

--- C:\Code\femn\lib\app.dart ---

import 'dart:typed_data';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/foundation.dart';
import 'package:flutter/material.dart';
import 'package:image_picker/image_picker.dart';
import 'package:provider/provider.dart';
import 'package:femn/customization/colors.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';

// Firebase Services
final FirebaseAuth _auth = FirebaseAuth.instance;
final FirebaseFirestore _firestore = FirebaseFirestore.instance;
final FirebaseStorage _storage = FirebaseStorage.instance;

// Auth Provider
class AuthProvider with ChangeNotifier {
  User? _user;
  bool _isLoading = false;
  String? _error;

  User? get user => _user;
  bool get isLoading => _isLoading;
  String? get error => _error;

  AuthProvider() {
    _auth.authStateChanges().listen((User? user) {
      _user = user;
      notifyListeners();
    });
  }

  Future<void> signInWithEmail(String email, String password) async {
    try {
      _isLoading = true;
      _error = null;
      notifyListeners();

      await _auth.signInWithEmailAndPassword(email: email, password: password);
    } on FirebaseAuthException catch (e) {
      _error = e.message;
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> signUpWithEmail(
    String email,
    String password,
    String name,
  ) async {
    try {
      _isLoading = true;
      _error = null;
      notifyListeners();

      final UserCredential credential = await _auth
          .createUserWithEmailAndPassword(email: email, password: password);

      await _firestore.collection('users').doc(credential.user!.uid).set({
        'name': name,
        'email': email,
        'createdAt': FieldValue.serverTimestamp(),
        'interests': [],
        'followers': 0,
        'following': 0,
        'pins': 0,
      });
    } on FirebaseAuthException catch (e) {
      _error = e.message;
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> signOut() async {
    await _auth.signOut();
  }

  void clearError() {
    _error = null;
    notifyListeners();
  }
}

// Pin Model
class Pin {
  final String id;
  final String title;
  final String description;
  final String imageUrl;
  final String creatorId;
  final String creatorName;
  final String? websiteUrl;
  final int saves;
  final int likes;
  final DateTime createdAt;
  final List<String> tags;

  Pin({
    required this.id,
    required this.title,
    required this.description,
    required this.imageUrl,
    required this.creatorId,
    required this.creatorName,
    this.websiteUrl,
    this.saves = 0,
    this.likes = 0,
    required this.createdAt,
    this.tags = const [],
  });

  factory Pin.fromMap(Map<String, dynamic> data, String id) {
    return Pin(
      id: id,
      title: data['title'] ?? '',
      description: data['description'] ?? '',
      imageUrl: data['imageUrl'] ?? '',
      creatorId: data['creatorId'] ?? '',
      creatorName: data['creatorName'] ?? '',
      websiteUrl: data['websiteUrl'],
      saves: data['saves'] ?? 0,
      likes: data['likes'] ?? 0,
      createdAt: (data['createdAt'] as Timestamp).toDate(),
      tags: List<String>.from(data['tags'] ?? []),
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'title': title,
      'description': description,
      'imageUrl': imageUrl,
      'creatorId': creatorId,
      'creatorName': creatorName,
      'websiteUrl': websiteUrl,
      'saves': saves,
      'likes': likes,
      'createdAt': Timestamp.fromDate(createdAt),
      'tags': tags,
    };
  }
}

// Board Model
class Board {
  final String id;
  final String name;
  final String description;
  final String creatorId;
  final bool isSecret;
  final String? coverImageUrl;
  final int pinCount;
  final DateTime createdAt;
  final List<String> collaborators;

  Board({
    required this.id,
    required this.name,
    required this.description,
    required this.creatorId,
    this.isSecret = false,
    this.coverImageUrl,
    this.pinCount = 0,
    required this.createdAt,
    this.collaborators = const [],
  });

  factory Board.fromMap(Map<String, dynamic> data, String id) {
    return Board(
      id: id,
      name: data['name'] ?? '',
      description: data['description'] ?? '',
      creatorId: data['creatorId'] ?? '',
      isSecret: data['isSecret'] ?? false,
      coverImageUrl: data['coverImageUrl'],
      pinCount: data['pinCount'] ?? 0,
      createdAt: (data['createdAt'] as Timestamp).toDate(),
      collaborators: List<String>.from(data['collaborators'] ?? []),
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'name': name,
      'description': description,
      'creatorId': creatorId,
      'isSecret': isSecret,
      'coverImageUrl': coverImageUrl,
      'pinCount': pinCount,
      'createdAt': Timestamp.fromDate(createdAt),
      'collaborators': collaborators,
    };
  }
}

// Pin Provider
class PinProvider with ChangeNotifier {
  final List<Pin> _pins = [];
  final List<Board> _boards = [];
  bool _isLoading = false;

  List<Pin> get pins => _pins;
  List<Board> get boards => _boards;
  bool get isLoading => _isLoading;

  Future<void> fetchPins() async {
    _isLoading = true;
    notifyListeners();

    try {
      final snapshot = await _firestore
          .collection('pins')
          .orderBy('createdAt', descending: true)
          .limit(50)
          .get();

      _pins.clear();
      for (var doc in snapshot.docs) {
        _pins.add(Pin.fromMap(doc.data(), doc.id));
      }
    } catch (e) {
      if (kDebugMode) {
        print('Error fetching pins: $e');
      }
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> fetchUserBoards(String userId) async {
    try {
      final snapshot = await _firestore
          .collection('boards')
          .where('creatorId', isEqualTo: userId)
          .orderBy('createdAt', descending: true)
          .get();

      _boards.clear();
      for (var doc in snapshot.docs) {
        _boards.add(Board.fromMap(doc.data(), doc.id));
      }
      notifyListeners();
    } catch (e) {
      if (kDebugMode) {
        print('Error fetching boards: $e');
      }
    }
  }

  Future<String> createPin({
    required String title,
    required String description,
    required Uint8List imageData,
    required String userId,
    required String userName,
    String? websiteUrl,
    List<String> tags = const [],
    required String boardId,
  }) async {
    try {
      // Upload image to storage
      final String fileName =
          'pins/${DateTime.now().millisecondsSinceEpoch}.jpg';
      final Reference storageRef = _storage.ref().child(fileName);
      final UploadTask uploadTask = storageRef.putData(
        imageData,
        SettableMetadata(contentType: 'image/jpeg'),
      );
      final TaskSnapshot snapshot = await uploadTask;
      final String imageUrl = await snapshot.ref.getDownloadURL();

      // Create pin document
      final pinDoc = _firestore.collection('pins').doc();
      final pin = Pin(
        id: pinDoc.id,
        title: title,
        description: description,
        imageUrl: imageUrl,
        creatorId: userId,
        creatorName: userName,
        websiteUrl: websiteUrl,
        tags: tags,
        createdAt: DateTime.now(),
      );

      await pinDoc.set(pin.toMap());

      // Add pin to board
      await _firestore.collection('boards').doc(boardId).update({
        'pinCount': FieldValue.increment(1),
        'updatedAt': FieldValue.serverTimestamp(),
      });

      await _firestore
          .collection('board_pins')
          .doc('${boardId}_${pinDoc.id}')
          .set({
            'boardId': boardId,
            'pinId': pinDoc.id,
            'addedAt': FieldValue.serverTimestamp(),
          });

      // Update user pin count
      await _firestore.collection('users').doc(userId).update({
        'pins': FieldValue.increment(1),
      });

      _pins.insert(0, pin);
      notifyListeners();

      return pinDoc.id;
    } catch (e) {
      if (kDebugMode) {
        print('Error creating pin: $e');
      }
      rethrow;
    }
  }

  Future<void> savePin(String pinId, String boardId, String userId) async {
    try {
      await _firestore.collection('saves').doc('${userId}_$pinId').set({
        'userId': userId,
        'pinId': pinId,
        'boardId': boardId,
        'savedAt': FieldValue.serverTimestamp(),
      });

      await _firestore.collection('pins').doc(pinId).update({
        'saves': FieldValue.increment(1),
      });

      // Update the local pin data
      final index = _pins.indexWhere((pin) => pin.id == pinId);
      if (index != -1) {
        _pins[index] = Pin(
          id: _pins[index].id,
          title: _pins[index].title,
          description: _pins[index].description,
          imageUrl: _pins[index].imageUrl,
          creatorId: _pins[index].creatorId,
          creatorName: _pins[index].creatorName,
          websiteUrl: _pins[index].websiteUrl,
          saves: _pins[index].saves + 1,
          likes: _pins[index].likes,
          createdAt: _pins[index].createdAt,
          tags: _pins[index].tags,
        );
        notifyListeners();
      }
    } catch (e) {
      if (kDebugMode) {
        print('Error saving pin: $e');
      }
    }
  }

  Future<String> createBoard({
    required String name,
    required String description,
    required String userId,
    bool isSecret = false,
  }) async {
    try {
      final boardDoc = _firestore.collection('boards').doc();
      final board = Board(
        id: boardDoc.id,
        name: name,
        description: description,
        creatorId: userId,
        isSecret: isSecret,
        createdAt: DateTime.now(),
      );

      await boardDoc.set(board.toMap());
      _boards.add(board);
      notifyListeners();

      return boardDoc.id;
    } catch (e) {
      if (kDebugMode) {
        print('Error creating board: $e');
      }
      rethrow;
    }
  }
}

// User Provider
class UserProvider with ChangeNotifier {
  Map<String, dynamic>? _currentUserData;
  bool _isLoading = false;

  Map<String, dynamic>? get currentUserData => _currentUserData;
  bool get isLoading => _isLoading;

  Future<void> fetchCurrentUserData(String userId) async {
    _isLoading = true;
    notifyListeners();

    try {
      final doc = await _firestore.collection('users').doc(userId).get();
      if (doc.exists) {
        _currentUserData = doc.data()!;
      }
    } catch (e) {
      if (kDebugMode) {
        print('Error fetching user data: $e');
      }
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> updateUserInterests(
    String userId,
    List<String> interests,
  ) async {
    try {
      await _firestore.collection('users').doc(userId).update({
        'interests': interests,
      });
      _currentUserData?['interests'] = interests;
      notifyListeners();
    } catch (e) {
      if (kDebugMode) {
        print('Error updating interests: $e');
      }
    }
  }
}

// Auth Wrapper
class AuthWrapper extends StatelessWidget {
  const AuthWrapper({super.key});

  @override
  Widget build(BuildContext context) {
    final authProvider = Provider.of<AuthProvider>(context);

    if (authProvider.user == null) {
      return const OnboardingScreen();
    } else {
      return const MainAppScreen();
    }
  }
}

// Onboarding Screen
class OnboardingScreen extends StatefulWidget {
  const OnboardingScreen({super.key});

  @override
  State<OnboardingScreen> createState() => _OnboardingScreenState();
}

class _OnboardingScreenState extends State<OnboardingScreen> {
  int _currentPage = 0;
  final PageController _pageController = PageController();
  final List<String> _selectedInterests = [];

  final List<Map<String, dynamic>> _onboardingPages = [
    {
      'title': 'Discover your inspiration',
      'description': 'Find ideas for all your projects and interests',
      'image': 'assets/onboarding1.png',
    },
    {
      'title': 'Save what you love',
      'description': 'Collect and organize your favorite ideas',
      'image': 'assets/onboarding2.png',
    },
    {
      'title': 'Create and share',
      'description': 'Share your own ideas with the world',
      'image': 'assets/onboarding3.png',
    },
  ];

  final List<String> _interests = [
    'Home Decor',
    'DIY & Crafts',
    'Fashion',
    'Food & Drink',
    'Photography',
    'Travel',
    'Art',
    'Technology',
    'Fitness',
    'Education',
    'Gardening',
    'Business',
  ];

  void _nextPage() {
    if (_currentPage < _onboardingPages.length - 1) {
      _pageController.nextPage(
        duration: const Duration(milliseconds: 300),
        curve: Curves.easeIn,
      );
    } else {
      // Navigate to sign up
    }
  }

  void _selectInterest(String interest) {
    setState(() {
      if (_selectedInterests.contains(interest)) {
        _selectedInterests.remove(interest);
      } else {
        _selectedInterests.add(interest);
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      body: PageView.builder(
        controller: _pageController,
        itemCount: _onboardingPages.length + 1,
        onPageChanged: (int page) {
          setState(() {
            _currentPage = page;
          });
        },
        itemBuilder: (context, index) {
          if (index < _onboardingPages.length) {
            return _buildOnboardingPage(_onboardingPages[index]);
          } else {
            return _buildInterestsPage();
          }
        },
      ),
    );
  }

  Widget _buildOnboardingPage(Map<String, dynamic> page) {
    return Container(
      padding: const EdgeInsets.all(24),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const Spacer(flex: 2),
          Image.asset(page['image'], height: 300, fit: BoxFit.contain),
          const Spacer(),
          Text(
            page['title'],
            style: const TextStyle(
              fontSize: 24,
              fontWeight: FontWeight.bold,
              color: AppColors.textHigh,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 16),
          Text(
            page['description'],
            style: const TextStyle(fontSize: 16, color: AppColors.textMedium),
            textAlign: TextAlign.center,
          ),
          const Spacer(),
          ElevatedButton(
            onPressed: _nextPage,
            style: ElevatedButton.styleFrom(
              backgroundColor: AppColors.primaryLavender,
              foregroundColor:
                  AppColors.backgroundDeep, // Dark text on Lavender
              minimumSize: const Size(double.infinity, 50),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(25),
              ),
            ),
            child: Text(
              _currentPage == _onboardingPages.length - 1
                  ? 'Get Started'
                  : 'Continue',
            ),
          ),
          const SizedBox(height: 16),
          if (_currentPage < _onboardingPages.length - 1)
            TextButton(
              onPressed: () {
                _pageController.jumpToPage(_onboardingPages.length);
              },
              child: const Text(
                'Skip',
                style: TextStyle(color: AppColors.textMedium),
              ),
            ),
          const Spacer(),
        ],
      ),
    );
  }

  Widget _buildInterestsPage() {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: const Text(
          'Pick your interests',
          style: TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: Colors.transparent,
        elevation: 0,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
      ),
      body: Column(
        children: [
          const Padding(
            padding: EdgeInsets.all(16),
            child: Text(
              'Select at least 5 interests to personalize your experience',
              style: TextStyle(fontSize: 16, color: AppColors.textMedium),
              textAlign: TextAlign.center,
            ),
          ),
          Expanded(
            child: GridView.builder(
              padding: const EdgeInsets.all(16),
              gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                crossAxisCount: 3,
                crossAxisSpacing: 8,
                mainAxisSpacing: 8,
                childAspectRatio: 1.5,
              ),
              itemCount: _interests.length,
              itemBuilder: (context, index) {
                final interest = _interests[index];
                final isSelected = _selectedInterests.contains(interest);
                return FilterChip(
                  label: Text(interest),
                  selected: isSelected,
                  onSelected: (_) => _selectInterest(interest),
                  backgroundColor: AppColors.elevation,
                  selectedColor:
                      AppColors.secondaryTeal, // Teal for selected state
                  checkmarkColor: Colors.white,
                  labelStyle: TextStyle(
                    color: isSelected ? Colors.white : AppColors.textHigh,
                  ),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(20),
                    side: BorderSide.none,
                  ),
                );
              },
            ),
          ),
          Padding(
            padding: const EdgeInsets.all(16),
            child: ElevatedButton(
              onPressed: _selectedInterests.length >= 5
                  ? () {
                      // Save interests and navigate to auth
                      Navigator.push(
                        context,
                        MaterialPageRoute(
                          builder: (context) => const AuthScreen(),
                        ),
                      );
                    }
                  : null,
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.primaryLavender,
                foregroundColor: AppColors.backgroundDeep,
                disabledBackgroundColor: AppColors.elevation,
                disabledForegroundColor: AppColors.textDisabled,
                minimumSize: const Size(double.infinity, 50),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(25),
                ),
              ),
              child: const Text('Continue'),
            ),
          ),
        ],
      ),
    );
  }
}

// Auth Screen
class AuthScreen extends StatefulWidget {
  const AuthScreen({super.key});

  @override
  State<AuthScreen> createState() => _AuthScreenState();
}

class _AuthScreenState extends State<AuthScreen>
    with SingleTickerProviderStateMixin {
  late TabController _tabController;
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  final _nameController = TextEditingController();
  bool _obscurePassword = true;

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 2, vsync: this);
  }

  @override
  void dispose() {
    _tabController.dispose();
    _emailController.dispose();
    _passwordController.dispose();
    _nameController.dispose();
    super.dispose();
  }

  Future<void> _signIn() async {
    final authProvider = Provider.of<AuthProvider>(context, listen: false);
    await authProvider.signInWithEmail(
      _emailController.text.trim(),
      _passwordController.text.trim(),
    );
  }

  Future<void> _signUp() async {
    final authProvider = Provider.of<AuthProvider>(context, listen: false);
    await authProvider.signUpWithEmail(
      _emailController.text.trim(),
      _passwordController.text.trim(),
      _nameController.text.trim(),
    );
  }

  @override
  Widget build(BuildContext context) {
    final authProvider = Provider.of<AuthProvider>(context);

    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        title: const Text(
          'FEMN',
          style: TextStyle(
            color: AppColors.textHigh,
            fontWeight: FontWeight.bold,
          ),
        ),
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
        bottom: TabBar(
          controller: _tabController,
          indicatorColor: AppColors.primaryLavender,
          labelColor: AppColors.primaryLavender,
          unselectedLabelColor: AppColors.textMedium,
          tabs: const [
            Tab(text: 'Sign In'),
            Tab(text: 'Sign Up'),
          ],
        ),
      ),
      body: TabBarView(
        controller: _tabController,
        children: [
          _buildSignInForm(authProvider),
          _buildSignUpForm(authProvider),
        ],
      ),
    );
  }

  Widget _buildSignInForm(AuthProvider authProvider) {
    return Padding(
      padding: const EdgeInsets.all(24),
      child: Column(
        children: [
          _buildTextField(
            controller: _emailController,
            label: 'Email',
            icon: Feather.mail,
            keyboardType: TextInputType.emailAddress,
          ),
          const SizedBox(height: 16),
          _buildTextField(
            controller: _passwordController,
            label: 'Password',
            icon: Feather.lock,
            obscureText: _obscurePassword,
            onToggleObscure: () =>
                setState(() => _obscurePassword = !_obscurePassword),
          ),
          const SizedBox(height: 24),
          if (authProvider.error != null)
            Text(
              authProvider.error!,
              style: const TextStyle(color: AppColors.error),
            ),
          const SizedBox(height: 16),
          ElevatedButton(
            onPressed: authProvider.isLoading ? null : _signIn,
            style: ElevatedButton.styleFrom(
              backgroundColor: AppColors.primaryLavender,
              foregroundColor: AppColors.backgroundDeep,
              minimumSize: const Size(double.infinity, 50),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
            child: authProvider.isLoading
                ? const CircularProgressIndicator(
                    color: AppColors.backgroundDeep,
                  )
                : const Text('Sign In'),
          ),
        ],
      ),
    );
  }

  Widget _buildSignUpForm(AuthProvider authProvider) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(24),
      child: Column(
        children: [
          _buildTextField(
            controller: _nameController,
            label: 'Full Name',
            icon: Feather.user,
          ),
          const SizedBox(height: 16),
          _buildTextField(
            controller: _emailController,
            label: 'Email',
            icon: Feather.mail,
            keyboardType: TextInputType.emailAddress,
          ),
          const SizedBox(height: 16),
          _buildTextField(
            controller: _passwordController,
            label: 'Password',
            icon: Feather.lock,
            obscureText: _obscurePassword,
            onToggleObscure: () =>
                setState(() => _obscurePassword = !_obscurePassword),
          ),
          const SizedBox(height: 24),
          if (authProvider.error != null)
            Text(
              authProvider.error!,
              style: const TextStyle(color: AppColors.error),
            ),
          const SizedBox(height: 16),
          ElevatedButton(
            onPressed: authProvider.isLoading ? null : _signUp,
            style: ElevatedButton.styleFrom(
              backgroundColor: AppColors.primaryLavender,
              foregroundColor: AppColors.backgroundDeep,
              minimumSize: const Size(double.infinity, 50),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
            child: authProvider.isLoading
                ? const CircularProgressIndicator(
                    color: AppColors.backgroundDeep,
                  )
                : const Text('Sign Up'),
          ),
        ],
      ),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    bool obscureText = false,
    TextInputType? keyboardType,
    VoidCallback? onToggleObscure,
  }) {
    return TextField(
      controller: controller,
      style: TextStyle(color: AppColors.textHigh),
      decoration: InputDecoration(
        labelText: label,
        labelStyle: TextStyle(color: AppColors.textMedium),
        prefixIcon: Icon(icon, color: AppColors.primaryLavender),
        suffixIcon:
            (label.toLowerCase().contains('password') &&
                onToggleObscure != null)
            ? IconButton(
                icon: Icon(
                  obscureText ? Feather.eye_off : Feather.eye,
                  color: AppColors.primaryLavender,
                ),
                onPressed: onToggleObscure,
              )
            : null,
        filled: true,
        fillColor: AppColors.elevation,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide.none,
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: AppColors.primaryLavender),
        ),
      ),
      obscureText: obscureText,
      keyboardType: keyboardType,
    );
  }
}

// Main App Screen
class MainAppScreen extends StatefulWidget {
  const MainAppScreen({super.key});

  @override
  State<MainAppScreen> createState() => _MainAppScreenState();
}

class _MainAppScreenState extends State<MainAppScreen> {
  int _currentIndex = 0;

  final List<Widget> _screens = [
    const HomeFeedScreen(),
    const SearchScreen(),
    const CreatePinScreen(),
    const NotificationsScreen(),
    const ProfileScreen(userId: ''),
  ];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      body: _screens[_currentIndex],
      bottomNavigationBar: BottomNavigationBar(
        backgroundColor: AppColors.surface,
        currentIndex: _currentIndex,
        onTap: (index) {
          setState(() {
            _currentIndex = index;
          });
        },
        selectedItemColor: AppColors.primaryLavender,
        unselectedItemColor: AppColors.textDisabled,
        type: BottomNavigationBarType.fixed,
        items: const [
          BottomNavigationBarItem(icon: Icon(Feather.home), label: 'Home'),
          BottomNavigationBarItem(icon: Icon(Feather.search), label: 'Search'),
          BottomNavigationBarItem(icon: Icon(Feather.plus), label: 'Create'),
          BottomNavigationBarItem(
            icon: Icon(Feather.bell),
            label: 'Notifications',
          ),
          BottomNavigationBarItem(icon: Icon(Feather.user), label: 'Profile'),
        ],
      ),
    );
  }
}

// Home Feed Screen
class HomeFeedScreen extends StatefulWidget {
  const HomeFeedScreen({super.key});

  @override
  State<HomeFeedScreen> createState() => _HomeFeedScreenState();
}

class _HomeFeedScreenState extends State<HomeFeedScreen> {
  final ScrollController _scrollController = ScrollController();
  bool _isLoading = false;

  @override
  void initState() {
    super.initState();
    _loadPins();
    _scrollController.addListener(_scrollListener);
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }

  Future<void> _loadPins() async {
    final pinProvider = Provider.of<PinProvider>(context, listen: false);
    await pinProvider.fetchPins();
  }

  void _scrollListener() {
    if (_scrollController.position.pixels ==
        _scrollController.position.maxScrollExtent) {
      _loadMorePins();
    }
  }

  Future<void> _loadMorePins() async {
    if (_isLoading) return;

    setState(() {
      _isLoading = true;
    });

    // Simulate loading more pins
    await Future.delayed(const Duration(seconds: 2));

    setState(() {
      _isLoading = false;
    });
  }

  @override
  Widget build(BuildContext context) {
    final pinProvider = Provider.of<PinProvider>(context);
    Provider.of<AuthProvider>(context);

    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: const Text(
          'FEMN',
          style: TextStyle(
            color: AppColors.textHigh,
            fontWeight: FontWeight.bold,
          ),
        ),
        backgroundColor: Colors.transparent,
        elevation: 0,
        actions: [
          IconButton(
            icon: const Icon(Feather.sliders, color: AppColors.primaryLavender),
            onPressed: () {
              // Show feed tuning options
            },
          ),
        ],
      ),
      body: pinProvider.isLoading
          ? const Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryLavender,
              ),
            )
          : RefreshIndicator(
              color: AppColors.primaryLavender,
              backgroundColor: AppColors.surface,
              onRefresh: _loadPins,
              child: GridView.builder(
                controller: _scrollController,
                padding: const EdgeInsets.all(8),
                gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                  crossAxisCount: 2,
                  crossAxisSpacing: 8,
                  mainAxisSpacing: 8,
                  childAspectRatio: 0.7,
                ),
                itemCount: pinProvider.pins.length + (_isLoading ? 1 : 0),
                itemBuilder: (context, index) {
                  if (index == pinProvider.pins.length) {
                    return const Center(
                      child: CircularProgressIndicator(
                        color: AppColors.primaryLavender,
                      ),
                    );
                  }

                  final pin = pinProvider.pins[index];
                  return PinCard(pin: pin);
                },
              ),
            ),
    );
  }
}

// Pin Card Widget
class PinCard extends StatelessWidget {
  final Pin pin;

  const PinCard({super.key, required this.pin});

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: () {
        Navigator.push(
          context,
          MaterialPageRoute(builder: (context) => PinDetailScreen(pin: pin)),
        );
      },
      child: Card(
        color: AppColors.surface, // Surface color for card
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            Expanded(
              child: ClipRRect(
                borderRadius: const BorderRadius.vertical(
                  top: Radius.circular(12),
                ),
                child: Image.network(
                  pin.imageUrl,
                  fit: BoxFit.cover,
                  loadingBuilder: (context, child, loadingProgress) {
                    if (loadingProgress == null) return child;
                    return Center(
                      child: CircularProgressIndicator(
                        color: AppColors.primaryLavender,
                        value: loadingProgress.expectedTotalBytes != null
                            ? loadingProgress.cumulativeBytesLoaded /
                                  loadingProgress.expectedTotalBytes!
                            : null,
                      ),
                    );
                  },
                ),
              ),
            ),
            Padding(
              padding: const EdgeInsets.all(8),
              child: Text(
                pin.title,
                style: const TextStyle(
                  fontWeight: FontWeight.bold,
                  fontSize: 14,
                  color: AppColors.textHigh, // Off-white text
                ),
                maxLines: 2,
                overflow: TextOverflow.ellipsis,
              ),
            ),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
              child: Row(
                children: [
                  const Icon(
                    Feather.map_pin,
                    size: 14,
                    color: AppColors.accentMustard,
                  ), // Mustard for saves
                  const SizedBox(width: 4),
                  Text(
                    '${pin.saves}',
                    style: const TextStyle(
                      fontSize: 12,
                      color: AppColors.textMedium,
                    ),
                  ),
                  const Spacer(),
                  IconButton(
                    icon: const Icon(
                      Feather.more_vertical,
                      size: 16,
                      color: AppColors.textMedium,
                    ),
                    onPressed: () {
                      // Show more options
                    },
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// Pin Detail Screen
class PinDetailScreen extends StatelessWidget {
  final Pin pin;

  const PinDetailScreen({super.key, required this.pin});

  @override
  Widget build(BuildContext context) {
    final authProvider = Provider.of<AuthProvider>(context);

    return Scaffold(
      backgroundColor: Colors.transparent,
      body: CustomScrollView(
        slivers: [
          SliverAppBar(
            backgroundColor: Colors.transparent,
            expandedHeight: 300,
            leading: IconButton(
              icon: Icon(Feather.arrow_left, color: AppColors.primaryLavender),
              onPressed: () => Navigator.pop(context),
            ),
            flexibleSpace: FlexibleSpaceBar(
              background: Image.network(pin.imageUrl, fit: BoxFit.cover),
            ),
            pinned: true,
            actions: [
              IconButton(
                icon: const Icon(
                  Feather.download,
                  color: AppColors.primaryLavender,
                ),
                onPressed: () {
                  _showSaveDialog(context, authProvider.user!.uid);
                },
              ),
              IconButton(
                icon: const Icon(
                  Feather.share_2,
                  color: AppColors.primaryLavender,
                ),
                onPressed: () {
                  _sharePin(context);
                },
              ),
            ],
          ),
          SliverToBoxAdapter(
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    pin.title,
                    style: const TextStyle(
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                      color: AppColors.textHigh,
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    pin.description,
                    style: const TextStyle(
                      fontSize: 16,
                      color: AppColors.textMedium,
                    ),
                  ),
                  const SizedBox(height: 16),
                  if (pin.websiteUrl != null)
                    ElevatedButton(
                      onPressed: () {
                        // Open website
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.elevation,
                        foregroundColor: AppColors.primaryLavender,
                      ),
                      child: const Text('Visit website'),
                    ),
                  const SizedBox(height: 16),
                  Row(
                    children: [
                      const Icon(
                        Feather.map_pin,
                        size: 16,
                        color: AppColors.accentMustard,
                      ),
                      const SizedBox(width: 4),
                      Text(
                        '${pin.saves} saves',
                        style: TextStyle(color: AppColors.textMedium),
                      ),
                      const SizedBox(width: 16),
                      const Icon(
                        Feather.heart,
                        size: 16,
                        color: AppColors.error,
                      ), // Soft red for likes
                      const SizedBox(width: 4),
                      Text(
                        '${pin.likes} likes',
                        style: TextStyle(color: AppColors.textMedium),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
      bottomNavigationBar: BottomAppBar(
        color: AppColors.surface,
        child: Row(
          children: [
            IconButton(
              icon: const Icon(Feather.heart, color: AppColors.primaryLavender),
              onPressed: () {
                // Like pin
              },
            ),
            IconButton(
              icon: const Icon(
                Feather.message_circle,
                color: AppColors.primaryLavender,
              ),
              onPressed: () {
                // Show comments
              },
            ),
            const Spacer(),
            ElevatedButton(
              onPressed: () {
                _showSaveDialog(context, authProvider.user!.uid);
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.primaryLavender,
                foregroundColor: AppColors.backgroundDeep,
              ),
              child: const Text('Save'),
            ),
          ],
        ),
      ),
    );
  }

  void _showSaveDialog(BuildContext context, String userId) {
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (context) {
        return FutureBuilder(
          future: Provider.of<PinProvider>(
            context,
            listen: false,
          ).fetchUserBoards(userId),
          builder: (context, snapshot) {
            final pinProvider = Provider.of<PinProvider>(context);
            return Container(
              decoration: BoxDecoration(
                color: AppColors.surface,
                borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
              ),
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text(
                    'Save to board',
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: AppColors.textHigh,
                    ),
                  ),
                  const SizedBox(height: 16),
                  Expanded(
                    child: ListView.builder(
                      itemCount: pinProvider.boards.length + 1,
                      itemBuilder: (context, index) {
                        if (index == 0) {
                          return ListTile(
                            leading: const Icon(
                              Feather.plus,
                              color: AppColors.primaryLavender,
                            ),
                            title: const Text(
                              'Create new board',
                              style: TextStyle(color: AppColors.textHigh),
                            ),
                            onTap: () {
                              _createNewBoard(context);
                            },
                          );
                        }
                        final board = pinProvider.boards[index - 1];
                        return ListTile(
                          leading: const Icon(
                            Feather.bookmark,
                            color: AppColors.textMedium,
                          ),
                          title: Text(
                            board.name,
                            style: TextStyle(color: AppColors.textMedium),
                          ),
                          onTap: () {
                            _saveToBoard(context, board.id);
                          },
                        );
                      },
                    ),
                  ),
                ],
              ),
            );
          },
        );
      },
    );
  }

  void _saveToBoard(BuildContext context, String boardId) {
    final pinProvider = Provider.of<PinProvider>(context, listen: false);
    final authProvider = Provider.of<AuthProvider>(context, listen: false);

    pinProvider.savePin(pin.id, boardId, authProvider.user!.uid);
    Navigator.pop(context);
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(
          'Pin saved!',
          style: TextStyle(color: AppColors.backgroundDeep),
        ),
        backgroundColor: AppColors.primaryLavender,
      ),
    );
  }

  void _createNewBoard(BuildContext context) {
    showDialog(
      context: context,
      builder: (context) {
        final _boardNameController = TextEditingController();
        final _boardDescController = TextEditingController();
        bool _isSecret = false;

        return AlertDialog(
          backgroundColor: AppColors.surface,
          title: const Text(
            'Create new board',
            style: TextStyle(color: AppColors.textHigh),
          ),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              TextField(
                controller: _boardNameController,
                style: TextStyle(color: AppColors.textHigh),
                decoration: const InputDecoration(
                  labelText: 'Board name',
                  labelStyle: TextStyle(color: AppColors.textMedium),
                  enabledBorder: OutlineInputBorder(
                    borderSide: BorderSide(color: AppColors.textDisabled),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderSide: BorderSide(color: AppColors.primaryLavender),
                  ),
                ),
              ),
              const SizedBox(height: 16),
              TextField(
                controller: _boardDescController,
                style: TextStyle(color: AppColors.textHigh),
                decoration: const InputDecoration(
                  labelText: 'Description',
                  labelStyle: TextStyle(color: AppColors.textMedium),
                  enabledBorder: OutlineInputBorder(
                    borderSide: BorderSide(color: AppColors.textDisabled),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderSide: BorderSide(color: AppColors.primaryLavender),
                  ),
                ),
                maxLines: 3,
              ),
              const SizedBox(height: 16),
              Row(
                children: [
                  StatefulBuilder(
                    builder: (context, setState) => Checkbox(
                      value: _isSecret,
                      activeColor: AppColors.primaryLavender,
                      onChanged: (value) {
                        setState(() => _isSecret = value ?? false);
                      },
                    ),
                  ),
                  const Text(
                    'Secret board',
                    style: TextStyle(color: AppColors.textMedium),
                  ),
                ],
              ),
            ],
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text(
                'Cancel',
                style: TextStyle(color: AppColors.textMedium),
              ),
            ),
            ElevatedButton(
              onPressed: () async {
                final pinProvider = Provider.of<PinProvider>(
                  context,
                  listen: false,
                );
                final authProvider = Provider.of<AuthProvider>(
                  context,
                  listen: false,
                );

                try {
                  final boardId = await pinProvider.createBoard(
                    name: _boardNameController.text,
                    description: _boardDescController.text,
                    userId: authProvider.user!.uid,
                    isSecret: _isSecret,
                  );
                  _saveToBoard(context, boardId);
                } catch (e) {
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(content: Text('Error creating board: $e')),
                  );
                }
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.primaryLavender,
                foregroundColor: AppColors.backgroundDeep,
              ),
              child: const Text('Create'),
            ),
          ],
        );
      },
    );
  }

  void _sharePin(BuildContext context) {
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (context) {
        return Container(
          decoration: BoxDecoration(
            color: AppColors.surface,
            borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
          ),
          padding: const EdgeInsets.all(16),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              ListTile(
                leading: const Icon(Feather.link, color: AppColors.textMedium),
                title: const Text(
                  'Copy link',
                  style: TextStyle(color: AppColors.textHigh),
                ),
                onTap: () {
                  // Copy link to clipboard
                  Navigator.pop(context);
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(content: Text('Link copied to clipboard')),
                  );
                },
              ),
              ListTile(
                leading: const Icon(
                  Feather.share_2,
                  color: AppColors.textMedium,
                ),
                title: const Text(
                  'Share via...',
                  style: TextStyle(color: AppColors.textHigh),
                ),
                onTap: () {
                  // Share via native share sheet
                  Navigator.pop(context);
                },
              ),
            ],
          ),
        );
      },
    );
  }
}

// Create Pin Screen
class CreatePinScreen extends StatefulWidget {
  const CreatePinScreen({super.key});

  @override
  State<CreatePinScreen> createState() => _CreatePinScreenState();
}

class _CreatePinScreenState extends State<CreatePinScreen> {
  final _titleController = TextEditingController();
  final _descriptionController = TextEditingController();
  final _websiteController = TextEditingController();
  Uint8List? _imageData;
  bool _isLoading = false;

  Future<void> _pickImage() async {
    final picker = ImagePicker();
    final pickedFile = await picker.pickImage(source: ImageSource.gallery);

    if (pickedFile != null) {
      final bytes = await pickedFile.readAsBytes();
      setState(() {
        _imageData = bytes;
      });
    }
  }

  Future<void> _createPin() async {
    if (_imageData == null || _titleController.text.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Please add an image and title')),
      );
      return;
    }

    setState(() {
      _isLoading = true;
    });

    try {
      final authProvider = Provider.of<AuthProvider>(context, listen: false);
      final pinProvider = Provider.of<PinProvider>(context, listen: false);
      final userProvider = Provider.of<UserProvider>(context, listen: false);

      await pinProvider.createPin(
        title: _titleController.text,
        description: _descriptionController.text,
        imageData: _imageData!,
        userId: authProvider.user!.uid,
        userName: userProvider.currentUserData?['name'] ?? 'User',
        websiteUrl: _websiteController.text.isNotEmpty
            ? _websiteController.text
            : null,
        boardId: 'default_board', // You might want to let user choose board
      );

      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Pin created successfully!')),
      );
      Navigator.pop(context);
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Error creating pin: $e')));
    } finally {
      setState(() {
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: const Text(
          'Create Pin',
          style: TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: Colors.transparent,
        elevation: 0,
        actions: [
          IconButton(
            icon: const Icon(Feather.check, color: AppColors.primaryLavender),
            onPressed: _isLoading ? null : _createPin,
          ),
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            GestureDetector(
              onTap: _pickImage,
              child: Container(
                height: 200,
                decoration: BoxDecoration(
                  color: AppColors.elevation,
                  borderRadius: BorderRadius.circular(12),
                ),
                child: _imageData == null
                    ? const Center(
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(
                              Feather.image,
                              size: 48,
                              color: AppColors.textDisabled,
                            ),
                            SizedBox(height: 8),
                            Text(
                              'Tap to add image',
                              style: TextStyle(color: AppColors.textMedium),
                            ),
                          ],
                        ),
                      )
                    : ClipRRect(
                        borderRadius: BorderRadius.circular(12),
                        child: Image.memory(
                          _imageData!,
                          fit: BoxFit.cover,
                          width: double.infinity,
                        ),
                      ),
              ),
            ),
            const SizedBox(height: 16),
            _buildTextField(controller: _titleController, label: 'Title'),
            const SizedBox(height: 16),
            _buildTextField(
              controller: _descriptionController,
              label: 'Description',
              maxLines: 3,
            ),
            const SizedBox(height: 16),
            _buildTextField(
              controller: _websiteController,
              label: 'Website URL (optional)',
              keyboardType: TextInputType.url,
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String label,
    int maxLines = 1,
    TextInputType? keyboardType,
  }) {
    return TextField(
      controller: controller,
      style: TextStyle(color: AppColors.textHigh),
      decoration: InputDecoration(
        labelText: label,
        labelStyle: TextStyle(color: AppColors.textMedium),
        filled: true,
        fillColor: AppColors.elevation,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide.none,
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide(color: AppColors.primaryLavender),
        ),
      ),
      maxLines: maxLines,
      keyboardType: keyboardType,
    );
  }
}

// Search Screen
class SearchScreen extends StatelessWidget {
  const SearchScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return const Scaffold(
      backgroundColor: Colors.transparent,
      appBar: SearchAppBar(),
      body: Center(
        child: Text(
          'Search functionality would go here',
          style: TextStyle(color: AppColors.textMedium),
        ),
      ),
    );
  }
}

// Search AppBar
class SearchAppBar extends StatelessWidget implements PreferredSizeWidget {
  const SearchAppBar({super.key});

  @override
  Size get preferredSize => const Size.fromHeight(kToolbarHeight);

  @override
  Widget build(BuildContext context) {
    return AppBar(
      backgroundColor: Colors.transparent,
      elevation: 0,
      title: Container(
        height: 40,
        decoration: BoxDecoration(
          color: AppColors.elevation,
          borderRadius: BorderRadius.circular(20),
        ),
        child: const TextField(
          style: TextStyle(color: AppColors.textHigh),
          decoration: InputDecoration(
            prefixIcon: Icon(Feather.search, color: AppColors.textMedium),
            hintText: 'Search for ideas',
            hintStyle: TextStyle(color: AppColors.textDisabled),
            border: InputBorder.none,
            contentPadding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
          ),
        ),
      ),
    );
  }
}

// Notifications Screen
class NotificationsScreen extends StatelessWidget {
  const NotificationsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: const Text(
          'Notifications',
          style: TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: Colors.transparent,
        elevation: 0,
      ),
      body: const Center(
        child: Text(
          'Notifications will appear here',
          style: TextStyle(color: AppColors.textMedium),
        ),
      ),
    );
  }
}

// Profile Screen
class ProfileScreen extends StatelessWidget {
  const ProfileScreen({super.key, required String userId});

  @override
  Widget build(BuildContext context) {
    final authProvider = Provider.of<AuthProvider>(context);
    final userProvider = Provider.of<UserProvider>(context);

    if (userProvider.currentUserData == null && authProvider.user != null) {
      userProvider.fetchCurrentUserData(authProvider.user!.uid);
    }

    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: const Text(
          'Profile',
          style: TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: Colors.transparent,
        elevation: 0,
        actions: [
          IconButton(
            icon: const Icon(Feather.settings, color: AppColors.textHigh),
            onPressed: () {
              // Navigate to settings
            },
          ),
        ],
      ),
      body: userProvider.isLoading
          ? const Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryLavender,
              ),
            )
          : SingleChildScrollView(
              child: Column(
                children: [
                  const SizedBox(height: 20),
                  const CircleAvatar(
                    radius: 40,
                    backgroundImage: NetworkImage(
                      'https://via.placeholder.com/150',
                    ),
                    backgroundColor: AppColors.elevation,
                  ),
                  const SizedBox(height: 16),
                  Text(
                    userProvider.currentUserData?['name'] ?? 'User',
                    style: const TextStyle(
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                      color: AppColors.textHigh,
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    userProvider.currentUserData?['email'] ?? '',
                    style: const TextStyle(color: AppColors.textMedium),
                  ),
                  const SizedBox(height: 24),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                    children: [
                      _buildStatColumn(
                        'Pins',
                        userProvider.currentUserData?['pins'] ?? 0,
                      ),
                      _buildStatColumn(
                        'Followers',
                        userProvider.currentUserData?['followers'] ?? 0,
                      ),
                      _buildStatColumn(
                        'Following',
                        userProvider.currentUserData?['following'] ?? 0,
                      ),
                    ],
                  ),
                  const SizedBox(height: 24),
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 16),
                    child: ElevatedButton(
                      onPressed: () {
                        authProvider.signOut();
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor:
                            AppColors.elevation, // Less emphasis for sign out
                        foregroundColor: AppColors
                            .error, // Soft red text for destructive action
                        minimumSize: const Size(double.infinity, 50),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      child: const Text('Sign Out'),
                    ),
                  ),
                ],
              ),
            ),
    );
  }

  Widget _buildStatColumn(String label, int value) {
    return Column(
      children: [
        Text(
          value.toString(),
          style: const TextStyle(
            fontSize: 18,
            fontWeight: FontWeight.bold,
            color: AppColors.textHigh,
          ),
        ),
        Text(label, style: const TextStyle(color: AppColors.textMedium)),
      ],
    );
  }
}


--- C:\Code\femn\lib\firebase_options.dart ---


import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
import 'package:flutter/foundation.dart'
    show defaultTargetPlatform, kIsWeb, TargetPlatform;

/// Default [FirebaseOptions] for use with your Firebase apps.
///
/// Example:
/// ```dart
/// import 'firebase_options.dart';
/// // ...
/// await Firebase.initializeApp(
///   options: DefaultFirebaseOptions.currentPlatform,
/// );
/// ```
class DefaultFirebaseOptions {
  static FirebaseOptions get currentPlatform {
    if (kIsWeb) {
      return web;
    }
    switch (defaultTargetPlatform) {
      case TargetPlatform.android:
        return android;
      case TargetPlatform.iOS:
        return ios;
      case TargetPlatform.macOS:
        return macos;
      case TargetPlatform.windows:
        return windows;
      case TargetPlatform.linux:
        throw UnsupportedError(
          'DefaultFirebaseOptions have not been configured for linux - '
          'you can reconfigure this by running the FlutterFire CLI again.',
        );
      default:
        throw UnsupportedError(
          'DefaultFirebaseOptions are not supported for this platform.',
        );
    }
  }

  static const FirebaseOptions web = FirebaseOptions(
    apiKey: 'AIzaSyD_JFByqlCyojA76X0odlT-nWnW5eTSW0s',
    appId: '1:832544989118:web:56a4a2ab798b010bae63ef',
    messagingSenderId: '832544989118',
    projectId: 'femn-9cabb',
    authDomain: 'femn-9cabb.firebaseapp.com',
    storageBucket: 'femn-9cabb.firebasestorage.app',
    measurementId: 'G-ZSZZYYEZGB',
  );

  static const FirebaseOptions android = FirebaseOptions(
    apiKey: 'AIzaSyAH-t2jr5YJYqF-yH1ONdbr0MLucrBb-DI',
    appId: '1:832544989118:android:313ad83b4e753868ae63ef',
    messagingSenderId: '832544989118',
    projectId: 'femn-9cabb',
    storageBucket: 'femn-9cabb.firebasestorage.app',
  );

  static const FirebaseOptions ios = FirebaseOptions(
    apiKey: 'AIzaSyDV3ZdVsPpg1TIFP9xLymXPlaXqbWFE9XQ',
    appId: '1:832544989118:ios:7623a889e9bd5b61ae63ef',
    messagingSenderId: '832544989118',
    projectId: 'femn-9cabb',
    storageBucket: 'femn-9cabb.firebasestorage.app',
    iosBundleId: 'com.example.femn',
  );

  static const FirebaseOptions macos = FirebaseOptions(
    apiKey: 'AIzaSyDV3ZdVsPpg1TIFP9xLymXPlaXqbWFE9XQ',
    appId: '1:832544989118:ios:7623a889e9bd5b61ae63ef',
    messagingSenderId: '832544989118',
    projectId: 'femn-9cabb',
    storageBucket: 'femn-9cabb.firebasestorage.app',
    iosBundleId: 'com.example.femn',
  );

  static const FirebaseOptions windows = FirebaseOptions(
    apiKey: 'AIzaSyD_JFByqlCyojA76X0odlT-nWnW5eTSW0s',
    appId: '1:832544989118:web:b583564fe254bf09ae63ef',
    messagingSenderId: '832544989118',
    projectId: 'femn-9cabb',
    authDomain: 'femn-9cabb.firebaseapp.com',
    storageBucket: 'femn-9cabb.firebasestorage.app',
    measurementId: 'G-HJJP1BWG8T',
  );
}


--- C:\Code\femn\lib\main.dart ---

import 'package:femn/feed/addpost.dart';
import 'package:femn/circle/groups.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:femn/hub_screens/messaging.dart';
import 'package:femn/hub_screens/wellness.dart';
import 'package:femn/customization/colors.dart'; // <--- IMPORT YOUR COLORS FILE
import 'package:firebase_auth/firebase_auth.dart' hide AuthProvider;
import 'package:firebase_core/firebase_core.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'auth/auth.dart';
import 'hub_screens/post.dart';
import 'circle/campaign.dart'; // Ensure filename matches (campaign.dart or campaigns.dart)
import 'auth/auth_provider.dart';
import 'customization/fonts.dart';
import 'package:app_links/app_links.dart'; // <--- ADD THIS IMPORT
import 'dart:async';
import 'package:femn/services/deep_link_service.dart';

import 'package:firebase_app_check/firebase_app_check.dart';
import 'firebase_options.dart';
import 'package:femn/widgets/femn_background.dart';

import 'services/notification_service.dart'; // <--- Notification Service
import 'services/navigation_service.dart'; // <--- ADD THIS

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);

  // Activate App Check with debug providers
  await FirebaseAppCheck.instance.activate(
    androidProvider: AndroidProvider.debug,
    appleProvider: AppleProvider.debug,
  );

  runApp(
    ChangeNotifierProvider(create: (context) => AuthProvider(), child: MyApp()),
  );

  // Initialize Notifications
  NotificationService().initialize();
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      navigatorKey: NavigationService.navigatorKey,
      title: 'Femn',
      theme: ThemeData(
        // --- 1. Global Color Settings ---
        brightness: Brightness.dark,
        primaryColor: AppColors.primaryLavender,
        scaffoldBackgroundColor: Colors.transparent, // Deep Dark Background

        colorScheme: ColorScheme.dark(
          primary: AppColors.primaryLavender,
          secondary: AppColors.secondaryTeal,
          surface: AppColors.surface,
          onPrimary: AppColors.backgroundDeep, // Dark text on Lavender buttons
          onSecondary: Colors.white, // White text on Teal elements
          onSurface: AppColors.textHigh, // Off-white text on surfaces
          error: AppColors.error,
        ),

        // --- 2. Text Theme (Defaulting to Off-White) ---
        textTheme: TextTheme(
          bodyLarge: primaryTextStyle(
            fontSize: 18.0,
            color: AppColors.textHigh,
          ),
          bodyMedium: primaryTextStyle(
            fontSize: 16.0,
            color: AppColors.textMedium,
          ),
          displayLarge: primaryVeryBoldTextStyle(
            fontSize: 32.0,
            color: AppColors.textHigh,
          ),
          displayMedium: primaryVeryBoldTextStyle(
            fontSize: 28.0,
            color: AppColors.textHigh,
          ),
          displaySmall: primaryVeryBoldTextStyle(
            fontSize: 24.0,
            color: AppColors.textHigh,
          ),
          headlineMedium: primaryVeryBoldTextStyle(
            fontSize: 20.0,
            color: AppColors.textHigh,
          ),
          headlineSmall: primaryVeryBoldTextStyle(
            fontSize: 18.0,
            color: AppColors.textHigh,
          ),
          titleLarge: primaryVeryBoldTextStyle(
            fontSize: 16.0,
            color: AppColors.textHigh,
          ),
          titleMedium: secondaryTextStyle(
            fontSize: 16.0,
            fontWeight: FontWeight.bold,
            color: AppColors.textHigh,
          ),
          titleSmall: secondaryTextStyle(
            fontSize: 14.0,
            fontWeight: FontWeight.bold,
            color: AppColors.textHigh,
          ),
          bodySmall: secondaryTextStyle(
            fontSize: 12.0,
            color: AppColors.textMedium,
          ),
          labelLarge: secondaryVeryBoldTextStyle(
            fontSize: 16.0,
            color: AppColors.textHigh,
          ),
          labelSmall: secondaryTextStyle(
            fontSize: 10.0,
            color: AppColors.textMedium,
          ),
        ),

        // --- 3. Component Themes ---
        appBarTheme: AppBarTheme(
          backgroundColor: Colors.transparent,
          elevation: 0,
          iconTheme: IconThemeData(color: AppColors.primaryLavender),
          titleTextStyle: TextStyle(
            color: AppColors.textHigh,
            fontSize: 20,
            fontWeight: FontWeight.bold,
          ),
        ),

        elevatedButtonTheme: ElevatedButtonThemeData(
          style: ElevatedButton.styleFrom(
            backgroundColor: AppColors.primaryLavender,
            foregroundColor: AppColors.backgroundDeep, // Dark text on button
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(14),
            ),
            padding: EdgeInsets.symmetric(vertical: 14, horizontal: 20),
            textStyle: secondaryVeryBoldTextStyle(
              fontSize: 16,
              color: AppColors.backgroundDeep,
            ),
            elevation: 2,
          ),
        ),

        inputDecorationTheme: InputDecorationTheme(
          filled: true,
          fillColor: AppColors.elevation, // Dark container for inputs
          contentPadding: EdgeInsets.symmetric(vertical: 14, horizontal: 16),
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(14),
            borderSide: BorderSide.none,
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(14),
            borderSide: BorderSide(
              color: AppColors.primaryLavender,
              width: 1.5,
            ),
          ),
          labelStyle: secondaryTextStyle(color: AppColors.textMedium),
          hintStyle: secondaryTextStyle(color: AppColors.textDisabled),
        ),

        cardTheme: CardThemeData(
          color: AppColors.surface, // Dark surface for cards
          elevation: 2,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
        ),

        iconTheme: IconThemeData(color: AppColors.primaryLavender),

        bottomSheetTheme: BottomSheetThemeData(
          backgroundColor: AppColors.surface,
          modalBackgroundColor: AppColors.surface,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
          ),
        ),
      ),
      builder: (context, child) {
        return FemnBackground(child: child!);
      },
      home: Consumer<AuthProvider>(
        builder: (context, authProvider, child) {
          return StreamBuilder<User?>(
            stream: FirebaseAuth.instance.authStateChanges(),
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.active) {
                User? user = snapshot.data;
                return user == null ? LoginScreen() : HomeScreen();
              }
              return Scaffold(
                backgroundColor: Colors.transparent,
                body: Center(
                  child: CircularProgressIndicator(
                    color: AppColors.primaryLavender,
                  ),
                ),
              );
            },
          );
        },
      ),
      debugShowCheckedModeBanner: false,
    );
  }
}

// Home Screen with Bottom Navigation
class HomeScreen extends StatefulWidget {
  @override
  _HomeScreenState createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  int _currentIndex = 0;

  // --- DEEP LINKING VARIABLES ---
  late AppLinks _appLinks;
  StreamSubscription<Uri>? _linkSubscription;

  final List<Widget> _screens = [
    FeedScreen(),
    GroupsScreen(),
    WellnessScreen(),
    CampaignsScreen(),
    MessagingScreen(),
  ];

  @override
  void initState() {
    super.initState();
    _initDeepLinks(); // <--- Initialize Listener on Startup
  }

  @override
  void dispose() {
    _linkSubscription?.cancel(); // <--- Clean up when screen closes
    super.dispose();
  }

  // --- DEEP LINKING LOGIC ---
  Future<void> _initDeepLinks() async {
    _appLinks = AppLinks();

    // 1. Handle "Cold Start" (App was closed, link opened it)
    try {
      final Uri? initialUri = await _appLinks.getInitialLink();
      if (initialUri != null) {
        _handleLink(initialUri);
      }
    } catch (e) {
      print("Deep Link Error: $e");
    }

    // 2. Handle "Warm Start" (App was in background, link brought it to front)
    _linkSubscription = _appLinks.uriLinkStream.listen((uri) {
      _handleLink(uri);
    });
  }

  Future<void> _handleLink(Uri uri) async {
    print("Link received: $uri");

    if (uri.pathSegments.contains('post')) {
      final String postId = uri.pathSegments.last;

      // Show loading indicator
      if (!mounted) return;
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (c) => const Center(
          child: CircularProgressIndicator(color: AppColors.primaryLavender),
        ),
      );

      try {
        final doc = await FirebaseFirestore.instance
            .collection('posts')
            .doc(postId)
            .get();

        // Dismiss loading
        if (mounted) Navigator.pop(context);

        if (doc.exists) {
          final data = doc.data();
          final userId = data?['userId'];

          if (userId != null && mounted) {
            Navigator.of(context).push(
              MaterialPageRoute(
                builder: (context) => PostDetailScreen(
                  postId: postId,
                  userId: userId,
                  source: 'deep_link',
                ),
              ),
            );
          } else if (mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(
                content: Text("Error: Post has no author associated"),
                backgroundColor: AppColors.error,
              ),
            );
          }
        } else if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text("Post not found"),
              backgroundColor: AppColors.error,
            ),
          );
        }
      } catch (e) {
        if (mounted && Navigator.canPop(context))
          Navigator.pop(context); // Ensure dialog closes
        print("Deep link navigation error: $e");
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text("Error opening post"),
              backgroundColor: AppColors.error,
            ),
          );
        }
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent, // Allow background to show
      body: _screens[_currentIndex],
      extendBody: true, // Allows content to go behind the floating nav bar
      extendBodyBehindAppBar: true,
      bottomNavigationBar: Padding(
        padding: const EdgeInsets.fromLTRB(12, 0, 12, 24), // bottom spacing
        child: Align(
          alignment: Alignment.bottomCenter, // center horizontally
          child: Container(
            width:
                MediaQuery.of(context).size.width *
                0.8, // Slightly wider for comfort
            height: 70,
            decoration: BoxDecoration(
              color: AppColors.surface.withOpacity(0.95), // Dark Surface
              borderRadius: BorderRadius.circular(40),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(
                    0.4,
                  ), // Stronger shadow for depth in dark mode
                  blurRadius: 20,
                  spreadRadius: 2,
                  offset: const Offset(0, 8),
                ),
              ],
              border: Border.all(color: AppColors.elevation, width: 1),
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceEvenly,
              children: [
                _buildNavItem(Feather.home, "Home", 0),
                _buildNavItem(Feather.hexagon, "Circle", 1),
                _buildNavItem(Feather.user, "You", 2),
                // _buildNavItem(Feather.flag, "Campaigns", 3), // Optional: Uncomment if you want 5 items
                _buildNavItem(Feather.message_circle, "Inbox", 4),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildNavItem(IconData icon, String label, int index) {
    final bool isSelected = _currentIndex == index;
    return GestureDetector(
      onTap: () => setState(() => _currentIndex = index),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 250),
        curve: Curves.easeInOut,
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        decoration: BoxDecoration(
          // Use Teal for selected state background, heavily transparent
          color: isSelected
              ? AppColors.secondaryTeal.withOpacity(0.3)
              : Colors.transparent,
          borderRadius: BorderRadius.circular(30),
        ),
        child: Row(
          children: [
            Icon(
              icon,
              size: isSelected ? 24 : 22,
              // Lavender for active, Medium Gray for inactive
              color: isSelected
                  ? AppColors.primaryLavender
                  : AppColors.textMedium.withOpacity(0.7),
            ),
            AnimatedSize(
              duration: const Duration(milliseconds: 250),
              curve: Curves.easeInOut,
              child: isSelected
                  ? Padding(
                      padding: const EdgeInsets.only(left: 8),
                      child: Text(
                        label,
                        style: TextStyle(
                          fontSize: 14,
                          fontWeight: FontWeight.bold,
                          color: AppColors.primaryLavender, // Lavender Text
                        ),
                      ),
                    )
                  : const SizedBox.shrink(),
            ),
          ],
        ),
      ),
    );
  }
}


--- C:\Code\femn\lib\analytics\models\analytics_models.dart ---

import 'package:flutter/material.dart';

// 1. Overview Dashboard
class OverviewStats {
  final int totalFollowers;
  final int followersGained; // Will be 0 if no history
  final int totalViews;
  final int totalLikes;
  final int totalComments;
  final int totalShares;
  final int profileVisits; // New
  final double engagementRate; // Percentage

  OverviewStats({
    required this.totalFollowers,
    required this.followersGained,
    required this.totalViews,
    required this.totalLikes,
    required this.totalComments,
    required this.totalShares,
    required this.profileVisits,
    required this.engagementRate,
  });
}

class GrowthPoint {
  final DateTime date;
  final int value;

  GrowthPoint(this.date, this.value);
}

// 2. Content Analytics
class ContentPerformance {
  final String id;
  final String title;
  final String type; // 'post', 'petition', 'poll'
  final String thumbnailUrl;
  final int views; 
  final int likes;
  final int comments;
  final int shares;      // New
  final int saves;       // New
  final int linkClicks;  // New
  final DateTime postedAt;
  final dynamic originalDoc; 
  final String? source; // Feed, Profile, Search etc (Primary source if aggregated)

  ContentPerformance({
    required this.id,
    required this.title,
    required this.type,
    required this.thumbnailUrl,
    required this.views,
    required this.likes,
    required this.comments,
    required this.shares,
    required this.saves,
    required this.linkClicks,
    required this.postedAt,
    this.originalDoc,
    this.source,
  });
}

// 3. Audience Insights
class AudienceDemographic {
  final String label; // e.g., "18-24", "Female"
  final double percentage; // 0-100

  AudienceDemographic(this.label, this.percentage);
}

class ActivityHour {
  final int hour; // 0-23
  final int activityLevel; // 0-100 scale

  ActivityHour(this.hour, this.activityLevel);
}

class AudienceData {
  final List<AudienceDemographic> ageGroups;
  final List<AudienceDemographic> genderBreakdown;
  final List<AudienceDemographic> topLocations; 
  final List<ActivityHour> activityByHour;

  AudienceData({
    required this.ageGroups,
    required this.genderBreakdown,
    required this.topLocations,
    required this.activityByHour,
  });
}

// 4. Engagement Metrics (Simplified - removed sentiment)
class EngagementMetrics {
  final double likeToCommentRatio;
  final double responseRate;

  EngagementMetrics({
    required this.likeToCommentRatio,
    required this.responseRate,
  });
}

// 5. Campaign/Advocacy Analytics
class CampaignStats {
  final String campaignId;
  final String title;
  final int signatures;
  final int goal;
  final double progress; // 0-1

  CampaignStats({
    required this.campaignId,
    required this.title,
    required this.signatures,
    required this.goal,
    required this.progress,
  });
}

// 6. Monetization (Embers)
class RevenueData {
  final int totalEmbers;
  final int fromContent;
  final int fromPartnerships;
  final List<GrowthPoint> earnedHistory;

  RevenueData({
    required this.totalEmbers,
    required this.fromContent,
    required this.fromPartnerships,
    required this.earnedHistory,
  });
}

// 7. Competitive Analysis
class CompetitiveBenchmark {
  final String metricName; 
  final double yourValue;
  final double industryAverage;
  final double topCreatorAverage;

  CompetitiveBenchmark({
    required this.metricName,
    required this.yourValue,
    required this.industryAverage,
    required this.topCreatorAverage,
  });
}

// --- NEW DEEP ANALYTICS MODELS ---

class TrafficSourceData {
  final String sourceName; // e.g., "For You", "Profile", "Search"
  final int visits;
  final double percentage;

  TrafficSourceData(this.sourceName, this.visits, this.percentage);
}

class GeoImpactData {
  final String region;
  final int count;
  final double percentage;

  GeoImpactData(this.region, this.count, this.percentage);
}

class PetitionFunnelData {
  final String step; // "Views", "Signatures", "Shares"
  final int count;
  final double conversionRate; // % from previous step

  PetitionFunnelData(this.step, this.count, this.conversionRate);
}

class CommunityStats {
  final String groupId;
  final String groupName;
  final int engagementCount;

  CommunityStats(this.groupId, this.groupName, this.engagementCount);
}

class DeepAnalyticsData {
  final List<TrafficSourceData> trafficSources;
  final List<GeoImpactData> geoImpact; // For petitions
  final List<PetitionFunnelData> petitionFunnel;
  final List<CommunityStats> communityPerformance;

  DeepAnalyticsData({
    required this.trafficSources,
    required this.geoImpact,
    required this.petitionFunnel,
    required this.communityPerformance,
  });
}

// Singleton Container for all Dashboard Data
class AnalyticsDashboardData {
  final OverviewStats overview;
  final List<GrowthPoint> followerGrowth;
  final List<ContentPerformance> topContent;
  final AudienceData audience;
  final EngagementMetrics engagement;
  final List<CampaignStats> campaigns;
  final RevenueData revenue;
  final List<CompetitiveBenchmark> benchmarks;
  final DeepAnalyticsData deepStats; // NEW

  AnalyticsDashboardData({
    required this.overview,
    required this.followerGrowth,
    required this.topContent,
    required this.audience,
    required this.engagement,
    required this.campaigns,
    required this.revenue,
    required this.benchmarks,
    required this.deepStats,
  });
}


--- C:\Code\femn\lib\analytics\screens\analytics_dashboard.dart ---

import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:shimmer/shimmer.dart';
import '../../customization/colors.dart';
import '../../customization/fonts.dart';
import '../models/analytics_models.dart';
import '../services/analytics_service.dart';
import '../widgets/analytics_sections.dart';
import '../../widgets/femn_background.dart';

class AnalyticsDashboardScreen extends StatefulWidget {
  @override
  _AnalyticsDashboardScreenState createState() => _AnalyticsDashboardScreenState();
}

class _AnalyticsDashboardScreenState extends State<AnalyticsDashboardScreen> {
  int _selectedDays = 30; // Default view
  late Future<AnalyticsDashboardData> _dataFuture;
  final AnalyticsService _service = AnalyticsService();

  @override
  void initState() {
    super.initState();
    _loadData();
  }

  void _loadData() {
    setState(() {
      _dataFuture = _service.fetchDashboardData(_selectedDays);
    });
  }

  void _onDaysChanged(int days) {
    if (_selectedDays == days) return;
    _selectedDays = days;
    _loadData();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent, // Uses FemnBackground from main
      appBar: AppBar(
        title: Text("Creator Analytics", style: primaryVeryBoldTextStyle(fontSize: 20, color: AppColors.textHigh)),
        backgroundColor: Colors.transparent,
        leading: IconButton(
          icon: Icon(Feather.arrow_left, color: AppColors.primaryLavender),
          onPressed: () => Navigator.pop(context),
        ),
      ),
      body: FemnBackground(
        child: RefreshIndicator(
          onRefresh: () async {
            _loadData();
            await _dataFuture;
          },
          color: AppColors.primaryLavender,
          child: SingleChildScrollView(
            padding: EdgeInsets.all(16),
            child: FutureBuilder<AnalyticsDashboardData>(
              future: _dataFuture,
              builder: (context, snapshot) {
                if (snapshot.connectionState == ConnectionState.waiting) {
                  return _buildLoading();
                } else if (snapshot.hasError) {
                  return Center(child: Text("Error loading analytics", style: TextStyle(color: AppColors.error)));
                } else if (!snapshot.hasData) {
                  return Center(child: Text("No data available"));
                }

                final data = snapshot.data!;
                return Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // Time Range Selector
                    _buildTimeSelector(),
                    SizedBox(height: 24),

                    // 1. Overview
                    AnalyticsSectionHeader(title: "Overview", icon: Feather.activity),
                    OverviewSection(stats: data.overview, growth: data.followerGrowth),

                    // 2. Content Performance
                    SizedBox(height: 12),
                    AnalyticsSectionHeader(title: "Top Content", icon: Feather.video, onMore: () {}),
                    ContentSection(content: data.topContent),

                    // 3. Audience
                    AnalyticsSectionHeader(title: "Audience Insights", icon: Feather.users),
                    AudienceSection(data: data.audience),
                    
                    // 3.5 Deep Insights (Traffic, Geo, Funnel)
                    DeepInsightsSection(stats: data.deepStats),

                    // 4. Campaigns
                    if (data.campaigns.isNotEmpty) ...[
                      AnalyticsSectionHeader(title: "Advocacy Impact", icon: Feather.flag),
                      CampaignSection(campaigns: data.campaigns),
                    ],

                    // 5. Monetization
                    AnalyticsSectionHeader(title: "Earnings", icon: Feather.dollar_sign),
                    _buildMonetizationCard(data.revenue),
                    
                    // 6. Benchmarks
                    AnalyticsSectionHeader(title: "Competitive Benchmark", icon: Feather.bar_chart_2),
                    _buildBenchmarkList(data.benchmarks),

                    SizedBox(height: 48),
                  ],
                );
              },
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildTimeSelector() {
    return Container(
      padding: EdgeInsets.all(4),
      decoration: BoxDecoration(
        color: AppColors.elevation,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Row(
        children: [
          _buildTimeOption("7 Days", 7),
          _buildTimeOption("30 Days", 30),
          _buildTimeOption("90 Days", 90),
        ],
      ),
    );
  }

  Widget _buildTimeOption(String label, int days) {
    bool isSelected = _selectedDays == days;
    return Expanded(
      child: GestureDetector(
        onTap: () => _onDaysChanged(days),
        child: AnimatedContainer(
          duration: Duration(milliseconds: 200),
          padding: EdgeInsets.symmetric(vertical: 10),
          decoration: BoxDecoration(
            color: isSelected ? AppColors.surface : Colors.transparent,
            borderRadius: BorderRadius.circular(8),
            boxShadow: isSelected ? [BoxShadow(color: Colors.black12, blurRadius: 4)] : [],
          ),
          child: Text(
            label,
            textAlign: TextAlign.center,
            style: TextStyle(
              fontWeight: FontWeight.bold,
              color: isSelected ? AppColors.primaryLavender : AppColors.textMedium,
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildMonetizationCard(RevenueData revenue) {
    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.elevation,
        borderRadius: BorderRadius.circular(16),
      ),
      child: Row(
        children: [
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text("Total Embers Earned", style: secondaryTextStyle(fontSize: 12, color: AppColors.textMedium)),
                SizedBox(height: 4),
                Row(
                  children: [
                    Icon(Feather.zap, color: AppColors.accentMustard, size: 20),
                    SizedBox(width: 4),
                    Text("${revenue.totalEmbers}", style: primaryVeryBoldTextStyle(fontSize: 24, color: AppColors.textHigh)),
                  ],
                ),
              ],
            ),
          ),
          Container(height: 40, width: 1, color: Colors.white10),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                Text("Content", style: secondaryTextStyle(fontSize: 12, color: AppColors.textMedium)),
                Text("${revenue.fromContent}", style: primaryVeryBoldTextStyle(fontSize: 16, color: AppColors.textHigh)),
                SizedBox(height: 4),
                Text("Partnerships", style: secondaryTextStyle(fontSize: 12, color: AppColors.textMedium)),
                Text("${revenue.fromPartnerships}", style: primaryVeryBoldTextStyle(fontSize: 16, color: AppColors.textHigh)),
              ],
            ),
          ),
        ],
      ),
    );
  }

  // Removed _buildPredictionCard and _buildEngagementCard

  Widget _buildBenchmarkList(List<CompetitiveBenchmark> benchmarks) {
    return Column(
      children: benchmarks.map((b) {
        return Container(
          margin: EdgeInsets.only(bottom: 8),
          padding: EdgeInsets.all(12),
          decoration: BoxDecoration(
            color: AppColors.elevation,
            borderRadius: BorderRadius.circular(12),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(b.metricName, style: secondaryVeryBoldTextStyle(fontSize: 14, color: AppColors.textHigh)),
              SizedBox(height: 8),
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text("You: ${b.yourValue}%", style: TextStyle(color: AppColors.primaryLavender, fontWeight: FontWeight.bold)),
                  Text("Avg: ${b.industryAverage}%", style: TextStyle(color: AppColors.textMedium)),
                ],
              ),
              SizedBox(height: 8),
              Stack(
                children: [
                  Container(height: 6, decoration: BoxDecoration(color: Colors.white10, borderRadius: BorderRadius.circular(3))),
                  FractionallySizedBox(
                    widthFactor: (b.yourValue / (b.topCreatorAverage * 1.2)).clamp(0.0, 1.0),
                    child: Container(height: 6, decoration: BoxDecoration(color: AppColors.primaryLavender, borderRadius: BorderRadius.circular(3))),
                  ),
                ],
              )
            ],
          ),
        );
      }).toList(),
    );
  }

  Widget _buildLoading() {
    return Shimmer.fromColors(
      baseColor: AppColors.elevation,
      highlightColor: AppColors.surface,
      child: Column(
        children: List.generate(5, (index) => 
          Container(
            height: 150, 
            margin: EdgeInsets.only(bottom: 16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(16)
            ),
          )
        ),
      ),
    );
  }
}


--- C:\Code\femn\lib\analytics\screens\expanded_post_screen.dart ---

import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import '../../customization/colors.dart';
import '../../hub_screens/post.dart';
import '../../widgets/femn_background.dart';

class ExpandedPostScreen extends StatelessWidget {
  final String postId;

  const ExpandedPostScreen({Key? key, required this.postId}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      extendBodyBehindAppBar: true,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: Container(
          margin: const EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: AppColors.elevation.withOpacity(0.8),
            shape: BoxShape.circle,
          ),
          child: IconButton(
            icon: const Icon(Feather.arrow_left, color: AppColors.textHigh, size: 20),
            onPressed: () => Navigator.pop(context),
          ),
        ),
      ),
      body: FemnBackground(
        child: SingleChildScrollView(
          padding: EdgeInsets.only(top: 80, bottom: 20),
          child: Column(
            children: [
              PostCardWithStream(postId: postId),
            ],
          ),
        ),
      ),
    );
  }
}


--- C:\Code\femn\lib\analytics\services\analytics_service.dart ---

import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../models/analytics_models.dart';

class AnalyticsService {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;

  Future<AnalyticsDashboardData> fetchDashboardData(int days) async {
    final user = _auth.currentUser;
    if (user == null) throw Exception("User not logged in");
    final uid = user.uid;

    // 1. Fetch User Data (Followers, Embers)
    final userDoc = await _firestore.collection('users').doc(uid).get();
    final userData = userDoc.data() ?? {};
    
    // Followers & Visits
    final followersList = List<String>.from(userData['followers'] ?? []);
    final int totalFollowers = followersList.length;
    final int profileVisits = (userData['profileVisits'] as int?) ?? 0;
    
    // Embers (Earnings)
    final int totalEmbers = (userData['embers'] as int?) ?? 0;

    // 2. Fetch Content (Posts, Petitions, Polls)
    List<ContentPerformance> allContent = [];
    int totalViews = 0;
    int totalLikes = 0;
    int sumComments = 0;
    int totalShares = 0;
    int totalSaves = 0;
    int totalLinkClicks = 0;
    List<CampaignStats> campaigns = [];

    // --- A. POSTS ---
    final postsSnap = await _firestore
        .collection('posts')
        .where('userId', isEqualTo: uid)
        .orderBy('timestamp', descending: true)
        .get();

    for (var doc in postsSnap.docs) {
      final data = doc.data();
      final likes = (data['likes'] as List?)?.length ?? 0;
      final comments = (data['commentsCount'] as int?) ?? 0; 
      final views = (data['views'] as int?) ?? 0;
      final shares = (data['shares'] as int?) ?? 0; // New
      final saves = (data['saves'] as int?) ?? 0;   // New
      final linkClicks = (data['linkClicks'] as int?) ?? 0; // New
      
      totalViews += views;
      totalLikes += likes;
      sumComments += comments;
      totalShares += shares;
      totalSaves += saves;
      totalLinkClicks += linkClicks;

      allContent.add(ContentPerformance(
        id: doc.id,
        title: data['description'] ?? 'Untitled Post',
        type: 'post',
        thumbnailUrl: data['thumbnailUrl'] ?? data['imageUrl'] ?? '',
        views: views,
        likes: likes,
        comments: comments,
        shares: shares,
        saves: saves,
        linkClicks: linkClicks,
        postedAt: (data['timestamp'] as Timestamp?)?.toDate() ?? DateTime.now(),
        originalDoc: doc,
      ));
    }

    // --- B. PETITIONS (Campaigns) ---
    final petitionsSnap = await _firestore
        .collection('petitions')
        .where('createdBy', isEqualTo: uid)
        .get();

    for (var doc in petitionsSnap.docs) {
      final data = doc.data();
      final sigs = (data['currentSignatures'] as int?) ?? 0;
      final goal = (data['goal'] as int?) ?? 1000;
      final banner = data['bannerImageUrl'] ?? data['imageUrl'] ?? '';
      
      campaigns.add(CampaignStats(
        campaignId: doc.id,
        title: data['title'] ?? 'Petition',
        signatures: sigs,
        goal: goal,
        progress: goal > 0 ? sigs / goal : 0.0,
      ));

      allContent.add(ContentPerformance(
        id: doc.id,
        title: data['title'] ?? 'Petition',
        type: 'petition',
        thumbnailUrl: banner,
        views: (data['views'] as int?) ?? 0, // FIXED: Use actual views
        likes: (data['signers'] as List?)?.length ?? 0, 
        comments: 0,
        shares: (data['shares'] as int?) ?? 0,
        saves: 0,
        linkClicks: 0,
        postedAt: (data['createdAt'] as Timestamp?)?.toDate() ?? DateTime.now(),
        originalDoc: doc,
      ));
    }

    // --- C. POLLS ---
    final pollsSnap = await _firestore
        .collection('polls')
        .where('createdBy', isEqualTo: uid)
        .get();

    for (var doc in pollsSnap.docs) {
      final data = doc.data();
      final options = data['options'] as List? ?? [];
      int totalVotes = 0;
      for (var opt in options) {
        totalVotes += (opt['votes'] as int?) ?? 0;
      }

      allContent.add(ContentPerformance(
        id: doc.id,
        title: data['question'] ?? 'Poll',
        type: 'poll',
        thumbnailUrl: data['imageUrl'] ?? '',
        views: totalVotes,
        likes: (data['voters'] as List?)?.length ?? 0,
        comments: 0, 
        shares: (data['shares'] as int?) ?? 0,
        saves: 0,
        linkClicks: 0,
        postedAt: (data['createdAt'] as Timestamp?)?.toDate() ?? DateTime.now(),
        originalDoc: doc,
      ));
    }

    // 3. Sort & Aggregates
    allContent.sort((a, b) => b.views.compareTo(a.views));
    final topContent = allContent.take(5).toList();

    // Weighted Engagement Rate
    // (Likes*1 + Comments*2 + Shares*3 + Saves*3) / Views * 100
    double engagementRate = 0.0;
    if (totalViews > 0) {
      double weightedScore = (totalLikes * 1.0) + (sumComments * 2.0) + (totalShares * 3.0) + (totalSaves * 3.0);
      engagementRate = (weightedScore / totalViews) * 100;
    }

    // 4. Demographics (Sampling)
    final audienceData = await _fetchDemographics(followersList);

    // 5. Growth History (Snapshot)
    List<GrowthPoint> followerGrowth = []; 
    followerGrowth.add(GrowthPoint(DateTime.now(), totalFollowers));

    // 6. Deep Analytics (Traffic, Geo, Funnel)
    final deepStats = await _fetchDeepAnalytics(uid, allContent);

    return AnalyticsDashboardData(
      overview: OverviewStats(
        totalFollowers: totalFollowers,
        followersGained: 0,
        totalViews: totalViews,
        totalLikes: totalLikes,
        totalComments: sumComments,
        totalShares: totalShares,
        profileVisits: profileVisits, // Real data
        engagementRate: engagementRate,
      ),
      followerGrowth: followerGrowth,
      topContent: topContent,
      audience: audienceData,
      engagement: EngagementMetrics( 
        likeToCommentRatio: sumComments > 0 ? totalLikes / sumComments : 0,
        responseRate: 0, 
      ),
      campaigns: campaigns,
      revenue: RevenueData(
        totalEmbers: totalEmbers,
        fromContent: 0,
        fromPartnerships: 0,
        earnedHistory: [],
      ),
      benchmarks: [], 
      deepStats: deepStats,
    );
  }

  Future<AudienceData> _fetchDemographics(List<String> followerIds) async {
    // Sample first 50 followers to save reads/performance
    final sampleIds = followerIds.take(50).toList();
    if (sampleIds.isEmpty) {
      return AudienceData(ageGroups: [], genderBreakdown: [], topLocations: [], activityByHour: []);
    }

    Map<String, int> genderCount = {};
    Map<String, int> ageCount = {};

    // Firestore allows 'IN' queries up to 10-30 items (we'll do batch of 10)
    // Actually fetching individually might be simpler for logic, or chunking.
    // Let's iterate fetches safely (Parallel futures)
    
    // Chunking to batches of 10
    List<Future<QuerySnapshot>> futures = [];
    for (var i = 0; i < sampleIds.length; i += 10) {
      var end = (i + 10 < sampleIds.length) ? i + 10 : sampleIds.length;
      var batch = sampleIds.sublist(i, end);
      if (batch.isNotEmpty) {
        futures.add(_firestore.collection('users').where(FieldPath.documentId, whereIn: batch).get());
      }
    }

    final snapshots = await Future.wait(futures);

    for (var snap in snapshots) {
      for (var doc in snap.docs) {
        final data = doc.data() as Map<String, dynamic>;
        
        // Gender
        String gender = data['gender'] ?? 'Unknown';
        if (gender.isEmpty) gender = 'Unknown';
        genderCount[gender] = (genderCount[gender] ?? 0) + 1;

        // Age
        if (data['dateOfBirth'] != null) {
          DateTime dob = (data['dateOfBirth'] as Timestamp).toDate();
          int age = DateTime.now().year - dob.year;
          String bucket = _getAgeBucket(age);
          ageCount[bucket] = (ageCount[bucket] ?? 0) + 1;
        } else {
          ageCount['Unknown'] = (ageCount['Unknown'] ?? 0) + 1;
        }
      }
    }

    // Convert to Percentages
    int totalSample = sampleIds.length; // Actually count docs found?
    // Better to use actual docs count
    int fetchedDocs = snapshots.fold(0, (sum, snap) => sum + snap.docs.length);
    if (fetchedDocs == 0) fetchedDocs = 1;

    List<AudienceDemographic> genderList = genderCount.entries.map((e) {
      return AudienceDemographic(e.key, (e.value / fetchedDocs) * 100);
    }).toList();

    List<AudienceDemographic> ageList = ageCount.entries.map((e) {
      return AudienceDemographic(e.key, (e.value / fetchedDocs) * 100);
    }).toList();

    return AudienceData(
      ageGroups: ageList,
      genderBreakdown: genderList,
      topLocations: [], // Adding location requires checking specific field availability
      activityByHour: [],
    );
  }

  // --- DEEP ANALYTICS ---
  Future<DeepAnalyticsData> _fetchDeepAnalytics(String uid, List<ContentPerformance> allContent) async {
    // 1. Traffic Sources (from aggregated map)
    final userDoc = await _firestore.collection('users').doc(uid).get();
    final userData = userDoc.data() as Map<String, dynamic>? ?? {};
    final Map<String, dynamic> breakdown = userData['trafficBreakdown'] ?? {};
    
    Map<String, int> sourceCounts = {};
    int totalVisits = 0;
    
    breakdown.forEach((key, value) {
      if (value is int) {
        sourceCounts[key] = value;
        totalVisits += value;
      }
    });
    
    // Sort keys and format for UI
    List<TrafficSourceData> trafficSources = sourceCounts.entries.map((e) {
      String label = e.key;
      // Capitalize first letter or map to friendly names
      if (label == 'feed') label = 'For You Feed';
      if (label == 'profile') label = 'Profile Visits';
      if (label == 'search') label = 'Search';
      if (label == 'hashtag') label = 'Hashtags';
      
      return TrafficSourceData(
        label, 
        e.value, 
        totalVisits > 0 ? (e.value / totalVisits) * 100 : 0
      );
    }).toList();
    
    trafficSources.sort((a, b) => b.visits.compareTo(a.visits));

    
    // 2. Geo Impact (Petitions)
    // Filter petitions from allContent
    final petitions = allContent.where((c) => c.type == 'petition').toList();
    List<GeoImpactData> geoImpact = [];
    
    if (petitions.isNotEmpty) {
      // Sample up to 50 signers from the most popular petition
      // (Fetching ALL signers for ALL petitions is too heavy)
      final topPetition = petitions.first;
      // We need to fetch the actual petition doc to get the signers list
      // ContentPerformance has originalDoc, but let's be safe
      if (topPetition.originalDoc != null) {
        final data = topPetition.originalDoc!.data() as Map<String, dynamic>;
        final List signers = data['signers'] ?? [];
        final sampleSigners = signers.take(50).toList(); // List of UIDs
        
        if (sampleSigners.isNotEmpty) {
           // Batch fetch users
           // Reuse demographic logic pattern
           Map<String, int> regionCounts = {};
           int regionTotal = 0;
           
           List<Future<QuerySnapshot>> futures = [];
           for (var i = 0; i < sampleSigners.length; i += 10) {
             var end = (i + 10 < sampleSigners.length) ? i + 10 : sampleSigners.length;
             var batch = sampleSigners.sublist(i, end);
             if (batch.isNotEmpty) {
                futures.add(_firestore.collection('users').where(FieldPath.documentId, whereIn: batch).get());
             }
           }
           
           final snapshots = await Future.wait(futures);
           for (var snap in snapshots) {
             for (var doc in snap.docs) {
               final userData = doc.data() as Map<String, dynamic>;
               String region = userData['region'] ?? userData['country'] ?? 'Unknown';
               regionCounts[region] = (regionCounts[region] ?? 0) + 1;
               regionTotal++;
             }
           }
           
           if (regionTotal > 0) {
             geoImpact = regionCounts.entries.map((e) {
               return GeoImpactData(e.key, e.value, (e.value / regionTotal) * 100);
             }).toList();
           }
        }
      }
    }

    // 3. Petition Funnel
    // Aggregated from all petitions
    int totalPetitionViews = 0;
    int totalSignatures = 0;
    int totalPetitionShares = 0;
    
    for (var p in petitions) {
      totalPetitionViews += p.views;
      totalSignatures += p.likes; // We mapped signatures to 'likes' field in ContentPerformance
      totalPetitionShares += p.shares;
    }
    
    List<PetitionFunnelData> funnel = [
      PetitionFunnelData("Views", totalPetitionViews, 100.0),
      PetitionFunnelData("Signatures", totalSignatures, totalPetitionViews > 0 ? (totalSignatures / totalPetitionViews) * 100 : 0),
      PetitionFunnelData("Shares", totalPetitionShares, totalSignatures > 0 ? (totalPetitionShares / totalSignatures) * 100 : 0),
    ];
    
    // 4. Community/Groups Performance
    // Fetch groups owned by user
    List<CommunityStats> communities = [];
    try {
      final groupSnap = await _firestore.collection('groups')
          .where('createdBy', isEqualTo: uid)
          .limit(5)
          .get();
          
      for (var doc in groupSnap.docs) {
        final data = doc.data();
        communities.add(CommunityStats(
          doc.id,
          data['name'] ?? 'Untitled Group',
          (data['memberCount'] as int?) ?? 0
        ));
      }
    } catch (e) {
      print("Error fetching groups: $e");
    }

    return DeepAnalyticsData(
      trafficSources: trafficSources,
      geoImpact: geoImpact,
      petitionFunnel: funnel,
      communityPerformance: communities,
    );
  }

  String _getAgeBucket(int age) {
    if (age < 18) return '13-17';
    if (age <= 24) return '18-24';
    if (age <= 34) return '25-34';
    if (age <= 44) return '35-44';
    if (age <= 54) return '45-54';
    return '55+';
  }
}


--- C:\Code\femn\lib\analytics\widgets\analytics_charts.dart ---

import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/material.dart';
import '../../customization/colors.dart';
import '../models/analytics_models.dart';

class GrowthLineChart extends StatelessWidget {
  final List<GrowthPoint> points;
  final bool isRevenue;

  const GrowthLineChart({Key? key, required this.points, this.isRevenue = false}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    if (points.isEmpty) return Center(child: Text("No Data"));

    final sorted = List<GrowthPoint>.from(points)..sort((a, b) => a.date.compareTo(b.date));
    double minY = sorted.map((e) => e.value.toDouble()).reduce((a, b) => a < b ? a : b);
    double maxY = sorted.map((e) => e.value.toDouble()).reduce((a, b) => a > b ? a : b);
    
    // Add buffer
    minY = (minY * 0.9).floorToDouble();
    maxY = (maxY * 1.1).ceilToDouble();

    return LineChart(
      LineChartData(
        gridData: FlGridData(
          show: true, 
          drawVerticalLine: false,
          getDrawingHorizontalLine: (value) => FlLine(color: AppColors.textDisabled.withOpacity(0.1), strokeWidth: 1),
        ),
        titlesData: FlTitlesData(
          show: true,
          bottomTitles: AxisTitles(
            sideTitles: SideTitles(showTitles: false), // Hide dates for cleaner look, or implement flexible logic
          ),
          leftTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
          topTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
          rightTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
        ),
        borderData: FlBorderData(show: false),
        minX: 0,
        maxX: (sorted.length - 1).toDouble(),
        minY: minY,
        maxY: maxY,
        lineBarsData: [
          LineChartBarData(
            spots: sorted.asMap().entries.map((e) {
              return FlSpot(e.key.toDouble(), e.value.value.toDouble());
            }).toList(),
            isCurved: true,
            color: AppColors.primaryLavender,
            barWidth: 3,
            isStrokeCapRound: true,
            dotData: FlDotData(show: false),
            belowBarData: BarAreaData(
              show: true,
              color: AppColors.primaryLavender.withOpacity(0.15),
            ),
          ),
        ],
      ),
    );
  }
}

class AudiencePieChart extends StatelessWidget {
  final List<AudienceDemographic> data;

  const AudiencePieChart({Key? key, required this.data}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    // Generate colors
    final colors = [
      AppColors.primaryLavender,
      AppColors.secondaryTeal,
      Colors.blueAccent,
      Colors.orangeAccent,
      Colors.pinkAccent,
    ];

    return PieChart(
      PieChartData(
        sectionsSpace: 2,
        centerSpaceRadius: 40,
        sections: data.asMap().entries.map((e) {
          final index = e.key;
          final item = e.value;
          return PieChartSectionData(
            color: colors[index % colors.length],
            value: item.percentage,
            title: '${item.percentage.round()}%',
            radius: 50,
            titleStyle: TextStyle(
              fontSize: 12,
              fontWeight: FontWeight.bold,
              color: Colors.white,
            ),
          );
        }).toList(),
      ),
    );
  }
}

class ActivityHeatmapBar extends StatelessWidget {
  final List<ActivityHour> activity;

  const ActivityHeatmapBar({Key? key, required this.activity}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 100,
      padding: EdgeInsets.symmetric(horizontal: 10),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.end,
        children: activity.map((h) {
          return Expanded(
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 2.0),
              child: Container(
                height: h.activityLevel.toDouble(), // Simple height scaling
                decoration: BoxDecoration(
                  color: AppColors.primaryLavender.withOpacity(h.activityLevel / 100),
                  borderRadius: BorderRadius.only(topLeft: Radius.circular(4), topRight: Radius.circular(4)),
                ),
              ),
            ),
          );
        }).toList(),
      ),
    );
  }
}


--- C:\Code\femn\lib\analytics\widgets\analytics_sections.dart ---

import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import '../../customization/colors.dart';
import '../../customization/fonts.dart';
import '../models/analytics_models.dart';
import 'analytics_charts.dart';
import 'package:intl/intl.dart';

// Navigation Imports
import '../screens/expanded_post_screen.dart';
import '../../circle/petitions.dart';
import '../../circle/polls.dart';
import '../../circle/poll_detail_screen.dart'; 
import '../../hub_screens/post.dart'; // Standard Post Detail
import 'deep_analytics_widgets.dart'; // Add Deep Analytics Widgets

// --- Helper for Section Headers ---
class AnalyticsSectionHeader extends StatelessWidget {
  final String title;
  final IconData icon;
  final VoidCallback? onMore;

  const AnalyticsSectionHeader({Key? key, required this.title, required this.icon, this.onMore}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 16.0),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Row(
            children: [
              Icon(icon, color: AppColors.primaryLavender, size: 20),
              SizedBox(width: 8),
              Text(
                title,
                style: primaryVeryBoldTextStyle(fontSize: 18, color: AppColors.textHigh),
              ),
            ],
          ),
          if (onMore != null)
            GestureDetector(
              onTap: onMore,
              child: Text("See All", style: secondaryTextStyle(fontSize: 12, color: AppColors.secondaryTeal)),
            ),
        ],
      ),
    );
  }
}

// --- 1. Overview Section ---
class OverviewSection extends StatelessWidget {
  final OverviewStats stats;
  final List<GrowthPoint> growth;

  const OverviewSection({Key? key, required this.stats, required this.growth}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Row(
          children: [
            Expanded(child: _buildStatCard("Followers", NumberFormat.compact().format(stats.totalFollowers), "+${stats.followersGained}", true)),
            SizedBox(width: 12),
            Expanded(child: _buildStatCard("Views", NumberFormat.compact().format(stats.totalViews), "---", true)),
          ],
        ),
        SizedBox(height: 12),
        Row(
          children: [
            Expanded(child: _buildStatCard("Engagement", "${stats.engagementRate.toStringAsFixed(1)}%", "Weighted Score", true)),
            SizedBox(width: 12),
            Expanded(child: _buildStatCard("Profile Visits", NumberFormat.compact().format(stats.profileVisits), "30d", true)),
          ],
        ),
        SizedBox(height: 24),
        
        // Only show chart if we have data (or at least one point)
        if (growth.isNotEmpty)
          Container(
            height: 200,
            padding: EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: AppColors.elevation,
              borderRadius: BorderRadius.circular(16),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text("Growth Trend", style: secondaryTextStyle(fontSize: 14, color: AppColors.textMedium)),
                SizedBox(height: 16),
                Expanded(child: GrowthLineChart(points: growth)),
              ],
            ),
          ),
      ],
    );
  }

  Widget _buildStatCard(String title, String value, String subtext, bool isPositive) {
    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.elevation,
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(title, style: secondaryTextStyle(fontSize: 12, color: AppColors.textMedium)),
          SizedBox(height: 8),
          Text(value, style: primaryVeryBoldTextStyle(fontSize: 20, color: AppColors.textHigh)),
          SizedBox(height: 4),
          Text(
            subtext, 
            style: secondaryTextStyle(
              fontSize: 12, 
              color: isPositive ? AppColors.secondaryTeal : AppColors.textMedium // Neutral color if not explicity pos/neg logic
            )
          ),
        ],
      ),
    );
  }
}

// --- 2. Content Section (Updated for Real Navigation) ---
class ContentSection extends StatelessWidget {
  final List<ContentPerformance> content;

  const ContentSection({Key? key, required this.content}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Column(
      children: content.map((item) {
        return InkWell(
          onTap: () => _navigateToContent(context, item),
          child: Container(
            margin: EdgeInsets.only(bottom: 12),
            padding: EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: AppColors.elevation,
              borderRadius: BorderRadius.circular(12),
            ),
            child: Row(
              children: [
                // Thumbnail
                Container(
                  width: 50,
                  height: 50,
                  decoration: BoxDecoration(
                    color: Colors.grey[800],
                    borderRadius: BorderRadius.circular(8),
                    // Handle image providers safely
                    image: (item.thumbnailUrl.isNotEmpty) 
                      ? DecorationImage(image: NetworkImage(item.thumbnailUrl), fit: BoxFit.cover)
                      : null,
                  ),
                  child: (item.thumbnailUrl.isEmpty) 
                    ? Icon(
                        item.type == 'petition' ? Feather.file_text : 
                        item.type == 'poll' ? Feather.bar_chart_2 : Feather.video, 
                        color: AppColors.textMedium, size: 20
                      ) 
                    : null,
                ),
                SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(item.title, style: secondaryVeryBoldTextStyle(fontSize: 14, color: AppColors.textHigh), maxLines: 1, overflow: TextOverflow.ellipsis),
                      SizedBox(height: 4),
                      Row(
                        children: [
                          Icon((item.type == 'petition') ? Feather.edit_2 : Feather.eye, size: 12, color: AppColors.textMedium),
                          SizedBox(width: 4),
                          Text(
                            "${NumberFormat.compact().format(item.views)} ${(item.type == 'petition' ? 'signatures' : item.type == 'poll' ? 'votes' : 'views')}  ${item.shares} shares  ${item.saves} saves", 
                            style: secondaryTextStyle(fontSize: 12, color: AppColors.textMedium)
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
                Icon(Feather.chevron_right, color: AppColors.textDisabled, size: 16),
              ],
            ),
          ),
        );
      }).toList(),
    );
  }

  void _navigateToContent(BuildContext context, ContentPerformance item) {
    if (item.type == 'post') {
      // Get userId from the original document if available
      final data = item.originalDoc?.data() as Map<String, dynamic>?;
      final userId = data?['userId'] ?? '';
      
      Navigator.push(context, MaterialPageRoute(
        builder: (_) => PostDetailScreen(
          postId: item.id, 
          userId: userId,
          source: 'analytics'
        )
      ));
    } else if (item.type == 'petition') {
      Navigator.push(context, MaterialPageRoute(builder: (_) => EnhancedPetitionDetailScreen(petitionId: item.id)));
    } else if (item.type == 'poll') {
      Navigator.push(context, MaterialPageRoute(builder: (_) => PollDetailScreen(pollId: item.id)));
    }
  }
  
  String timeagoFormat(DateTime date) {
    final diff = DateTime.now().difference(date);
    if (diff.inDays > 7) return DateFormat.MMMd().format(date);
    if (diff.inDays >= 1) return '${diff.inDays}d ago';
    if (diff.inHours >= 1) return '${diff.inHours}h ago';
    return 'Just now';
  }
}

// --- 3. Audience Section ---
class AudienceSection extends StatelessWidget {
  final AudienceData data;

  const AudienceSection({Key? key, required this.data}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    // If no data, show placeholder
    if (data.genderBreakdown.isEmpty && data.ageGroups.isEmpty) {
      return Container(
         padding: EdgeInsets.all(24),
         alignment: Alignment.center,
         child: Text("Not enough audience data collected yet.", style: secondaryTextStyle(color: AppColors.textDisabled)),
      );
    }

    return Column(
      children: [
        Row(
          children: [
            Expanded(
              child: _buildChartContainer("Gender", AspectRatio(aspectRatio: 1, child: AudiencePieChart(data: data.genderBreakdown))),
            ),
            SizedBox(width: 12),
            Expanded(
              child: _buildChartContainer(
                "Age", 
                Column(
                  children: data.ageGroups.map((e) => _buildSimpleBar(e.label, e.percentage)).toList(),
                )
              ),
            ),
          ],
        ),
        // Removed Activity Heatmap for now as real data is hard to query cheaply
      ],
    );
  }

  Widget _buildChartContainer(String title, Widget content) {
    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.elevation,
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        children: [
          Text(title, style: secondaryTextStyle(fontSize: 14, color: AppColors.textMedium)),
          SizedBox(height: 12),
          content,
        ],
      ),
    );
  }

  Widget _buildSimpleBar(String label, double value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 2.0),
      child: Row(
        children: [
          Text(label, style: secondaryTextStyle(fontSize: 10, color: AppColors.textMedium)),
          SizedBox(width: 8),
          Expanded(
            child: LinearProgressIndicator(
              value: value / 100,
              backgroundColor: Colors.white10,
              color: AppColors.primaryLavender,
              minHeight: 4,
            ),
          ),
        ],
      ),
    );
  }
}

// --- 4. Campaigns & Advocacy ---
class CampaignSection extends StatelessWidget {
  final List<CampaignStats> campaigns;

  const CampaignSection({Key? key, required this.campaigns}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    if (campaigns.isEmpty) return SizedBox.shrink();

    return Column(
      children: campaigns.map((c) {
        return InkWell(
          onTap: () {
            Navigator.push(context, MaterialPageRoute(
              builder: (_) => EnhancedPetitionDetailScreen(petitionId: c.campaignId)
            ));
          },
          borderRadius: BorderRadius.circular(16),
          child: Container(
            margin: EdgeInsets.only(bottom: 12),
            padding: EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: AppColors.elevation,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: AppColors.primaryLavender.withOpacity(0.3)),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Expanded(child: Text(c.title, style: primaryVeryBoldTextStyle(fontSize: 16, color: AppColors.textHigh), overflow: TextOverflow.ellipsis)),
                    Icon(Feather.chevron_right, color: AppColors.textDisabled, size: 16),
                  ],
                ),
                SizedBox(height: 8),
                LinearProgressIndicator(value: c.progress, color: AppColors.secondaryTeal, backgroundColor: Colors.white10, borderRadius: BorderRadius.circular(4)),
                SizedBox(height: 8),
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text("${c.signatures} / ${c.goal} signatures", style: secondaryTextStyle(fontSize: 12, color: AppColors.textMedium)),
                  ],
                )
              ],
            ),
          ),
        );
      }).toList(),
    );
  }
}

// --- 5. Benchmarks (Keep implementation) ---
// --- 5. Benchmarks (Benchmarks implemented in dashboard) ---

// --- 6. Deep Insights Section ---
class DeepInsightsSection extends StatelessWidget {
  final DeepAnalyticsData stats;

  const DeepInsightsSection({Key? key, required this.stats}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // Traffic Sources
        if (stats.trafficSources.isNotEmpty)
          _buildInsightCard(
            "Traffic Sources", 
            Feather.activity, 
            TrafficSourcesSection(sources: stats.trafficSources)
          ),

        // Geo Impact
        if (stats.geoImpact.isNotEmpty)
          _buildInsightCard(
            "Geographic Impact", 
            Feather.map_pin, 
            GeoImpactList(data: stats.geoImpact)
          ),
          
        // Petition Funnel
        if (stats.petitionFunnel.isNotEmpty)
          _buildInsightCard(
            "Petition Conversion Funnel",
            Feather.filter,
            PetitionFunnelChart(funnel: stats.petitionFunnel)
          ),
          
        // Community
        if (stats.communityPerformance.isNotEmpty)
          _buildInsightCard(
            "Community Performance",
            Feather.users,
            CommunityPerformanceList(communities: stats.communityPerformance)
          ),
      ],
    );
  }

  Widget _buildInsightCard(String title, IconData icon, Widget content) {
    return Column(
      children: [
        AnalyticsSectionHeader(title: title, icon: icon),
        content,
        SizedBox(height: 24),
      ],
    );
  }
}


--- C:\Code\femn\lib\analytics\widgets\deep_analytics_widgets.dart ---

import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import '../../customization/colors.dart';
import '../../customization/fonts.dart';
import '../models/analytics_models.dart';
import 'package:intl/intl.dart';
import 'dart:math';
import '../../circle/groups.dart';

// --- Traffic Sources Widget ---
class TrafficSourcesSection extends StatelessWidget {
  final List<TrafficSourceData> sources;
  const TrafficSourcesSection({Key? key, required this.sources}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    if (sources.isEmpty) {
      return Padding(
        padding: const EdgeInsets.symmetric(vertical: 20),
        child: Text("No traffic data yet.", style: secondaryTextStyle(color: AppColors.textMedium)),
      );
    }

    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.elevation,
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
           AspectRatio(
             aspectRatio: 1.5,
             child: PieChart(
               PieChartData(
                 sectionsSpace: 2,
                 centerSpaceRadius: 30,
                 sections: sources.asMap().entries.map((e) {
                   final index = e.key;
                   final item = e.value;
                   final color = [AppColors.primaryLavender, AppColors.secondaryTeal, Colors.blue, Colors.orange][index % 4];
                   return PieChartSectionData(
                     color: color,
                     value: item.percentage,
                     title: '${item.percentage.round()}%',
                     radius: 40,
                     titleStyle: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: Colors.white),
                   );
                 }).toList(),
               ),
             ),
           ),
           SizedBox(height: 16),
           ...sources.map((s) => Padding(
             padding: const EdgeInsets.symmetric(vertical: 4.0),
             child: Row(
               mainAxisAlignment: MainAxisAlignment.spaceBetween,
               children: [
                 Text(s.sourceName, style: secondaryTextStyle(fontSize: 12, color: AppColors.textHigh)),
                 Text("${s.visits} visits", style: secondaryTextStyle(fontSize: 12, color: AppColors.textMedium)),
               ],
             ),
           )).toList(),
        ],
      ),
    );
  }
}

// --- Geo Impact Widget ---
class GeoImpactList extends StatelessWidget {
  final List<GeoImpactData> data;
  const GeoImpactList({Key? key, required this.data}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    if (data.isEmpty) return Container(
       padding: EdgeInsets.all(24),
       width: double.infinity,
       alignment: Alignment.center,
       child: Text("No regional data from petitions yet.", textAlign: TextAlign.center, style: secondaryTextStyle(color: AppColors.textDisabled))
    );

    return Column(
      children: data.take(5).map((d) { // Show top 5
        return Padding(
          padding: const EdgeInsets.only(bottom: 8.0),
          child: Row(
            children: [
              Container(
                width: 60, // Wider for full name if needed
                alignment: Alignment.centerLeft,
                child: Text(d.region.length > 8 ? d.region.substring(0, 8) + '..' : d.region, style: secondaryVeryBoldTextStyle(fontSize: 12, color: AppColors.textMedium)),
              ),
              Expanded(
                child: LinearProgressIndicator(
                  value: d.percentage / 100,
                  backgroundColor: AppColors.elevation,
                  color: AppColors.secondaryTeal,
                  minHeight: 8,
                  borderRadius: BorderRadius.circular(4),
                ),
              ),
              SizedBox(width: 8),
              Text("${d.percentage.round()}%", style: secondaryTextStyle(fontSize: 12, color: AppColors.textMedium)),
            ],
          ),
        );
      }).toList(),
    );
  }
}

// --- Petition Funnel Widget ---
class PetitionFunnelChart extends StatelessWidget {
  final List<PetitionFunnelData> funnel;
  const PetitionFunnelChart({Key? key, required this.funnel}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    if (funnel.isEmpty || funnel.every((f) => f.count == 0)) {
       return Container(
         width: double.infinity,
         padding: EdgeInsets.all(24),
         alignment: Alignment.center,
         child: Text("Start a petition to see your advocacy funnel.", style: secondaryTextStyle(color: AppColors.textDisabled), textAlign: TextAlign.center),
       );
    }
    
    // Find max value for scaling width
    final maxVal = funnel.first.count.toDouble(); 

    return Column(
      children: funnel.asMap().entries.map((e) {
        final index = e.key;
        final item = e.value;
        final widthFactor = maxVal > 0 ? (item.count / maxVal) : 0.0;
        
        // Colors from funnel top to bottom
        final color = index == 0 ? AppColors.primaryLavender : 
                      index == 1 ? AppColors.secondaryTeal : 
                      Colors.orangeAccent;

        return Container(
          margin: EdgeInsets.symmetric(vertical: 6),
          child: Row(
            children: [
              Expanded(
                flex: 2,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(item.step, style: secondaryVeryBoldTextStyle(fontSize: 12, color: AppColors.textHigh)),
                    if (index > 0)
                      Text("${item.conversionRate.toStringAsFixed(1)}% conv", style: secondaryTextStyle(fontSize: 10, color: AppColors.textMedium)),
                  ],
                ),
              ),
              Expanded(
                flex: 5,
                child: Stack(
                  children: [
                    Container(
                      height: 30,
                      decoration: BoxDecoration(
                        color: AppColors.elevation,
                        borderRadius: BorderRadius.circular(4),
                      ),
                    ),
                    FractionallySizedBox(
                      widthFactor: widthFactor < 0.05 ? 0.05 : widthFactor, // Ensure at least small bar visible
                      child: Container(
                        height: 30,
                        alignment: Alignment.centerRight,
                        padding: EdgeInsets.only(right: 8),
                        decoration: BoxDecoration(
                          color: color,
                          borderRadius: BorderRadius.circular(4),
                        ),
                      ),
                    ),
                    Positioned.fill(
                      child: Align(
                        alignment: Alignment.centerLeft,
                        child: Padding(
                          padding: const EdgeInsets.only(left: 8.0),
                          child: Text(
                            NumberFormat.compact().format(item.count),
                            style: secondaryVeryBoldTextStyle(fontSize: 10, color: Colors.white),
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        );
      }).toList(),
    );
  }
}

// --- Community List Widget ---
class CommunityPerformanceList extends StatelessWidget {
  final List<CommunityStats> communities;
  const CommunityPerformanceList({Key? key, required this.communities}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    if (communities.isEmpty) return Padding(
      padding: EdgeInsets.symmetric(vertical: 16),
      child: Text("No communities found.", style: secondaryTextStyle(color: AppColors.textDisabled))
    );

    return Column(
      children: communities.map((c) {
        return InkWell(
          onTap: () {
            Navigator.push(context, MaterialPageRoute(
              builder: (context) => GroupViewScreen(groupId: c.groupId, onJoinSuccess: null)
            ));
          },
          child: Container(
             margin: EdgeInsets.only(bottom: 8),
             padding: EdgeInsets.all(12),
             decoration: BoxDecoration(
               color: AppColors.elevation,
               borderRadius: BorderRadius.circular(12),
               border: Border.all(color: AppColors.primaryLavender.withOpacity(0.2)),
             ),
             child: Row(
               mainAxisAlignment: MainAxisAlignment.spaceBetween,
               children: [
                 Expanded(
                   child: Row(
                     children: [
                       Icon(Feather.users, size: 16, color: AppColors.primaryLavender),
                       SizedBox(width: 8),
                       Expanded(child: Text(c.groupName, style: secondaryVeryBoldTextStyle(fontSize: 14, color: AppColors.textHigh), overflow: TextOverflow.ellipsis)),
                     ],
                   ),
                 ),
                 Icon(Feather.chevron_right, size: 14, color: AppColors.textDisabled),
               ],
             ),
          ),
        );
      }).toList(),
    );
  }
}


--- C:\Code\femn\lib\auth\auth.dart ---

import 'dart:io';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:femn/customization/colors.dart'; // <--- Ensure this file exists
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:image_picker/image_picker.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:intl/intl.dart';
import 'package:femn/hub_screens/post.dart'; // <--- Ensure this file exists
import 'package:femn/widgets/femn_background.dart';

// ==========================================
// 1. DATA & VALIDATORS (New Additions)
// ==========================================

class CountryData {
  static const List<String> allCountries = [
    "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan",
    "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi",
    "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic",
    "Denmark", "Djibouti", "Dominica", "Dominican Republic",
    "East Timor", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia",
    "Fiji", "Finland", "France",
    "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana",
    "Haiti", "Honduras", "Hungary",
    "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Ivory Coast",
    "Jamaica", "Japan", "Jordan",
    "Kazakhstan", "Kenya", "Kiribati", "Korea, North", "Korea, South", "Kosovo", "Kuwait", "Kyrgyzstan",
    "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg",
    "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar",
    "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Macedonia", "Norway",
    "Oman",
    "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal",
    "Qatar",
    "Romania", "Russia", "Rwanda",
    "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria",
    "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu",
    "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan",
    "Vanuatu", "Vatican City", "Venezuela", "Vietnam",
    "Yemen",
    "Zambia", "Zimbabwe"
  ];
}

class UsernameValidator {
  static final Set<String> _reservedWords = {
    'admin', 'administrator', 'root', 'system', 'support', 'help', 'info',
    'service', 'staff', 'marketing', 'sales', 'billing', 'api', 'bot',
    'crawler', 'security', 'signin', 'login', 'register', 'join', 'account',
    'settings', 'dashboard', 'notifications', 'messages', 'search', 'explore',
    'femn', 'femnteam', 'official', 'moderator'
  };

  static String? validate(String? value) {
    if (value == null || value.isEmpty) {
      return "Username is required";
    }

    // Check length
    if (value.length < 3) return "Username must be at least 3 characters";
    if (value.length > 20) return "Username must be under 20 characters";

    // Convert to lowercase for checking logic
    final lowerValue = value.toLowerCase();

    // Check Reserved Words
    if (_reservedWords.contains(lowerValue)) {
      return "This username is reserved";
    }

    // Check Allowed Characters (a-z, 0-9, _, .)
    final validCharacters = RegExp(r'^[a-z0-9._]+$');
    if (!validCharacters.hasMatch(lowerValue)) {
      return "Use only letters, numbers, dot (.), or underscore (_)";
    }

    // Check Placement (Start/End)
    if (lowerValue.startsWith('_') || lowerValue.startsWith('.')) {
      return "Cannot start with underscore or dot";
    }
    if (lowerValue.endsWith('_') || lowerValue.endsWith('.')) {
      return "Cannot end with underscore or dot";
    }

    // Check Consecutive Special Characters
    if (lowerValue.contains('..') || lowerValue.contains('__') || 
        lowerValue.contains('._') || lowerValue.contains('_.')) {
      return "Cannot have consecutive special characters";
    }

    return null; // Valid
  }
}

// ========== SPLASH SCREEN ==========
class SplashScreen extends StatefulWidget {
  @override
  _SplashScreenState createState() => _SplashScreenState();
}

class _SplashScreenState extends State<SplashScreen> {
  @override
  void initState() {
    super.initState();
    _navigateToAuth();
  }

  _navigateToAuth() async {
    await Future.delayed(Duration(seconds: 3));
    Navigator.pushReplacement(
      context,
      MaterialPageRoute(builder: (context) => AuthScreen()),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent, 
      body: FemnBackground(
        imagePath: 'assets/femn_bg.png',
        opacity: 0.7,
        child: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              // FEMN LOGO
              Container(
                width: 120,
                height: 120,
                decoration: BoxDecoration(
                  color: AppColors.surface, 
                  shape: BoxShape.circle,
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.3),
                      blurRadius: 12,
                      offset: Offset(0, 4),
                    ),
                  ],
                  image: DecorationImage(
                    image: AssetImage("assets/default_avatar.png"),
                    fit: BoxFit.cover,
                  ),
                ),
              ),
              SizedBox(height: 20),
              Text(
                "Femn",
                style: GoogleFonts.poppins(
                  fontSize: 48,
                  fontWeight: FontWeight.bold,
                  color: AppColors.textHigh, 
                  shadows: [
                    Shadow(
                      offset: Offset(1, 1),
                      blurRadius: 3,
                      color: Colors.black,
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// ========== AUTHENTICATION SCREEN ==========
class AuthScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      body: FemnBackground(
        opacity: 0.8,
        child: SafeArea(
          child: Center(
            child: Padding(
              padding: EdgeInsets.symmetric(horizontal: 30, vertical: 20),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                crossAxisAlignment: CrossAxisAlignment.center,
                children: [
                  Container(
                    width: 120,
                    height: 120,
                    decoration: BoxDecoration(
                      color: AppColors.surface,
                      shape: BoxShape.circle,
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black.withOpacity(0.3),
                          blurRadius: 12,
                          offset: Offset(0, 4),
                        ),
                      ],
                      image: DecorationImage(
                        image: AssetImage("assets/default_avatar.png"),
                        fit: BoxFit.cover,
                      ),
                    ),
                  ),
                  SizedBox(height: 20),
                  Text(
                    "Femn",
                    style: GoogleFonts.poppins(
                      fontSize: 48,
                      fontWeight: FontWeight.bold,
                      color: AppColors.primaryLavender,
                      letterSpacing: 1.5,
                    ),
                  ),
                  SizedBox(height: 10),
                  Text(
                    "Connect, Share, and Heal",
                    style: GoogleFonts.poppins(
                      fontSize: 18,
                      color: AppColors.textMedium,
                    ),
                    textAlign: TextAlign.center,
                  ),
                  SizedBox(height: 60),
                  
                  // Login Button
                  SizedBox(
                    width: double.infinity,
                    child: ElevatedButton(
                      onPressed: () {
                        Navigator.push(
                          context,
                          MaterialPageRoute(builder: (context) => LoginScreen()),
                        );
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.primaryLavender,
                        shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(24)),
                        padding: EdgeInsets.symmetric(vertical: 16),
                        elevation: 4,
                        shadowColor: Colors.black.withOpacity(0.2),
                      ),
                      child: Text(
                        "Login",
                        style: TextStyle(
                            color: AppColors.backgroundDeep,
                            fontSize: 18,
                            fontWeight: FontWeight.bold),
                      ),
                    ),
                  ),
                  SizedBox(height: 20),
                  
                  // Signup Button
                  SizedBox(
                    width: double.infinity,
                    child: OutlinedButton(
                      onPressed: () {
                        Navigator.push(
                          context,
                          MaterialPageRoute(builder: (context) => AccountTypeScreen()),
                        );
                      },
                      style: OutlinedButton.styleFrom(
                        foregroundColor: AppColors.textHigh,
                        side: BorderSide(color: AppColors.primaryLavender, width: 2),
                        shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(24)),
                        padding: EdgeInsets.symmetric(vertical: 16),
                      ),
                      child: Text(
                        "Sign Up",
                        style: TextStyle(
                            color: AppColors.primaryLavender,
                            fontSize: 18,
                            fontWeight: FontWeight.bold),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// ========== ACCOUNT TYPES ==========
enum AccountType { personal, organization, therapist }

// ========== AUTH SERVICE ==========
class AuthService {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;

  // Generic Sign Up
  Future<String?> signUp({
    required String email,
    required String password,
    required String username,
    required String fullName,
    required DateTime dateOfBirth,
    required List<String> interests,
    String profileImage = '',
    String bio = ''
  }) async {
    return await signUpPersonal(
      email: email,
      password: password,
      username: username,
      fullName: fullName,
      dateOfBirth: dateOfBirth,
      interests: interests,
      profileImage: profileImage,
      bio: bio,
    );
  }

  // Personal Account Sign Up
  Future<String?> signUpPersonal({
    required String email,
    required String password,
    required String username,
    required String fullName,
    required DateTime dateOfBirth,
    required List<String> interests,
    String profileImage = '',
    String bio = '',
  }) async {
    try {
      UserCredential cred = await _auth.createUserWithEmailAndPassword(
        email: email,
        password: password,
      );
      await _firestore.collection('users').doc(cred.user!.uid).set({
        'uid': cred.user!.uid,
        'email': email,
        'username': username,
        'fullName': fullName,
        'dateOfBirth': dateOfBirth,
        'profileImage': profileImage,
        'interests': interests,
        'bio': bio,
        'accountType': 'personal',
        'followers': [],
        'following': [],
        'posts': 0,
        'embers': 0,
        'createdAt': DateTime.now(),
        'isVerified': false,
        'isActive': true,
      });
      return null;
    } on FirebaseAuthException catch (e) {
      return e.message;
    }
  }

  // Organization Account Sign Up
  Future<String?> signUpOrganization({
    required String email,
    required String password,
    required String organizationName,
    required String category,
    required String country,
    required String missionStatement,
    String username = '',
    String profileImage = '',
    String website = '',
    String phone = '',
    String address = '',
    List<String> socialLinks = const [],
    String bio = '',
    List<String> areasOfFocus = const [],
  }) async {
    try {
      UserCredential cred = await _auth.createUserWithEmailAndPassword(
        email: email,
        password: password,
      );
      String generatedUsername = username.isEmpty 
          ? organizationName.toLowerCase().replaceAll(' ', '_')
          : username;
      await _firestore.collection('users').doc(cred.user!.uid).set({
        'uid': cred.user!.uid,
        'email': email,
        'username': generatedUsername,
        'fullName': organizationName,
        'organizationName': organizationName,
        'category': category,
        'country': country,
        'missionStatement': missionStatement,
        'profileImage': profileImage,
        'website': website,
        'phone': phone,
        'address': address,
        'socialLinks': socialLinks,
        'bio': bio,
        'areasOfFocus': areasOfFocus,
        'accountType': 'organization',
        'followers': [],
        'following': [],
        'posts': 0,
        'embers': 0,
        'createdAt': DateTime.now(),
        'isVerified': false,
        'isActive': true,
      });
      return null;
    } on FirebaseAuthException catch (e) {
      return e.message;
    }
  }

  // Therapist Account Sign Up
  Future<String?> signUpTherapist({
    required String email,
    required String password,
    required String fullName,
    required String username,
    required List<String> specialization,
    required String experienceLevel,
    required DateTime dateOfBirth,
    required List<AvailabilitySlot> availability,
    String profileImage = '',
    List<File>? certificationFiles,
    List<String> languages = const [],
    List<String> livedExperiences = const [],
    String region = '',
    String ethnicity = '',
    String gender = '',
    bool isLgbtqPlus = false,
    String religion = '',
  }) async {
    try {
      // 1. Create User
      UserCredential cred = await _auth.createUserWithEmailAndPassword(
        email: email,
        password: password,
      );

      final String uid = cred.user!.uid;

      // 2. Upload Certifications (Now authorized as user is created)
      List<String> certificationUrls = [];
      if (certificationFiles != null && certificationFiles.isNotEmpty) {
        for (var i = 0; i < certificationFiles.length; i++) {
          final ref = FirebaseStorage.instance
              .ref()
              .child('therapist_certifications')
              .child(uid)
              .child('${DateTime.now().millisecondsSinceEpoch}_$i.jpg');
          await ref.putFile(certificationFiles[i]);
          certificationUrls.add(await ref.getDownloadURL());
        }
      }

      // Calculate Age Range
      final age = DateTime.now().year - dateOfBirth.year;
      String ageRange = 'Adult';
      if (age < 18) ageRange = 'Adolescent';
      else if (age <= 25) ageRange = 'Young Adult';
      else if (age <= 60) ageRange = 'Adult';
      else ageRange = 'Elderly';

      // 3. Save User Document
      await _firestore.collection('users').doc(uid).set({
        'uid': uid,
        'email': email,
        'username': username,
        'fullName': fullName,
        'specialization': specialization,
        'experienceLevel': experienceLevel,
        'dateOfBirth': dateOfBirth,
        'availability': availability.map((s) => s.toMap()).toList(),
        'profileImage': profileImage,
        'certifications': certificationUrls,
        'languages': languages,
        'livedExperiences': livedExperiences,
        'region': region,
        'ethnicity': ethnicity,
        'gender': gender,
        'isLgbtqPlus': isLgbtqPlus,
        'religion': religion,
        'ageRange': ageRange,
        'accountType': 'therapist',
        'followers': [],
        'following': [],
        'posts': 0,
        'embers': 0,
        'createdAt': DateTime.now(),
        'isVerified': false,
        'isActive': true,
        'totalRatings': 0,
        'averageRating': 0.0,
        'reports': 0,
        'activeClients': 0,
        'totalClients': 0,
        'strikes': 0,
      });
      return null;
    } on FirebaseAuthException catch (e) {
      return e.message;
    } catch (e) {
      return e.toString();
    }
  }

  Future<String?> signIn(String email, String password) async {
    try {
      await _auth.signInWithEmailAndPassword(email: email, password: password);
      return null;
    } on FirebaseAuthException catch (e) {
      return e.message;
    }
  }

  Future<void> signOut() async {
    await _auth.signOut();
  }
}

// ========== ACCOUNT TYPE SELECTION SCREEN ==========
class AccountTypeScreen extends StatelessWidget {
@override
Widget build(BuildContext context) {
  return Scaffold(
    backgroundColor: Colors.transparent,
    body: FemnBackground(
      child: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(24.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.center,
            children: [
              Align(
                alignment: Alignment.topLeft,
                child: IconButton(
                  icon: Icon(Feather.arrow_left, color: AppColors.textHigh),
                  onPressed: () => Navigator.pop(context),
                ),
              ),
              Container(
                width: 100,
                height: 100,
                decoration: BoxDecoration(
                  color: AppColors.surface,
                  shape: BoxShape.circle,
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.3),
                      blurRadius: 12,
                      offset: Offset(0, 4),
                    ),
                  ],
                  image: DecorationImage(
                    image: AssetImage("assets/default_avatar.png"),
                    fit: BoxFit.cover,
                  ),
                ),
              ),
              SizedBox(height: 20),
              Text(
                "Choose Account Type",
                style: GoogleFonts.poppins(
                  fontSize: 28,
                  fontWeight: FontWeight.bold,
                  color: AppColors.primaryLavender,
                ),
              ),
              SizedBox(height: 10),
              Text(
                "Select the type of account that best fits you",
                style: GoogleFonts.poppins(
                  fontSize: 16,
                  color: AppColors.textMedium,
                ),
                textAlign: TextAlign.center,
              ),
              SizedBox(height: 40),
              Expanded(
                child: Column(
                  children: [
                    _buildAccountTypeCard(
                      context,
                      icon: Feather.user,
                      title: "Personal Account",
                      subtitle: "For individuals looking to connect and share",
                      type: AccountType.personal,
                      color: AppColors.primaryLavender,
                    ),
                    SizedBox(height: 20),
                    _buildAccountTypeCard(
                      context,
                      icon: Feather.briefcase,
                      title: "Organization Account",
                      subtitle: "For NGOs, companies, and community groups",
                      type: AccountType.organization,
                      color: AppColors.secondaryTeal,
                    ),
                    SizedBox(height: 20),
                    _buildAccountTypeCard(
                      context,
                      icon: Feather.activity,
                      title: "Therapist Account",
                      subtitle: "For mental health professionals and volunteers",
                      type: AccountType.therapist,
                      color: AppColors.accentMustard,
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    ),
  );
}

Widget _buildAccountTypeCard(
  BuildContext context, {
  required IconData icon,
  required String title,
  required String subtitle,
  required AccountType type,
  required Color color,
}) {
  return Card(
    elevation: 4,
    color: AppColors.surface,
    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)), 
    child: InkWell(
      borderRadius: BorderRadius.circular(16),
      onTap: () {
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => SignupScreen(accountType: type),
          ),
        );
      },
      child: Container(
        padding: EdgeInsets.all(16),
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          color: AppColors.surface,
        ),
        child: Row(
          children: [
            Container(
              padding: EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: AppColors.elevation,
                borderRadius: BorderRadius.circular(12),
              ),
              child: Icon(icon, color: color, size: 24),
            ),
            SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: GoogleFonts.poppins(
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                      color: AppColors.textHigh,
                    ),
                  ),
                  SizedBox(height: 2),
                  Text(
                    subtitle,
                    style: GoogleFonts.poppins(
                      fontSize: 12, 
                      color: AppColors.textMedium,
                    ),
                  ),
                ],
              ),
            ),
            Icon(Feather.chevron_right, color: AppColors.textDisabled, size: 16),
          ],
        ),
      ),
    ),
  );
}
}

// ========== UPDATED SIGNUP SCREEN ==========
class SignupScreen extends StatefulWidget {
  final AccountType accountType;
  const SignupScreen({required this.accountType});

  @override
  _SignupScreenState createState() => _SignupScreenState();
}

class _SignupScreenState extends State<SignupScreen> {
  final _formKey = GlobalKey<FormState>();
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  final _confirmPasswordController = TextEditingController();
  bool _isLoading = false;
  bool _obscurePassword = true;
  bool _obscureConfirmPassword = true;
  int _currentStep = 0;

  int _getTotalSteps() {
    switch (widget.accountType) {
      case AccountType.personal: return 3;
      case AccountType.organization: return 3;
      case AccountType.therapist: return 7;
    }
  }

  void _nextStep() {
    if (_formKey.currentState!.validate()) {
      if (_currentStep < _getTotalSteps() - 1) {
        setState(() => _currentStep++);
      } else {
        _signup();
      }
    }
  }

  void _previousStep() {
    if (_currentStep > 0) {
      setState(() => _currentStep--);
    } else {
      Navigator.pop(context);
    }
  }

  String _getStepTitle() {
    switch (widget.accountType) {
      case AccountType.personal:
        if (_currentStep == 0) return "Basic Info";
        if (_currentStep == 1) return "Security";
        return "Your Interests";
      case AccountType.organization:
        if (_currentStep == 0) return "Account Details";
        if (_currentStep == 1) return "Profile Info";
        return "Areas of Focus";
      case AccountType.therapist:
        if (_currentStep == 0) return "Professional Identity";
        if (_currentStep == 1) return "Account & Age";
        if (_currentStep == 2) return "Demographics";
        if (_currentStep == 3) return "Availability";
        if (_currentStep == 4) return "Professional Focus";
        if (_currentStep == 5) return "Lived Experience";
        return "Languages Spoken";
    }
  }

  // Personal Account Fields
  final _usernameController = TextEditingController();
  final _fullNameController = TextEditingController();
  DateTime? _dateOfBirth;
  List<String> _selectedInterests = [];

  // Organization Account Fields
  final _organizationNameController = TextEditingController();
  final _missionStatementController = TextEditingController();
  final _websiteController = TextEditingController();
  final _phoneController = TextEditingController();
  final _addressController = TextEditingController();
  String? _selectedCategory;
  String? _selectedCountry;
  List<String> _selectedAreasOfFocus = [];
  List<String> _socialLinks = [''];

  // Therapist Account Fields
  final _therapistFullNameController = TextEditingController();
  final _therapistUsernameController = TextEditingController();
  List<String> _selectedSpecializations = [];
  List<String> _selectedLivedExperiences = [];
  String? _selectedExperienceLevel;
  String? _selectedRegion;
  List<String> _selectedLanguages = [];
  String? _selectedEthnicity;
  String? _selectedGender;
  bool _isLgbtqPlus = false;
  String? _selectedReligion;
  List<Map<String, dynamic>> _availabilityGroups = [];
  List<File> _certificationFiles = [];

  // Options
  final List<String> _interestsOptions = [
    'Feminist literature', 'Gender equality activism', 'Mental health awareness',
    'Body positivity', 'LGBTQ+ support', 'Career & entrepreneurship',
  ];
  final List<String> _organizationCategories = [
    'NGO', 'Startup', 'Women\'s Group', 'Educational', 'Activist', 
    'Non-profit', 'Company', 'Collective', 'Community'
  ];
  
  // UPDATED: Using the comprehensive Country list
  final List<String> _countries = CountryData.allCountries;

  final List<String> _specializations = [
    'Anxiety', 'Depression', 'Trauma', 'Relationships', 'Self-esteem',
    'Stress Management', 'Grief', 'Addiction', 'Family Therapy',
    'LGBTQ+', 'Autistic / AuDHD', 'Dyslexic', 'Non-verbal', 'Mixed-Race',
    'Refugee / Asylee experience', 'Caste-oppression informed', 'Colorism-informed',
    'Anti-colonial / Decolonial framework', 'Racial trauma', 'Indigenous',
    'Ex-religious / Religious trauma', 'Fat Positive / Health at Every Size (HAES)',
    'Body Neutrality focused', 'Physically Disabled / Wheelchair user',
    'Deaf / Hard of Hearing (ASL proficient)', 'Blind / Low Vision informed',
    'Eating Disorder recovery', 'Post-partum / Maternal mental health',
    'Infertility / Miscarriage support', 'Menopause / Hormonal health',
    'Cancer survivor / Oncology-informed', 'Terminal illness / End-of-life care',
    'Veteran / Military family', 'First Responder (Police, Fire, EMT)',
    'Medical Professional (Doctors, Nurses)', 'Tech industry / Burnout specialist',
    'Artist / Creative professional', 'Academic / Higher Ed focus',
    'Sex Work positive', 'Social Activist / Organizer', 'Foster Care system alum',
    'Adoption / Adoptee', 'Elder / Geriatric focus', 'Domestic Violence survivor',
    'Sexual Assault survivor', 'Childhood Emotional Neglect (CEN)',
    'Narcissistic Abuse recovery', 'Incarceration / Justice-involved',
    'Homelessness / Housing instability', 'Poverty / Class-straddling mobility',
    'Relinquishment trauma', 'Cult recovery', 'Intergenerational / Ancestral trauma',
    'Feminist / Liberation-focused'
  ];

  final List<String> _livedExperiences = [
    'LGBTQ+', 'Autistic / AuDHD', 'Dyslexic', 'Non-verbal', 'Mixed-Race',
    'Refugee / Asylee experience', 'Caste-oppression informed', 'Colorism-informed',
    'Anti-colonial / Decolonial framework', 'Racial trauma', 'Indigenous',
    'Ex-religious / Religious trauma', 'Fat Positive / Health at Every Size (HAES)',
    'Body Neutrality focused', 'Physically Disabled / Wheelchair user',
    'Deaf / Hard of Hearing (ASL proficient)', 'Blind / Low Vision informed',
    'Eating Disorder recovery', 'Post-partum / Maternal mental health',
    'Infertility / Miscarriage support', 'Menopause / Hormonal health',
    'Cancer survivor / Oncology-informed', 'Terminal illness / End-of-life care',
    'Veteran / Military family', 'First Responder (Police, Fire, EMT)',
    'Medical Professional (Doctors, Nurses)', 'Tech industry / Burnout specialist',
    'Artist / Creative professional', 'Academic / Higher Ed focus',
    'Sex Work positive', 'Social Activist / Organizer', 'Foster Care system alum',
    'Adoption / Adoptee', 'Elder / Geriatric focus', 'Domestic Violence survivor',
    'Sexual Assault survivor', 'Childhood Emotional Neglect (CEN)',
    'Narcissistic Abuse recovery', 'Incarceration / Justice-involved',
    'Homelessness / Housing instability', 'Poverty / Class-straddling mobility',
    'Relinquishment trauma', 'Cult recovery', 'Intergenerational / Ancestral trauma',
    'Feminist / Liberation-focused'
  ];

  final Set<String> _sensitiveSpecializations = {
    'Trauma', 'Addiction', 'Eating Disorder recovery', 'Post-partum / Maternal mental health',
    'Infertility / Miscarriage support', 'Cancer survivor / Oncology-informed',
    'Terminal illness / End-of-life care', 'Domestic Violence survivor',
    'Sexual Assault survivor', 'Childhood Emotional Neglect (CEN)',
    'Narcissistic Abuse recovery', 'Incarceration / Justice-involved',
    'Racial trauma', 'Intergenerational / Ancestral trauma', 'Cult recovery',
    'Relinquishment trauma', 'Medical Professional (Doctors, Nurses)'
  };
  final List<String> _experienceLevels = [
    'Certified Therapist', 'Psych Student', 'Peer Listener', 'Volunteer'
  ];
  final List<String> _genderPreferences = [
    'Open to all', 'Male only', 'Female only', 'Other'
  ];
  final List<String> _regions = [
    'West Africa', 'Middle East', 'North America', 'Europe', 
    'Asia', 'South America', 'Central Africa'
  ];
  final List<String> _languages = [
    'English', 'French', 'Spanish', 'Arabic', 'Swahili',
    'Portuguese', 'Hindi', 'Yoruba', 'Zulu', 'Mandarin', 'Japanese', 'Bengali',
    'German', 'Italian', 'Russian', 'Korean', 'Turkish', 'Vietnamese', 'Thai', 
    'Polish', 'Dutch', 'Amharic', 'Oromo', 'Hausa', 'Igbo', 'Shona', 'Twi',
    'Wolof', 'Somali', 'Berber', 'Urdu', 'Punjabi', 'Telugu', 'Marathi', 'Tamil',
    'Gujarati', 'Malayalam', 'Kannada', 'Persian', 'Pashto', 'Kurdish', 'Hebrew',
    'Indonesian', 'Malay', 'Tagalog', 'Burmese', 'Khmer', 'Lao', 'Greek', 'Czech',
    'Hungarian', 'Swedish', 'Finnish', 'Danish', 'Norwegian', 'Ukrainian', 'Romanian',
    'Catalan', 'Basque', 'Galician', 'Quechua', 'Guarani', 'Aymara', 'Nahuatl', 'Maya',
    'ASL (American Sign Language)', 'BSL (British Sign Language)', 'ISL (International Sign Language)'
  ];
  final List<String> _ethnicities = [
    'Asian', 'Black', 'Blasian', 'White', 'Hispanic', 'Middle Eastern', 'Indigenous', 'Other'
  ];
  final List<String> _genders = [
    'Male', 'Female', 'Non-binary', 'Transgender', 'Other'
  ];
  final List<String> _religions = [
    'Christianity', 'Islam', 'Hinduism', 'Buddhism', 'Sikhism', 'Judaism', 
    'Agnostic', 'Atheist', 'Spiritual', 'Traditional', 'Other'
  ];
  final List<String> _ageRanges = [
    'Adolescent', 'Young Adult', 'Adult', 'Elderly'
  ];
  final List<String> _areasOfFocus = [
    'Gender Equality', 'Education', 'Health', 'Advocacy',
    'Poverty Alleviation', 'Environmental Justice', 'Youth Development'
  ];

  Future<void> _pickCertificationFiles() async {
    final picker = ImagePicker();
    final pickedFiles = await picker.pickMultiImage();
    if (pickedFiles != null) {
      setState(() {
        _certificationFiles.addAll(pickedFiles.map((file) => File(file.path)));
      });
    }
  }

  void _addSocialLink() {
    setState(() {
      _socialLinks.add('');
    });
  }

  void _removeSocialLink(int index) {
    setState(() {
      _socialLinks.removeAt(index);
    });
  }

  void _updateSocialLink(int index, String value) {
    setState(() {
      _socialLinks[index] = value;
    });
  }


  void _addAvailabilityGroup() {
    setState(() {
      _availabilityGroups.add({
        'days': <String>[],
        'start': TimeOfDay(hour: 9, minute: 0),
        'end': TimeOfDay(hour: 17, minute: 0),
      });
    });
  }

  void _removeAvailabilityGroup(int index) {
    setState(() {
      _availabilityGroups.removeAt(index);
    });
  }

  void _toggleDayInGroup(int groupIndex, String day) {
    setState(() {
      final days = _availabilityGroups[groupIndex]['days'] as List<String>;
      if (days.contains(day)) {
        days.remove(day);
      } else {
        days.add(day);
      }
    });
  }

  Future<void> _selectTimeRange(int groupIndex, bool isStart) async {
    final TimeOfDay? picked = await showTimePicker(
      context: context,
      initialTime: isStart ? _availabilityGroups[groupIndex]['start'] : _availabilityGroups[groupIndex]['end'],
    );
    if (picked != null) {
      setState(() {
        if (isStart) {
          _availabilityGroups[groupIndex]['start'] = picked;
        } else {
          _availabilityGroups[groupIndex]['end'] = picked;
        }
      });
    }
  }

  List<AvailabilitySlot> _flattenAvailability() {
    List<AvailabilitySlot> flattened = [];
    for (var group in _availabilityGroups) {
      final days = group['days'] as List<dynamic>;
      final start = group['start'] as TimeOfDay;
      final end = group['end'] as TimeOfDay;
      for (var day in days) {
        flattened.add(AvailabilitySlot(
          day: day.toString(),
          startTime: start,
          endTime: end,
        ));
      }
    }
    return flattened;
  }

  void _showError(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message, style: TextStyle(color: AppColors.backgroundDeep)),
        backgroundColor: AppColors.error,
      ),
    );
  }

  Future<void> _signup() async {
    if (_formKey.currentState!.validate()) {
      if (_passwordController.text != _confirmPasswordController.text) {
        _showError("Passwords do not match");
        return;
      }
      setState(() => _isLoading = true);

      try {
        String? error;
        String profileUrl = '';

        switch (widget.accountType) {
          case AccountType.personal:
            if (_dateOfBirth == null) {
              _showError("Please select your date of birth");
              setState(() => _isLoading = false);
              return;
            }
            error = await AuthService().signUpPersonal(
              email: _emailController.text.trim(),
              password: _passwordController.text.trim(),
              // Force lowercase username
              username: _usernameController.text.trim().toLowerCase(),
              fullName: _fullNameController.text.trim(),
              dateOfBirth: _dateOfBirth!,
              interests: _selectedInterests,
              profileImage: profileUrl,
              bio: '',
            );
            break;
          case AccountType.organization:
            if (_selectedCategory == null || _selectedCountry == null) {
              _showError("Please fill all required fields");
              setState(() => _isLoading = false);
              return;
            }
            error = await AuthService().signUpOrganization(
              email: _emailController.text.trim(),
              password: _passwordController.text.trim(),
              organizationName: _organizationNameController.text.trim(),
              category: _selectedCategory!,
              country: _selectedCountry!,
              missionStatement: _missionStatementController.text.trim(),
              // Force lowercase username
              username: _organizationNameController.text.trim().toLowerCase().replaceAll(' ', '_'),
              profileImage: profileUrl,
              website: _websiteController.text.trim(),
              phone: _phoneController.text.trim(),
              address: _addressController.text.trim(),
              socialLinks: _socialLinks.where((link) => link.isNotEmpty).toList(),
              bio: '',
              areasOfFocus: _selectedAreasOfFocus,
            );
            break;
          case AccountType.therapist:
            final flattened = _flattenAvailability();
            
            // Age Check
            if (_dateOfBirth == null) {
              _showError("Please select your date of birth");
              setState(() => _isLoading = false);
              return;
            }
            final age = DateTime.now().year - _dateOfBirth!.year;
            if (age < 18) {
              _showError("You must be at least 18 years old to be a therapist.");
              setState(() => _isLoading = false);
              return;
            }

            if (_selectedSpecializations.isEmpty || _selectedExperienceLevel == null || flattened.isEmpty) {
              _showError("Please fill all required fields, including availability days");
              setState(() => _isLoading = false);
              return;
            }

            // Certification Requirement check
            if ((_selectedExperienceLevel == 'Certified Therapist' || _selectedExperienceLevel == 'Psych Student') && _certificationFiles.isEmpty) {
              _showError("Professionals and Students must upload certifications.");
              setState(() => _isLoading = false);
              return;
            }
            
            error = await AuthService().signUpTherapist(
              email: _emailController.text.trim(),
              password: _passwordController.text.trim(),
              fullName: _therapistFullNameController.text.trim(),
              // Force lowercase username
              username: _therapistUsernameController.text.trim().toLowerCase(),
              specialization: _selectedSpecializations,
              livedExperiences: _selectedLivedExperiences,
              experienceLevel: _selectedExperienceLevel!,
              dateOfBirth: _dateOfBirth!,
              availability: flattened,
              profileImage: profileUrl,
              certificationFiles: _certificationFiles,
              languages: _selectedLanguages,
              region: _selectedRegion ?? '',
              ethnicity: _selectedEthnicity ?? '',
              gender: _selectedGender ?? '',
              isLgbtqPlus: _selectedSpecializations.contains('LGBTQ+') || _selectedLivedExperiences.contains('LGBTQ+'),
              religion: _selectedReligion ?? '',
            );
            break;
        }

        setState(() => _isLoading = false);

        if (error != null) {
          _showError(error);
        } else {
          Navigator.pushReplacement(
            context,
            MaterialPageRoute(builder: (context) => FeedScreen()),
          );
        }
      } catch (e) {
        setState(() => _isLoading = false);
        _showError("An error occurred: $e");
      }
    }
  }

  Widget _buildPersonalForm() {
    if (_currentStep == 0) {
      return Column(
        children: [
          _buildTextField(
            controller: _fullNameController,
            hintText: "Full Name",
            icon: Feather.user,
            validator: (v) => v!.isEmpty ? "Enter your full name" : null,
          ),
          _buildTextField(
            controller: _usernameController,
            hintText: "Username",
            icon: Feather.at_sign,
            validator: (v) => UsernameValidator.validate(v),
          ),
          _buildTextField(
            controller: _emailController,
            hintText: "Email *",
            icon: Feather.mail,
            validator: (v) => v!.isEmpty ? "Enter your email" : null,
          ),
        ],
      );
    } else if (_currentStep == 1) {
      return Column(
        children: [
          _buildDateOfBirthField(),
          _buildTextField(
            controller: _passwordController,
            hintText: "Password *",
            icon: Feather.lock,
            validator: (v) => v!.length < 6 ? "Password must be 6+ chars" : null,
            obscureText: _obscurePassword,
            onToggleObscure: () => setState(() => _obscurePassword = !_obscurePassword),
          ),
          _buildTextField(
            controller: _confirmPasswordController,
            hintText: "Confirm Password *",
            icon: Feather.lock,
            validator: (v) => v != _passwordController.text ? "Passwords do not match" : null,
            obscureText: _obscureConfirmPassword,
            onToggleObscure: () => setState(() => _obscureConfirmPassword = !_obscureConfirmPassword),
          ),
        ],
      );
    } else {
      return _buildInterestsField();
    }
  }

  Widget _buildOrganizationForm() {
    if (_currentStep == 0) {
      return Column(
        children: [
          _buildTextField(
            controller: _organizationNameController,
            hintText: "Organization Name",
            icon: Feather.briefcase,
            validator: (v) => v!.isEmpty ? "Enter organization name" : null,
          ),
          _buildTextField(
            controller: _emailController,
            hintText: "Email *",
            icon: Feather.mail,
            validator: (v) => v!.isEmpty ? "Enter email" : null,
          ),
          _buildTextField(
            controller: _passwordController,
            hintText: "Password *",
            icon: Feather.lock,
            validator: (v) => v!.length < 6 ? "Password must be 6+ chars" : null,
            obscureText: _obscurePassword,
            onToggleObscure: () => setState(() => _obscurePassword = !_obscurePassword),
          ),
          _buildTextField(
            controller: _confirmPasswordController,
            hintText: "Confirm Password *",
            icon: Feather.lock,
            validator: (v) => v != _passwordController.text ? "Passwords do not match" : null,
            obscureText: _obscureConfirmPassword,
            onToggleObscure: () => setState(() => _obscureConfirmPassword = !_obscureConfirmPassword),
          ),
        ],
      );
    } else if (_currentStep == 1) {
      return Column(
        children: [
          _buildTextField(
            controller: _missionStatementController,
            hintText: "Mission Statement *",
            icon: Feather.file_text,
            maxLines: 3,
            validator: (v) => v!.isEmpty ? "Enter mission statement" : null,
          ),
          _buildDropdown(
            value: _selectedCategory,
            hint: "Select Category *",
            items: _organizationCategories,
            icon: Feather.grid,
            onChanged: (value) => setState(() => _selectedCategory = value),
            validator: (value) => value == null ? "Select a category" : null,
          ),
          _buildTextField(
            controller: _websiteController,
            hintText: "Website (optional)",
            icon: Feather.globe,
          ),
          _buildTextField(
            controller: _phoneController,
            hintText: "Phone (optional)",
            icon: Feather.phone,
          ),
          _buildSocialLinksField(),
          _buildTextField(
            controller: _addressController,
            hintText: "Address (optional)",
            icon: Feather.map_pin,
          ),
          _buildDropdown(
            value: _selectedCountry,
            hint: "Select Country *",
            items: _countries,
            icon: Feather.globe,
            onChanged: (value) => setState(() => _selectedCountry = value),
            validator: (value) => value == null ? "Select a country" : null,
          ),
        ],
      );
    } else {
      return _buildMultiSelectChips(
        title: "Areas of Focus (optional)",
        options: _areasOfFocus,
        selected: _selectedAreasOfFocus,
        onChanged: (selected) => setState(() => _selectedAreasOfFocus = selected),
      );
    }
  }

  Widget _buildTherapistForm() {
    if (_currentStep == 0) {
      return Column(
        children: [
          _buildTextField(
            controller: _therapistFullNameController,
            hintText: "Full Name *",
            icon: Feather.user,
            validator: (v) => v!.isEmpty ? "Enter your full name" : null,
          ),
          _buildTextField(
            controller: _therapistUsernameController,
            hintText: "Username *",
            icon: Feather.at_sign,
            validator: (v) => UsernameValidator.validate(v),
          ),
          _buildTextField(
            controller: _emailController,
            hintText: "Email *",
            icon: Feather.mail,
            validator: (v) => v!.isEmpty ? "Enter your email" : null,
          ),
          _buildDropdown(
            value: _selectedExperienceLevel,
            hint: "Experience Level *",
            items: _experienceLevels,
            icon: Feather.activity,
            onChanged: (value) => setState(() {
              _selectedExperienceLevel = value;
              if (value != 'Certified Therapist') {
                _selectedSpecializations.removeWhere((s) => _sensitiveSpecializations.contains(s));
              }
            }),
            validator: (value) => value == null ? "Select experience level" : null,
          ),
        ],
      );
    } else if (_currentStep == 1) {
      return Column(
        children: [
          _buildDateOfBirthField(),
          _buildTextField(
            controller: _passwordController,
            hintText: "Password *",
            icon: Feather.lock,
            validator: (v) => v!.length < 6 ? "Password must be 6+ chars" : null,
            obscureText: _obscurePassword,
            onToggleObscure: () => setState(() => _obscurePassword = !_obscurePassword),
          ),
          _buildTextField(
            controller: _confirmPasswordController,
            hintText: "Confirm Password *",
            icon: Feather.lock,
            validator: (v) => v != _passwordController.text ? "Passwords do not match" : null,
            obscureText: _obscureConfirmPassword,
            onToggleObscure: () => setState(() => _obscureConfirmPassword = !_obscureConfirmPassword),
          ),
          if (_selectedExperienceLevel == 'Certified Therapist' || _selectedExperienceLevel == 'Psych Student')
            _buildCertificationsField(),
        ],
      );
    } else if (_currentStep == 2) {
      return Column(
        children: [
          _buildDropdown(
            value: _selectedEthnicity,
            hint: "Race & Ethnicity *",
            items: _ethnicities,
            icon: Feather.user,
            onChanged: (value) => setState(() => _selectedEthnicity = value),
            validator: (value) => value == null ? "Select ethnicity" : null,
          ),
          _buildDropdown(
            value: _selectedGender,
            hint: "Gender *",
            items: _genders,
            icon: Feather.user,
            onChanged: (value) => setState(() => _selectedGender = value),
            validator: (value) => value == null ? "Select gender" : null,
          ),
          _buildDropdown(
            value: _selectedRegion,
            hint: "Region (optional)",
            items: _regions,
            icon: Feather.map,
            onChanged: (value) => setState(() => _selectedRegion = value),
          ),
          _buildDropdown(
            value: _selectedReligion,
            hint: "Religion *",
            items: _religions,
            icon: Feather.shield,
            onChanged: (value) => setState(() => _selectedReligion = value),
            validator: (value) => value == null ? "Select religion" : null,
          ),
        ],
      );
    } else if (_currentStep == 3) {
      return _buildAvailabilityField();
    } else if (_currentStep == 4) {
      final List<String> availableSpecializations = _selectedExperienceLevel == 'Certified Therapist' 
        ? _specializations 
        : _specializations.where((s) => !_sensitiveSpecializations.contains(s)).toList();
      return _buildMultiSelectChips(
        title: "Specialization (I specialize in helping...) *",
        options: availableSpecializations,
        selected: _selectedSpecializations,
        onChanged: (selected) => setState(() => _selectedSpecializations = selected),
      );
    } else if (_currentStep == 5) {
      return _buildMultiSelectChips(
        title: "I am / Have experienced...",
        options: _livedExperiences,
        selected: _selectedLivedExperiences,
        onChanged: (selected) => setState(() => _selectedLivedExperiences = selected),
      );
    } else {
      return _buildMultiSelectChips(
        title: "Languages Spoken (optional)",
        options: _languages,
        selected: _selectedLanguages,
        onChanged: (selected) => setState(() => _selectedLanguages = selected),
      );
    }
  }
  
  Widget _buildTextField({
    required TextEditingController controller,
    required String hintText,
    required IconData icon,
    int maxLines = 1,
    String? Function(String?)? validator,
    bool obscureText = false,
    VoidCallback? onToggleObscure,
  }) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 16),
      child: Container(
        decoration: BoxDecoration(
          color: AppColors.elevation, 
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.1),
              blurRadius: 6,
              offset: Offset(0, 2),
            ),
          ],
        ),
        child: TextFormField(
          controller: controller,
          cursorColor: AppColors.primaryLavender,
          style: TextStyle(color: AppColors.textHigh), 
          maxLines: maxLines,
          obscureText: obscureText,
          decoration: InputDecoration(
            filled: true,
            fillColor: AppColors.elevation,
            hintText: hintText,
            hintStyle: TextStyle(color: AppColors.textDisabled),
            prefixIcon: Icon(icon, color: AppColors.primaryLavender),
            suffixIcon: (hintText.toLowerCase().contains('password') && onToggleObscure != null)
                ? IconButton(
                    icon: Icon(
                      obscureText ? Feather.eye_off : Feather.eye,
                      color: AppColors.primaryLavender,
                    ),
                    onPressed: onToggleObscure,
                  )
                : null,
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(24),
              borderSide: BorderSide.none,
            ),
          ),
          validator: validator,
        ),
      ),
    );
  }

  // ========== UPDATED DROPDOWN WIDGET ==========
  // Matches style of TextFields and includes Icon support
  Widget _buildDropdown({
    required String? value,
    required String hint,
    required List<String> items,
    required Function(String?) onChanged,
    required IconData icon,
    String? Function(String?)? validator,
  }) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 16),
      child: Container(
        decoration: BoxDecoration(
          color: AppColors.elevation, // Matches TextField background
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.1),
              blurRadius: 6,
              offset: Offset(0, 2),
            ),
          ],
        ),
        child: DropdownButtonFormField<String>(
          value: value,
          isExpanded: true, // Prevents overflow for long country names
          menuMaxHeight: 300, // Limits height so list is scrollable
          icon: Icon(Feather.chevron_down, color: AppColors.textDisabled),
          style: TextStyle(
            color: AppColors.textHigh,
            fontSize: 16,
            fontFamily: GoogleFonts.poppins().fontFamily,
          ),
          dropdownColor: AppColors.surface, // Dark dropdown menu
          decoration: InputDecoration(
            filled: true,
            fillColor: Colors.transparent, // Transparent because Container handles color
            contentPadding: EdgeInsets.symmetric(horizontal: 0, vertical: 16),
            hintText: hint,
            hintStyle: TextStyle(color: AppColors.textDisabled),
            prefixIcon: Icon(icon, color: AppColors.primaryLavender),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(24),
              borderSide: BorderSide.none,
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(24),
              borderSide: BorderSide.none,
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(24),
              borderSide: BorderSide(color: AppColors.primaryLavender, width: 1),
            ),
            errorBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(24),
              borderSide: BorderSide(color: AppColors.error, width: 1),
            ),
          ),
          items: items.map((String item) {
            return DropdownMenuItem<String>(
              value: item,
              child: Text(
                item,
                overflow: TextOverflow.ellipsis,
                style: TextStyle(color: AppColors.textHigh),
              ),
            );
          }).toList(),
          onChanged: onChanged,
          validator: validator,
        ),
      ),
    );
  }

  Widget _buildDateOfBirthField() {
    return Padding(
      padding: const EdgeInsets.only(bottom: 16),
      child: Container(
        decoration: BoxDecoration(
          color: AppColors.elevation,
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.1),
              blurRadius: 6,
              offset: Offset(0, 2),
            ),
          ],
        ),
        child: ListTile(
          title: Text(
          _dateOfBirth == null
              ? "Select Date of Birth *"
              : "DOB: ${DateFormat('yyyy-MM-dd').format(_dateOfBirth!)}",
            style: TextStyle(
              color: AppColors.textHigh,
              fontWeight: FontWeight.w500,
            ),
          ),
          trailing: Icon(Feather.calendar, color: AppColors.primaryLavender),
          onTap: _selectDOB,
        ),
      ),
    );
  }

  Future<void> _selectDOB() async {
    DateTime? picked = await showDatePicker(
      context: context,
      initialDate: DateTime(2000),
      firstDate: DateTime(1900),
      lastDate: DateTime.now(),
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: ColorScheme.dark(
              primary: AppColors.primaryLavender,
              onPrimary: AppColors.backgroundDeep,
              surface: AppColors.surface,
              onSurface: AppColors.textHigh,
            ),
          ),
          child: child!,
        );
      },
    );
    if (picked != null && picked != _dateOfBirth) {
      setState(() {
        _dateOfBirth = picked;
      });
    }
  }

  Widget _buildInterestsField() {
    return Padding(
      padding: const EdgeInsets.only(bottom: 16),
      child: Container(
        width: double.infinity,
        decoration: BoxDecoration(
          color: AppColors.elevation,
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.1),
              blurRadius: 6,
              offset: Offset(0, 2),
            ),
          ],
        ),
        padding: EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              "Select Interests",
              style: TextStyle(
                color: AppColors.primaryLavender,
                fontWeight: FontWeight.w600,
                fontSize: 16,
              ),
            ),
            SizedBox(height: 10),
            Wrap(
              spacing: 10,
              children: _interestsOptions.map((i) {
                final selected = _selectedInterests.contains(i);
                return FilterChip(
                  label: Text(
                    i,
                    style: TextStyle(
                      color: selected ? Colors.white : AppColors.textMedium,
                      fontWeight: selected ? FontWeight.bold : FontWeight.normal,
                    ),
                  ),
                  selected: selected,
                  onSelected: (v) => setState(() {
                    if (v) _selectedInterests.add(i);
                    else _selectedInterests.remove(i);
                  }),
                  selectedColor: AppColors.secondaryTeal, 
                  backgroundColor: AppColors.backgroundDeep, 
                  checkmarkColor: Colors.white,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(20),
                    side: BorderSide(
                      color: selected ? AppColors.secondaryTeal : AppColors.textDisabled,
                      width: 1,
                    ),
                  ),
                );
              }).toList(),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildMultiSelectChips({
    required String title,
    required List<String> options,
    required List<String> selected,
    required Function(List<String>) onChanged,
  }) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 16),
      child: Container(
        width: double.infinity,
        decoration: BoxDecoration(
          color: AppColors.elevation,
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.1),
              blurRadius: 6,
              offset: Offset(0, 2),
            ),
          ],
        ),
        padding: EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              title,
              style: TextStyle(
                color: AppColors.primaryLavender,
                fontWeight: FontWeight.w600,
                fontSize: 16,
              ),
            ),
            SizedBox(height: 10),
            Wrap(
              spacing: 10,
              children: options.map((option) {
                final isSelected = selected.contains(option);
                return FilterChip(
                  label: Text(option, style: TextStyle(color: isSelected ? Colors.white : AppColors.textMedium)),
                  selected: isSelected,
                  onSelected: (v) {
                    final newSelected = List<String>.from(selected);
                    if (v) {
                      newSelected.add(option);
                    } else {
                      newSelected.remove(option);
                    }
                    onChanged(newSelected);
                  },
                  selectedColor: AppColors.secondaryTeal,
                  backgroundColor: AppColors.backgroundDeep,
                  checkmarkColor: Colors.white,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(20),
                    side: BorderSide(color: isSelected ? AppColors.secondaryTeal : AppColors.textDisabled),
                  ),
                );
              }).toList(),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildAvailabilityField() {
    final List<String> weekDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    final List<String> shortDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

    return Padding(
      padding: const EdgeInsets.only(bottom: 16),
      child: Container(
        width: double.infinity,
        decoration: BoxDecoration(
          color: AppColors.elevation,
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.1),
              blurRadius: 6,
              offset: Offset(0, 2),
            ),
          ],
        ),
        padding: EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      "Work Availability *",
                      style: TextStyle(
                        color: AppColors.primaryLavender,
                        fontWeight: FontWeight.bold,
                        fontSize: 18,
                      ),
                    ),
                    Text(
                      "Set your available time slots",
                      style: TextStyle(color: AppColors.textDisabled, fontSize: 12),
                    ),
                  ],
                ),
                IconButton(
                  icon: Icon(Feather.plus_circle, color: AppColors.secondaryTeal, size: 28),
                  onPressed: _addAvailabilityGroup,
                ),
              ],
            ),
            const SizedBox(height: 16),
            if (_availabilityGroups.isEmpty)
              Container(
                width: double.infinity,
                padding: EdgeInsets.symmetric(vertical: 20),
                decoration: BoxDecoration(
                  color: AppColors.backgroundDeep.withOpacity(0.3),
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: AppColors.textDisabled.withOpacity(0.1)),
                ),
                child: Column(
                  children: [
                    Icon(Feather.clock, color: AppColors.textDisabled, size: 32),
                    SizedBox(height: 8),
                    Text(
                      "No availability slots added yet",
                      style: TextStyle(color: AppColors.textDisabled, fontStyle: FontStyle.italic),
                    ),
                  ],
                ),
              ),
            ..._availabilityGroups.asMap().entries.map((entry) {
              final index = entry.key;
              final group = entry.value;
              final List<String> selectedDays = List<String>.from(group['days']);

              return Container(
                margin: EdgeInsets.only(bottom: 16),
                padding: EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: AppColors.surface,
                  borderRadius: BorderRadius.circular(20),
                  border: Border.all(color: AppColors.primaryLavender.withOpacity(0.1)),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Text("Select Days", style: TextStyle(color: AppColors.textMedium, fontWeight: FontWeight.bold, fontSize: 13)),
                        GestureDetector(
                          onTap: () => _removeAvailabilityGroup(index),
                          child: Icon(Feather.x, color: AppColors.error, size: 18),
                        ),
                      ],
                    ),
                    const SizedBox(height: 10),
                    SingleChildScrollView(
                      scrollDirection: Axis.horizontal,
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: List.generate(7, (dayIdx) {
                          final day = weekDays[dayIdx];
                          final isSelected = selectedDays.contains(day);
                          return GestureDetector(
                            onTap: () => _toggleDayInGroup(index, day),
                            child: AnimatedContainer(
                              duration: Duration(milliseconds: 200),
                              margin: EdgeInsets.only(right: 4),
                              padding: EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                              decoration: BoxDecoration(
                                color: isSelected ? AppColors.secondaryTeal : AppColors.elevation,
                                borderRadius: BorderRadius.circular(12),
                                border: Border.all(
                                  color: isSelected ? AppColors.secondaryTeal : AppColors.textDisabled.withOpacity(0.1),
                                ),
                              ),
                              child: Text(
                                shortDays[dayIdx],
                                style: TextStyle(
                                  color: isSelected ? Colors.white : AppColors.textMedium,
                                  fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                                  fontSize: 11,
                                ),
                              ),
                            ),
                          );
                        }),
                      ),
                    ),
                    const SizedBox(height: 16),
                    Row(
                      children: [
                        Expanded(
                          child: InkWell(
                            onTap: () => _selectTimeRange(index, true),
                            child: Container(
                              padding: EdgeInsets.symmetric(vertical: 10, horizontal: 12),
                              decoration: BoxDecoration(
                                color: AppColors.elevation,
                                borderRadius: BorderRadius.circular(12),
                              ),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text("START TIME", style: TextStyle(color: AppColors.textDisabled, fontSize: 9, fontWeight: FontWeight.bold)),
                                  const SizedBox(height: 2),
                                  Text(
                                    (group['start'] as TimeOfDay).format(context),
                                    style: TextStyle(color: AppColors.primaryLavender, fontWeight: FontWeight.bold),
                                  ),
                                ],
                              ),
                            ),
                          ),
                        ),
                        Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 10),
                          child: Icon(Feather.arrow_right, color: AppColors.textDisabled, size: 16),
                        ),
                        Expanded(
                          child: InkWell(
                            onTap: () => _selectTimeRange(index, false),
                            child: Container(
                              padding: EdgeInsets.symmetric(vertical: 10, horizontal: 12),
                              decoration: BoxDecoration(
                                color: AppColors.elevation,
                                borderRadius: BorderRadius.circular(12),
                              ),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text("END TIME", style: TextStyle(color: AppColors.textDisabled, fontSize: 9, fontWeight: FontWeight.bold)),
                                  const SizedBox(height: 2),
                                  Text(
                                    (group['end'] as TimeOfDay).format(context),
                                    style: TextStyle(color: AppColors.primaryLavender, fontWeight: FontWeight.bold),
                                  ),
                                ],
                              ),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              );
            }).toList(),
          ],
        ),
      ),
    );
  }

  Widget _buildSocialLinksField() {
    return Padding(
      padding: const EdgeInsets.only(bottom: 16),
      child: Container(
        width: double.infinity,
        decoration: BoxDecoration(
          color: AppColors.elevation,
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.1),
              blurRadius: 6,
              offset: Offset(0, 2),
            ),
          ],
        ),
        padding: EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Text(
                  "Social Links (optional)",
                  style: TextStyle(
                    color: AppColors.primaryLavender,
                    fontWeight: FontWeight.w600,
                    fontSize: 16,
                  ),
                ),
                Spacer(),
                IconButton(
                  icon: Icon(Feather.plus, color: AppColors.primaryLavender),
                  onPressed: _addSocialLink,
                ),
              ],
            ),
            ..._socialLinks.asMap().entries.map((entry) {
              final index = entry.key;
              return Padding(
                padding: const EdgeInsets.only(bottom: 8),
                child: Row(
                  children: [
                    Expanded(
                      child: Container(
                        decoration: BoxDecoration(
                          color: AppColors.surface,
                          borderRadius: BorderRadius.circular(20),
                        ),
                        child: TextFormField(
                          decoration: InputDecoration(
                            hintText: "https://...",
                            hintStyle: TextStyle(color: AppColors.textDisabled),
                            border: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(20),
                              borderSide: BorderSide.none,
                            ),
                            contentPadding: EdgeInsets.symmetric(horizontal: 16),
                          ),
                          style: TextStyle(color: AppColors.textHigh),
                          onChanged: (value) => _updateSocialLink(index, value),
                        ),
                      ),
                    ),
                    if (_socialLinks.length > 1)
                      IconButton(
                        icon: Icon(Feather.x, color: AppColors.error),
                        onPressed: () => _removeSocialLink(index),
                      ),
                  ],
                ),
              );
            }).toList(),
          ],
        ),
      ),
    );
  }

  Widget _buildCertificationsField() {
    return Padding(
      padding: const EdgeInsets.only(bottom: 16),
      child: Container(
        width: double.infinity,
        decoration: BoxDecoration(
          color: AppColors.elevation,
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.1),
              blurRadius: 6,
              offset: Offset(0, 2),
            ),
          ],
        ),
        padding: EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              "Certifications (optional)",
              style: TextStyle(
                color: AppColors.primaryLavender,
                fontWeight: FontWeight.w600,
                fontSize: 16,
              ),
            ),
            SizedBox(height: 10),
            if (_certificationFiles.isNotEmpty)
              ..._certificationFiles.map((file) => ListTile(
                leading: Icon(Feather.file, color: AppColors.primaryLavender),
                title: Text(file.path.split('/').last, style: TextStyle(color: AppColors.textHigh)),
                trailing: IconButton(
                  icon: Icon(Feather.trash_2, color: AppColors.error),
                  onPressed: () => setState(() => _certificationFiles.remove(file)),
                ),
              )).toList(),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton.icon(
                onPressed: _pickCertificationFiles,
                icon: Icon(Feather.upload),
                label: Text("Upload Certifications"),
                style: ElevatedButton.styleFrom(
                  backgroundColor: AppColors.surface,
                  foregroundColor: AppColors.primaryLavender,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(20),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  String _getAccountTypeTitle() {
    switch (widget.accountType) {
      case AccountType.personal:
        return "Personal Account";
      case AccountType.organization:
        return "Organization Account";
      case AccountType.therapist:
        return "Therapist Account";
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      body: FemnBackground(
        child: SafeArea(
          child: Center(
            child: SingleChildScrollView(
              padding: EdgeInsets.symmetric(horizontal: 30, vertical: 20),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: [
                  Align(
                    alignment: Alignment.topLeft,
                    child: IconButton(
                      icon: Icon(Feather.arrow_left, color: AppColors.textHigh),
                      onPressed: () => Navigator.pop(context),
                    ),
                  ),
                  // FEMN LOGO
                  Container(
                    width: 100,
                    height: 100,
                    decoration: BoxDecoration(
                      color: AppColors.surface,
                      shape: BoxShape.circle,
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black.withOpacity(0.3),
                          blurRadius: 12,
                          offset: Offset(0, 4),
                        ),
                      ],
                      image: DecorationImage(
                        image: AssetImage("assets/default_avatar.png"),
                        fit: BoxFit.cover,
                      ),
                    ),
                  ),
                  SizedBox(height: 20),
                  Text(
                    "Femn",
                    style: GoogleFonts.poppins(
                      fontSize: 48,
                      fontWeight: FontWeight.bold,
                      color: AppColors.primaryLavender,
                      letterSpacing: 1.5,
                    ),
                  ),
                  SizedBox(height: 10),
                  Text(
                    _getStepTitle(),
                    style: GoogleFonts.poppins(
                      fontSize: 22,
                      fontWeight: FontWeight.w600,
                      color: AppColors.textHigh,
                    ),
                  ),
                  SizedBox(height: 5),
                  Text(
                    "Step ${_currentStep + 1} of ${_getTotalSteps()}",
                    style: GoogleFonts.poppins(
                      fontSize: 14,
                      color: AppColors.primaryLavender,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  SizedBox(height: 30),
                  Form(
                    key: _formKey,
                    child: Column(
                      children: [
                        // Step-specific content
                        _buildAccountTypeSpecificForm(),

                        SizedBox(height: 30),

                        // Action buttons
                        _isLoading
                            ? CircularProgressIndicator(color: AppColors.primaryLavender)
                            : Row(
                                children: [
                                  if (_currentStep > 0) ...[
                                    Expanded(
                                      child: OutlinedButton(
                                        onPressed: _previousStep,
                                        style: OutlinedButton.styleFrom(
                                          side: BorderSide(color: AppColors.primaryLavender),
                                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
                                          padding: EdgeInsets.symmetric(vertical: 16),
                                        ),
                                        child: Text("Back", style: TextStyle(color: AppColors.primaryLavender, fontWeight: FontWeight.bold)),
                                      ),
                                    ),
                                    SizedBox(width: 16),
                                  ],
                                  Expanded(
                                    flex: 2,
                                    child: ElevatedButton(
                                      onPressed: _nextStep,
                                      style: ElevatedButton.styleFrom(
                                        backgroundColor: AppColors.primaryLavender,
                                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
                                        padding: EdgeInsets.symmetric(vertical: 16),
                                        elevation: 4,
                                        shadowColor: Colors.black.withOpacity(0.2),
                                      ),
                                      child: Text(
                                        _currentStep == _getTotalSteps() - 1 ? "Sign Up" : "Next",
                                        style: TextStyle(
                                            color: AppColors.backgroundDeep,
                                            fontSize: 18,
                                            fontWeight: FontWeight.bold),
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildAccountTypeSpecificForm() {
    switch (widget.accountType) {
      case AccountType.personal:
        return _buildPersonalForm();
      case AccountType.organization:
        return _buildOrganizationForm();
      case AccountType.therapist:
        return _buildTherapistForm();
    }
  }
}

class LoginScreen extends StatefulWidget {
  @override
  _LoginScreenState createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final _formKey = GlobalKey<FormState>();
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  bool _isLoading = false;
  bool _obscurePassword = true;

  void _showError(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message, style: TextStyle(color: AppColors.backgroundDeep)),
        backgroundColor: AppColors.error,
      ),
    );
  }

  void _login() async {
    if (_formKey.currentState!.validate()) {
      setState(() => _isLoading = true);
      String? error = await AuthService().signIn(
        _emailController.text.trim(),
        _passwordController.text.trim(),
      );
      setState(() => _isLoading = false);
      if (error != null) {
        _showError(error);
      } else {
        // Check for deactivation
        final user = FirebaseAuth.instance.currentUser;
        if (user != null) {
          try {
            final doc = await FirebaseFirestore.instance.collection('users').doc(user.uid).get();
            if (doc.exists && doc.data()?['isActive'] == false) {
              bool? reactivate = await showDialog<bool>(
                context: context,
                barrierDismissible: false,
                builder: (context) => AlertDialog(
                  backgroundColor: AppColors.surface,
                  title: Text("Reactivate Account?", style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)),
                  content: Text(
                    "Your account is currently deactivated. Would you like to reactivate it and log in?",
                    style: TextStyle(color: AppColors.textMedium),
                  ),
                  actions: [
                    TextButton(
                      onPressed: () => Navigator.pop(context, false),
                      child: Text("Cancel", style: TextStyle(color: AppColors.textDisabled)),
                    ),
                    TextButton(
                      onPressed: () => Navigator.pop(context, true),
                      child: Text("Reactivate", style: TextStyle(color: AppColors.primaryLavender, fontWeight: FontWeight.bold)),
                    ),
                  ],
                ),
              );

              if (reactivate == true) {
                await FirebaseFirestore.instance.collection('users').doc(user.uid).update({'isActive': true});
              } else {
                await AuthService().signOut();
                setState(() => _isLoading = false);
                return;
              }
            }
          } catch (e) {
            print("Error checking active status: $e");
          }
        }

        Navigator.pushReplacement(
          context,
          MaterialPageRoute(builder: (context) => FeedScreen()), 
        );
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      body: Container(
        decoration: BoxDecoration(
          image: DecorationImage(
            image: AssetImage('assets/femn_state.png'),
            fit: BoxFit.cover,
            colorFilter: ColorFilter.mode(Colors.black.withOpacity(0.9), BlendMode.darken),
          ),
        ),
        child: SafeArea(
          child: Center(
            child: SingleChildScrollView(
              padding: EdgeInsets.symmetric(horizontal: 30, vertical: 20),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: [
                  // FEMN LOGO
                  Container(
                    width: 120,
                    height: 120,
                    decoration: BoxDecoration(
                      color: AppColors.surface,
                      shape: BoxShape.circle,
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black.withOpacity(0.3),
                          blurRadius: 12,
                          offset: Offset(0, 4),
                        ),
                      ],
                      image: DecorationImage(
                        image: AssetImage("assets/default_avatar.png"),
                        fit: BoxFit.cover,
                      ),
                    ),
                  ),
                  SizedBox(height: 20),
                  Text(
                    "Femn",
                    style: GoogleFonts.poppins(
                      fontSize: 48,
                      fontWeight: FontWeight.bold,
                      color: AppColors.primaryLavender,
                      letterSpacing: 1.5,
                    ),
                  ),
                  SizedBox(height: 10),
                  Text(
                    "Welcome Back!",
                    style: GoogleFonts.poppins(
                      fontSize: 18,
                      color: AppColors.textMedium,
                    ),
                  ),
                  SizedBox(height: 40),
                  // FORM
                  Form(
                    key: _formKey,
                    child: Column(
                      children: [
                        // EMAIL FIELD
                        Padding(
                          padding: const EdgeInsets.only(bottom: 16),
                          child: Container(
                            decoration: BoxDecoration(
                              color: AppColors.elevation,
                              borderRadius: BorderRadius.circular(24),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.black.withOpacity(0.1),
                                  blurRadius: 6,
                                  offset: Offset(0, 2),
                                ),
                              ],
                            ),
                            child: TextFormField(
                              controller: _emailController,
                              cursorColor: AppColors.primaryLavender,
                              style: TextStyle(color: AppColors.textHigh),
                              keyboardType: TextInputType.emailAddress,
                              decoration: InputDecoration(
                                filled: true,
                                fillColor: AppColors.elevation,
                                hintText: "Email",
                                hintStyle: TextStyle(color: AppColors.textDisabled),
                                prefixIcon: Icon(Feather.mail, color: AppColors.primaryLavender),
                                border: OutlineInputBorder(
                                  borderRadius: BorderRadius.circular(24),
                                  borderSide: BorderSide.none,
                                ),
                              ),
                              validator: (value) => value!.isEmpty ? "Enter your email" : null,
                            ),
                          ),
                        ),
                        // PASSWORD FIELD
                        Padding(
                          padding: const EdgeInsets.only(bottom: 16),
                          child: Container(
                            decoration: BoxDecoration(
                              color: AppColors.elevation,
                              borderRadius: BorderRadius.circular(24),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.black.withOpacity(0.1),
                                  blurRadius: 6,
                                  offset: Offset(0, 2),
                                ),
                              ],
                            ),
                            child: TextFormField(
                              controller: _passwordController,
                              cursorColor: AppColors.primaryLavender,
                              style: TextStyle(color: AppColors.textHigh),
                              obscureText: _obscurePassword,
                              decoration: InputDecoration(
                                filled: true,
                                fillColor: AppColors.elevation,
                                hintText: "Password",
                                hintStyle: TextStyle(color: AppColors.textDisabled),
                                prefixIcon: Icon(Feather.lock, color: AppColors.primaryLavender),
                                suffixIcon: IconButton(
                                  icon: Icon(
                                    _obscurePassword ? Feather.eye_off : Feather.eye,
                                    color: AppColors.primaryLavender,
                                  ),
                                  onPressed: () => setState(() => _obscurePassword = !_obscurePassword),
                                ),
                                border: OutlineInputBorder(
                                  borderRadius: BorderRadius.circular(24),
                                  borderSide: BorderSide.none,
                                ),
                              ),
                              validator: (value) => value!.isEmpty ? "Enter your password" : null,
                            ),
                          ),
                        ),
                        SizedBox(height: 20),
                        // LOGIN BUTTON
                        _isLoading
                            ? CircularProgressIndicator(color: AppColors.primaryLavender)
                            : SizedBox(
                                width: double.infinity,
                                child: ElevatedButton(
                                  onPressed: _login,
                                  style: ElevatedButton.styleFrom(
                                    backgroundColor: AppColors.primaryLavender,
                                    shape: RoundedRectangleBorder(
                                      borderRadius: BorderRadius.circular(24),
                                    ),
                                    padding: EdgeInsets.symmetric(vertical: 16),
                                    elevation: 4,
                                    shadowColor: Colors.black.withOpacity(0.2),
                                  ),
                                  child: Text(
                                    "Login",
                                    style: TextStyle(
                                      color: AppColors.backgroundDeep,
                                      fontSize: 18,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ),
                              ),
                        SizedBox(height: 16),
                        TextButton(
                          onPressed: () {
                            Navigator.push(
                              context,
                              MaterialPageRoute(builder: (_) => AccountTypeScreen()),
                            );
                          },
                          child: Text(
                            "Don't have an account? Sign Up",
                            style: TextStyle(
                              color: AppColors.primaryLavender,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// ========== HOME SCREEN ==========
class HomeScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: Text("Femn", style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)),
        backgroundColor: Colors.transparent,
        foregroundColor: AppColors.textHigh,
        elevation: 0,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
      ),
      body: Container(
        // Subtle gradient background
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Colors.transparent,
              AppColors.elevation,
            ],
          ),
        ),
        child: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Container(
                width: 150,
                height: 150,
                decoration: BoxDecoration(
                  color: AppColors.surface,
                  shape: BoxShape.circle,
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.2),
                      blurRadius: 15,
                      offset: Offset(0, 5),
                    ),
                  ],
                  image: DecorationImage(
                    image: AssetImage("assets/default_avatar.png"),
                    fit: BoxFit.cover,
                  ),
                ),
              ),
              SizedBox(height: 30),
              Text(
                "Welcome to Femn!",
                style: GoogleFonts.poppins(
                  fontSize: 28,
                  fontWeight: FontWeight.bold,
                  color: AppColors.textHigh,
                ),
              ),
              SizedBox(height: 10),
              Text(
                "Connect, Share, and Heal Together",
                style: GoogleFonts.poppins(
                  fontSize: 16,
                  color: AppColors.textMedium,
                ),
              ),
              SizedBox(height: 30),
              SizedBox(
                width: 200,
                child: ElevatedButton(
                  onPressed: () {
                    AuthService().signOut().then((_) {
                      Navigator.pushReplacement(
                        context,
                        MaterialPageRoute(builder: (context) => AuthScreen()),
                      );
                    });
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.surface, // Surface colored button
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(24),
                    ),
                    padding: EdgeInsets.symmetric(vertical: 16),
                    elevation: 4,
                  ),
                  child: Text(
                    "Logout",
                    style: TextStyle(
                      color: AppColors.primaryLavender, // Lavender Text
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// ========== AVAILABILITY SLOT MODEL ==========
class AvailabilitySlot {
  final String day;
  final TimeOfDay startTime;
  final TimeOfDay endTime;

  AvailabilitySlot({
    required this.day,
    required this.startTime,
    required this.endTime,
  });

  AvailabilitySlot copyWith({
    String? day,
    TimeOfDay? startTime,
    TimeOfDay? endTime,
  }) {
    return AvailabilitySlot(
      day: day ?? this.day,
      startTime: startTime ?? this.startTime,
      endTime: endTime ?? this.endTime,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'day': day,
      'startHour': startTime.hour,
      'startMinute': startTime.minute,
      'endHour': endTime.hour,
      'endMinute': endTime.minute,
    };
  }

  static AvailabilitySlot fromMap(Map<String, dynamic> map) {
    return AvailabilitySlot(
      day: map['day'] ?? 'Monday',
      startTime: TimeOfDay(hour: map['startHour'] ?? 9, minute: map['startMinute'] ?? 0),
      endTime: TimeOfDay(hour: map['endHour'] ?? 17, minute: map['endMinute'] ?? 0),
    );
  }
}


--- C:\Code\femn\lib\auth\auth_provider.dart ---

import 'dart:io';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/foundation.dart';
import 'auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:cloud_firestore/cloud_firestore.dart';

class AuthProvider with ChangeNotifier {
  final AuthService _authService = AuthService();

  Future<String?> signIn(String email, String password) async {
    return await _authService.signIn(email, password);
  }

  // Generic Sign Up (retained for backward compatibility or personal use)
  Future<String?> signUp({
    required String email,
    required String password,
    required String username,
    required String fullName,
    required DateTime dateOfBirth,
    required List<String> interests,
    String profileImage = '',
    String bio = '',
  }) async {
    return await _authService.signUp(
      email: email,
      password: password,
      username: username,
      fullName: fullName,
      dateOfBirth: dateOfBirth,
      interests: interests,
      profileImage: profileImage,
      bio: bio,
    );
  }

  // Personal Account Sign Up
  Future<String?> signUpPersonal({
    required String email,
    required String password,
    required String username,
    required String fullName,
    required DateTime dateOfBirth,
    required List<String> interests,
    String profileImage = '',
    String bio = '',
  }) async {
    return await _authService.signUpPersonal(
      email: email,
      password: password,
      username: username,
      fullName: fullName,
      dateOfBirth: dateOfBirth,
      interests: interests,
      profileImage: profileImage,
      bio: bio,
    );
  }

  // Organization Account Sign Up
  // Organization Account Sign Up
  Future<String?> signUpOrganization({
    required String email,
    required String password,
    required String organizationName,
    required String category,
    required String country,
    required String missionStatement,
    String username = '',
    String profileImage = '', // CHANGED FROM logo to profileImage
    String website = '',
    String phone = '',
    String address = '',
    List<String> socialLinks = const [],
    String bio = '',
    List<String> areasOfFocus = const [],
  }) async {
    return await _authService.signUpOrganization(
      email: email,
      password: password,
      organizationName: organizationName,
      category: category,
      country: country,
      missionStatement: missionStatement,
      username: username,
      profileImage: profileImage, // CHANGED FROM logo to profileImage
      website: website,
      phone: phone,
      address: address,
      socialLinks: socialLinks,
      bio: bio,
      areasOfFocus: areasOfFocus,
    );
  }

  // Therapist Account Sign Up
  Future<String?> signUpTherapist({
    required String email,
    required String password,
    required String fullName,
    required String username,
    required List<String> specialization,
    required String experienceLevel,
    required DateTime dateOfBirth,
    required List<AvailabilitySlot> availability,
    String profileImage = '',
    List<File>? certificationFiles,
    List<String> languages = const [],
    List<String> livedExperiences = const [],
    String region = '',
    String ethnicity = '',
    String gender = '',
    bool isLgbtqPlus = false,
    String religion = '',
  }) async {
    return await _authService.signUpTherapist(
      email: email,
      password: password,
      fullName: fullName,
      username: username,
      specialization: specialization,
      experienceLevel: experienceLevel,
      dateOfBirth: dateOfBirth,
      availability: availability,
      profileImage: profileImage,
      certificationFiles: certificationFiles,
      languages: languages,
      livedExperiences: livedExperiences,
      region: region,
      ethnicity: ethnicity,
      gender: gender,
      isLgbtqPlus: isLgbtqPlus,
      religion: religion,
    );
  }

  Future<void> signOut() async {
    await _authService.signOut();
    notifyListeners();
  }
}


--- C:\Code\femn\lib\circle\campaign.dart ---

import 'dart:async';
import 'dart:io';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:femn/customization/colors.dart'; // <--- IMPORT YOUR COLORS FILE
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:flutter/material.dart';
import 'package:image_picker/image_picker.dart';
import 'package:intl/intl.dart';
import 'package:shimmer/shimmer.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'petitions.dart';
import '../services/notification_service.dart'; // <--- ADD THIS

class CampaignsScreen extends StatefulWidget {
  @override
  _CampaignsScreenState createState() => _CampaignsScreenState();
}

class _CampaignsScreenState extends State<CampaignsScreen> {
  final List<String> _tabs = ['Polls', 'Petitions', 'Events'];

  @override
  Widget build(BuildContext context) {
    return DefaultTabController(
      length: _tabs.length,
      child: Scaffold(
        backgroundColor: Colors.transparent,
        appBar: AppBar(
          backgroundColor: Colors.transparent,
          elevation: 0,
          title: Text(
            'Campaigns',
            style: TextStyle(
              fontWeight: FontWeight.bold,
              color: AppColors.textHigh,
            ),
          ),
          bottom: TabBar(
            indicatorColor: AppColors.primaryLavender,
            labelColor: AppColors.primaryLavender,
            unselectedLabelColor: AppColors.textMedium,
            tabs: _tabs.map((tab) => Tab(text: tab)).toList(),
          ),
        ),
        body: TabBarView(children: [PollsTab(), PetitionsTab(), EventsTab()]),
        floatingActionButton: FloatingActionButton(
          onPressed: () {
            _showCreateBottomSheet(context);
          },
          child: Icon(Feather.plus, color: AppColors.backgroundDeep),
          backgroundColor: AppColors.accentMustard, // Mustard for FAB
        ),
      ),
    );
  }

  void _showCreateBottomSheet(BuildContext context) {
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (BuildContext context) {
        return Container(
          padding: EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: AppColors.surface,
            borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(
                'Create New',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: AppColors.textHigh,
                ),
              ),
              SizedBox(height: 16),
              ListTile(
                leading: Icon(
                  Feather.bar_chart_2,
                  color: AppColors.primaryLavender,
                ),
                title: Text(
                  'Poll',
                  style: TextStyle(
                    fontWeight: FontWeight.w500,
                    color: AppColors.textHigh,
                  ),
                ),
                onTap: () {
                  Navigator.pop(context);
                  Navigator.push(
                    context,
                    MaterialPageRoute(builder: (context) => CreatePollScreen()),
                  );
                },
              ),
              ListTile(
                leading: Icon(
                  Feather.file_text,
                  color: AppColors.secondaryTeal,
                ),
                title: Text(
                  'Petition',
                  style: TextStyle(
                    fontWeight: FontWeight.w500,
                    color: AppColors.textHigh,
                  ),
                ),
                onTap: () {
                  Navigator.pop(context);
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (context) => EnhancedPetitionCreationScreen(),
                    ),
                  );
                },
              ),
              ListTile(
                leading: Icon(Feather.calendar, color: AppColors.accentMustard),
                title: Text(
                  'Event',
                  style: TextStyle(
                    fontWeight: FontWeight.w500,
                    color: AppColors.textHigh,
                  ),
                ),
                onTap: () {
                  Navigator.pop(context);
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (context) => CreateEventScreen(),
                    ),
                  );
                },
              ),
            ],
          ),
        );
      },
    );
  }
}

// Polls Tab with Voting
class PollsTab extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final user = FirebaseAuth.instance.currentUser;

    return StreamBuilder<QuerySnapshot>(
      stream: FirebaseFirestore.instance
          .collection('polls')
          .orderBy('createdAt', descending: true)
          .snapshots(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return _buildShimmerList();
        }

        if (snapshot.hasError) {
          return Center(
            child: Text(
              'Error loading polls',
              style: TextStyle(color: AppColors.error),
            ),
          );
        }

        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return _buildEmptyState('No polls yet ', Feather.bar_chart_2);
        }

        final polls = snapshot.data!.docs;
        return ListView.builder(
          padding: EdgeInsets.all(12),
          itemCount: polls.length,
          itemBuilder: (context, index) {
            final poll = polls[index];
            final hasVoted = user != null
                ? (poll['voters'] as List).contains(user.uid)
                : false;

            return _buildPollCard(poll, context, hasVoted);
          },
        );
      },
    );
  }

  Widget _buildPollCard(
    DocumentSnapshot poll,
    BuildContext context,
    bool hasVoted,
  ) {
    final pollData = poll.data() as Map<String, dynamic>?;
    final imageUrl = pollData?['imageUrl'] as String?;
    final description = pollData?['description'] as String?;
    final creatorName = pollData?['creatorName'] as String? ?? 'Unknown';
    final question = pollData?['question'] as String? ?? 'No Question';
    final options = (pollData?['options'] as List?) ?? [];

    final totalVotes = options.fold<int>(0, (sum, option) {
      final opt = option as Map<String, dynamic>;
      return sum + ((opt['votes'] as int?) ?? 0);
    });

    return Card(
      margin: EdgeInsets.symmetric(vertical: 8),
      color: AppColors.surface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      elevation: 0,
      child: InkWell(
        onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) => PollDetailScreen(pollId: poll.id),
            ),
          );
        },
        child: Padding(
          padding: EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              if (imageUrl != null && imageUrl.isNotEmpty)
                Padding(
                  padding: EdgeInsets.only(bottom: 12),
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(12),
                    child: CachedNetworkImage(
                      imageUrl: imageUrl,
                      height: 150,
                      width: double.infinity,
                      fit: BoxFit.cover,
                      placeholder: (context, url) => Container(
                        height: 150,
                        color: AppColors.elevation,
                        child: Center(
                          child: CircularProgressIndicator(
                            color: AppColors.primaryLavender,
                          ),
                        ),
                      ),
                      errorWidget: (context, url, error) =>
                          Icon(Feather.alert_circle, color: AppColors.error),
                    ),
                  ),
                ),
              Text(
                question,
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  fontSize: 18,
                  color: AppColors.textHigh,
                ),
              ),
              SizedBox(height: 8),
              Text(
                description ?? '',
                style: TextStyle(color: AppColors.textMedium, fontSize: 14),
                maxLines: 2,
                overflow: TextOverflow.ellipsis,
              ),
              SizedBox(height: 12),
              ...(options.take(2).map((option) {
                final opt = option as Map<String, dynamic>;
                final text = opt['text'] as String? ?? '';
                final votes = (opt['votes'] as int?) ?? 0;
                final percentage = totalVotes > 0
                    ? (votes / totalVotes * 100)
                    : 0;
                return Padding(
                  padding: EdgeInsets.only(bottom: 8),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Expanded(
                            child: ClipRRect(
                              borderRadius: BorderRadius.circular(4),
                              child: LinearProgressIndicator(
                                value: percentage / 100,
                                backgroundColor: AppColors.elevation,
                                valueColor: AlwaysStoppedAnimation<Color>(
                                  hasVoted
                                      ? AppColors.secondaryTeal
                                      : AppColors.textDisabled,
                                ),
                                minHeight: 6,
                              ),
                            ),
                          ),
                          SizedBox(width: 8),
                          Text(
                            '${percentage.toStringAsFixed(1)}%',
                            style: TextStyle(
                              color: AppColors.textMedium,
                              fontSize: 12,
                            ),
                          ),
                        ],
                      ),
                      SizedBox(height: 4),
                      Text(
                        text,
                        style: TextStyle(
                          fontSize: 12,
                          color: AppColors.textMedium,
                        ),
                      ),
                    ],
                  ),
                );
              }).toList()),
              if (options.length > 2)
                Text(
                  '+ ${options.length - 2} more options',
                  style: TextStyle(
                    color: AppColors.primaryLavender,
                    fontSize: 12,
                  ),
                ),
              SizedBox(height: 12),
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    '$totalVotes votes  Created by $creatorName',
                    style: TextStyle(
                      color: AppColors.textDisabled,
                      fontSize: 12,
                    ),
                  ),
                  if (hasVoted)
                    Icon(
                      Feather.check_circle,
                      color: AppColors.secondaryTeal,
                      size: 16,
                    ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// Petitions Tab with Signing
class PetitionsTab extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final user = FirebaseAuth.instance.currentUser;

    return StreamBuilder<QuerySnapshot>(
      stream: FirebaseFirestore.instance
          .collection('petitions')
          .orderBy('createdAt', descending: true)
          .snapshots(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return _buildShimmerList();
        }

        if (snapshot.hasError) {
          return Center(
            child: Text(
              'Error loading petitions',
              style: TextStyle(color: AppColors.error),
            ),
          );
        }

        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return _buildEmptyState('No petitions yet ', Feather.file_text);
        }

        final petitions = snapshot.data!.docs;

        // Extract trending (top 5 by signatures)
        final trendingPetitions = List<DocumentSnapshot>.from(petitions);
        trendingPetitions.sort(
          (a, b) => (b['currentSignatures'] ?? 0).compareTo(
            a['currentSignatures'] ?? 0,
          ),
        );
        final topTrending = trendingPetitions.take(5).toList();

        return ListView(
          padding: EdgeInsets.all(12),
          children: [
            if (topTrending.isNotEmpty) ...[
              Padding(
                padding: const EdgeInsets.only(left: 4, bottom: 12),
                child: Row(
                  children: [
                    Icon(
                      Feather.trending_up,
                      color: AppColors.accentMustard,
                      size: 20,
                    ),
                    SizedBox(width: 8),
                    Text(
                      'Trending Now',
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                        color: AppColors.textHigh,
                      ),
                    ),
                  ],
                ),
              ),
              SizedBox(
                height: 180,
                child: ListView.builder(
                  scrollDirection: Axis.horizontal,
                  itemCount: topTrending.length,
                  itemBuilder: (context, index) {
                    final petition = topTrending[index];
                    final hasSigned = user != null
                        ? (petition['signers'] as List).contains(user.uid)
                        : false;
                    return Container(
                      width: 280,
                      margin: EdgeInsets.only(right: 12),
                      child: _buildPetitionCard(
                        petition,
                        context,
                        hasSigned,
                        isMini: true,
                      ),
                    );
                  },
                ),
              ),
              SizedBox(height: 24),
              Padding(
                padding: const EdgeInsets.only(left: 4, bottom: 12),
                child: Text(
                  'All Petitions',
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: AppColors.textHigh,
                  ),
                ),
              ),
            ],
            ...petitions.map((petition) {
              final hasSigned = user != null
                  ? (petition['signers'] as List).contains(user.uid)
                  : false;
              return _buildPetitionCard(petition, context, hasSigned);
            }).toList(),
          ],
        );
      },
    );
  }

  Widget _buildPetitionCard(
    DocumentSnapshot petition,
    BuildContext context,
    bool hasSigned, {
    bool isMini = false,
  }) {
    final petitionData = petition.data() as Map<String, dynamic>?;
    final imageUrl =
        petitionData?['bannerImageUrl'] as String? ??
        petitionData?['imageUrl'] as String?;
    final title = petitionData?['title'] as String? ?? 'Untitled Petition';
    final description = petitionData?['description'] as String? ?? '';
    final creatorName = petitionData?['creatorName'] as String? ?? 'Unknown';
    final signatures =
        (petitionData?['currentSignatures'] as int?) ??
        (petitionData?['signatures'] as int?) ??
        0;
    final goal = (petitionData?['goal'] as int?) ?? 1000;
    final progress = goal > 0 ? signatures / goal : 0;

    return Card(
      margin: EdgeInsets.symmetric(vertical: 8),
      color: AppColors.surface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      elevation: 0,
      child: InkWell(
        onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) =>
                  EnhancedPetitionDetailScreen(petitionId: petition.id),
            ),
          );
        },
        child: Padding(
          padding: EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              if (imageUrl != null && imageUrl.isNotEmpty)
                Padding(
                  padding: EdgeInsets.only(bottom: 12),
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(12),
                    child: CachedNetworkImage(
                      imageUrl: imageUrl,
                      height: isMini ? 100 : 150,
                      width: double.infinity,
                      fit: BoxFit.cover,
                      placeholder: (context, url) => Container(
                        height: isMini ? 100 : 150,
                        color: AppColors.elevation,
                        child: Center(
                          child: CircularProgressIndicator(
                            color: AppColors.primaryLavender,
                          ),
                        ),
                      ),
                      errorWidget: (context, url, error) =>
                          Icon(Feather.alert_circle, color: AppColors.error),
                    ),
                  ),
                ),
              Text(
                title,
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  fontSize: isMini ? 14 : 18,
                  color: AppColors.textHigh,
                ),
                maxLines: isMini ? 1 : 2,
                overflow: TextOverflow.ellipsis,
              ),
              if (!isMini) ...[
                SizedBox(height: 8),
                Text(
                  description,
                  style: TextStyle(color: AppColors.textMedium, fontSize: 14),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),
              ],
              SizedBox(height: 12),
              ClipRRect(
                borderRadius: BorderRadius.circular(4),
                child: LinearProgressIndicator(
                  value: progress.clamp(0.0, 1.0).toDouble(),
                  backgroundColor: AppColors.elevation,
                  valueColor: AlwaysStoppedAnimation<Color>(
                    hasSigned ? AppColors.success : AppColors.secondaryTeal,
                  ),
                  minHeight: 6,
                ),
              ),

              SizedBox(height: 8),
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    '$signatures of $goal signatures',
                    style: TextStyle(color: AppColors.textMedium, fontSize: 12),
                  ),
                  if (hasSigned)
                    Icon(
                      Feather.check_circle,
                      color: AppColors.success,
                      size: 16,
                    ),
                ],
              ),
              SizedBox(height: 8),
              Text(
                'Created by $creatorName',
                style: TextStyle(color: AppColors.textDisabled, fontSize: 12),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// Events Tab
class EventsTab extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final user = FirebaseAuth.instance.currentUser;

    return StreamBuilder<QuerySnapshot>(
      stream: FirebaseFirestore.instance
          .collection('events')
          .orderBy('date', descending: false)
          .snapshots(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return _buildShimmerList();
        }

        if (snapshot.hasError) {
          return Center(
            child: Text(
              'Error loading events',
              style: TextStyle(color: AppColors.error),
            ),
          );
        }

        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return _buildEmptyState('No events yet ', Feather.calendar);
        }

        final events = snapshot.data!.docs;
        return ListView.builder(
          padding: EdgeInsets.all(12),
          itemCount: events.length,
          itemBuilder: (context, index) {
            final event = events[index];
            final isAttending = user != null
                ? (event['attendees'] as List).contains(user.uid)
                : false;

            return _buildEventCard(event, context, isAttending);
          },
        );
      },
    );
  }

  Widget _buildEventCard(
    DocumentSnapshot event,
    BuildContext context,
    bool isAttending,
  ) {
    final eventData = event.data() as Map<String, dynamic>?;
    final imageUrl = eventData?['imageUrl'] as String?;
    final title = eventData?['title'] as String? ?? 'Untitled Event';
    final description = eventData?['description'] as String?;
    final creatorName = eventData?['creatorName'] as String? ?? 'Unknown';
    final location = eventData?['location'] as String? ?? 'Location TBA';
    final attendeesList = (eventData?['attendees'] as List?) ?? [];
    final attendeesCount = attendeesList.length;

    DateTime date = DateTime.now();
    try {
      final timestamp = eventData?['date'] as Timestamp?;
      if (timestamp != null) {
        date = timestamp.toDate();
      }
    } catch (e) {
      print('Error parsing date for event ${event.id}: $e');
    }

    return Card(
      margin: EdgeInsets.symmetric(vertical: 8),
      color: AppColors.surface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      elevation: 0,
      child: InkWell(
        onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) => EventDetailScreen(eventId: event.id),
            ),
          );
        },
        child: Padding(
          padding: EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              if (imageUrl != null && imageUrl.isNotEmpty)
                Padding(
                  padding: EdgeInsets.only(bottom: 12),
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(12),
                    child: CachedNetworkImage(
                      imageUrl: imageUrl,
                      height: 150,
                      width: double.infinity,
                      fit: BoxFit.cover,
                      placeholder: (context, url) => Container(
                        height: 150,
                        color: AppColors.elevation,
                        child: Center(
                          child: CircularProgressIndicator(
                            color: AppColors.primaryLavender,
                          ),
                        ),
                      ),
                      errorWidget: (context, url, error) =>
                          Icon(Feather.alert_circle, color: AppColors.error),
                    ),
                  ),
                ),
              Text(
                title,
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  fontSize: 18,
                  color: AppColors.textHigh,
                ),
              ),
              SizedBox(height: 8),
              Row(
                children: [
                  Icon(
                    Feather.calendar,
                    size: 16,
                    color: AppColors.primaryLavender,
                  ),
                  SizedBox(width: 8),
                  Text(
                    DateFormat('MMM d, yyyy  h:mm a').format(date),
                    style: TextStyle(color: AppColors.textMedium, fontSize: 14),
                  ),
                ],
              ),
              SizedBox(height: 4),
              Row(
                children: [
                  Icon(
                    Feather.map_pin,
                    size: 16,
                    color: AppColors.primaryLavender,
                  ),
                  SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      location,
                      style: TextStyle(
                        color: AppColors.textMedium,
                        fontSize: 14,
                      ),
                      overflow: TextOverflow.ellipsis,
                    ),
                  ),
                ],
              ),
              SizedBox(height: 8),
              Text(
                description ?? '',
                style: TextStyle(color: AppColors.textMedium, fontSize: 14),
                maxLines: 2,
                overflow: TextOverflow.ellipsis,
              ),
              SizedBox(height: 12),
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    '$attendeesCount attending  Created by $creatorName',
                    style: TextStyle(
                      color: AppColors.textDisabled,
                      fontSize: 12,
                    ),
                  ),
                  if (isAttending)
                    Icon(
                      Feather.check_circle,
                      color: AppColors.success,
                      size: 16,
                    ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// Create Poll Screen
class CreatePollScreen extends StatefulWidget {
  @override
  _CreatePollScreenState createState() => _CreatePollScreenState();
}

class _CreatePollScreenState extends State<CreatePollScreen> {
  final _formKey = GlobalKey<FormState>();
  final TextEditingController _questionController = TextEditingController();
  final TextEditingController _descriptionController = TextEditingController();
  final List<TextEditingController> _optionControllers = [
    TextEditingController(),
    TextEditingController(),
  ];
  File? _image;
  bool _isLoading = false;

  Future<void> _pickImage() async {
    final picker = ImagePicker();
    final pickedFile = await picker.pickImage(source: ImageSource.gallery);

    if (pickedFile != null) {
      setState(() {
        _image = File(pickedFile.path);
      });
    }
  }

  Future<String> _uploadImage() async {
    if (_image == null) return '';

    final storageRef = FirebaseStorage.instance
        .ref()
        .child('poll_images')
        .child('${DateTime.now().millisecondsSinceEpoch}.jpg');

    await storageRef.putFile(_image!);
    return await storageRef.getDownloadURL();
  }

  Future<void> _createPoll() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() {
      _isLoading = true;
    });

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) throw Exception('User not authenticated');

      final imageUrl = await _uploadImage();

      final pollData = {
        'question': _questionController.text,
        'description': _descriptionController.text,
        'options': _optionControllers
            .map<Map<String, dynamic>>((c) => {'text': c.text, 'votes': 0})
            .where((option) => (option['text'] as String).isNotEmpty)
            .toList(),
        'creatorId': user.uid,
        'creatorName': user.displayName ?? user.email,
        'createdAt': Timestamp.now(),
        'voters': [],
        'imageUrl': imageUrl,
        'collaborators': [],
      };

      final docRef = await FirebaseFirestore.instance
          .collection('polls')
          .add(pollData);

      // Send notifications to followers
      NotificationService().sendPollCreatedNotification(
        creatorId: user.uid,
        creatorUsername: pollData['creatorName'] as String,
        pollId: docRef.id,
        pollQuestion: pollData['question'] as String,
        imageUrl: pollData['imageUrl'] as String?,
      );

      Navigator.pop(context);
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Error creating poll: $e')));
    } finally {
      setState(() {
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        title: Text('Create Poll', style: TextStyle(color: AppColors.textHigh)),
        backgroundColor: AppColors.backgroundDeep,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
        actions: [
          IconButton(
            icon: Icon(Feather.check, color: AppColors.primaryLavender),
            onPressed: _isLoading ? null : _createPoll,
          ),
        ],
      ),
      body: _isLoading
          ? Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryLavender,
              ),
            )
          : SingleChildScrollView(
              padding: EdgeInsets.all(16),
              child: Form(
                key: _formKey,
                child: Column(
                  children: [
                    GestureDetector(
                      onTap: _pickImage,
                      child: Container(
                        height: 150,
                        width: double.infinity,
                        decoration: BoxDecoration(
                          borderRadius: BorderRadius.circular(12),
                          color: AppColors.elevation,
                        ),
                        child: _image != null
                            ? ClipRRect(
                                borderRadius: BorderRadius.circular(12),
                                child: Image.file(_image!, fit: BoxFit.cover),
                              )
                            : Column(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  Icon(
                                    Feather.image,
                                    size: 40,
                                    color: AppColors.textDisabled,
                                  ),
                                  Text(
                                    'Add Image',
                                    style: TextStyle(
                                      color: AppColors.textMedium,
                                    ),
                                  ),
                                ],
                              ),
                      ),
                    ),
                    SizedBox(height: 16),
                    _buildTextField(
                      controller: _questionController,
                      label: 'Question',
                    ),
                    SizedBox(height: 16),
                    _buildTextField(
                      controller: _descriptionController,
                      label: 'Description (optional)',
                      maxLines: 3,
                    ),
                    SizedBox(height: 16),
                    Text(
                      'Options',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                        color: AppColors.textHigh,
                      ),
                    ),
                    ..._optionControllers
                        .map(
                          (controller) => Padding(
                            padding: EdgeInsets.only(top: 8),
                            child: _buildTextField(
                              controller: controller,
                              label:
                                  'Option ${_optionControllers.indexOf(controller) + 1}',
                            ),
                          ),
                        )
                        .toList(),
                    SizedBox(height: 8),
                    TextButton(
                      onPressed: () {
                        setState(() {
                          _optionControllers.add(TextEditingController());
                        });
                      },
                      child: Text(
                        '+ Add Option',
                        style: TextStyle(color: AppColors.secondaryTeal),
                      ),
                    ),
                  ],
                ),
              ),
            ),
    );
  }
}

// Create Petition Screen
class CreatePetitionScreen extends StatefulWidget {
  @override
  _CreatePetitionScreenState createState() => _CreatePetitionScreenState();
}

class _CreatePetitionScreenState extends State<CreatePetitionScreen> {
  final _formKey = GlobalKey<FormState>();
  final TextEditingController _titleController = TextEditingController();
  final TextEditingController _descriptionController = TextEditingController();
  final TextEditingController _goalController = TextEditingController(
    text: '1000',
  );
  File? _image;
  bool _isLoading = false;

  Future<void> _pickImage() async {
    final picker = ImagePicker();
    final pickedFile = await picker.pickImage(source: ImageSource.gallery);

    if (pickedFile != null) {
      setState(() {
        _image = File(pickedFile.path);
      });
    }
  }

  Future<String> _uploadImage() async {
    if (_image == null) return '';

    final storageRef = FirebaseStorage.instance
        .ref()
        .child('petition_images')
        .child('${DateTime.now().millisecondsSinceEpoch}.jpg');

    await storageRef.putFile(_image!);
    return await storageRef.getDownloadURL();
  }

  Future<void> _createPetition() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() {
      _isLoading = true;
    });

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) throw Exception('User not authenticated');

      final imageUrl = await _uploadImage();

      final petitionData = {
        'title': _titleController.text,
        'description': _descriptionController.text,
        'goal': int.tryParse(_goalController.text) ?? 1000,
        'creatorId': user.uid,
        'creatorName': user.displayName ?? user.email,
        'createdAt': Timestamp.now(),
        'signatures': 0,
        'signers': [],
        'imageUrl': imageUrl,
        'collaborators': [],
      };

      final docRef = await FirebaseFirestore.instance
          .collection('petitions')
          .add(petitionData);

      // Send notifications to followers
      NotificationService().sendPetitionCreatedNotification(
        creatorId: user.uid,
        creatorUsername: petitionData['creatorName'] as String,
        petitionId: docRef.id,
        petitionTitle: petitionData['title'] as String,
        bannerImageUrl: petitionData['imageUrl'] as String?,
      );

      Navigator.pop(context);
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Error creating petition: $e')));
    } finally {
      setState(() {
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        title: Text(
          'Create Petition',
          style: TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: AppColors.backgroundDeep,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
        actions: [
          IconButton(
            icon: Icon(Feather.check, color: AppColors.primaryLavender),
            onPressed: _isLoading ? null : _createPetition,
          ),
        ],
      ),
      body: _isLoading
          ? Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryLavender,
              ),
            )
          : SingleChildScrollView(
              padding: EdgeInsets.all(16),
              child: Form(
                key: _formKey,
                child: Column(
                  children: [
                    GestureDetector(
                      onTap: _pickImage,
                      child: Container(
                        height: 150,
                        width: double.infinity,
                        decoration: BoxDecoration(
                          borderRadius: BorderRadius.circular(12),
                          color: AppColors.elevation,
                        ),
                        child: _image != null
                            ? ClipRRect(
                                borderRadius: BorderRadius.circular(12),
                                child: Image.file(_image!, fit: BoxFit.cover),
                              )
                            : Column(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  Icon(
                                    Feather.image,
                                    size: 40,
                                    color: AppColors.textDisabled,
                                  ),
                                  Text(
                                    'Add Image',
                                    style: TextStyle(
                                      color: AppColors.textMedium,
                                    ),
                                  ),
                                ],
                              ),
                      ),
                    ),
                    SizedBox(height: 16),
                    _buildTextField(
                      controller: _titleController,
                      label: 'Title',
                    ),
                    SizedBox(height: 16),
                    _buildTextField(
                      controller: _descriptionController,
                      label: 'Description',
                      maxLines: 5,
                    ),
                    SizedBox(height: 16),
                    _buildTextField(
                      controller: _goalController,
                      label: 'Signature Goal',
                      keyboardType: TextInputType.number,
                    ),
                  ],
                ),
              ),
            ),
    );
  }
}

// Create Event Screen
class CreateEventScreen extends StatefulWidget {
  @override
  _CreateEventScreenState createState() => _CreateEventScreenState();
}

class _CreateEventScreenState extends State<CreateEventScreen> {
  final _formKey = GlobalKey<FormState>();
  final TextEditingController _titleController = TextEditingController();
  final TextEditingController _descriptionController = TextEditingController();
  final TextEditingController _locationController = TextEditingController();
  DateTime? _selectedDate;
  TimeOfDay? _selectedTime;
  File? _image;
  bool _isLoading = false;

  Future<void> _pickImage() async {
    final picker = ImagePicker();
    final pickedFile = await picker.pickImage(source: ImageSource.gallery);

    if (pickedFile != null) {
      setState(() {
        _image = File(pickedFile.path);
      });
    }
  }

  Future<String> _uploadImage() async {
    if (_image == null) return '';

    final storageRef = FirebaseStorage.instance
        .ref()
        .child('event_images')
        .child('${DateTime.now().millisecondsSinceEpoch}.jpg');

    await storageRef.putFile(_image!);
    return await storageRef.getDownloadURL();
  }

  Future<void> _selectDateTime() async {
    final date = await showDatePicker(
      context: context,
      initialDate: DateTime.now(),
      firstDate: DateTime.now(),
      lastDate: DateTime.now().add(Duration(days: 365)),
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: ColorScheme.dark(
              primary: AppColors.primaryLavender,
              onPrimary: AppColors.backgroundDeep,
              surface: AppColors.surface,
              onSurface: AppColors.textHigh,
            ),
          ),
          child: child!,
        );
      },
    );

    if (date != null) {
      final time = await showTimePicker(
        context: context,
        initialTime: TimeOfDay.now(),
        builder: (context, child) {
          return Theme(
            data: Theme.of(context).copyWith(
              colorScheme: ColorScheme.dark(
                primary: AppColors.primaryLavender,
                onPrimary: AppColors.backgroundDeep,
                surface: AppColors.surface,
                onSurface: AppColors.textHigh,
              ),
            ),
            child: child!,
          );
        },
      );

      if (time != null) {
        setState(() {
          _selectedDate = date;
          _selectedTime = time;
        });
      }
    }
  }

  Future<void> _createEvent() async {
    if (!_formKey.currentState!.validate()) return;
    if (_selectedDate == null || _selectedTime == null) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Please select date and time')));
      return;
    }

    setState(() {
      _isLoading = true;
    });

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) throw Exception('User not authenticated');

      final imageUrl = await _uploadImage();

      final eventDateTime = DateTime(
        _selectedDate!.year,
        _selectedDate!.month,
        _selectedDate!.day,
        _selectedTime!.hour,
        _selectedTime!.minute,
      );

      final eventData = {
        'title': _titleController.text,
        'description': _descriptionController.text,
        'location': _locationController.text,
        'date': Timestamp.fromDate(eventDateTime),
        'creatorId': user.uid,
        'creatorName': user.displayName ?? user.email,
        'createdAt': Timestamp.now(),
        'attendees': [],
        'imageUrl': imageUrl,
        'collaborators': [],
      };

      await FirebaseFirestore.instance.collection('events').add(eventData);
      Navigator.pop(context);
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Error creating event: $e')));
    } finally {
      setState(() {
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        title: Text(
          'Create Event',
          style: TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: AppColors.backgroundDeep,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
        actions: [
          IconButton(
            icon: Icon(Feather.check, color: AppColors.primaryLavender),
            onPressed: _isLoading ? null : _createEvent,
          ),
        ],
      ),
      body: _isLoading
          ? Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryLavender,
              ),
            )
          : SingleChildScrollView(
              padding: EdgeInsets.all(16),
              child: Form(
                key: _formKey,
                child: Column(
                  children: [
                    GestureDetector(
                      onTap: _pickImage,
                      child: Container(
                        height: 150,
                        width: double.infinity,
                        decoration: BoxDecoration(
                          borderRadius: BorderRadius.circular(12),
                          color: AppColors.elevation,
                        ),
                        child: _image != null
                            ? ClipRRect(
                                borderRadius: BorderRadius.circular(12),
                                child: Image.file(_image!, fit: BoxFit.cover),
                              )
                            : Column(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  Icon(
                                    Feather.image,
                                    size: 40,
                                    color: AppColors.textDisabled,
                                  ),
                                  Text(
                                    'Add Image',
                                    style: TextStyle(
                                      color: AppColors.textMedium,
                                    ),
                                  ),
                                ],
                              ),
                      ),
                    ),
                    SizedBox(height: 16),
                    _buildTextField(
                      controller: _titleController,
                      label: 'Title',
                    ),
                    SizedBox(height: 16),
                    _buildTextField(
                      controller: _descriptionController,
                      label: 'Description',
                      maxLines: 3,
                    ),
                    SizedBox(height: 16),
                    _buildTextField(
                      controller: _locationController,
                      label: 'Location',
                    ),
                    SizedBox(height: 16),
                    Container(
                      decoration: BoxDecoration(
                        color: AppColors.elevation,
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: ListTile(
                        title: Text(
                          _selectedDate == null
                              ? 'Select Date and Time'
                              : '${DateFormat('MMM d, yyyy').format(_selectedDate!)} at ${_selectedTime!.format(context)}',
                          style: TextStyle(color: AppColors.textHigh),
                        ),
                        trailing: Icon(
                          Feather.calendar,
                          color: AppColors.primaryLavender,
                        ),
                        onTap: _selectDateTime,
                      ),
                    ),
                  ],
                ),
              ),
            ),
    );
  }
}

// Reusable Input Field Widget for Create Screens
Widget _buildTextField({
  required TextEditingController controller,
  required String label,
  int maxLines = 1,
  TextInputType? keyboardType,
}) {
  return TextFormField(
    controller: controller,
    style: TextStyle(color: AppColors.textHigh),
    maxLines: maxLines,
    keyboardType: keyboardType,
    decoration: InputDecoration(
      labelText: label,
      labelStyle: TextStyle(color: AppColors.textMedium),
      filled: true,
      fillColor: AppColors.elevation,
      border: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide.none,
      ),
      focusedBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: AppColors.primaryLavender),
      ),
    ),
    validator: (value) => value!.isEmpty ? 'Please enter $label' : null,
  );
}

// Detail Screens with Voting/Signing Functionality
class PollDetailScreen extends StatefulWidget {
  final String pollId;

  const PollDetailScreen({Key? key, required this.pollId}) : super(key: key);

  @override
  _PollDetailScreenState createState() => _PollDetailScreenState();
}

class _PollDetailScreenState extends State<PollDetailScreen> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  String? _selectedOption;
  bool _isLoading = false;

  Future<void> _vote(String optionIndex) async {
    final user = _auth.currentUser;
    if (user == null) return;

    setState(() {
      _isLoading = true;
    });

    try {
      final pollDoc = _firestore.collection('polls').doc(widget.pollId);
      await _firestore.runTransaction((transaction) async {
        final poll = await transaction.get(pollDoc);
        if (!poll.exists) throw Exception('Poll not found');

        final voters = List<String>.from(poll['voters'] ?? []);
        if (voters.contains(user.uid)) {
          throw Exception('You have already voted');
        }

        final options = List<Map<String, dynamic>>.from(poll['options']);
        options[int.parse(optionIndex)]['votes'] =
            (options[int.parse(optionIndex)]['votes'] as int) + 1;
        voters.add(user.uid);

        transaction.update(pollDoc, {'options': options, 'voters': voters});
      });

      setState(() {
        _selectedOption = optionIndex;
      });
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Error voting: $e')));
    } finally {
      setState(() {
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        title: Text(
          'Poll Details',
          style: TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: AppColors.backgroundDeep,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
      ),
      body: StreamBuilder<DocumentSnapshot>(
        stream: _firestore.collection('polls').doc(widget.pollId).snapshots(),
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting) {
            return Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryLavender,
              ),
            );
          }

          if (!snapshot.hasData || !snapshot.data!.exists) {
            return Center(
              child: Text(
                'Poll not found',
                style: TextStyle(color: AppColors.textHigh),
              ),
            );
          }

          final poll = snapshot.data!;
          final options = List<Map<String, dynamic>>.from(poll['options']);
          final totalVotes = options.fold<int>(
            0,
            (sum, option) => sum + (option['votes'] as int),
          );
          final hasVoted = (poll['voters'] as List).contains(
            _auth.currentUser?.uid,
          );

          return SingleChildScrollView(
            padding: EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                if (poll['imageUrl'] != null && poll['imageUrl'].isNotEmpty)
                  Padding(
                    padding: EdgeInsets.only(bottom: 16),
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(12),
                      child: CachedNetworkImage(
                        imageUrl: poll['imageUrl'],
                        height: 200,
                        width: double.infinity,
                        fit: BoxFit.cover,
                      ),
                    ),
                  ),

                Text(
                  poll['question'],
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                    color: AppColors.textHigh,
                  ),
                ),

                SizedBox(height: 8),

                if (poll['description'] != null &&
                    poll['description'].isNotEmpty)
                  Text(
                    poll['description'],
                    style: TextStyle(fontSize: 16, color: AppColors.textMedium),
                  ),

                SizedBox(height: 16),

                ...options.asMap().entries.map((entry) {
                  final index = entry.key;
                  final option = entry.value;
                  final votes = option['votes'] as int;
                  final percentage = totalVotes > 0
                      ? (votes / totalVotes * 100)
                      : 0;

                  return Card(
                    color: AppColors.surface,
                    margin: EdgeInsets.only(bottom: 8),
                    child: ListTile(
                      title: Text(
                        option['text'],
                        style: TextStyle(color: AppColors.textHigh),
                      ),
                      subtitle: hasVoted || _selectedOption != null
                          ? ClipRRect(
                              borderRadius: BorderRadius.circular(4),
                              child: LinearProgressIndicator(
                                value: percentage / 100,
                                backgroundColor: AppColors.elevation,
                                valueColor: AlwaysStoppedAnimation<Color>(
                                  AppColors.secondaryTeal,
                                ),
                              ),
                            )
                          : null,
                      trailing: hasVoted || _selectedOption != null
                          ? Text(
                              '${percentage.toStringAsFixed(1)}% ($votes votes)',
                              style: TextStyle(color: AppColors.textMedium),
                            )
                          : null,
                      onTap:
                          (!hasVoted && _selectedOption == null && !_isLoading)
                          ? () => _vote(index.toString())
                          : null,
                      selected: _selectedOption == index.toString(),
                      tileColor: _selectedOption == index.toString()
                          ? AppColors.primaryLavender.withOpacity(0.1)
                          : null,
                    ),
                  );
                }).toList(),

                SizedBox(height: 16),

                Text(
                  'Total votes: $totalVotes  Created by ${poll['creatorName']}',
                  style: TextStyle(color: AppColors.textDisabled),
                ),
              ],
            ),
          );
        },
      ),
    );
  }
}

class PetitionDetailScreen extends StatefulWidget {
  final String petitionId;

  const PetitionDetailScreen({Key? key, required this.petitionId})
    : super(key: key);

  @override
  _PetitionDetailScreenState createState() => _PetitionDetailScreenState();
}

class _PetitionDetailScreenState extends State<PetitionDetailScreen> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  bool _isLoading = false;

  Future<void> _signPetition() async {
    final user = _auth.currentUser;
    if (user == null) return;

    setState(() {
      _isLoading = true;
    });

    try {
      final petitionDoc = _firestore
          .collection('petitions')
          .doc(widget.petitionId);
      await _firestore.runTransaction((transaction) async {
        final petition = await transaction.get(petitionDoc);
        if (!petition.exists) throw Exception('Petition not found');

        final signers = List<String>.from(petition['signers'] ?? []);
        if (signers.contains(user.uid)) {
          throw Exception('You have already signed this petition');
        }

        transaction.update(petitionDoc, {
          'signatures': FieldValue.increment(1),
          'signers': FieldValue.arrayUnion([user.uid]),
        });
      });
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Error signing: $e')));
    } finally {
      setState(() {
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        title: Text(
          'Petition Details',
          style: TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: AppColors.backgroundDeep,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
      ),
      body: StreamBuilder<DocumentSnapshot>(
        stream: _firestore
            .collection('petitions')
            .doc(widget.petitionId)
            .snapshots(),
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting) {
            return Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryLavender,
              ),
            );
          }

          if (!snapshot.hasData || !snapshot.data!.exists) {
            return Center(
              child: Text(
                'Petition not found',
                style: TextStyle(color: AppColors.textHigh),
              ),
            );
          }

          final petition = snapshot.data!;
          final signatures = petition['signatures'] as int;
          final goal = petition['goal'] as int;
          final progress = signatures / goal;
          final hasSigned = (petition['signers'] as List).contains(
            _auth.currentUser?.uid,
          );

          return SingleChildScrollView(
            padding: EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                if (petition['imageUrl'] != null &&
                    petition['imageUrl'].isNotEmpty)
                  Padding(
                    padding: EdgeInsets.only(bottom: 16),
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(12),
                      child: CachedNetworkImage(
                        imageUrl: petition['imageUrl'],
                        height: 200,
                        width: double.infinity,
                        fit: BoxFit.cover,
                      ),
                    ),
                  ),

                Text(
                  petition['title'],
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                    color: AppColors.textHigh,
                  ),
                ),

                SizedBox(height: 16),

                ClipRRect(
                  borderRadius: BorderRadius.circular(4),
                  child: LinearProgressIndicator(
                    value: progress.clamp(0.0, 1.0),
                    backgroundColor: AppColors.elevation,
                    valueColor: AlwaysStoppedAnimation<Color>(
                      AppColors.secondaryTeal,
                    ),
                    minHeight: 10,
                  ),
                ),

                SizedBox(height: 8),

                Text(
                  '$signatures of $goal signatures',
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                    color: AppColors.textHigh,
                  ),
                ),

                SizedBox(height: 16),

                Text(
                  petition['description'],
                  style: TextStyle(
                    fontSize: 16,
                    height: 1.5,
                    color: AppColors.textMedium,
                  ),
                ),

                SizedBox(height: 24),

                if (!hasSigned)
                  SizedBox(
                    width: double.infinity,
                    child: ElevatedButton(
                      onPressed: _isLoading ? null : _signPetition,
                      child: _isLoading
                          ? CircularProgressIndicator(
                              color: AppColors.backgroundDeep,
                            )
                          : Text(
                              'Sign This Petition',
                              style: TextStyle(color: AppColors.backgroundDeep),
                            ),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.primaryLavender,
                        padding: EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                    ),
                  ),

                if (hasSigned)
                  SizedBox(
                    width: double.infinity,
                    child: OutlinedButton(
                      onPressed: null,
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(Feather.check_circle, color: AppColors.success),
                          SizedBox(width: 8),
                          Text(
                            'Already Signed',
                            style: TextStyle(color: AppColors.success),
                          ),
                        ],
                      ),
                      style: OutlinedButton.styleFrom(
                        padding: EdgeInsets.symmetric(vertical: 16),
                        side: BorderSide(color: AppColors.success),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                    ),
                  ),

                SizedBox(height: 16),

                Text(
                  'Created by ${petition['creatorName']}',
                  style: TextStyle(color: AppColors.textDisabled),
                ),
              ],
            ),
          );
        },
      ),
    );
  }
}

class EventDetailScreen extends StatefulWidget {
  final String eventId;

  const EventDetailScreen({Key? key, required this.eventId}) : super(key: key);

  @override
  _EventDetailScreenState createState() => _EventDetailScreenState();
}

class _EventDetailScreenState extends State<EventDetailScreen> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  bool _isLoading = false;

  Future<void> _toggleAttendance() async {
    final user = _auth.currentUser;
    if (user == null) return;

    setState(() {
      _isLoading = true;
    });

    try {
      final eventDoc = _firestore.collection('events').doc(widget.eventId);
      final event = await eventDoc.get();

      if (!event.exists) throw Exception('Event not found');

      final attendees = List<String>.from(event['attendees'] ?? []);
      final isAttending = attendees.contains(user.uid);

      await eventDoc.update({
        'attendees': isAttending
            ? FieldValue.arrayRemove([user.uid])
            : FieldValue.arrayUnion([user.uid]),
      });
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Error updating attendance: $e')));
    } finally {
      setState(() {
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        title: Text(
          'Event Details',
          style: TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: AppColors.backgroundDeep,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
      ),
      body: StreamBuilder<DocumentSnapshot>(
        stream: _firestore.collection('events').doc(widget.eventId).snapshots(),
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting) {
            return Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryLavender,
              ),
            );
          }

          if (!snapshot.hasData || !snapshot.data!.exists) {
            return Center(
              child: Text(
                'Event not found',
                style: TextStyle(color: AppColors.textHigh),
              ),
            );
          }

          final event = snapshot.data!;
          final date = event['date'] != null
              ? (event['date'] as Timestamp).toDate()
              : DateTime.now();
          final attendees = (event['attendees'] as List).length;
          final isAttending = (event['attendees'] as List).contains(
            _auth.currentUser?.uid,
          );

          return SingleChildScrollView(
            padding: EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                if (event['imageUrl'] != null && event['imageUrl'].isNotEmpty)
                  Padding(
                    padding: EdgeInsets.only(bottom: 16),
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(12),
                      child: CachedNetworkImage(
                        imageUrl: event['imageUrl'],
                        height: 200,
                        width: double.infinity,
                        fit: BoxFit.cover,
                      ),
                    ),
                  ),

                Text(
                  event['title'],
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                    color: AppColors.textHigh,
                  ),
                ),

                SizedBox(height: 16),

                Row(
                  children: [
                    Icon(Feather.calendar, color: AppColors.primaryLavender),
                    SizedBox(width: 12),
                    Text(
                      DateFormat('MMM d, yyyy  h:mm a').format(date),
                      style: TextStyle(
                        fontSize: 16,
                        color: AppColors.textMedium,
                      ),
                    ),
                  ],
                ),

                SizedBox(height: 12),

                Row(
                  children: [
                    Icon(Feather.map_pin, color: AppColors.primaryLavender),
                    SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        event['location'],
                        style: TextStyle(
                          fontSize: 16,
                          color: AppColors.textMedium,
                        ),
                      ),
                    ),
                  ],
                ),

                SizedBox(height: 16),

                Text(
                  event['description'] ?? '',
                  style: TextStyle(
                    fontSize: 16,
                    height: 1.5,
                    color: AppColors.textMedium,
                  ),
                ),

                SizedBox(height: 24),

                Row(
                  children: [
                    Icon(Feather.users, color: AppColors.secondaryTeal),
                    SizedBox(width: 8),
                    Text(
                      '$attendees people attending',
                      style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                    ),
                  ],
                ),

                SizedBox(height: 24),

                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    onPressed: _isLoading ? null : _toggleAttendance,
                    child: _isLoading
                        ? CircularProgressIndicator(
                            color: AppColors.backgroundDeep,
                          )
                        : Text(
                            isAttending ? 'Cancel Attendance' : 'Attend Event',
                            style: TextStyle(
                              color: isAttending
                                  ? AppColors.textHigh
                                  : AppColors.backgroundDeep,
                            ),
                          ),
                    style: ElevatedButton.styleFrom(
                      padding: EdgeInsets.symmetric(vertical: 16),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      backgroundColor: isAttending
                          ? AppColors.elevation
                          : AppColors.primaryLavender,
                    ),
                  ),
                ),

                SizedBox(height: 16),

                Text(
                  'Created by ${event['creatorName']}',
                  style: TextStyle(color: AppColors.textDisabled),
                ),
              ],
            ),
          );
        },
      ),
    );
  }
}

Widget _buildShimmerList() {
  return ListView.builder(
    padding: EdgeInsets.all(12),
    itemCount: 6,
    itemBuilder: (context, index) {
      return Shimmer.fromColors(
        baseColor: AppColors.elevation,
        highlightColor: AppColors.surface,
        child: Card(
          margin: EdgeInsets.symmetric(vertical: 8),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          child: Container(
            height: 180,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(16),
              color: AppColors.elevation,
            ),
          ),
        ),
      );
    },
  );
}

Widget _buildEmptyState(String message, IconData icon) {
  return Center(
    child: Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        Icon(icon, size: 64, color: AppColors.textDisabled),
        SizedBox(height: 16),
        Text(
          message,
          style: TextStyle(fontSize: 18, color: AppColors.textMedium),
          textAlign: TextAlign.center,
        ),
      ],
    ),
  );
}


--- C:\Code\femn\lib\circle\discussions.dart ---

import 'dart:async';
import 'dart:io';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:femn/customization/colors.dart'; // <--- IMPORT YOUR COLORS FILE
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:flutter_staggered_grid_view/flutter_staggered_grid_view.dart';
import 'package:image_picker/image_picker.dart';
import 'package:image_cropper/image_cropper.dart';
import 'package:intl/intl.dart';
import 'package:uuid/uuid.dart';
import 'package:femn/customization/layout.dart';
import 'groups.dart';

class DiscussionsScreen extends StatefulWidget {
  @override
  _DiscussionsScreenState createState() => _DiscussionsScreenState();
}

class _DiscussionsScreenState extends State<DiscussionsScreen> {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  late String _currentUserId;
  String _selectedCategory = 'All';
  final List<String> _categories = ['All', 'General', 'Education', 'Health', 'Career', 'Relationships'];
  String _searchQuery = '';

  @override
  void initState() {
    super.initState();
    _currentUserId = _auth.currentUser!.uid;
  }

  // Method to check if a discussion is archived
  bool _isDiscussionArchived(Map<String, dynamic> discussionData) {
    final Timestamp? expiresAt = discussionData['expiresAt'];
    if (expiresAt == null) return false;
    
    final DateTime expirationDate = expiresAt.toDate();
    return DateTime.now().isAfter(expirationDate);
  }

  // Method to get days left for a discussion
  int? _getDaysLeft(Map<String, dynamic> discussionData) {
    final Timestamp? expiresAt = discussionData['expiresAt'];
    if (expiresAt == null) return null;
    
    final DateTime expirationDate = expiresAt.toDate();
    final DateTime now = DateTime.now();
    
    if (now.isAfter(expirationDate)) return null;
    
    return expirationDate.difference(now).inDays;
  }

  // Method to get average rating for archived discussion
  double _getAverageRating(Map<String, dynamic> discussionData) {
    final Map<String, dynamic>? ratings = discussionData['ratings'];
    if (ratings == null || ratings.isEmpty) return 0.0;
    
    final double total = ratings.values.map((rating) => rating.toDouble()).reduce((a, b) => a + b);
    return total / ratings.length;
  }

  Widget _buildDiscussionsGrid() {
    return StreamBuilder<QuerySnapshot>(
      stream: _firestore
          .collection('discussions')
          .where('isPrivate', isEqualTo: false)
          .snapshots(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return const GridShimmerSkeleton();
        }
        
        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Feather.message_square, size: 50, color: AppColors.textDisabled),
                SizedBox(height: 16),
                Text(
                  'No discussions yet',
                  textAlign: TextAlign.center,
                  style: TextStyle(fontSize: 16, color: AppColors.textMedium),
                ),
                SizedBox(height: 8),
                Text(
                  'Be the first to start a discussion!',
                  textAlign: TextAlign.center,
                  style: TextStyle(color: AppColors.textDisabled),
                ),
              ],
            ),
          );
        }
        
        final discussions = snapshot.data!.docs;
        
        // Filter by category
        final filteredDiscussions = _selectedCategory == 'All'
            ? discussions
            : discussions.where((discussion) {
                final discussionData = discussion.data() as Map<String, dynamic>;
                final String category = discussionData['category'] ?? 'General';
                return category == _selectedCategory;
              }).toList();
        
        // Filter out discussions user is already a member of
        final discoverDiscussions = filteredDiscussions.where((discussion) {
          final discussionData = discussion.data() as Map<String, dynamic>;
          final List<dynamic> members = discussionData['members'] ?? [];
          return !members.contains(_currentUserId);
        }).toList();
        
        if (discoverDiscussions.isEmpty) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Feather.search, size: 50, color: AppColors.textDisabled),
                SizedBox(height: 16),
                Text(
                  'No discussions found in ${_selectedCategory == "All" ? "any category" : _selectedCategory}',
                  textAlign: TextAlign.center,
                  style: TextStyle(fontSize: 16, color: AppColors.textMedium),
                ),
                SizedBox(height: 8),
                Text(
                  'Try a different category or create your own discussion',
                  textAlign: TextAlign.center,
                  style: TextStyle(color: AppColors.textDisabled),
                ),
              ],
            ),
          );
        }
        
        return Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16.0),
          child: MasonryGridView.count(
            crossAxisCount: ResponsiveLayout.getColumnCount(context),
            mainAxisSpacing: 8,
            crossAxisSpacing: 8,
            itemCount: discoverDiscussions.length,
            itemBuilder: (context, index) {
              final discussion = discoverDiscussions[index];
              final discussionData = discussion.data() as Map<String, dynamic>;
              final String discussionId = discussion.id;
              final String discussionName = discussionData['name'] ?? 'Untitled Discussion';
              final String discussionImage = discussionData['imageUrl'] ?? '';
              final int memberCount = discussionData['memberCount'] ?? 0;
              final String discussionDescription = discussionData['description'] ?? '';
              final String ageRating = discussionData['ageRating'] ?? '13-17';
              final List<dynamic> hashtagsList = discussionData['hashtags'] ?? [];
              final List<String> hashtags = hashtagsList.cast<String>();
              
              final bool isArchived = _isDiscussionArchived(discussionData);
              final int? daysLeft = isArchived ? null : _getDaysLeft(discussionData);
              
              final Map<String, dynamic> ratings = discussionData['ratings'] ?? {};
              double averageRating = 0;
              if (ratings.isNotEmpty) {
                averageRating = ratings.values.map((v) => (v as num).toDouble()).reduce((a, b) => a + b) / ratings.length;
              }
              final int ratingCount = ratings.length;

              return Card(
                margin: EdgeInsets.zero,
                color: AppColors.surface, // Dark Card
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
                elevation: 1,
                child: InkWell(
                  onTap: () {
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (context) => DiscussionViewScreen(
                          discussionId: discussionId,
                          onJoinSuccess: null,
                        ),
                      ),
                    );
                  },
                  borderRadius: BorderRadius.circular(12),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.stretch,
                    children: [
                      Stack(
                        children: [
                          ClipRRect(
                            borderRadius: BorderRadius.vertical(top: Radius.circular(12)),
                            child: AspectRatio(
                              aspectRatio: 16 / 9,
                              child: discussionImage.isNotEmpty
                                  ? CachedNetworkImage(
                                      imageUrl: discussionImage,
                                      fit: BoxFit.cover,
                                      placeholder: (context, url) =>
                                          Container(color: AppColors.elevation),
                                      errorWidget: (context, url, error) =>
                                          Icon(Feather.alert_circle, color: AppColors.error),
                                    )
                                  : Container(
                                      color: AppColors.elevation,
                                      child: Icon(Feather.message_square, color: AppColors.textDisabled),
                                    ),
                            ),
                          ),
                          Positioned(
                            top: 8,
                            right: 8,
                            child: Container(
                              padding: EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                              decoration: BoxDecoration(
                                color: Colors.black54,
                                borderRadius: BorderRadius.circular(12),
                              ),
                              child: Row(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Icon(Feather.users, color: Colors.white, size: 16),
                                  SizedBox(width: 4),
                                  Text(
                                    '$memberCount',
                                    style: TextStyle(color: Colors.white, fontSize: 12),
                                  ),
                                ],
                              ),
                            ),
                          ),
                          // Days left or Archived badge
                          Positioned(
                            bottom: 8,
                            left: 8,
                            child: Container(
                              padding: EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                              decoration: BoxDecoration(
                                color: isArchived ? AppColors.textDisabled : AppColors.accentMustard,
                                borderRadius: BorderRadius.circular(8),
                              ),
                              child: Text(
                                isArchived ? 'Archived' : '$daysLeft days left',
                                style: TextStyle(
                                  color: AppColors.backgroundDeep,
                                  fontSize: 10,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ),
                          ),
                        ],
                      ),
                      Padding(
                        padding: const EdgeInsets.all(8.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              discussionName,
                              style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16, color: AppColors.textHigh),
                              maxLines: 1,
                              overflow: TextOverflow.ellipsis,
                            ),
                            const SizedBox(height: 6),
                            Row(
                              children: [
                                Icon(Icons.star_rounded, size: 16, color: AppColors.accentMustard),
                                SizedBox(width: 4),
                                Text(
                                  averageRating > 0 ? averageRating.toStringAsFixed(1) : '0.0',
                                  style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13, color: AppColors.textHigh),
                                ),
                                SizedBox(width: 4),
                                Text(
                                  "($ratingCount)",
                                  style: TextStyle(fontSize: 12, color: AppColors.textMedium),
                                ),
                              ],
                            ),
                            SizedBox(height: 4),
                            if (hashtags.isNotEmpty)
                              SizedBox(
                                height: 20,
                                child: ListView(
                                  scrollDirection: Axis.horizontal,
                                  children: hashtags.map((tag) {
                                    return Padding(
                                      padding: const EdgeInsets.only(right: 4.0),
                                      child: Text(
                                        '#$tag',
                                        style: TextStyle(fontSize: 11, color: AppColors.primaryLavender),
                                      ),
                                    );
                                  }).toList(),
                                ),
                              ),
                            SizedBox(height: 2),
                            Row(
                              mainAxisAlignment: MainAxisAlignment.spaceBetween,
                              children: [
                                Text(
                                  discussionData['category'] ?? 'General',
                                  style: TextStyle(fontSize: 11, color: AppColors.textDisabled),
                                ),
                                Text(
                                  ageRating,
                                  style: TextStyle(fontSize: 11, color: AppColors.textDisabled),
                                ),
                              ],
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              );
            },
          ),
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: Text('Discussions', style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)),
        backgroundColor: Colors.transparent,
        elevation: 0,
        actions: [
          IconButton(
            icon: Icon(Feather.search, color: AppColors.primaryLavender),
            onPressed: () {
              // Implement search functionality
            },
          ),
        ],
      ),
      body: Column(
        children: [
          // Category filter
          Container(
            height: 50,
            child: ListView.builder(
              scrollDirection: Axis.horizontal,
              itemCount: _categories.length,
              itemBuilder: (context, index) {
                final category = _categories[index];
                final isSelected = _selectedCategory == category;
                return Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 8.0, vertical: 8.0),
                  child: FilterChip(
                    label: Text(category),
                    selected: isSelected,
                    onSelected: (selected) {
                      setState(() {
                        _selectedCategory = selected ? category : 'All';
                      });
                    },
                    backgroundColor: AppColors.elevation,
                    selectedColor: AppColors.secondaryTeal,
                    labelStyle: TextStyle(
                      color: isSelected ? Colors.white : AppColors.textMedium,
                    ),
                    checkmarkColor: Colors.white,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20), side: BorderSide.none),
                  ),
                );
              },
            ),
          ),
          Expanded(
            child: _buildDiscussionsGrid(),
          ),
        ],
      ),
    );
  }
}

class DiscussionViewScreen extends StatefulWidget {
  final String discussionId;
  final VoidCallback? onJoinSuccess;
  const DiscussionViewScreen({
    Key? key, 
    required this.discussionId, 
    this.onJoinSuccess
  }) : super(key: key);

  @override
  _DiscussionViewScreenState createState() => _DiscussionViewScreenState();
}

class _DiscussionViewScreenState extends State<DiscussionViewScreen> {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  late String _currentUserId;
  late DocumentReference _discussionDocRef;
  bool _isMember = false;
  bool _isArchived = false;
  bool _isJoining = false;
  List<QueryDocumentSnapshot> _recentMessages = [];

  @override
  void initState() {
    super.initState();
    _currentUserId = _auth.currentUser!.uid;
    // --- ENSURE THIS POINTS TO 'discussions' ---
    _discussionDocRef = _firestore.collection('discussions').doc(widget.discussionId);
    _checkMembership();
    _checkIfArchived();
    _markMessagesAsRead();
    _loadRecentMessages();
  }

  Future<void> _loadRecentMessages() async {
    try {
      final messagesSnapshot = await _discussionDocRef
          .collection('messages')
          .orderBy('timestamp', descending: true)
          .limit(30)
          .get();
      
      setState(() {
        _recentMessages = messagesSnapshot.docs;
      });
    } catch (e) {
      print("Error loading recent messages: $e");
    }
  }

  // Inside _DiscussionViewScreenState class (in discussions.dart)
  Future<void> _markMessagesAsRead() async {
    try {
      final discussionDoc = await _discussionDocRef.get();
      if (discussionDoc.exists) {
        final discussionData = discussionDoc.data() as Map<String, dynamic>?;
        if (discussionData == null) return;

        // Access the unreadCount map for the current user
        final Map<String, dynamic> unreadCountMap =
            discussionData['unreadCount'] ?? {};
        final int currentUnread = unreadCountMap[_currentUserId] ?? 0;

        // Only update if there are unread messages
        if (currentUnread > 0) {
          // Update the specific user's unread count within the map using dot notation
          await _discussionDocRef.update({
            'unreadCount.$_currentUserId': 0,
          });
        }
      }
    } catch (e) {
      print("Error marking messages as read: $e");
      // Optionally show a snackbar or handle the error
    }
  }

  Future<void> _checkMembership() async {
    final discussionDoc = await _discussionDocRef.get();
    if (discussionDoc.exists) {
      final discussionData = discussionDoc.data() as Map<String, dynamic>;
      final List<dynamic> members = discussionData['members'] ?? [];
      setState(() {
        _isMember = members.contains(_currentUserId);
      });
    }
  }

  Future<void> _checkIfArchived() async {
    final discussionDoc = await _discussionDocRef.get();
    if (discussionDoc.exists) {
      final discussionData = discussionDoc.data() as Map<String, dynamic>;
      final Timestamp? expiresAt = discussionData['expiresAt'];
      if (expiresAt != null) {
        final DateTime expirationDate = expiresAt.toDate();
        setState(() {
          _isArchived = DateTime.now().isAfter(expirationDate);
        });
      }
    }
  }

  Future<void> _joinDiscussion() async {
    if (_isJoining || _isMember || _isArchived) return;
    
    setState(() {
      _isJoining = true;
    });

    try {
      await _discussionDocRef.update({
        'members': FieldValue.arrayUnion([_currentUserId]),
        'memberCount': FieldValue.increment(1),
        'unreadCount.$_currentUserId': 0,
      });

      setState(() {
        _isMember = true;
        _isJoining = false;
      });

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Joined discussion successfully', style: TextStyle(color: AppColors.backgroundDeep)),
          backgroundColor: AppColors.success,
        ),
      );

      if (widget.onJoinSuccess != null) {
        widget.onJoinSuccess!();
      }
    } catch (e) {
      print("Error joining discussion: $e");
      setState(() {
        _isJoining = false;
      });
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to join discussion. Please try again.')),
      );
    }
  }

  Future<void> _rateDiscussion(double rating) async {
    try {
      await _discussionDocRef.update({
        'ratings.$_currentUserId': rating,
      });

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Rating submitted successfully', style: TextStyle(color: AppColors.backgroundDeep)),
          backgroundColor: AppColors.success,
        ),
      );
    } catch (e) {
      print("Error rating discussion: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to submit rating. Please try again.')),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: StreamBuilder<DocumentSnapshot>(
          stream: _discussionDocRef.snapshots(),
          builder: (context, snapshot) {
            if (!snapshot.hasData) return Text('Discussion');
            final discussionData = snapshot.data!.data() as Map<String, dynamic>?;
            return Text(discussionData?['name'] ?? 'Discussion', style: TextStyle(color: AppColors.textHigh));
          },
        ),
        backgroundColor: Colors.transparent,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
        elevation: 0,
        actions: [
          if (!_isMember && !_isArchived)
            Padding(
              padding: EdgeInsets.only(right: 16),
              child: _isJoining
                  ? Center(child: CircularProgressIndicator(color: AppColors.primaryLavender))
                  : TextButton(
                      onPressed: _joinDiscussion,
                      child: Text('JOIN', style: TextStyle(color: AppColors.backgroundDeep, fontWeight: FontWeight.bold)),
                      style: TextButton.styleFrom(
                        backgroundColor: AppColors.primaryLavender,
                        shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(20)),
                      ),
                    ),
            ),
        ],
      ),
      body: _isMember 
          ? DiscussionChatScreen(discussionId: widget.discussionId)
          : _isArchived
              ? _buildArchivedDiscussionView()
              : _buildDiscussionPreview(),
    );
  }

  Widget _buildDiscussionPreview() {
    return StreamBuilder<DocumentSnapshot>(
      stream: _discussionDocRef.snapshots(),
      builder: (context, snapshot) {
        if (!snapshot.hasData) return Center(child: CircularProgressIndicator(color: AppColors.primaryLavender));
        
        final discussionData = snapshot.data!.data() as Map<String, dynamic>?;
        if (discussionData == null) return Center(child: Text('Discussion not found'));
        
        final String description = discussionData['description'] ?? '';
        final List<dynamic> hashtags = discussionData['hashtags'] ?? [];
        final Map<String, dynamic> ratings = discussionData['ratings'] ?? {};
        
        double averageRating = 0;
        if (ratings.isNotEmpty) {
          averageRating = ratings.values.map((v) => (v as num).toDouble()).reduce((a, b) => a + b) / ratings.length;
        }

        return Column(
          children: [
            // Enhanced Preview Header
                  Container(
                    padding: EdgeInsets.all(20),
                    margin: EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: AppColors.surface.withOpacity(0.8),
                      borderRadius: BorderRadius.circular(24),
                      border: Border.all(color: AppColors.primaryLavender.withOpacity(0.1)),
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black.withOpacity(0.1),
                          blurRadius: 20,
                          offset: Offset(0, 10),
                        ),
                      ],
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          children: [
                            Container(
                              padding: EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                              decoration: BoxDecoration(
                                color: AppColors.primaryLavender.withOpacity(0.1),
                                borderRadius: BorderRadius.circular(8),
                              ),
                              child: Text('PREVIEW MODE', 
                                style: TextStyle(fontSize: 10, fontWeight: FontWeight.w900, color: AppColors.primaryLavender, letterSpacing: 1.2)),
                            ),
                            Spacer(),
                            if (averageRating > 0)
                              Row(
                                children: [
                                  Icon(Icons.star_rounded, color: AppColors.accentMustard, size: 18),
                                  SizedBox(width: 4),
                                  Text(averageRating.toStringAsFixed(1), 
                                    style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold, fontSize: 14)),
                                  Text(' (${ratings.length})', 
                                    style: TextStyle(color: AppColors.textDisabled, fontSize: 12)),
                                ],
                              ),
                          ],
                        ),
                        SizedBox(height: 16),
                        if (description.isNotEmpty)
                          Text(description, 
                            style: TextStyle(color: AppColors.textHigh, fontSize: 15, height: 1.5, fontWeight: FontWeight.w500)),
                        if (hashtags.isNotEmpty) ...[
                          SizedBox(height: 16),
                          Wrap(
                            spacing: 8,
                            runSpacing: 8,
                            children: hashtags.map((tag) => Container(
                              padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                              decoration: BoxDecoration(
                                gradient: LinearGradient(
                                  colors: [AppColors.primaryLavender.withOpacity(0.15), AppColors.primaryLavender.withOpacity(0.05)],
                                ),
                                borderRadius: BorderRadius.circular(12),
                                border: Border.all(color: AppColors.primaryLavender.withOpacity(0.1)),
                              ),
                              child: Text('#$tag', 
                                style: TextStyle(color: AppColors.primaryLavender, fontSize: 12, fontWeight: FontWeight.bold)),
                            )).toList(),
                          ),
                        ],
                        SizedBox(height: 20),
                        Container(
                          width: double.infinity,
                          padding: EdgeInsets.symmetric(vertical: 12),
                          decoration: BoxDecoration(
                            color: AppColors.elevation.withOpacity(0.5),
                            borderRadius: BorderRadius.circular(12),
                          ),
                          child: Center(
                            child: Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Icon(Feather.info, size: 14, color: AppColors.textDisabled),
                                SizedBox(width: 8),
                                Text('Join to participate in the conversation', 
                                  style: TextStyle(color: AppColors.textDisabled, fontSize: 13, fontWeight: FontWeight.w500)),
                              ],
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
            // Chat Preview Area
            Expanded(
              child: ListView.builder(
                reverse: true, // Show most recent at bottom
                padding: EdgeInsets.symmetric(vertical: 16),
                itemCount: _recentMessages.length,
                itemBuilder: (context, index) {
                  final message = _recentMessages[index];
                  final messageData = message.data() as Map<String, dynamic>;
                  return _buildMessageItem(messageData);
                },
              ),
            ),
          ],
        );
      },
    );
  }

  Widget _buildMessageItem(Map<String, dynamic> messageData) {
    final String senderId = messageData['senderId'] ?? '';
    final String text = messageData['text'] ?? '';
    final String type = messageData['type'] ?? 'text';
    final Timestamp? timestamp = messageData['timestamp'];
    final DateTime? messageTime = timestamp?.toDate();

    return FutureBuilder<Map<String, dynamic>>(
      future: UserProfileCache.getUserProfile(senderId),
      builder: (context, snapshot) {
        String senderName = 'User';
        String senderImage = '';
        if (snapshot.hasData) {
          senderName = snapshot.data!['name'] ?? 'User';
          senderImage = snapshot.data!['profileImage'] ?? '';
        }

        bool isMe = senderId == _currentUserId;

        return Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
          child: Row(
            mainAxisAlignment: isMe ? MainAxisAlignment.end : MainAxisAlignment.start,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              if (!isMe)
                CircleAvatar(
                  radius: 14,
                  backgroundColor: AppColors.elevation,
                  backgroundImage: senderImage.isNotEmpty ? CachedNetworkImageProvider(senderImage) : null,
                  child: senderImage.isEmpty ? Icon(Feather.user, size: 14, color: AppColors.textDisabled) : null,
                ),
              if (!isMe) SizedBox(width: 8),
              Flexible(
                child: Column(
                  crossAxisAlignment: isMe ? CrossAxisAlignment.end : CrossAxisAlignment.start,
                  children: [
                    if (!isMe)
                      Padding(
                        padding: const EdgeInsets.only(left: 4, bottom: 2),
                        child: Text(senderName, style: TextStyle(fontSize: 11, fontWeight: FontWeight.bold, color: AppColors.textMedium)),
                      ),
                    Container(
                      padding: EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                      decoration: BoxDecoration(
                        color: isMe ? AppColors.primaryLavender : AppColors.elevation,
                        borderRadius: BorderRadius.only(
                          topLeft: Radius.circular(16),
                          topRight: Radius.circular(16),
                          bottomLeft: Radius.circular(isMe ? 16 : 4),
                          bottomRight: Radius.circular(isMe ? 4 : 16),
                        ),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          if (type == 'image')
                            ClipRRect(
                              borderRadius: BorderRadius.circular(8),
                              child: CachedNetworkImage(
                                imageUrl: messageData['imageUrl'],
                                width: 200,
                                fit: BoxFit.cover,
                              ),
                            )
                          else
                            Text(text, style: TextStyle(color: isMe ? Colors.white : AppColors.textHigh, fontSize: 14)),
                          SizedBox(height: 2),
                          Text(
                            messageTime != null ? DateFormat.Hm().format(messageTime) : '',
                            style: TextStyle(fontSize: 9, color: isMe ? Colors.white.withOpacity(0.7) : AppColors.textDisabled),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildArchivedDiscussionView() {
    return StreamBuilder<DocumentSnapshot>(
      stream: _discussionDocRef.snapshots(),
      builder: (context, snapshot) {
        if (!snapshot.hasData) return Center(child: CircularProgressIndicator(color: AppColors.primaryLavender));
        
        final discussionData = snapshot.data!.data() as Map<String, dynamic>?;
        if (discussionData == null) return Container();
        
        final double averageRating = _getAverageRating(discussionData);
        final bool hasRated = discussionData['ratings']?[_currentUserId] != null;
        
        return SingleChildScrollView(
          padding: EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              if (discussionData['imageUrl'] != null)
                ClipRRect(
                  borderRadius: BorderRadius.circular(12),
                  child: CachedNetworkImage(
                    imageUrl: discussionData['imageUrl'],
                    width: double.infinity,
                    height: 200,
                    fit: BoxFit.cover,
                  ),
                ),
              SizedBox(height: 16),
              Text(
                discussionData['name'] ?? '',
                style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: AppColors.textHigh),
              ),
              SizedBox(height: 8),
              Text(
                discussionData['description'] ?? '',
                style: TextStyle(fontSize: 16, color: AppColors.textMedium),
              ),
              SizedBox(height: 16),
              Text(
                'This discussion has ended and is now archived.',
                style: TextStyle(fontSize: 14, color: AppColors.accentMustard, fontStyle: FontStyle.italic),
              ),
              SizedBox(height: 16),
              if (averageRating > 0)
                Row(
                  children: [
                    Icon(Feather.star, color: Colors.amber, size: 20),
                    SizedBox(width: 4),
                    Text(
                      averageRating.toStringAsFixed(1),
                      style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: AppColors.textHigh),
                    ),
                    SizedBox(width: 8),
                    Text(
                      '(${discussionData['ratings']?.length ?? 0} ratings)',
                      style: TextStyle(fontSize: 14, color: AppColors.textDisabled),
                    ),
                  ],
                ),
              SizedBox(height: 16),
              if (!hasRated)
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('Rate this discussion:', style: TextStyle(color: AppColors.textHigh)),
                    SizedBox(height: 8),
                    Slider(
                      value: 5.0,
                      min: 1.0,
                      max: 10.0,
                      divisions: 9,
                      activeColor: AppColors.primaryLavender,
                      inactiveColor: AppColors.elevation,
                      onChanged: (value) {},
                      onChangeEnd: _rateDiscussion,
                    ),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Text('1', style: TextStyle(fontSize: 12, color: AppColors.textMedium)),
                        Text('5', style: TextStyle(fontSize: 12, color: AppColors.textMedium)),
                        Text('10', style: TextStyle(fontSize: 12, color: AppColors.textMedium)),
                      ],
                    ),
                  ],
                ),
              SizedBox(height: 32),
              Text(
                'Discussion History',
                style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: AppColors.textHigh),
              ),
              SizedBox(height: 16),
              Text(
                'Message history would be displayed here in a read-only format.',
                style: TextStyle(fontStyle: FontStyle.italic, color: AppColors.textDisabled),
              ),
            ],
          ),
        );
      },
    );
  }

  double _getAverageRating(Map<String, dynamic> discussionData) {
    final Map<String, dynamic>? ratings = discussionData['ratings'];
    if (ratings == null || ratings.isEmpty) return 0.0;
    
    final double total = ratings.values.map((rating) => rating.toDouble()).reduce((a, b) => a + b);
    return total / ratings.length;
  }
}

class DiscussionChatScreen extends StatefulWidget {
  final String discussionId;
  const DiscussionChatScreen({Key? key, required this.discussionId}) : super(key: key);

  @override
  _DiscussionChatScreenState createState() => _DiscussionChatScreenState();
}

class _DiscussionChatScreenState extends State<DiscussionChatScreen> {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final TextEditingController _messageController = TextEditingController();
  final ScrollController _scrollController = ScrollController();
  late String _currentUserId;
  late DocumentReference _discussionDocRef;
  bool _isMember = false;
  bool _isArchived = false;
  File? _imageToSend;
  File? _videoToSend;

  // Message reaction variables
  Map<String, String> _userReactions = {}; // messageId -> emoji

  @override
  void initState() {
    super.initState();
    _currentUserId = _auth.currentUser!.uid;
    _discussionDocRef = _firestore.collection('discussions').doc(widget.discussionId);
    _checkMembership();
    _checkIfArchived();
    _markMessagesAsRead();
  }

  Future<void> _checkMembership() async {
    final discussionDoc = await _discussionDocRef.get();
    if (discussionDoc.exists) {
      final discussionData = discussionDoc.data() as Map<String, dynamic>;
      final List<dynamic> members = discussionData['members'] ?? [];
      setState(() {
        _isMember = members.contains(_currentUserId);
      });
    }
  }

  Future<void> _checkIfArchived() async {
    final discussionDoc = await _discussionDocRef.get();
    if (discussionDoc.exists) {
      final discussionData = discussionDoc.data() as Map<String, dynamic>;
      final Timestamp? expiresAt = discussionData['expiresAt'];
      if (expiresAt != null) {
        final DateTime expirationDate = expiresAt.toDate();
        setState(() {
          _isArchived = DateTime.now().isAfter(expirationDate);
        });
      }
    }
  }

  Future<void> _markMessagesAsRead() async {
    try {
      final discussionDoc = await _discussionDocRef.get();
      if (!discussionDoc.exists) return;
      final discussionData = discussionDoc.data() as Map<String, dynamic>?;
      if (discussionData == null) return;
      final Map<String, dynamic> unreadCountMap = discussionData['unreadCount'] ?? {};
      final int currentUnread = unreadCountMap[_currentUserId] ?? 0;
      if (currentUnread > 0) {
        await _discussionDocRef.update({
          'unreadCount.$_currentUserId': 0,
        });
      }
    } catch (e) {
      print("Error marking messages as read: $e");
    }
  }

  Future<void> _pickImage() async {
    if (!_isMember || _isArchived) return;
    try {
      final pickedFile = await ImagePicker().pickImage(source: ImageSource.gallery);
      if (pickedFile != null) {
        _cropAndEditImage(File(pickedFile.path));
      }
    } catch (e) {
      print("Error picking image: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to pick image. Please try again.')),
      );
    }
  }

  Future<void> _pickVideo() async {
    if (!_isMember || _isArchived) return;
    try {
      final pickedFile = await ImagePicker().pickVideo(source: ImageSource.gallery);
      if (pickedFile != null) {
        _sendMessage(videoFile: File(pickedFile.path));
      }
    } catch (e) {
      print("Error picking video: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to pick video. Please try again.')),
      );
    }
  }

  Future<void> _cropAndEditImage(File imageFile) async {
    try {
      final CroppedFile? croppedFile = await ImageCropper().cropImage(
        sourcePath: imageFile.path,
        uiSettings: [
          AndroidUiSettings(
            toolbarTitle: 'Edit Image',
            toolbarColor: AppColors.backgroundDeep,
            toolbarWidgetColor: AppColors.textHigh,
            initAspectRatio: CropAspectRatioPreset.original,
            lockAspectRatio: false,
          ),
          IOSUiSettings(
            title: 'Edit Image',
          ),
        ],
      );
      if (croppedFile != null) {
        // Assume ImagePreviewScreen exists or is handled elsewhere
        // For refactoring, we'll just send directly to keep it simple, 
        // or you would navigate to your preview screen here.
        _sendMessage(imageFile: File(croppedFile.path));
      }
    } catch (e) {
      print("Error cropping image: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to edit image. Please try again.')),
      );
    }
  }

  Future<void> _sendMessage({File? imageFile, File? videoFile, String? text}) async {
    if (!_isMember || _isArchived) return;
    final messageText = text ?? _messageController.text.trim();
    if (messageText.isEmpty && imageFile == null && videoFile == null) return;
    
    try {
      String? mediaUrl;
      String mediaType = 'text';
      
      if (imageFile != null) {
        final ref = FirebaseStorage.instance
            .ref()
            .child('discussion_chats')
            .child(widget.discussionId)
            .child('images')
            .child('${Uuid().v4()}.jpg');
        await ref.putFile(imageFile);
        mediaUrl = await ref.getDownloadURL();
        mediaType = 'image';
      } else if (videoFile != null) {
        final ref = FirebaseStorage.instance
            .ref()
            .child('discussion_chats')
            .child(widget.discussionId)
            .child('videos')
            .child('${Uuid().v4()}.mp4');
        await ref.putFile(videoFile);
        mediaUrl = await ref.getDownloadURL();
        mediaType = 'video';
      }

      final messageId = Uuid().v4();
      final timestamp = FieldValue.serverTimestamp();
      
      final messageData = {
        'id': messageId,
        'discussionId': widget.discussionId,
        'senderId': _currentUserId,
        'text': messageText,
        'mediaUrl': mediaUrl,
        'type': mediaType,
        'timestamp': timestamp,
        'reactions': {},
        'status': 'sent',
      };

      await _discussionDocRef.collection('messages').doc(messageId).set(messageData);
      
      final discussionUpdateData = {
        'lastMessage': mediaType == 'image' ? ' Image' : mediaType == 'video' ? ' Video' : messageText,
        'lastMessageTime': timestamp,
        'lastMessageSender': _currentUserId,
      };

      await _discussionDocRef.update(discussionUpdateData);
      
      // Update unread counts for other members
      final discussionDoc = await _discussionDocRef.get();
      if (discussionDoc.exists) {
        final discussionData = discussionDoc.data() as Map<String, dynamic>;
        final List<dynamic> members = discussionData['members'] ?? [];
        final Map<String, dynamic> unreadCountMap = discussionData['unreadCount'] ?? {};
        
        for (var memberId in members) {
          if (memberId != _currentUserId) {
            final currentCount = unreadCountMap[memberId] ?? 0;
            unreadCountMap[memberId] = currentCount + 1;
          }
        }
        await _discussionDocRef.update({'unreadCount': unreadCountMap});
      }

      _messageController.clear();
      _scrollToBottom();
    } catch (e) {
      print("Error sending message: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to send message. Please try again.')),
      );
    }
  }

  Future<void> _reactToMessage(String messageId, String emoji) async {
    try {
      final messageRef = _discussionDocRef.collection('messages').doc(messageId);
      final messageDoc = await messageRef.get();
      
      if (messageDoc.exists) {
        final messageData = messageDoc.data() as Map<String, dynamic>;
        final Map<String, dynamic> reactions = Map<String, dynamic>.from(messageData['reactions'] ?? {});
        
        // Remove user's previous reaction if any
        reactions.removeWhere((key, value) => value['userId'] == _currentUserId);
        
        // Add new reaction
        reactions[Uuid().v4()] = {
          'userId': _currentUserId,
          'emoji': emoji,
          'timestamp': FieldValue.serverTimestamp(),
        };
        
        await messageRef.update({'reactions': reactions});
      }
    } catch (e) {
      print("Error reacting to message: $e");
    }
  }

  void _scrollToBottom() {
    if (_scrollController.hasClients) {
      _scrollController.animateTo(
        _scrollController.position.maxScrollExtent,
        duration: Duration(milliseconds: 300),
        curve: Curves.easeOut,
      );
    }
  }

  void _showReactionMenu(String messageId) {
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (context) {
        final List<String> emojis = ['', '', '', '', '', ''];
        return Container(
          decoration: BoxDecoration(
            color: AppColors.surface,
            borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
          ),
          padding: EdgeInsets.all(16),
          child: Wrap(
            spacing: 16,
            children: emojis.map((emoji) {
              return GestureDetector(
                onTap: () {
                  Navigator.pop(context);
                  _reactToMessage(messageId, emoji);
                },
                child: Text(emoji, style: TextStyle(fontSize: 24)),
              );
            }).toList(),
          ),
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      body: Column(
        children: [
          // Discussion info header
          StreamBuilder<DocumentSnapshot>(
            stream: _discussionDocRef.snapshots(),
            builder: (context, snapshot) {
              if (!snapshot.hasData) return Container();
              final discussionData = snapshot.data!.data() as Map<String, dynamic>?;
              final String discussionName = discussionData?['name'] ?? 'Discussion';
              final String discussionImage = discussionData?['imageUrl'] ?? '';
              final int memberCount = discussionData?['memberCount'] ?? 0;
              final int? daysLeft = discussionData != null ? getDaysLeft(discussionData) : null;
              final bool isArchived = discussionData != null ? isDiscussionArchived(discussionData) : false;

              final Map<String, dynamic> ratings = discussionData?['ratings'] ?? {};
              double averageRating = 0;
              if (ratings.isNotEmpty) {
                averageRating = ratings.values.map((v) => (v as num).toDouble()).reduce((a, b) => a + b) / ratings.length;
              }
              final int ratingCount = ratings.length;

              return Container(
                padding: EdgeInsets.all(16),
                color: AppColors.surface,
                child: Row(
                  children: [
                    CircleAvatar(
                      radius: 20,
                      backgroundColor: AppColors.elevation,
                      backgroundImage: discussionImage.isNotEmpty
                          ? CachedNetworkImageProvider(discussionImage)
                          : AssetImage('assets/default_avatar.png') as ImageProvider,
                    ),
                    SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            discussionName,
                            style: TextStyle(
                              fontWeight: FontWeight.bold,
                              fontSize: 16,
                              color: AppColors.textHigh,
                            ),
                          ),
                          Row(
                            children: [
                              Text(
                                isArchived 
                                  ? 'Archived' 
                                  : daysLeft != null 
                                    ? '$daysLeft days left' 
                                    : '$memberCount members',
                                style: TextStyle(
                                  color: isArchived ? AppColors.textDisabled : AppColors.secondaryTeal,
                                  fontSize: 14,
                                ),
                              ),
                              if (averageRating > 0) ...[
                                SizedBox(width: 8),
                                Icon(Icons.star_rounded, size: 14, color: AppColors.accentMustard),
                                SizedBox(width: 4),
                                Text(
                                  averageRating.toStringAsFixed(1),
                                  style: TextStyle(fontSize: 12, fontWeight: FontWeight.bold, color: AppColors.textHigh),
                                ),
                                SizedBox(width: 4),
                                Text(
                                  "($ratingCount)",
                                  style: TextStyle(fontSize: 11, color: AppColors.textDisabled),
                                ),
                              ],
                            ],
                          ),
                        ],
                      ),
                    ),
                    Spacer(),
                    if (_isMember && !_isArchived)
                      PopupMenuButton<String>(
                        icon: Icon(Feather.more_vertical, color: AppColors.primaryLavender),
                        onSelected: (value) async {
                          if (value == 'rate') {
                            final double? rating = await showDialog<double>(
                              context: context,
                              builder: (context) => _RatingDialog(),
                            );
                            if (rating != null) {
                              _rateDiscussion(rating);
                            }
                          } else if (value == 'leave') {
                            // Implement leave logic if needed
                          }
                        },
                        itemBuilder: (context) => [
                          PopupMenuItem(
                            value: 'rate',
                            child: ListTile(
                              leading: Icon(Feather.star, color: AppColors.primaryLavender),
                              title: Text('Rate Discussion', style: TextStyle(color: AppColors.textHigh)),
                              contentPadding: EdgeInsets.zero,
                            ),
                          ),
                          PopupMenuItem(
                            value: 'leave',
                            child: ListTile(
                              leading: Icon(Feather.log_out, color: AppColors.error),
                              title: Text('Leave Discussion', style: TextStyle(color: AppColors.error)),
                              contentPadding: EdgeInsets.zero,
                            ),
                          ),
                        ],
                      ),
                  ],
                ),
              );
            },
          ),
          // Messages list
          Expanded(
            child: StreamBuilder<QuerySnapshot>(
              stream: _discussionDocRef
                  .collection('messages')
                  .orderBy('timestamp', descending: false)
                  .snapshots(),
              builder: (context, snapshot) {
                if (!snapshot.hasData) {
                  return Center(child: CircularProgressIndicator(color: AppColors.primaryLavender));
                }
                final messages = snapshot.data!.docs;
                
                return ListView.builder(
                  controller: _scrollController,
                  padding: EdgeInsets.all(8),
                  itemCount: messages.length,
                  itemBuilder: (context, index) {
                    final message = messages[index];
                    final messageData = message.data() as Map<String, dynamic>;
                    final String messageId = message.id;
                    final String senderId = messageData['senderId'];
                    final String text = messageData['text'] ?? '';
                    final String type = messageData['type'] ?? 'text';
                    final String? mediaUrl = messageData['mediaUrl'];
                    final Timestamp? timestamp = messageData['timestamp'];
                    final Map<String, dynamic> reactions = messageData['reactions'] ?? {};
                    final bool isMe = senderId == _currentUserId;
                    final DateTime? messageTime = timestamp?.toDate();
                    
                    return GestureDetector(
                      onLongPress: _isArchived ? () => _showReactionMenu(messageId) : null,
                      child: Container(
                        margin: EdgeInsets.symmetric(vertical: 4),
                        child: Row(
                          mainAxisAlignment: isMe ? MainAxisAlignment.end : MainAxisAlignment.start,
                          children: [
                            if (!isMe)
                              CircleAvatar(
                                radius: 16,
                                backgroundColor: AppColors.elevation,
                                child: Icon(Feather.user, size: 16, color: AppColors.textMedium),
                              ),
                            SizedBox(width: 8),
                            Flexible(
                              child: Column(
                                crossAxisAlignment: isMe ? CrossAxisAlignment.end : CrossAxisAlignment.start,
                                children: [
                                  Container(
                                    padding: EdgeInsets.all(12),
                                    constraints: BoxConstraints(
                                      maxWidth: MediaQuery.of(context).size.width * 0.7,
                                    ),
                                    decoration: BoxDecoration(
                                      // Me = Teal (White Text), Other = Elevation (Off-White Text)
                                      color: isMe ? AppColors.secondaryTeal : AppColors.elevation,
                                      borderRadius: BorderRadius.circular(16),
                                      boxShadow: [
                                        BoxShadow(
                                          color: Colors.black.withOpacity(0.1),
                                          blurRadius: 2,
                                          offset: Offset(0, 1),
                                        ),
                                      ],
                                    ),
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        if (type == 'image' && mediaUrl != null)
                                          _buildImageMessage(mediaUrl, text),
                                        if (type == 'video' && mediaUrl != null)
                                          _buildVideoMessage(mediaUrl, text),
                                        if (type == 'text' && text.isNotEmpty)
                                          Text(
                                            text,
                                            style: TextStyle(
                                              // Teal bubble needs white, Elevation bubble needs textHigh
                                              color: isMe ? Colors.white : AppColors.textHigh
                                            ),
                                          ),
                                        SizedBox(height: 4),
                                        if (messageTime != null)
                                          Text(
                                            DateFormat.Hm().format(messageTime),
                                            style: TextStyle(
                                              fontSize: 10,
                                              color: isMe ? Colors.white70 : AppColors.textDisabled,
                                            ),
                                          ),
                                      ],
                                    ),
                                  ),
                                  // Reactions
                                  if (reactions.isNotEmpty)
                                    Container(
                                      margin: EdgeInsets.only(top: 4),
                                      padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                                      decoration: BoxDecoration(
                                        color: AppColors.surface,
                                        borderRadius: BorderRadius.circular(12),
                                        border: Border.all(color: AppColors.elevation),
                                      ),
                                      child: Wrap(
                                        spacing: 4,
                                        children: _buildReactionWidgets(reactions),
                                      ),
                                    ),
                                ],
                              ),
                            ),
                            if (isMe) SizedBox(width: 8),
                          ],
                        ),
                      ),
                    );
                  },
                );
              },
            ),
          ),
          // Message input area (only show if not archived)
          if (_isMember && !_isArchived)
            Container(
              padding: EdgeInsets.all(8),
              color: AppColors.surface,
              child: Row(
                children: [
                  IconButton(
                    icon: Icon(Feather.image, color: AppColors.primaryLavender),
                    onPressed: _pickImage,
                  ),
                  IconButton(
                    icon: Icon(Feather.video, color: AppColors.primaryLavender),
                    onPressed: _pickVideo,
                  ),
                  Expanded(
                    child: TextField(
                      controller: _messageController,
                      style: TextStyle(color: AppColors.textHigh),
                      decoration: InputDecoration(
                        hintText: 'Type a message...',
                        hintStyle: TextStyle(color: AppColors.textDisabled),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(20),
                          borderSide: BorderSide.none,
                        ),
                        filled: true,
                        fillColor: AppColors.elevation,
                        contentPadding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                      ),
                      maxLines: null,
                      textInputAction: TextInputAction.send,
                      onSubmitted: (value) => _sendMessage(),
                    ),
                  ),
                  IconButton(
                    icon: Icon(Feather.send, color: AppColors.primaryLavender),
                    onPressed: () => _sendMessage(),
                  ),
                ],
              ),
            ),
        ],
      ),
    );
  }

  List<Widget> _buildReactionWidgets(Map<String, dynamic> reactions) {
    // Group reactions by emoji
    final Map<String, int> emojiCounts = {};
    final Map<String, String> userEmojis = {};
    
    reactions.forEach((key, value) {
      final String emoji = value['emoji'];
      final String userId = value['userId'];
      
      emojiCounts[emoji] = (emojiCounts[emoji] ?? 0) + 1;
      if (userId == _currentUserId) {
        userEmojis[userId] = emoji;
      }
    });
    
    return emojiCounts.entries.map((entry) {
      final String emoji = entry.key;
      final int count = entry.value;
      final bool isMyReaction = userEmojis.containsValue(emoji);
      
      return Container(
        padding: EdgeInsets.symmetric(horizontal: 4, vertical: 2),
        decoration: BoxDecoration(
          color: isMyReaction ? AppColors.primaryLavender.withOpacity(0.2) : Colors.transparent,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(
            color: isMyReaction ? AppColors.primaryLavender : AppColors.textDisabled,
          ),
        ),
        child: Text(
          '$emoji $count',
          style: TextStyle(fontSize: 12, color: AppColors.textMedium),
        ),
      );
    }).toList();
  }

  Widget _buildImageMessage(String imageUrl, String caption) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        GestureDetector(
          onTap: () {
            // Navigator.push(...) to ImageViewer
          },
          child: ClipRRect(
            borderRadius: BorderRadius.circular(8),
            child: CachedNetworkImage(
              imageUrl: imageUrl,
              width: 200,
              height: 200,
              fit: BoxFit.cover,
              placeholder: (context, url) => Container(
                width: 200,
                height: 200,
                color: AppColors.elevation,
                child: Center(child: CircularProgressIndicator(color: AppColors.primaryLavender)),
              ),
              errorWidget: (context, url, error) => Container(
                width: 200,
                height: 200,
                color: AppColors.elevation,
                child: Icon(Feather.alert_circle, color: AppColors.error),
              ),
            ),
          ),
        ),
        if (caption.isNotEmpty)
          Padding(
            padding: EdgeInsets.only(top: 8),
            child: Text(
              caption,
              style: TextStyle(color: Colors.white),
            ),
          ),
      ],
    );
  }

  Widget _buildVideoMessage(String videoUrl, String caption) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        GestureDetector(
          onTap: () {
            // Implement video player
          },
          child: Container(
            width: 200,
            height: 200,
            decoration: BoxDecoration(
              color: Colors.black, // Videos look best on black
              borderRadius: BorderRadius.circular(8),
            ),
            child: Stack(
              children: [
                Center(
                  child: Icon(Feather.play_circle, size: 50, color: Colors.white),
                ),
                Positioned(
                  bottom: 8,
                  right: 8,
                  child: Text(
                    'Video',
                    style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
        if (caption.isNotEmpty)
          Padding(
            padding: EdgeInsets.only(top: 8),
            child: Text(
              caption,
              style: TextStyle(color: Colors.white),
            ),
          ),
      ],
    );
  }

  Future<void> _rateDiscussion(double rating) async {
    try {
      await _discussionDocRef.update({
        'ratings.$_currentUserId': rating,
      });

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Rating submitted successfully', style: TextStyle(color: AppColors.backgroundDeep)),
          backgroundColor: AppColors.success,
        ),
      );
    } catch (e) {
      print("Error rating discussion: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to submit rating. Please try again.')),
      );
    }
  }
}

class _RatingDialog extends StatefulWidget {
  @override
  __RatingDialogState createState() => __RatingDialogState();
}

class __RatingDialogState extends State<_RatingDialog> {
  double _currentRating = 5.0;

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      backgroundColor: AppColors.surface,
      title: Text('Rate Discussion', style: TextStyle(color: AppColors.textHigh)),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(Feather.star, color: Colors.amber, size: 24),
              SizedBox(width: 8),
              Text(
                _currentRating.round().toString(),
                style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: AppColors.textHigh),
              ),
            ],
          ),
          Slider(
            value: _currentRating,
            min: 1.0,
            max: 10.0,
            divisions: 9,
            activeColor: AppColors.primaryLavender,
            inactiveColor: AppColors.elevation,
            onChanged: (value) {
              setState(() {
                _currentRating = value;
              });
            },
          ),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text('1', style: TextStyle(fontSize: 12, color: AppColors.textDisabled)),
              Text('10', style: TextStyle(fontSize: 12, color: AppColors.textDisabled)),
            ],
          ),
        ],
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: Text('Cancel', style: TextStyle(color: AppColors.textMedium)),
        ),
        TextButton(
          onPressed: () => Navigator.pop(context, _currentRating),
          child: Text('Submit', style: TextStyle(color: AppColors.primaryLavender, fontWeight: FontWeight.bold)),
        ),
      ],
    );
  }
}

// Helper function to check if discussion is archived
bool isDiscussionArchived(Map<String, dynamic> discussionData) {
  final Timestamp? expiresAt = discussionData['expiresAt'];
  if (expiresAt == null) return false;
  
  final DateTime expirationDate = expiresAt.toDate();
  return DateTime.now().isAfter(expirationDate);
}

// Helper function to get days left
int? getDaysLeft(Map<String, dynamic> discussionData) {
  final Timestamp? expiresAt = discussionData['expiresAt'];
  if (expiresAt == null) return null;
  
  final DateTime expirationDate = expiresAt.toDate();
  final DateTime now = DateTime.now();
  
  if (now.isAfter(expirationDate)) return null;
  
  return expirationDate.difference(now).inDays;
}


--- C:\Code\femn\lib\circle\groups.dart ---

import 'dart:async';
import 'dart:io';
import 'dart:math';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:femn/auth/auth.dart';
import 'package:femn/circle/discussions.dart';
import 'package:femn/customization/colors.dart'; // Import the new color scheme
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/rendering.dart';
import 'package:flutter/services.dart'; // For SystemUiOverlayStyle
import 'package:flutter/widgets.dart';
import 'package:flutter_staggered_grid_view/flutter_staggered_grid_view.dart';
import 'package:femn/customization/layout.dart';
import 'package:image_picker/image_picker.dart';
import 'package:image_cropper/image_cropper.dart';
import 'package:intl/intl.dart';
import 'package:uuid/uuid.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:path_provider/path_provider.dart';
import '../feed/addpost.dart';
import 'package:femn/hub_screens/profile.dart';
import 'package:femn/hub_screens/search.dart';
import 'package:file_picker/file_picker.dart';
import 'dart:math';
import 'petitions.dart';
import 'polls.dart'; 
import 'package:collection/collection.dart'; // For comparing lists (though not directly used in current code)
import 'package:firebase_storage/firebase_storage.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:shimmer/shimmer.dart';

// Remove old color constants and use AppColors instead
const Map<String, IconData> _optionIcons = {
  'Polls': Feather.bar_chart_2,
  'Discussions': Feather.message_square,
  'Groups': Feather.users,
  'Mentorship': Feather.book_open,
  'Petitions': Feather.check_square,
};

// Import necessary packages if not already imported elsewhere in your file
// import 'package:cloud_firestore/cloud_firestore.dart';
// import 'package:firebase_auth/firebase_auth.dart';

class UserProfileCache {
  // Private static cache map to store user data
  static final Map<String, Map<String, dynamic>> _cache = {};

  // Private constructor to prevent instantiation
  UserProfileCache._();

  /// Fetches user profile data, prioritizing cache, then Firestore.
  /// Ensures a consistent data structure is returned.
  static Future<Map<String, dynamic>> getUserProfile(String userId) async {
    debugPrint("UserProfileCache.getUserProfile: Requesting profile for user ID: '$userId'");

    // 1. Check if data is already in the cache
    if (_cache.containsKey(userId)) {
      final cachedData = _cache[userId]!;
      debugPrint("UserProfileCache.getUserProfile: Found in cache. Data: $cachedData");
      return cachedData;
    }

    // 2. If not in cache, fetch from Firestore
    try {
      final docSnapshot =
          await FirebaseFirestore.instance.collection('users').doc(userId).get();

      Map<String, dynamic> userData;
      if (docSnapshot.exists) {
        final data = docSnapshot.data()!;
        userData = {
          'uid': userId,
          'name': data['name'] ?? data['username'] ?? 'User',
          'profileImage': data['profileImage'] ?? data['photoUrl'] ?? '',
        };
        debugPrint("UserProfileCache: fetched & processed data for $userId: $userData");
      } else {
        userData = {
          'uid': userId,
          'name': 'User',
          'profileImage': '',
        };
        debugPrint("UserProfileCache: $userId doc missing, using default.");
      }

      // Cache and return
      _cache[userId] = userData;
      return userData;
    } catch (e) {
      debugPrint("UserProfileCache: Error fetching $userId -> $e");
      final fallback = {
        'uid': userId,
        'name': 'User',
        'profileImage': '',
      };
      _cache[userId] = fallback;
      return fallback;
    }
  }

  /// Preloads profiles for a list of user IDs, fetching only those not already cached.
  static Future<void> preloadUserProfiles(List<String> userIds) async {
    final idsToFetch = userIds.toSet().where((id) => !_cache.containsKey(id)).toList();
    if (idsToFetch.isEmpty) {
      debugPrint("UserProfileCache: nothing new to preload.");
      return;
    }

    try {
      final futures = idsToFetch
          .map((id) => FirebaseFirestore.instance.collection('users').doc(id).get())
          .toList();
      final snapshots = await Future.wait(futures);

      for (int i = 0; i < idsToFetch.length; i++) {
        final userId = idsToFetch[i];
        final docSnapshot = snapshots[i];

        Map<String, dynamic> userData;
        if (docSnapshot.exists) {
          final data = docSnapshot.data()!;
          userData = {
            'uid': userId,
            'name': data['name'] ?? data['username'] ?? 'User',
            'profileImage': data['profileImage'] ?? data['photoUrl'] ?? '',
          };
        } else {
          userData = {
            'uid': userId,
            'name': 'User',
            'profileImage': '',
          };
        }

        _cache[userId] = userData;
        debugPrint("UserProfileCache: preloaded $userId -> $userData");
      }
    } catch (e) {
      debugPrint("UserProfileCache: preload error -> $e");
    }
  }

  /// Clears the cache
  static void clearCache() {
    _cache.clear();
    debugPrint("UserProfileCache: cache cleared.");
  }

  /// Returns cached profile immediately (null if not cached yet).
  static Map<String, dynamic>? getCachedProfile(String userId) {
    return _cache[userId];
  }
}

class GroupsScreen extends StatefulWidget {
  @override
  _GroupsScreenState createState() => _GroupsScreenState();
}

class _GroupsScreenState extends State<GroupsScreen> {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final TextEditingController _groupNameController = TextEditingController();
  final TextEditingController _groupDescriptionController = TextEditingController();
  final TextEditingController _searchController = TextEditingController();
  bool _isPrivate = false;
  File? _groupImage;
  late String _currentUserId;
  String _selectedCategory = 'All';
  final List<String> _contentTypes = ['All', 'Groups', 'Polls', 'Discussions', 'Archived', 'Petitions'];
  int _selectedContentTypeIndex = 0; // 0 corresponds to 'Groups'
  String _searchQuery = '';

  String _selectedAgeRating = '13-17'; // Default age rating
  final List<String> _ageRatings = ['13-17', '18-25', '26+'];
  List<String> _hashtags = []; // Store hashtags
  final TextEditingController _hashtagController = TextEditingController();

  String get _currentContentType {
    return _contentTypes[_selectedContentTypeIndex];
  }

  final List<String> _categories = [
    'All',
    'Polls',
    'Discussions',
    'Groups',
    'Mentorship',
    'Petitions'
  ];
  final Map<String, String> _categoryIcons = {
    'Polls': '',
    'Discussions': '',
    'Groups': '',
    'Mentorship': '',
    'Petitions': '',
  };

  @override
  void initState() {
    super.initState();
    _currentUserId = _auth.currentUser!.uid;
  }

  Future<void> _pickGroupImage() async {
    final pickedFile =
        await ImagePicker().pickImage(source: ImageSource.gallery);
    if (pickedFile != null) {
      setState(() {
        _groupImage = File(pickedFile.path);
      });
    }
  }

  Future<String?> _uploadGroupImage() async {
    if (_groupImage == null) return null;
    try {
      final ref = FirebaseStorage.instance
          .ref()
          .child('group_images')
          .child('${Uuid().v4()}.jpg');
      await ref.putFile(_groupImage!);
      return await ref.getDownloadURL();
    } catch (e) {
      print("Error uploading group image: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to upload image. Please try again.')),
      );
      return null;
    }
  }

  // Add this method to your _GroupsScreenState class
  void showPetitionDetails(BuildContext context, Petition petition, bool isSigned) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => EnhancedPetitionDetailScreen(petitionId: petition.id),
      ),
    );
  }

  // Add this method to your _GroupsScreenState class
  void showCreatePetitionModal(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => EnhancedPetitionCreationScreen(),
      ),
    );
  }

  // Add these methods to your _GroupsScreenState class

// Method to check if a discussion is archived
bool _isDiscussionArchived(Map<String, dynamic> discussionData) {
  final Timestamp? expiresAt = discussionData['expiresAt'];
  if (expiresAt == null) return false;
  
  final DateTime expirationDate = expiresAt.toDate();
  return DateTime.now().isAfter(expirationDate);
}

// Method to get days left for a discussion
int? _getDaysLeft(Map<String, dynamic> discussionData) {
  final Timestamp? expiresAt = discussionData['expiresAt'];
  if (expiresAt == null) return null;
  
  final DateTime expirationDate = expiresAt.toDate();
  final DateTime now = DateTime.now();
  
  if (now.isAfter(expirationDate)) return null;
  
  return expirationDate.difference(now).inDays;
}

// Method to get average rating for archived discussion
double _getAverageRating(Map<String, dynamic> discussionData) {
  final Map<String, dynamic>? ratings = discussionData['ratings'];
  if (ratings == null || ratings.isEmpty) return 0.0;
  
  final double total = ratings.values.map((rating) => rating.toDouble()).reduce((a, b) => a + b);
  return total / ratings.length;
}

  Future<void> _createGroup() async {
    if (_groupNameController.text.trim().isEmpty ||
        _groupDescriptionController.text.trim().isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Title and Description are required.')),
      );
      return;
    }
    final groupName = _groupNameController.text.trim();
    final groupDescription = _groupDescriptionController.text.trim();
    final imageUrl = await _uploadGroupImage();

    try {
      final groupId = Uuid().v4();
      final timestamp = FieldValue.serverTimestamp();
      
      // Create base group data
      final groupData = {
        'id': groupId,
        'name': groupName,
        'description': groupDescription,
        'imageUrl': imageUrl ?? '',
        'isPrivate': _isPrivate,
        'createdBy': _currentUserId,
        'createdAt': timestamp,
        'members': [_currentUserId],
        'admins': [_currentUserId],
        'moderators': [],
        'memberCount': 1,
        'lastMessage': '',
        'lastMessageTime': timestamp,
        'lastMessageSender': '',
        'unreadCount': {_currentUserId: 0},
        'category': _selectedCategory != 'All' ? _selectedCategory : 'General',
        'isReadOnly': false,
        'profanityFilter': true,
        'linkRestrictions': false,
        'typing': {},
        'ageRating': _selectedAgeRating,
        'hashtags': _hashtags,
      };

      // Add expiration for discussions
      // Add expiration for discussions
      if (_selectedCategory == 'Discussions') {
        final expiresAt = DateTime.now().add(Duration(days: 7));
        groupData['expiresAt'] = Timestamp.fromDate(expiresAt);
        groupData['isTemporary'] = true;
      }

      await _firestore.collection('groups').doc(groupId).set(groupData);

      // Reset form including new fields
      _groupNameController.clear();
      _groupDescriptionController.clear();
      _hashtagController.clear();
      setState(() {
        _groupImage = null;
        _isPrivate = false;
        _selectedAgeRating = '13-17';
        _selectedCategory = 'All';
        _hashtags.clear();
      });

      // Navigate to the new group chat
      Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) => GroupChatScreen(groupId: groupId),
        ),
      );
    } catch (e) {
      print("Error creating group: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to create group. Please try again.')),
      );
    }
  }

    // --- Add this new method ---
// Modified _buildAllTab method with shuffling

Widget _buildAllTab() {
  // Singular control variables for widths and paddings
  const double externalPadding = 20.0; // Horizontal padding for the entire grid
  const double cardSpacing = 8.0; // Spacing between cards
  const double cardInternalPadding = 12.0; // Padding inside each card
  const double cardMarginVertical = 2.0; // Vertical margin for cards
  const double cardMarginHorizontal = 2.0; // Horizontal margin for cards
  const double borderRadiusValue = 24.0; // Border radius for all cards


  return FutureBuilder<List<QuerySnapshot>>(
    // Fetch snapshots from all relevant collections simultaneously
    future: Future.wait([
      _firestore.collection('groups').where('isPrivate', isEqualTo: false).get(),
      _firestore.collection('polls').get(),
      _firestore.collection('groups')
          .where('category', isEqualTo: 'Discussions')
          .where('isPrivate', isEqualTo: false)
          .get(), // Re-fetch discussions if needed separately or filter later
      _firestore.collection('petitions').get(),
    ]),
    builder: (context, snapshot) {
      if (snapshot.connectionState == ConnectionState.waiting) {
        return const GridShimmerSkeleton();
      }

      if (snapshot.hasError || !snapshot.hasData) {
        return Center(child: Text('Error loading content.', style: TextStyle(color: AppColors.textHigh)));
      }

      final groupsSnapshot = snapshot.data![0];
      final pollsSnapshot = snapshot.data![1];
      // final discussionsSnapshot = snapshot.data![2]; // Optional: if you need discussions separately
      final petitionsSnapshot = snapshot.data![3];

      List<DocumentSnapshot> allItems = [];
      List<String> itemTypes = []; // To track the type of each item

      // Add Groups
      for (var doc in groupsSnapshot.docs) {
        // Filter out discussions if they are included in the general groups collection
        // and you want to handle them distinctly or only via the 'Discussions' tab.
        // You might need logic here based on your data structure.
        // For now, assuming 'category' field distinguishes them.
        final data = doc.data() as Map<String, dynamic>;
        final String category = data['category'] ?? 'General';

        if (category != 'Discussions') {
          // Filter out groups user is already a member of if desired for "Discover" in All
          final List<dynamic> members = data['members'] ?? [];
          if (!members.contains(_currentUserId)) {
            allItems.add(doc);
            itemTypes.add('group');
          }
        }
      }

      // Add Discussions (ensure they are fetched correctly, e.g., by category)
      // Assuming discussions are also stored in 'groups' collection with category 'Discussions'
      for (var doc in groupsSnapshot.docs) {
        // Or use discussionsSnapshot.docs if separate and preferred
        final data = doc.data() as Map<String, dynamic>;
        final String category = data['category'] ?? 'General';

        if (category == 'Discussions') {
          // Filter out discussions user is already a member of if desired
          final List<dynamic> members = data['members'] ?? [];
          if (!members.contains(_currentUserId)) {
            allItems.add(doc);
            itemTypes.add('discussion'); // Treat discussions as a specific type
          }
        }
      }

      // Add Polls
      for (var doc in pollsSnapshot.docs) {
        allItems.add(doc);
        itemTypes.add('poll');
      }

      // Add Petitions
      for (var doc in petitionsSnapshot.docs) {
        allItems.add(doc);
        itemTypes.add('petition');
      }

      // Check if combined list is empty
      if (allItems.isEmpty) {
        return Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(Feather.compass, size: 50, color: AppColors.textDisabled),
              SizedBox(height: 16),
              Text(
                'Nothing here yet',
                textAlign: TextAlign.center,
                style: TextStyle(fontSize: 16, color: AppColors.textHigh),
              ),
              SizedBox(height: 8),
              Text(
                'Explore or create content!',
                textAlign: TextAlign.center,
                style: TextStyle(color: AppColors.textDisabled),
              ),
            ],
          ),
        );
      }

      // --- Shuffle the combined list here ---
      // Combine items and types, shuffle the combined list, then separate
      List<Map<String, dynamic>> combinedList = [];
      for (int i = 0; i < allItems.length; i++) {
        combinedList.add({
          'item': allItems[i],
          'type': itemTypes[i],
        });
      }

      // Shuffle the combined list to randomize the order
      combinedList.shuffle();

      // Separate the shuffled list back into items and types
      List<DocumentSnapshot> shuffledItems = combinedList.map((map) => map['item'] as DocumentSnapshot).toList();
      List<String> shuffledItemTypes = combinedList.map((map) => map['type'] as String).toList();
      // --- End of shuffling logic ---

      return Padding(
        padding: const EdgeInsets.symmetric(horizontal: externalPadding),
        child: MasonryGridView.count(
          crossAxisCount: ResponsiveLayout.getColumnCount(context),
          mainAxisSpacing: cardSpacing,
          crossAxisSpacing: cardSpacing,
          itemCount: shuffledItems.length, // Use shuffled list length
          itemBuilder: (context, index) {
            // Use shuffled lists for item and type
            final DocumentSnapshot item = shuffledItems[index];
            final String itemType = shuffledItemTypes[index];
            final itemData = item.data() as Map<String, dynamic>;

            // - Render different item types -
            if (itemType == 'group') {
              final String groupId = item.id;
              final String groupName = itemData['name'] ?? 'Untitled';
              final String groupImage = itemData['imageUrl'] ?? '';
              final int memberCount = itemData['memberCount'] ?? 0;
              final String groupDescription = itemData['description'] ?? '';
              final Map<String, dynamic> ratings = itemData['ratings'] ?? {};
              double averageRating = 0;
              if (ratings.isNotEmpty) {
                averageRating = ratings.values.map((v) => (v as num).toDouble()).reduce((a, b) => a + b) / ratings.length;
              }
              final int ratingCount = ratings.length;

              return Card(
                margin: const EdgeInsets.symmetric(
                  vertical: cardMarginVertical,
                  horizontal: cardMarginHorizontal,
                ),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(22), // smoother rounded corners
                ),
                color: AppColors.surface,
                elevation: 4, // subtle soft shadow
                shadowColor: Colors.black.withOpacity(0.08),
                child: InkWell(
                  borderRadius: BorderRadius.circular(22),
                  onTap: () {
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (context) => GroupViewScreen(
                          groupId: groupId,
                          onJoinSuccess: null,
                        ),
                      ),
                    );
                  },
                  child: Padding(
                    padding: const EdgeInsets.all(cardInternalPadding),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.center,
                      children: [
                        // Group image
                        ClipRRect(
                          borderRadius: BorderRadius.circular(18),
                          child: groupImage.isNotEmpty
                              ? CachedNetworkImage(
                                  imageUrl: groupImage,
                                  width: double.infinity,
                                  fit: BoxFit.cover,
                                  placeholder: (context, url) => Shimmer.fromColors(
                                    baseColor: AppColors.elevation,
                                    highlightColor: AppColors.surface.withOpacity(0.5),
                                    child: Container(color: Colors.white),
                                  ),
                                  errorWidget: (context, url, error) =>
                                      const Icon(Feather.alert_circle, color: AppColors.primaryLavender),
                                )
                              : Container(
                                  width: double.infinity,
                                  color: AppColors.elevation,
                                  padding: const EdgeInsets.all(28),
                                  child: const Icon(
                                    Feather.users,
                                    color: AppColors.primaryLavender,
                                    size: 36,
                                  ),
                                ),
                        ),

                        const SizedBox(height: 12),

                        // Group name
                        Text(
                          groupName,
                          textAlign: TextAlign.center,
                          style: const TextStyle(
                            fontWeight: FontWeight.bold,
                            fontSize: 16,
                            color: AppColors.primaryLavender,
                          ),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),

                        const SizedBox(height: 6),

                        // Rating Row
                        Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(Icons.star_rounded, size: 16, color: AppColors.accentMustard),
                            SizedBox(width: 4),
                            Text(
                              averageRating > 0 ? averageRating.toStringAsFixed(1) : '0.0',
                              style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13, color: AppColors.textHigh),
                            ),
                            SizedBox(width: 4),
                            Text(
                              "($ratingCount)",
                              style: TextStyle(fontSize: 12, color: AppColors.textMedium),
                            ),
                          ],
                        ),

                        const SizedBox(height: 6),
                        const SizedBox(height: 12),

                        // Member count pill
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5),
                          decoration: BoxDecoration(
                            color: AppColors.secondaryTeal,
                            borderRadius: BorderRadius.circular(50),
                            boxShadow: [
                              BoxShadow(
                                color: Colors.black.withOpacity(0.06),
                                blurRadius: 6,
                                offset: const Offset(0, 2),
                              ),
                            ],
                          ),
                          child: Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              const Icon(
                                Feather.users,
                                size: 16,
                                color: AppColors.textOnSecondary,
                              ),
                              const SizedBox(width: 5),
                              Text(
                                '$memberCount members',
                                style: const TextStyle(
                                  color: AppColors.textOnSecondary,
                                  fontSize: 12,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              );
            }

            else if (itemType == 'discussion') {
              final String discussionId = item.id;
              final String discussionName = itemData['name'] ?? 'Untitled Discussion';
              final String discussionImage = itemData['imageUrl'] ?? '';
              final String discussionDescription = itemData['description'] ?? '';
              final int memberCount = itemData['memberCount'] ?? 0;
              final Map<String, dynamic> ratings = itemData['ratings'] ?? {};
              double averageRating = 0;
              if (ratings.isNotEmpty) {
                averageRating = ratings.values.map((v) => (v as num).toDouble()).reduce((a, b) => a + b) / ratings.length;
              }
              final int ratingCount = ratings.length;

              final bool isArchived = _isDiscussionArchived(itemData);
              final int? daysLeft = isArchived ? null : _getDaysLeft(itemData);

              return Card(
                margin: const EdgeInsets.symmetric(
                  vertical: cardMarginVertical,
                  horizontal: cardMarginHorizontal,
                ),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(borderRadiusValue),
                ),
                color: AppColors.surface,
                elevation: 3,
                shadowColor: AppColors.elevation,
                child: InkWell(
                  borderRadius: BorderRadius.circular(borderRadiusValue),
                  onTap: isArchived
                      ? null
                      : () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => DiscussionViewScreen(
                                discussionId: discussionId,
                                onJoinSuccess: null,
                              ),
                            ),
                          );
                        },
                  child: Padding(
                    padding: const EdgeInsets.all(cardInternalPadding),
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      crossAxisAlignment: CrossAxisAlignment.center,
                      children: [
                        //  Image with overlay if archived
                        ClipRRect(
                          borderRadius: BorderRadius.circular(borderRadiusValue - 4),
                          child: SizedBox(
                            width: double.infinity,
                            height: 140,
                            child: Stack(
                              fit: StackFit.expand,
                              children: [
                                discussionImage.isNotEmpty
                                    ? CachedNetworkImage(
                                        imageUrl: discussionImage,
                                        fit: BoxFit.cover,
                                        color: isArchived
                                            ? Colors.grey.withOpacity(0.5)
                                            : null,
                                        colorBlendMode:
                                            isArchived ? BlendMode.saturation : null,
                                        placeholder: (context, url) => Shimmer.fromColors(
                                          baseColor: AppColors.elevation,
                                          highlightColor: AppColors.surface.withOpacity(0.5),
                                          child: Container(color: Colors.white),
                                        ),
                                        errorWidget: (context, url, error) =>
                                            const Icon(Feather.alert_circle),
                                      )
                                    : Container(
                                        color: AppColors.elevation,
                                        child: const Icon(Feather.message_square, color: AppColors.textDisabled),
                                      ),
                                if (isArchived)
                                  Container(
                                    color: Colors.black.withOpacity(0.4),
                                    alignment: Alignment.center,
                                    child: const Text(
                                      'ARCHIVED',
                                      style: TextStyle(
                                        color: Colors.white,
                                        fontWeight: FontWeight.bold,
                                        letterSpacing: 1.3,
                                      ),
                                    ),
                                  ),
                              ],
                            ),
                          ),
                        ),

                        const SizedBox(height: 12),

                        //  Title (uniform color)
                        Text(
                          discussionName,
                          textAlign: TextAlign.center,
                          style: const TextStyle(
                            fontWeight: FontWeight.bold,
                            fontSize: 16,
                            color: AppColors.primaryLavender,
                          ),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),

                        const SizedBox(height: 6),

                        // Rating Row
                        Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(Icons.star_rounded, size: 16, color: AppColors.accentMustard),
                            SizedBox(width: 4),
                            Text(
                              averageRating > 0 ? averageRating.toStringAsFixed(1) : '0.0',
                              style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13, color: AppColors.textHigh),
                            ),
                            SizedBox(width: 4),
                            Text(
                              "($ratingCount)",
                              style: TextStyle(fontSize: 12, color: AppColors.textMedium),
                            ),
                          ],
                        ),

                        const SizedBox(height: 10),

                        //  Days left (if active)
                        if (!isArchived && daysLeft != null)
                          Container(
                            padding:
                                const EdgeInsets.symmetric(horizontal: 10, vertical: 5),
                            decoration: BoxDecoration(
                              color: AppColors.secondaryTeal,
                              borderRadius: BorderRadius.circular(50),
                              boxShadow: [
                                BoxShadow(
                                  color: AppColors.primaryLavender.withOpacity(0.15),
                                  blurRadius: 4,
                                  offset: const Offset(0, 2),
                                )
                              ],
                            ),
                            child: Text(
                              '$daysLeft days left',
                              style: const TextStyle(
                                color: AppColors.textOnSecondary,
                                fontSize: 11,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),

                        const SizedBox(height: 8),

                        //  Member count pill
                        Container(
                          padding:
                              const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                          decoration: BoxDecoration(
                            color: isArchived
                                ? AppColors.textDisabled
                                : AppColors.secondaryTeal,
                            borderRadius: BorderRadius.circular(50),
                            boxShadow: [
                              BoxShadow(
                                color: (isArchived
                                        ? AppColors.textDisabled
                                        : AppColors.primaryLavender)
                                    .withOpacity(0.1),
                                blurRadius: 4,
                                offset: const Offset(0, 2),
                              )
                            ],
                          ),
                          child: Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Icon(Feather.users,
                                  size: 14,
                                  color: isArchived ? AppColors.textHigh : AppColors.textOnSecondary),
                              const SizedBox(width: 4),
                              Text(
                                '$memberCount members',
                                style: TextStyle(
                                  color: isArchived ? AppColors.textHigh : AppColors.textOnSecondary,
                                  fontSize: 12,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              );
            }

            else if (itemType == 'poll') {
              // Poll card rendering
              final DocumentSnapshot pollSnapshot = shuffledItems[index];
              return PollCard(
                pollSnapshot: pollSnapshot,
                cardMarginVertical: cardMarginVertical,
                cardMarginHorizontal: cardMarginHorizontal,
                cardInternalPadding: cardInternalPadding,
                borderRadiusValue: borderRadiusValue,
              );
            }
            else if (itemType == 'petition') {
              final petitionDoc = item;
              final petition = Petition.fromDocument(petitionDoc);
              final bool isSigned = petition.signers.contains(_currentUserId);
              final double progress =
                  petition.goal > 0 ? petition.currentSignatures / petition.goal : 0.0;

              return Card(
                margin: const EdgeInsets.symmetric(
                    vertical: cardMarginVertical, horizontal: cardMarginHorizontal),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(borderRadiusValue),
                ),
                color: AppColors.surface,
                elevation: 2,
                shadowColor: AppColors.elevation,
                child: InkWell(
                  onTap: () {
                    showPetitionDetails(context, petition, isSigned);
                  },
                  borderRadius: BorderRadius.circular(borderRadiusValue),
                  child: Padding(
                    padding: const EdgeInsets.all(cardInternalPadding),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.center,
                      children: [
                        // Banner image
                        ClipRRect(
                          borderRadius: BorderRadius.circular(borderRadiusValue - 4),
                          child: petition.bannerImageUrl != null &&
                                  petition.bannerImageUrl!.isNotEmpty
                              ? CachedNetworkImage(
                                  imageUrl: petition.bannerImageUrl!,
                                  height: 140,
                                  width: double.infinity,
                                  fit: BoxFit.cover,
                                  placeholder: (context, url) => Shimmer.fromColors(
                                    baseColor: AppColors.elevation,
                                    highlightColor: AppColors.surface.withOpacity(0.5),
                                    child: Container(color: Colors.white),
                                  ),
                                  errorWidget: (context, url, error) =>
                                      const Icon(Feather.alert_circle),
                                )
                              : Container(
                                  height: 140,
                                  width: double.infinity,
                                  color: AppColors.elevation,
                                  child: const Icon(Feather.image, color: AppColors.textDisabled),
                                ),
                        ),
                        const SizedBox(height: 12),

                        // Title
                        Text(
                          petition.title.length > 50
                              ? '${petition.title.substring(0, 50)}...'
                              : petition.title,
                          textAlign: TextAlign.center,
                          style: const TextStyle(
                            fontWeight: FontWeight.bold,
                            fontSize: 16,
                            color: AppColors.primaryLavender,
                          ),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),
                        const SizedBox(height: 6),

                        // Description
                        Text(
                          petition.description,
                          textAlign: TextAlign.center,
                          style: const TextStyle(
                            fontSize: 13,
                            color: AppColors.textMedium,
                          ),
                          maxLines: 3,
                          overflow: TextOverflow.ellipsis,
                        ),
                        const SizedBox(height: 10),

                        // Signature pill with progress border
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                          decoration: BoxDecoration(
                            color: AppColors.secondaryTeal,
                            borderRadius: BorderRadius.circular(50),
                            border: Border.all(
                              color: AppColors.primaryLavender,
                              width: 4.5 * progress, // thin, proportional to progress
                            ),
                            boxShadow: [
                              BoxShadow(
                                color: AppColors.primaryLavender.withOpacity(0.1),
                                blurRadius: 4,
                                offset: const Offset(0, 2),
                              )
                            ],
                          ),
                          child: Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              const Icon(Feather.user_check, size: 14, color: AppColors.textOnSecondary),
                              const SizedBox(width: 4),
                              Text(
                                '${petition.currentSignatures}/${petition.goal} signatures',
                                style: const TextStyle(
                                  color: AppColors.textOnSecondary,
                                  fontSize: 12,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              );
            }

            else {
              // Fallback for unknown item types
              return Card(
                color: AppColors.surface,
                child: ListTile(
                  title: Text('Unknown Item Type', style: TextStyle(color: AppColors.textHigh))
                )
              );
            }
          },
        ),
      );
    },
  );
}


  Widget _buildGroupsTab() {
    return StreamBuilder<QuerySnapshot>(
      stream: _firestore
          .collection('groups')
          .where('isPrivate', isEqualTo: false)
          .snapshots(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return const GridShimmerSkeleton();
        }
        
        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return Center(
            child: FittedBox(
              fit: BoxFit.scaleDown,
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(Feather.users, size: 40, color: AppColors.textDisabled),
                  SizedBox(height: 12),
                  Text('No public groups yet', style: TextStyle(fontSize: 14, color: AppColors.textHigh)),
                  SizedBox(height: 6),
                  Text(
                    'Be the first to create a group!',
                    style: TextStyle(color: AppColors.textDisabled, fontSize: 12),
                  ),
                ],
              ),
            ),
          );
        }
        
        final allGroups = snapshot.data!.docs;
        // Filter by category
        final filteredGroups = _selectedCategory == 'All'
            ? allGroups
            : allGroups.where((group) {
                final groupData = group.data() as Map<String, dynamic>;
                final String category = groupData['category'] ?? 'General';
                return category == _selectedCategory;
              }).toList();
        
        // Filter out groups user is already a member of
        final discoverGroups = filteredGroups.where((group) {
          final groupData = group.data() as Map<String, dynamic>;
          final List<dynamic> members = groupData['members'] ?? [];
          return !members.contains(_currentUserId);
        }).toList();
        
        if (discoverGroups.isEmpty) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Feather.search, size: 50, color: AppColors.textDisabled),
                SizedBox(height: 16),
                Text(
                  'No groups found in ${_selectedCategory == "All" ? "any category" : _selectedCategory}',
                  textAlign: TextAlign.center,
                  style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                ),
                SizedBox(height: 8),
                Text(
                  'Try a different category or create your own group',
                  textAlign: TextAlign.center,
                  style: TextStyle(color: AppColors.textDisabled),
                ),
              ],
            ),
          );
        }
        
        return Padding(
          padding: const EdgeInsets.symmetric(horizontal: 20.0), // externalPadding
          child: MasonryGridView.count(
            crossAxisCount: ResponsiveLayout.getColumnCount(context),
            mainAxisSpacing: 8.0, // cardSpacing
            crossAxisSpacing: 8.0, // cardSpacing
            itemCount: discoverGroups.length,
            itemBuilder: (context, index) {
              final group = discoverGroups[index];
              final groupData = group.data() as Map<String, dynamic>;
              final String groupId = group.id;
              final String groupName = groupData['name'] ?? 'Untitled';
              final String groupImage = groupData['imageUrl'] ?? '';
              final int memberCount = groupData['memberCount'] ?? 0;
              final String groupDescription = groupData['description'] ?? '';
              final Map<String, dynamic> ratings = groupData['ratings'] ?? {};
              double averageRating = 0;
              if (ratings.isNotEmpty) {
                averageRating = ratings.values.map((v) => (v as num).toDouble()).reduce((a, b) => a + b) / ratings.length;
              }
              final int ratingCount = ratings.length;

              return Card(
                margin: const EdgeInsets.symmetric(
                  vertical: 2.0, // cardMarginVertical
                  horizontal: 2.0, // cardMarginHorizontal
                ),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(22), // matches _buildAllTab
                ),
                color: AppColors.surface,
                elevation: 4,
                shadowColor: Colors.black.withOpacity(0.08),
                child: InkWell(
                  borderRadius: BorderRadius.circular(22),
                  onTap: () {
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (context) => GroupViewScreen(
                          groupId: groupId,
                          onJoinSuccess: null,
                        ),
                      ),
                    );
                  },
                  child: Padding(
                    padding: const EdgeInsets.all(12.0), // cardInternalPadding
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.center,
                      children: [
                        // Group image
                        ClipRRect(
                          borderRadius: BorderRadius.circular(18),
                          child: groupImage.isNotEmpty
                              ? CachedNetworkImage(
                                  imageUrl: groupImage,
                                  width: double.infinity,
                                  fit: BoxFit.cover,
                                  placeholder: (context, url) => Shimmer.fromColors(
                                    baseColor: AppColors.elevation,
                                    highlightColor: AppColors.surface.withOpacity(0.5),
                                    child: Container(color: Colors.white),
                                  ),
                                  errorWidget: (context, url, error) =>
                                      const Icon(Feather.alert_circle, color: AppColors.primaryLavender),
                                )
                              : Container(
                                  width: double.infinity,
                                  color: AppColors.elevation,
                                  padding: const EdgeInsets.all(28),
                                  child: const Icon(
                                    Feather.users,
                                    color: AppColors.primaryLavender,
                                    size: 36,
                                  ),
                                ),
                        ),

                        const SizedBox(height: 12),

                        // Group name
                        Text(
                          groupName,
                          textAlign: TextAlign.center,
                          style: const TextStyle(
                            fontWeight: FontWeight.bold,
                            fontSize: 16,
                            color: AppColors.primaryLavender,
                          ),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),

                        const SizedBox(height: 6),

                        // Rating Row
                        Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(Icons.star_rounded, size: 16, color: AppColors.accentMustard),
                            SizedBox(width: 4),
                            Text(
                              averageRating > 0 ? averageRating.toStringAsFixed(1) : '0.0',
                              style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13, color: AppColors.textHigh),
                            ),
                            SizedBox(width: 4),
                            Text(
                              "($ratingCount)",
                              style: TextStyle(fontSize: 12, color: AppColors.textMedium),
                            ),
                          ],
                        ),

                        const SizedBox(height: 6),
                        const SizedBox(height: 12),

                        // Member count pill
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5),
                          decoration: BoxDecoration(
                            color: AppColors.secondaryTeal,
                            borderRadius: BorderRadius.circular(50),
                            boxShadow: [
                              BoxShadow(
                                color: Colors.black.withOpacity(0.06),
                                blurRadius: 6,
                                offset: const Offset(0, 2),
                              ),
                            ],
                          ),
                          child: Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              const Icon(
                                Feather.users,
                                size: 16,
                                color: AppColors.textOnSecondary,
                              ),
                              const SizedBox(width: 5),
                              Text(
                                '$memberCount members',
                                style: const TextStyle(
                                  color: AppColors.textOnSecondary,
                                  fontSize: 12,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              );
            },
          ),
        );

      },
    );
  }

  Widget _buildPollsTab() {
    return StreamBuilder<QuerySnapshot>(
      stream: _firestore.collection('polls').snapshots(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return const GridShimmerSkeleton();
        }
        
        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Feather.bar_chart_2, size: 50, color: AppColors.textDisabled),
                SizedBox(height: 16),
                Text(
                  'No polls yet',
                  textAlign: TextAlign.center,
                  style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                ),
                SizedBox(height: 8),
                Text(
                  'Be the first to create a poll!',
                  textAlign: TextAlign.center,
                  style: TextStyle(color: AppColors.textDisabled),
                ),
              ],
            ),
          );
        }
        
        final polls = snapshot.data!.docs;
        
        return Padding(
          padding: const EdgeInsets.symmetric(horizontal: 20.0),
          child: MasonryGridView.count(
            crossAxisCount: ResponsiveLayout.getColumnCount(context),
            mainAxisSpacing: 8.0,
            crossAxisSpacing: 8.0,
            itemCount: polls.length,
            itemBuilder: (context, index) {
              final poll = polls[index];
              return PollCard(
                pollSnapshot: poll,
                cardMarginVertical: 2.0,
                cardMarginHorizontal: 2.0,
                cardInternalPadding: 12.0,
                borderRadiusValue: 24.0,
              );
            },
          ),
        );
      },
    );
  }

  Widget _buildDiscussionsTab() {
    return StreamBuilder<QuerySnapshot>(
      stream: _firestore
          .collection('groups')
          .where('category', isEqualTo: 'Discussions')
          .where('isPrivate', isEqualTo: false)
          .snapshots(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return const GridShimmerSkeleton();
        }
        
        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Feather.message_square, size: 50, color: AppColors.textDisabled),
                SizedBox(height: 16),
                Text(
                  'No discussions yet',
                  textAlign: TextAlign.center,
                  style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                ),
                SizedBox(height: 8),
                Text(
                  'Be the first to start a discussion!',
                  textAlign: TextAlign.center,
                  style: TextStyle(color: AppColors.textDisabled),
                ),
              ],
            ),
          );
        }
        
        final allDiscussions = snapshot.data!.docs;
        final discussions = allDiscussions.where((doc) {
          final data = doc.data() as Map<String, dynamic>;
          return !_isDiscussionArchived(data);
        }).toList();
        
        if (discussions.isEmpty) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Feather.message_square, size: 50, color: AppColors.textDisabled),
                SizedBox(height: 16),
                const Text(
                  'No active discussions',
                  textAlign: TextAlign.center,
                  style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                ),
              ],
            ),
          );
        }
        
        return Padding(
          padding: const EdgeInsets.symmetric(horizontal: 20.0),
          child: MasonryGridView.count(
            crossAxisCount: ResponsiveLayout.getColumnCount(context),
            mainAxisSpacing: 8.0,
            crossAxisSpacing: 8.0,
            itemCount: discussions.length,
            itemBuilder: (context, index) {
              final discussion = discussions[index];
              final discussionData = discussion.data() as Map<String, dynamic>;
              final String discussionId = discussion.id;
              final String discussionName = discussionData['name'] ?? 'Untitled Discussion';
              final String discussionImage = discussionData['imageUrl'] ?? '';
              final int memberCount = discussionData['memberCount'] ?? 0;
              final String discussionDescription = discussionData['description'] ?? '';

              final bool isArchived = _isDiscussionArchived(discussionData);
              final int? daysLeft = isArchived ? null : _getDaysLeft(discussionData);

              return Card(
                margin: const EdgeInsets.symmetric(
                  vertical: 2.0,
                  horizontal: 2.0,
                ),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(24.0),
                ),
                color: AppColors.surface,
                elevation: 3,
                shadowColor: AppColors.elevation,
                child: InkWell(
                  borderRadius: BorderRadius.circular(24.0),
                  onTap: () {
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (context) => DiscussionViewScreen(
                          discussionId: discussionId,
                          onJoinSuccess: null,
                        ),
                      ),
                    );
                  },
                  child: Padding(
                    padding: const EdgeInsets.all(12.0),
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      crossAxisAlignment: CrossAxisAlignment.center,
                      children: [
                        //  Image with shimmer
                        ClipRRect(
                          borderRadius: BorderRadius.circular(20.0),
                          child: SizedBox(
                            width: double.infinity,
                            height: 140,
                            child: discussionImage.isNotEmpty
                                ? CachedNetworkImage(
                                    imageUrl: discussionImage,
                                    fit: BoxFit.cover,
                                    placeholder: (context, url) => Shimmer.fromColors(
                                      baseColor: AppColors.elevation,
                                      highlightColor: AppColors.surface.withOpacity(0.5),
                                      child: Container(color: Colors.white),
                                    ),
                                    errorWidget: (context, url, error) =>
                                        const Icon(Feather.alert_circle),
                                  )
                                : Container(
                                    color: AppColors.elevation,
                                    child: const Icon(Feather.message_square, color: AppColors.textDisabled),
                                  ),
                          ),
                        ),

                        const SizedBox(height: 12),

                        //  Title
                        Text(
                          discussionName,
                          textAlign: TextAlign.center,
                          style: const TextStyle(
                            fontWeight: FontWeight.bold,
                            fontSize: 16,
                            color: AppColors.primaryLavender,
                          ),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),

                        const SizedBox(height: 6),

                        //  Description
                        Text(
                          discussionDescription,
                          textAlign: TextAlign.center,
                          style: const TextStyle(
                            fontSize: 13,
                            color: AppColors.textMedium,
                          ),
                          maxLines: 3,
                          overflow: TextOverflow.ellipsis,
                        ),

                        const SizedBox(height: 10),

                        //  Days left (if active)
                        if (!isArchived && daysLeft != null)
                          Container(
                            padding:
                                const EdgeInsets.symmetric(horizontal: 10, vertical: 5),
                            decoration: BoxDecoration(
                              color: AppColors.secondaryTeal,
                              borderRadius: BorderRadius.circular(50),
                              boxShadow: [
                                BoxShadow(
                                  color: AppColors.primaryLavender.withOpacity(0.15),
                                  blurRadius: 4,
                                  offset: const Offset(0, 2),
                                )
                              ],
                            ),
                            child: Text(
                              '$daysLeft days left',
                              style: const TextStyle(
                                color: AppColors.textOnSecondary,
                                fontSize: 11,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),

                        const SizedBox(height: 8),

                        //  Member count pill
                        Container(
                          padding:
                              const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                          decoration: BoxDecoration(
                            color: isArchived
                                ? AppColors.textDisabled
                                : AppColors.secondaryTeal,
                            borderRadius: BorderRadius.circular(50),
                            boxShadow: [
                              BoxShadow(
                                color: (isArchived
                                        ? AppColors.textDisabled
                                        : AppColors.primaryLavender)
                                    .withOpacity(0.1),
                                blurRadius: 4,
                                offset: const Offset(0, 2),
                              )
                            ],
                          ),
                          child: Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Icon(Feather.users,
                                  size: 14,
                                  color: isArchived ? AppColors.textHigh : AppColors.textOnSecondary),
                              const SizedBox(width: 4),
                              Text(
                                '$memberCount members',
                                style: TextStyle(
                                  color: isArchived ? AppColors.textHigh : AppColors.textOnSecondary,
                                  fontSize: 12,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              );
            },
          ),
        );

      },
    );
  }

  Widget _buildArchivedTab() {
    return StreamBuilder<QuerySnapshot>(
      stream: _firestore
          .collection('groups')
          .where('category', isEqualTo: 'Discussions')
          .where('isPrivate', isEqualTo: false)
          .snapshots(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return const GridShimmerSkeleton();
        }

        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Feather.archive, size: 50, color: AppColors.textDisabled),
                SizedBox(height: 16),
                const Text(
                  'No archived discussions',
                  textAlign: TextAlign.center,
                  style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                ),
              ],
            ),
          );
        }

        final allDiscussions = snapshot.data!.docs;
        final archivedDiscussions = allDiscussions.where((doc) {
          final data = doc.data() as Map<String, dynamic>;
          return _isDiscussionArchived(data);
        }).toList();

        if (archivedDiscussions.isEmpty) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Feather.archive, size: 50, color: AppColors.textDisabled),
                SizedBox(height: 16),
                const Text(
                  'No archived discussions',
                  textAlign: TextAlign.center,
                  style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                ),
              ],
            ),
          );
        }

        return Padding(
          padding: const EdgeInsets.symmetric(horizontal: 20.0),
          child: MasonryGridView.count(
            crossAxisCount: ResponsiveLayout.getColumnCount(context),
            mainAxisSpacing: 8.0,
            crossAxisSpacing: 8.0,
            itemCount: archivedDiscussions.length,
            itemBuilder: (context, index) {
              final discussion = archivedDiscussions[index];
              final discussionData = discussion.data() as Map<String, dynamic>;
              final String discussionId = discussion.id;
              final String discussionName = discussionData['name'] ?? 'Untitled Discussion';
              final String discussionImage = discussionData['imageUrl'] ?? '';
              final int memberCount = discussionData['memberCount'] ?? 0;
              final String discussionDescription = discussionData['description'] ?? '';

              return Card(
                margin: const EdgeInsets.symmetric(
                  vertical: 2.0,
                  horizontal: 2.0,
                ),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(24.0),
                ),
                color: AppColors.surface,
                elevation: 3,
                shadowColor: AppColors.elevation,
                child: InkWell(
                  borderRadius: BorderRadius.circular(24.0),
                  onTap: () {
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (context) => DiscussionViewScreen(
                          discussionId: discussionId,
                          onJoinSuccess: null,
                        ),
                      ),
                    );
                  },
                  child: Padding(
                    padding: const EdgeInsets.all(12.0),
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      crossAxisAlignment: CrossAxisAlignment.center,
                      children: [
                        //  Image with shimmer and ARCHIVED overlay
                        ClipRRect(
                          borderRadius: BorderRadius.circular(20.0),
                          child: SizedBox(
                            width: double.infinity,
                            height: 140,
                            child: Stack(
                              fit: StackFit.expand,
                              children: [
                                discussionImage.isNotEmpty
                                    ? CachedNetworkImage(
                                        imageUrl: discussionImage,
                                        fit: BoxFit.cover,
                                        color: Colors.grey.withOpacity(0.5),
                                        colorBlendMode: BlendMode.saturation,
                                        placeholder: (context, url) => Shimmer.fromColors(
                                          baseColor: AppColors.elevation,
                                          highlightColor: AppColors.surface.withOpacity(0.5),
                                          child: Container(color: Colors.white),
                                        ),
                                        errorWidget: (context, url, error) =>
                                            const Icon(Feather.alert_circle),
                                      )
                                    : Container(
                                        color: AppColors.elevation,
                                        child: const Icon(Feather.message_square, color: AppColors.textDisabled),
                                      ),
                                Container(
                                  color: Colors.black.withOpacity(0.4),
                                  alignment: Alignment.center,
                                  child: const Text(
                                    'ARCHIVED',
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontWeight: FontWeight.bold,
                                      letterSpacing: 1.3,
                                    ),
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ),

                        const SizedBox(height: 12),

                        //  Title
                        Text(
                          discussionName,
                          textAlign: TextAlign.center,
                          style: const TextStyle(
                            fontWeight: FontWeight.bold,
                            fontSize: 16,
                            color: AppColors.textDisabled,
                          ),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),

                        const SizedBox(height: 6),

                        //  Description
                        Text(
                          discussionDescription,
                          textAlign: TextAlign.center,
                          style: const TextStyle(
                            fontSize: 13,
                            color: AppColors.textDisabled,
                          ),
                          maxLines: 3,
                          overflow: TextOverflow.ellipsis,
                        ),

                        const SizedBox(height: 10),

                        //  Member count pill (Disabled style)
                        Container(
                          padding:
                              const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                          decoration: BoxDecoration(
                            color: AppColors.elevation,
                            borderRadius: BorderRadius.circular(50),
                          ),
                          child: Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              const Icon(Feather.users, size: 14, color: AppColors.textDisabled),
                              const SizedBox(width: 4),
                              Text(
                                '$memberCount members',
                                style: const TextStyle(
                                  color: AppColors.textDisabled,
                                  fontSize: 12,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              );
            },
          ),
        );
      },
    );
  }

  Widget _buildPetitionsTab() {
    return StreamBuilder<QuerySnapshot>(
      stream: _firestore.collection('petitions').snapshots(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return const GridShimmerSkeleton();
        }

        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Feather.check_square, size: 50, color: AppColors.textDisabled),
                SizedBox(height: 16),
                Text(
                  'No petitions yet',
                  textAlign: TextAlign.center,
                  style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                ),
                SizedBox(height: 8),
                Text(
                  'Be the first to create a petition!',
                  textAlign: TextAlign.center,
                  style: TextStyle(color: AppColors.textDisabled),
                ),
              ],
            ),
          );
        }

        final petitions = snapshot.data!.docs;

        return Padding(
          padding: const EdgeInsets.symmetric(horizontal: 20.0),
          child: MasonryGridView.count(
            crossAxisCount: ResponsiveLayout.getColumnCount(context),
            mainAxisSpacing: 8.0,
            crossAxisSpacing: 8.0,
            itemCount: petitions.length,
            itemBuilder: (context, index) {
              final petition = petitions[index];
              final petitionData = petition.data() as Map<String, dynamic>;
              final String petitionId = petition.id;
              final String title = petitionData['title'] ?? 'Untitled Petition';
              final String imageUrl = petitionData['imageUrl'] ?? '';
              final String description = petitionData['description'] ?? '';
              final int signaturesCount = petitionData['signaturesCount'] ?? petitionData['currentSignatures'] ?? 0;
              final int goal = petitionData['goal'] ?? 1000;
              final double progress = (signaturesCount / goal).clamp(0.0, 1.0);

              return Card(
                margin: const EdgeInsets.symmetric(
                  vertical: 2.0,
                  horizontal: 2.0,
                ),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(24.0),
                ),
                color: AppColors.surface,
                elevation: 4,
                shadowColor: Colors.black.withOpacity(0.06),
                child: InkWell(
                  borderRadius: BorderRadius.circular(24.0),
                  onTap: () {
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (context) => EnhancedPetitionDetailScreen(petitionId: petitionId),
                      ),
                    );
                  },
                  child: Padding(
                    padding: const EdgeInsets.all(12.0),
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      crossAxisAlignment: CrossAxisAlignment.center,
                      children: [
                        //  Petition Image
                        ClipRRect(
                          borderRadius: BorderRadius.circular(18),
                          child: imageUrl.isNotEmpty
                              ? CachedNetworkImage(
                                  imageUrl: imageUrl,
                                  height: 120,
                                  width: double.infinity,
                                  fit: BoxFit.cover,
                                  placeholder: (context, url) => Shimmer.fromColors(
                                    baseColor: AppColors.elevation,
                                    highlightColor: AppColors.surface.withOpacity(0.5),
                                    child: Container(color: Colors.white),
                                  ),
                                  errorWidget: (context, url, error) =>
                                      const Icon(Feather.alert_circle),
                                )
                              : Container(
                                  height: 120,
                                  color: AppColors.elevation,
                                  width: double.infinity,
                                  child: const Icon(
                                    Feather.file_text,
                                    color: AppColors.primaryLavender,
                                    size: 32,
                                  ),
                                ),
                        ),

                        const SizedBox(height: 12),

                        //  Title
                        Text(
                          title,
                          textAlign: TextAlign.center,
                          style: const TextStyle(
                            fontWeight: FontWeight.bold,
                            fontSize: 16,
                            color: AppColors.primaryLavender,
                          ),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),

                        const SizedBox(height: 6),

                        //  Description
                        Text(
                          description,
                          textAlign: TextAlign.center,
                          style: const TextStyle(
                            fontSize: 13,
                            color: AppColors.textMedium,
                          ),
                          maxLines: 2,
                          overflow: TextOverflow.ellipsis,
                        ),

                        const SizedBox(height: 12),

                        //  Progress Bar
                        Stack(
                          children: [
                            Container(
                              height: 6,
                              width: double.infinity,
                              decoration: BoxDecoration(
                                color: AppColors.elevation,
                                borderRadius: BorderRadius.circular(10),
                              ),
                            ),
                            FractionallySizedBox(
                              widthFactor: progress,
                              child: Container(
                                height: 6,
                                decoration: BoxDecoration(
                                  color: AppColors.secondaryTeal,
                                  borderRadius: BorderRadius.circular(10),
                                  boxShadow: [
                                    BoxShadow(
                                      color: AppColors.secondaryTeal.withOpacity(0.3),
                                      blurRadius: 4,
                                      offset: const Offset(0, 1),
                                    )
                                  ],
                                ),
                              ),
                            ),
                          ],
                        ),

                        const SizedBox(height: 8),

                        //  Signature Count
                        Text(
                          '$signaturesCount / $goal signed',
                          style: const TextStyle(
                            fontSize: 12,
                            fontWeight: FontWeight.bold,
                            color: AppColors.secondaryTeal,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              );
            },
          ),
        );
      },
    );
  }


  void _showCreatePetitionModal() {
    final TextEditingController _titleController = TextEditingController();
    final TextEditingController _descriptionController = TextEditingController();
    final TextEditingController _goalController = TextEditingController(text: '100');
    
    // Reset hashtags for a new petition
    setState(() {
      _hashtags.clear();
    });
    _hashtagController.clear();

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: AppColors.surface,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (context) => StatefulBuilder(
        builder: (context, setModalState) {
          return Padding(
            padding: EdgeInsets.only(
              bottom: MediaQuery.of(context).viewInsets.bottom,
              left: 16,
              right: 16,
              top: 16,
            ),
            child: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Text('Create Petition', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
                      IconButton(
                        icon: Icon(Feather.x, color: AppColors.textHigh),
                        onPressed: () => Navigator.pop(context),
                      ),
                    ],
                  ),
                  SizedBox(height: 16),
                  TextField(
                    controller: _titleController,
                    style: TextStyle(color: AppColors.textHigh),
                    decoration: InputDecoration(
                      labelText: 'Petition Title *',
                      labelStyle: TextStyle(color: AppColors.textMedium),
                      border: OutlineInputBorder(),
                      filled: true,
                      fillColor: AppColors.elevation,
                    ),
                  ),
                  SizedBox(height: 16),
                  TextField(
                    controller: _descriptionController,
                    style: TextStyle(color: AppColors.textHigh),
                    decoration: InputDecoration(
                      labelText: 'Petition Description *',
                      labelStyle: TextStyle(color: AppColors.textMedium),
                      border: OutlineInputBorder(),
                      filled: true,
                      fillColor: AppColors.elevation,
                    ),
                    maxLines: 4,
                  ),
                  SizedBox(height: 16),
                  TextField(
                    controller: _goalController,
                    style: TextStyle(color: AppColors.textHigh),
                    decoration: InputDecoration(
                      labelText: 'Signature Goal *',
                      labelStyle: TextStyle(color: AppColors.textMedium),
                      border: OutlineInputBorder(),
                      filled: true,
                      fillColor: AppColors.elevation,
                    ),
                    keyboardType: TextInputType.number,
                  ),
                  SizedBox(height: 16),
                  // Age Rating Dropdown
                  DropdownButtonFormField<String>(
                    value: _selectedAgeRating,
                    items: _ageRatings.map((rating) {
                      return DropdownMenuItem<String>(
                        value: rating,
                        child: Text(rating, style: TextStyle(color: AppColors.textHigh)),
                      );
                    }).toList(),
                    onChanged: (value) {
                      setModalState(() {
                        _selectedAgeRating = value!;
                      });
                    },
                    decoration: InputDecoration(
                      labelText: 'Age Rating',
                      labelStyle: TextStyle(color: AppColors.textMedium),
                      border: OutlineInputBorder(),
                      filled: true,
                      fillColor: AppColors.elevation,
                    ),
                    dropdownColor: AppColors.surface,
                  ),
                  SizedBox(height: 16),
                  // Hashtags
                  Wrap(
                    spacing: 8.0,
                    runSpacing: 4.0,
                    children: _hashtags.map((tag) {
                      return Chip(
                        label: Text('#$tag', style: TextStyle(color: AppColors.textOnSecondary)),
                        backgroundColor: AppColors.secondaryTeal,
                        deleteIcon: Icon(Feather.x, size: 18, color: AppColors.textOnSecondary),
                        onDeleted: () {
                          setModalState(() {
                            _hashtags.remove(tag);
                          });
                        },
                      );
                    }).toList(),
                  ),
                  Row(
                    children: [
                      Expanded(
                        child: TextField(
                          controller: _hashtagController,
                          style: TextStyle(color: AppColors.textHigh),
                          decoration: InputDecoration(
                            labelText: 'Add Hashtag',
                            labelStyle: TextStyle(color: AppColors.textMedium),
                            border: OutlineInputBorder(),
                            filled: true,
                            fillColor: AppColors.elevation,
                            suffixIcon: IconButton(
                              icon: Icon(Feather.plus, color: AppColors.primaryLavender),
                              onPressed: () {
                                String newTag = _hashtagController.text.trim().replaceAll('#', '');
                                if (newTag.isNotEmpty && !_hashtags.contains(newTag)) {
                                  setModalState(() {
                                    _hashtags.add(newTag);
                                  });
                                  _hashtagController.clear();
                                }
                              },
                            ),
                          ),
                          onSubmitted: (_) {
                            String newTag = _hashtagController.text.trim().replaceAll('#', '');
                            if (newTag.isNotEmpty && !_hashtags.contains(newTag)) {
                              setModalState(() {
                                _hashtags.add(newTag);
                              });
                              _hashtagController.clear();
                            }
                          },
                        ),
                      ),
                    ],
                  ),
                  SizedBox(height: 16),
                  ElevatedButton(
                    onPressed: () {
                      if (_titleController.text.isEmpty || 
                          _descriptionController.text.isEmpty ||
                          _goalController.text.isEmpty) {
                        ScaffoldMessenger.of(context).showSnackBar(
                          SnackBar(content: Text('All fields are required')),
                        );
                        return;
                      }
                      
                      _createPetition(
                        _titleController.text,
                        _descriptionController.text,
                        int.parse(_goalController.text),
                      );
                    },
                    child: Text('Create Petition', style: TextStyle(color: AppColors.textOnSecondary)),
                    style: ElevatedButton.styleFrom(
                      minimumSize: Size(double.infinity, 50),
                      backgroundColor: AppColors.primaryLavender,
                    ),
                  ),
                  SizedBox(height: 16),
                ],
              ),
            ),
          );
        },
      ),
    );
  }

  Future<void> _createPetition(String title, String description, int goal) async {
    try {
      final petitionId = Uuid().v4();
      final timestamp = FieldValue.serverTimestamp();
      
      final petitionData = {
        'id': petitionId,
        'title': title,
        'description': description,
        'goal': goal,
        'currentSignatures': 0,
        'createdBy': _currentUserId,
        'createdAt': timestamp,
        'signatures': [],
        'ageRating': _selectedAgeRating,
        'hashtags': _hashtags,
        'type': 'petition',
      };
      
      await _firestore.collection('petitions').doc(petitionId).set(petitionData);
      
      // Reset form
      setState(() {
        _hashtags.clear();
      });
      _hashtagController.clear();
      _selectedAgeRating = '13-17';
      
      Navigator.pop(context); // Close the modal
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Petition created successfully')),
      );
    } catch (e) {
      print("Error creating petition: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to create petition. Please try again.')),
      );
    }
  }

  void _showComingSoonPopup() {
    showDialog(
      context: context,
      builder: (context) => Dialog(
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16.0),
        ),
        elevation: 6,
        backgroundColor: AppColors.surface,
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 24.0, vertical: 20.0),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(
                'Coming Soon',
                style: TextStyle(
                  color: AppColors.accentMustard,
                  fontWeight: FontWeight.bold,
                  fontSize: 18,
                ),
              ),
              const SizedBox(height: 12),
              Text(
                'This feature is currently under development.',
                style: TextStyle(
                  color: AppColors.textMedium,
                  fontSize: 15,
                ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 20),
              GestureDetector(
                onTap: () => Navigator.pop(context),
                child: Container(
                  padding: const EdgeInsets.symmetric(horizontal: 28, vertical: 10),
                  decoration: BoxDecoration(
                    color: AppColors.elevation,
                    borderRadius: BorderRadius.circular(12),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.08),
                        blurRadius: 6,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),
                    child: Text(
                      'OK',
                      style: TextStyle(
                        color: AppColors.primaryLavender,
                        fontWeight: FontWeight.bold,
                        fontSize: 14,
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      );
    }

  void _showOptionsModal() {
    showModalBottomSheet(
      context: context,
      backgroundColor: AppColors.surface,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (context) => Container(
        padding: EdgeInsets.all(16),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Center(
              child: Container(
                width: 40,
                height: 4,
                margin: EdgeInsets.only(bottom: 16),
                decoration: BoxDecoration(
                  color: AppColors.primaryLavender,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
            ),
            Text('Create New', 
                style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
            SizedBox(height: 16),
            // Options grid
            GridView.count(
              shrinkWrap: true,
              crossAxisCount: 2,
              childAspectRatio: 1.8,
              mainAxisSpacing: 12,
              crossAxisSpacing: 12,
              children: [
                _buildOptionCard('Polls', _optionIcons['Polls']!),
                _buildOptionCard('Discussions', _optionIcons['Discussions']!),
                _buildOptionCard('Groups', _optionIcons['Groups']!),
                _buildOptionCard('Mentorship', _optionIcons['Mentorship']!),
                _buildOptionCard('Petitions', _optionIcons['Petitions']!),
              ],
            ),
            SizedBox(height: 16),
          ],
        ),
      ),
    );
  }

  // Replace the existing _showCreateGroupModal function with this:
  void _navigateToGroupCreationScreen() {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => GroupCreationScreen(),
      ),
    );
  }

  // Add this method to your _GroupsScreenState class
  void _navigateToPollCreationScreen() {
    Navigator.push(
      context,
      MaterialPageRoute(builder: (context) => PollCreationScreen()),
    );
  }

  // Helper method to build option cards
  Widget _buildOptionCard(String title, IconData icon) {
    return Card(
      color: AppColors.elevation,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
        side: BorderSide(color: AppColors.primaryLavender, width: 1.0),
      ),
      elevation: 1,
      child: InkWell(
        onTap: () {
          Navigator.pop(context); // Close the options modal
          if (title == 'Groups') {
            _navigateToGroupCreationScreen();
          } else if (title == 'Polls') {
            Navigator.pop(context);
            // Replace the modal call with screen navigation
            Navigator.push(
              context,
              MaterialPageRoute(builder: (context) => PollCreationScreen()),
            );
          } else if (title == 'Discussions') {
            // _showCreateDiscussionModal();
            _showComingSoonPopup();
          } else if (title == 'Petitions') {
            Navigator.pop(context);
            showCreatePetitionModal(context);
          } else if (title == 'Mentorship') {
           _showComingSoonPopup();
          }
        },
        borderRadius: BorderRadius.circular(12),
        child: Padding(
          padding: EdgeInsets.all(12),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(icon, color: AppColors.primaryLavender, size: 28),
              SizedBox(height: 8),
              Text(title, 
                  style: TextStyle(fontWeight: FontWeight.w500, color: AppColors.textHigh)),
            ],
          ),
        ),
      ),
    );
  }

  // Show a "coming soon" modal for Mentorship
  void _showComingSoonModal() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Coming Soon', style: TextStyle(color: AppColors.textHigh)),
        content: Text('Mentorship feature is coming in a future update.', style: TextStyle(color: AppColors.textMedium)),
        backgroundColor: AppColors.surface,
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('OK', style: TextStyle(color: AppColors.primaryLavender)),
          ),
        ],
      ),
    );
  }


  void _showCreateDiscussionModal() {
    // Reset hashtags for a new discussion
    setState(() {
      _hashtags.clear();
    });
    _hashtagController.clear();
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: AppColors.surface,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (context) => StatefulBuilder(
        builder: (context, setModalState) {
          return Padding(
            padding: EdgeInsets.only(
              bottom: MediaQuery.of(context).viewInsets.bottom,
              left: 16,
              right: 16,
              top: 16,
            ),
            child: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Text('New Discussion',
                          style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
                      IconButton(
                        icon: Icon(Feather.x, color: AppColors.textHigh),
                        onPressed: () => Navigator.pop(context),
                      ),
                    ],
                  ),
                  SizedBox(height: 16),
                  Center(
                    child: GestureDetector(
                      onTap: _pickGroupImage, // Reusing the same image picking logic
                      child: CircleAvatar(
                        radius: 40,
                        backgroundColor: AppColors.elevation,
                        backgroundImage: _groupImage != null
                            ? FileImage(_groupImage!)
                            : null,
                        child: _groupImage == null
                            ? Icon(Feather.camera, size: 30, color: AppColors.textDisabled)
                            : null,
                      ),
                    ),
                  ),
                  SizedBox(height: 16),
                  TextField(
                    controller: _groupNameController, // Reusing the same controller for simplicity
                    style: TextStyle(color: AppColors.textHigh),
                    decoration: InputDecoration(
                      labelText: 'Discussion Title *',
                      labelStyle: TextStyle(color: AppColors.textMedium),
                      border: OutlineInputBorder(),
                      filled: true,
                      fillColor: AppColors.elevation,
                    ),
                  ),
                  SizedBox(height: 16),
                  TextField(
                    controller: _groupDescriptionController, // Reusing the same controller for simplicity
                    style: TextStyle(color: AppColors.textHigh),
                    decoration: InputDecoration(
                      labelText: 'Description *',
                      labelStyle: TextStyle(color: AppColors.textMedium),
                      border: OutlineInputBorder(),
                      filled: true,
                      fillColor: AppColors.elevation,
                    ),
                    maxLines: 3,
                  ),
                  SizedBox(height: 16),
                  // Hashtags Display
                  Wrap(
                    spacing: 8.0,
                    runSpacing: 4.0,
                    children: _hashtags.map((tag) {
                      return Chip(
                        label: Text('#$tag', style: TextStyle(color: AppColors.textOnSecondary)),
                        backgroundColor: AppColors.secondaryTeal,
                        deleteIcon: Icon(Feather.x, size: 18, color: AppColors.textOnSecondary),
                        onDeleted: () {
                          setModalState(() {
                            _hashtags.remove(tag);
                          });
                        },
                      );
                    }).toList(),
                  ),
                  // Add Hashtag Input
                  Row(
                    children: [
                      Expanded(
                        child: TextField(
                          controller: _hashtagController,
                          style: TextStyle(color: AppColors.textHigh),
                          decoration: InputDecoration(
                            labelText: 'Add Hashtag',
                            labelStyle: TextStyle(color: AppColors.textMedium),
                            border: OutlineInputBorder(),
                            filled: true,
                            fillColor: AppColors.elevation,
                            suffixIcon: IconButton(
                              icon: Icon(Feather.plus, color: AppColors.primaryLavender),
                              onPressed: () {
                                String newTag = _hashtagController.text.trim().replaceAll('#', '');
                                if (newTag.isNotEmpty && !_hashtags.contains(newTag)) {
                                  setModalState(() {
                                    _hashtags.add(newTag);
                                  });
                                  _hashtagController.clear();
                                }
                              },
                            ),
                          ),
                          onSubmitted: (_) {
                            String newTag = _hashtagController.text.trim().replaceAll('#', '');
                            if (newTag.isNotEmpty && !_hashtags.contains(newTag)) {
                              setModalState(() {
                                _hashtags.add(newTag);
                              });
                              _hashtagController.clear();
                            }
                          },
                        ),
                      ),
                    ],
                  ),
                  SizedBox(height: 16),
                  // Age Rating Dropdown
                  DropdownButtonFormField<String>(
                    value: _selectedAgeRating,
                    items: _ageRatings.map((rating) {
                      return DropdownMenuItem<String>(
                        value: rating,
                        child: Text(rating, style: TextStyle(color: AppColors.textHigh)),
                      );
                    }).toList(),
                    onChanged: (value) {
                      setModalState(() {
                        _selectedAgeRating = value!;
                      });
                    },
                    decoration: InputDecoration(
                      labelText: 'Age Rating',
                      labelStyle: TextStyle(color: AppColors.textMedium),
                      border: OutlineInputBorder(),
                      filled: true,
                      fillColor: AppColors.elevation,
                    ),
                    dropdownColor: AppColors.surface,
                  ),
                  SizedBox(height: 16),
                  SwitchListTile(
                    title: Text('Private Discussion', style: TextStyle(color: AppColors.textHigh)),
                    subtitle: Text('Only invited members can join (Coming Soon)', style: TextStyle(color: AppColors.textMedium)),
                    value: _isPrivate,
                    onChanged: (value) {
                      setModalState(() {
                        _isPrivate = value;
                      });
                    },
                    activeColor: AppColors.primaryLavender,
                  ),
                  SizedBox(height: 16),
                  ElevatedButton(
                    onPressed: _createDiscussion, // New method to create discussion
                    child: Text('Create', style: TextStyle(color: AppColors.textOnSecondary)),
                    style: ElevatedButton.styleFrom(
                      minimumSize: Size(double.infinity, 50),
                      backgroundColor: AppColors.primaryLavender,
                    ),
                  ),
                  SizedBox(height: 16),
                ],
              ),
            ),
          );
        },
      ),
    );
  }

// Inside _createDiscussion function (likely in the screen where you create discussions)
  Future<void> _createDiscussion() async {
    if (_groupNameController.text.trim().isEmpty || _groupDescriptionController.text.trim().isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Title and Description are required.')),
      );
      return;
    }

    final String discussionId = _groupNameController.text.trim().toLowerCase().replaceAll(' ', '_') + '_' + DateTime.now().millisecondsSinceEpoch.toString();
    final timestamp = FieldValue.serverTimestamp();

    try {
      // --- CHANGE HERE: Save to 'discussions' collection ---
      final discussionData = {
        'id': discussionId, // Consider if you really need this if using doc ID
        'name': _groupNameController.text.trim(),
        'description': _groupDescriptionController.text.trim(),
        'imageUrl': _groupImage != null ? await _uploadImage(_groupImage!) : '',
        'createdAt': timestamp,
        'createdBy': _currentUserId,
        'admins': [_currentUserId],
        'moderators': [], // Initialize empty moderators list
        'members': [_currentUserId], // Creator is the first member
        'memberCount': 1,
        'lastMessage': '',
        'lastMessageTime': timestamp,
        'lastMessageSender': '',
        'unreadCount': {_currentUserId: 0}, // Initialize unread count for creator
        'category': 'Discussions', // Set category
        'isReadOnly': false,
        'profanityFilter': true,
        'linkRestrictions': false,
        'typing': {},
        'ageRating': _selectedAgeRating,
        'hashtags': _hashtags,
        // Add expiration for discussions if needed
        'expiresAt': Timestamp.fromDate(DateTime.now().add(Duration(days: 7))),
        'isTemporary': true,
      };

      // --- CHANGE HERE: Use 'discussions' collection ---
      await _firestore.collection('discussions').doc(discussionId).set(discussionData);

      // Reset form fields
      _groupNameController.clear();
      _groupDescriptionController.clear();
      _hashtagController.clear();
      setState(() {
        _groupImage = null;
        _isPrivate = false; // Reset privacy if applicable
        _selectedAgeRating = '13-17';
        _hashtags.clear();
      });

      // Navigate to the discussion chat screen
      // --- CHANGE HERE (Potentially): Use DiscussionChatScreen or adapt GroupChatScreen ---
      Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) => DiscussionChatScreen(discussionId: discussionId), // Use DiscussionChatScreen
          // OR if GroupChatScreen handles both:  MaterialPageRoute(builder: (context) => GroupChatScreen(groupId: discussionId, isDiscussion: true)), // Pass flag if needed
        ),
      );

    } catch (e) {
      print("Error creating discussion: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to create discussion. Please try again.')),
      );
    }
  }

  // Inside _GroupsScreenState class
  Future<String?> _uploadImage(File imageFile) async {
    try {
      // Example path - adjust if needed, maybe just 'images' or specific to discussions
      // Consider if this method should be truly generic or specific to context
      final ref = FirebaseStorage.instance
          .ref()
          .child('discussion_images') // Or a more generic 'images' folder
          .child('${Uuid().v4()}.jpg');
      await ref.putFile(imageFile);
      return await ref.getDownloadURL();
    } catch (e) {
      print("Error uploading image: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to upload image. Please try again.')),
      );
      return null;
    }
  }

  @override
  Widget build(BuildContext context) {
    return AnnotatedRegion<SystemUiOverlayStyle>(
      value: SystemUiOverlayStyle.light,
      child: Scaffold(
      appBar: AppBar(
        // --- Modified Title Section ---
        title: Row(
          mainAxisSize: MainAxisSize.min, // Only take as much space as needed
          children: [
            // --- Logo Container (adapted from the first file) ---
          Container(
            width: 42,
            height: 42,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              color: AppColors.elevation,
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.08),
                  blurRadius: 15,
                  offset: const Offset(0, 2),
                ),
              ],
            ),
            child: ClipOval(
              child: Image.asset(
                'assets/default_avatar.png',
                fit: BoxFit.cover,
              ),
            ),
          ),
            // --- Space between logo and text ---
            SizedBox(width: 8), // Adjust spacing if needed
            // --- Original Title Text ---
            Text(
              'Circles',
              style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.textHigh,),
            ),
          ],
        ),
        // --- Keep the rest of your AppBar properties ---
        backgroundColor: Colors.transparent,
        foregroundColor: AppColors.textHigh,
        elevation: 0,
        actions: [
          // --- Add Button ---
          Container(
            width: 42,
            height: 42,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              color: AppColors.elevation,
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.08),
                  blurRadius: 6,
                  offset: const Offset(0, 2),
                ),
              ],
            ),
            child: IconButton(
              icon: const Icon(
                Feather.plus,
                color: AppColors.primaryLavender,
                size: 22, // fits inside 42x42 nicely
              ),
              onPressed: () => _showOptionsModal(),
              tooltip: 'Create New',
            ),
          ),
          const SizedBox(width: 8),

          // --- Search Button ---
          Container(
            width: 42,
            height: 42,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              color: AppColors.elevation,
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.08),
                  blurRadius: 6,
                  offset: const Offset(0, 2),
                ),
              ],
            ),
            child: IconButton(
              icon: const Icon(
                Feather.search,
                color: AppColors.primaryLavender,
                size: 22,
              ),
              onPressed: () {
                Navigator.push(
                  context,
                  MaterialPageRoute(builder: (context) => SearchScreen()),
                );
              },
            ),
          ),
          const SizedBox(width: 8),

          // --- User Avatar ---
          FutureBuilder<DocumentSnapshot>(
            future: _firestore.collection('users').doc(_currentUserId).get(),
            builder: (context, snapshot) {
              Widget avatar;
              if (snapshot.connectionState == ConnectionState.waiting) {
                avatar = Image.asset(
                  'assets/default_avatar.png',
                  fit: BoxFit.cover,
                );
              } else if (!snapshot.hasData || !snapshot.data!.exists) {
                avatar = Image.asset(
                  'assets/default_avatar.png',
                  fit: BoxFit.cover,
                );
              } else {
                final userData = snapshot.data!.data() as Map<String, dynamic>;
                final String profileImage = userData['profileImage'] ?? '';
                avatar = profileImage.isNotEmpty
                    ? Image(
                        image: CachedNetworkImageProvider(profileImage),
                        fit: BoxFit.cover,
                      )
                    : Image.asset(
                        'assets/default_avatar.png',
                        fit: BoxFit.cover,
                      );
              }

              return GestureDetector(
                onTap: () => _showProfileMenu(context),
                child: Container(
                  width: 42,
                  height: 42,
                  decoration: BoxDecoration(
                    shape: BoxShape.circle,
                    color: AppColors.elevation,
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.08),
                        blurRadius: 15,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),
                  child: ClipOval(child: avatar),
                ),
              );
            },
          ),

          const SizedBox(width: 8),
        ],
      ),
        body: RefreshIndicator(
          onRefresh: () async {
            setState(() {});
            await Future.delayed(Duration(seconds: 1));
          },
          color: AppColors.primaryLavender,
          backgroundColor: Colors.transparent,
          child: Column(
            children: [
              // Content Type Selector - ADD THIS SECTION
              Container(
                height: 45,
                child: Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 16),
                  child: ListView.builder(
                    scrollDirection: Axis.horizontal,
                    itemCount: _contentTypes.length,
                    itemBuilder: (context, index) {
                      final type = _contentTypes[index];
                      final isSelected = _selectedContentTypeIndex == index;

                      return GestureDetector(
                        onTap: () {
                          setState(() {
                            _selectedContentTypeIndex = index;
                          });
                        },
                        child: AnimatedContainer(
                          duration: const Duration(milliseconds: 200),
                          curve: Curves.easeInOut,
                          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 6),
                          margin: const EdgeInsets.symmetric(horizontal: 6, vertical: 6),
                          decoration: BoxDecoration(
                            color: isSelected ? AppColors.secondaryTeal : AppColors.elevation,
                            borderRadius: BorderRadius.circular(16),
                            boxShadow: [
                              BoxShadow(
                                color: Colors.black.withOpacity(isSelected ? 0.15 : 0.03),
                                blurRadius: isSelected ? 6 : 4,
                                offset: const Offset(0, 2),
                              ),
                            ],
                          ),
                          child: Center(
                            child: Text(
                              type,
                              style: TextStyle(
                                color: isSelected ? AppColors.textOnSecondary : AppColors.textHigh,
                                fontWeight: isSelected ? FontWeight.bold : FontWeight.w500,
                                fontSize: 14,
                              ),
                            ),
                          ),
                        ),
                      );
                    },
                  ),
                ),
              ),
                            
              // Top 1/4: Pinned/Joined Groups - Fixed height constraint
              Container(
                constraints: BoxConstraints(
                  maxHeight: MediaQuery.of(context).size.height * 0.12,
                ),
                child: StreamBuilder<QuerySnapshot>(
                  stream: _firestore
                      .collection('groups')
                      .where('members', arrayContains: _currentUserId)
                      .orderBy('lastMessageTime', descending: true)
                      .snapshots(),
                  builder: (context, snapshot) {
                    if (snapshot.connectionState == ConnectionState.waiting) {
                      return Center(
                          child: CircularProgressIndicator(color: AppColors.primaryLavender));
                    }
                    if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
                      return Center(
                        child: SingleChildScrollView(
                          physics: const AlwaysScrollableScrollPhysics(),
                          child: Padding(
                            padding: const EdgeInsets.all(16.0),
                            child: Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(Feather.users, size: 20, color: AppColors.textDisabled),
                                const SizedBox(height: 16),
                                Text(
                                  'Join your first group!',
                                  style: TextStyle(
                                    fontSize: 14,
                                    fontWeight: FontWeight.bold,
                                    color: AppColors.textHigh,
                                  ),
                                ),
                                const SizedBox(height: 4),
                                Text(
                                  'Discover communities that matter to you',
                                  textAlign: TextAlign.center,
                                  style: TextStyle(color: AppColors.textDisabled, fontSize: 14),
                                ),
                                const SizedBox(height: 16),
                                ElevatedButton(
                                  onPressed: () => _navigateToGroupCreationScreen(),
                                  child: const Text('Create Group', style: TextStyle(color: AppColors.textOnSecondary)),
                                  style: ElevatedButton.styleFrom(
                                    backgroundColor: AppColors.primaryLavender,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ),
                      );
                    }

                    final joinedGroups = snapshot.data!.docs;

                    return SizedBox(
                      height: 120,
                      child: ListView.builder(
                        scrollDirection: Axis.horizontal,
                        itemCount: joinedGroups.length,
                        padding: const EdgeInsets.symmetric(horizontal: 12),
                        itemBuilder: (context, index) {
                          final group = joinedGroups[index];
                          final groupData = group.data() as Map<String, dynamic>;
                          final String groupId = group.id;
                          final String groupName = groupData['name'] ?? '';
                          final String groupImage = groupData['imageUrl'] ?? '';
                          final Map<String, dynamic> unreadCountMap =
                              groupData['unreadCount'] ?? {};
                          final int unreadCount =
                              unreadCountMap[_currentUserId] ?? 0;
                          final bool hasNewMessages = unreadCount > 0;

                          final Timestamp? lastMessageTime =
                              groupData['lastMessageTime'];
                          final String lastMessage =
                              groupData['lastMessage'] ?? '';
                          final String lastMessageSender =
                              groupData['lastMessageSender'] ?? '';
                          String displayMessage = lastMessage;
                          if (lastMessageSender == _currentUserId) {
                            displayMessage = "You: $lastMessage";
                          } else if (lastMessageSender.isNotEmpty) {
                            displayMessage = "Someone: $lastMessage";
                          }

                          String timeString = '';
                          if (lastMessageTime != null) {
                            final now = DateTime.now();
                            final messageDate = lastMessageTime.toDate();
                            if (now.difference(messageDate).inDays < 1) {
                              timeString = DateFormat.Hm().format(messageDate);
                            } else {
                              timeString = DateFormat.MMMd().format(messageDate);
                            }
                          }

                          return GestureDetector(
                            onTap: () {
                              Navigator.push(
                                context,
                                MaterialPageRoute(
                                  builder: (context) =>
                                      GroupChatScreen(groupId: groupId),
                                ),
                              );
                            },
                            child: Container(
                              width: 260,
                              margin: const EdgeInsets.symmetric(horizontal: 8, vertical: 6),
                              padding: const EdgeInsets.all(12),
                              decoration: BoxDecoration(
                                color: AppColors.surface,
                                borderRadius: BorderRadius.circular(24),
                                boxShadow: [
                                  BoxShadow(
                                    color: Colors.black.withOpacity(0.05),
                                    blurRadius: 6,
                                    offset: const Offset(0, 3),
                                  ),
                                ],
                              ),
                              child: Row(
                                children: [
                                  // Group image
                                  Container(
                                    width: 50,
                                    height: 50,
                                    decoration: BoxDecoration(
                                      shape: BoxShape.circle,
                                      color: AppColors.elevation,
                                      boxShadow: [
                                        BoxShadow(
                                          color: Colors.black.withOpacity(0.08),
                                          blurRadius: 4,
                                          offset: const Offset(0, 2),
                                        ),
                                      ],
                                    ),
                                    child: ClipOval(
                                      child: groupImage.isNotEmpty
                                          ? Image(
                                              image: CachedNetworkImageProvider(groupImage),
                                              fit: BoxFit.cover,
                                            )
                                          : Image.asset(
                                              'assets/default_avatar.png',
                                              fit: BoxFit.cover,
                                            ),
                                    ),
                                  ),
                                  const SizedBox(width: 12),

                                  // Name + last message
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      mainAxisAlignment: MainAxisAlignment.center,
                                      children: [
                                        Text(
                                          groupName,
                                          style: TextStyle(
                                            fontWeight: FontWeight.w600,
                                            fontSize: 16,
                                            color: AppColors.primaryLavender,
                                          ),
                                          maxLines: 1,
                                          overflow: TextOverflow.ellipsis,
                                        ),
                                        const SizedBox(height: 4),
                                        Text(
                                          displayMessage,
                                          style: TextStyle(
                                            fontSize: 14,
                                            color: AppColors.textMedium,
                                          ),
                                          maxLines: 1,
                                          overflow: TextOverflow.ellipsis,
                                        ),
                                      ],
                                    ),
                                  ),

                                  // Time + unread badge
                                  Column(
                                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                    crossAxisAlignment: CrossAxisAlignment.end,
                                    children: [
                                      Text(
                                        timeString,
                                        style: TextStyle(
                                          fontSize: 12,
                                          color: AppColors.textMedium,
                                        ),
                                      ),
                                      if (hasNewMessages)
                                        Container(
                                          margin: const EdgeInsets.only(top: 6),
                                          padding: const EdgeInsets.all(6),
                                          decoration: BoxDecoration(
                                            color: AppColors.primaryLavender,
                                            shape: BoxShape.circle,
                                          ),
                                          constraints: const BoxConstraints(
                                            minWidth: 20,
                                            minHeight: 20,
                                          ),
                                          child: Center(
                                            child: Text(
                                              unreadCount > 99 ? '99+' : '$unreadCount',
                                              style: const TextStyle(
                                                color: AppColors.textOnSecondary,
                                                fontSize: 12,
                                                fontWeight: FontWeight.bold,
                                              ),
                                              textAlign: TextAlign.center,
                                            ),
                                          ),
                                        ),
                                    ],
                                  ),
                                ],
                              ),
                            ),
                          );
                        },
                      ),
                    );
                  },
                ),
              ),

              // Main Content Area - Show different content based on selection
              Expanded(
                child: _buildContentForSelectedType(),
              ),
            ],
          ),
        ),
      ),
    );
  }

  // --- Update this existing method ---
  Widget _buildContentForSelectedType() {
    switch (_currentContentType) {
      case 'All': // Add this case
        return _buildAllTab();
      case 'Polls':
        return _buildPollsTab();
      case 'Discussions':
      return _buildDiscussionsTab(); // Or keep if you want a dedicated Discussions tab too
    case 'Archived':
      return _buildArchivedTab();
    case 'Groups':
        return _buildGroupsTab();
      case 'Petitions':
        return _buildPetitionsTab();
      default:
        // It's good practice to handle the default, even if 'All' is now default.
        // You might want to return _buildAllTab() here as well, or an error widget.
        return _buildAllTab(); // Redirect unknown/default to All
    }
  }
  // --- End of update ---
}


// --- New Group Creation Screen ---
class GroupCreationScreen extends StatefulWidget {
  @override
  _GroupCreationScreenState createState() => _GroupCreationScreenState();
}

class _GroupCreationScreenState extends State<GroupCreationScreen> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseStorage _storage = FirebaseStorage.instance;

  final TextEditingController _groupNameController = TextEditingController();
  final TextEditingController _groupDescriptionController = TextEditingController();
  final TextEditingController _hashtagController = TextEditingController();

  String _selectedCategory = 'All';
  bool _isPrivate = false;
  File? _groupImage;
  String _selectedAgeRating = '13-17';
  final List<String> _ageRatings = ['13-17', '18-25', '26+'];
  List<String> _hashtags = [];
  
  bool _isLoading = false;
  late String _currentUserId;

  final List<String> _categories = [
    'All', 'Polls', 'Discussions', 'Groups', 'Mentorship', 'Petitions'
  ];

  @override
  void initState() {
    super.initState();
    _currentUserId = _auth.currentUser!.uid;
  }

  Future<void> _pickGroupImage() async {
    final pickedFile = await ImagePicker().pickImage(source: ImageSource.gallery);
    if (pickedFile != null) {
      setState(() {
        _groupImage = File(pickedFile.path);
      });
    }
  }

  Future<String?> _uploadGroupImage() async {
    if (_groupImage == null) return null;
    try {
      final ref = _storage.ref().child('group_images').child('${Uuid().v4()}.jpg');
      await ref.putFile(_groupImage!);
      return await ref.getDownloadURL();
    } catch (e) {
      print("Error uploading group image: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to upload image. Please try again.')),
      );
      return null;
    }
  }

  Future<void> _createGroup() async {
    if (_groupNameController.text.trim().isEmpty || 
        _groupDescriptionController.text.trim().isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Title and Description are required.')),
      );
      return;
    }

    final groupName = _groupNameController.text.trim();
    final groupDescription = _groupDescriptionController.text.trim();

    setState(() {
      _isLoading = true;
    });

    try {
      final imageUrl = await _uploadGroupImage();
      final groupId = Uuid().v4();
      final timestamp = FieldValue.serverTimestamp();
      
      final groupData = {
        'id': groupId,
        'name': groupName,
        'description': groupDescription,
        'imageUrl': imageUrl ?? '',
        'isPrivate': _isPrivate,
        'createdBy': _currentUserId,
        'createdAt': timestamp,
        'members': [_currentUserId],
        'admins': [_currentUserId],
        'moderators': [],
        'memberCount': 1,
        'lastMessage': '',
        'lastMessageTime': timestamp,
        'lastMessageSender': '',
        'unreadCount': {_currentUserId: 0},
        'category': _selectedCategory != 'All' ? _selectedCategory : 'General',
        'isReadOnly': false,
        'profanityFilter': true,
        'linkRestrictions': false,
        'typing': {},
        'ageRating': _selectedAgeRating,
        'hashtags': _hashtags,
      };

      // Add expiration for discussions
      if (_selectedCategory == 'Discussions') {
        final expiresAt = DateTime.now().add(Duration(days: 7));
        groupData['expiresAt'] = Timestamp.fromDate(expiresAt);
        groupData['isTemporary'] = true;
      }

      await _firestore.collection('groups').doc(groupId).set(groupData);

      // Show success and navigate back
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Group created successfully!')),
      );

      // Navigate to the new group chat
      Navigator.pushReplacement(
        context,
        MaterialPageRoute(
          builder: (context) => GroupChatScreen(groupId: groupId),
        ),
      );

    } catch (e) {
      print("Error creating group: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to create group. Please try again.')),
      );
    } finally {
      setState(() {
        _isLoading = false;
      });
    }
  }

  Widget _buildSectionHeader(String title, IconData icon) {
    return Row(
      children: [
        Container(
          width: 30,
          height: 30,
          decoration: BoxDecoration(
            color: AppColors.primaryLavender.withOpacity(0.1),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Icon(icon, size: 18, color: AppColors.primaryLavender),
        ),
        SizedBox(width: 10),
        Text(
          title,
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w600,
            color: AppColors.textHigh,
          ),
        ),
      ],
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: Text(
          'Create New Group ',
          style: TextStyle(
            fontWeight: FontWeight.bold,
            fontSize: 20,
            letterSpacing: 0.5,
            color: AppColors.textHigh,
          ),
        ),
        backgroundColor: Colors.transparent,
        elevation: 0,
        centerTitle: true,
        leading: IconButton(
          icon: Icon(Feather.arrow_left, color: AppColors.textHigh),
          onPressed: () => Navigator.pop(context),
        ),
      ),
      body: Padding(
        padding: EdgeInsets.all(18.0),
        child: SingleChildScrollView(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Header Section with curved edges
              Container(
                width: double.infinity,
                padding: EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: AppColors.surface,
                  borderRadius: BorderRadius.circular(18),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.1),
                      blurRadius: 10,
                      offset: Offset(0, 4),
                    ),
                  ],
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Icon(Feather.users, color: AppColors.primaryLavender, size: 24),
                        SizedBox(width: 10),
                        Text(
                          'Create Your Community',
                          style: TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.w600,
                            color: AppColors.textHigh,
                          ),
                        ),
                      ],
                    ),
                    SizedBox(height: 8),
                    Text(
                      'Fill in the details below to create your group and start connecting!',
                      style: TextStyle(
                        color: AppColors.textMedium,
                        fontSize: 14,
                      ),
                    ),
                  ],
                ),
              ),
              SizedBox(height: 24),

              // Group Image
              _buildSectionHeader('Group Image', Feather.camera),
              SizedBox(height: 8),
              Center(
                child: GestureDetector(
                  onTap: _pickGroupImage,
                  child: Container(
                    height: 150,
                    width: double.infinity,
                    decoration: BoxDecoration(
                      color: AppColors.elevation,
                      borderRadius: BorderRadius.circular(18),
                      border: Border.all(color: AppColors.primaryLavender),
                      image: _groupImage != null
                          ? DecorationImage(
                              image: FileImage(_groupImage!),
                              fit: BoxFit.cover,
                            )
                          : null,
                    ),
                    child: _groupImage == null
                        ? Center(
                            child: Column(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Icon(Feather.image, size: 40, color: AppColors.primaryLavender),
                                SizedBox(height: 6),
                                Text(
                                  "Upload Group Image",
                                  style: TextStyle(color: AppColors.primaryLavender),
                                ),
                              ],
                            ),
                          )
                        : null,
                  ),
                ),
              ),
              SizedBox(height: 20),

              // Group Title
              _buildSectionHeader('Group Title', Feather.type),
              SizedBox(height: 8),
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.05),
                      blurRadius: 5,
                      offset: Offset(0, 2),
                    ),
                  ],
                ),
child: TextField(
  controller: _groupNameController,
  // Combined the color and fontSize into one style argument
  style: TextStyle(
    color: AppColors.textHigh,
    fontSize: 16,
  ),
  decoration: InputDecoration(
    labelText: 'Enter group name',
    labelStyle: TextStyle(color: AppColors.textMedium),
    border: OutlineInputBorder(
      borderRadius: BorderRadius.circular(12),
      borderSide: BorderSide.none,
    ),
    filled: true,
    fillColor: AppColors.elevation,
    prefixIcon: Icon(Feather.edit_2, color: AppColors.primaryLavender),
    contentPadding: EdgeInsets.symmetric(horizontal: 20, vertical: 16),
  ),
),
              ),
              SizedBox(height: 20),

              // Description
              _buildSectionHeader('Description', Feather.align_left),
              SizedBox(height: 8),
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.05),
                      blurRadius: 5,
                      offset: Offset(0, 2),
                    ),
                  ],
                ),
child: TextField(
  controller: _groupDescriptionController,
  // Combined both style properties here
  style: TextStyle(
    color: AppColors.textHigh,
    fontSize: 16,
  ),
  decoration: InputDecoration(
    labelText: 'Describe your group...',
    labelStyle: TextStyle(color: AppColors.textMedium),
    border: OutlineInputBorder(
      borderRadius: BorderRadius.circular(12),
      borderSide: BorderSide.none,
    ),
    filled: true,
    fillColor: AppColors.elevation,
    alignLabelWithHint: true,
    contentPadding: EdgeInsets.all(20),
  ),
  maxLines: 4,
),
              ),
              SizedBox(height: 20),

              // Age Rating
              _buildSectionHeader('Age Rating', Feather.users),
              SizedBox(height: 8),
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.05),
                      blurRadius: 5,
                      offset: Offset(0, 2),
                    ),
                  ],
                ),
                child: DropdownButtonFormField<String>(
                  value: _selectedAgeRating,
                  items: _ageRatings.map((rating) {
                    return DropdownMenuItem<String>(
                      value: rating,
                      child: Text(rating, style: TextStyle(color: AppColors.textHigh)),
                    );
                  }).toList(),
                  onChanged: (value) {
                    setState(() {
                      _selectedAgeRating = value!;
                    });
                  },
                  decoration: InputDecoration(
                    labelText: 'Who should see this group?',
                    labelStyle: TextStyle(color: AppColors.textMedium),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: BorderSide.none,
                    ),
                    filled: true,
                    fillColor: AppColors.elevation,
                    prefixIcon: Icon(Feather.users, color: AppColors.primaryLavender),
                    contentPadding: EdgeInsets.symmetric(horizontal: 20),
                  ),
                  dropdownColor: AppColors.surface,
                  style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                ),
              ),
              SizedBox(height: 20),

              // Hashtags
              _buildSectionHeader('Hashtags', Feather.hash),
              SizedBox(height: 8),
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.05),
                      blurRadius: 5,
                      offset: Offset(0, 2),
                    ),
                  ],
                ),
                child: TextField(
                  controller: _hashtagController,
                  style: TextStyle(color: AppColors.textHigh),
                  decoration: InputDecoration(
                    labelText: 'Add relevant hashtags',
                    labelStyle: TextStyle(color: AppColors.textMedium),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: BorderSide.none,
                    ),
                    filled: true,
                    fillColor: AppColors.elevation,
                    prefixIcon: Icon(Feather.hash, color: AppColors.primaryLavender),
                    suffixIcon: IconButton(
                      icon: Container(
                        width: 32,
                        height: 32,
                        decoration: BoxDecoration(
                          color: AppColors.primaryLavender,
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Icon(Feather.plus, color: AppColors.textOnSecondary, size: 18),
                      ),
                      onPressed: () {
                        String newTag = _hashtagController.text.trim().replaceAll('#', '');
                        if (newTag.isNotEmpty && !_hashtags.contains(newTag)) {
                          setState(() {
                            _hashtags.add(newTag);
                          });
                          _hashtagController.clear();
                        }
                      },
                    ),
                    contentPadding: EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                  ),
                  onSubmitted: (_) {
                    String newTag = _hashtagController.text.trim().replaceAll('#', '');
                    if (newTag.isNotEmpty && !_hashtags.contains(newTag)) {
                      setState(() {
                        _hashtags.add(newTag);
                      });
                      _hashtagController.clear();
                    }
                  },
                ),
              ),
              SizedBox(height: 12),

              // Display added hashtags
              if (_hashtags.isNotEmpty)
                Wrap(
                  spacing: 8.0,
                  runSpacing: 8.0,
                  children: _hashtags.map((tag) {
                    return Container(
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          colors: [AppColors.primaryLavender.withOpacity(0.2), AppColors.primaryLavender.withOpacity(0.1)],
                        ),
                        borderRadius: BorderRadius.circular(20),
                      ),
                      child: Padding(
                        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Text(
                              '#$tag',
                              style: TextStyle(
                                color: AppColors.primaryLavender,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                            SizedBox(width: 4),
                            GestureDetector(
                              onTap: () {
                                setState(() {
                                  _hashtags.remove(tag);
                                });
                              },
                              child: Icon(Feather.x, size: 16, color: AppColors.primaryLavender),
                            ),
                          ],
                        ),
                      ),
                    );
                  }).toList(),
                ),
              SizedBox(height: 20),

              // Privacy Setting
              Container(
                decoration: BoxDecoration(
                  color: AppColors.surface,
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.05),
                      blurRadius: 5,
                      offset: Offset(0, 2),
                    ),
                  ],
                ),
                child: SwitchListTile(
                  title: Text(
                    'Private Group',
                    style: TextStyle(
                      fontWeight: FontWeight.w600,
                      color: AppColors.textHigh,
                    ),
                  ),
                  subtitle: Text('Only invited members can join (Coming Soon)', style: TextStyle(color: AppColors.textMedium)),
                  value: _isPrivate,
                  onChanged: (value) {
                    setState(() {
                      _isPrivate = value;
                    });
                  },
                  secondary: Container(
                    width: 30,
                    height: 30,
                    decoration: BoxDecoration(
                      color: AppColors.primaryLavender.withOpacity(0.1),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Icon(Feather.lock, size: 18, color: AppColors.primaryLavender),
                  ),
                  activeColor: AppColors.primaryLavender,
                ),
              ),
              SizedBox(height: 30),

              // Create Group Button
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(14),
                  boxShadow: [
                    BoxShadow(
                      color: AppColors.primaryLavender.withOpacity(0.3),
                      blurRadius: 10,
                      offset: Offset(0, 4),
                    ),
                  ],
                ),
                child: ElevatedButton(
                  onPressed: _isLoading ? null : _createGroup,
                  style: ElevatedButton.styleFrom(
                    minimumSize: Size(double.infinity, 55),
                    backgroundColor: AppColors.primaryLavender,
                    foregroundColor: AppColors.textOnSecondary,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(14),
                    ),
                    elevation: 0,
                  ),
                  child: _isLoading 
                      ? SizedBox(
                          height: 20,
                          width: 20,
                          child: CircularProgressIndicator(
                            strokeWidth: 2,
                            color: AppColors.textOnSecondary,
                          ),
                        )
                      : Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(Feather.user_plus, size: 20),
                            SizedBox(width: 8),
                            Text(
                              'Create Group',
                              style: TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                          ],
                        ),
                ),
              ),
              SizedBox(height: 20),
            ],
          ),
        ),
      ),
    );
  }
}


// Ensure these variables exist in _GroupChatScreenState
// bool _isMember = false;
// bool _isReadOnly = false;
// And that _sendMessage is implemented to handle files.

void _showProfileMenu(BuildContext context) {
  Navigator.push(
    context,
    MaterialPageRoute(
      builder: (context) => ProfileScreen(
        userId: FirebaseAuth.instance.currentUser!.uid,
      ),
    ),
  );
}

class GroupViewScreen extends StatefulWidget {
  final String groupId;
  final VoidCallback? onJoinSuccess;
  const GroupViewScreen({
    Key? key, 
    required this.groupId, 
    this.onJoinSuccess
  }) : super(key: key);

  @override
  _GroupViewScreenState createState() => _GroupViewScreenState();
}

class _GroupViewScreenState extends State<GroupViewScreen> {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  late String _currentUserId;
  late DocumentReference _groupDocRef;
  bool _isMember = false;
  bool _isAdmin = false;
  bool _isModerator = false;
  bool _isJoining = false;
  List<QueryDocumentSnapshot> _recentMessages = [];

  @override
  void initState() {
    super.initState();
    _currentUserId = _auth.currentUser!.uid;
    _groupDocRef = _firestore.collection('groups').doc(widget.groupId);
    _checkMembership();
    _loadRecentMessages(); // Load recent messages for preview
  }

  Future<void> _checkMembership() async {
    final groupDoc = await _groupDocRef.get();
    if (groupDoc.exists) {
      final groupData = groupDoc.data() as Map<String, dynamic>;
      final List<dynamic> members = groupData['members'] ?? [];
      final List<dynamic> admins = groupData['admins'] ?? [];
      final List<dynamic> moderators = groupData['moderators'] ?? [];
      setState(() {
        _isMember = members.contains(_currentUserId);
        _isAdmin = admins.contains(_currentUserId);
        _isModerator = moderators.contains(_currentUserId);
      });
    }
  }

  // NEW: Load recent messages for preview
  Future<void> _loadRecentMessages() async {
    try {
      final messagesSnapshot = await _groupDocRef
          .collection('messages')
          .orderBy('timestamp', descending: true)
          .limit(20)
          .get();
      
      setState(() {
        _recentMessages = messagesSnapshot.docs;
      });
    } catch (e) {
      print("Error loading recent messages: $e");
    }
  }

  Future<void> _joinGroup() async {
    if (_isJoining || _isMember) return;
    
    setState(() {
      _isJoining = true;
    });

    try {
      await _groupDocRef.update({
        'members': FieldValue.arrayUnion([_currentUserId]),
        'memberCount': FieldValue.increment(1),
        'unreadCount.$_currentUserId': 0,
      });

      setState(() {
        _isMember = true;
        _isJoining = false;
      });

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Joined group successfully')),
      );

      if (widget.onJoinSuccess != null) {
        widget.onJoinSuccess!();
      }
    } catch (e) {
      print("Error joining group: $e");
      setState(() {
        _isJoining = false;
      });
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to join group. Please try again.')),
      );
    }
  }

  // NEW: Build message preview UI
  Widget _buildMessagePreview(Map<String, dynamic> messageData, bool isMe) {
    final String text = messageData['text'] ?? '';
    final String type = messageData['type'] ?? 'text';
    final String senderId = messageData['senderId'];
    final Timestamp? timestamp = messageData['timestamp'];
    final DateTime? messageTime = timestamp?.toDate();

    return FutureBuilder<Map<String, dynamic>>(
      future: UserProfileCache.getUserProfile(senderId),
      builder: (context, userSnapshot) {
        String userName = 'User';
        String userProfileImage = '';
        if (userSnapshot.hasData) {
          final userData = userSnapshot.data!;
          userName = userData['name'] ?? 'User';
          userProfileImage = userData['profileImage'] ?? '';
        }

        bool isActuallyMe = senderId == _currentUserId;

        return Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
          child: Row(
            mainAxisAlignment: isActuallyMe ? MainAxisAlignment.end : MainAxisAlignment.start,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              if (!isActuallyMe)
                CircleAvatar(
                  radius: 14,
                  backgroundColor: AppColors.elevation,
                  backgroundImage: userProfileImage.isNotEmpty ? CachedNetworkImageProvider(userProfileImage) : null,
                  child: userProfileImage.isEmpty ? Icon(Feather.user, size: 14, color: AppColors.textDisabled) : null,
                ),
              if (!isActuallyMe) SizedBox(width: 8),
              Flexible(
                child: Column(
                  crossAxisAlignment: isActuallyMe ? CrossAxisAlignment.end : CrossAxisAlignment.start,
                  children: [
                    if (!isActuallyMe)
                      Padding(
                        padding: const EdgeInsets.only(left: 4, bottom: 2),
                        child: Text(userName, style: TextStyle(fontSize: 11, fontWeight: FontWeight.bold, color: AppColors.textMedium)),
                      ),
                    Container(
                      padding: EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                      decoration: BoxDecoration(
                        color: isActuallyMe ? AppColors.primaryLavender : AppColors.elevation,
                        borderRadius: BorderRadius.only(
                          topLeft: Radius.circular(16),
                          topRight: Radius.circular(16),
                          bottomLeft: Radius.circular(isActuallyMe ? 16 : 4),
                          bottomRight: Radius.circular(isActuallyMe ? 4 : 16),
                        ),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          if (type == 'image')
                            ClipRRect(
                              borderRadius: BorderRadius.circular(8),
                              child: CachedNetworkImage(
                                imageUrl: messageData['imageUrl'],
                                width: 200,
                                fit: BoxFit.cover,
                              ),
                            )
                          else if (type == 'audio')
                            Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Icon(Feather.mic, size: 16, color: isActuallyMe ? Colors.white : AppColors.primaryLavender),
                                SizedBox(width: 8),
                                Text('Voice message', style: TextStyle(color: isActuallyMe ? Colors.white : AppColors.textHigh, fontSize: 13)),
                              ],
                            )
                          else
                            Text(text, style: TextStyle(color: isActuallyMe ? Colors.white : AppColors.textHigh, fontSize: 14)),
                          SizedBox(height: 2),
                          Text(
                            messageTime != null ? DateFormat.Hm().format(messageTime) : '',
                            style: TextStyle(fontSize: 9, color: isActuallyMe ? Colors.white.withOpacity(0.7) : AppColors.textDisabled),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    return AnnotatedRegion<SystemUiOverlayStyle>(
      value: SystemUiOverlayStyle.light,
      child: Scaffold(
        appBar: AppBar(
          title: StreamBuilder<DocumentSnapshot>(
            stream: _groupDocRef.snapshots(),
            builder: (context, snapshot) {
              if (!snapshot.hasData) return Text('Group', style: TextStyle(color: AppColors.textHigh));
              final groupData = snapshot.data!.data() as Map<String, dynamic>?;
              return Text(groupData?['name'] ?? 'Group', style: TextStyle(color: AppColors.textHigh));
            },
          ),
          backgroundColor: Colors.transparent,
          foregroundColor: AppColors.textHigh,
          elevation: 0,
          actions: [
            if (!_isMember)
              Padding(
                padding: EdgeInsets.only(right: 16),
                child: _isJoining
                    ? Padding(
                        padding: EdgeInsets.all(8.0),
                        child: SizedBox(
                          width: 20,
                          height: 20,
                          child: CircularProgressIndicator(
                            strokeWidth: 2,
                            color: AppColors.primaryLavender,
                          ),
                        ),
                      )
                    : TextButton(
                        onPressed: _joinGroup,
                        child: Text('JOIN',
                            style: TextStyle(
                                color: AppColors.textOnSecondary, 
                                fontWeight: FontWeight.bold)),
                        style: TextButton.styleFrom(
                          backgroundColor: AppColors.primaryLavender,
                          padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                          shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(20)),
                        ),
                      ),
              ),
            // NEW: Three-dot menu replacement for info button
            PopupMenuButton<String>(
              icon: Icon(Feather.more_vertical, color: AppColors.textHigh),
              onSelected: (value) {
                // Handle menu selection
                if (value == 'info') {
                  // Show group info
                } else if (value == 'media') {
                  // Show group media
                } else if (value == 'search') {
                  // Show search
                }
              },
              itemBuilder: (BuildContext context) {
                return [
                  PopupMenuItem<String>(
                    value: 'info',
                    child: ListTile(
                      leading: Icon(Feather.info, color: AppColors.primaryLavender),
                      title: Text('Group Info', style: TextStyle(color: AppColors.textHigh)),
                    ),
                  ),
                  PopupMenuItem<String>(
                    value: 'media',
                    child: ListTile(
                      leading: Icon(Feather.image, color: AppColors.primaryLavender),
                      title: Text('Group Media', style: TextStyle(color: AppColors.textHigh)),
                    ),
                  ),
                  PopupMenuItem<String>(
                    value: 'search',
                    child: ListTile(
                      leading: Icon(Feather.search, color: AppColors.primaryLavender),
                      title: Text('Search', style: TextStyle(color: AppColors.textHigh)),
                    ),
                  ),
                ];
              },
            ),
          ],
        ),
        body: _isMember 
            ? GroupChatScreen(groupId: widget.groupId)
            : StreamBuilder<DocumentSnapshot>(
                stream: _groupDocRef.snapshots(),
                builder: (context, snapshot) {
                  if (!snapshot.hasData) return Center(child: CircularProgressIndicator(color: AppColors.primaryLavender));
                  
                  final groupData = snapshot.data!.data() as Map<String, dynamic>?;
                  if (groupData == null) return Center(child: Text('Group not found'));

                  final String description = groupData['description'] ?? '';
                  final List<dynamic> hashtags = groupData['hashtags'] ?? [];
                  final Map<String, dynamic> ratings = groupData['ratings'] ?? {};
                  
                  double averageRating = 0;
                  if (ratings.isNotEmpty) {
                    averageRating = ratings.values.map((v) => (v as num).toDouble()).reduce((a, b) => a + b) / ratings.length;
                  }

                  return Column(
                    children: [
                      // Enhanced Preview Header
                      Container(
                        padding: EdgeInsets.all(20),
                        margin: EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          color: AppColors.surface.withOpacity(0.8),
                          borderRadius: BorderRadius.circular(24),
                          border: Border.all(color: AppColors.primaryLavender.withOpacity(0.1)),
                          boxShadow: [
                            BoxShadow(
                              color: Colors.black.withOpacity(0.1),
                              blurRadius: 20,
                              offset: Offset(0, 10),
                            ),
                          ],
                        ),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Container(
                                  padding: EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                                  decoration: BoxDecoration(
                                    color: AppColors.primaryLavender.withOpacity(0.1),
                                    borderRadius: BorderRadius.circular(8),
                                  ),
                                  child: Text('PREVIEW MODE', 
                                    style: TextStyle(fontSize: 10, fontWeight: FontWeight.w900, color: AppColors.primaryLavender, letterSpacing: 1.2)),
                                ),
                                Spacer(),
                                if (averageRating > 0)
                                  Row(
                                    children: [
                                      Icon(Icons.star_rounded, color: AppColors.accentMustard, size: 18),
                                      SizedBox(width: 4),
                                      Text(averageRating.toStringAsFixed(1), 
                                        style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold, fontSize: 14)),
                                      Text(' (${ratings.length})', 
                                        style: TextStyle(color: AppColors.textDisabled, fontSize: 12)),
                                    ],
                                  ),
                              ],
                            ),
                            SizedBox(height: 16),
                            if (description.isNotEmpty)
                              Text(description, 
                                style: TextStyle(color: AppColors.textHigh, fontSize: 15, height: 1.5, fontWeight: FontWeight.w500)),
                            if (hashtags.isNotEmpty) ...[
                              SizedBox(height: 16),
                              Wrap(
                                spacing: 8,
                                runSpacing: 8,
                                children: hashtags.map((tag) => Container(
                                  padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                                  decoration: BoxDecoration(
                                    gradient: LinearGradient(
                                      colors: [AppColors.primaryLavender.withOpacity(0.15), AppColors.primaryLavender.withOpacity(0.05)],
                                    ),
                                    borderRadius: BorderRadius.circular(12),
                                    border: Border.all(color: AppColors.primaryLavender.withOpacity(0.1)),
                                  ),
                                  child: Text('#$tag', 
                                    style: TextStyle(color: AppColors.primaryLavender, fontSize: 12, fontWeight: FontWeight.bold)),
                                )).toList(),
                              ),
                            ],
                            SizedBox(height: 20),
                            Container(
                              width: double.infinity,
                              padding: EdgeInsets.symmetric(vertical: 12),
                              decoration: BoxDecoration(
                                color: AppColors.elevation.withOpacity(0.5),
                                borderRadius: BorderRadius.circular(12),
                              ),
                              child: Center(
                                child: Row(
                                  mainAxisSize: MainAxisSize.min,
                                  children: [
                                    Icon(Feather.info, size: 14, color: AppColors.textDisabled),
                                    SizedBox(width: 8),
                                    Text('Join to participate in the conversation', 
                                      style: TextStyle(color: AppColors.textDisabled, fontSize: 13, fontWeight: FontWeight.w500)),
                                  ],
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                      // Chat Preview Area
                      Expanded(
                        child: Container(
                          decoration: BoxDecoration(
                            // Optional: Add a subtle background pattern or color to match the chat
                          ),
                          child: ListView.builder(
                            reverse: true, // Show most recent at bottom
                            padding: EdgeInsets.symmetric(vertical: 16),
                            itemCount: _recentMessages.length,
                            itemBuilder: (context, index) {
                              final message = _recentMessages[index];
                              final messageData = message.data() as Map<String, dynamic>;
                              return _buildMessagePreview(messageData, false);
                            },
                          ),
                        ),
                      ),
                    ],
                  );
                },
              ),
      ),
    );
  }
}

// NEW: Group Info Screen Widget
class GroupInfoScreen extends StatefulWidget {
  final String groupId;

  const GroupInfoScreen({Key? key, required this.groupId}) : super(key: key);

  @override
  _GroupInfoScreenState createState() => _GroupInfoScreenState();
}

class _GroupInfoScreenState extends State<GroupInfoScreen> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  late String _currentUserId;
  bool _isAdmin = false;

  @override
  void initState() {
    super.initState();
    _currentUserId = _auth.currentUser!.uid;
    _checkAdminStatus();
  }

  Future<void> _checkAdminStatus() async {
    final groupDoc = await _firestore.collection('groups').doc(widget.groupId).get();
    if (groupDoc.exists) {
      final groupData = groupDoc.data() as Map<String, dynamic>;
      final List<dynamic> admins = groupData['admins'] ?? [];
      setState(() {
        _isAdmin = admins.contains(_currentUserId);
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: Text('Group Info', style: TextStyle(color: AppColors.textHigh)),
        backgroundColor: Colors.transparent,
        foregroundColor: AppColors.textHigh,
        elevation: 0,
      ),
      body: StreamBuilder<DocumentSnapshot>(
        stream: _firestore.collection('groups').doc(widget.groupId).snapshots(),
        builder: (context, snapshot) {
          if (!snapshot.hasData) {
            return Center(child: CircularProgressIndicator(color: AppColors.primaryLavender));
          }

          final groupData = snapshot.data!.data() as Map<String, dynamic>;
          final String groupName = groupData['name'] ?? '';
          final String groupImage = groupData['imageUrl'] ?? '';
          final String description = groupData['description'] ?? '';
          final List<dynamic> members = groupData['members'] ?? [];
          final List<dynamic> admins = groupData['admins'] ?? [];
          final List<dynamic> hashtags = groupData['hashtags'] ?? [];
          final Map<String, dynamic> ratings = groupData['ratings'] ?? {};
          
          double averageRating = 0;
          if (ratings.isNotEmpty) {
            averageRating = ratings.values.map((v) => (v as num).toDouble()).reduce((a, b) => a + b) / ratings.length;
          }
          final double myRating = (ratings[_currentUserId] ?? 0).toDouble();

          return ListView(
            padding: EdgeInsets.all(16),
            children: [
              // Group Header
              Center(
                child: Column(
                  children: [
                    CircleAvatar(
                      radius: 50,
                      backgroundColor: AppColors.elevation,
                      backgroundImage: groupImage.isNotEmpty
                          ? CachedNetworkImageProvider(groupImage)
                          : AssetImage('assets/default_avatar.png',) as ImageProvider,
                    ),
                    SizedBox(height: 16),
                    Text(
                      groupName,
                      style: TextStyle(
                        fontSize: 24,
                        fontWeight: FontWeight.bold,
                        color: AppColors.primaryLavender,
                      ),
                    ),
                    if (description.isNotEmpty) ...[
                      SizedBox(height: 8),
                      Text(
                        description,
                        textAlign: TextAlign.center,
                        style: TextStyle(color: AppColors.textMedium),
                      ),
                    ],
                    if (hashtags.isNotEmpty) ...[
                      SizedBox(height: 8),
                      Wrap(
                        spacing: 8,
                        children: hashtags.map((tag) => Text('#$tag', style: TextStyle(color: AppColors.primaryLavender, fontSize: 12))).toList(),
                      ),
                    ],
                  ],
                ),
              ),
              
              SizedBox(height: 24),

              // Rating Section
              _buildSectionHeader('Rating'),
              Card(
                color: AppColors.surface,
                child: Padding(
                  padding: EdgeInsets.all(16),
                  child: Column(
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(Feather.star, color: Colors.amber, size: 24),
                          SizedBox(width: 8),
                          Text(
                            averageRating > 0 ? averageRating.toStringAsFixed(1) : 'No ratings yet',
                            style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: AppColors.textHigh),
                          ),
                          if (ratings.isNotEmpty) ...[
                            SizedBox(width: 8),
                            Text('(${ratings.length})', style: TextStyle(color: AppColors.textDisabled)),
                          ],
                        ],
                      ),
                      SizedBox(height: 16),
                      Text('Your Rating', style: TextStyle(color: AppColors.textMedium, fontSize: 14)),
                      Slider(
                        value: myRating > 0 ? myRating : 5.0,
                        min: 1.0,
                        max: 10.0,
                        divisions: 9,
                        activeColor: AppColors.primaryLavender,
                        inactiveColor: AppColors.elevation,
                        label: (myRating > 0 ? myRating : 5.0).round().toString(),
                        onChanged: (value) {
                          _updateRating(value);
                        },
                      ),
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text('1', style: TextStyle(fontSize: 12, color: AppColors.textDisabled)),
                          Text('5', style: TextStyle(fontSize: 12, color: AppColors.textDisabled)),
                          Text('10', style: TextStyle(fontSize: 12, color: AppColors.textDisabled)),
                        ],
                      ),
                    ],
                  ),
                ),
              ),
              
              SizedBox(height: 24),
              
              // Members Section
              _buildSectionHeader('Members (${members.length})'),
              _buildMembersList(members, admins),
              
              SizedBox(height: 16),
              
              // Media, Links & Docs Section
              _buildSectionHeader('Shared Media'),
              _buildMediaSection(),
              
              SizedBox(height: 16),
              
              // Group Settings (Admin only)
              if (_isAdmin) _buildAdminSettings(),
            ],
          );
        },
      ),
    );
  }

Widget _buildSectionHeader(String title) {
    return Padding(
      padding: EdgeInsets.symmetric(vertical: 8),
      child: Text(
        title,
        style: TextStyle(
          fontSize: 18,
          fontWeight: FontWeight.bold,
          color: AppColors.primaryLavender,
        ),
      ), // This closing parenthesis belongs to the Text widget
    ); // This closing parenthesis belongs to the Padding widget
  }

  Widget _buildMembersList(List<dynamic> members, List<dynamic> admins) {
    return Column(
      children: [
        if (_isAdmin) ...[
          ListTile(
            leading: Container(
              width: 40,
              height: 40,
              decoration: BoxDecoration(
                color: AppColors.primaryLavender.withOpacity(0.1),
                borderRadius: BorderRadius.circular(20),
              ),
              child: Icon(Feather.user_plus, color: AppColors.primaryLavender),
            ),
            title: Text('Add Participants', style: TextStyle(color: AppColors.textHigh)),
            onTap: _addParticipants,
          ),
          Divider(color: AppColors.elevation),
        ],
        
        ...members.map((memberId) => FutureBuilder<Map<String, dynamic>>(
          future: UserProfileCache.getUserProfile(memberId),
          builder: (context, snapshot) {
            if (!snapshot.hasData) {
              return ListTile(
                leading: CircleAvatar(radius: 20, backgroundColor: AppColors.elevation),
                title: Text('Loading...', style: TextStyle(color: AppColors.textHigh)),
              );
            }
            
            final userData = snapshot.data!;
            final String userName = userData['name'] ?? 'User';
            final String userImage = userData['profileImage'] ?? '';
            final bool isAdmin = admins.contains(memberId);
            final bool isMe = memberId == _currentUserId;
            
            return ListTile(
              leading: CircleAvatar(
                radius: 20,
                backgroundColor: AppColors.elevation,
                backgroundImage: userImage.isNotEmpty
                    ? CachedNetworkImageProvider(userImage)
                    : AssetImage('assets/default_avatar.png') as ImageProvider,
              ),
              title: Row(
                children: [
                  Text(userName, style: TextStyle(color: AppColors.textHigh)),
                  if (isMe) Text(' (You)', style: TextStyle(color: AppColors.textDisabled)),
                ],
              ),
              subtitle: isAdmin ? Text('Admin', style: TextStyle(color: AppColors.primaryLavender)) : null,
              trailing: _isAdmin && !isMe ? PopupMenuButton<String>(
                onSelected: (value) => _handleMemberAction(value, memberId, isAdmin),
                itemBuilder: (context) => [
                  PopupMenuItem(
                    value: isAdmin ? 'demote' : 'promote',
                    child: Text(isAdmin ? 'Demote from Admin' : 'Promote to Admin', style: TextStyle(color: AppColors.textHigh)),
                  ),
                  PopupMenuItem(
                    value: 'remove',
                    child: Text('Remove from Group', style: TextStyle(color: AppColors.error)),
                  ),
                ],
              ) : null,
            );
          },
        )).toList(),
      ],
    );
  }

  Widget _buildMediaSection() {
    return StreamBuilder<QuerySnapshot>(
      stream: _firestore.collection('groups').doc(widget.groupId)
          .collection('messages').snapshots(),
      builder: (context, snapshot) {
        if (!snapshot.hasData) {
          return CircularProgressIndicator(color: AppColors.primaryLavender);
        }
        
        final messages = snapshot.data!.docs;
        final mediaMessages = messages.where((msg) {
          final data = msg.data() as Map<String, dynamic>;
          return data['imageUrl'] != null || 
                 data['type'] == 'file' || 
                 _containsLink(data['text'] ?? '');
        }).toList();
        
        return GridView.builder(
          shrinkWrap: true,
          physics: NeverScrollableScrollPhysics(),
          gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
            crossAxisCount: 3,
            crossAxisSpacing: 4,
            mainAxisSpacing: 4,
          ),
          itemCount: mediaMessages.length,
          itemBuilder: (context, index) {
            final message = mediaMessages[index];
            final data = message.data() as Map<String, dynamic>;
            
            if (data['imageUrl'] != null) {
              return CachedNetworkImage(
                imageUrl: data['imageUrl'],
                fit: BoxFit.cover,
                placeholder: (context, url) => Container(color: AppColors.elevation),
              );
            } else if (data['type'] == 'file') {
              return Container(
                color: AppColors.elevation,
                child: Icon(Feather.file, color: AppColors.primaryLavender),
              );
            } else {
              return Container(
                color: AppColors.elevation,
                child: Icon(Feather.link, color: AppColors.primaryLavender),
              );
            }
          },
        );
      },
    );
  }

  Widget _buildAdminSettings() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionHeader('Admin Controls'),
        Card(
          color: AppColors.surface,
          child: Column(
            children: [
              SwitchListTile(
                title: Text('Read-only Mode', style: TextStyle(color: AppColors.textHigh)),
                subtitle: Text('Only admins can send messages', style: TextStyle(color: AppColors.textMedium)),
                value: false, // You'll need to store this in your group data
                onChanged: (value) => _toggleReadOnlyMode(value),
                activeColor: AppColors.primaryLavender,
              ),
              SwitchListTile(
                title: Text('Profanity Filter', style: TextStyle(color: AppColors.textHigh)),
                subtitle: Text('Automatically filter inappropriate content', style: TextStyle(color: AppColors.textMedium)),
                value: true, // You'll need to store this in your group data
                onChanged: (value) => _toggleProfanityFilter(value),
                activeColor: AppColors.primaryLavender,
              ),
              SwitchListTile(
                title: Text('Link Restrictions', style: TextStyle(color: AppColors.textHigh)),
                subtitle: Text('Prevent sharing of external links', style: TextStyle(color: AppColors.textMedium)),
                value: false, // You'll need to store this in your group data
                onChanged: (value) => _toggleLinkRestrictions(value),
                activeColor: AppColors.primaryLavender,
              ),
            ],
          ),
        ),
      ],
    );
  }

  bool _containsLink(String text) {
    final urlRegex = RegExp(r'https?://[^\s]+');
    return urlRegex.hasMatch(text);
  }

  void _addParticipants() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Add Participants', style: TextStyle(color: AppColors.textHigh)),
        content: Text('Feature coming soon!', style: TextStyle(color: AppColors.textMedium)),
        backgroundColor: AppColors.surface,
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('OK', style: TextStyle(color: AppColors.primaryLavender)),
          ),
        ],
      ),
    );
  }

  void _handleMemberAction(String action, String memberId, bool isAdmin) {
    switch (action) {
      case 'promote':
        _promoteToAdmin(memberId);
        break;
      case 'demote':
        _demoteFromAdmin(memberId);
        break;
      case 'remove':
        _removeMember(memberId);
        break;
    }
  }

  void _promoteToAdmin(String memberId) {
    _firestore.collection('groups').doc(widget.groupId).update({
      'admins': FieldValue.arrayUnion([memberId]),
    });
  }

  void _demoteFromAdmin(String memberId) {
    _firestore.collection('groups').doc(widget.groupId).update({
      'admins': FieldValue.arrayRemove([memberId]),
    });
  }

  void _removeMember(String memberId) {
    _firestore.collection('groups').doc(widget.groupId).update({
      'members': FieldValue.arrayRemove([memberId]),
      'admins': FieldValue.arrayRemove([memberId]),
      'memberCount': FieldValue.increment(-1),
    });
  }

  void _toggleReadOnlyMode(bool value) {
    _firestore.collection('groups').doc(widget.groupId).update({
      'isReadOnly': value,
    });
  }

  void _toggleProfanityFilter(bool value) {
    _firestore.collection('groups').doc(widget.groupId).update({
      'profanityFilter': value,
    });
  }

  void _toggleLinkRestrictions(bool value) {
    _firestore.collection('groups').doc(widget.groupId).update({
      'linkRestrictions': value,
    });
  }

  void _updateRating(double rating) {
    _firestore.collection('groups').doc(widget.groupId).update({
      'ratings.$_currentUserId': rating,
    });
  }
}

// NEW: Search Dialog Widget
class SearchDialog extends StatefulWidget {
  final String groupId;

  const SearchDialog({Key? key, required this.groupId}) : super(key: key);

  @override
  _SearchDialogState createState() => _SearchDialogState();
}

class _SearchDialogState extends State<SearchDialog> {
  final TextEditingController _searchController = TextEditingController();
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  List<QueryDocumentSnapshot> _searchResults = [];
  bool _isSearching = false;

  void _performSearch(String query) async {
    if (query.isEmpty) {
      setState(() {
        _searchResults = [];
        _isSearching = false;
      });
      return;
    }

    setState(() {
      _isSearching = true;
    });

    try {
      final results = await _firestore
          .collection('groups')
          .doc(widget.groupId)
          .collection('messages')
          .where('text', isGreaterThanOrEqualTo: query)
          .where('text', isLessThanOrEqualTo: query + '\uf8ff')
          .get();

      setState(() {
        _searchResults = results.docs;
        _isSearching = false;
      });
    } catch (e) {
      print("Search error: $e");
      setState(() {
        _isSearching = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: AppColors.surface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      child: Container(
        width: double.infinity,
        height: MediaQuery.of(context).size.height * 0.7,
        padding: EdgeInsets.all(16),
        child: Column(
          children: [
            Row(
              children: [
                Icon(Feather.search, color: AppColors.primaryLavender),
                SizedBox(width: 12),
                Expanded(
                  child: TextField(
                    controller: _searchController,
                    style: TextStyle(color: AppColors.textHigh),
                    decoration: InputDecoration(
                      hintText: 'Search in chat...',
                      hintStyle: TextStyle(color: AppColors.textDisabled),
                      border: InputBorder.none,
                    ),
                    onChanged: _performSearch,
                  ),
                ),
                IconButton(
                  icon: Icon(Feather.x, color: AppColors.textHigh),
                  onPressed: () => Navigator.pop(context),
                ),
              ],
            ),
            Divider(color: AppColors.elevation),
            SizedBox(height: 16),
            if (_isSearching)
              Center(child: CircularProgressIndicator(color: AppColors.primaryLavender))
            else if (_searchResults.isEmpty && _searchController.text.isNotEmpty)
              Center(child: Text('No messages found', style: TextStyle(color: AppColors.textMedium)))
            else if (_searchResults.isEmpty)
              Center(child: Text('Enter search terms above', style: TextStyle(color: AppColors.textMedium)))
            else
              Expanded(
                child: ListView.builder(
                  itemCount: _searchResults.length,
                  itemBuilder: (context, index) {
                    final message = _searchResults[index];
                    final data = message.data() as Map<String, dynamic>;
                    final String text = data['text'] ?? '';
                    final Timestamp timestamp = data['timestamp'];
                    
                    return ListTile(
                      title: Text(text, style: TextStyle(color: AppColors.textHigh)),
                      subtitle: Text(DateFormat.yMMMd().add_Hm().format(timestamp.toDate()), style: TextStyle(color: AppColors.textDisabled)),
                      onTap: () {
                        Navigator.pop(context);
                      },
                    );
                  },
                ),
              ),
          ],
        ),
      ),
    );
  }
}

class GroupChatScreen extends StatefulWidget {
  final String groupId;
  const GroupChatScreen({Key? key, required this.groupId}) : super(key: key);
  @override
  _GroupChatScreenState createState() => _GroupChatScreenState();
}

class _GroupChatScreenState extends State<GroupChatScreen> {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final TextEditingController _messageController = TextEditingController();
  final ScrollController _scrollController = ScrollController();
  late String _currentUserId;
  late DocumentReference _groupDocRef;
  File? _imageToSend;


  bool _isMember = false;
  bool _isAdmin = false;
  bool _isModerator = false;
  bool _isReadOnly = false;


  Map<String, dynamic> _typingStatus = {};
  Timer? _typingTimer;
  bool _isTyping = false;
  bool _showScrollToBottom = false;
  double _lastScrollOffset = 0.0;

  // Message reply variables
  Map<String, dynamic>? _replyingToMessage;
  final FocusNode _messageFocusNode = FocusNode();

  // Inside _GroupsScreenState class, near other variable declarations like _groupNameController, _isPrivate, etc.
  // Add these lines:
  String _selectedAgeRating = '13-17'; // Default age rating
  final List<String> _ageRatings = ['13-17', '18-25', '26+'];
  List<String> _hashtags = []; // Store hashtags
  final TextEditingController _hashtagController = TextEditingController(); // For adding hashtags
  

  // The _isMember and _isReadOnly variables belong in _GroupChatScreenState, not here.
  // They are likely already declared there, or should be if they are missing.

  @override
  void initState() {
    super.initState();
    _currentUserId = _auth.currentUser!.uid;
    _groupDocRef = _firestore.collection('groups').doc(widget.groupId);
    _checkMembership();
    _markMessagesAsRead();
    _setupTypingListener();
    _scrollController.addListener(_scrollListener);
    // Initialize audio recorder and player
  }

  

  Future<void> _preloadUserProfiles(List<QueryDocumentSnapshot> messages) async {
    print("GroupChatScreen._preloadUserProfiles: Starting preload for ${messages.length} messages.");
    final userIds = messages
        .map((msg) => msg['senderId'] as String)
        .where((id) => id != null && id.isNotEmpty) // Basic validation
        .toList();
    print("GroupChatScreen._preloadUserProfiles: Extracted sender IDs: $userIds");

    if (userIds.isNotEmpty) {
      // Call the cache's preload function
      await UserProfileCache.preloadUserProfiles(userIds);
      print("GroupChatScreen._preloadUserProfiles: Preload completed.");
    } else {
      print("GroupChatScreen._preloadUserProfiles: No valid sender IDs found to preload.");
    }
  }

  // Inside _GroupChatScreenState class
  Future<void> _pickFile() async {
    if (!_isMember || _isReadOnly) return; // Use class variables
    try {
      FilePickerResult? result = await FilePicker.platform.pickFiles(
        type: FileType.any, // Allows any file type
        // Or be more specific:
        // type: FileType.custom,
        // allowedExtensions: ['pdf', 'doc', 'docx'],
      );

      if (result != null) {
        PlatformFile file = result.files.first;
        // Pass the file to your sendMessage function
        // You need to implement _sendMessage to handle File type
        // Example: _sendMessage(file: file); 
        // The actual implementation depends on how you send messages.
        // It would involve uploading the file.bytes or file.path to Firebase Storage
        // and then calling _sendMessage with the download URL and type 'file'.
      } else {
        // User canceled the picker
      }
    } catch (e) {
      print("Error picking file: $e");
      // Use context from the widget state
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to pick file. Please try again.')),
      );
    }
  }

  @override
  void dispose() {
    _messageController.dispose();
    _scrollController.removeListener(_scrollListener);
    _scrollController.dispose();
    _typingTimer?.cancel();
    _stopTyping();
    _messageFocusNode.dispose();
    super.dispose();
  }

  void _scrollListener() {
    final maxScroll = _scrollController.position.maxScrollExtent;
    final currentScroll = _scrollController.position.pixels;
    final delta = 20.0;
    if (!_showScrollToBottom && currentScroll < maxScroll - delta) {
      setState(() {
        _showScrollToBottom = true;
      });
    } else if (_showScrollToBottom && currentScroll >= maxScroll - delta) {
      setState(() {
        _showScrollToBottom = false;
      });
    }
    _lastScrollOffset = currentScroll;
  }

  Future<void> _checkMembership() async {
    final groupDoc = await _groupDocRef.get();
    if (groupDoc.exists) {
      final groupData = groupDoc.data() as Map<String, dynamic>;
      final List<dynamic> members = groupData['members'] ?? [];
      final List<dynamic> admins = groupData['admins'] ?? [];
      final List<dynamic> moderators = groupData['moderators'] ?? [];
      final bool isReadOnly = groupData['isReadOnly'] ?? false;
      setState(() {
        _isMember = members.contains(_currentUserId);
        _isAdmin = admins.contains(_currentUserId);
        _isModerator = moderators.contains(_currentUserId);
        _isReadOnly = isReadOnly;
      });
    }
  }

  

  void _setupTypingListener() {
    _groupDocRef.snapshots().listen((snapshot) {
      if (snapshot.exists) {
        final data = snapshot.data() as Map<String, dynamic>;
        setState(() {
          _typingStatus = data['typing'] ?? {};
        });
      }
    });
  }

  void _startTyping() {
    if (!_isMember || _isReadOnly) return;
    if (!_isTyping) {
      _isTyping = true;
      _groupDocRef.update({
        'typing.$_currentUserId': FieldValue.serverTimestamp(),
      });
    }
    _typingTimer?.cancel();
    _typingTimer = Timer(Duration(seconds: 2), _stopTyping);
  }

  void _stopTyping() {
    if (_isTyping) {
      _isTyping = false;
      _groupDocRef.update({
        'typing.$_currentUserId': FieldValue.delete(),
      });
    }
  }

  Future<void> _markMessagesAsRead() async {
    try {
      final groupDoc = await _groupDocRef.get();
      if (!groupDoc.exists) return;
      final groupData = groupDoc.data() as Map<String, dynamic>?;
      if (groupData == null) return;
      final Map<String, dynamic> unreadCountMap =
          groupData['unreadCount'] ?? {};
      final int currentUnread = unreadCountMap[_currentUserId] ?? 0;
      if (currentUnread > 0) {
        await _groupDocRef.update({
          'unreadCount.$_currentUserId': 0,
        });
      }
    } catch (e) {
      print("Error marking messages as read: $e");
    }
  }

 Future<void> _pickImage() async {
    if (!_isMember || _isReadOnly) return;
    try {
      final pickedFile =
          await ImagePicker().pickImage(source: ImageSource.gallery);
      if (pickedFile != null) {
        _cropAndEditImage(File(pickedFile.path));
      }
    } catch (e) {
      print("Error picking image: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to pick image. Please try again.')),
      );
    }
  }

  Future<void> _cropAndEditImage(File imageFile) async {
    try {
      final CroppedFile? croppedFile = await ImageCropper().cropImage(
        sourcePath: imageFile.path,
        uiSettings: [
          AndroidUiSettings(
            toolbarTitle: 'Edit Image',
            toolbarColor: AppColors.primaryLavender,
            toolbarWidgetColor: AppColors.textOnSecondary,
            initAspectRatio: CropAspectRatioPreset.original,
            lockAspectRatio: false,
            aspectRatioPresets: [
              CropAspectRatioPreset.square,
              CropAspectRatioPreset.ratio3x2,
              CropAspectRatioPreset.original,
              CropAspectRatioPreset.ratio4x3,
              CropAspectRatioPreset.ratio16x9,
            ],
          ),
          IOSUiSettings(
            title: 'Edit Image',
          ),
        ],
      );
      if (croppedFile != null) {
        // Navigate to image preview screen with caption option
        final result = await Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) =>
                ImagePreviewScreen(imageFile: File(croppedFile.path)),
          ),
        );
        if (result != null && result is Map<String, dynamic>) {
          final File editedImage = result['image'];
          final String caption = result['caption'] ?? '';
          _sendMessage(
              imageFile: editedImage,
              text: caption.isNotEmpty ? caption : null);
        }
      }
    } catch (e) {
      print("Error cropping image: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to edit image. Please try again.')),
      );
    }
  }

  // Message sending methods
  Future<void> _sendMessage({File? imageFile, String? text}) async {
    if (!_isMember || _isReadOnly) return;
    final messageText = text ?? _messageController.text.trim();
    if (messageText.isEmpty && imageFile == null) return;
    try {
      String? imageUrl;
      if (imageFile != null) {
        final ref = FirebaseStorage.instance
            .ref()
            .child('group_chats')
            .child(widget.groupId)
            .child('images')
            .child('${Uuid().v4()}.jpg');
        await ref.putFile(imageFile);
        imageUrl = await ref.getDownloadURL();
      }
      final messageId = Uuid().v4();
      final timestamp = FieldValue.serverTimestamp();
      final messageData = {
        'id': messageId,
        'groupId': widget.groupId,
        'senderId': _currentUserId,
        'text': messageText,
        'imageUrl': imageUrl,
        'timestamp': timestamp,
        'type': imageUrl != null ? 'image' : 'text',
        'reactions': {},
        'replies': 0,
        'status': 'sent',
        'replyTo': _replyingToMessage != null
            ? {
                'messageId': _replyingToMessage!['id'],
                'senderId': _replyingToMessage!['senderId'],
                'text': _replyingToMessage!['text'] ??
                    (_replyingToMessage!['type'] == 'image'
                        ? ' Image'
                        : 'Audio'),
              }
            : null,
      };
      await _groupDocRef.collection('messages').doc(messageId).set(messageData);
      final groupUpdateData = {
        'lastMessage': imageUrl != null ? ' Image' : messageText,
        'lastMessageTime': timestamp,
        'lastMessageSender': _currentUserId,
      };
      await _groupDocRef.update(groupUpdateData);
      // Update unread counts
      final groupDoc = await _groupDocRef.get();
      if (groupDoc.exists) {
        final groupData = groupDoc.data() as Map<String, dynamic>;
        final List<dynamic> members = groupData['members'] ?? [];
        final Map<String, dynamic> unreadCountMap =
            groupData['unreadCount'] ?? {};
        for (var memberId in members) {
          if (memberId != _currentUserId) {
            final currentCount = unreadCountMap[memberId] ?? 0;
            unreadCountMap[memberId] = currentCount + 1;
          }
        }
        await _groupDocRef.update({'unreadCount': unreadCountMap});
      }
      _messageController.clear();
      // Clear reply if it exists
      setState(() {
        _replyingToMessage = null;
      });
      _scrollToBottom();
    } catch (e) {
      print("Error sending message: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to send message. Please try again.')),
      );
    }
  }

  void _scrollToBottom() {
    if (_scrollController.hasClients) {
      _scrollController.animateTo(
        _scrollController.position.maxScrollExtent,
        duration: Duration(milliseconds: 300),
        curve: Curves.easeOut,
      );
    }
  }

  void _cancelReply() {
    setState(() {
      _replyingToMessage = null;
    });
    _messageFocusNode.requestFocus();
  }

  void _replyToMessage(Map<String, dynamic> message) {
    setState(() {
      _replyingToMessage = message;
    });
    _messageFocusNode.requestFocus();
  }

  void _jumpToMessage(String messageId) {
    // This would ideally scroll to the specific message
    // For now, we'll just clear the reply
    setState(() {
      _replyingToMessage = null;
    });
  }

  Future<String?> _getProfileImageUrl(String userId) async {
    try {
      final ref = FirebaseStorage.instance
          .ref()
          .child("profile_images/$userId.jpg"); //  check your folder name
      return await ref.getDownloadURL();
    } catch (e) {
      print("No profile image for $userId: $e");
      return null;
    }
  }

  // NEW: Enhanced three-dot menu implementation
  void _showThreeDotMenu() {
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      isScrollControlled: true,
      builder: (context) {
        return Container(
          height: MediaQuery.of(context).size.height * 0.8,
          decoration: BoxDecoration(
            color: AppColors.backgroundDeep,
            borderRadius: BorderRadius.vertical(top: Radius.circular(25)),
          ),
          child: Column(
            children: [
              // Header
              Container(
                padding: EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: AppColors.surface,
                  borderRadius: BorderRadius.vertical(top: Radius.circular(25)),
                ),
                child: Row(
                  children: [
                    Icon(Feather.more_vertical, color: AppColors.primaryLavender, size: 24),
                    SizedBox(width: 12),
                    Text(
                      'Group Options',
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                        color: AppColors.primaryLavender,
                      ),
                    ),
                    Spacer(),
                    IconButton(
                      icon: Icon(Feather.x, color: AppColors.primaryLavender),
                      onPressed: () => Navigator.pop(context),
                    ),
                  ],
                ),
              ),
              
              Expanded(
                child: ListView(
                  padding: EdgeInsets.all(16),
                  children: [
                    // Group Info Section
                    _buildMenuSection(
                      title: 'Group Info',
                      icon: Feather.info,
                      onTap: _showGroupInfoScreen,
                    ),
                    
                    // Search Section
                    _buildMenuSection(
                      title: 'Search',
                      icon: Feather.search,
                      onTap: _showSearchScreen,
                    ),
                    
                    // Wallpaper Section
                    _buildMenuSection(
                      title: 'Wallpaper',
                      icon: Feather.image,
                      onTap: _showWallpaperOptions,
                    ),
                    
                    // More Options Section
                    _buildExpandableSection(
                      title: 'More Options',
                      icon: Feather.chevron_down,
                      children: [
                        if (!_isAdmin) // Only show report for non-admins
                          _buildMenuOption(
                            title: 'Report Group',
                            icon: Feather.alert_triangle,
                            color: AppColors.accentMustard,
                            onTap: _reportGroup,
                          ),
                        _buildMenuOption(
                          title: 'Exit Group',
                          icon: Feather.log_out,
                          color: AppColors.error,
                          onTap: _leaveGroup,
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildMenuSection({
    required String title,
    required IconData icon,
    required VoidCallback onTap,
  }) {
    return Card(
      margin: EdgeInsets.symmetric(vertical: 4),
      color: AppColors.surface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: ListTile(
        leading: Container(
          width: 40,
          height: 40,
          decoration: BoxDecoration(
            color: AppColors.primaryLavender.withOpacity(0.1),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Icon(icon, color: AppColors.primaryLavender, size: 20),
        ),
        title: Text(title, style: TextStyle(fontWeight: FontWeight.w500, color: AppColors.textHigh)),
        trailing: Icon(Feather.chevron_right, size: 16, color: AppColors.textDisabled),
        onTap: onTap,
      ),
    );
  }

  Widget _buildExpandableSection({
    required String title,
    required IconData icon,
    required List<Widget> children,
  }) {
    return Card(
      margin: EdgeInsets.symmetric(vertical: 4),
      color: AppColors.surface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: ExpansionTile(
        leading: Container(
          width: 40,
          height: 40,
          decoration: BoxDecoration(
            color: AppColors.primaryLavender.withOpacity(0.1),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Icon(icon, color: AppColors.primaryLavender, size: 20),
        ),
        title: Text(title, style: TextStyle(fontWeight: FontWeight.w500, color: AppColors.textHigh)),
        children: children,
      ),
    );
  }

  Widget _buildMenuOption({
    required String title,
    required IconData icon,
    required Color color,
    required VoidCallback onTap,
  }) {
    return ListTile(
      leading: Icon(icon, color: color),
      title: Text(title, style: TextStyle(color: color)),
      onTap: onTap,
    );
  }

  // NEW: Group Info Screen
  void _showGroupInfoScreen() {
    Navigator.pop(context); // Close the menu first
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => GroupInfoScreen(groupId: widget.groupId),
      ),
    );
  }

  // NEW: Search Screen
  void _showSearchScreen() {
    Navigator.pop(context); // Close the menu first
    showDialog(
      context: context,
      builder: (context) => SearchDialog(groupId: widget.groupId),
    );
  }

  // NEW: Wallpaper Options
  void _showWallpaperOptions() {
    Navigator.pop(context); // Close the menu first
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Wallpaper', style: TextStyle(color: AppColors.textHigh)),
        content: Text('Wallpaper feature coming soon!', style: TextStyle(color: AppColors.textMedium)),
        backgroundColor: AppColors.surface,
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('OK', style: TextStyle(color: AppColors.primaryLavender)),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      body: Column(
        children: [
          // Group info header - REPLACED with three-dot menu
          StreamBuilder<DocumentSnapshot>(
            stream: _groupDocRef.snapshots(),
            builder: (context, snapshot) {
              if (!snapshot.hasData) return Container();
              final groupData =
                  snapshot.data!.data() as Map<String, dynamic>?;
              final String groupName = groupData?['name'] ?? 'Group';
              final String groupImage = groupData?['imageUrl'] ?? '';
              final int memberCount = groupData?['memberCount'] ?? 0;
              return Container(
                padding: EdgeInsets.all(16),
                color: AppColors.surface,
                child: Row(
                  children: [
                    CircleAvatar(
                      radius: 20,
                      backgroundColor: AppColors.elevation,
                      backgroundImage: groupImage.isNotEmpty
                          ? CachedNetworkImageProvider(groupImage)
                          : AssetImage('assets/default_avatar.png',)
                              as ImageProvider,
                    ),
                    SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            groupName,
                            style: TextStyle(
                              fontWeight: FontWeight.bold,
                              fontSize: 16,
                              color: AppColors.textHigh,
                            ),
                          ),
                          Text(
                            '$memberCount members',
                            style: TextStyle(
                              color: AppColors.textMedium,
                              fontSize: 14,
                            ),
                          ),
                        ],
                      ),
                    ),
                    // REPLACED: Info button with three-dot menu
                    // NEW: Enhanced three-dot menu
                    IconButton(
                      icon: Icon(Feather.more_vertical, color: AppColors.primaryLavender),
                      onPressed: _showThreeDotMenu,
                    ),
                  ],
                ),
              );
            },
          ),
          // Typing indicators
          if (_typingStatus.isNotEmpty)
            Container(
              padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
              color: AppColors.elevation,
              child: Row(
                children: [
                  // Inside the Typing indicators Container
                  Text(
                    '${_typingStatus.keys.length} ${_typingStatus.keys.length == 1 ? 'person is' : 'people are'} typing...',
                    style: TextStyle(
                      color: AppColors.primaryLavender,
                      fontStyle: FontStyle.italic,
                    ),
                  ),
                ],
              ),
            ),
          // Messages list
Expanded(
  child: StreamBuilder<QuerySnapshot>(
    stream: _groupDocRef
        .collection('messages')
        .orderBy('timestamp', descending: false)
        .snapshots(),
    builder: (context, snapshot) {
      if (!snapshot.hasData) {
        return Center(
          child: CircularProgressIndicator(color: AppColors.primaryLavender),
        );
      }
      final messages = snapshot.data!.docs;

      // Preload user profiles when messages load
      WidgetsBinding.instance.addPostFrameCallback((_) {
        _preloadUserProfiles(messages);
      });

      return Stack(
        children: [
          ListView.builder(
            controller: _scrollController,
            padding: EdgeInsets.all(8),
            itemCount: messages.length,
            itemBuilder: (context, index) {
              final message = messages[index];
              final messageData = message.data() as Map<String, dynamic>;
              final String messageId = message.id;
              final String senderId = messageData['senderId'];
              final String text = messageData['text'] ?? '';
              final String type = messageData['type'] ?? 'text';
              final String? imageUrl = messageData['imageUrl'];
              final Timestamp? timestamp = messageData['timestamp'];
              final Map<String, dynamic>? replyTo = messageData['replyTo'] is Map
                  ? Map<String, dynamic>.from(messageData['replyTo'])
                  : null;
              final bool isMe = senderId == _currentUserId;
              final DateTime? messageTime = timestamp?.toDate();

              //  Use StreamBuilder so avatar & username auto-refresh
              return StreamBuilder<DocumentSnapshot>(
                stream: FirebaseFirestore.instance
                    .collection('users')
                    .doc(senderId)
                    .snapshots(),
                builder: (context, userSnapshot) {
                  String senderUsername = 'User';

                  if (userSnapshot.hasData && userSnapshot.data!.exists) {
                    final userData = userSnapshot.data!.data() as Map<String, dynamic>;
                    senderUsername = userData['username'] ?? userData['name'] ?? 'User';
                  }

                  return GestureDetector(
                    onLongPress: () {
                      _showMessageOptions(messageData);
                    },
                    child: Container(
                      margin: const EdgeInsets.symmetric(vertical: 4),
                      child: Row(
                        mainAxisAlignment: isMe ? MainAxisAlignment.end : MainAxisAlignment.start,
                        children: [
                          // --- AVATAR (only show for other users) ---
                          if (!isMe) ...[
                            Builder(
                              builder: (context) {
                                final cachedProfile = UserProfileCache.getCachedProfile(senderId);
                                if (cachedProfile != null && cachedProfile['profileImage'] != null) {
                                  final profileImageUrl = cachedProfile['profileImage'] as String;
                                  return Container(
                                    padding: const EdgeInsets.all(1.5), // thin outline
                                    decoration: BoxDecoration(
                                      shape: BoxShape.circle,
                                      border: Border.all(color: AppColors.primaryLavender, width: 1.5),
                                    ),
                                    child: CircleAvatar(
                                      radius: 16,
                                      backgroundColor: AppColors.elevation,
                                      backgroundImage: profileImageUrl.isNotEmpty
                                          ? CachedNetworkImageProvider(profileImageUrl)
                                          : const AssetImage('assets/default_avatar.png') as ImageProvider,
                                    ),
                                  );
                                }

                                // fallback  fetch only if cache is empty
                                return FutureBuilder<String?>(
                                  future: UserProfileCache.getUserProfile(senderId)
                                      .then((profile) => profile['profileImage'] as String?),
                                  builder: (context, snapshot) {
                                    if (!snapshot.hasData) {
                                      return Container(
                                        padding: const EdgeInsets.all(1.5),
                                        decoration: BoxDecoration(
                                          shape: BoxShape.circle,
                                          border: Border.all(color: AppColors.primaryLavender, width: 1.5),
                                        ),
                                        child: CircleAvatar(
                                          radius: 16,
                                          backgroundColor: AppColors.elevation,
                                          child: const Icon(Feather.user, size: 16, color: AppColors.textDisabled),
                                        ),
                                      );
                                    }

                                    final profileImageUrl = snapshot.data!;
                                    return Container(
                                      padding: const EdgeInsets.all(1.5),
                                      decoration: BoxDecoration(
                                        shape: BoxShape.circle,
                                        border: Border.all(color: AppColors.primaryLavender, width: 1.5),
                                      ),
                                      child: CircleAvatar(
                                        radius: 16,
                                        backgroundColor: AppColors.elevation,
                                        backgroundImage: profileImageUrl.isNotEmpty
                                            ? CachedNetworkImageProvider(profileImageUrl)
                                            : null,
                                        child: profileImageUrl.isEmpty
                                            ? const Icon(Feather.user, size: 16, color: AppColors.textDisabled)
                                            : null,
                                      ),
                                    );
                                  },
                                );
                              },
                            ),
                            const SizedBox(width: 8),
                          ],

            // --- MESSAGE BUBBLE ---
            Flexible(
              child: Container(
                decoration: BoxDecoration(
                  color: isMe ? AppColors.primaryLavender : AppColors.surface,
                  borderRadius: BorderRadius.circular(16),
                  boxShadow: const [
                    BoxShadow(
                      color: Colors.black12,
                      blurRadius: 2,
                      offset: Offset(0, 1),
                    ),
                  ],
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    if (!isMe)
                      Padding(
                        padding: const EdgeInsets.only(
                          top: 8.0,
                          left: 12.0,
                          right: 12.0,
                          bottom: 4.0,
                        ),
                        child: Text(
                          senderUsername,
                          style: TextStyle(
                            fontSize: 12,
                            fontWeight: FontWeight.bold,
                            fontStyle: FontStyle.italic,
                            color: AppColors.textHigh,
                          ),
                        ),
                      ),
                    Padding(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 12.0,
                        vertical: 8.0,
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          if (replyTo != null) _buildReplyPreview(replyTo, isMe),

                          if (type == 'text' && text.isNotEmpty)
                            Text(
                              text,
                              style: TextStyle(color: isMe ? AppColors.textOnSecondary : AppColors.textHigh),
                            ),

                          if (type == 'image' && imageUrl != null)
                            _buildImageMessage(imageUrl, text),

                          if (messageTime != null)
                            Padding(
                              padding: const EdgeInsets.only(top: 4.0),
                              child: Text(
                                DateFormat.Hm().format(messageTime),
                                style: TextStyle(
                                  fontSize: 10,
                                  color: isMe ? AppColors.textOnSecondary : AppColors.textDisabled,
                                ),
                              ),
                            ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  },
);
;

            },
          ),
          if (_showScrollToBottom)
            Positioned(
              bottom: 16,
              right: 16,
              child: FloatingActionButton(
                onPressed: _scrollToBottom,
                mini: true,
                backgroundColor: AppColors.primaryLavender,
                child: Icon(Feather.arrow_down,
                    color: AppColors.textOnSecondary, size: 20),
              ),
            ),
        ],
      );
    },
  ),
),
          // --- Modified Message Input Area ---
          if (_isMember &&
              !_isReadOnly) // Only show input area if member and not read-only
            Container(
              padding: EdgeInsets.all(8),
              color: AppColors.surface,
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  // Reply preview (if replying to a message)
                  if (_replyingToMessage != null)
                    Container(
                      padding: EdgeInsets.all(8),
                      color: AppColors.elevation,
                      child: Row(
                        children: [
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  'Replying to ${_replyingToMessage!['senderId'] == _currentUserId ? 'yourself' : 'message'}',
                                  style: TextStyle(
                                    fontWeight: FontWeight.bold,
                                    fontSize: 12,
                                    color: AppColors.textHigh,
                                  ),
                                ),
                                SizedBox(height: 4),
                                Text(
                                  _replyingToMessage!['text'] ??
                                      (_replyingToMessage!['type'] == 'image'
                                          ? ' Image'
                                          : ''),
                                  style: TextStyle(fontSize: 12, color: AppColors.textMedium),
                                  maxLines: 1,
                                  overflow: TextOverflow.ellipsis,
                                ),
                              ],
                              ),
                          ),
                          IconButton(
                            icon: Icon(Feather.x, size: 18, color: AppColors.textHigh),
                            onPressed: _cancelReply,
                          ),
                        ],
                      ),
                    ),
                  // Standard message input row
                  Row(
                    children: [
                      IconButton(
                        icon: Icon(Feather.image, color: AppColors.primaryLavender),
                        onPressed: _pickImage,
                      ),
                      Expanded(
                        child: Container(
                          constraints: BoxConstraints(maxHeight: 100),
                          child: TextField(
                            controller: _messageController,
                            focusNode: _messageFocusNode,
                            onChanged: (value) => _startTyping(),
                            style: TextStyle(color: AppColors.textHigh),
                            decoration: InputDecoration(
                              hintText: 'Type a message...',
                              hintStyle: TextStyle(color: AppColors.textDisabled),
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(20),
                                borderSide: BorderSide.none,
                              ),
                              filled: true,
                              fillColor: AppColors.elevation,
                              contentPadding: EdgeInsets.symmetric(
                                  horizontal: 16, vertical: 8),
                            ),
                            maxLines: null,
                            textInputAction: TextInputAction.send,
                            onSubmitted: (value) => _sendMessage(),
                          ),
                        ),
                      ),
                      IconButton(
                        icon: Icon(
                          _messageController.text.isNotEmpty
                              ? Feather.send
                              : Feather.plus,
                          color: AppColors.primaryLavender,
                        ),
                        onPressed: () {
                          if (_messageController.text.isNotEmpty) {
                            _sendMessage();
                          } else {
                            // Optionally show options for attachments
                            _showAttachmentOptions();
                          }
                        },
                      ),
                    ],
                  ),
                ],
              ),
            ),
          // --- End Modified Message Input Area ---
        ],
      ),
    );
  }

  // Add this helper method for attachment options
  void _showAttachmentOptions() {
    showModalBottomSheet(
      context: context,
      builder: (context) {
        return Container(
          padding: EdgeInsets.all(16),
          color: AppColors.surface,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              ListTile(
                leading: Icon(Feather.image, color: AppColors.primaryLavender),
                title: Text('Send Image', style: TextStyle(color: AppColors.textHigh)),
                onTap: () {
                  Navigator.pop(context);
                  _pickImage();
                },
              ),
              ListTile(
                leading: Icon(Feather.file, color: AppColors.primaryLavender),
                title: Text('Send File', style: TextStyle(color: AppColors.textHigh)),
                onTap: () {
                  Navigator.pop(context);
                  _pickFile();
                },
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildReplyPreview(Map<String, dynamic> replyData, bool isMe) {
    final String repliedMessageSenderId = replyData['senderId'];
    final bool isReplyingToSelf = repliedMessageSenderId == _currentUserId;
    
    return FutureBuilder<Map<String, dynamic>>(
      future: UserProfileCache.getUserProfile(repliedMessageSenderId),
      builder: (context, userSnapshot) {
        String senderName = 'User'; // Default fallback
        
        if (userSnapshot.hasData) {
          final userData = userSnapshot.data!;
          senderName = userData['name'] ?? userData['username'] ?? 'User';
        } else if (isReplyingToSelf) {
          senderName = 'You';
        }
        
        return Container(
          padding: EdgeInsets.all(8),
          margin: EdgeInsets.only(bottom: 4),
          decoration: BoxDecoration(
            color: (isMe
                ? AppColors.primaryLavender.withOpacity(0.2)
                : AppColors.elevation),
            borderRadius: BorderRadius.circular(8),
            border: Border(
              left: BorderSide(
                color: isMe ? AppColors.primaryLavender : AppColors.textDisabled,
                width: 3,
              ),
            ),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                senderName, // Use the actual username instead of "Someone"
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  fontSize: 12,
                  color: isMe ? AppColors.primaryLavender : AppColors.textMedium,
                ),
              ),
              SizedBox(height: 2),
              Text(
                replyData['text'] ?? 'Media',
                style: TextStyle(fontSize: 12, color: isMe ? AppColors.textOnSecondary : AppColors.textHigh),
                maxLines: 2,
                overflow: TextOverflow.ellipsis,
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildImageMessage(String imageUrl, String caption) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        GestureDetector(
          onTap: () {
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) => ImageViewerScreen(imageUrl: imageUrl),
              ),
            );
          },
          child: ClipRRect(
            borderRadius: BorderRadius.circular(8),
            child: CachedNetworkImage(
              imageUrl: imageUrl,
              width: 200,
              height: 200,
              fit: BoxFit.cover,
              placeholder: (context, url) => Container(
                width: 200,
                height: 200,
                color: AppColors.elevation,
                child: Center(
                    child: CircularProgressIndicator(color: AppColors.primaryLavender)),
              ),
              errorWidget: (context, url, error) => Container(
                width: 200,
                height: 200,
                color: AppColors.elevation,
                child: Icon(Feather.alert_circle, color: AppColors.error),
              ),
            ),
          ),
        ),
        if (caption.isNotEmpty)
          Padding(
            padding: EdgeInsets.only(top: 8),
            child: Text(
              caption,
              style: TextStyle(color: AppColors.textHigh),
            ),
          ),
      ],
    );
  }


  void _showMessageOptions(Map<String, dynamic> messageData) {
    showModalBottomSheet(
      context: context,
      builder: (context) {
        return Container(
          padding: EdgeInsets.all(16),
          color: AppColors.surface,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              ListTile(
                leading: Icon(Feather.corner_up_left, color: AppColors.primaryLavender),
                title: Text('Reply', style: TextStyle(color: AppColors.textHigh)),
                onTap: () {
                  Navigator.pop(context);
                  _replyToMessage(messageData);
                },
              ),
              ListTile(
                leading: Icon(Feather.copy, color: AppColors.primaryLavender),
                title: Text('Copy', style: TextStyle(color: AppColors.textHigh)),
                onTap: () {
                  Navigator.pop(context);
                  if (messageData['text'] != null) {
                    Clipboard.setData(ClipboardData(text: messageData['text']));
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(content: Text('Message copied')),
                    );
                  }
                },
              ),
              if (messageData['imageUrl'] != null)
                ListTile(
                  leading: Icon(Feather.download, color: AppColors.primaryLavender),
                  title: Text('Save to gallery', style: TextStyle(color: AppColors.textHigh)),
                  onTap: () {
                    Navigator.pop(context);
                    // Implement save to gallery functionality
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(content: Text('Image saved to gallery')),
                    );
                  },
                ),
            ],
          ),
        );
      },
    );
  }

 // NEW: Group info dialog
  void _showGroupInfo() {
    showDialog(
      context: context,
      builder: (context) {
        return AlertDialog(
          title: Text('Group Info', style: TextStyle(color: AppColors.textHigh)),
          backgroundColor: AppColors.surface,
          content: StreamBuilder<DocumentSnapshot>(
            stream: _groupDocRef.snapshots(),
            builder: (context, snapshot) {
              if (!snapshot.hasData) {
                return Center(child: CircularProgressIndicator(color: AppColors.primaryLavender));
              }

              final groupData = snapshot.data!.data() as Map<String, dynamic>;
              final String name = groupData['name'] ?? '';
              final String description = groupData['description'] ?? '';
              final Timestamp createdAt = groupData['createdAt'] ?? Timestamp.now();
              final int memberCount = groupData['memberCount'] ?? 0;
              final String category = groupData['category'] ?? 'General';

              return Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text('Name: $name', style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.textHigh)),
                  SizedBox(height: 8),
                  if (description.isNotEmpty) Text('Description: $description', style: TextStyle(color: AppColors.textMedium)),
                  SizedBox(height: 8),
                  Text('Category: $category', style: TextStyle(color: AppColors.textMedium)),
                  SizedBox(height: 8),
                  Text('Created: ${DateFormat.yMMMd().format(createdAt.toDate())}', style: TextStyle(color: AppColors.textMedium)),
                  SizedBox(height: 8),
                  Text('Members: $memberCount', style: TextStyle(color: AppColors.textMedium)),
                ],
              );
            },
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: Text('Close', style: TextStyle(color: AppColors.primaryLavender)),
            ),
          ],
        );
      },
    );
  }

  // NEW: Group media screen
  void _showGroupMedia() {
    // Implementation for showing group media
    // This would typically navigate to a new screen showing images, videos, and links
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => GroupMediaScreen(groupId: widget.groupId),
      ),
    );
  }

  // NEW: Search dialog
  void _showSearchDialog() {
    showDialog(
      context: context,
      builder: (context) {
        final TextEditingController searchController = TextEditingController();
        return AlertDialog(
          title: Text('Search in Chat', style: TextStyle(color: AppColors.textHigh)),
          content: TextField(
            controller: searchController,
            style: TextStyle(color: AppColors.textHigh),
            decoration: InputDecoration(
              hintText: 'Enter search term...',
              hintStyle: TextStyle(color: AppColors.textDisabled),
              border: OutlineInputBorder(),
              filled: true,
              fillColor: AppColors.elevation,
            ),
          ),
          backgroundColor: AppColors.surface,
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: Text('Cancel', style: TextStyle(color: AppColors.textDisabled)),
            ),
            TextButton(
              onPressed: () {
                // Implement search functionality
                _searchInChat(searchController.text);
                Navigator.pop(context);
              },
              child: Text('Search', style: TextStyle(color: AppColors.primaryLavender)),
            ),
          ],
        );
      },
    );
  }

  // NEW: Search in chat implementation
  void _searchInChat(String query) {
    // Implementation for searching within the chat
    // This would typically filter messages based on the query
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('Search for: $query')),
    );
  }

  // NEW: Leave group functionality
  void _leaveGroup() {
    showDialog(
      context: context,
      builder: (context) {
        return AlertDialog(
          title: Text('Leave Group', style: TextStyle(color: AppColors.textHigh)),
          content: Text('Are you sure you want to leave this group?', style: TextStyle(color: AppColors.textMedium)),
          backgroundColor: AppColors.surface,
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: Text('Cancel', style: TextStyle(color: AppColors.textDisabled)),
            ),
            TextButton(
              onPressed: () async {
                Navigator.pop(context);
                try {
                  await _groupDocRef.update({
                    'members': FieldValue.arrayRemove([_currentUserId]),
                    'memberCount': FieldValue.increment(-1),
                    'unreadCount.$_currentUserId': FieldValue.delete(),
                  });

                  // If user was admin, remove from admins list
                  if (_isAdmin) {
                    await _groupDocRef.update({
                      'admins': FieldValue.arrayRemove([_currentUserId]),
                    });
                  }

                  // If user was moderator, remove from moderators list
                  if (_isModerator) {
                    await _groupDocRef.update({
                      'moderators': FieldValue.arrayRemove([_currentUserId]),
                    });
                  }

                  Navigator.pop(context); // Go back to groups list
                } catch (e) {
                  print("Error leaving group: $e");
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(content: Text('Failed to leave group. Please try again.')),
                  );
                }
              },
              child: Text('Leave', style: TextStyle(color: AppColors.error)),
            ),
          ],
        );
      },
    );
  }

  // NEW: Report group functionality
  void _reportGroup() {
    showDialog(
      context: context,
      builder: (context) {
        final TextEditingController reportController = TextEditingController();
        return AlertDialog(
          title: Text('Report Group', style: TextStyle(color: AppColors.textHigh)),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text('Please describe the issue:', style: TextStyle(color: AppColors.textMedium)),
              SizedBox(height: 8),
              TextField(
                controller: reportController,
                style: TextStyle(color: AppColors.textHigh),
                decoration: InputDecoration(
                  border: OutlineInputBorder(),
                  filled: true,
                  fillColor: AppColors.elevation,
                ),
                maxLines: 3,
              ),
            ],
          ),
          backgroundColor: AppColors.surface,
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: Text('Cancel', style: TextStyle(color: AppColors.textDisabled)),
            ),
            TextButton(
              onPressed: () {
                // Implement report functionality
                _submitReport(reportController.text);
                Navigator.pop(context);
              },
              child: Text('Submit Report', style: TextStyle(color: AppColors.primaryLavender)),
            ),
          ],
        );
      },
    );
  }

  // NEW: Submit report implementation
  void _submitReport(String reason) {
    // Implementation for submitting a group report
    // This would typically save the report to a separate collection
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('Report submitted successfully')),
    );
  }
}

// NEW: GroupMediaScreen class for showing group media
class GroupMediaScreen extends StatelessWidget {
  final String groupId;

  const GroupMediaScreen({Key? key, required this.groupId}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: Text('Group Media', style: TextStyle(color: AppColors.textHigh)),
        backgroundColor: Colors.transparent,
      ),
      body: StreamBuilder<QuerySnapshot>(
        stream: FirebaseFirestore.instance
            .collection('groups')
            .doc(groupId)
            .collection('messages')
            .where('type', whereIn: ['image', 'video'])
            .snapshots(),
        builder: (context, snapshot) {
          if (!snapshot.hasData) {
            return Center(child: CircularProgressIndicator(color: AppColors.primaryLavender));
          }

          final mediaMessages = snapshot.data!.docs;

          return GridView.builder(
            gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
              crossAxisCount: 3,
              crossAxisSpacing: 2,
              mainAxisSpacing: 2,
            ),
            itemCount: mediaMessages.length,
            itemBuilder: (context, index) {
              final message = mediaMessages[index];
              final messageData = message.data() as Map<String, dynamic>;
              final String mediaUrl = messageData['imageUrl'] ?? '';

              return GestureDetector(
                onTap: () {
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (context) => ImageViewerScreen(imageUrl: mediaUrl),
                    ),
                  );
                },
                child: CachedNetworkImage(
                  imageUrl: mediaUrl,
                  fit: BoxFit.cover,
                  placeholder: (context, url) => Container(
                    color: AppColors.elevation,
                    child: Center(child: CircularProgressIndicator(color: AppColors.primaryLavender)),
                  ),
                  errorWidget: (context, url, error) => Icon(Feather.alert_circle, color: AppColors.error),
                ),
              );
            },
          );
        },
      ),
    );
  }
}

class ImagePreviewScreen extends StatefulWidget {
  final File imageFile;
  const ImagePreviewScreen({Key? key, required this.imageFile})
      : super(key: key);

  @override
  _ImagePreviewScreenState createState() => _ImagePreviewScreenState();
}

class _ImagePreviewScreenState extends State<ImagePreviewScreen> {
  final TextEditingController _captionController = TextEditingController();
  File? _editedImage;

  @override
  void initState() {
    super.initState();
    _editedImage = widget.imageFile;
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('Edit Image', style: TextStyle(color: AppColors.textHigh)),
        backgroundColor: Colors.transparent,
        foregroundColor: AppColors.textHigh,
        actions: [
          IconButton(
            icon: Icon(Feather.check, color: AppColors.primaryLavender),
            onPressed: () {
              Navigator.pop(context, {
                'image': _editedImage!,
                'caption': _captionController.text,
              });
            },
          ),
        ],
      ),
      backgroundColor: Colors.transparent,
      body: Column(
        children: [
          Expanded(
            child: InteractiveViewer(
              child: Image.file(_editedImage!),
            ),
          ),
          Padding(
            padding: EdgeInsets.all(16),
            child: TextField(
              controller: _captionController,
              style: TextStyle(color: AppColors.textHigh),
              decoration: InputDecoration(
                hintText: 'Add a caption...',
                hintStyle: TextStyle(color: AppColors.textDisabled),
                border: OutlineInputBorder(),
                filled: true,
                fillColor: AppColors.elevation,
              ),
            ),
          ),
        ],
      ),
    );
  }
}

class ImageViewerScreen extends StatelessWidget {
  final String imageUrl;
  const ImageViewerScreen({Key? key, required this.imageUrl}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black,
      body: GestureDetector(
        onTap: () => Navigator.pop(context),
        child: Center(
          child: Hero(
            tag: imageUrl,
            child: CachedNetworkImage(
              imageUrl: imageUrl,
              fit: BoxFit.contain,
            ),
          ),
        ),
      ),
    );
  }
}

  // Custom painter for waveform visualization
  class _WaveformPainter extends CustomPainter {
    final int duration;

    _WaveformPainter(this.duration);

    @override
    void paint(Canvas canvas, Size size) {
      final paint = Paint()
        ..color = AppColors.textOnSecondary
        ..style = PaintingStyle.fill;

      final rng = Random(duration);
      final barWidth = 3.0;
      final spacing = 2.0;
      final totalBars = (size.width / (barWidth + spacing)).floor();

      for (int i = 0; i < totalBars; i++) {
        final height = rng.nextDouble() * size.height;
        final x = i * (barWidth + spacing);

        canvas.drawRect(
          Rect.fromLTWH(x, (size.height - height) / 2, barWidth, height),
          paint,
        );
      }
    }

    @override
    bool shouldRepaint(covariant CustomPainter oldDelegate) => true;
  }

void main() {
  runApp(MaterialApp(
    title: 'Women Support Groups',
    theme: ThemeData(
      primaryColor: AppColors.primaryLavender,
      colorScheme: ColorScheme.dark(
        primary: AppColors.primaryLavender,
        secondary: AppColors.secondaryTeal,
        background: AppColors.backgroundDeep,
        surface: AppColors.surface,
        onPrimary: AppColors.textOnSecondary,
        onSecondary: AppColors.textOnSecondary,
        onBackground: AppColors.textHigh,
        onSurface: AppColors.textHigh,
      ),
      scaffoldBackgroundColor: AppColors.backgroundDeep,
      appBarTheme: AppBarTheme(
        backgroundColor: Colors.transparent,
        foregroundColor: AppColors.textHigh,
        elevation: 0,
      ),
      floatingActionButtonTheme: FloatingActionButtonThemeData(
        backgroundColor: AppColors.primaryLavender,
        foregroundColor: AppColors.textOnSecondary,
      ),
    ),
    home: GroupsScreen(),
  ));
}


--- C:\Code\femn\lib\circle\petitions.dart ---

import 'dart:io';
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:uuid/uuid.dart';
import 'package:image_picker/image_picker.dart';
import 'package:image_cropper/image_cropper.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:intl/intl.dart';
import 'package:share_plus/share_plus.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:femn/customization/colors.dart';
import 'package:femn/customization/layout.dart';
import 'package:fl_chart/fl_chart.dart';
import '../../feed/personalized_feed_service.dart'; // Import Service
import 'package:google_fonts/google_fonts.dart'; // <--- IMPORT COLORS
import '../services/notification_service.dart';

final List<String> _ageRatings = ['13-17', '18-25', '26+'];

// Enhanced Petition Model with Comments, Analytics, and Discussion Settings
class Petition {
  final String id;
  final String title;
  final String description;
  final String fullStory;
  final int goal;
  final int currentSignatures;
  final String createdBy;
  final String? bannerImageUrl;
  final String ageRating;
  final List<String> hashtags;
  final List<String> signers;
  final List<PetitionSignature> signaturesWithComments;
  final Timestamp createdAt;
  final Timestamp? deadline;
  final int views;
  final int shares;
  final List<String> tags;
  final bool isFeatured;
  final String category;

  // Discussion settings
  final bool discussionEnabled;
  final List<String> discussionModerators;
  final List<String> collaborators;
  final List<String> externalLinks;
  final Map<String, dynamic>? discussionSettings;

  Petition({
    required this.id,
    required this.title,
    required this.description,
    required this.fullStory,
    required this.goal,
    required this.currentSignatures,
    required this.createdBy,
    this.bannerImageUrl,
    required this.ageRating,
    required this.hashtags,
    required this.signers,
    required this.signaturesWithComments,
    required this.createdAt,
    this.deadline,
    this.views = 0,
    this.shares = 0,
    this.tags = const [],
    this.isFeatured = false,
    this.category = 'General',
    this.discussionEnabled = true,
    this.discussionModerators = const [],
    this.collaborators = const [],
    this.externalLinks = const [],
    this.discussionSettings,
  });

  factory Petition.fromDocument(DocumentSnapshot doc) {
    final data = doc.data() as Map<String, dynamic>;

    List<PetitionSignature> signatures = [];
    if (data['signaturesWithComments'] != null) {
      signatures = (data['signaturesWithComments'] as List)
          .map((sig) => PetitionSignature.fromMap(sig))
          .toList();
    }

    return Petition(
      id: data['id'] ?? doc.id,
      title: data['title'] ?? '',
      description: data['description'] ?? '',
      fullStory: data['fullStory'] ?? '',
      goal: data['goal'] ?? 0,
      currentSignatures: data['currentSignatures'] ?? 0,
      createdBy: data['createdBy'] ?? '',
      bannerImageUrl: data['bannerImageUrl'],
      ageRating: data['ageRating'] ?? '13-17',
      hashtags: List<String>.from(data['hashtags'] ?? []),
      signers: List<String>.from(data['signers'] ?? []),
      signaturesWithComments: signatures,
      createdAt: data['createdAt'] ?? Timestamp.now(),
      deadline: data['deadline'],
      views: data['views'] ?? 0,
      shares: data['shares'] ?? 0,
      tags: List<String>.from(data['tags'] ?? []),
      isFeatured: data['isFeatured'] ?? false,
      category: data['category'] ?? 'General',
      discussionEnabled: data['discussionEnabled'] ?? true,
      discussionModerators: List<String>.from(
        data['discussionModerators'] ?? [],
      ),
      collaborators: List<String>.from(data['collaborators'] ?? []),
      externalLinks: List<String>.from(data['externalLinks'] ?? []),
      discussionSettings: data['discussionSettings'],
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'title': title,
      'description': description,
      'fullStory': fullStory,
      'goal': goal,
      'currentSignatures': currentSignatures,
      'createdBy': createdBy,
      'bannerImageUrl': bannerImageUrl,
      'ageRating': ageRating,
      'hashtags': hashtags,
      'signers': signers,
      'signaturesWithComments': signaturesWithComments
          .map((sig) => sig.toMap())
          .toList(),
      'createdAt': createdAt,
      'deadline': deadline,
      'views': views,
      'shares': shares,
      'tags': tags,
      'isFeatured': isFeatured,
      'category': category,
      'discussionEnabled': discussionEnabled,
      'discussionModerators': discussionModerators,
      'collaborators': collaborators,
      'externalLinks': externalLinks,
      'discussionSettings': discussionSettings,
    };
  }

  bool get hasDeadline => deadline != null;
  bool get isExpired =>
      hasDeadline && deadline!.toDate().isBefore(DateTime.now());
  int get daysLeft {
    if (!hasDeadline) return -1;
    final now = DateTime.now();
    final end = deadline!.toDate();
    final difference = end.difference(now).inDays;
    return difference >= 0 ? difference : 0;
  }

  double get progress => goal > 0 ? currentSignatures / goal : 0.0;
}

class PetitionSignature {
  final String userId;
  final String username;
  final String? profileImage;
  final String? comment;
  final Timestamp signedAt;
  final bool isPublic;

  PetitionSignature({
    required this.userId,
    required this.username,
    this.profileImage,
    this.comment,
    required this.signedAt,
    this.isPublic = true,
  });

  factory PetitionSignature.fromMap(Map<String, dynamic> data) {
    return PetitionSignature(
      userId: data['userId'],
      username: data['username'],
      profileImage: data['profileImage'],
      comment: data['comment'],
      signedAt: data['signedAt'],
      isPublic: data['isPublic'] ?? true,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'userId': userId,
      'username': username,
      'profileImage': profileImage,
      'comment': comment,
      'signedAt': signedAt,
      'isPublic': isPublic,
    };
  }
}

// Discussion Message Model
class DiscussionMessage {
  final String id;
  final String petitionId;
  final String userId;
  final String username;
  final String? userProfileImage;
  final String text;
  final Timestamp timestamp;
  final String? replyToId;
  final String? replyToUsername;
  final String? replyToText;
  final Map<String, List<String>> reactions; // emoji -> list of user IDs
  final bool isDeleted;
  final String? deletedReason;

  DiscussionMessage({
    required this.id,
    required this.petitionId,
    required this.userId,
    required this.username,
    this.userProfileImage,
    required this.text,
    required this.timestamp,
    this.replyToId,
    this.replyToUsername,
    this.replyToText,
    this.reactions = const {},
    this.isDeleted = false,
    this.deletedReason,
  });

  factory DiscussionMessage.fromDocument(DocumentSnapshot doc) {
    final data = doc.data() as Map<String, dynamic>;

    Map<String, List<String>> reactions = {};
    if (data['reactions'] != null) {
      final reactionsMap = Map<String, dynamic>.from(data['reactions']);
      reactionsMap.forEach((key, value) {
        reactions[key] = List<String>.from(value);
      });
    }

    return DiscussionMessage(
      id: doc.id,
      petitionId: data['petitionId'],
      userId: data['userId'],
      username: data['username'],
      userProfileImage: data['userProfileImage'],
      text: data['text'],
      timestamp: data['timestamp'],
      replyToId: data['replyToId'],
      replyToUsername: data['replyToUsername'],
      replyToText: data['replyToText'],
      reactions: reactions,
      isDeleted: data['isDeleted'] ?? false,
      deletedReason: data['deletedReason'],
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'petitionId': petitionId,
      'userId': userId,
      'username': username,
      'userProfileImage': userProfileImage,
      'text': text,
      'timestamp': timestamp,
      'replyToId': replyToId,
      'replyToUsername': replyToUsername,
      'replyToText': replyToText,
      'reactions': reactions,
      'isDeleted': isDeleted,
      'deletedReason': deletedReason,
    };
  }

  bool get hasReplies => false;
  int get totalReactions =>
      reactions.values.fold(0, (sum, userList) => sum + userList.length);

  List<String> getUserReactions(String userId) {
    return reactions.entries
        .where((entry) => entry.value.contains(userId))
        .map((entry) => entry.key)
        .toList();
  }
}

// Enhanced Petition Creation Screen
class EnhancedPetitionCreationScreen extends StatefulWidget {
  final Petition? existingPetition;
  const EnhancedPetitionCreationScreen({Key? key, this.existingPetition})
    : super(key: key);

  @override
  _EnhancedPetitionCreationScreenState createState() =>
      _EnhancedPetitionCreationScreenState();
}

class _EnhancedPetitionCreationScreenState
    extends State<EnhancedPetitionCreationScreen> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseStorage _storage = FirebaseStorage.instance;
  final TextEditingController _titleController = TextEditingController();
  final TextEditingController _descriptionController = TextEditingController();
  final TextEditingController _fullStoryController = TextEditingController();
  final TextEditingController _goalController = TextEditingController(
    text: '100',
  );
  final TextEditingController _hashtagController = TextEditingController();
  String _selectedAgeRating = '13-17';
  String _selectedCategory = 'General';
  List<String> _hashtags = [];
  List<String> _tags = [];
  final List<String> _externalLinks = ['', '']; // Max 2 links
  final List<String> _collaborators = [];
  File? _bannerImage;
  String? _existingBannerUrl;
  DateTime? _deadline;
  bool _isLoading = false;
  bool _isEditing = false;

  @override
  void initState() {
    super.initState();
    if (widget.existingPetition != null) {
      _isEditing = true;
      _titleController.text = widget.existingPetition!.title;
      _descriptionController.text = widget.existingPetition!.description;
      _fullStoryController.text = widget.existingPetition!.fullStory;
      _goalController.text = widget.existingPetition!.goal.toString();
      _selectedAgeRating = widget.existingPetition!.ageRating;
      _selectedCategory = widget.existingPetition!.category;
      _hashtags = List<String>.from(widget.existingPetition!.hashtags);
      _collaborators.addAll(widget.existingPetition!.collaborators);
      _existingBannerUrl = widget.existingPetition!.bannerImageUrl;
      _deadline = widget.existingPetition!.deadline?.toDate();

      // Load links
      for (
        int i = 0;
        i < widget.existingPetition!.externalLinks.length && i < 2;
        i++
      ) {
        _externalLinks[i] = widget.existingPetition!.externalLinks[i];
      }
    }
  }

  final List<String> _categories = [
    'General',
    'Environment',
    'Human Rights',
    'Education',
    'Health',
    'Politics',
    'Animal Rights',
    'Social Justice',
    'Technology',
    'Other',
  ];

  Future<void> _pickBannerImage() async {
    final pickedFile = await ImagePicker().pickImage(
      source: ImageSource.gallery,
    );
    if (pickedFile != null) {
      final croppedFile = await ImageCropper().cropImage(
        sourcePath: pickedFile.path,
        uiSettings: [
          AndroidUiSettings(
            toolbarTitle: 'Crop Banner',
            toolbarColor: AppColors.backgroundDeep,
            toolbarWidgetColor: AppColors.textHigh,
            activeControlsWidgetColor: AppColors.primaryLavender,
            backgroundColor: Colors.transparent,
            statusBarColor: AppColors.backgroundDeep,
            initAspectRatio: CropAspectRatioPreset.original,
            lockAspectRatio: true,
            hideBottomControls: false,
          ),
          IOSUiSettings(
            title: 'Crop Banner',
            aspectRatioLockEnabled: true,
            resetButtonHidden: false,
            rotateButtonsHidden: false,
            rotateClockwiseButtonHidden: false,
            aspectRatioPickerButtonHidden: true,
            hidesNavigationBar: false,
          ),
        ],
        aspectRatio: CropAspectRatio(
          ratioX: 9,
          ratioY: 16,
        ), // Consistent Vertical Crop
      );

      if (croppedFile != null) {
        setState(() {
          _bannerImage = File(croppedFile.path);
          _existingBannerUrl =
              null; // Preference local over existing during edit
        });
      }
    }
  }

  Future<void> _selectDeadline() async {
    final DateTime? picked = await showDatePicker(
      context: context,
      initialDate: DateTime.now().add(Duration(days: 30)),
      firstDate: DateTime.now(),
      lastDate: DateTime.now().add(Duration(days: 365)),
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: ColorScheme.dark(
              primary: AppColors.primaryLavender,
              onPrimary: AppColors.backgroundDeep,
              surface: AppColors.surface,
              onSurface: AppColors.textHigh,
            ),
          ),
          child: child!,
        );
      },
    );
    if (picked != null) {
      setState(() {
        _deadline = picked;
      });
    }
  }

  Future<String?> _uploadBannerImage(String petitionId) async {
    if (_bannerImage == null) return null;
    try {
      final ref = _storage
          .ref()
          .child('petition_banners')
          .child('$petitionId.jpg');
      final uploadTask = ref.putFile(_bannerImage!);
      final snapshot = await uploadTask;
      return await snapshot.ref.getDownloadURL();
    } catch (e) {
      print("Error uploading banner image: $e");
      return null;
    }
  }

  Future<void> _createEnhancedPetition() async {
    final title = _titleController.text.trim();
    final description = _descriptionController.text.trim();
    final fullStory = _fullStoryController.text.trim();
    final goalText = _goalController.text.trim();
    final currentUserId = _auth.currentUser?.uid;

    if (title.isEmpty ||
        description.isEmpty ||
        fullStory.isEmpty ||
        goalText.isEmpty ||
        (_bannerImage == null && _existingBannerUrl == null) ||
        currentUserId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(
            'Title, Description, Full Story, Goal, and Banner Image are mandatory.',
          ),
        ),
      );
      return;
    }

    // Validate links: Maximum 2, only GoFundMe, TikTok, Instagram
    List<String> validLinks = _externalLinks
        .where((l) => l.trim().isNotEmpty)
        .map((l) => l.trim())
        .toList();
    if (validLinks.length > 2) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Maximum 2 attachment links allowed.')),
      );
      return;
    }

    for (String link in validLinks) {
      bool isAllowed =
          link.contains('gofundme.com') ||
          link.contains('tiktok.com') ||
          link.contains('instagram.com');
      if (!isAllowed) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              'Allowed links: GoFundMe, TikTok, and Instagram only.',
            ),
          ),
        );
        return;
      }
    }

    int goal;
    try {
      goal = int.parse(goalText);
      if (goal <= 0) throw FormatException("Goal must be positive");
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Goal must be a valid positive number.')),
      );
      return;
    }

    setState(() {
      _isLoading = true;
    });

    try {
      final petitionId = _isEditing ? widget.existingPetition!.id : Uuid().v4();
      String? bannerImageUrl = _existingBannerUrl;
      if (_bannerImage != null) {
        bannerImageUrl = await _uploadBannerImage(petitionId);
      }

      final petitionData = {
        'id': petitionId,
        'title': title,
        'description': description,
        'fullStory': fullStory,
        'goal': goal,
        'createdBy': _isEditing
            ? widget.existingPetition!.createdBy
            : currentUserId,
        'createdAt': _isEditing
            ? widget.existingPetition!.createdAt
            : FieldValue.serverTimestamp(),
        'ageRating': _selectedAgeRating,
        'hashtags': _hashtags,
        'bannerImageUrl': bannerImageUrl,
        'deadline': _deadline != null ? Timestamp.fromDate(_deadline!) : null,
        'category': _selectedCategory,
        'collaborators': _collaborators,
        'externalLinks': validLinks,
        'discussionModerators': _isEditing
            ? widget.existingPetition!.discussionModerators
            : [currentUserId],
      };

      if (_isEditing) {
        await _firestore
            .collection('petitions')
            .doc(petitionId)
            .update(petitionData);
      } else {
        petitionData['currentSignatures'] = 0;
        petitionData['signers'] = [];
        petitionData['signaturesWithComments'] = [];
        petitionData['views'] = 0;
        petitionData['shares'] = 0;
        petitionData['isFeatured'] = false;
        petitionData['discussionEnabled'] = true;
        await _firestore
            .collection('petitions')
            .doc(petitionId)
            .set(petitionData);

        // Send notifications to followers
        final userDoc = await _firestore
            .collection('users')
            .doc(currentUserId)
            .get();
        final username = userDoc.data()?['username'] ?? 'User';
        NotificationService().sendPetitionCreatedNotification(
          creatorId: currentUserId,
          creatorUsername: username,
          petitionId: petitionId,
          petitionTitle: title,
          bannerImageUrl: bannerImageUrl,
        );
      }

      Navigator.pushReplacement(
        context,
        MaterialPageRoute(
          builder: (context) =>
              EnhancedPetitionDetailScreen(petitionId: petitionId),
        ),
      );
    } catch (e) {
      print("Error saving petition: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to save petition. Please try again.')),
      );
    } finally {
      setState(() {
        _isLoading = false;
      });
    }
  }

  Widget _buildSectionHeader(
    String title,
    IconData icon, {
    bool isMandatory = false,
  }) {
    return Row(
      children: [
        Container(
          width: 30,
          height: 30,
          decoration: BoxDecoration(
            color: AppColors.primaryLavender.withOpacity(0.1),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Icon(icon, size: 18, color: AppColors.primaryLavender),
        ),
        SizedBox(width: 10),
        Row(
          children: [
            Text(
              title,
              style: TextStyle(
                fontSize: 16,
                fontWeight: FontWeight.w600,
                color: AppColors.textHigh,
              ),
            ),
            if (isMandatory)
              const Text(
                ' *',
                style: TextStyle(
                  color: AppColors.error,
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                ),
              ),
          ],
        ),
      ],
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: Text(
          _isEditing ? 'Edit Petition' : 'Create Enhanced Petition',
          style: TextStyle(
            fontSize: 20,
            fontWeight: FontWeight.w600,
            color: AppColors.textHigh,
          ),
        ),
        backgroundColor: Colors.transparent,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
        elevation: 0,
        centerTitle: true,
      ),
      body: Padding(
        padding: EdgeInsets.all(20.0),
        child: SingleChildScrollView(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Header Section
              Container(
                width: double.infinity,
                padding: EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: AppColors.surface,
                  borderRadius: BorderRadius.circular(20),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Icon(
                          Feather.flag,
                          color: AppColors.primaryLavender,
                          size: 24,
                        ),
                        SizedBox(width: 10),
                        Text(
                          'Start Your Movement',
                          style: TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.w600,
                            color: AppColors.textHigh,
                          ),
                        ),
                      ],
                    ),
                    SizedBox(height: 8),
                    Text(
                      'Fill in the details below to create your petition and make a difference!',
                      style: TextStyle(
                        color: AppColors.textMedium,
                        fontSize: 14,
                      ),
                    ),
                  ],
                ),
              ),
              SizedBox(height: 24),
              // Petition Title
              _buildSectionHeader(
                'Petition Title',
                Feather.type,
                isMandatory: true,
              ),
              SizedBox(height: 8),
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(15),
                  color: AppColors.elevation,
                ),
                child: TextField(
                  controller: _titleController,
                  style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                  decoration: InputDecoration(
                    labelText: 'What change do you want to see?',
                    labelStyle: TextStyle(color: AppColors.textMedium),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(15),
                      borderSide: BorderSide.none,
                    ),
                    filled: true,
                    fillColor: AppColors.elevation,
                    prefixIcon: Icon(
                      Feather.edit_2,
                      color: AppColors.primaryLavender,
                    ),
                    contentPadding: EdgeInsets.symmetric(
                      horizontal: 20,
                      vertical: 16,
                    ),
                  ),
                ),
              ),
              SizedBox(height: 20),
              // Short Description
              _buildSectionHeader(
                'Short Description',
                Feather.file_text,
                isMandatory: true,
              ),
              SizedBox(height: 8),
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(15),
                  color: AppColors.elevation,
                ),
                child: TextField(
                  controller: _descriptionController,
                  style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                  decoration: InputDecoration(
                    labelText: 'Brief description of your petition...',
                    labelStyle: TextStyle(color: AppColors.textMedium),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(15),
                      borderSide: BorderSide.none,
                    ),
                    filled: true,
                    fillColor: AppColors.elevation,
                    alignLabelWithHint: true,
                    contentPadding: EdgeInsets.all(20),
                  ),
                  maxLines: 3,
                ),
              ),
              SizedBox(height: 20),
              // Full Story
              _buildSectionHeader(
                'Full Story',
                Feather.file_text,
                isMandatory: true,
              ),
              SizedBox(height: 8),
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(15),
                  color: AppColors.elevation,
                ),
                child: TextField(
                  controller: _fullStoryController,
                  style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                  decoration: InputDecoration(
                    labelText:
                        'Tell the complete story behind your petition...',
                    labelStyle: TextStyle(color: AppColors.textMedium),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(15),
                      borderSide: BorderSide.none,
                    ),
                    filled: true,
                    fillColor: AppColors.elevation,
                    alignLabelWithHint: true,
                    contentPadding: EdgeInsets.all(20),
                  ),
                  maxLines: 6,
                ),
              ),
              SizedBox(height: 20),
              // Signature Goal
              _buildSectionHeader(
                'Signature Goal',
                Feather.users,
                isMandatory: true,
              ),
              SizedBox(height: 8),
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(15),
                  color: AppColors.elevation,
                ),
                child: TextField(
                  controller: _goalController,
                  style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                  decoration: InputDecoration(
                    labelText: 'How many signatures do you need?',
                    labelStyle: TextStyle(color: AppColors.textMedium),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(15),
                      borderSide: BorderSide.none,
                    ),
                    filled: true,
                    fillColor: AppColors.elevation,
                    prefixIcon: Icon(
                      Feather.flag,
                      color: AppColors.primaryLavender,
                    ),
                    contentPadding: EdgeInsets.symmetric(
                      horizontal: 20,
                      vertical: 16,
                    ),
                  ),
                  keyboardType: TextInputType.number,
                ),
              ),
              SizedBox(height: 20),
              // Category Selection
              _buildSectionHeader('Category', Feather.grid),
              SizedBox(height: 8),
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(15),
                  color: AppColors.elevation,
                ),
                child: DropdownButtonFormField<String>(
                  value: _selectedCategory,
                  items: _categories.map((category) {
                    return DropdownMenuItem<String>(
                      value: category,
                      child: Text(category),
                    );
                  }).toList(),
                  onChanged: (value) {
                    setState(() {
                      _selectedCategory = value!;
                    });
                  },
                  decoration: InputDecoration(
                    labelText: 'Select Category',
                    labelStyle: TextStyle(color: AppColors.textMedium),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(15),
                      borderSide: BorderSide.none,
                    ),
                    filled: true,
                    fillColor: AppColors.elevation,
                    prefixIcon: Icon(
                      Feather.grid,
                      color: AppColors.primaryLavender,
                    ),
                    contentPadding: EdgeInsets.symmetric(horizontal: 20),
                  ),
                  dropdownColor: AppColors.surface,
                  style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                  iconEnabledColor: AppColors.primaryLavender,
                ),
              ),
              SizedBox(height: 20),
              // Deadline Selection
              _buildSectionHeader('Deadline', Feather.calendar),
              SizedBox(height: 8),
              Container(
                decoration: BoxDecoration(
                  color: AppColors.elevation,
                  borderRadius: BorderRadius.circular(15),
                ),
                child: ListTile(
                  leading: Container(
                    width: 40,
                    height: 40,
                    decoration: BoxDecoration(
                      color: AppColors.primaryLavender.withOpacity(0.1),
                      borderRadius: BorderRadius.circular(10),
                    ),
                    child: Icon(
                      Feather.calendar,
                      color: AppColors.primaryLavender,
                    ),
                  ),
                  title: Text(
                    _deadline == null
                        ? 'Add Deadline (Optional)'
                        : 'Deadline: ${DateFormat('MMM d, yyyy').format(_deadline!)}',
                    style: TextStyle(
                      color: _deadline != null
                          ? AppColors.primaryLavender
                          : AppColors.textMedium,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  subtitle: _deadline != null
                      ? Text(
                          '${_deadline!.difference(DateTime.now()).inDays} days from now',
                          style: TextStyle(color: AppColors.textMedium),
                        )
                      : Text(
                          'Set an end date for your petition',
                          style: TextStyle(color: AppColors.textDisabled),
                        ),
                  trailing: ElevatedButton(
                    onPressed: _selectDeadline,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryLavender.withOpacity(
                        0.1,
                      ),
                      foregroundColor: AppColors.primaryLavender,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(10),
                      ),
                      elevation: 0,
                    ),
                    child: Text(_deadline == null ? 'Add' : 'Change'),
                  ),
                  onTap: _selectDeadline,
                ),
              ),
              SizedBox(height: 20),
              // Banner Image Upload
              _buildSectionHeader(
                'Banner Image',
                Feather.image,
                isMandatory: true,
              ),
              SizedBox(height: 8),
              if (_bannerImage != null || _existingBannerUrl != null)
                Padding(
                  padding: const EdgeInsets.only(bottom: 12.0),
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(15),
                    child: _bannerImage != null
                        ? Image.file(
                            _bannerImage!,
                            height: 300,
                            width: double.infinity,
                            fit: BoxFit.cover,
                          )
                        : CachedNetworkImage(
                            imageUrl: _existingBannerUrl!,
                            height: 300,
                            width: double.infinity,
                            fit: BoxFit.cover,
                          ),
                  ),
                ),
              Container(
                decoration: BoxDecoration(
                  color: AppColors.elevation,
                  borderRadius: BorderRadius.circular(15),
                ),
                child: ListTile(
                  leading: Container(
                    width: 40,
                    height: 40,
                    decoration: BoxDecoration(
                      color: AppColors.primaryLavender.withOpacity(0.1),
                      borderRadius: BorderRadius.circular(10),
                    ),
                    child: Icon(
                      Feather.image,
                      color: AppColors.primaryLavender,
                    ),
                  ),
                  title: Text(
                    (_bannerImage != null || _existingBannerUrl != null)
                        ? 'Image Selected'
                        : 'Add Banner Image',
                    style: TextStyle(
                      color:
                          (_bannerImage != null || _existingBannerUrl != null)
                          ? AppColors.primaryLavender
                          : AppColors.textMedium,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  subtitle: Text(
                    'Make your petition visually appealing',
                    style: TextStyle(color: AppColors.textDisabled),
                  ),
                  trailing: ElevatedButton(
                    onPressed: _pickBannerImage,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryLavender.withOpacity(
                        0.1,
                      ),
                      foregroundColor: AppColors.primaryLavender,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(10),
                      ),
                      elevation: 0,
                    ),
                    child: Text(
                      (_bannerImage != null || _existingBannerUrl != null)
                          ? 'Change'
                          : 'Upload',
                    ),
                  ),
                ),
              ),
              SizedBox(height: 20),
              // Hashtags
              _buildSectionHeader('Hashtags', Feather.hash),
              SizedBox(height: 8),
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(15),
                  color: AppColors.elevation,
                ),
                child: TextField(
                  controller: _hashtagController,
                  style: TextStyle(color: AppColors.textHigh),
                  decoration: InputDecoration(
                    labelText: 'Add relevant hashtags',
                    labelStyle: TextStyle(color: AppColors.textMedium),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(15),
                      borderSide: BorderSide.none,
                    ),
                    filled: true,
                    fillColor: AppColors.elevation,
                    prefixIcon: Icon(
                      Feather.hash,
                      color: AppColors.primaryLavender,
                    ),
                    suffixIcon: IconButton(
                      icon: Container(
                        width: 32,
                        height: 32,
                        decoration: BoxDecoration(
                          color: AppColors.primaryLavender,
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Icon(
                          Feather.plus,
                          color: AppColors.backgroundDeep,
                          size: 18,
                        ),
                      ),
                      onPressed: () {
                        String newTag = _hashtagController.text
                            .trim()
                            .replaceAll('#', '');
                        if (newTag.isNotEmpty && !_hashtags.contains(newTag)) {
                          setState(() {
                            _hashtags.add(newTag);
                          });
                          _hashtagController.clear();
                        }
                      },
                    ),
                    contentPadding: EdgeInsets.symmetric(
                      horizontal: 20,
                      vertical: 16,
                    ),
                  ),
                  onSubmitted: (_) {
                    String newTag = _hashtagController.text.trim().replaceAll(
                      '#',
                      '',
                    );
                    if (newTag.isNotEmpty && !_hashtags.contains(newTag)) {
                      setState(() {
                        _hashtags.add(newTag);
                      });
                      _hashtagController.clear();
                    }
                  },
                ),
              ),
              SizedBox(height: 12),
              // Display added hashtags
              if (_hashtags.isNotEmpty)
                Wrap(
                  spacing: 8.0,
                  runSpacing: 8.0,
                  children: _hashtags.map((tag) {
                    return Container(
                      decoration: BoxDecoration(
                        color: AppColors.secondaryTeal.withOpacity(0.2),
                        borderRadius: BorderRadius.circular(20),
                      ),
                      child: Padding(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 12,
                          vertical: 6,
                        ),
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Text(
                              '#$tag',
                              style: TextStyle(
                                color: AppColors.secondaryTeal,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                            SizedBox(width: 4),
                            GestureDetector(
                              onTap: () {
                                setState(() {
                                  _hashtags.remove(tag);
                                });
                              },
                              child: Icon(
                                Feather.x,
                                size: 16,
                                color: AppColors.secondaryTeal,
                              ),
                            ),
                          ],
                        ),
                      ),
                    );
                  }).toList(),
                ),
              SizedBox(height: 20),
              // Age Rating
              _buildSectionHeader('Age Rating', Feather.users),
              SizedBox(height: 8),
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(12),
                  color: AppColors.elevation,
                ),
                child: DropdownButtonFormField<String>(
                  value: _selectedAgeRating,
                  items: _ageRatings.map((rating) {
                    return DropdownMenuItem<String>(
                      value: rating,
                      child: Text(rating),
                    );
                  }).toList(),
                  onChanged: (value) {
                    setState(() {
                      _selectedAgeRating = value!;
                    });
                  },
                  decoration: InputDecoration(
                    labelText: 'Who should see this petition?',
                    labelStyle: TextStyle(color: AppColors.textMedium),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(12),
                      borderSide: BorderSide.none,
                    ),
                    filled: true,
                    fillColor: AppColors.elevation,
                    prefixIcon: Icon(
                      Feather.users,
                      color: AppColors.primaryLavender,
                    ),
                    contentPadding: EdgeInsets.symmetric(
                      horizontal: 20,
                      vertical: 16,
                    ),
                  ),
                  dropdownColor: AppColors.surface,
                  style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                  iconEnabledColor: AppColors.primaryLavender,
                ),
              ),
              SizedBox(height: 24),

              // External Links
              _buildSectionHeader('Support Links (Max 2)', Feather.link),
              SizedBox(height: 8),
              Text(
                'Add GoFundMe, TikTok, or Instagram links to support your cause.',
                style: TextStyle(color: AppColors.textMedium, fontSize: 12),
              ),
              SizedBox(height: 8),
              ...List.generate(
                2,
                (index) => Padding(
                  padding: const EdgeInsets.only(bottom: 8.0),
                  child: Container(
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(15),
                      color: AppColors.elevation,
                    ),
                    child: TextField(
                      onChanged: (v) => _externalLinks[index] = v,
                      style: TextStyle(color: AppColors.textHigh),
                      decoration: InputDecoration(
                        hintText: 'Link ${index + 1} (GoFundMe/Social)',
                        hintStyle: TextStyle(color: AppColors.textDisabled),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(15),
                          borderSide: BorderSide.none,
                        ),
                        filled: true,
                        fillColor: AppColors.elevation,
                        prefixIcon: Icon(
                          Feather.link,
                          color: AppColors.primaryLavender,
                        ),
                      ),
                    ),
                  ),
                ),
              ),

              SizedBox(height: 24),
              // Collaborators Management
              _buildSectionHeader('Collaborators', Feather.user_plus),
              SizedBox(height: 8),
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(15),
                  color: AppColors.elevation,
                ),
                child: TextField(
                  onSubmitted: (v) {
                    if (v.trim().isNotEmpty &&
                        !_collaborators.contains(v.trim())) {
                      setState(() {
                        _collaborators.add(v.trim());
                      });
                    }
                  },
                  style: TextStyle(color: AppColors.textHigh),
                  decoration: InputDecoration(
                    hintText: 'Add collaborator username',
                    hintStyle: TextStyle(color: AppColors.textDisabled),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(15),
                      borderSide: BorderSide.none,
                    ),
                    filled: true,
                    fillColor: AppColors.elevation,
                    prefixIcon: Icon(
                      Feather.user_plus,
                      color: AppColors.primaryLavender,
                    ),
                  ),
                ),
              ),
              if (_collaborators.isNotEmpty)
                Padding(
                  padding: const EdgeInsets.only(top: 12.0),
                  child: Wrap(
                    spacing: 8,
                    children: _collaborators
                        .map(
                          (c) => Chip(
                            label: Text(
                              c,
                              style: TextStyle(
                                color: AppColors.textHigh,
                                fontSize: 12,
                              ),
                            ),
                            backgroundColor: AppColors.surface,
                            deleteIcon: Icon(
                              Feather.x,
                              size: 14,
                              color: AppColors.error,
                            ),
                            onDeleted: () =>
                                setState(() => _collaborators.remove(c)),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                        )
                        .toList(),
                  ),
                ),

              SizedBox(height: 30),
              // Create/Edit Petition Button
              Container(
                width: double.infinity,
                height: 55,
                child: ElevatedButton(
                  onPressed: _isLoading ? null : _createEnhancedPetition,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.primaryLavender,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(15),
                    ),
                  ),
                  child: _isLoading
                      ? CircularProgressIndicator(
                          color: AppColors.backgroundDeep,
                        )
                      : Text(
                          _isEditing
                              ? 'Save Changes'
                              : 'Create Enhanced Petition',
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                            color: AppColors.backgroundDeep,
                          ),
                        ),
                ),
              ),
              SizedBox(height: 20),
            ],
          ),
        ),
      ),
    );
  }
}

// Petition Discussion Screen (New Implementation)
class PetitionDiscussionScreen extends StatefulWidget {
  final String petitionId;
  final bool isSigned;
  final bool isCreator;

  const PetitionDiscussionScreen({
    Key? key,
    required this.petitionId,
    required this.isSigned,
    required this.isCreator,
  }) : super(key: key);

  @override
  _PetitionDiscussionScreenState createState() =>
      _PetitionDiscussionScreenState();
}

class _PetitionDiscussionScreenState extends State<PetitionDiscussionScreen> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final TextEditingController _messageController = TextEditingController();
  final ScrollController _scrollController = ScrollController();

  late String _currentUserId;
  String? _currentUsername;
  Petition? _petition;
  List<DiscussionMessage> _messages = [];
  bool _isLoading = true;
  DiscussionMessage? _replyingTo;
  bool _isSending = false;

  // Available emojis for reactions
  final List<String> _availableReactions = ['', '', '', '', ''];
  DiscussionMessage? _selectedMessageForReaction;

  @override
  void initState() {
    super.initState();
    _currentUserId = _auth.currentUser!.uid;
    _fetchCurrentUsername();
    _loadPetition();
    _loadMessages();
  }

  Future<void> _fetchCurrentUsername() async {
    final userDoc = await _firestore
        .collection('users')
        .doc(_currentUserId)
        .get();
    if (userDoc.exists) {
      if (mounted) {
        setState(() {
          _currentUsername = userDoc.data()?['username'];
        });
      }
    }
  }

  Future<void> _loadPetition() async {
    try {
      final doc = await _firestore
          .collection('petitions')
          .doc(widget.petitionId)
          .get();
      if (doc.exists) {
        setState(() {
          _petition = Petition.fromDocument(doc);
        });
      }
    } catch (e) {
      print("Error loading petition: $e");
    }
  }

  Stream<List<DiscussionMessage>> _getMessagesStream() {
    return _firestore
        .collection('petition_discussions')
        .doc(widget.petitionId)
        .collection('messages')
        .orderBy('timestamp', descending: false)
        .snapshots()
        .map(
          (snapshot) => snapshot.docs
              .map((doc) => DiscussionMessage.fromDocument(doc))
              .toList(),
        );
  }

  void _loadMessages() {
    setState(() {
      _isLoading = true;
    });

    _getMessagesStream().listen(
      (messages) {
        setState(() {
          _messages = messages;
          _isLoading = false;
        });

        // Auto-scroll to bottom when new messages arrive
        WidgetsBinding.instance.addPostFrameCallback((_) {
          if (_scrollController.hasClients) {
            _scrollController.animateTo(
              _scrollController.position.maxScrollExtent,
              duration: Duration(milliseconds: 300),
              curve: Curves.easeOut,
            );
          }
        });
      },
      onError: (error) {
        print("Error loading messages: $error");
        setState(() {
          _isLoading = false;
        });
      },
    );
  }

  Future<void> _sendMessage() async {
    if (_messageController.text.trim().isEmpty || _isSending) return;
    if (!widget.isSigned && !widget.isCreator) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(
            'You must sign the petition to participate in discussion',
          ),
        ),
      );
      return;
    }

    setState(() {
      _isSending = true;
    });

    try {
      final userDoc = await _firestore
          .collection('users')
          .doc(_currentUserId)
          .get();
      final userData = userDoc.data() as Map<String, dynamic>;

      final messageId = Uuid().v4();
      final message = DiscussionMessage(
        id: messageId,
        petitionId: widget.petitionId,
        userId: _currentUserId,
        username: userData['username'] ?? 'User',
        userProfileImage: userData['profileImage'],
        text: _messageController.text.trim(),
        timestamp: Timestamp.now(),
        replyToId: _replyingTo?.id,
        replyToUsername: _replyingTo?.username,
        replyToText: _replyingTo != null
            ? (_replyingTo!.text.length > 50
                  ? '${_replyingTo!.text.substring(0, 50)}...'
                  : _replyingTo!.text)
            : null,
      );

      await _firestore
          .collection('petition_discussions')
          .doc(widget.petitionId)
          .collection('messages')
          .doc(messageId)
          .set(message.toMap());

      _messageController.clear();
      _cancelReply();
    } catch (e) {
      print("Error sending message: $e");
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Failed to send message')));
    } finally {
      setState(() {
        _isSending = false;
      });
    }
  }

  void _startReply(DiscussionMessage message) {
    setState(() {
      _replyingTo = message;
    });
  }

  void _cancelReply() {
    setState(() {
      _replyingTo = null;
    });
  }

  Future<void> _toggleReaction(String messageId, String emoji) async {
    try {
      final messageRef = _firestore
          .collection('petition_discussions')
          .doc(widget.petitionId)
          .collection('messages')
          .doc(messageId);

      final messageDoc = await messageRef.get();
      if (!messageDoc.exists) return;

      final message = DiscussionMessage.fromDocument(messageDoc);
      final currentReactions = Map<String, List<String>>.from(
        message.reactions,
      );
      final usersWhoReacted = currentReactions[emoji] ?? [];

      if (usersWhoReacted.contains(_currentUserId)) {
        // Remove reaction
        usersWhoReacted.remove(_currentUserId);
        if (usersWhoReacted.isEmpty) {
          currentReactions.remove(emoji);
        } else {
          currentReactions[emoji] = usersWhoReacted;
        }
      } else {
        // Add reaction
        usersWhoReacted.add(_currentUserId);
        currentReactions[emoji] = usersWhoReacted;
      }

      await messageRef.update({'reactions': currentReactions});
      _hideReactionMenu();
    } catch (e) {
      print("Error toggling reaction: $e");
    }
  }

  Future<void> _deleteMessage(String messageId) async {
    try {
      final messageRef = _firestore
          .collection('petition_discussions')
          .doc(widget.petitionId)
          .collection('messages')
          .doc(messageId);

      await messageRef.update({
        'isDeleted': true,
        'deletedReason': 'deleted_by_user',
        'text': '[Message deleted]',
      });

      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Message deleted')));
    } catch (e) {
      print("Error deleting message: $e");
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Failed to delete message')));
    }
  }

  Future<void> _adminDeleteMessage(String messageId, String reason) async {
    if (!widget.isCreator && !_isModerator()) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Only moderators can delete messages')),
      );
      return;
    }

    try {
      final messageRef = _firestore
          .collection('petition_discussions')
          .doc(widget.petitionId)
          .collection('messages')
          .doc(messageId);

      await messageRef.update({
        'isDeleted': true,
        'deletedReason': reason,
        'text': '[Message removed by moderator]',
      });

      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Message removed by moderator')));
    } catch (e) {
      print("Error in admin delete: $e");
    }
  }

  bool _isModerator() {
    if (_petition == null) return false;
    final currentUserId = _auth.currentUser?.uid;
    return widget.isCreator ||
        _petition!.createdBy == currentUserId ||
        _petition!.discussionModerators.contains(currentUserId) ||
        (_currentUsername != null &&
            _petition!.collaborators.contains(_currentUsername));
  }

  void _showReactionMenu(DiscussionMessage message) {
    setState(() {
      _selectedMessageForReaction = message;
    });
  }

  void _hideReactionMenu() {
    setState(() {
      _selectedMessageForReaction = null;
    });
  }

  void _showAdminActions(DiscussionMessage message) {
    showModalBottomSheet(
      context: context,
      backgroundColor: AppColors.surface,
      builder: (context) {
        return Container(
          padding: EdgeInsets.all(16),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                'Moderator Actions',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: AppColors.textHigh,
                ),
              ),
              SizedBox(height: 16),
              ListTile(
                leading: Icon(Feather.trash_2, color: AppColors.error),
                title: Text(
                  'Remove Message',
                  style: TextStyle(color: AppColors.textHigh),
                ),
                subtitle: Text(
                  'Remove this message from discussion',
                  style: TextStyle(color: AppColors.textMedium),
                ),
                onTap: () {
                  Navigator.pop(context);
                  _showRemoveReasonDialog(message.id);
                },
              ),
              if (_isModerator() &&
                  !_petition!.discussionModerators.contains(message.userId))
                ListTile(
                  leading: Icon(
                    Feather.shield,
                    color: AppColors.primaryLavender,
                  ),
                  title: Text(
                    'Make Moderator',
                    style: TextStyle(color: AppColors.textHigh),
                  ),
                  subtitle: Text(
                    'Grant moderator privileges to this user',
                    style: TextStyle(color: AppColors.textMedium),
                  ),
                  onTap: () {
                    Navigator.pop(context);
                    _makeModerator(message.userId);
                  },
                ),
            ],
          ),
        );
      },
    );
  }

  void _showRemoveReasonDialog(String messageId) {
    showDialog(
      context: context,
      builder: (context) {
        String reason = 'inappropriate_content';
        return AlertDialog(
          backgroundColor: AppColors.surface,
          title: Text(
            'Remove Message',
            style: TextStyle(color: AppColors.textHigh),
          ),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                'Select removal reason:',
                style: TextStyle(color: AppColors.textMedium),
              ),
              SizedBox(height: 16),
              DropdownButtonFormField<String>(
                value: reason,
                dropdownColor: AppColors.surface,
                style: TextStyle(color: AppColors.textHigh),
                items: [
                  DropdownMenuItem(
                    value: 'inappropriate_content',
                    child: Text('Inappropriate Content'),
                  ),
                  DropdownMenuItem(value: 'spam', child: Text('Spam')),
                  DropdownMenuItem(
                    value: 'harassment',
                    child: Text('Harassment'),
                  ),
                  DropdownMenuItem(
                    value: 'off_topic',
                    child: Text('Off-topic'),
                  ),
                ],
                onChanged: (value) {
                  reason = value!;
                },
              ),
            ],
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: Text(
                'Cancel',
                style: TextStyle(color: AppColors.textMedium),
              ),
            ),
            ElevatedButton(
              onPressed: () {
                Navigator.pop(context);
                _adminDeleteMessage(messageId, reason);
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.error,
                foregroundColor: AppColors.backgroundDeep,
              ),
              child: Text('Remove'),
            ),
          ],
        );
      },
    );
  }

  Future<void> _makeModerator(String userId) async {
    try {
      await _firestore.collection('petitions').doc(widget.petitionId).update({
        'discussionModerators': FieldValue.arrayUnion([userId]),
      });

      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('User added as moderator')));
    } catch (e) {
      print("Error making moderator: $e");
    }
  }

  Widget _buildMessageBubble(DiscussionMessage message) {
    final isCurrentUser = message.userId == _currentUserId;
    final isModerator = _isModerator();
    final userReactions = message.getUserReactions(_currentUserId);

    return Container(
      margin: EdgeInsets.symmetric(vertical: 4, horizontal: 8),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        mainAxisAlignment: isCurrentUser
            ? MainAxisAlignment.end
            : MainAxisAlignment.start,
        children: [
          if (!isCurrentUser) ...[
            CircleAvatar(
              radius: 16,
              backgroundImage: message.userProfileImage != null
                  ? CachedNetworkImageProvider(message.userProfileImage!)
                  : null,
              child: message.userProfileImage == null
                  ? Icon(Feather.user, size: 16)
                  : null,
              backgroundColor: AppColors.elevation,
            ),
            SizedBox(width: 8),
          ],
          Expanded(
            child: Column(
              crossAxisAlignment: isCurrentUser
                  ? CrossAxisAlignment.end
                  : CrossAxisAlignment.start,
              children: [
                if (!isCurrentUser) ...[
                  Row(
                    children: [
                      Text(
                        message.username,
                        style: TextStyle(
                          fontSize: 12,
                          fontWeight: FontWeight.bold,
                          color: AppColors.textMedium,
                        ),
                      ),
                      if (_petition?.discussionModerators.contains(
                            message.userId,
                          ) ??
                          false)
                        Padding(
                          padding: EdgeInsets.only(left: 4),
                          child: Icon(
                            Feather.check_circle,
                            size: 12,
                            color: AppColors.primaryLavender,
                          ),
                        ),
                      if (message.userId == _petition?.createdBy)
                        Padding(
                          padding: EdgeInsets.only(left: 4),
                          child: Icon(
                            Feather.flag,
                            size: 12,
                            color: AppColors.accentMustard,
                          ),
                        ),
                    ],
                  ),
                  SizedBox(height: 2),
                ],
                GestureDetector(
                  onLongPress: () {
                    if (isCurrentUser || isModerator) {
                      _showMessageOptions(message, isCurrentUser);
                    }
                  },
                  onTap: () {
                    if (!isCurrentUser) {
                      _showReactionMenu(message);
                    }
                  },
                  child: Container(
                    padding: EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: isCurrentUser
                          ? AppColors.secondaryTeal
                          : AppColors.elevation,
                      borderRadius: BorderRadius.circular(16),
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        // Reply preview
                        if (message.replyToId != null)
                          Container(
                            padding: EdgeInsets.all(8),
                            margin: EdgeInsets.only(bottom: 8),
                            decoration: BoxDecoration(
                              color: AppColors.backgroundDeep.withOpacity(0.3),
                              borderRadius: BorderRadius.circular(8),
                            ),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  'Replying to ${message.replyToUsername}',
                                  style: TextStyle(
                                    fontSize: 12,
                                    fontWeight: FontWeight.bold,
                                    color: AppColors.textMedium,
                                  ),
                                ),
                                SizedBox(height: 2),
                                Text(
                                  message.replyToText ?? '',
                                  style: TextStyle(
                                    fontSize: 12,
                                    color: AppColors.textMedium,
                                  ),
                                  maxLines: 2,
                                  overflow: TextOverflow.ellipsis,
                                ),
                              ],
                            ),
                          ),
                        // Message text
                        Text(
                          message.isDeleted ? message.text : message.text,
                          style: TextStyle(
                            color: message.isDeleted
                                ? AppColors.textDisabled
                                : (isCurrentUser
                                      ? Colors.white
                                      : AppColors.textHigh),
                            fontStyle: message.isDeleted
                                ? FontStyle.italic
                                : FontStyle.normal,
                          ),
                        ),
                        // Reactions
                        if (message.reactions.isNotEmpty) ...[
                          SizedBox(height: 8),
                          Wrap(
                            spacing: 8,
                            children: message.reactions.entries.map((entry) {
                              return Container(
                                padding: EdgeInsets.symmetric(
                                  horizontal: 6,
                                  vertical: 2,
                                ),
                                decoration: BoxDecoration(
                                  color: userReactions.contains(entry.key)
                                      ? AppColors.primaryLavender.withOpacity(
                                          0.2,
                                        )
                                      : AppColors.backgroundDeep.withOpacity(
                                          0.5,
                                        ),
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                child: Row(
                                  mainAxisSize: MainAxisSize.min,
                                  children: [
                                    Text(entry.key),
                                    SizedBox(width: 4),
                                    Text(
                                      entry.value.length.toString(),
                                      style: TextStyle(
                                        fontSize: 12,
                                        color: AppColors.textHigh,
                                      ),
                                    ),
                                  ],
                                ),
                              );
                            }).toList(),
                          ),
                        ],
                      ],
                    ),
                  ),
                ),
                SizedBox(height: 4),
                Text(
                  DateFormat('HH:mm').format(message.timestamp.toDate()),
                  style: TextStyle(fontSize: 10, color: AppColors.textDisabled),
                ),
              ],
            ),
          ),
          if (isCurrentUser) ...[
            SizedBox(width: 8),
            CircleAvatar(
              radius: 16,
              backgroundImage: message.userProfileImage != null
                  ? CachedNetworkImageProvider(message.userProfileImage!)
                  : null,
              child: message.userProfileImage == null
                  ? Icon(Feather.user, size: 16)
                  : null,
              backgroundColor: AppColors.elevation,
            ),
          ],
        ],
      ),
    );
  }

  void _showMessageOptions(DiscussionMessage message, bool isCurrentUser) {
    showModalBottomSheet(
      context: context,
      backgroundColor: AppColors.surface,
      builder: (context) {
        return Container(
          padding: EdgeInsets.all(16),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              if (isCurrentUser)
                ListTile(
                  leading: Icon(
                    Feather.corner_up_left,
                    color: AppColors.primaryLavender,
                  ),
                  title: Text(
                    'Reply',
                    style: TextStyle(color: AppColors.textHigh),
                  ),
                  onTap: () {
                    Navigator.pop(context);
                    _startReply(message);
                  },
                ),
              if (isCurrentUser)
                ListTile(
                  leading: Icon(Feather.trash_2, color: AppColors.error),
                  title: Text(
                    'Delete Message',
                    style: TextStyle(color: AppColors.textHigh),
                  ),
                  onTap: () {
                    Navigator.pop(context);
                    _deleteMessage(message.id);
                  },
                ),
              if (_isModerator() && !isCurrentUser)
                ListTile(
                  leading: Icon(Feather.shield, color: AppColors.accentMustard),
                  title: Text(
                    'Moderator Actions',
                    style: TextStyle(color: AppColors.textHigh),
                  ),
                  onTap: () {
                    Navigator.pop(context);
                    _showAdminActions(message);
                  },
                ),
              ListTile(
                leading: Icon(Feather.x_circle, color: AppColors.textMedium),
                title: Text(
                  'Cancel',
                  style: TextStyle(color: AppColors.textMedium),
                ),
                onTap: () => Navigator.pop(context),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildReactionMenu() {
    if (_selectedMessageForReaction == null) return SizedBox.shrink();

    return Positioned(
      bottom: 80,
      left: 0,
      right: 0,
      child: Container(
        margin: EdgeInsets.symmetric(horizontal: 20),
        padding: EdgeInsets.all(12),
        decoration: BoxDecoration(
          color: AppColors.surface,
          borderRadius: BorderRadius.circular(25),
          boxShadow: [
            BoxShadow(
              color: Colors.black26,
              blurRadius: 10,
              offset: Offset(0, 2),
            ),
          ],
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceEvenly,
          children: _availableReactions.map((emoji) {
            return GestureDetector(
              onTap: () {
                _toggleReaction(_selectedMessageForReaction!.id, emoji);
              },
              child: Container(
                padding: EdgeInsets.all(8),
                child: Text(emoji, style: TextStyle(fontSize: 24)),
              ),
            );
          }).toList(),
        ),
      ),
    );
  }

  Widget _buildReplyPreview() {
    if (_replyingTo == null) return SizedBox.shrink();

    return Container(
      padding: EdgeInsets.all(12),
      color: AppColors.elevation,
      child: Row(
        children: [
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  'Replying to ${_replyingTo!.username}',
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    fontSize: 12,
                    color: AppColors.primaryLavender,
                  ),
                ),
                SizedBox(height: 2),
                Text(
                  _replyingTo!.text.length > 50
                      ? '${_replyingTo!.text.substring(0, 50)}...'
                      : _replyingTo!.text,
                  style: TextStyle(fontSize: 12, color: AppColors.textMedium),
                ),
              ],
            ),
          ),
          IconButton(
            icon: Icon(Feather.x, size: 18, color: AppColors.textMedium),
            onPressed: _cancelReply,
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    if (!widget.isSigned && !widget.isCreator) {
      return Scaffold(
        backgroundColor: Colors.transparent,
        appBar: AppBar(
          title: Text(
            'Discussion',
            style: TextStyle(color: AppColors.textHigh),
          ),
          backgroundColor: Colors.transparent,
          elevation: 0,
          iconTheme: IconThemeData(color: AppColors.primaryLavender),
        ),
        body: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(Feather.lock, size: 64, color: AppColors.textDisabled),
              SizedBox(height: 16),
              Text(
                'Discussion Locked',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: AppColors.textHigh,
                ),
              ),
              SizedBox(height: 8),
              Text(
                'You need to sign the petition to participate in the discussion',
                textAlign: TextAlign.center,
                style: TextStyle(color: AppColors.textMedium),
              ),
              SizedBox(height: 20),
              ElevatedButton(
                onPressed: () => Navigator.pop(context),
                child: Text('Back to Petition'),
                style: ElevatedButton.styleFrom(
                  backgroundColor: AppColors.primaryLavender,
                  foregroundColor: AppColors.backgroundDeep,
                ),
              ),
            ],
          ),
        ),
      );
    }

    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: Text('Discussion', style: TextStyle(color: AppColors.textHigh)),
        backgroundColor: Colors.transparent,
        elevation: 0,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
        actions: [
          if (_isModerator())
            IconButton(
              icon: Icon(Feather.shield, color: AppColors.primaryLavender),
              onPressed: () {
                // Show moderator tools
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text(
                      'Moderator tools - long press messages to manage',
                    ),
                  ),
                );
              },
            ),
        ],
      ),
      body: Column(
        children: [
          _buildReplyPreview(),
          Expanded(
            child: _isLoading
                ? Center(
                    child: CircularProgressIndicator(
                      color: AppColors.primaryLavender,
                    ),
                  )
                : _messages.isEmpty
                ? Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          Feather.message_square,
                          size: 64,
                          color: AppColors.textDisabled,
                        ),
                        SizedBox(height: 16),
                        Text(
                          'No messages yet',
                          style: TextStyle(
                            fontSize: 18,
                            color: AppColors.textMedium,
                          ),
                        ),
                        SizedBox(height: 8),
                        Text(
                          'Start the conversation!',
                          style: TextStyle(color: AppColors.textMedium),
                        ),
                      ],
                    ),
                  )
                : Stack(
                    children: [
                      ListView.builder(
                        controller: _scrollController,
                        padding: EdgeInsets.only(bottom: 80),
                        itemCount: _messages.length,
                        itemBuilder: (context, index) {
                          return _buildMessageBubble(_messages[index]);
                        },
                      ),
                      _buildReactionMenu(),
                    ],
                  ),
          ),
          Container(
            padding: EdgeInsets.all(8),
            color: AppColors.surface,
            child: Row(
              children: [
                Expanded(
                  child: Container(
                    decoration: BoxDecoration(
                      color: AppColors.elevation,
                      borderRadius: BorderRadius.circular(25),
                    ),
                    child: TextField(
                      controller: _messageController,
                      style: TextStyle(color: AppColors.textHigh),
                      decoration: InputDecoration(
                        hintText: 'Type a message...',
                        hintStyle: TextStyle(color: AppColors.textDisabled),
                        border: InputBorder.none,
                        contentPadding: EdgeInsets.symmetric(
                          horizontal: 16,
                          vertical: 12,
                        ),
                      ),
                      maxLines: null,
                      textInputAction: TextInputAction.send,
                      onSubmitted: (_) => _sendMessage(),
                    ),
                  ),
                ),
                SizedBox(width: 8),
                CircleAvatar(
                  backgroundColor:
                      _messageController.text.trim().isEmpty || _isSending
                      ? AppColors.textDisabled
                      : AppColors.primaryLavender,
                  child: IconButton(
                    icon: _isSending
                        ? SizedBox(
                            height: 20,
                            width: 20,
                            child: CircularProgressIndicator(
                              strokeWidth: 2,
                              color: AppColors.backgroundDeep,
                            ),
                          )
                        : Icon(Feather.send, color: AppColors.backgroundDeep),
                    onPressed: _sendMessage,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _messageController.dispose();
    _scrollController.dispose();
    super.dispose();
  }
}

// Enhanced Petition Detail Screen
class EnhancedPetitionDetailScreen extends StatefulWidget {
  final String petitionId;
  const EnhancedPetitionDetailScreen({Key? key, required this.petitionId})
    : super(key: key);

  @override
  _EnhancedPetitionDetailScreenState createState() =>
      _EnhancedPetitionDetailScreenState();
}

class _EnhancedPetitionDetailScreenState
    extends State<EnhancedPetitionDetailScreen> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final PersonalizedFeedService _feedService = PersonalizedFeedService();

  late String _currentUserId;
  Petition? _petition;
  bool _isLoading = true;
  int _currentTab = 0;
  final TextEditingController _signatureCommentController =
      TextEditingController();
  bool _showSignatureDialog = false;
  bool _isSigning = false;
  bool _signatureIsPublic = true;

  @override
  void initState() {
    super.initState();
    _currentUserId = _auth.currentUser!.uid;
    _loadPetition();
    _incrementViews();
  }

  Future<void> _loadPetition() async {
    try {
      final doc = await _firestore
          .collection('petitions')
          .doc(widget.petitionId)
          .get();
      if (doc.exists) {
        setState(() {
          _petition = Petition.fromDocument(doc);
          _isLoading = false;
        });
      }
    } catch (e) {
      print("Error loading petition: $e");
      setState(() {
        _isLoading = false;
      });
    }
  }

  Future<void> _incrementViews() async {
    // 1. Update Global Counter
    await _firestore.collection('petitions').doc(widget.petitionId).update({
      'views': FieldValue.increment(1),
    });

    // 2. Record Signal for Personalization & Funnel
    if (_currentUserId.isNotEmpty) {
      _feedService.recordInteraction(
        type: 'view',
        postId: widget.petitionId,
        authorId:
            _petition?.createdBy, // Might be null initially, but that's ok
        collection: 'petitions',
        source:
            'profile', // Assuming mostly accessed from profile for now, or pass via widget
      );
    }
  }

  Future<void> _signPetitionWithComment(String comment, bool isPublic) async {
    if (_isSigning || _petition == null) return;
    setState(() {
      _isSigning = true;
    });

    try {
      final userDoc = await _firestore
          .collection('users')
          .doc(_currentUserId)
          .get();
      final userData = userDoc.data() as Map<String, dynamic>;
      final signature = PetitionSignature(
        userId: _currentUserId,
        username: userData['username'] ?? 'User',
        profileImage: userData['profileImage'],
        comment: comment.isNotEmpty ? comment : null,
        signedAt: Timestamp.now(),
        isPublic: isPublic,
      );

      bool justReachedGoal = false;
      List<String> allSigners = [];

      await _firestore.runTransaction((transaction) async {
        final petitionDoc = await transaction.get(
          _firestore.collection('petitions').doc(widget.petitionId),
        );
        if (!petitionDoc.exists) throw Exception('Petition not found');

        allSigners = List<String>.from(petitionDoc['signers'] ?? []);
        if (allSigners.contains(_currentUserId)) {
          throw Exception('You have already signed this petition');
        }

        final int currentCount = petitionDoc['currentSignatures'] ?? 0;
        final int goal = petitionDoc['goal'] ?? 0;
        if (currentCount + 1 >= goal && currentCount < goal) {
          justReachedGoal = true;
        }

        allSigners.add(_currentUserId);

        transaction.update(
          _firestore.collection('petitions').doc(widget.petitionId),
          {
            'currentSignatures': FieldValue.increment(1),
            'signers': FieldValue.arrayUnion([_currentUserId]),
            'signaturesWithComments': FieldValue.arrayUnion([
              signature.toMap(),
            ]),
          },
        );
      });

      if (justReachedGoal && _petition != null) {
        NotificationService().sendPetitionGoalReachedNotification(
          petitionId: widget.petitionId,
          petitionTitle: _petition!.title,
          signerIds: allSigners,
          bannerImageUrl: _petition!.bannerImageUrl,
        );
      }

      await _loadPetition();
      setState(() {
        _showSignatureDialog = false;
        _signatureCommentController.clear();
      });

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Thank you for signing the petition!')),
      );
    } catch (e) {
      print("Error signing petition: $e");
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Failed to sign petition: $e')));
    } finally {
      setState(() {
        _isSigning = false;
      });
    }
  }

  void _showShareOptions() {
    if (_petition == null) return;
    showModalBottomSheet(
      context: context,
      backgroundColor: AppColors.surface,
      builder: (context) {
        return Container(
          padding: EdgeInsets.all(16),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(
                'Share Petition',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: AppColors.textHigh,
                ),
              ),
              SizedBox(height: 16),
              ListTile(
                leading: Icon(Feather.link, color: AppColors.primaryLavender),
                title: Text(
                  'Copy Link',
                  style: TextStyle(color: AppColors.textHigh),
                ),
                onTap: () {
                  _copyPetitionLink();
                  Navigator.pop(context);
                },
              ),
              ListTile(
                leading: Icon(
                  Feather.share_2,
                  color: AppColors.primaryLavender,
                ),
                title: Text(
                  'Share via...',
                  style: TextStyle(color: AppColors.textHigh),
                ),
                onTap: () {
                  _sharePetition();
                  Navigator.pop(context);
                },
              ),
              ListTile(
                leading: Icon(FontAwesome.whatsapp, color: Colors.green),
                title: Text(
                  'Share on WhatsApp',
                  style: TextStyle(color: AppColors.textHigh),
                ),
                onTap: () {
                  _shareOnWhatsApp();
                  Navigator.pop(context);
                },
              ),
              ListTile(
                leading: Icon(Feather.camera, color: AppColors.primaryLavender),
                title: Text(
                  'Generate Shareable Image',
                  style: TextStyle(color: AppColors.textHigh),
                ),
                onTap: () {
                  _generateShareableImage();
                  Navigator.pop(context);
                },
              ),
            ],
          ),
        );
      },
    );
  }

  void _copyPetitionLink() {
    // final link = 'https://yourapp.com/petitions/${_petition!.id}';
    ScaffoldMessenger.of(
      context,
    ).showSnackBar(SnackBar(content: Text('Link copied to clipboard')));
  }

  void _sharePetition() {
    if (_petition == null) return;
    final shareText =
        '''
 Check out this petition: "${_petition!.title}"
${_petition!.description}
${_petition!.currentSignatures} people have already signed! Help reach ${_petition!.goal} signatures.
#${_petition!.hashtags.isNotEmpty ? _petition!.hashtags.first : 'Petition'}
''';
    Share.share(shareText);

    // Increment Share
    _feedService.recordInteraction(
      type: 'share',
      postId: widget.petitionId,
      authorId: _petition?.createdBy,
      collection: 'petitions',
    );
  }

  Future<void> _shareOnWhatsApp() async {
    if (_petition == null) return;
    final shareText =
        'Check out this petition: "${_petition!.title}" - ${_petition!.description}';
    final url = 'https://wa.me/?text=${Uri.encodeComponent(shareText)}';
    final uri = Uri.parse(url);
    if (await canLaunchUrl(uri)) {
      await launchUrl(uri);
    } else {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Could not open WhatsApp')));
    }
  }

  void _generateShareableImage() {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('Shareable image feature coming soon!')),
    );
  }

  Widget _buildStoryTab() {
    if (_petition == null) return Container();
    return SingleChildScrollView(
      padding: EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          if (_petition!.bannerImageUrl != null &&
              _petition!.bannerImageUrl!.isNotEmpty)
            ClipRRect(
              borderRadius: BorderRadius.circular(12),
              child: CachedNetworkImage(
                imageUrl: _petition!.bannerImageUrl!,
                width: double.infinity,
                height: 200,
                fit: BoxFit.cover,
                placeholder: (context, url) => Container(
                  height: 200,
                  color: AppColors.elevation,
                  child: Center(
                    child: CircularProgressIndicator(
                      color: AppColors.primaryLavender,
                    ),
                  ),
                ),
                errorWidget: (context, url, error) => Container(
                  height: 200,
                  color: AppColors.elevation,
                  child: Icon(Feather.alert_circle, color: AppColors.error),
                ),
              ),
            ),
          SizedBox(height: 16),
          // Creator Info
          FutureBuilder<DocumentSnapshot>(
            future: _firestore
                .collection('users')
                .doc(_petition!.createdBy)
                .get(),
            builder: (context, snapshot) {
              if (snapshot.hasData) {
                final creator = snapshot.data!;
                final creatorData = creator.data() as Map<String, dynamic>;
                return ListTile(
                  leading: CircleAvatar(
                    backgroundImage: creatorData['profileImage'] != null
                        ? CachedNetworkImageProvider(
                            creatorData['profileImage'],
                          )
                        : null,
                    backgroundColor: AppColors.elevation,
                    child: creatorData['profileImage'] == null
                        ? Icon(Feather.user)
                        : null,
                  ),
                  title: Text(
                    creatorData['username'] ?? 'User',
                    style: TextStyle(color: AppColors.textHigh),
                  ),
                  subtitle: Text(
                    'Petition Creator',
                    style: TextStyle(color: AppColors.primaryLavender),
                  ),
                  onTap: () {
                    // Navigate to creator profile
                  },
                );
              }
              return ListTile(
                leading: CircleAvatar(
                  child: Icon(Feather.user),
                  backgroundColor: AppColors.elevation,
                ),
                title: Text(
                  'Loading...',
                  style: TextStyle(color: AppColors.textHigh),
                ),
                subtitle: Text(
                  'Petition Creator',
                  style: TextStyle(color: AppColors.textMedium),
                ),
              );
            },
          ),
          SizedBox(height: 16),
          Text(
            _petition!.title,
            style: TextStyle(
              fontSize: 24,
              fontWeight: FontWeight.bold,
              color: AppColors.textHigh,
            ),
          ),
          SizedBox(height: 8),
          Text(
            _petition!.description,
            style: TextStyle(fontSize: 16, color: AppColors.textMedium),
          ),
          SizedBox(height: 16),
          Text(
            'Full Story',
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.bold,
              color: AppColors.textHigh,
            ),
          ),
          SizedBox(height: 8),
          Text(
            _petition!.fullStory,
            style: TextStyle(
              fontSize: 16,
              height: 1.5,
              color: AppColors.textHigh,
            ),
          ),
          if (_petition!.externalLinks.isNotEmpty) ...[
            SizedBox(height: 24),
            Text(
              'Support & More Info',
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: AppColors.textHigh,
              ),
            ),
            SizedBox(height: 8),
            ..._petition!.externalLinks.map((link) {
              IconData icon = Feather.link;
              if (link.contains('gofundme.com')) icon = Feather.heart;
              if (link.contains('tiktok.com'))
                icon = FontAwesome.music; // Closest for TikTok
              if (link.contains('instagram.com')) icon = FontAwesome.instagram;

              return Padding(
                padding: const EdgeInsets.only(bottom: 8.0),
                child: Container(
                  decoration: BoxDecoration(
                    color: AppColors.elevation,
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: ListTile(
                    leading: Icon(icon, color: AppColors.primaryLavender),
                    title: Text(
                      link,
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                      style: TextStyle(
                        color: AppColors.primaryLavender,
                        decoration: TextDecoration.underline,
                        fontSize: 14,
                      ),
                    ),
                    onTap: () async {
                      final uri = Uri.parse(link);
                      if (await canLaunchUrl(uri)) {
                        await launchUrl(uri);
                      }
                    },
                  ),
                ),
              );
            }).toList(),
          ],
          SizedBox(height: 32),
          Text(
            'Updates & Announcements',
            style: GoogleFonts.outfit(
              fontSize: 20,
              fontWeight: FontWeight.bold,
              color: AppColors.textHigh,
            ),
          ),
          SizedBox(height: 16),
          StreamBuilder<QuerySnapshot>(
            stream: _firestore
                .collection('petitions')
                .doc(_petition!.id)
                .collection('announcements')
                .orderBy('timestamp', descending: true)
                .snapshots(),
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.waiting) {
                return Center(
                  child: CircularProgressIndicator(
                    color: AppColors.primaryLavender,
                  ),
                );
              }
              if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
                return Container(
                  padding: EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    color: AppColors.elevation,
                    borderRadius: BorderRadius.circular(15),
                    border: Border.all(color: AppColors.surface, width: 1),
                  ),
                  child: Center(
                    child: Text(
                      'No official updates yet.',
                      style: TextStyle(
                        color: AppColors.textDisabled,
                        fontStyle: FontStyle.italic,
                      ),
                    ),
                  ),
                );
              }
              return Column(
                children: snapshot.data!.docs
                    .map((doc) => _buildAnnouncementCard(doc))
                    .toList(),
              );
            },
          ),
          SizedBox(height: 40),
        ],
      ),
    );
  }

  Widget _buildAnnouncementCard(DocumentSnapshot doc) {
    final data = doc.data() as Map<String, dynamic>;
    final timestamp = data['timestamp'] as Timestamp?;
    final dateStr = timestamp != null
        ? DateFormat('MMM d, yyyy  HH:mm').format(timestamp.toDate())
        : 'Recently';

    return Container(
      margin: EdgeInsets.only(bottom: 16),
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.surface,
        borderRadius: BorderRadius.circular(20),
        border: Border.all(
          color: AppColors.primaryLavender.withOpacity(0.2),
          width: 1,
        ),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 10,
            offset: Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                padding: EdgeInsets.all(6),
                decoration: BoxDecoration(
                  color: AppColors.primaryLavender.withOpacity(0.1),
                  shape: BoxShape.circle,
                ),
                child: Icon(
                  Feather.volume_2,
                  color: AppColors.primaryLavender,
                  size: 16,
                ),
              ),
              SizedBox(width: 8),
              Text(
                'OFFICIAL UPDATE',
                style: GoogleFonts.outfit(
                  fontSize: 10,
                  fontWeight: FontWeight.bold,
                  color: AppColors.primaryLavender,
                  letterSpacing: 1.2,
                ),
              ),
              Spacer(),
              Text(
                dateStr,
                style: TextStyle(fontSize: 10, color: AppColors.textDisabled),
              ),
            ],
          ),
          SizedBox(height: 12),
          Text(
            data['title'] ?? 'Update',
            style: GoogleFonts.outfit(
              fontSize: 18,
              fontWeight: FontWeight.bold,
              color: AppColors.textHigh,
            ),
          ),
          SizedBox(height: 8),
          Text(
            data['body'] ?? '',
            style: TextStyle(
              fontSize: 14,
              height: 1.5,
              color: AppColors.textMedium,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSignaturesTab() {
    if (_petition == null) return Container();
    final publicSignatures = _petition!.signaturesWithComments
        .where((sig) => sig.isPublic && sig.comment != null)
        .toList();
    if (publicSignatures.isEmpty) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Feather.message_circle,
              size: 64,
              color: AppColors.textDisabled,
            ),
            SizedBox(height: 16),
            Text(
              'No comments yet',
              style: TextStyle(fontSize: 18, color: AppColors.textMedium),
            ),
            SizedBox(height: 8),
            Text(
              'Be the first to leave a comment when signing!',
              style: TextStyle(color: AppColors.textDisabled),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      );
    }
    return ListView.builder(
      padding: EdgeInsets.all(16),
      itemCount: publicSignatures.length,
      itemBuilder: (context, index) {
        final signature = publicSignatures[index];
        return Card(
          color: AppColors.surface,
          margin: EdgeInsets.only(bottom: 12),
          child: Padding(
            padding: EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    CircleAvatar(
                      radius: 20,
                      backgroundColor: AppColors.elevation,
                      backgroundImage: signature.profileImage != null
                          ? CachedNetworkImageProvider(signature.profileImage!)
                          : null,
                      child: signature.profileImage == null
                          ? Icon(Feather.user, color: AppColors.textMedium)
                          : null,
                    ),
                    SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            signature.username,
                            style: TextStyle(
                              fontWeight: FontWeight.bold,
                              color: AppColors.textHigh,
                            ),
                          ),
                          Text(
                            'Signed ${DateFormat('MMM d, yyyy').format(signature.signedAt.toDate())}',
                            style: TextStyle(
                              fontSize: 12,
                              color: AppColors.textDisabled,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
                SizedBox(height: 12),
                if (signature.comment != null)
                  Text(
                    signature.comment!,
                    style: TextStyle(
                      fontSize: 14,
                      height: 1.4,
                      color: AppColors.textHigh,
                    ),
                  ),
              ],
            ),
          ),
        );
      },
    );
  }

  Widget _buildDiscussionTab() {
    if (_petition == null) return Container();
    return PetitionDiscussionScreen(
      petitionId: widget.petitionId,
      isSigned: _petition!.signers.contains(_currentUserId),
      isCreator: _petition!.createdBy == _currentUserId,
    );
  }

  Widget _buildTabButton(String text, int tabIndex) {
    final isSelected = _currentTab == tabIndex;
    return Expanded(
      child: TextButton(
        onPressed: () {
          setState(() {
            _currentTab = tabIndex;
          });
        },
        style: TextButton.styleFrom(
          backgroundColor: isSelected
              ? AppColors.primaryLavender.withOpacity(0.1)
              : Colors.transparent,
          shape: RoundedRectangleBorder(),
          padding: EdgeInsets.symmetric(vertical: 16),
        ),
        child: Text(
          text,
          style: TextStyle(
            color: isSelected
                ? AppColors.primaryLavender
                : AppColors.textMedium,
            fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
          ),
        ),
      ),
    );
  }

  void _openSignatureDialog() {
    showDialog(
      context: context,
      builder: (context) {
        return StatefulBuilder(
          builder: (context, setState) => AlertDialog(
            backgroundColor: AppColors.surface,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(20),
            ),
            title: Text(
              'Sign Petition',
              style: TextStyle(
                color: AppColors.textHigh,
                fontWeight: FontWeight.bold,
              ),
            ),
            content: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    'Show your support for this movement by adding your signature.',
                    style: TextStyle(color: AppColors.textMedium),
                  ),
                  SizedBox(height: 20),
                  Row(
                    children: [
                      Checkbox(
                        value: _signatureIsPublic,
                        activeColor: AppColors.primaryLavender,
                        onChanged: (value) {
                          setState(() {
                            _signatureIsPublic = value ?? true;
                          });
                        },
                      ),
                      Expanded(
                        child: Text(
                          'Make my signature public',
                          style: TextStyle(
                            fontSize: 14,
                            color: AppColors.textMedium,
                          ),
                        ),
                      ),
                    ],
                  ),
                  SizedBox(height: 20),
                  Container(
                    width: double.infinity,
                    child: TextButton.icon(
                      onPressed: () {
                        Navigator.pop(context);
                        this.setState(() {
                          _currentTab = 1; // Switch to Discussion tab
                        });
                      },
                      style: TextButton.styleFrom(
                        backgroundColor: AppColors.primaryLavender.withOpacity(
                          0.1,
                        ),
                        padding: EdgeInsets.symmetric(vertical: 12),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      icon: Icon(
                        Feather.message_square,
                        color: AppColors.primaryLavender,
                        size: 20,
                      ),
                      label: Text(
                        'Join the Discussion instead',
                        style: TextStyle(color: AppColors.primaryLavender),
                      ),
                    ),
                  ),
                ],
              ),
            ),
            actions: [
              TextButton(
                onPressed: () => Navigator.pop(context),
                child: Text(
                  'Cancel',
                  style: TextStyle(color: AppColors.textMedium),
                ),
              ),
              ElevatedButton(
                onPressed: _isSigning
                    ? null
                    : () {
                        _signPetitionWithComment('', _signatureIsPublic);
                        Navigator.pop(context);
                      },
                child: _isSigning
                    ? SizedBox(
                        height: 20,
                        width: 20,
                        child: CircularProgressIndicator(
                          strokeWidth: 2,
                          color: AppColors.backgroundDeep,
                        ),
                      )
                    : Text(
                        'Sign Petition',
                        style: TextStyle(color: AppColors.backgroundDeep),
                      ),
                style: ElevatedButton.styleFrom(
                  backgroundColor: AppColors.primaryLavender,
                  padding: EdgeInsets.symmetric(horizontal: 24, vertical: 12),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    if (_isLoading) {
      return Scaffold(
        backgroundColor: Colors.transparent,
        appBar: AppBar(backgroundColor: Colors.transparent, elevation: 0),
        body: Center(
          child: CircularProgressIndicator(color: AppColors.primaryLavender),
        ),
      );
    }
    if (_petition == null) {
      return Scaffold(
        backgroundColor: Colors.transparent,
        appBar: AppBar(backgroundColor: Colors.transparent, elevation: 0),
        body: Center(
          child: Text(
            'Petition not found',
            style: TextStyle(color: AppColors.textHigh),
          ),
        ),
      );
    }

    final isSigned = _petition!.signers.contains(_currentUserId);
    final isCreator = _petition!.createdBy == _currentUserId;
    final isExpired = _petition!.isExpired;

    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: Text(
          'Petition Details',
          style: TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: Colors.transparent,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
        elevation: 0,
        actions: [
          IconButton(
            icon: Icon(Feather.share_2, color: AppColors.primaryLavender),
            onPressed: _showShareOptions,
          ),
          if (isCreator ||
              _petition!.collaborators.contains(_auth.currentUser?.displayName))
            IconButton(
              icon: Icon(Feather.edit_2, color: AppColors.primaryLavender),
              onPressed: () {
                Navigator.push(
                  context,
                  MaterialPageRoute(
                    builder: (context) => EnhancedPetitionCreationScreen(
                      existingPetition: _petition,
                    ),
                  ),
                ).then((_) => _loadPetition());
              },
            ),
          if (isCreator) ...[
            IconButton(
              icon: Icon(Feather.grid, color: AppColors.primaryLavender),
              onPressed: () {
                Navigator.push(
                  context,
                  MaterialPageRoute(
                    builder: (context) =>
                        PetitionManagementDashboard(petition: _petition!),
                  ),
                );
              },
            ),
            IconButton(
              icon: Icon(Feather.bar_chart_2, color: AppColors.primaryLavender),
              onPressed: () {
                Navigator.push(
                  context,
                  MaterialPageRoute(
                    builder: (context) =>
                        PetitionAnalyticsScreen(petitionId: widget.petitionId),
                  ),
                );
              },
            ),
          ],
        ],
      ),
      body: Column(
        children: [
          // Progress Header
          Container(
            padding: EdgeInsets.all(16),
            color: AppColors.surface,
            child: Column(
              children: [
                LinearProgressIndicator(
                  value: _petition!.progress,
                  backgroundColor: AppColors.elevation,
                  color: AppColors.primaryLavender,
                  minHeight: 8,
                ),
                SizedBox(height: 8),
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text(
                      '${_petition!.currentSignatures} signatures',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                        color: AppColors.textHigh,
                      ),
                    ),
                    Text(
                      'Goal: ${_petition!.goal}',
                      style: TextStyle(
                        fontSize: 16,
                        color: AppColors.textMedium,
                      ),
                    ),
                  ],
                ),
                if (_petition!.hasDeadline)
                  Padding(
                    padding: EdgeInsets.only(top: 8),
                    child: Text(
                      _petition!.isExpired
                          ? 'This petition has ended'
                          : '${_petition!.daysLeft} days left',
                      style: TextStyle(
                        color: _petition!.isExpired
                            ? AppColors.error
                            : AppColors.secondaryTeal,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
              ],
            ),
          ),
          // Tabs
          Container(
            color: AppColors.backgroundDeep,
            child: Row(
              children: [
                _buildTabButton('Story', 0),
                _buildTabButton('Discussion', 1),
              ],
            ),
          ),
          // Tab Content
          Expanded(
            child: _currentTab == 0 ? _buildStoryTab() : _buildDiscussionTab(),
          ),
        ],
      ),
      // Sign Button
      bottomNavigationBar: !isSigned && !isExpired
          ? Container(
              padding: EdgeInsets.all(16),
              color: AppColors.backgroundDeep,
              child: ElevatedButton(
                onPressed: _openSignatureDialog,
                child: Text(
                  'Sign This Petition',
                  style: TextStyle(color: AppColors.backgroundDeep),
                ),
                style: ElevatedButton.styleFrom(
                  minimumSize: Size(double.infinity, 50),
                  backgroundColor: AppColors.primaryLavender,
                  foregroundColor: AppColors.backgroundDeep,
                ),
              ),
            )
          : isSigned
          ? Container(
              padding: EdgeInsets.all(16),
              color: AppColors.backgroundDeep,
              child: Text(
                ' You have signed this petition',
                textAlign: TextAlign.center,
                style: TextStyle(
                  color: AppColors.success,
                  fontWeight: FontWeight.bold,
                  fontSize: 16,
                ),
              ),
            )
          : null,
    );
  }
}

// Petition Analytics Screen
class PetitionAnalyticsScreen extends StatefulWidget {
  final String petitionId;
  const PetitionAnalyticsScreen({Key? key, required this.petitionId})
    : super(key: key);

  @override
  _PetitionAnalyticsScreenState createState() =>
      _PetitionAnalyticsScreenState();
}

class _PetitionAnalyticsScreenState extends State<PetitionAnalyticsScreen> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  Petition? _petition;
  List<SignatureDay> _signatureHistory = [];

  @override
  void initState() {
    super.initState();
    _loadPetition();
    _loadSignatureHistory();
  }

  Future<void> _loadPetition() async {
    final doc = await _firestore
        .collection('petitions')
        .doc(widget.petitionId)
        .get();
    if (doc.exists) {
      setState(() {
        _petition = Petition.fromDocument(doc);
      });
    }
  }

  Future<void> _loadSignatureHistory() async {
    // Simulate signature history data
    setState(() {
      _signatureHistory = [
        SignatureDay(day: DateTime.now().subtract(Duration(days: 6)), count: 5),
        SignatureDay(
          day: DateTime.now().subtract(Duration(days: 5)),
          count: 12,
        ),
        SignatureDay(day: DateTime.now().subtract(Duration(days: 4)), count: 8),
        SignatureDay(
          day: DateTime.now().subtract(Duration(days: 3)),
          count: 20,
        ),
        SignatureDay(
          day: DateTime.now().subtract(Duration(days: 2)),
          count: 15,
        ),
        SignatureDay(
          day: DateTime.now().subtract(Duration(days: 1)),
          count: 25,
        ),
        SignatureDay(
          day: DateTime.now(),
          count: _petition?.currentSignatures ?? 0,
        ),
      ];
    });
  }

  Widget _buildStatCard(String title, String value, IconData icon) {
    return Expanded(
      child: Card(
        color: AppColors.surface,
        child: Padding(
          padding: EdgeInsets.all(16),
          child: Column(
            children: [
              Icon(icon, size: 30, color: AppColors.primaryLavender),
              SizedBox(height: 8),
              Text(
                value,
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                  color: AppColors.textHigh,
                ),
              ),
              Text(title, style: TextStyle(color: AppColors.textMedium)),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildSignatureChart() {
    if (_signatureHistory.isEmpty) return Container();

    return Container(
      height: 250,
      padding: EdgeInsets.fromLTRB(10, 20, 20, 10),
      child: LineChart(
        LineChartData(
          gridData: FlGridData(
            show: true,
            drawVerticalLine: false,
            getDrawingHorizontalLine: (value) =>
                FlLine(color: AppColors.elevation, strokeWidth: 1),
          ),
          titlesData: FlTitlesData(
            show: true,
            rightTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
            topTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
            bottomTitles: AxisTitles(
              sideTitles: SideTitles(
                showTitles: true,
                reservedSize: 30,
                interval: 1,
                getTitlesWidget: (value, meta) {
                  int idx = value.toInt();
                  if (idx >= 0 && idx < _signatureHistory.length) {
                    return Padding(
                      padding: const EdgeInsets.only(top: 8.0),
                      child: Text(
                        DateFormat('E').format(_signatureHistory[idx].day),
                        style: TextStyle(
                          color: AppColors.textDisabled,
                          fontSize: 10,
                        ),
                      ),
                    );
                  }
                  return const SizedBox.shrink();
                },
              ),
            ),
            leftTitles: AxisTitles(
              sideTitles: SideTitles(
                showTitles: true,
                reservedSize: 42,
                getTitlesWidget: (value, meta) {
                  return Text(
                    value.toInt().toString(),
                    style: TextStyle(
                      color: AppColors.textDisabled,
                      fontSize: 10,
                    ),
                    textAlign: TextAlign.right,
                  );
                },
              ),
            ),
          ),
          borderData: FlBorderData(show: false),
          minX: 0,
          maxX: (_signatureHistory.length - 1).toDouble(),
          minY: 0,
          maxY:
              (_signatureHistory
                  .map((e) => e.count.toDouble())
                  .reduce((a, b) => a > b ? a : b) *
              1.2),
          lineBarsData: [
            LineChartBarData(
              spots: _signatureHistory
                  .asMap()
                  .entries
                  .map(
                    (e) => FlSpot(e.key.toDouble(), e.value.count.toDouble()),
                  )
                  .toList(),
              isCurved: true,
              gradient: LinearGradient(
                colors: [AppColors.primaryLavender, AppColors.secondaryTeal],
              ),
              barWidth: 4,
              isStrokeCapRound: true,
              dotData: FlDotData(show: true),
              belowBarData: BarAreaData(
                show: true,
                gradient: LinearGradient(
                  colors: [
                    AppColors.primaryLavender.withOpacity(0.3),
                    AppColors.primaryLavender.withOpacity(0),
                  ],
                  begin: Alignment.topCenter,
                  end: Alignment.bottomCenter,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildEngagementMetrics() {
    if (_petition == null) return Container();
    final conversionRate = _petition!.views > 0
        ? (_petition!.currentSignatures / _petition!.views * 100)
        : 0;
    final avgDaily = _petition!.createdAt
        .toDate()
        .difference(DateTime.now())
        .inDays
        .abs();
    final avgDailySignatures = avgDaily > 0
        ? (_petition!.currentSignatures / avgDaily)
        : _petition!.currentSignatures.toDouble();
    return Card(
      color: AppColors.surface,
      child: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          children: [
            _buildMetricRow(
              'Conversion Rate',
              '${conversionRate.toStringAsFixed(1)}%',
            ),
            Divider(color: AppColors.elevation),
            _buildMetricRow(
              'Avg. Daily Signatures',
              '${avgDailySignatures.toStringAsFixed(1)}',
            ),
            Divider(color: AppColors.elevation),
            _buildMetricRow('Total Views', _petition!.views.toString()),
            Divider(color: AppColors.elevation),
            _buildMetricRow('Shares', _petition!.shares.toString()),
            Divider(color: AppColors.elevation),
            _buildMetricRow('Days Running', avgDaily.toString()),
            Divider(color: AppColors.elevation),
            _buildMetricRow(
              'Days Remaining',
              _petition!.daysLeft > 0
                  ? _petition!.daysLeft.toString()
                  : 'Ended',
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildDemographicChart() {
    return Container(
      height: 220,
      child: PieChart(
        PieChartData(
          sectionsSpace: 4,
          centerSpaceRadius: 50,
          sections: [
            PieChartSectionData(
              value: 45,
              color: AppColors.primaryLavender,
              title: '13-17',
              radius: 60,
              titleStyle: GoogleFonts.outfit(
                color: Colors.white,
                fontSize: 12,
                fontWeight: FontWeight.bold,
              ),
              badgeWidget: Icon(Feather.book, color: Colors.white, size: 16),
              badgePositionPercentageOffset: 1.2,
            ),
            PieChartSectionData(
              value: 35,
              color: AppColors.secondaryTeal,
              title: '18-25',
              radius: 55,
              titleStyle: GoogleFonts.outfit(
                color: Colors.white,
                fontSize: 12,
                fontWeight: FontWeight.bold,
              ),
              badgeWidget: Icon(
                Feather.briefcase,
                color: Colors.white,
                size: 16,
              ),
              badgePositionPercentageOffset: 1.2,
            ),
            PieChartSectionData(
              value: 20,
              color: AppColors.accentMustard,
              title: '26+',
              radius: 50,
              titleStyle: GoogleFonts.outfit(
                color: Colors.white,
                fontSize: 12,
                fontWeight: FontWeight.bold,
              ),
              badgeWidget: Icon(Feather.home, color: Colors.white, size: 16),
              badgePositionPercentageOffset: 1.2,
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildTrafficSourceChart() {
    return Container(
      height: 200,
      padding: EdgeInsets.symmetric(vertical: 20),
      child: BarChart(
        BarChartData(
          alignment: BarChartAlignment.spaceAround,
          maxY: 100,
          barTouchData: BarTouchData(enabled: false),
          titlesData: FlTitlesData(
            show: true,
            bottomTitles: AxisTitles(
              sideTitles: SideTitles(
                showTitles: true,
                getTitlesWidget: (value, meta) {
                  const titles = ['Direct', 'Social', 'Search', 'Referral'];
                  if (value.toInt() < titles.length) {
                    return Padding(
                      padding: const EdgeInsets.only(top: 8.0),
                      child: Text(
                        titles[value.toInt()],
                        style: TextStyle(
                          color: AppColors.textDisabled,
                          fontSize: 10,
                        ),
                      ),
                    );
                  }
                  return const SizedBox.shrink();
                },
              ),
            ),
            leftTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
            topTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
            rightTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
          ),
          gridData: FlGridData(show: false),
          borderData: FlBorderData(show: false),
          barGroups: [
            BarChartGroupData(
              x: 0,
              barRods: [
                BarChartRodData(
                  toY: 40,
                  color: AppColors.primaryLavender,
                  width: 22,
                  borderRadius: BorderRadius.circular(6),
                ),
              ],
            ),
            BarChartGroupData(
              x: 1,
              barRods: [
                BarChartRodData(
                  toY: 75,
                  color: AppColors.secondaryTeal,
                  width: 22,
                  borderRadius: BorderRadius.circular(6),
                ),
              ],
            ),
            BarChartGroupData(
              x: 2,
              barRods: [
                BarChartRodData(
                  toY: 55,
                  color: AppColors.accentMustard,
                  width: 22,
                  borderRadius: BorderRadius.circular(6),
                ),
              ],
            ),
            BarChartGroupData(
              x: 3,
              barRods: [
                BarChartRodData(
                  toY: 30,
                  color: AppColors.error,
                  width: 22,
                  borderRadius: BorderRadius.circular(6),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildMetricRow(String label, String value) {
    return Padding(
      padding: EdgeInsets.symmetric(vertical: 8),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(
            label,
            style: TextStyle(
              fontWeight: FontWeight.w500,
              color: AppColors.textHigh,
            ),
          ),
          Text(
            value,
            style: TextStyle(
              fontWeight: FontWeight.bold,
              color: AppColors.primaryLavender,
            ),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    if (_petition == null) {
      return Scaffold(
        backgroundColor: Colors.transparent,
        appBar: AppBar(backgroundColor: AppColors.backgroundDeep),
        body: Center(
          child: CircularProgressIndicator(color: AppColors.primaryLavender),
        ),
      );
    }
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: Text(
          'Petition Analytics',
          style: TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: Colors.transparent,
        elevation: 0,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
      ),
      body: SingleChildScrollView(
        padding: EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'Quick Insights',
              style: GoogleFonts.outfit(
                fontSize: 22,
                fontWeight: FontWeight.bold,
                color: AppColors.textHigh,
              ),
            ),
            SizedBox(height: 16),
            // Overview Cards
            Row(
              children: [
                _buildStatCard(
                  'Signatures',
                  _petition!.currentSignatures.toString(),
                  Feather.users,
                ),
                SizedBox(width: 12),
                _buildStatCard(
                  'Views',
                  _petition!.views.toString(),
                  Feather.eye,
                ),
                SizedBox(width: 12),
                _buildStatCard(
                  'Shares',
                  _petition!.shares.toString(),
                  Feather.share_2,
                ),
              ],
            ),
            SizedBox(height: 32),

            Text(
              'Signature Velocity',
              style: GoogleFonts.outfit(
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: AppColors.textHigh,
              ),
            ),
            SizedBox(height: 16),
            Card(
              color: AppColors.surface,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(20),
              ),
              child: Padding(
                padding: const EdgeInsets.all(16.0),
                child: _buildSignatureChart(),
              ),
            ),
            SizedBox(height: 32),

            Row(
              children: [
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'Age Demographic',
                        style: GoogleFonts.outfit(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                          color: AppColors.textHigh,
                        ),
                      ),
                      SizedBox(height: 16),
                      _buildDemographicChart(),
                    ],
                  ),
                ),
              ],
            ),
            SizedBox(height: 32),

            Text(
              'Traffic Sources',
              style: GoogleFonts.outfit(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: AppColors.textHigh,
              ),
            ),
            SizedBox(height: 16),
            Card(
              color: AppColors.surface,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(20),
              ),
              child: _buildTrafficSourceChart(),
            ),
            SizedBox(height: 32),

            Text(
              'Detailed Engagement',
              style: GoogleFonts.outfit(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: AppColors.textHigh,
              ),
            ),
            SizedBox(height: 16),
            _buildEngagementMetrics(),
            SizedBox(height: 40),
          ],
        ),
      ),
    );
  }
}

class SignatureDay {
  final DateTime day;
  final int count;
  SignatureDay({required this.day, required this.count});
}

// Enhanced Petitions Screen (Main List)
class EnhancedPetitionsScreen extends StatefulWidget {
  @override
  _EnhancedPetitionsScreenState createState() =>
      _EnhancedPetitionsScreenState();
}

class _EnhancedPetitionsScreenState extends State<EnhancedPetitionsScreen> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  late String _currentUserId;

  @override
  void initState() {
    super.initState();
    _currentUserId = _auth.currentUser!.uid;
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: Text(
          'Enhanced Petitions',
          style: TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: Colors.transparent,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
        elevation: 0,
      ),
      body: StreamBuilder<QuerySnapshot>(
        stream: _firestore
            .collection('petitions')
            .orderBy('createdAt', descending: true)
            .snapshots(),
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting) {
            return const GridShimmerSkeleton();
          }
          if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
            return Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(
                    Feather.check_square,
                    size: 50,
                    color: AppColors.textDisabled,
                  ),
                  SizedBox(height: 16),
                  Text(
                    'No petitions yet',
                    textAlign: TextAlign.center,
                    style: TextStyle(fontSize: 16, color: AppColors.textMedium),
                  ),
                  SizedBox(height: 8),
                  Text(
                    'Be the first to create a petition!',
                    textAlign: TextAlign.center,
                    style: TextStyle(color: AppColors.textDisabled),
                  ),
                ],
              ),
            );
          }
          final petitions = snapshot.data!.docs
              .map((doc) => Petition.fromDocument(doc))
              .toList();
          return Padding(
            padding: const EdgeInsets.all(8.0),
            child: GridView.builder(
              gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                crossAxisCount: ResponsiveLayout.getColumnCount(context),
                crossAxisSpacing: 8,
                mainAxisSpacing: 8,
                childAspectRatio: 0.8,
              ),
              itemCount: petitions.length,
              itemBuilder: (context, index) {
                final petition = petitions[index];
                return _buildEnhancedPetitionCard(context, petition);
              },
            ),
          );
        },
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) => EnhancedPetitionCreationScreen(),
            ),
          );
        },
        backgroundColor: AppColors.accentMustard,
        child: Icon(Feather.plus, color: AppColors.backgroundDeep),
      ),
    );
  }

  Widget _buildEnhancedPetitionCard(BuildContext context, Petition petition) {
    final bool isSigned = petition.signers.contains(_currentUserId);
    return Card(
      color: AppColors.surface,
      margin: EdgeInsets.zero,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      elevation: 2,
      child: InkWell(
        onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) =>
                  EnhancedPetitionDetailScreen(petitionId: petition.id),
            ),
          );
        },
        borderRadius: BorderRadius.circular(12),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            // Banner Image
            ClipRRect(
              borderRadius: BorderRadius.vertical(top: Radius.circular(12)),
              child:
                  petition.bannerImageUrl != null &&
                      petition.bannerImageUrl!.isNotEmpty
                  ? CachedNetworkImage(
                      imageUrl: petition.bannerImageUrl!,
                      height: 100,
                      fit: BoxFit.cover,
                      placeholder: (context, url) =>
                          Container(color: AppColors.elevation),
                      errorWidget: (context, url, error) =>
                          Icon(Feather.alert_circle, color: AppColors.error),
                    )
                  : Container(
                      height: 100,
                      color: AppColors.elevation,
                      child: Icon(
                        Feather.check_square,
                        color: AppColors.textDisabled,
                      ),
                    ),
            ),
            // Content
            Padding(
              padding: const EdgeInsets.all(8.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Badge for signed status or deadline
                  Row(
                    children: [
                      if (isSigned)
                        Container(
                          padding: EdgeInsets.symmetric(
                            horizontal: 6,
                            vertical: 2,
                          ),
                          decoration: BoxDecoration(
                            color: AppColors.success,
                            borderRadius: BorderRadius.circular(4),
                          ),
                          child: Text(
                            'SIGNED',
                            style: TextStyle(
                              color: AppColors.backgroundDeep,
                              fontSize: 10,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                      if (petition.hasDeadline && !isSigned)
                        Container(
                          padding: EdgeInsets.symmetric(
                            horizontal: 6,
                            vertical: 2,
                          ),
                          decoration: BoxDecoration(
                            color: petition.isExpired
                                ? AppColors.error
                                : AppColors.secondaryTeal,
                            borderRadius: BorderRadius.circular(4),
                          ),
                          child: Text(
                            petition.isExpired
                                ? 'ENDED'
                                : '${petition.daysLeft}d',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: 10,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                    ],
                  ),
                  SizedBox(height: 6),
                  // Title
                  Text(
                    petition.title.length > 35
                        ? '${petition.title.substring(0, 35)}...'
                        : petition.title,
                    style: TextStyle(
                      fontWeight: FontWeight.bold,
                      fontSize: 14,
                      color: AppColors.textHigh,
                    ),
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                  ),
                  SizedBox(height: 4),
                  // Description
                  Text(
                    petition.description,
                    style: TextStyle(fontSize: 12, color: AppColors.textMedium),
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                  ),
                  SizedBox(height: 8),
                  // Progress Bar
                  LinearProgressIndicator(
                    value: petition.progress,
                    backgroundColor: AppColors.elevation,
                    color: AppColors.primaryLavender,
                  ),
                  SizedBox(height: 4),
                  // Signature Count
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Text(
                        '${petition.currentSignatures}/${petition.goal}',
                        style: TextStyle(
                          fontSize: 11,
                          color: AppColors.textMedium,
                        ),
                      ),
                      Text(
                        '${(petition.progress * 100).toInt()}%',
                        style: TextStyle(
                          fontSize: 11,
                          fontWeight: FontWeight.bold,
                          color: AppColors.primaryLavender,
                        ),
                      ),
                    ],
                  ),
                  SizedBox(height: 4),
                  // Category and Age Rating
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Text(
                        petition.category,
                        style: TextStyle(
                          fontSize: 10,
                          color: AppColors.textDisabled,
                        ),
                      ),
                      Text(
                        petition.ageRating,
                        style: TextStyle(
                          fontSize: 10,
                          color: AppColors.textDisabled,
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// Helper navigation functions
void showEnhancedPetitionDetails(
  BuildContext context,
  Petition petition,
  bool isSigned,
) {
  Navigator.push(
    context,
    MaterialPageRoute(
      builder: (context) =>
          EnhancedPetitionDetailScreen(petitionId: petition.id),
    ),
  );
}

void showCreateEnhancedPetitionModal(BuildContext context) {
  Navigator.push(
    context,
    MaterialPageRoute(builder: (context) => EnhancedPetitionCreationScreen()),
  );
}

// ========== PETITION MANAGEMENT DASHBOARD ==========

class UserPetitionsDashboard extends StatefulWidget {
  const UserPetitionsDashboard({Key? key}) : super(key: key);

  @override
  _UserPetitionsDashboardState createState() => _UserPetitionsDashboardState();
}

class _UserPetitionsDashboardState extends State<UserPetitionsDashboard> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  bool _isLoading = true;
  List<Petition> _myPetitions = [];

  @override
  void initState() {
    super.initState();
    _loadUserPetitions();
  }

  Future<void> _loadUserPetitions() async {
    final uid = _auth.currentUser?.uid;
    if (uid == null) return;

    try {
      final snapshot = await _firestore
          .collection('petitions')
          .where('createdBy', isEqualTo: uid)
          .get();

      final List<Petition> petitions = snapshot.docs
          .map((doc) => Petition.fromDocument(doc))
          .toList();

      // Also check if user is a collaborator (by username)
      final username = _auth.currentUser?.displayName;
      if (username != null) {
        final collabSnapshot = await _firestore
            .collection('petitions')
            .where('collaborators', arrayContains: username)
            .get();

        for (var doc in collabSnapshot.docs) {
          if (!petitions.any((p) => p.id == doc.id)) {
            petitions.add(Petition.fromDocument(doc));
          }
        }
      }

      setState(() {
        _myPetitions = petitions;
        _isLoading = false;
      });
    } catch (e) {
      print("Error loading user petitions: $e");
      setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    int totalSigs = _myPetitions.fold(
      0,
      (sum, item) => sum + item.currentSignatures,
    );
    int totalViews = _myPetitions.fold(0, (sum, item) => sum + item.views);

    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: Text(
          'Causes Management',
          style: GoogleFonts.outfit(
            fontWeight: FontWeight.bold,
            color: AppColors.textHigh,
          ),
        ),
        backgroundColor: Colors.transparent,
        elevation: 0,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
      ),
      body: _isLoading
          ? Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryLavender,
              ),
            )
          : _myPetitions.isEmpty
          ? _buildEmptyState()
          : RefreshIndicator(
              onRefresh: _loadUserPetitions,
              child: CustomScrollView(
                slivers: [
                  SliverPadding(
                    padding: EdgeInsets.all(20),
                    sliver: SliverToBoxAdapter(
                      child: _buildGlobalSummary(totalSigs, totalViews),
                    ),
                  ),
                  SliverToBoxAdapter(
                    child: Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 20.0),
                      child: Text(
                        'Your Petitions',
                        style: GoogleFonts.outfit(
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                          color: AppColors.textHigh,
                        ),
                      ),
                    ),
                  ),
                  SliverPadding(
                    padding: EdgeInsets.all(20),
                    sliver: SliverList(
                      delegate: SliverChildBuilderDelegate((context, index) {
                        final petition = _myPetitions[index];
                        return _buildManagementItem(petition);
                      }, childCount: _myPetitions.length),
                    ),
                  ),
                ],
              ),
            ),
    );
  }

  Widget _buildGlobalSummary(int signatures, int views) {
    return Container(
      padding: EdgeInsets.all(24),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [AppColors.primaryLavender, AppColors.secondaryTeal],
        ),
        borderRadius: BorderRadius.circular(24),
        boxShadow: [
          BoxShadow(
            color: AppColors.primaryLavender.withOpacity(0.3),
            blurRadius: 20,
            offset: Offset(0, 10),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Global Performance',
            style: GoogleFonts.outfit(
              color: AppColors.backgroundDeep.withOpacity(0.7),
              fontWeight: FontWeight.bold,
            ),
          ),
          SizedBox(height: 16),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              _buildGlobalStatItem('Total Signatures', signatures.toString()),
              Container(
                width: 1,
                height: 40,
                color: AppColors.backgroundDeep.withOpacity(0.2),
              ),
              _buildGlobalStatItem('Total Reach', views.toString()),
              Container(
                width: 1,
                height: 40,
                color: AppColors.backgroundDeep.withOpacity(0.2),
              ),
              _buildGlobalStatItem(
                'Active Petitions',
                _myPetitions.length.toString(),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildGlobalStatItem(String label, String value) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          value,
          style: GoogleFonts.outfit(
            fontSize: 24,
            fontWeight: FontWeight.bold,
            color: AppColors.backgroundDeep,
          ),
        ),
        Text(
          label,
          style: TextStyle(
            fontSize: 10,
            color: AppColors.backgroundDeep.withOpacity(0.6),
            fontWeight: FontWeight.bold,
          ),
        ),
      ],
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Feather.clipboard, size: 80, color: AppColors.elevation),
          SizedBox(height: 16),
          Text(
            'No petitions yet',
            style: TextStyle(
              color: AppColors.textMedium,
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          SizedBox(height: 8),
          Text(
            'Create your first petition to see it here.',
            style: TextStyle(color: AppColors.textDisabled),
          ),
          SizedBox(height: 24),
          ElevatedButton(
            onPressed: () => Navigator.push(
              context,
              MaterialPageRoute(
                builder: (_) => EnhancedPetitionCreationScreen(),
              ),
            ),
            style: ElevatedButton.styleFrom(
              backgroundColor: AppColors.primaryLavender,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
            child: Text(
              'Create Petition',
              style: TextStyle(color: AppColors.backgroundDeep),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildManagementItem(Petition petition) {
    return Container(
      margin: EdgeInsets.only(bottom: 16),
      decoration: BoxDecoration(
        color: AppColors.surface,
        borderRadius: BorderRadius.circular(20),
        border: Border.all(color: AppColors.elevation, width: 1),
      ),
      child: InkWell(
        onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (_) => PetitionManagementDashboard(petition: petition),
            ),
          ).then((_) => _loadUserPetitions());
        },
        borderRadius: BorderRadius.circular(20),
        child: Padding(
          padding: EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  ClipRRect(
                    borderRadius: BorderRadius.circular(12),
                    child: CachedNetworkImage(
                      imageUrl: petition.bannerImageUrl ?? '',
                      width: 60,
                      height: 60,
                      fit: BoxFit.cover,
                      errorWidget: (_, __, ___) => Container(
                        color: AppColors.elevation,
                        child: Icon(Feather.image),
                      ),
                    ),
                  ),
                  SizedBox(width: 16),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          petition.title,
                          style: TextStyle(
                            color: AppColors.textHigh,
                            fontWeight: FontWeight.bold,
                            fontSize: 16,
                          ),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),
                        Text(
                          '${petition.currentSignatures} / ${petition.goal} signatures',
                          style: TextStyle(
                            color: AppColors.textDisabled,
                            fontSize: 12,
                          ),
                        ),
                      ],
                    ),
                  ),
                  Icon(
                    Feather.chevron_right,
                    size: 16,
                    color: AppColors.textDisabled,
                  ),
                ],
              ),
              SizedBox(height: 16),
              LinearProgressIndicator(
                value: petition.progress,
                backgroundColor: AppColors.elevation,
                color: AppColors.primaryLavender,
                minHeight: 6,
              ),
              SizedBox(height: 12),
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  _buildMiniStat(Feather.eye, '${petition.views}', 'Views'),
                  _buildMiniStat(
                    Feather.message_square,
                    'Active',
                    'Discussion',
                  ),
                  Text(
                    petition.isExpired ? 'Ended' : '${petition.daysLeft}d left',
                    style: TextStyle(
                      color: petition.isExpired
                          ? AppColors.error
                          : AppColors.secondaryTeal,
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildMiniStat(IconData icon, String value, String label) {
    return Row(
      children: [
        Icon(icon, size: 14, color: AppColors.primaryLavender),
        SizedBox(width: 4),
        Text(
          value,
          style: TextStyle(
            color: AppColors.textHigh,
            fontSize: 12,
            fontWeight: FontWeight.bold,
          ),
        ),
        SizedBox(width: 2),
        Text(
          label,
          style: TextStyle(color: AppColors.textDisabled, fontSize: 10),
        ),
      ],
    );
  }
}

// ========== PETITION MANAGEMENT DASHBOARD ==========
class PetitionManagementDashboard extends StatefulWidget {
  final Petition petition;
  const PetitionManagementDashboard({Key? key, required this.petition})
    : super(key: key);

  @override
  _PetitionManagementDashboardState createState() =>
      _PetitionManagementDashboardState();
}

class _PetitionManagementDashboardState
    extends State<PetitionManagementDashboard> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  late Petition _petition;
  bool _isLoading = false;

  @override
  void initState() {
    super.initState();
    _petition = widget.petition;
  }

  void _editPetition() {
    // Show edit modal with current values
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _EditPetitionModal(
        petition: _petition,
        onUpdated: (updated) {
          setState(() {
            _petition = updated;
          });
        },
      ),
    );
  }

  void _addCollaborator() {
    final controller = TextEditingController();
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: AppColors.surface,
        title: Text(
          'Add Collaborator',
          style: TextStyle(color: AppColors.textHigh),
        ),
        content: TextField(
          controller: controller,
          decoration: InputDecoration(
            hintText: 'Enter username',
            hintStyle: TextStyle(color: AppColors.textDisabled),
            fillColor: AppColors.elevation,
            filled: true,
            border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
          ),
          style: TextStyle(color: AppColors.textHigh),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('Cancel'),
          ),
          ElevatedButton(
            onPressed: () async {
              if (controller.text.isNotEmpty) {
                final newCollabs = List<String>.from(_petition.collaborators)
                  ..add(controller.text.trim());
                await _firestore
                    .collection('petitions')
                    .doc(_petition.id)
                    .update({'collaborators': newCollabs});
                setState(() {
                  _petition = Petition(
                    id: _petition.id,
                    title: _petition.title,
                    description: _petition.description,
                    fullStory: _petition.fullStory,
                    goal: _petition.goal,
                    currentSignatures: _petition.currentSignatures,
                    createdBy: _petition.createdBy,
                    bannerImageUrl: _petition.bannerImageUrl,
                    ageRating: _petition.ageRating,
                    hashtags: _petition.hashtags,
                    signers: _petition.signers,
                    signaturesWithComments: _petition.signaturesWithComments,
                    createdAt: _petition.createdAt,
                    deadline: _petition.deadline,
                    category: _petition.category,
                    collaborators: newCollabs,
                    externalLinks: _petition.externalLinks,
                  );
                });
                Navigator.pop(context);
              }
            },
            child: Text('Add'),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: Text(
          'Manage Petition',
          style: TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: Colors.transparent,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
        elevation: 0,
      ),
      body: SingleChildScrollView(
        padding: EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Status Card
            Container(
              padding: EdgeInsets.all(20),
              decoration: BoxDecoration(
                color: AppColors.surface,
                borderRadius: BorderRadius.circular(20),
              ),
              child: Column(
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            'Goal Progress',
                            style: TextStyle(color: AppColors.textMedium),
                          ),
                          SizedBox(height: 4),
                          Text(
                            '${_petition.currentSignatures} / ${_petition.goal}',
                            style: TextStyle(
                              fontSize: 24,
                              fontWeight: FontWeight.bold,
                              color: AppColors.textHigh,
                            ),
                          ),
                        ],
                      ),
                      Container(
                        padding: EdgeInsets.symmetric(
                          horizontal: 12,
                          vertical: 6,
                        ),
                        decoration: BoxDecoration(
                          color: AppColors.primaryLavender.withOpacity(0.1),
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: Text(
                          '${(_petition.progress * 100).toInt()}%',
                          style: TextStyle(
                            color: AppColors.primaryLavender,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    ],
                  ),
                  SizedBox(height: 20),
                  LinearProgressIndicator(
                    value: _petition.progress,
                    backgroundColor: AppColors.elevation,
                    color: AppColors.primaryLavender,
                    minHeight: 10,
                  ),
                ],
              ),
            ),
            SizedBox(height: 24),

            // Stats Grid
            Row(
              children: [
                _buildCompactStat('Views', '${_petition.views}', Feather.eye),
                SizedBox(width: 12),
                _buildCompactStat(
                  'Shares',
                  '${_petition.shares}',
                  Feather.share_2,
                ),
              ],
            ),
            SizedBox(height: 24),

            Text(
              'Quick Actions',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: AppColors.textHigh,
              ),
            ),
            SizedBox(height: 12),
            _buildActionItem(
              'Edit Petition Details',
              Feather.edit_2,
              _editPetition,
            ),
            _buildActionItem(
              'Manage Collaborators',
              Feather.user_plus,
              _addCollaborator,
            ),
            _buildActionItem(
              'View Detailed Analytics',
              Feather.bar_chart_2,
              () {
                Navigator.push(
                  context,
                  MaterialPageRoute(
                    builder: (_) =>
                        PetitionAnalyticsScreen(petitionId: _petition.id),
                  ),
                );
              },
            ),
            _buildActionItem(
              'Post Official Announcement',
              Feather.volume_2,
              _sendAnnouncement,
            ),
            _buildActionItem(
              'Export Signature Data (CSV)',
              Feather.download,
              () {
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text(
                      'Preparing data export... Check your email shortly.',
                    ),
                    backgroundColor: AppColors.secondaryTeal,
                  ),
                );
              },
            ),
            _buildActionItem('Promotion Insights', Feather.trending_up, () {
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Text(
                    'Petition is currently trending in ${_petition.category}!',
                  ),
                ),
              );
            }),

            SizedBox(height: 24),
            Text(
              'Collaborators',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: AppColors.textHigh,
              ),
            ),
            SizedBox(height: 12),
            if (_petition.collaborators.isEmpty)
              Text(
                'No collaborators added yet.',
                style: TextStyle(color: AppColors.textDisabled),
              )
            else
              Wrap(
                spacing: 8,
                children: _petition.collaborators
                    .map(
                      (c) => Chip(
                        label: Text(
                          c,
                          style: TextStyle(color: AppColors.textHigh),
                        ),
                        backgroundColor: AppColors.elevation,
                        onDeleted: () async {
                          final newCollabs = List<String>.from(
                            _petition.collaborators,
                          )..remove(c);
                          await _firestore
                              .collection('petitions')
                              .doc(_petition.id)
                              .update({'collaborators': newCollabs});
                          setState(() {
                            _petition = Petition(
                              id: _petition.id,
                              title: _petition.title,
                              description: _petition.description,
                              fullStory: _petition.fullStory,
                              goal: _petition.goal,
                              currentSignatures: _petition.currentSignatures,
                              createdBy: _petition.createdBy,
                              bannerImageUrl: _petition.bannerImageUrl,
                              ageRating: _petition.ageRating,
                              hashtags: _petition.hashtags,
                              signers: _petition.signers,
                              signaturesWithComments:
                                  _petition.signaturesWithComments,
                              createdAt: _petition.createdAt,
                              deadline: _petition.deadline,
                              category: _petition.category,
                              collaborators: newCollabs,
                              externalLinks: _petition.externalLinks,
                            );
                          });
                        },
                        deleteIcon: Icon(
                          Feather.x,
                          size: 16,
                          color: AppColors.error,
                        ),
                      ),
                    )
                    .toList(),
              ),
          ],
        ),
      ),
    );
  }

  void _sendAnnouncement() {
    final titleController = TextEditingController();
    final bodyController = TextEditingController();
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => Container(
        padding: EdgeInsets.only(
          top: 20,
          left: 20,
          right: 20,
          bottom: MediaQuery.of(context).viewInsets.bottom + 20,
        ),
        decoration: BoxDecoration(
          color: AppColors.backgroundDeep,
          borderRadius: BorderRadius.vertical(top: Radius.circular(30)),
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'Send Official Update',
              style: GoogleFonts.outfit(
                fontSize: 24,
                fontWeight: FontWeight.bold,
                color: AppColors.textHigh,
              ),
            ),
            SizedBox(height: 8),
            Text(
              'This will notify all signers and appear in the petition story.',
              style: TextStyle(color: AppColors.textDisabled),
            ),
            SizedBox(height: 20),
            TextField(
              controller: titleController,
              decoration: InputDecoration(
                hintText: 'Update Title',
                filled: true,
                fillColor: AppColors.surface,
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(15),
                  borderSide: BorderSide.none,
                ),
              ),
              style: TextStyle(color: AppColors.textHigh),
            ),
            SizedBox(height: 12),
            TextField(
              controller: bodyController,
              maxLines: 5,
              decoration: InputDecoration(
                hintText: 'Tell your supporters what\'s happening...',
                filled: true,
                fillColor: AppColors.surface,
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(15),
                  borderSide: BorderSide.none,
                ),
              ),
              style: TextStyle(color: AppColors.textHigh),
            ),
            SizedBox(height: 24),
            ElevatedButton(
              onPressed: () async {
                if (titleController.text.isNotEmpty &&
                    bodyController.text.isNotEmpty) {
                  setState(() => _isLoading = true);
                  try {
                    await _firestore
                        .collection('petitions')
                        .doc(_petition.id)
                        .collection('announcements')
                        .add({
                          'title': titleController.text.trim(),
                          'body': bodyController.text.trim(),
                          'timestamp': FieldValue.serverTimestamp(),
                          'authorId': _auth.currentUser?.uid,
                        });

                    // Send notifications to all signers
                    NotificationService().sendPetitionUpdateNotification(
                      petitionId: _petition.id,
                      petitionTitle: _petition.title,
                      updateTitle: titleController.text.trim(),
                      signerIds: _petition.signers,
                      bannerImageUrl: _petition.bannerImageUrl,
                    );

                    Navigator.pop(context);
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text('Announcement successfully posted!'),
                        backgroundColor: AppColors.success,
                      ),
                    );
                  } catch (e) {
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text('Failed to post announcement: $e'),
                        backgroundColor: AppColors.error,
                      ),
                    );
                  } finally {
                    setState(() => _isLoading = false);
                  }
                }
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.primaryLavender,
                minimumSize: Size(double.infinity, 55),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(15),
                ),
              ),
              child: _isLoading
                  ? CircularProgressIndicator(color: AppColors.backgroundDeep)
                  : Text(
                      'POST ANNOUNCEMENT',
                      style: TextStyle(
                        fontWeight: FontWeight.bold,
                        color: AppColors.backgroundDeep,
                      ),
                    ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildCompactStat(String label, String value, IconData icon) {
    return Expanded(
      child: Container(
        padding: EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: AppColors.surface,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.elevation, width: 1),
        ),
        child: Row(
          children: [
            Container(
              padding: EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: AppColors.primaryLavender.withOpacity(0.1),
                borderRadius: BorderRadius.circular(10),
              ),
              child: Icon(icon, color: AppColors.primaryLavender, size: 20),
            ),
            SizedBox(width: 12),
            Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  value,
                  style: GoogleFonts.outfit(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: AppColors.textHigh,
                  ),
                ),
                Text(
                  label,
                  style: TextStyle(
                    fontSize: 11,
                    color: AppColors.textDisabled,
                    letterSpacing: 0.5,
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildActionItem(String title, IconData icon, VoidCallback onTap) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(16),
        child: Container(
          padding: EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: AppColors.elevation.withOpacity(0.5),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: AppColors.surface, width: 1),
          ),
          child: Row(
            children: [
              Icon(icon, color: AppColors.primaryLavender, size: 22),
              SizedBox(width: 16),
              Expanded(
                child: Text(
                  title,
                  style: TextStyle(
                    color: AppColors.textHigh,
                    fontWeight: FontWeight.w500,
                    fontSize: 15,
                  ),
                ),
              ),
              Icon(
                Feather.chevron_right,
                size: 14,
                color: AppColors.textDisabled,
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _EditPetitionModal extends StatefulWidget {
  final Petition petition;
  final Function(Petition) onUpdated;
  const _EditPetitionModal({required this.petition, required this.onUpdated});

  @override
  __EditPetitionModalState createState() => __EditPetitionModalState();
}

class __EditPetitionModalState extends State<_EditPetitionModal> {
  late TextEditingController _titleController;
  late TextEditingController _descController;
  late TextEditingController _storyController;
  bool _isLoading = false;

  @override
  void initState() {
    super.initState();
    _titleController = TextEditingController(text: widget.petition.title);
    _descController = TextEditingController(text: widget.petition.description);
    _storyController = TextEditingController(text: widget.petition.fullStory);
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: AppColors.backgroundDeep,
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      padding: EdgeInsets.all(
        20,
      ).copyWith(bottom: MediaQuery.of(context).viewInsets.bottom + 20),
      child: SingleChildScrollView(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'Edit Petition',
              style: TextStyle(
                fontSize: 20,
                fontWeight: FontWeight.bold,
                color: AppColors.textHigh,
              ),
            ),
            SizedBox(height: 20),
            _buildEditField('Title', _titleController),
            _buildEditField('Description', _descController, maxLines: 2),
            _buildEditField('Full Story', _storyController, maxLines: 5),
            SizedBox(height: 20),
            ElevatedButton(
              onPressed: _isLoading
                  ? null
                  : () async {
                      setState(() => _isLoading = true);
                      await FirebaseFirestore.instance
                          .collection('petitions')
                          .doc(widget.petition.id)
                          .update({
                            'title': _titleController.text,
                            'description': _descController.text,
                            'fullStory': _storyController.text,
                          });
                      widget.onUpdated(
                        Petition(
                          id: widget.petition.id,
                          title: _titleController.text,
                          description: _descController.text,
                          fullStory: _storyController.text,
                          goal: widget.petition.goal,
                          currentSignatures: widget.petition.currentSignatures,
                          createdBy: widget.petition.createdBy,
                          bannerImageUrl: widget.petition.bannerImageUrl,
                          ageRating: widget.petition.ageRating,
                          hashtags: widget.petition.hashtags,
                          signers: widget.petition.signers,
                          signaturesWithComments:
                              widget.petition.signaturesWithComments,
                          createdAt: widget.petition.createdAt,
                          deadline: widget.petition.deadline,
                          category: widget.petition.category,
                          collaborators: widget.petition.collaborators,
                          externalLinks: widget.petition.externalLinks,
                        ),
                      );
                      Navigator.pop(context);
                    },
              child: _isLoading
                  ? CircularProgressIndicator()
                  : Text('Save Changes'),
              style: ElevatedButton.styleFrom(
                minimumSize: Size(double.infinity, 50),
                backgroundColor: AppColors.primaryLavender,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildEditField(
    String label,
    TextEditingController controller, {
    int maxLines = 1,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: TextStyle(
            color: AppColors.textMedium,
            fontWeight: FontWeight.bold,
          ),
        ),
        SizedBox(height: 8),
        TextField(
          controller: controller,
          maxLines: maxLines,
          style: TextStyle(color: AppColors.textHigh),
          decoration: InputDecoration(
            fillColor: AppColors.elevation,
            filled: true,
            border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
          ),
        ),
        SizedBox(height: 16),
      ],
    );
  }
}


--- C:\Code\femn\lib\circle\polls.dart ---

import 'dart:io';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:image_picker/image_picker.dart';
import 'package:uuid/uuid.dart';
import 'package:femn/customization/colors.dart'; // <--- IMPORT COLORS
import 'groups.dart'; // Assuming GroupsScreen is defined here
import '../services/notification_service.dart';

// --- New Poll Creation Screen ---
class PollCreationScreen extends StatefulWidget {
  @override
  _PollCreationScreenState createState() => _PollCreationScreenState();
}

class _PollCreationScreenState extends State<PollCreationScreen> {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseStorage _storage = FirebaseStorage.instance;

  final TextEditingController _questionController = TextEditingController();
  final TextEditingController _hashtagController = TextEditingController();

  final List<_PollOptionInput> _optionInputs = [
    _PollOptionInput(controller: TextEditingController(), image: null),
    _PollOptionInput(controller: TextEditingController(), image: null),
  ];

  List<String> _hashtags = [];
  String _selectedAgeRating = '13-17';
  String _selectedDuration = '7';

  final List<String> _ageRatings = ['13-17', '18-25', '26+'];
  final List<Map<String, String>> _durations = [
    {'value': '7', 'label': '1 Week'},
    {'value': '30', 'label': '1 Month'},
  ];

  bool _isLoading = false;
  late String _currentUserId;

  @override
  void initState() {
    super.initState();
    _currentUserId = _auth.currentUser!.uid;
  }

  // Helper method to upload option images
  Future<String?> _uploadOptionImage(File imageFile) async {
    try {
      final String fileName = 'poll_options/${Uuid().v4()}.jpg';
      final Reference ref = _storage.ref().child(fileName);
      await ref.putFile(imageFile);
      return await ref.getDownloadURL();
    } catch (e) {
      print("Error uploading option image: $e");
      return null;
    }
  }

  Future<void> _createPoll() async {
    final String question = _questionController.text.trim();
    if (question.isEmpty) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Poll question is required')));
      return;
    }

    // Validate options
    List<Map<String, dynamic>> optionsData = [];
    bool hasValidOption = false;
    for (var input in _optionInputs) {
      final String text = input.controller.text.trim();
      if (text.isNotEmpty) {
        hasValidOption = true;
        String? imageUrl;
        if (input.image != null) {
          imageUrl = await _uploadOptionImage(input.image!);
        }
        optionsData.add({'text': text, 'imageUrl': imageUrl});
      }
    }

    if (!hasValidOption || optionsData.length < 2) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('At least two valid options are required')),
      );
      return;
    }

    setState(() {
      _isLoading = true;
    });

    try {
      final String pollId = Uuid().v4();
      final FieldValue timestamp = FieldValue.serverTimestamp();

      final int durationDays = int.parse(_selectedDuration);
      final Timestamp expiresAt = Timestamp.fromDate(
        DateTime.now().add(Duration(days: durationDays)),
      );

      final Map<String, dynamic> pollData = {
        'id': pollId,
        'question': question,
        'options': optionsData,
        'createdBy': _currentUserId,
        'createdAt': timestamp,
        'expiresAt': expiresAt,
        'totalVotes': 0,
        'voters': [],
        'ageRating': _selectedAgeRating,
        'hashtags': _hashtags,
        'type': 'poll',
      };

      await _firestore.collection('polls').doc(pollId).set(pollData);

      // Send notifications to followers
      final userDoc = await _firestore
          .collection('users')
          .doc(_currentUserId)
          .get();
      final username = userDoc.data()?['username'] ?? 'User';

      NotificationService().sendPollCreatedNotification(
        creatorId: _currentUserId,
        creatorUsername: username,
        pollId: pollId,
        pollQuestion: question,
      );

      // Show success and navigate back to groups screen
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Poll created successfully!')));

      // Navigate back to groups screen
      Navigator.pushReplacement(
        context,
        MaterialPageRoute(builder: (context) => GroupsScreen()),
      );
    } catch (e) {
      print("Error creating poll: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to create poll. Please try again.')),
      );
    } finally {
      setState(() {
        _isLoading = false;
      });
    }
  }

  Widget _buildSectionHeader(String title, IconData icon) {
    return Row(
      children: [
        Container(
          width: 30,
          height: 30,
          decoration: BoxDecoration(
            color: AppColors.primaryLavender.withOpacity(0.1),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Icon(icon, size: 18, color: AppColors.primaryLavender),
        ),
        SizedBox(width: 10),
        Text(
          title,
          style: TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.w600,
            color: AppColors.textHigh,
          ),
        ),
      ],
    );
  }

  Widget _buildOptionInputField(
    _PollOptionInput optionInput,
    int index,
    int totalOptions,
    Function(File?) onImagePicked,
    VoidCallback onRemove,
  ) {
    return Container(
      margin: EdgeInsets.only(bottom: 12),
      padding: EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: AppColors.elevation, // Darker input background
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 5,
            offset: Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        children: [
          Row(
            children: [
              Expanded(
                child: TextField(
                  controller: optionInput.controller,
                  style: TextStyle(color: AppColors.textHigh),
                  decoration: InputDecoration(
                    hintText: 'Option ${index + 1}',
                    hintStyle: TextStyle(color: AppColors.textDisabled),
                    border: InputBorder.none,
                    contentPadding: EdgeInsets.zero,
                  ),
                ),
              ),
              SizedBox(width: 8),
              // Image Picker Button
              GestureDetector(
                onTap: () async {
                  final ImagePicker picker = ImagePicker();
                  final XFile? pickedImage = await picker.pickImage(
                    source: ImageSource.gallery,
                  );
                  if (pickedImage != null) {
                    onImagePicked(File(pickedImage.path));
                  }
                },
                child: Container(
                  width: 40,
                  height: 40,
                  decoration: BoxDecoration(
                    color: AppColors.surface,
                    border: Border.all(color: AppColors.textDisabled),
                    borderRadius: BorderRadius.circular(4),
                  ),
                  child: optionInput.image != null
                      ? ClipRRect(
                          borderRadius: BorderRadius.circular(4),
                          child: Image.file(
                            optionInput.image!,
                            fit: BoxFit.cover,
                          ),
                        )
                      : Icon(
                          Feather.camera,
                          size: 20,
                          color: AppColors.textMedium,
                        ),
                ),
              ),
            ],
          ),
          // Remove Button (only if more than 2 options)
          if (totalOptions > 2)
            Align(
              alignment: Alignment.centerRight,
              child: TextButton(
                onPressed: onRemove,
                child: Text(
                  'Remove Option',
                  style: TextStyle(color: AppColors.error, fontSize: 12),
                ),
              ),
            ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent, // Deep background
      appBar: AppBar(
        title: Text(
          'Create New Poll',
          style: TextStyle(
            fontSize: 20,
            fontWeight: FontWeight.w600,
            color: AppColors.textHigh,
          ),
        ),
        backgroundColor: Colors.transparent,
        foregroundColor: AppColors.textHigh,
        elevation: 0,
        centerTitle: true,
        leading: IconButton(
          icon: Icon(Feather.arrow_left, color: AppColors.primaryLavender),
          // Navigate to GroupsScreen instead of popping
          onPressed: () {
            Navigator.pushReplacement(
              context,
              MaterialPageRoute(builder: (context) => GroupsScreen()),
            );
          },
        ),
      ),
      body: Container(
        // Subtle dark gradient background
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Colors.transparent,
              Color(0xFF1A1620), // Slightly lighter dark
            ],
          ),
        ),
        child: Padding(
          padding: EdgeInsets.all(20.0),
          child: SingleChildScrollView(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Header Section
                Container(
                  width: double.infinity,
                  padding: EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    color: AppColors.surface, // Surface Card
                    borderRadius: BorderRadius.circular(20),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.3),
                        blurRadius: 10,
                        offset: Offset(0, 4),
                      ),
                    ],
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Icon(
                            Feather.bar_chart_2,
                            color: AppColors.primaryLavender,
                            size: 24,
                          ),
                          SizedBox(width: 10),
                          Text(
                            'Create Your Poll',
                            style: TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.w600,
                              color: AppColors.textHigh,
                            ),
                          ),
                        ],
                      ),
                      SizedBox(height: 8),
                      Text(
                        'Ask a question and let the community vote!',
                        style: TextStyle(
                          color: AppColors.textMedium,
                          fontSize: 14,
                        ),
                      ),
                    ],
                  ),
                ),
                SizedBox(height: 24),

                // Poll Question
                _buildSectionHeader('Poll Question', Feather.help_circle),
                SizedBox(height: 8),
                Container(
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(15),
                    color: AppColors.elevation,
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.1),
                        blurRadius: 5,
                        offset: Offset(0, 2),
                      ),
                    ],
                  ),
                  child: TextField(
                    controller: _questionController,
                    style: TextStyle(color: AppColors.textHigh),
                    decoration: InputDecoration(
                      labelText: 'What would you like to ask?',
                      labelStyle: TextStyle(color: AppColors.textMedium),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(15),
                        borderSide: BorderSide.none,
                      ),
                      filled: true,
                      fillColor: AppColors.elevation,
                      prefixIcon: Icon(
                        Feather.edit_2,
                        color: AppColors.primaryLavender,
                      ),
                      contentPadding: EdgeInsets.symmetric(
                        horizontal: 20,
                        vertical: 16,
                      ),
                    ),
                    maxLines: 2,
                  ),
                ),
                SizedBox(height: 20),

                // Poll Options
                _buildSectionHeader('Poll Options', Feather.list),
                SizedBox(height: 8),
                Text(
                  'Add at least 2 options for people to vote on',
                  style: TextStyle(color: AppColors.textMedium, fontSize: 14),
                ),
                SizedBox(height: 12),
                ...List.generate(_optionInputs.length, (index) {
                  return _buildOptionInputField(
                    _optionInputs[index],
                    index,
                    _optionInputs.length,
                    (File? newImage) {
                      setState(() {
                        _optionInputs[index].image = newImage;
                      });
                    },
                    () {
                      setState(() {
                        _optionInputs.removeAt(index);
                      });
                    },
                  );
                }),
                SizedBox(height: 8),
                Container(
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(
                      color: AppColors.primaryLavender,
                      width: 1,
                    ),
                  ),
                  child: TextButton(
                    onPressed: () {
                      setState(() {
                        _optionInputs.add(
                          _PollOptionInput(
                            controller: TextEditingController(),
                            image: null,
                          ),
                        );
                      });
                    },
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          Feather.plus,
                          color: AppColors.primaryLavender,
                          size: 20,
                        ),
                        SizedBox(width: 8),
                        Text(
                          'Add Another Option',
                          style: TextStyle(
                            color: AppColors.primaryLavender,
                            fontSize: 14,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
                SizedBox(height: 20),

                // Duration Selection
                _buildSectionHeader('Poll Duration', Feather.clock),
                SizedBox(height: 8),
                Container(
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(15),
                    color: AppColors.elevation,
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.1),
                        blurRadius: 5,
                        offset: Offset(0, 2),
                      ),
                    ],
                  ),
                  child: DropdownButtonFormField<String>(
                    value: _selectedDuration,
                    dropdownColor: AppColors.surface,
                    style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                    iconEnabledColor: AppColors.primaryLavender,
                    items: _durations.map((duration) {
                      return DropdownMenuItem<String>(
                        value: duration['value'],
                        child: Text(duration['label']!),
                      );
                    }).toList(),
                    onChanged: (value) {
                      if (value != null) {
                        setState(() {
                          _selectedDuration = value;
                        });
                      }
                    },
                    decoration: InputDecoration(
                      labelText: 'How long should the poll run?',
                      labelStyle: TextStyle(color: AppColors.textMedium),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(15),
                        borderSide: BorderSide.none,
                      ),
                      filled: true,
                      fillColor: AppColors.elevation,
                      prefixIcon: Icon(
                        Feather.clock,
                        color: AppColors.primaryLavender,
                      ),
                      contentPadding: EdgeInsets.symmetric(horizontal: 20),
                    ),
                  ),
                ),
                SizedBox(height: 20),

                // Age Rating
                _buildSectionHeader('Age Rating', Feather.users),
                SizedBox(height: 8),
                Container(
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(15),
                    color: AppColors.elevation,
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.1),
                        blurRadius: 5,
                        offset: Offset(0, 2),
                      ),
                    ],
                  ),
                  child: DropdownButtonFormField<String>(
                    value: _selectedAgeRating,
                    dropdownColor: AppColors.surface,
                    style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                    iconEnabledColor: AppColors.primaryLavender,
                    items: _ageRatings.map((rating) {
                      return DropdownMenuItem<String>(
                        value: rating,
                        child: Text(rating),
                      );
                    }).toList(),
                    onChanged: (value) {
                      if (value != null) {
                        setState(() {
                          _selectedAgeRating = value;
                        });
                      }
                    },
                    decoration: InputDecoration(
                      labelText: 'Who should see this poll?',
                      labelStyle: TextStyle(color: AppColors.textMedium),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(15),
                        borderSide: BorderSide.none,
                      ),
                      filled: true,
                      fillColor: AppColors.elevation,
                      prefixIcon: Icon(
                        Feather.users,
                        color: AppColors.primaryLavender,
                      ),
                      contentPadding: EdgeInsets.symmetric(horizontal: 20),
                    ),
                  ),
                ),
                SizedBox(height: 20),

                // Hashtags
                _buildSectionHeader('Hashtags', Feather.hash),
                SizedBox(height: 8),
                Container(
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(15),
                    color: AppColors.elevation,
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.1),
                        blurRadius: 5,
                        offset: Offset(0, 2),
                      ),
                    ],
                  ),
                  child: TextField(
                    controller: _hashtagController,
                    style: TextStyle(color: AppColors.textHigh),
                    decoration: InputDecoration(
                      labelText: 'Add relevant hashtags',
                      labelStyle: TextStyle(color: AppColors.textMedium),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(15),
                        borderSide: BorderSide.none,
                      ),
                      filled: true,
                      fillColor: AppColors.elevation,
                      prefixIcon: Icon(
                        Feather.hash,
                        color: AppColors.primaryLavender,
                      ),
                      suffixIcon: IconButton(
                        icon: Container(
                          width: 32,
                          height: 32,
                          decoration: BoxDecoration(
                            color: AppColors.primaryLavender,
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Icon(
                            Feather.plus,
                            color: AppColors.backgroundDeep,
                            size: 18,
                          ),
                        ),
                        onPressed: () {
                          String newTag = _hashtagController.text
                              .trim()
                              .replaceAll('#', '');
                          if (newTag.isNotEmpty &&
                              !_hashtags.contains(newTag)) {
                            setState(() {
                              _hashtags.add(newTag);
                            });
                            _hashtagController.clear();
                          }
                        },
                      ),
                      contentPadding: EdgeInsets.symmetric(
                        horizontal: 20,
                        vertical: 16,
                      ),
                    ),
                    onSubmitted: (_) {
                      String newTag = _hashtagController.text.trim().replaceAll(
                        '#',
                        '',
                      );
                      if (newTag.isNotEmpty && !_hashtags.contains(newTag)) {
                        setState(() {
                          _hashtags.add(newTag);
                        });
                        _hashtagController.clear();
                      }
                    },
                  ),
                ),
                SizedBox(height: 12),

                // Display added hashtags
                if (_hashtags.isNotEmpty)
                  Wrap(
                    spacing: 8.0,
                    runSpacing: 8.0,
                    children: _hashtags.map((tag) {
                      return Container(
                        decoration: BoxDecoration(
                          color: AppColors.secondaryTeal.withOpacity(
                            0.2,
                          ), // Teal for tags
                          borderRadius: BorderRadius.circular(20),
                        ),
                        child: Padding(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 12,
                            vertical: 6,
                          ),
                          child: Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Text(
                                '#$tag',
                                style: TextStyle(
                                  color: AppColors.secondaryTeal,
                                  fontWeight: FontWeight.w500,
                                ),
                              ),
                              SizedBox(width: 4),
                              GestureDetector(
                                onTap: () {
                                  setState(() {
                                    _hashtags.remove(tag);
                                  });
                                },
                                child: Icon(
                                  Feather.x,
                                  size: 16,
                                  color: AppColors.secondaryTeal,
                                ),
                              ),
                            ],
                          ),
                        ),
                      );
                    }).toList(),
                  ),
                SizedBox(height: 30),

                // Create Poll Button
                Container(
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(15),
                    boxShadow: [
                      BoxShadow(
                        color: AppColors.primaryLavender.withOpacity(0.3),
                        blurRadius: 10,
                        offset: Offset(0, 4),
                      ),
                    ],
                  ),
                  child: ElevatedButton(
                    onPressed: _isLoading ? null : _createPoll,
                    style: ElevatedButton.styleFrom(
                      minimumSize: Size(double.infinity, 55),
                      backgroundColor: AppColors.primaryLavender,
                      foregroundColor: AppColors.backgroundDeep,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(15),
                      ),
                      elevation: 0,
                    ),
                    child: _isLoading
                        ? SizedBox(
                            height: 20,
                            width: 20,
                            child: CircularProgressIndicator(
                              strokeWidth: 2,
                              color: AppColors.backgroundDeep,
                            ),
                          )
                        : Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Icon(Feather.bar_chart_2, size: 20),
                              SizedBox(width: 8),
                              Text(
                                'Create Poll',
                                style: TextStyle(
                                  fontSize: 16,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                            ],
                          ),
                  ),
                ),
                SizedBox(height: 20),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

// Helper class to hold option text and image
class _PollOptionInput {
  final TextEditingController controller;
  File? image;

  _PollOptionInput({required this.controller, this.image});
}

// --- 2. Widget for Poll Card in the Grid ---
class PollCard extends StatefulWidget {
  final DocumentSnapshot pollSnapshot;
  final double cardMarginVertical;
  final double cardMarginHorizontal;
  final double cardInternalPadding;
  final double borderRadiusValue;
  final bool isCompact;

  const PollCard({
    Key? key,
    required this.pollSnapshot,
    required this.cardMarginVertical,
    required this.cardMarginHorizontal,
    required this.cardInternalPadding,
    required this.borderRadiusValue,
    this.isCompact = false,
  }) : super(key: key);

  @override
  State<PollCard> createState() => _PollCardState();
}

class _PollCardState extends State<PollCard> {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;

  late Map<String, dynamic> _pollData;
  late String _currentUserId;
  String? _userVote; // Tracks the user's current vote

  @override
  void initState() {
    super.initState();
    _currentUserId = _auth.currentUser!.uid;
    _loadPollData();
  }

  void _loadPollData() {
    _pollData = widget.pollSnapshot.data() as Map<String, dynamic>;
    List<dynamic> voters = _pollData['voters'] ?? [];
    // Check if the current user has already voted
    for (var voteEntry in voters) {
      if (voteEntry is Map<String, dynamic> &&
          voteEntry['userId'] == _currentUserId) {
        _userVote =
            voteEntry['optionText']; // Store the option text they voted for
        break;
      }
    }
  }

  Future<void> _vote(String optionText) async {
    if (_userVote != null) return; // Prevent re-voting

    try {
      final DocumentReference pollRef = _firestore
          .collection('polls')
          .doc(widget.pollSnapshot.id);

      // Update the main poll document
      await _firestore.runTransaction((transaction) async {
        DocumentSnapshot snapshot = await transaction.get(pollRef);
        if (!snapshot.exists) return;

        Map<String, dynamic> data = snapshot.data() as Map<String, dynamic>;
        List<dynamic> voters = List.from(data['voters'] ?? []);
        int totalVotes = data['totalVotes'] ?? 0;

        // Add the user's vote to the list
        voters.add({'userId': _currentUserId, 'optionText': optionText});
        totalVotes += 1;

        transaction.update(pollRef, {
          'voters': voters,
          'totalVotes': totalVotes,
        });
      });

      // Fetch the updated poll data immediately after voting
      final DocumentSnapshot updatedSnapshot = await pollRef.get();
      if (updatedSnapshot.exists) {
        setState(() {
          _pollData = updatedSnapshot.data() as Map<String, dynamic>;
          _userVote = optionText; // Update local state

          // Update the voters list from the fresh data
          List<dynamic> voters = _pollData['voters'] ?? [];
          for (var voteEntry in voters) {
            if (voteEntry is Map<String, dynamic> &&
                voteEntry['userId'] == _currentUserId) {
              _userVote = voteEntry['optionText'];
              break;
            }
          }
        });
      }

      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Vote recorded!')));
    } catch (e) {
      print("Error voting: $e");
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Failed to vote. Please try again.')),
      );
    }
  }

  Widget _buildVotingOption(
    String text,
    String? imageUrl,
    VoidCallback onTap,
    bool isSelected,
  ) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 10.0),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(12),
        child: Row(
          children: [
            // Circular option indicator - thicker border when selected
            Container(
              width: 20,
              height: 20,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                border: Border.all(
                  color: AppColors.primaryLavender,
                  width: isSelected ? 3.0 : 1.5, // Thicker border when selected
                ),
              ),
              child: imageUrl != null && imageUrl.isNotEmpty
                  ? ClipOval(
                      child: Image.network(
                        imageUrl,
                        fit: BoxFit.cover,
                        errorBuilder: (c, e, s) =>
                            const Icon(Feather.alert_circle, size: 16),
                      ),
                    )
                  : null,
            ),
            const SizedBox(width: 10),
            Expanded(
              child: Text(
                text,
                style: TextStyle(
                  fontSize: 14,
                  color: AppColors.primaryLavender,
                  fontWeight: isSelected
                      ? FontWeight.bold
                      : FontWeight.normal, // Thicker font when selected
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildResultsOption(
    String text,
    String? imageUrl,
    double percentage,
    bool isUserVote,
  ) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 10.0),
      child: Row(
        children: [
          // Circular option indicator - thicker border for user's vote
          Container(
            width: 20,
            height: 20,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              border: Border.all(
                color: isUserVote
                    ? AppColors.accentMustard
                    : AppColors
                          .primaryLavender, // Mustard highlight if user voted
                width: isUserVote ? 3.0 : 1.5,
              ),
            ),
            child: imageUrl != null && imageUrl.isNotEmpty
                ? ClipOval(
                    child: Image.network(
                      imageUrl,
                      fit: BoxFit.cover,
                      errorBuilder: (c, e, s) =>
                          const Icon(Feather.alert_circle, size: 16),
                    ),
                  )
                : null,
          ),
          const SizedBox(width: 10),
          Expanded(
            child: Text(
              text,
              style: TextStyle(
                fontSize: 14,
                color: AppColors.textHigh,
                fontWeight: isUserVote ? FontWeight.bold : FontWeight.normal,
              ),
            ),
          ),
          Text(
            '${percentage.toStringAsFixed(1)}%',
            style: TextStyle(
              fontSize: 12,
              color: AppColors.primaryLavender,
              fontWeight: isUserVote ? FontWeight.bold : FontWeight.w500,
            ),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final String question = _pollData['question'] ?? 'No question';
    final List<dynamic> optionsData = _pollData['options'] ?? [];
    final int totalVotes = _pollData['totalVotes'] ?? 0;
    // final String ageRating = _pollData['ageRating'] ?? '13-17';
    // final List<dynamic> hashtagsList = _pollData['hashtags'] ?? [];

    int? daysLeft;
    if (_pollData['expiresAt'] != null) {
      final Timestamp expiresAt = _pollData['expiresAt'];
      final DateTime now = DateTime.now();
      daysLeft = expiresAt.toDate().difference(now).inDays;
    }

    // Limit options to 6 for display
    List<dynamic> displayOptions =
        optionsData.length > (widget.isCompact ? 3 : 6)
        ? optionsData.take(widget.isCompact ? 3 : 6).toList()
        : optionsData;

    return Container(
      margin: EdgeInsets.symmetric(
        vertical: widget.cardMarginVertical,
        horizontal: widget.cardMarginHorizontal,
      ),
      padding: EdgeInsets.all(widget.cardInternalPadding),
      decoration: BoxDecoration(
        color: AppColors.surface, // Surface card color
        borderRadius: BorderRadius.circular(widget.borderRadiusValue),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.2),
            blurRadius: 6,
            offset: const Offset(0, 3),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Question Title
          Text(
            question,
            style: TextStyle(
              fontWeight: FontWeight.bold,
              fontSize: widget.isCompact ? 14 : 18,
              color: AppColors.textHigh, // Off-white heading
            ),
          ),
          SizedBox(height: widget.isCompact ? 8 : 16),

          // Options
          ...displayOptions.asMap().entries.map((entry) {
            // int index = entry.key;
            dynamic option = entry.value;
            String optionText = option is Map<String, dynamic>
                ? (option['text'] ?? '')
                : option.toString();
            // String? optionImageUrl =
            //     option is Map<String, dynamic> ? option['imageUrl'] : null;

            int optionVoteCount = 0;
            if (_pollData['voters'] is List) {
              optionVoteCount = (_pollData['voters'] as List)
                  .where(
                    (vote) =>
                        vote is Map<String, dynamic> &&
                        vote['optionText'] == optionText,
                  )
                  .length;
            }

            double percentage = totalVotes > 0
                ? (optionVoteCount / totalVotes)
                : 0;

            bool isUserVote = _userVote == optionText;

            return Padding(
              padding: const EdgeInsets.symmetric(vertical: 4.0),
              child: InkWell(
                onTap: _userVote == null ? () => _vote(optionText) : null,
                borderRadius: BorderRadius.circular(30),
                splashColor: AppColors.primaryLavender.withOpacity(0.2),
                child: Stack(
                  children: [
                    // Background pill
                    Container(
                      height: widget.isCompact ? 32 : 44,
                      decoration: BoxDecoration(
                        color: AppColors.elevation, // Dark container for option
                        borderRadius: BorderRadius.circular(30),
                      ),
                    ),
                    // Animated fill
                    if (_userVote != null)
                      TweenAnimationBuilder<double>(
                        tween: Tween<double>(begin: 0, end: percentage),
                        duration: const Duration(milliseconds: 700),
                        builder: (context, value, child) {
                          return FractionallySizedBox(
                            widthFactor: value > 0
                                ? value
                                : 0.001, // Avoid 0 width issues
                            child: Container(
                              height: widget.isCompact ? 32 : 44,
                              decoration: BoxDecoration(
                                borderRadius: BorderRadius.circular(30),
                                color: isUserVote
                                    ? AppColors
                                          .secondaryTeal // Active/Selected fill
                                    : AppColors.primaryLavender.withOpacity(
                                        0.5,
                                      ), // Other options fill
                              ),
                            ),
                          );
                        },
                      ),
                    // Option Text + Percent Badge
                    Container(
                      height: widget.isCompact ? 32 : 44,
                      padding: const EdgeInsets.symmetric(horizontal: 16),
                      alignment: Alignment.centerLeft,
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Flexible(
                            child: Text(
                              optionText,
                              style: TextStyle(
                                fontWeight: isUserVote
                                    ? FontWeight.bold
                                    : FontWeight.w500,
                                color: isUserVote
                                    ? Colors.white
                                    : AppColors
                                          .textHigh, // White text on Teal, High on Elevation
                                fontSize: widget.isCompact ? 12 : 14,
                              ),
                              overflow: TextOverflow.ellipsis,
                            ),
                          ),
                          if (_userVote != null)
                            Container(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 6,
                                vertical: 2,
                              ),
                              decoration: BoxDecoration(
                                color: Colors.black.withOpacity(0.3),
                                borderRadius: BorderRadius.circular(12),
                              ),
                              child: Text(
                                '${(percentage * 100).round()}%',
                                style: TextStyle(
                                  fontSize: widget.isCompact ? 10 : 12,
                                  fontWeight: FontWeight.bold,
                                  color: Colors.white,
                                ),
                              ),
                            ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            );
          }).toList(),

          const SizedBox(height: 12),

          // Days left mini pill
          if (daysLeft != null && daysLeft >= 0)
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
              decoration: BoxDecoration(
                color: AppColors.accentMustard.withOpacity(
                  0.8,
                ), // Mustard for alert
                borderRadius: BorderRadius.circular(12),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.08),
                    blurRadius: 3,
                    offset: Offset(0, 2),
                  ),
                ],
              ),
              child: Text(
                '$daysLeft days left',
                style: const TextStyle(
                  color: AppColors.backgroundDeep,
                  fontSize: 10,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
        ],
      ),
    );
  }
}


--- C:\Code\femn\lib\circle\poll_detail_screen.dart ---

import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import '../../customization/colors.dart';
import '../../widgets/femn_background.dart';
import 'package:femn/circle/polls.dart';

class PollDetailScreen extends StatelessWidget {
  final String pollId;

  const PollDetailScreen({Key? key, required this.pollId}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      extendBodyBehindAppBar: true,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: Container(
          margin: const EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: AppColors.elevation.withOpacity(0.8),
            shape: BoxShape.circle,
          ),
          child: IconButton(
            icon: const Icon(Feather.arrow_left, color: AppColors.textHigh, size: 20),
            onPressed: () => Navigator.pop(context),
          ),
        ),
      ),
      body: FemnBackground(
        child: StreamBuilder<DocumentSnapshot>(
          stream: FirebaseFirestore.instance.collection('polls').doc(pollId).snapshots(),
          builder: (context, snapshot) {
            if (snapshot.hasError) {
              return Center(child: Text('Error loading poll', style: TextStyle(color: AppColors.error)));
            }
            if (!snapshot.hasData || !snapshot.data!.exists) {
              return Center(child: Text('Poll not found', style: TextStyle(color: AppColors.textMedium)));
            }
            
            // Just display the PollCard in a centered view
            return Center(
              child: SingleChildScrollView(
                padding: EdgeInsets.symmetric(horizontal: 16, vertical: 80),
                child: PollCard(
                  pollSnapshot: snapshot.data!,
                  cardMarginVertical: 8,
                  cardMarginHorizontal: 0,
                  cardInternalPadding: 16,
                  borderRadiusValue: 16,
                ),
              ),
            );
          },
        ),
      ),
    );
  }
}


--- C:\Code\femn\lib\customization\colors.dart ---

import 'package:flutter/material.dart';

class AppColors {
  // --- 1. The Core Palette ---
  static const Color primaryLavender = Color(0xFFAD80BF); // Main buttons, active tabs, links
  static const Color secondaryTeal = Color.fromARGB(255, 15, 103, 117);   // Secondary containers, chips
  static const Color accentMustard = Color(0xFFBA8736);   // FAB, "New" badges, highlights

  // --- 2. The Backgrounds ("Tinted Grays") ---
  // A near-black with a hint of purple warmth
  static const Color backgroundDeep = Color(0xFF120E13); 
  // Slightly lighter, used for card backgrounds/lists
  static const Color surface = Color(0xFF1E1B24);        
  // Lighter still, for bottom sheets, nav bars, or inactive buttons
  static const Color elevation = Color(0xFF2D2636);      

  // --- 3. Text Hierarchy (On Dark Backgrounds) ---
  static const Color textHigh = Color(0xFFE6E1E5);       // Headings (Off-white)
  static const Color textMedium = Color(0xFFCAC4D0);     // Body (Light Gray)
  static const Color textDisabled = Color(0xFF49454F);   // Hints/Disabled (Dark Gray)

  // --- 4. Semantic Colors (Functional) ---
  static const Color error = Color(0xFFFFB4AB);          // Soft Red
  static const Color success = Color(0xFFA5D6A7);        // Soft Green
  static const Color warning = Color(0xFFBA8736);        // (Same as Mustard)
  
  // --- 5. Helpers ---
  // A helper to quickly get white text for your Teal containers (since they are dark)
  static const Color textOnSecondary = Colors.white;
  // A helper for icons on dark backgrounds
  static const Color iconDefault = Color(0xFFAD80BF); 
}


--- C:\Code\femn\lib\customization\fonts.dart ---

import 'package:flutter/material.dart';
import 'package:femn/customization/colors.dart'; // <--- IMPORT YOUR COLORS FILE

// Define the font family name (must match pubspec.yaml)
const String _fontFamily = 'Helvetica';

// Create a TextStyle for regular Helvetica
TextStyle helveticaStyle({
  double fontSize = 16.0,
  FontWeight fontWeight = FontWeight.normal,
  Color color = AppColors.textHigh, // Default to Off-White for Dark Mode
}) {
  return TextStyle(
    fontFamily: _fontFamily,
    fontSize: fontSize,
    fontWeight: fontWeight,
    color: color,
  );
}

// Utility functions for very bold text
TextStyle helveticaBoldStyle({
  double fontSize = 16.0,
  Color color = AppColors.textHigh, // Default to Off-White
}) {
  return TextStyle(
    fontFamily: _fontFamily,
    fontSize: fontSize,
    fontWeight: FontWeight.bold,
    color: color,
  );
}

// Optional: You can keep your old names if you prefer
// But now they refer to Helvetica instead of Google Fonts
final primaryFont = _fontFamily; 
final secondaryFont = _fontFamily;

// Keep your utility functions but rename them to reflect Helvetica
TextStyle primaryTextStyle({
  double fontSize = 16.0,
  FontWeight fontWeight = FontWeight.normal,
  Color color = AppColors.textHigh,
}) {
  return helveticaStyle(fontSize: fontSize, fontWeight: fontWeight, color: color);
}

TextStyle secondaryTextStyle({
  double fontSize = 16.0,
  FontWeight fontWeight = FontWeight.normal,
  Color color = AppColors.textHigh,
}) {
  return helveticaStyle(fontSize: fontSize, fontWeight: fontWeight, color: color);
}

// Very bold versions
TextStyle primaryVeryBoldTextStyle({
  double fontSize = 16.0,
  Color color = AppColors.textHigh,
}) {
  return helveticaBoldStyle(fontSize: fontSize, color: color);
}

TextStyle secondaryVeryBoldTextStyle({
  double fontSize = 16.0,
  Color color = AppColors.textHigh,
}) {
  return helveticaBoldStyle(fontSize: fontSize, color: color);
}


--- C:\Code\femn\lib\customization\layout.dart ---

import 'package:flutter/material.dart';
import 'package:shimmer/shimmer.dart';
import 'package:flutter_staggered_grid_view/flutter_staggered_grid_view.dart';
import 'colors.dart';

class ResponsiveLayout {
  /// Returns the number of columns for staggered grids based on screen width.
  /// 
  /// - Mobile (< 800): 2 (Unified baseline)
  /// - Tablet/Larger (> 800): 3
  /// - Desktop/Even Larger (> 1200): 4
  static int getColumnCount(BuildContext context) {
    double width = MediaQuery.of(context).size.width;
    if (width > 1200) {
      return 4;
    } else if (width > 800) {
      return 3;
    } else {
      // 2 is better for staggered mobile grids generally, 
      // but some screens had 3. To follow "Uniformity", 
      // we'll use 2 as the mobile baseline unless the USER prefers otherwise.
      // However, the USER's prompt says "larger screens should be 3, even larger 4".
      // This strongly suggests that 2 is the non-larger (standard) size.
      return 2;
    }
  }
}

class GridShimmerSkeleton extends StatelessWidget {
  final int itemCount;
  final double horizontalPadding;
  final double verticalPadding;

  const GridShimmerSkeleton({
    Key? key,
    this.itemCount = 8,
    this.horizontalPadding = 16.0,
    this.verticalPadding = 10.0,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding, vertical: verticalPadding),
      child: MasonryGridView.count(
        crossAxisCount: ResponsiveLayout.getColumnCount(context),
        mainAxisSpacing: 12,
        crossAxisSpacing: 12,
        itemCount: itemCount,
        shrinkWrap: true,
        physics: const NeverScrollableScrollPhysics(),
        itemBuilder: (context, index) {
          return ShimmerItem(index: index);
        },
      ),
    );
  }
}

class SliverGridShimmerSkeleton extends StatelessWidget {
  final int itemCount;
  final double horizontalPadding;
  final double verticalPadding;

  const SliverGridShimmerSkeleton({
    Key? key,
    this.itemCount = 8,
    this.horizontalPadding = 16.0,
    this.verticalPadding = 10.0,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return SliverPadding(
      padding: EdgeInsets.symmetric(horizontal: horizontalPadding, vertical: verticalPadding),
      sliver: SliverMasonryGrid.count(
        crossAxisCount: ResponsiveLayout.getColumnCount(context),
        mainAxisSpacing: 12,
        crossAxisSpacing: 12,
        childCount: itemCount,
        itemBuilder: (context, index) {
          return ShimmerItem(index: index);
        },
      ),
    );
  }
}

class ShimmerItem extends StatelessWidget {
  final int index;
  const ShimmerItem({Key? key, required this.index}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final List<double> randomHeights = [200, 280, 180, 240, 300, 190, 250, 220];

    return Shimmer.fromColors(
      baseColor: AppColors.elevation,
      highlightColor: AppColors.surface,
      child: Container(
        height: randomHeights[index % randomHeights.length],
        decoration: BoxDecoration(
          color: AppColors.elevation,
          borderRadius: BorderRadius.circular(20),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Expanded(
              child: Container(
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(20),
                ),
              ),
            ),
            Padding(
              padding: const EdgeInsets.all(8.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Container(height: 10, width: 80, color: Colors.white),
                  const SizedBox(height: 6),
                  Container(height: 8, width: double.infinity, color: Colors.white),
                ],
              ),
            )
          ],
        ),
      ),
    );
  }
}




--- C:\Code\femn\lib\customization\theme_manager.dart ---

import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'colors.dart';
import '../customization/fonts.dart';

enum FemnThemeMode {
  midnightActivist, // Dark (Default)
  clarifiedDay,     // Light
  sageWellness,     // Nature
  highImpact,       // Contrast
}

class ThemeManager extends ChangeNotifier {
  static const String _themePrefKey = 'selected_theme';
  static const String _matchSystemKey = 'match_system';

  FemnThemeMode _currentMode = FemnThemeMode.midnightActivist;
  bool _matchSystem = false; // Default to manual control initially as per request logic, can be changed.

  FemnThemeMode get currentMode => _currentMode;
  bool get matchSystem => _matchSystem;

  ThemeManager() {
    _loadPreferences();
  }

  Future<void> _loadPreferences() async {
    final prefs = await SharedPreferences.getInstance();
    _matchSystem = prefs.getBool(_matchSystemKey) ?? true; // Default true as per user request
    if (!_matchSystem) {
      final int? themeIndex = prefs.getInt(_themePrefKey);
      if (themeIndex != null && themeIndex >= 0 && themeIndex < FemnThemeMode.values.length) {
        _currentMode = FemnThemeMode.values[themeIndex];
      }
    }
    notifyListeners();
  }

  Future<void> setMatchSystem(bool value) async {
    _matchSystem = value;
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_matchSystemKey, value);
    notifyListeners();
  }

  Future<void> setTheme(FemnThemeMode mode) async {
    if (_matchSystem) {
      // If we pick a theme manually, we likely want to turn off system sync?
      // Or we just update the preference for when efficient.
      // User request: "Option A (Best): No "Save" button. Tapping the theme applies it immediately"
      // Let's disable Match System if they manually pick a theme.
      await setMatchSystem(false);
    }
    _currentMode = mode;
    final prefs = await SharedPreferences.getInstance();
    await prefs.setInt(_themePrefKey, mode.index);
    notifyListeners();
  }

  // --- Theme Generators ---

  ThemeData getThemeData(FemnThemeMode mode, {bool systemDarkMode = true}) {
    // If matching system, override mode based on system brightness
    FemnThemeMode effectiveMode = mode;
    if (_matchSystem) {
       effectiveMode = systemDarkMode ? FemnThemeMode.midnightActivist : FemnThemeMode.clarifiedDay;
    }

    switch (effectiveMode) {
      case FemnThemeMode.clarifiedDay:
        return _buildClarifiedDay();
      case FemnThemeMode.sageWellness:
        return _buildSageWellness();
      case FemnThemeMode.highImpact:
        return _buildHighImpact();
      case FemnThemeMode.midnightActivist:
      default:
        return _buildMidnightActivist();
    }
  }
  
  // 1. Midnight Activist (Original Dark)
  ThemeData _buildMidnightActivist() {
    const colors = FemnColors(
      backgroundDeep: Color(0xFF120E13),
      surface: Color(0xFF1E1B24),
      elevation: Color(0xFF2D2636),
      primaryLavender: Color(0xFFAD80BF),
      secondaryTeal: Color.fromARGB(255, 15, 103, 117),
      accentMustard: Color(0xFFBA8736),
      textHigh: Color(0xFFE6E1E5),
      textMedium: Color(0xFFCAC4D0),
      textDisabled: Color(0xFF49454F),
      error: Color(0xFFFFB4AB),
      success: Color(0xFFA5D6A7),
      iconDefault: Color(0xFFAD80BF),
      textOnSecondary: Colors.white,
    );

    return _buildThemeFromColors(colors, Brightness.dark);
  }

  // 2. Clarified Day (Light Mode)
  ThemeData _buildClarifiedDay() {
    const colors = FemnColors(
      backgroundDeep: Color(0xFFF9F9F9), // Soft Off-White
      surface: Color(0xFFFFFFFF),        // Pure White Cards
      elevation: Color(0xFFECECEC),      // Slight grey for bounds
      primaryLavender: Color(0xFF8D5E9F), // Darker Lavender for contrast on white
      secondaryTeal: Color(0xFF0F6775),
      accentMustard: Color(0xFFBA8736),
      textHigh: Color(0xFF1C1B1F),       // Dark Gunmetal (Main Text)
      textMedium: Color(0xFF48464C),     // Dark Grey
      textDisabled: Color(0xFF939094),
      error: Color(0xFFB3261E),          // Standard Red for Light
      success: Color(0xFF2E7D32),        // Darker Green
      iconDefault: Color(0xFF8D5E9F),
      textOnSecondary: Colors.white,
    );
     return _buildThemeFromColors(colors, Brightness.light);
  }

  // 3. Sage & Wellness (Forest Green / Nature)
  ThemeData _buildSageWellness() {
    const colors = FemnColors(
      backgroundDeep: Color(0xFF0F1510), // Very dark forest green
      surface: Color(0xFF1A241C),        // Lighter green surface
      elevation: Color(0xFF253328),
      primaryLavender: Color.fromARGB(255, 15, 103, 117), // Using Teal as primary for nature
      secondaryTeal: Color(0xFFAD80BF),  // Lavender becomes secondary
      accentMustard: Color(0xFFE8D3B9),  // Beige accent
      textHigh: Color(0xFFEFEFEF),
      textMedium: Color(0xFFC8CEC9),
      textDisabled: Color(0xFF5C635D),
      error: Color(0xFFFFB4AB),
      success: Color(0xFFA5D6A7),
      iconDefault: Color.fromARGB(255, 15, 103, 117),
      textOnSecondary: Colors.white,
    );
    return _buildThemeFromColors(colors, Brightness.dark);
  }

  // 4. High Impact (OLED Black)
  ThemeData _buildHighImpact() {
    const colors = FemnColors(
      backgroundDeep: Color(0xFF000000), // True Black
      surface: Color(0xFF121212),
      elevation: Color(0xFF2C2C2C),
      primaryLavender: Color(0xFFBA8736), // Mustard Primary (High Vis)
      secondaryTeal: Colors.tealAccent,
      accentMustard: Colors.yellowAccent,
      textHigh: Color(0xFFFFFFFF),       // Pure White
      textMedium: Color(0xFFE0E0E0),
      textDisabled: Color(0xFF808080),
      error: Color(0xFFFF5252),
      success: Color(0xFF69F0AE),
      iconDefault: Color(0xFFBA8736),
      textOnSecondary: Colors.black,
    );
    return _buildThemeFromColors(colors, Brightness.dark);
  }

  ThemeData _buildThemeFromColors(FemnColors colors, Brightness brightness) {
    return ThemeData(
      brightness: brightness,
      primaryColor: colors.primaryLavender,
      scaffoldBackgroundColor: colors.backgroundDeep,
      
      // Extensions!
      extensions: [colors],
      
      colorScheme: ColorScheme(
        brightness: brightness,
        primary: colors.primaryLavender,
        onPrimary: brightness == Brightness.dark ? colors.backgroundDeep : Colors.white,
        secondary: colors.secondaryTeal,
        onSecondary: colors.textOnSecondary,
        surface: colors.surface,
        onSurface: colors.textHigh,
        error: colors.error,
        onError: Colors.white,
      ),

      // Component Themes using our colors
      appBarTheme: AppBarTheme(
        backgroundColor: colors.backgroundDeep,
        elevation: 0,
        iconTheme: IconThemeData(color: colors.primaryLavender),
        titleTextStyle: TextStyle(
          color: colors.textHigh,
          fontSize: 20,
          fontWeight: FontWeight.bold,
        ),
      ),
      
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          backgroundColor: colors.primaryLavender,
          foregroundColor: brightness == Brightness.dark ? colors.backgroundDeep : Colors.white,
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
          padding: EdgeInsets.symmetric(vertical: 14, horizontal: 20),
        ),
      ),

      cardTheme: CardThemeData(
        color: colors.surface,
        elevation: 2,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      ),
      
      bottomSheetTheme: BottomSheetThemeData(
        backgroundColor: colors.surface,
        modalBackgroundColor: colors.surface,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.vertical(top: Radius.circular(20))),
      ),

      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: colors.elevation,
        hintStyle: TextStyle(color: colors.textDisabled),
        labelStyle: TextStyle(color: colors.textMedium),
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide.none,
        ),
        enabledBorder: OutlineInputBorder(
           borderRadius: BorderRadius.circular(14),
           borderSide: BorderSide.none,
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide(color: colors.primaryLavender, width: 1.5),
        ),
      ),
      
      iconTheme: IconThemeData(color: colors.iconDefault),
      
      textTheme: TextTheme(
        bodyLarge: primaryTextStyle(fontSize: 18.0, color: colors.textHigh),
        bodyMedium: primaryTextStyle(fontSize: 16.0, color: colors.textMedium),
        displayLarge: primaryVeryBoldTextStyle(fontSize: 32.0, color: colors.textHigh),
        displayMedium: primaryVeryBoldTextStyle(fontSize: 28.0, color: colors.textHigh),
        displaySmall: primaryVeryBoldTextStyle(fontSize: 24.0, color: colors.textHigh),
        headlineMedium: primaryVeryBoldTextStyle(fontSize: 20.0, color: colors.textHigh),
        headlineSmall: primaryVeryBoldTextStyle(fontSize: 18.0, color: colors.textHigh),
        titleLarge: primaryVeryBoldTextStyle(fontSize: 16.0, color: colors.textHigh),
        titleMedium: secondaryTextStyle(fontSize: 16.0, fontWeight: FontWeight.bold, color: colors.textHigh),
        titleSmall: secondaryTextStyle(fontSize: 14.0, fontWeight: FontWeight.bold, color: colors.textHigh),
        bodySmall: secondaryTextStyle(fontSize: 12.0, color: colors.textMedium),
        labelLarge: secondaryVeryBoldTextStyle(fontSize: 16.0, color: colors.textHigh),
        labelSmall: secondaryTextStyle(fontSize: 10.0, color: colors.textMedium),
      ),
    );
  }
}


--- C:\Code\femn\lib\feed\addpost.dart ---

import 'dart:async';
import 'dart:io';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:femn/app.dart' hide ProfileScreen;
import 'package:femn/customization/colors.dart';
import 'package:femn/hub_screens/profile.dart';
import 'package:femn/services/custom_camera_screen.dart';
import 'package:femn/services/custom_gallery_screen.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:flutter/material.dart';
import 'package:uuid/uuid.dart';
import 'package:femn/services/embers_service.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:video_player/video_player.dart';
import 'package:video_thumbnail/video_thumbnail.dart';
import 'package:path_provider/path_provider.dart';
import 'package:femn/feed/feed_service.dart';
import 'package:femn/feed/upload_service.dart';

class AddPostScreen extends StatefulWidget {
  @override
  _AddPostScreenState createState() => _AddPostScreenState();
}

class _AddPostScreenState extends State<AddPostScreen> {
  // Split Controllers for UI
  final TextEditingController _titleController = TextEditingController();
  final TextEditingController _bodyController = TextEditingController(); // Replaces old _captionController for logic
  final TextEditingController _linkController = TextEditingController();
  
  final FocusNode _bodyFocusNode = FocusNode();
  
  File? _mediaFile;
  String _mediaType = 'image'; 
  bool _isUploading = false;
  
  VideoPlayerController? _videoController; 

  // Tagging / Mentions Logic variables
  List<DocumentSnapshot> _userSuggestions = [];
  bool _showSuggestions = false;
  String _currentTagQuery = "";
  Timer? _debounceTimer;

  // Constraints
  final int _maxFileSize = 15 * 1024 * 1024 * 1024; // 15 GB

  // Whitelist Data
  final List<String> _allowedDomains = [
    'globalfundforwomen.org', 'urgentactionfund.org', 'mamacash.org', 'awdf.org',
    'wphfund.org', 'feministcoalition2020.com', 'awid.org', 'equalitynow.org',
    'womankind.org.uk', 'riseuptogether.org', 'gofundme.com', 'kickstarter.com',
    'indiegogo.com', 'justgiving.com', 'ketto.org', 'milaap.org', 'unwomen.org',
    'ohchr.org', 'amnesty.org', 'hrw.org', 'unicef.org', 'genderdata.worldbank.org',
    'oecd.org', 'data2x.org', 'eff.org', 'frontlinedefenders.org', 'accessnow.org',
    'tacticaltech.org', 'who.int', 'ippf.org', 'msf.org', 'reproductiverights.org',
    'change.org', 'thepetitionsite.com', 'avaaz.org', 'ipetitions.com', 'coworker.org',
    'moveon.org', 'civist.eu', 'petition.parliament.uk', 'whitehouse.gov',
    'petiport.europarl.europa.eu', 'facebook.com', 'youtube.com', 'instagram.com',
    'whatsapp.com', 'tiktok.com', 'wechat.com', 'telegram.org', 'messenger.com',
    'snapchat.com', 'reddit.com'
  ];

  @override
  void initState() {
    super.initState();
    // Attach tagging listener to the BODY controller
    _bodyController.addListener(_onCaptionChanged);
  }

  @override
  void dispose() {
    _bodyController.removeListener(_onCaptionChanged);
    _titleController.dispose();
    _bodyController.dispose();
    _linkController.dispose();
    _bodyFocusNode.dispose();
    _debounceTimer?.cancel();
    _videoController?.dispose(); 
    super.dispose();
  }

  // --- Tagging Logic (Applied to Body) ---

  void _onCaptionChanged() {
    String text = _bodyController.text;
    TextSelection selection = _bodyController.selection;
    
    if (selection.baseOffset < 0) return;

    String textBeforeCursor = text.substring(0, selection.baseOffset);
    int atIndex = textBeforeCursor.lastIndexOf('@');

    if (atIndex != -1) {
      bool isValidStart = atIndex == 0 || textBeforeCursor[atIndex - 1] == ' ';
      
      if (isValidStart) {
        String query = textBeforeCursor.substring(atIndex + 1);
        if (!query.contains(' ')) {
          _currentTagQuery = query;
          _onTagQueryChanged(query);
          return;
        }
      }
    }

    if (_showSuggestions) {
      setState(() {
        _showSuggestions = false;
      });
    }
  }

  void _onTagQueryChanged(String query) {
    if (_debounceTimer?.isActive ?? false) _debounceTimer!.cancel();
    _debounceTimer = Timer(const Duration(milliseconds: 300), () {
      _searchUsersForTag(query);
    });
  }

  Future<void> _searchUsersForTag(String query) async {
    if (query.isEmpty) {
      setState(() => _showSuggestions = false);
      return;
    }

    try {
      final currentUserId = FirebaseAuth.instance.currentUser!.uid;
      
      QuerySnapshot snapshot = await FirebaseFirestore.instance
          .collection('users')
          .where('username', isGreaterThanOrEqualTo: query)
          .where('username', isLessThan: query + 'z')
          .limit(10)
          .get();

      List<DocumentSnapshot> docs = snapshot.docs;

      DocumentSnapshot currentUserDoc = await FirebaseFirestore.instance
          .collection('users')
          .doc(currentUserId)
          .get();
          
      List<String> following = List<String>.from(currentUserDoc['following'] ?? []);

      docs.sort((a, b) {
        String idA = a.id;
        String idB = b.id;
        bool followsA = following.contains(idA);
        bool followsB = following.contains(idB);

        if (followsA && !followsB) return -1;
        if (!followsA && followsB) return 1;
        return 0;
      });

      setState(() {
        _userSuggestions = docs;
        _showSuggestions = docs.isNotEmpty;
      });

    } catch (e) {
      print("Error searching users: $e");
    }
  }

  void _addTagToCaption(String username) {
    String text = _bodyController.text;
    TextSelection selection = _bodyController.selection;
    String textBeforeCursor = text.substring(0, selection.baseOffset);
    int atIndex = textBeforeCursor.lastIndexOf('@');

    if (atIndex != -1) {
      String newText = text.replaceRange(atIndex + 1, selection.baseOffset, "$username ");
      _bodyController.text = newText;
      _bodyController.selection = TextSelection.fromPosition(
        TextPosition(offset: atIndex + 1 + username.length + 1)
      );
    }
    
    setState(() {
      _showSuggestions = false;
    });
  }

  // --- Navigation & File Handling ---

  Future<void> _openCustomGallery() async {
    final File? result = await Navigator.push(
      context,
      MaterialPageRoute(builder: (context) => CustomGalleryScreen()),
    );
    if (result != null) _processSelectedFile(result);
  }

  Future<void> _openCustomCamera() async {
    final File? result = await Navigator.push(
      context,
      MaterialPageRoute(builder: (context) => CustomCameraScreen()),
    );
    if (result != null) _processSelectedFile(result);
  }

  void _processSelectedFile(File file) async {
    String type = _getFileType(file.path);
    int sizeInBytes = await file.length();
    if (sizeInBytes > _maxFileSize) {
      _showError('File is too large. Max size is 15GB.');
      return;
    }

    if (type == 'video') {
      _videoController?.dispose(); 
      _videoController = VideoPlayerController.file(file)
        ..initialize().then((_) {
          setState(() {}); 
          _videoController!.setLooping(true);
          _videoController!.play();
        });
    }

    setState(() {
      _mediaFile = file;
      _mediaType = type;
    });
  }

  String _getFileType(String path) {
    String ext = path.split('.').last.toLowerCase();
    List<String> videoExtensions = [
      'mp4', 'mov', 'avi', 'mkv', 'wmv', 'flv', 'webm', 'm4v', '3gp', 'mts'
    ];
    if (videoExtensions.contains(ext)) return 'video';
    return 'image';
  }

  void _showError(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message, style: TextStyle(color: AppColors.backgroundDeep)),
        backgroundColor: AppColors.error,
      ),
    );
  }

  // --- Link Validation ---
  bool _validateLink(String url) {
    if (url.isEmpty) return true; // Empty is valid (no link)
    Uri? uri = Uri.tryParse(url);
    if (uri == null || !uri.hasScheme) {
      // Try adding https if missing
      uri = Uri.tryParse("https://$url");
    }
    
    if (uri == null || uri.host.isEmpty) return false;

    // Check if host ends with any allowed domain
    // e.g., "m.facebook.com" ends with "facebook.com"
    return _allowedDomains.any((domain) => uri!.host.endsWith(domain));
  }

  void _showWhitelistDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: AppColors.surface,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        title: Text("Allowed Websites", style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)),
        content: Container(
          width: double.maxFinite,
          height: 300,
          child: Scrollbar(
            thumbVisibility: true,
            child: ListView.builder(
              itemCount: _allowedDomains.length,
              itemBuilder: (context, index) {
                return ListTile(
                  dense: true,
                  leading: Icon(Feather.check_circle, color: AppColors.primaryLavender, size: 16),
                  title: Text(_allowedDomains[index], style: TextStyle(color: AppColors.textMedium)),
                );
              },
            ),
          ),
        ),
        actions: [
          TextButton(
            child: Text("Close", style: TextStyle(color: AppColors.primaryLavender)),
            onPressed: () => Navigator.pop(context),
          )
        ],
      ),
    );
  }

  // --- Upload Logic ---

  void _uploadPost() {
    if (_mediaFile == null) return;
    
    // 1. Validation Logic
    if (!_mediaFile!.existsSync()) {
       _showError('File error. Please select again.');
       return;
    }

    String link = _linkController.text.trim();
    if (link.isNotEmpty) {
      if (!_validateLink(link)) {
        _showError('Link not allowed. Tap the info icon to see approved sites.');
        return;
      }
      // Ensure scheme
      if (!link.startsWith('http')) {
        link = 'https://$link';
      }
    }

    // Combine Title and Body for the final caption logic
    String title = _titleController.text.trim();
    String body = _bodyController.text.trim();
    String finalCaption = "";
    
    if (title.isNotEmpty && body.isNotEmpty) {
      finalCaption = "$title\n\n$body";
    } else if (title.isNotEmpty) {
      finalCaption = title;
    } else {
      finalCaption = body;
    }

    // 2. Hand off to Service
    PostUploadService.instance.startUpload(
      file: _mediaFile!,
      caption: finalCaption,
      mediaType: _mediaType,
      context: context,
      linkUrl: link.isNotEmpty ? link : null,
    );

    // 3. Immediate Exit
    Navigator.of(context).pop(); 
  }

  // --- Widgets ---

  Widget _buildSuggestionsList() {
    if (!_showSuggestions) return SizedBox.shrink();

    return Container(
      constraints: BoxConstraints(maxHeight: 200),
      margin: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      decoration: BoxDecoration(
        color: AppColors.surface,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(color: Colors.black26, blurRadius: 10, offset: Offset(0, 4))
        ],
        border: Border.all(color: AppColors.elevation)
      ),
      child: ListView.builder(
        shrinkWrap: true,
        physics: ClampingScrollPhysics(),
        padding: EdgeInsets.zero,
        itemCount: _userSuggestions.length,
        itemBuilder: (context, index) {
          final user = _userSuggestions[index].data() as Map<String, dynamic>;
          final String username = user['username'] ?? 'User';
          final String profileImage = user['profileImage'] ?? '';
          final String fullName = user['fullName'] ?? '';

          return ListTile(
            leading: CircleAvatar(
              backgroundColor: AppColors.elevation,
              backgroundImage: profileImage.isNotEmpty 
                ? CachedNetworkImageProvider(profileImage) 
                : AssetImage('assets/default_avatar.png') as ImageProvider,
              radius: 16,
            ),
            title: Text(username, style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)),
            subtitle: Text(fullName, style: TextStyle(color: AppColors.textMedium, fontSize: 12)),
            dense: true,
            onTap: () => _addTagToCaption(username),
          );
        },
      ),
    );
  }

  Widget _buildSplitCircleButton() {
    double size = 200.0;
    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        Text(
          "Create Post",
          style: TextStyle(
            color: AppColors.textHigh,
            fontSize: 24,
            fontWeight: FontWeight.bold,
            letterSpacing: 1.2
          ),
        ),
        SizedBox(height: 30),
        Container(
          width: size,
          height: size,
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            boxShadow: [
              BoxShadow(
                color: Colors.black26,
                blurRadius: 10,
                offset: Offset(0, 5),
              )
            ],
          ),
          child: ClipOval(
            child: Row(
              children: [
                Expanded(
                  child: Material(
                    color: AppColors.primaryLavender,
                    child: InkWell(
                      onTap: _openCustomGallery, 
                      child: Container(
                        height: double.infinity,
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(Feather.upload_cloud, color: AppColors.backgroundDeep, size: 32),
                            SizedBox(height: 8),
                            Text(
                              "Upload",
                              style: TextStyle(
                                color: AppColors.backgroundDeep,
                                fontWeight: FontWeight.bold,
                                fontSize: 16
                              ),
                            )
                          ],
                        ),
                      ),
                    ),
                  ),
                ),
                Expanded(
                  child: Material(
                    color: AppColors.elevation, 
                    child: InkWell(
                      onTap: _openCustomCamera,
                      child: Container(
                        height: double.infinity,
                        decoration: BoxDecoration(
                          border: Border(
                            left: BorderSide(color: AppColors.backgroundDeep, width: 1)
                          )
                        ),
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(Feather.camera, color: AppColors.primaryLavender, size: 32),
                            SizedBox(height: 8),
                            Text(
                              "Capture",
                              style: TextStyle(
                                color: AppColors.primaryLavender,
                                fontWeight: FontWeight.bold,
                                fontSize: 16
                              ),
                            )
                          ],
                        ),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
        SizedBox(height: 20),
        Text(
          "Photos  Videos  GIFs",
          style: TextStyle(color: AppColors.textDisabled, fontSize: 12),
        )
      ],
    );
  }

  Widget _buildUploadProgress() {
    return Positioned.fill(
      child: Container(
        color: Colors.black54,
        child: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              CircularProgressIndicator(valueColor: AlwaysStoppedAnimation<Color>(AppColors.primaryLavender)),
              SizedBox(height: 16),
              Text(
                'Uploading...',
                style: TextStyle(color: AppColors.textHigh, fontSize: 16),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildMediaPreview() {
    return ConstrainedBox(
      constraints: BoxConstraints(
        maxHeight: MediaQuery.of(context).size.height * 0.4, // Reduced height to fit fields
        minHeight: 200,
        maxWidth: MediaQuery.of(context).size.width,
      ),
      child: Container(
        margin: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
        decoration: BoxDecoration(
          color: Colors.black,
          borderRadius: BorderRadius.circular(16),
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(16),
          child: _mediaType == 'video'
              ? _videoController != null && _videoController!.value.isInitialized
                  ? AspectRatio(
                      aspectRatio: _videoController!.value.aspectRatio,
                      child: VideoPlayer(_videoController!),
                    )
                  : Center(child: CircularProgressIndicator(color: AppColors.primaryLavender))
              : Image.file(
                  _mediaFile!,
                  fit: BoxFit.contain,
                ),
        ),
      ),
    );
  }

  Widget _buildEnhancedInputFields() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
      child: Column(
        children: [
          // 1. Unified Caption Box (Title + Divider + Body)
          Container(
            decoration: BoxDecoration(
              color: AppColors.elevation,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: AppColors.elevation)
            ),
            child: Column(
              children: [
                // TITLE INPUT
                TextField(
                  controller: _titleController,
                  maxLength: 90,
                  style: TextStyle(color: AppColors.textHigh, fontSize: 16, fontWeight: FontWeight.bold),
                  decoration: InputDecoration(
                    hintText: 'Title',
                    hintStyle: TextStyle(color: AppColors.textDisabled, fontWeight: FontWeight.bold),
                    contentPadding: EdgeInsets.fromLTRB(16, 12, 16, 8),
                    border: InputBorder.none,
                    counterText: "", // Hide character count visually
                  ),
                ),
                
                // THIN ALMOST INVISIBLE SEPARATOR
                Divider(height: 1, thickness: 1, color: AppColors.textDisabled.withOpacity(0.1)),
                
                // BODY INPUT
                TextField(
                  controller: _bodyController,
                  focusNode: _bodyFocusNode,
                  style: TextStyle(color: AppColors.textHigh, fontSize: 16),
                  minLines: 3,
                  maxLines: null,
                  maxLength: 4000,
                  decoration: InputDecoration(
                    hintText: 'Type @ to tag friends or # for tags...',
                    hintStyle: TextStyle(color: AppColors.textDisabled),
                    contentPadding: EdgeInsets.all(16),
                    border: InputBorder.none,
                    counterText: "",
                  ),
                ),
              ],
            ),
          ),
          
          SizedBox(height: 12),

          // 2. Link Input Field
          Container(
             decoration: BoxDecoration(
              color: AppColors.elevation,
              borderRadius: BorderRadius.circular(12),
            ),
            child: Row(
              children: [
                Expanded(
                  child: TextField(
                    controller: _linkController,
                    style: TextStyle(color: AppColors.secondaryTeal, fontSize: 14),
                    decoration: InputDecoration(
                      hintText: 'Add a link (e.g. gofundme.com/...)',
                      hintStyle: TextStyle(color: AppColors.textDisabled),
                      prefixIcon: Icon(Feather.link, color: AppColors.textDisabled, size: 18),
                      border: InputBorder.none,
                      contentPadding: EdgeInsets.symmetric(horizontal: 16, vertical: 14),
                    ),
                  ),
                ),
                IconButton(
                  icon: Icon(Feather.info, color: AppColors.primaryLavender, size: 18),
                  tooltip: 'Allowed Websites',
                  onPressed: _showWhitelistDialog,
                )
              ],
            ),
          ),
          
          Padding(
            padding: const EdgeInsets.only(top: 8.0, left: 4.0),
            child: Align(
              alignment: Alignment.centerLeft,
              child: Text(
                "Note: Only links from verified organizations are allowed.",
                style: TextStyle(color: AppColors.textDisabled, fontSize: 10, fontStyle: FontStyle.italic),
              ),
            ),
          )
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundDeep,
        elevation: 0,
        leading: IconButton(
          icon: Icon(Feather.arrow_left, color: AppColors.primaryLavender),
          onPressed: () {
            if (_mediaFile != null) {
              setState(() {
                _mediaFile = null;
                _showSuggestions = false;
                _videoController?.dispose();
                _videoController = null;
                // Clear fields
                _titleController.clear();
                _bodyController.clear();
                _linkController.clear();
              });
            } else {
              Navigator.of(context).pop();
            }
          },
        ),
        title: _mediaFile != null 
          ? Text(
              'New Post',
              style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold),
            )
          : null,
        actions: [
          if (_mediaFile != null)
            Padding(
              padding: const EdgeInsets.only(right: 8.0),
              child: IconButton(
                icon: Icon(Feather.check, color: AppColors.primaryLavender),
                onPressed: _isUploading ? null : _uploadPost,
              ),
            ),
        ],
      ),
      body: Stack(
        children: [
          SingleChildScrollView(
            child: Column(
              children: [
                if (_mediaFile != null) ...[
                  _buildMediaPreview(),
                  _buildEnhancedInputFields(), // Replaces simple caption field
                  
                  // Suggestions placed in flow
                  _buildSuggestionsList(),

                  SizedBox(height: 100), 
                ] else
                  Container(
                    height: MediaQuery.of(context).size.height * 0.8,
                    child: Center(
                      child: _buildSplitCircleButton(),
                    ),
                  ),
              ],
            ),
          ),
          if (_isUploading) _buildUploadProgress(),
        ],
      ),
    );
  }
}


--- C:\Code\femn\lib\feed\feed_service.dart ---

import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_vertexai/firebase_vertexai.dart' as vai;
import 'dart:math';
import 'dart:convert';
import 'dart:io';
import 'dart:typed_data';
import 'package:femn/feed/personalized_feed_service.dart';

class FeedService {
  final FirebaseFirestore _db = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final PersonalizedFeedService _personalizedFeed = PersonalizedFeedService();

  // --- 1. THE "SENSES": MULTIMODAL AI ANALYSIS ---
  Future<Map<String, dynamic>> analyzeContent({
    required String caption,
    required String mediaType,
    File? file,
  }) async {
    print(" ALGORITHM [Input]: Analyzing content...");

    try {
      // Using the latest model for 2026
      final model = vai.FirebaseVertexAI.instance.generativeModel(
        model: 'gemini-2.5-flash', 
        generationConfig: vai.GenerationConfig(
          responseMimeType: 'application/json',
          temperature: 0.4, // Lower temperature for more factual/strict responses
        ),
      );

      List<vai.Part> parts = [];
      
      // --- THE SUPER PROMPT ---
      final promptText = '''
      You are the safety and recommendation engine for 'Femn'. 
      
      INPUT: A ${mediaType == 'video' ? 'video thumbnail' : 'photo'} and caption: "$caption".

      PHASE 1: STRICT SAFETY CHECK
      Analyze the image and caption for the following prohibited categories:
      1. Dangerous Acts: Challenges, self-harm, eating disorders.
      2. Sexual Content: Nudity (genitalia/nipples), sexually suggestive poses, pornographic intent.
      3. Violence/Gore: Open wounds, torture, extreme blood, dead bodies.
      4. Illegal: Drugs, weapons, criminal instructions.
      5. Hate/Harassment: Slurs, targeted abuse, symbols of hate groups.
      
      If ANY of these are found, set "isSafe" to false and stop analysis.

      PHASE 2: DEEP CULTURAL & VISUAL IDENTIFICATION
      If safe, identify the content with high specificity:
      1. ENTITIES: Name specific characters (e.g., "Kris", "Anubis"), franchises (e.g., "Deltarune", "Undertale"), or celebrities.
      2. CONTEXT: Identify the era (e.g., "Ancient Egypt"), genre (e.g., "Indie RPG"), or activity.
      3. AESTHETICS: Identify the art style (e.g., "Pixel Art", "Oil Painting") and specific Color Palette names (e.g., "Sepia", "Neon Cyberpunk").

      PHASE 3: SMART TAGGING (Generate exactly 15 tags)
      Combine:
      - Specific Tags: (e.g., "Deltarune", "Toby Fox", "Susie")
      - Niche Tags: (e.g., "Cozy Gaming", "Dark Academia", "Witchy Vibes")
      - Visual Tags: (e.g., "Silhouette", "Warm Tones")

      RETURN JSON STRUCTURE:
      {
        "isSafe": boolean,
        "moderationReason": "Reason if unsafe, otherwise null",
        "category": "String (One of: Feminism, Gaming, Art, History, Wellness, Politics, Tech, Lifestyle)",
        "tags": ["tag1", "tag2", ...],
        "visualDescription": "Detailed summary",
        "qualityScore": Integer (1-10)
      }
      ''';
      
      parts.add(vai.TextPart(promptText));

      if (file != null && await file.exists()) {
        final bytes = await file.readAsBytes();
        String mimeType = file.path.endsWith('.png') ? 'image/png' : 'image/jpeg';
        parts.add(vai.InlineDataPart(mimeType, Uint8List.fromList(bytes)));
      }

      final contentResponse = await model.generateContent([vai.Content.multi(parts)]);
      
      // Default Safety Fallback
      bool isSafe = false; 
      String moderationReason = "AI Analysis Failed";
      String category = 'General';
      List<String> tags = [];
      String visualDesc = "";
      int qualityScore = 0;

      if (contentResponse.text != null) {
        try {
          final cleanedText = contentResponse.text!.replaceAll('```json', '').replaceAll('```', '');
          final data = jsonDecode(cleanedText);
          
          isSafe = data['isSafe'] ?? false;
          moderationReason = data['moderationReason'] ?? "Unknown Safety Risk";
          
          if (isSafe) {
            category = data['category'] ?? 'General';
            tags = List<String>.from(data['tags'] ?? []);
            visualDesc = data['visualDescription'] ?? "";
            qualityScore = data['qualityScore'] ?? 5;
            
            print(" ALGORITHM [Identity]: Identified: $tags");
          } else {
            print(" ALGORITHM [Blocked]: Content flagged as unsafe: $moderationReason");
          }

        } catch (e) {
          print(" ALGORITHM [Error]: JSON Parsing failed. Defaulting to unsafe for security.");
        }
      }

      return {
        'isSafe': isSafe,
        'moderationReason': moderationReason,
        'category': category,
        'tags': tags,
        'embedding': List.filled(768, 0.0), // Placeholder until embedding is fixed
        'visualDescription': visualDesc,
        'qualityScore': qualityScore,
      };

    } catch (e) {
      print(" ALGORITHM [Critical Fail]: $e");
      return {
        'isSafe': false,
        'moderationReason': "System Error",
      };
    }
  }

  // --- 3. SMART FEED GENERATION (Unchanged from working version) ---
  Future<List<DocumentSnapshot>> getSmartFeed() async {
    try {
      return await _personalizedFeed.getPersonalizedFeed(limit: 20);
    } catch (e) {
      print('Error getting personalized feed: $e');
      // Fallback to recent posts
      final safetyQuery = await _db.collection('posts')
          .orderBy('timestamp', descending: true)
          .limit(20)
          .get();
      return safetyQuery.docs;
    }
  }
  
  Future<List<DocumentSnapshot>> getPaginatedFeed(DocumentSnapshot lastDocument) async {
    try {
      return await _personalizedFeed.getPersonalizedFeed(
        limit: 10,
        lastDocument: lastDocument,
      );
    } catch (e) {
      print('Error getting paginated personalized feed: $e');
      return [];
    }
  }
  
  // Add this method for "See More" functionality
  Future<List<DocumentSnapshot>> getPostsForTag(String tag) async {
    try {
      final query = await _db.collection('posts')
          .where('smartTags', arrayContains: tag)
          .where('timestamp', isGreaterThan: DateTime.now().subtract(Duration(days: 60)))
          .orderBy('timestamp', descending: true)
          .limit(20)
          .get();
      return query.docs;
    } catch (e) {
      return [];
    }
  }
}


--- C:\Code\femn\lib\feed\personalized_feed_service.dart ---

import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'dart:math';

class PersonalizedFeedService {
  final FirebaseFirestore _db = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  
  // Weights for different interaction types
  static const Map<String, double> _signalWeights = {
    'like': 2.0,
    'save': 3.0,
    'share': 4.0,
    'download': 3.5,
    'see_more': 1.5,
    'see_less': -3.0,
    'report': -10.0,
    'comment': 2.5,
    'watch_time': 0.1,
  };
  
  static const double _decayFactor = 0.98;

  // In-memory cache for user profile
  Map<String, dynamic>? _cachedUserProfile;
  DateTime? _profileCacheTime;
  static const Duration _cacheDuration = Duration(minutes: 5);
  
  Future<List<DocumentSnapshot>> getPersonalizedFeed({
    int limit = 20,
    DocumentSnapshot? lastDocument,
  }) async {
    final userId = _auth.currentUser?.uid;
    if (userId == null) return [];
    
    try {
      // 1. Get user's interaction history (Cached)
      if (_cachedUserProfile == null || 
          _profileCacheTime == null || 
          DateTime.now().difference(_profileCacheTime!) > _cacheDuration) {
        _cachedUserProfile = await _buildUserInterestProfile(userId);
        _profileCacheTime = DateTime.now();
      }
      
      final userProfile = _cachedUserProfile!;
      
      // 2. Fetch User Data needed for scoring (Following list)
      // We can also cache this briefly or fetch it once per session if needed, 
      // but one read here is fine compared to N reads later.
      final userDoc = await _db.collection('users').doc(userId).get();
      final following = List<String>.from(userDoc.data()?['following'] ?? []);
      
      // 3. Get candidate posts
      Query query = _db.collection('posts')
        .where('timestamp', isGreaterThan: DateTime.now().subtract(Duration(days: 30)))
        .orderBy('timestamp', descending: true);
        
      if (lastDocument != null) {
        query = query.startAfterDocument(lastDocument);
      }
      
      // Fetch more candidates than needed to allow for ranking
      final snapshot = await query.limit(limit * 3).get();
      
      if (snapshot.docs.isEmpty) return [];
      
      // 4. Score and rank synchronously
      List<Map<String, dynamic>> scoredPosts = [];
      
      for (final postDoc in snapshot.docs) {
        final postData = postDoc.data() as Map<String, dynamic>;
        
        // Calculate score heavily relies on CPU now, avoiding awaits
        final score = _calculatePostScoreSync(
          postDoc: postDoc,
          postData: postData,
          userProfile: userProfile,
          userId: userId,
          following: following,
        );
        
        scoredPosts.add({
          'post': postDoc,
          'score': score,
        });
      }
      
      // 5. Sort by score
      scoredPosts.sort((a, b) => b['score'].compareTo(a['score']));
      
      // 6. Apply diversity/variety logic
      final diversifiedPosts = _addVariety(scoredPosts);
      
      return diversifiedPosts.take(limit).map((item) => item['post'] as DocumentSnapshot).toList();
      
    } catch (e) {
      print('Error in personalized feed: $e');
      // Fallback
      final fallback = await _db.collection('posts')
        .orderBy('timestamp', descending: true)
        .limit(limit)
        .get();
      return fallback.docs;
    }
  }
  
  Future<Map<String, dynamic>> _buildUserInterestProfile(String userId) async {
    final tagWeights = <String, double>{};
    final categoryWeights = <String, double>{};
    final authorWeights = <String, double>{};
    final interactPostIds = <String>{}; // Cache of posts user interacted with
    
    int interactionCount = 0;
    double avgWatchTime = 0.0;
    
    try {
      final now = DateTime.now();
      final signalsSnapshot = await _db.collection('users')
        .doc(userId)
        .collection('signals')
        .where('timestamp', isGreaterThan: now.subtract(Duration(days: 90)))
        .orderBy('timestamp', descending: true)
        .limit(500) // Reduced limit for performance, 500 signals is plenty
        .get();
      
      double totalWatchTime = 0;
      int watchCount = 0;

      // Optimization: Batch fetch related posts
      // We only need details for posts to get tags/categories. 
      // 1. Collect unique Post IDs from signals that have positive weight logic
      final postIdsToFetch = <String>{};
      
      for (final doc in signalsSnapshot.docs) {
        final data = doc.data();
        postIdsToFetch.add(data['postId']);
        
        // Also track all interacted IDs for the 'already viewed' check
        interactPostIds.add(data['postId']);
      }
      
      // 2. Fetch post details in batches
      // Firestore 'whereIn' supports only 10 items. Parallel HTTP requests are better for larger sets.
      // We will limit to fetching details for the most recent 50 distinct posts to keep it fast.
      // Older interactions still count for frequency but maybe we don't need their tags as urgently.
      final topRecentPostIds = postIdsToFetch.take(50).toList();
      
      final List<DocumentSnapshot> postDocs = await Future.wait(
        topRecentPostIds.map((id) => _db.collection('posts').doc(id).get())
      );
      
      // Map for quick lookup
      final postMap = {for (var doc in postDocs) doc.id: doc};

      // 3. Process signals
      for (final signalDoc in signalsSnapshot.docs) {
        final signal = signalDoc.data();
        final postId = signal['postId'];
        final signalTime = (signal['timestamp'] as Timestamp).toDate();
        final daysAgo = now.difference(signalTime).inDays;
        
        final timeWeight = pow(_decayFactor, daysAgo).toDouble();
        final baseWeight = _signalWeights[signal['type']] ?? 1.0;
        final finalWeight = baseWeight * timeWeight;
        
        // Only process content-based weights if we fetched the post
        final postDoc = postMap[postId];
        if (postDoc != null && postDoc.exists) {
          final postData = postDoc.data() as Map<String, dynamic>;
          
          final tags = List<String>.from(postData['smartTags'] ?? []);
          for (final tag in tags) {
            tagWeights[tag] = (tagWeights[tag] ?? 0) + finalWeight;
          }
          
          final category = postData['category'] ?? 'General';
          categoryWeights[category] = (categoryWeights[category] ?? 0) + finalWeight;
          
          if (finalWeight > 0) {
            final authorId = postData['userId'];
            authorWeights[authorId] = (authorWeights[authorId] ?? 0) + finalWeight;
          }
        }
        
        if (signal['type'] == 'watch_time') {
          totalWatchTime += signal['value'] ?? 0;
          watchCount++;
        }
      }
      
      interactionCount = signalsSnapshot.docs.length;
      avgWatchTime = watchCount > 0 ? totalWatchTime / watchCount : 0;
      
      _normalizeWeights(tagWeights);
      _normalizeWeights(categoryWeights);
      _normalizeWeights(authorWeights);
      
    } catch (e) {
      print('Error building user profile: $e');
    }
    
    return {
      'tagWeights': tagWeights,
      'categoryWeights': categoryWeights,
      'authorWeights': authorWeights,
      'interactedPostIds': interactPostIds, // Important for scoring
      'interactionCount': interactionCount,
      'avgWatchTime': avgWatchTime,
    };
  }

  // Synchronous scoring function
  double _calculatePostScoreSync({
    required DocumentSnapshot postDoc,
    required Map<String, dynamic> postData,
    required Map<String, dynamic> userProfile,
    required String userId,
    required List<String> following,
  }) {
    double score = 0;
    
    // 1. Check if user already interacted (Negative if disliked, or just filter out if viewed?)
    // In naive implementation we might filter out ALL 'view' posts, but maybe user wants to see them again?
    // Let's just check for negative signals or 'seen_less'.
    // NOTE: This check is simplified. We assume if it's in 'interactedPostIds', 
    // it *might* have been acted upon.
    // For exact negative filtering, we'd need to store *types* of interaction in the set or map.
    // As a tradeoff, we won't strictly filter -100 here unless we stored that info.
    // BUT we can check author blocks etc.
    // For now, let's just use the profile content matching which is the heavy part.
    
    final previouslyInteracted = (userProfile['interactedPostIds'] as Set<String>).contains(postDoc.id);
    // Optional: Boost unseen posts, punish seen ones slightly? 
    if (previouslyInteracted) score -= 5.0; 
    
    // 2. Content-based scoring
    final tags = List<String>.from(postData['smartTags'] ?? []);
    final tagWeights = userProfile['tagWeights'] as Map<String, double>;
    for (final tag in tags) {
      score += tagWeights[tag] ?? 0;
    }
    
    // 3. Category match
    final category = postData['category'] ?? 'General';
    final catWeights = userProfile['categoryWeights'] as Map<String, double>;
    score += (catWeights[category] ?? 0) * 2;
    
    // 4. Author relationship
    final authorId = postData['userId'];
    if (authorId != userId) {
      if (following.contains(authorId)) {
        score += 10;
      } else {
        final authWeights = userProfile['authorWeights'] as Map<String, double>;
        score += authWeights[authorId] ?? 0;
      }
    }
    
    // 5. Quality score
    score += (postData['qualityScore'] ?? 5).toDouble() * 0.5;
    
    // 6. Recency boost
    final postTime = postData['timestamp'].toDate();
    final hoursAgo = DateTime.now().difference(postTime).inHours;
    final recencyBoost = max(0, 24 - hoursAgo) * 0.1;
    score += recencyBoost;
    
    // 7. Engagement
    final likes = List<String>.from(postData['likes'] ?? []);
    final comments = postData['comments'] ?? 0;
    final engagement = (likes.length * 0.5) + (comments * 0.3);
    score += engagement * 0.2;
    
    return score;
  }
  
  List<Map<String, dynamic>> _addVariety(List<Map<String, dynamic>> scoredPosts) {
    if (scoredPosts.length < 5) return scoredPosts;
    
    final diversified = <Map<String, dynamic>>[];
    final categoriesSeen = <String>{};
    
    // Take top 20%
    final topCount = (scoredPosts.length * 0.2).ceil();
    for (int i = 0; i < topCount && i < scoredPosts.length; i++) {
      diversified.add(scoredPosts[i]);
      final postData = scoredPosts[i]['post'].data() as Map<String, dynamic>;
      categoriesSeen.add(postData['category'] ?? 'General');
    }
    
    // Add variety
    for (int i = topCount; i < scoredPosts.length; i++) {
      final postData = scoredPosts[i]['post'].data() as Map<String, dynamic>;
      final category = postData['category'] ?? 'General';
      
      if (diversified.length % 3 == 0 && !categoriesSeen.contains(category)) {
        diversified.add(scoredPosts[i]);
        categoriesSeen.add(category);
      } else if (Random().nextDouble() < 0.3) {
        diversified.add(scoredPosts[i]);
      }
    }
    
    return diversified;
  }
  
  void _normalizeWeights(Map<String, double> weights) {
    if (weights.isEmpty) return;
    final maxWeight = weights.values.reduce(max);
    if (maxWeight > 0) {
      for (final key in weights.keys.toList()) {
        weights[key] = weights[key]! / maxWeight;
      }
    }
  }
  
  Future<void> recordInteraction({
    required String type,
    required String postId,
    String? authorId,
    double? value,
    String? source,
    String collection = 'posts',
  }) async {
    final userId = _auth.currentUser?.uid;
    if (userId == null) return;
    
    // Invalidate profile cache on strong signals if needed, or just let it expire naturally.
    // For 'see_less' or 'report', maybe we want immediate effect?
    // For optimization, we'll let it abide by the 5 min window.
    
    try {
       await _db.collection('users')
        .doc(userId)
        .collection('signals')
        .add({
          'type': type,
          'postId': postId,
          'authorId': authorId,
          'value': value,
          'source': source ?? 'feed',
          'timestamp': FieldValue.serverTimestamp(),
        });

      if (authorId != null && (type == 'view' || type == 'click_link')) {
        String sourceKey = source ?? 'feed';
        _db.collection('users').doc(authorId).update({
          'trafficBreakdown.$sourceKey': FieldValue.increment(1)
        }).onError((_, __) => null);
      }

      final docRef = _db.collection(collection).doc(postId);
      
      if (type == 'view') {
        docRef.update({'views': FieldValue.increment(1)}).onError((_, __) => null);
      } else if (type == 'share') {
        docRef.update({'shares': FieldValue.increment(1)}).onError((_, __) => null);
      } else if (type == 'save') {
        docRef.update({'saves': FieldValue.increment(1)}).onError((_, __) => null);
      } else if (type == 'click_link') {
        docRef.update({'linkClicks': FieldValue.increment(1)}).onError((_, __) => null);
      } else if (type == 'unsave') {
        docRef.update({'saves': FieldValue.increment(-1)}).onError((_, __) => null);
      }
    } catch (e) {
      print('Error recording interaction: $e');
    }
  }

  Future<List<DocumentSnapshot>> getSimilarPosts(String postId, {int limit = 10}) async {
    try {
      final postDoc = await _db.collection('posts').doc(postId).get();
      if (!postDoc.exists) return [];
      
      final postData = postDoc.data() as Map<String, dynamic>;
      final tags = List<String>.from(postData['smartTags'] ?? []);
      
      if (tags.isEmpty) return [];
      
      final similarPosts = <DocumentSnapshot>[];
      final seenIds = <String>{postId};
      
      for (final tag in tags.take(3)) {
        final query = await _db.collection('posts')
          .where('smartTags', arrayContains: tag)
          .where('timestamp', isGreaterThan: DateTime.now().subtract(Duration(days: 60)))
          .orderBy('timestamp', descending: true)
          .limit(5)
          .get();
        
        for (final doc in query.docs) {
          if (!seenIds.contains(doc.id)) {
            similarPosts.add(doc);
            seenIds.add(doc.id);
          }
          if (similarPosts.length >= limit) break;
        }
        if (similarPosts.length >= limit) break;
      }
      return similarPosts;
    } catch (e) {
      print('Error getting similar posts: $e');
      return [];
    }
  }
}


--- C:\Code\femn\lib\feed\upload_service.dart ---

import 'dart:async';
import 'dart:io';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:femn/services/embers_service.dart';
import 'package:femn/feed/feed_service.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:flutter/material.dart';
import 'package:path_provider/path_provider.dart';
import 'package:uuid/uuid.dart';
import 'package:video_thumbnail/video_thumbnail.dart';

enum UploadStatus { idle, uploading, success, error }

class PostUploadService extends ChangeNotifier {
  static final PostUploadService instance = PostUploadService._();
  PostUploadService._();

  UploadStatus status = UploadStatus.idle;
  double progress = 0.0;
  String? errorMessage;
  
  // Data for the "Ghost" post
  File? currentFile;
  File? currentThumbnail;
  String? currentCaption;
  String? currentMediaType;
  String? currentLinkUrl; // ADDED: Store the link URL

  Future<void> startUpload({
    required File file,
    required String caption,
    required String mediaType,
    required BuildContext context, 
    String? linkUrl, // ADDED: Link URL parameter
  }) async {
    // 1. Set State (Triggers Ghost Post)
    status = UploadStatus.uploading;
    progress = 0.05;
    currentFile = file;
    currentCaption = caption;
    currentMediaType = mediaType;
    currentThumbnail = null;
    currentLinkUrl = linkUrl; // Store the link URL
    errorMessage = null;
    notifyListeners(); 

    // --- Generate Thumbnail Immediately for UI ---
    if (mediaType == 'video') {
      try {
        final tempDir = await getTemporaryDirectory();
        final String? thumbPath = await VideoThumbnail.thumbnailFile(
          video: file.path,
          thumbnailPath: tempDir.path,
          imageFormat: ImageFormat.JPEG,
          quality: 50,
        );
        if (thumbPath != null) {
          currentThumbnail = File(thumbPath);
          notifyListeners();
        }
      } catch (e) {
        print("Error generating preview thumbnail: $e");
      }
    }

    String? uploadedStoragePath;
    String mediaId = const Uuid().v4();

    try {
      String currentUserId = FirebaseAuth.instance.currentUser!.uid;
      String ext = file.path.split('.').last;

      // 2. Upload Media
      Reference storageRef = FirebaseStorage.instance
          .ref()
          .child('posts')
          .child(currentUserId)
          .child('$mediaId.$ext');

      UploadTask task = storageRef.putFile(file);

      task.snapshotEvents.listen((TaskSnapshot snapshot) {
        progress = 0.1 + (0.5 * (snapshot.bytesTransferred / snapshot.totalBytes));
        notifyListeners();
      });

      await task;
      String mediaUrl = await storageRef.getDownloadURL();
      uploadedStoragePath = storageRef.fullPath;

      // 3. Upload Thumbnail (Reuse the one we generated if possible)
      String thumbnailUrl = '';
      if (mediaType == 'video') {
        File? thumbToUpload = currentThumbnail; 
        
        if (thumbToUpload == null) {
          final String? thumbPath = await VideoThumbnail.thumbnailFile(
            video: file.path,
            thumbnailPath: (await getTemporaryDirectory()).path,
            imageFormat: ImageFormat.JPEG,
            quality: 75,
          );
          if (thumbPath != null) thumbToUpload = File(thumbPath);
        }

        if (thumbToUpload != null) {
          Reference thumbRef = FirebaseStorage.instance.ref('posts/thumbnails/$mediaId.jpg');
          await thumbRef.putFile(thumbToUpload);
          thumbnailUrl = await thumbRef.getDownloadURL();
        }
      }

      progress = 0.7; 
      notifyListeners();

      // 4. AI Gatekeeper
      final feedService = FeedService();
      
      // Use the thumbnail for AI analysis if video (saves bandwidth)
      File fileToAnalyze = (mediaType == 'video' && currentThumbnail != null) 
          ? currentThumbnail! 
          : file;

      final aiData = await feedService.analyzeContent(
        caption: caption,
        mediaType: mediaType,
        file: fileToAnalyze,
      );

      progress = 0.9; 
      notifyListeners();

      // 5. Security Check
      if (aiData['isSafe'] == false) {
        throw Exception("Safety Block: ${aiData['moderationReason']}");
      }

      // 6. Tags & Mentions
      List<String> hashtags = [];
      RegExp exp = RegExp(r"\B#\w\w+");
      exp.allMatches(caption).forEach((match) {
        hashtags.add(match.group(0)!.substring(1));
      });

      List<String> mentions = [];
      RegExp mentionExp = RegExp(r"\B@\w+");
      mentionExp.allMatches(caption).forEach((match) {
        mentions.add(match.group(0)!.substring(1));
      });

      // 7. Save to Firestore
      DocumentReference postDocRef = await FirebaseFirestore.instance.collection('posts').add({
        'userId': currentUserId,
        'mediaUrl': mediaUrl,
        'thumbnailUrl': thumbnailUrl,
        'caption': caption,
        'likes': [],
        'comments': 0,
        'timestamp': DateTime.now(),
        'mediaType': mediaType,
        'hashtags': hashtags,
        'mentions': mentions,
        'category': aiData['category'],
        'smartTags': aiData['tags'],
        'visualDescription': aiData['visualDescription'],
        'qualityScore': aiData['qualityScore'],
        'embedding': aiData['embedding'],
        'linkUrl': linkUrl, // ADDED: Save link to Firestore
      });

      try {
         await EmbersService.earnForPost(context, postDocRef.id);
      } catch (_) {}

      await FirebaseFirestore.instance
          .collection('users')
          .doc(currentUserId)
          .update({
        'posts': FieldValue.increment(1),
      });

      status = UploadStatus.success;
      progress = 1.0;
      notifyListeners();

      await Future.delayed(Duration(seconds: 2));
      _reset();

    } catch (e) {
      print("Upload Failed: $e");
      if (uploadedStoragePath != null) {
        try {
          await FirebaseStorage.instance.ref(uploadedStoragePath).delete();
        } catch (_) {}
      }
      status = UploadStatus.error;
      errorMessage = e.toString().replaceAll("Exception: ", "");
      notifyListeners();
    }
  }

  void consumeError() {
    _reset();
  }

  void _reset() {
    status = UploadStatus.idle;
    progress = 0.0;
    currentFile = null;
    currentThumbnail = null;
    currentCaption = null;
    currentMediaType = null;
    currentLinkUrl = null; // Reset link URL
    errorMessage = null;
    notifyListeners();
  }
}


--- C:\Code\femn\lib\hub_screens\chatscreen.dart ---

import 'dart:async';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:femn/customization/colors.dart'; // <--- IMPORT YOUR COLORS FILE
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/material.dart';
import 'package:timeago/timeago.dart' as timeago;
import 'package:flutter_vector_icons/flutter_vector_icons.dart';

// --- UPDATED CHAT SCREEN WITH READ RECEIPTS ---
class ChatScreen extends StatefulWidget {
  final String chatId;
  final String otherUserId;
  final String otherUserName;
  final String otherUserProfileImage;

  const ChatScreen({
    required this.chatId,
    required this.otherUserId,
    required this.otherUserName,
    required this.otherUserProfileImage,
    Key? key,
  }) : super(key: key);

  @override
  _ChatScreenState createState() => _ChatScreenState();
}

class _ChatScreenState extends State<ChatScreen> {
  final TextEditingController _messageController = TextEditingController();
  final ScrollController _scrollController = ScrollController();
  late final String currentUserId;
  bool _isMarkingRead = false;

  @override
  void initState() {
    super.initState();
    currentUserId = FirebaseAuth.instance.currentUser!.uid;
  }

  @override
  void dispose() {
    _messageController.dispose();
    _scrollController.dispose();
    super.dispose();
  }

  Future<void> _markMessagesAsRead() async {
    // Prevent concurrent calls
    if (_isMarkingRead) return;
    _isMarkingRead = true;

    try {
      final chatDocRef = FirebaseFirestore.instance.collection('chats').doc(widget.chatId);
      final unreadQuery = await chatDocRef
          .collection('messages')
          .where('senderId', isEqualTo: widget.otherUserId)
          .where('read', isEqualTo: false)
          .get();

      if (unreadQuery.docs.isEmpty) {
        _isMarkingRead = false;
        return;
      }

      final batch = FirebaseFirestore.instance.batch();
      for (var doc in unreadQuery.docs) {
        batch.update(doc.reference, {'read': true});
      }

      // Reset unread count for current user in chat doc; merge so doc can be created/merged safely
      batch.set(chatDocRef, {
        'unreadCount': {currentUserId: 0}
      }, SetOptions(merge: true));

      await batch.commit();
    } catch (e) {
      debugPrint("Error marking messages as read: $e");
    } finally {
      _isMarkingRead = false;
    }
  }

  Future<void> _sendMessage() async {
    final text = _messageController.text.trim();
    if (text.isEmpty) return;

    final chatRef = FirebaseFirestore.instance.collection('chats').doc(widget.chatId);
    final messagesRef = chatRef.collection('messages');

    final messageData = {
      'senderId': currentUserId,
      'text': text,
      'timestamp': FieldValue.serverTimestamp(),
      'read': false,
    };

    try {
      await messagesRef.add(messageData);

      await chatRef.set({
        'lastMessage': text,
        'lastMessageTime': FieldValue.serverTimestamp(),
        'lastMessageSender': currentUserId,
        // increment unread for the other user
        'unreadCount': {widget.otherUserId: FieldValue.increment(1)},
      }, SetOptions(merge: true));

      _messageController.clear();
      _scrollToBottom();
    } catch (e) {
      debugPrint("Error sending message: $e");
    }
  }

  void _scrollToBottom() {
    if (!_scrollController.hasClients) return;
    _scrollController.animateTo(
      _scrollController.position.maxScrollExtent,
      duration: const Duration(milliseconds: 250),
      curve: Curves.easeOut,
    );
  }

  Widget _buildMessageBubble(String text, DateTime timestamp, bool isMe,
      {bool isRead = false, bool isLastMessage = false}) {
    return Align(
      alignment: isMe ? Alignment.centerRight : Alignment.centerLeft,
      child: Container(
        margin: const EdgeInsets.symmetric(vertical: 4, horizontal: 8),
        padding: const EdgeInsets.all(12),
        constraints: BoxConstraints(maxWidth: MediaQuery.of(context).size.width * 0.75),
        decoration: BoxDecoration(
          // Me = Teal (Dark, so white text), Other = Elevation (Dark Gray, so Off-White text)
          color: isMe ? AppColors.secondaryTeal : AppColors.elevation,
          borderRadius: BorderRadius.only(
            topLeft: Radius.circular(16),
            topRight: Radius.circular(16),
            bottomLeft: isMe ? Radius.circular(16) : Radius.zero,
            bottomRight: isMe ? Radius.zero : Radius.circular(16),
          ),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.end,
          children: [
            Text(
              text,
              style: TextStyle(
                // Teal needs white text, Elevation needs textHigh
                color: isMe ? Colors.white : AppColors.textHigh,
              ),
            ),
            const SizedBox(height: 6),
            Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Text(
                  timeago.format(timestamp),
                  style: TextStyle(
                    fontSize: 10,
                    color: isMe ? Colors.white70 : AppColors.textDisabled,
                  ),
                ),
                if (isMe && isLastMessage) const SizedBox(width: 6),
                if (isMe && isLastMessage)
                  Icon(
                    isRead ? Feather.check : Feather.check, // Feather doesn't have double check, using check for both with color difference
                    size: 14,
                    // Blue for read doesn't fit the palette, let's use Success Green or Lavender
                    color: isRead ? AppColors.primaryLavender : Colors.white70,
                  ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildMessageInput() {
    return SafeArea(
      top: false,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 8),
        color: AppColors.surface, // Background for input area
        child: Row(
          children: [
            Expanded(
              child: TextField(
                controller: _messageController,
                textInputAction: TextInputAction.send,
                onSubmitted: (_) => _sendMessage(),
                style: TextStyle(color: AppColors.textHigh),
                decoration: InputDecoration(
                  hintText: 'Type a message...',
                  hintStyle: TextStyle(color: AppColors.textDisabled),
                  filled: true,
                  fillColor: AppColors.elevation,
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(24),
                    borderSide: BorderSide.none,
                  ),
                  contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                ),
              ),
            ),
            const SizedBox(width: 8),
            CircleAvatar(
              backgroundColor: AppColors.primaryLavender,
              child: IconButton(
                icon: Icon(Feather.send, color: AppColors.backgroundDeep),
                onPressed: _sendMessage,
              ),
            ),
          ],
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final chatMessagesStream = FirebaseFirestore.instance
        .collection('chats')
        .doc(widget.chatId)
        .collection('messages')
        .orderBy('timestamp', descending: false)
        .snapshots();

    return Scaffold(
      backgroundColor: Colors.transparent, // Deep background
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
        title: Row(
          children: [
            CircleAvatar(
              backgroundColor: AppColors.elevation,
              backgroundImage: widget.otherUserProfileImage.isNotEmpty
                  ? CachedNetworkImageProvider(widget.otherUserProfileImage)
                  : const AssetImage('assets/default_avatar.png') as ImageProvider,
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    widget.otherUserName,
                    overflow: TextOverflow.ellipsis,
                    style: TextStyle(fontSize: 16, color: AppColors.textHigh),
                  ),
                  StreamBuilder<DocumentSnapshot>(
                    stream: FirebaseFirestore.instance.collection('users').doc(widget.otherUserId).snapshots(),
                    builder: (context, snapshot) {
                      if (snapshot.hasData && snapshot.data!.exists) {
                        final map = snapshot.data!.data() as Map<String, dynamic>?;
                        final bool isOnline = (map?['isOnline'] ?? false) as bool;
                        return Text(
                          isOnline ? 'Online' : 'Offline',
                          style: TextStyle(
                            fontSize: 12, 
                            color: isOnline ? AppColors.success : AppColors.textDisabled
                          ),
                        );
                      } else {
                        return Text(
                          'Offline',
                          style: TextStyle(fontSize: 12, color: AppColors.textDisabled),
                        );
                      }
                    },
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
      body: Column(
        children: [
          Expanded(
            child: StreamBuilder<QuerySnapshot>(
              stream: chatMessagesStream,
              builder: (context, snapshot) {
                if (snapshot.hasError) {
                  return Center(child: Text('Error: ${snapshot.error}', style: TextStyle(color: AppColors.error)));
                }
                if (!snapshot.hasData) {
                  return Center(child: CircularProgressIndicator(color: AppColors.primaryLavender));
                }

                final docs = snapshot.data!.docs;

                // Check for unread messages logic remains same...
                int unreadFromOther = 0;
                for (var doc in docs) {
                  final data = doc.data() as Map<String, dynamic>?;
                  if (data == null) continue;
                  if (data['senderId'] == widget.otherUserId && (data['read'] ?? true) == false) {
                    unreadFromOther++;
                  }
                }
                if (unreadFromOther > 0) {
                  WidgetsBinding.instance.addPostFrameCallback((_) {
                    _markMessagesAsRead();
                  });
                }

                WidgetsBinding.instance.addPostFrameCallback((_) => _scrollToBottom());

                return ListView.builder(
                  controller: _scrollController,
                  itemCount: docs.length,
                  padding: EdgeInsets.symmetric(vertical: 16),
                  itemBuilder: (context, index) {
                    final doc = docs[index];
                    final data = doc.data() as Map<String, dynamic>? ?? {};
                    final text = data['text'] as String? ?? '';
                    final ts = data['timestamp'];
                    final timestamp = ts is Timestamp ? ts.toDate() : DateTime.now();
                    final senderId = data['senderId'] as String? ?? '';
                    final isMe = senderId == currentUserId;
                    final isRead = data['read'] as bool? ?? false;
                    final isLastMessage = index == docs.length - 1;

                    return _buildMessageBubble(
                      text,
                      timestamp,
                      isMe,
                      isRead: isRead,
                      isLastMessage: isMe && isLastMessage,
                    );
                  },
                );
              },
            ),
          ),
          _buildMessageInput(),
        ],
      ),
    );
  }
}

// New Chat Screen
class NewChatScreen extends StatefulWidget {
  @override
  _NewChatScreenState createState() => _NewChatScreenState();
}

class _NewChatScreenState extends State<NewChatScreen> {
  final TextEditingController _searchController = TextEditingController();
  List<DocumentSnapshot> _searchResults = [];

  void _searchUsers(String query) async {
    if (query.isEmpty) {
      setState(() {
        _searchResults = [];
      });
      return;
    }
    final result = await FirebaseFirestore.instance
        .collection('users')
        .where('username', isGreaterThanOrEqualTo: query)
        .where('username', isLessThan: query + 'z')
        .get();
    setState(() {
      _searchResults = result.docs
          .where((doc) => doc['uid'] != FirebaseAuth.instance.currentUser!.uid)
          .toList();
    });
  }

 void _startChat(String otherUserId, String otherUserName,
      String otherUserProfileImage) async {
    final currentUserId = FirebaseAuth.instance.currentUser!.uid;
    // Check if chat already exists
    final existingChat = await FirebaseFirestore.instance
        .collection('chats')
        .where('participants', arrayContains: currentUserId)
        .get();
    // Find existing chat with the other user
    QueryDocumentSnapshot<Map<String, dynamic>>? existingChatDoc;
    for (var doc in existingChat.docs) {
      if (List.from(doc['participants']).contains(otherUserId)) {
        existingChatDoc = doc;
        break;
      }
    }
    String chatId;
    if (existingChatDoc != null) {
      chatId = existingChatDoc.id;
    } else {
     final newChat = await FirebaseFirestore.instance.collection('chats').add({
       'participants': [currentUserId, otherUserId],
       'lastMessage': '',
       'lastMessageTime': FieldValue.serverTimestamp(),
       'createdAt': FieldValue.serverTimestamp(),
       'unreadCount': {
          currentUserId: 0, 
          otherUserId: 0,   
        }
     });
     chatId = newChat.id;
    }
    Navigator.pop(context);
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => ChatScreen(
          chatId: chatId,
          otherUserId: otherUserId,
          otherUserName: otherUserName,
          otherUserProfileImage: otherUserProfileImage,
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: Text('New Message', style: TextStyle(color: AppColors.textHigh)),
        backgroundColor: Colors.transparent,
        iconTheme: IconThemeData(color: AppColors.primaryLavender),
      ),
      body: Column(
        children: [
          Padding(
            padding: const EdgeInsets.all(8.0),
            child: TextField(
              controller: _searchController,
              style: TextStyle(color: AppColors.textHigh),
              decoration: InputDecoration(
                hintText: 'Search users...',
                hintStyle: TextStyle(color: AppColors.textDisabled),
                prefixIcon: Icon(Feather.search, color: AppColors.primaryLavender),
                filled: true,
                fillColor: AppColors.elevation,
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide.none,
                ),
              ),
              onChanged: _searchUsers,
            ),
          ),
          Expanded(
            child: ListView.builder(
              itemCount: _searchResults.length,
              itemBuilder: (context, index) {
                var user = _searchResults[index];
                return ListTile(
                  leading: CircleAvatar(
                    backgroundColor: AppColors.elevation,
                    backgroundImage: user['profileImage'].isNotEmpty
                        ? CachedNetworkImageProvider(user['profileImage'])
                        : AssetImage('assets/default_avatar.png') as ImageProvider,
                  ),
                  title: Text(user['username'], style: TextStyle(color: AppColors.textHigh)),
                  subtitle: Text(user['fullName'], style: TextStyle(color: AppColors.textMedium)),
                  onTap: () => _startChat(
                    user['uid'],
                    user['username'],
                    user['profileImage'],
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}


--- C:\Code\femn\lib\hub_screens\messaging.dart ---

import 'dart:async';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/material.dart';
import 'package:timeago/timeago.dart' as timeago;
import 'package:flutter_vector_icons/flutter_vector_icons.dart';

// Internal App Imports
import 'package:femn/hub_screens/chatscreen.dart';
import 'package:femn/hub_screens/story.dart';
import 'package:femn/customization/colors.dart';
import 'package:femn/hub_screens/profile.dart';
import 'package:femn/hub_screens/notifications.dart';

// Assuming NewChatScreen is imported or defined in your project structure

class MessagingScreen extends StatefulWidget {
  @override
  _MessagingScreenState createState() => _MessagingScreenState();
}

class _MessagingScreenState extends State<MessagingScreen> {
  final currentUserId = FirebaseAuth.instance.currentUser!.uid;

  // --- Selection & Action State ---
  bool _isSelectionMode = false;
  Set<String> _selectedChatIds = {};

  // --- Actions ---

  Future<void> _togglePinChat(String chatId, bool currentPinned) async {
    final chatDoc = await FirebaseFirestore.instance
        .collection('chats')
        .doc(chatId)
        .get();
    final pinnedMap = Map<String, dynamic>.from(
      chatDoc.data()?['pinned'] ?? {},
    );

    if (!currentPinned) {
      // Check limit of 3
      int myPinnedCount = 0;
      // We can't easily check global count without query,
      // but for now let's just check the ones we loaded or do a small query.
      // Better: Just check the map in the doc? No, that's this chat.
      // Let's do a query for my pinned chats.
      final myPinnedQuery = await FirebaseFirestore.instance
          .collection('chats')
          .where('participants', arrayContains: currentUserId)
          .where('pinned.$currentUserId', isEqualTo: true)
          .get();

      if (myPinnedQuery.docs.length >= 3) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("You can only pin up to 3 chats.")),
        );
        return;
      }
    }

    pinnedMap[currentUserId] = !currentPinned;
    await FirebaseFirestore.instance.collection('chats').doc(chatId).update({
      'pinned': pinnedMap,
      'pinnedAt.$currentUserId': Timestamp.now(),
    });
  }

  Future<void> _toggleArchiveChat(String chatId, bool currentArchived) async {
    // Check if therapy chat (Restriction)
    final chatDoc = await FirebaseFirestore.instance
        .collection('chats')
        .doc(chatId)
        .get();
    if (chatDoc.data()?['type'] == 'therapy') {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text("Therapy chats cannot be archived.")),
      );
      return;
    }

    final archivedMap = Map<String, dynamic>.from(
      chatDoc.data()?['archived'] ?? {},
    );
    archivedMap[currentUserId] = !currentArchived;
    await FirebaseFirestore.instance.collection('chats').doc(chatId).update({
      'archived': archivedMap,
    });
  }

  Future<void> _deleteChat(String chatId) async {
    // Check if therapy chat
    final chatDoc = await FirebaseFirestore.instance
        .collection('chats')
        .doc(chatId)
        .get();
    if (chatDoc.data()?['type'] == 'therapy') {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text("Therapy chats cannot be deleted.")),
      );
      return;
    }

    // Soft delete for this user: set deletedAt
    final deletedAtMap = Map<String, dynamic>.from(
      chatDoc.data()?['deletedAt'] ?? {},
    );
    deletedAtMap[currentUserId] = Timestamp.now();

    await FirebaseFirestore.instance.collection('chats').doc(chatId).update({
      'deletedAt': deletedAtMap,
    });
  }

  Future<void> _muteChat(String chatId) async {
    // Simple toggle for now, or 8 hours default
    // In real app, show dialog for duration.
    final chatDoc = await FirebaseFirestore.instance
        .collection('chats')
        .doc(chatId)
        .get();
    final mutedMap = Map<String, dynamic>.from(
      chatDoc.data()?['mutedUntil'] ?? {},
    );

    // Toggle: if muted, unmute. If not, mute for 8 hours.
    final currentMute = mutedMap[currentUserId] as Timestamp?;
    final isMuted =
        currentMute != null && currentMute.toDate().isAfter(DateTime.now());

    if (isMuted) {
      mutedMap.remove(currentUserId);
    } else {
      mutedMap[currentUserId] = Timestamp.fromDate(
        DateTime.now().add(Duration(hours: 8)),
      );
    }

    await FirebaseFirestore.instance.collection('chats').doc(chatId).update({
      'mutedUntil': mutedMap,
    });
  }

  Future<void> _markReadUnread(String chatId, bool markAsRead) async {
    // This affects the "dot".
    // We already have unreadCount logic.
    // "Mark as Unread" usually just adds a dot locally or sets unreadCount to 1 if 0.
    // "Mark as Read" sets unreadCount to 0.

    // For manual "Mark as Unread", let's use a separate flag 'markedUnread' or just manipulate unreadCount.
    // Manipulating unreadCount is cleaner for existing logic.

    if (markAsRead) {
      await FirebaseFirestore.instance.collection('chats').doc(chatId).update({
        'unreadCount.$currentUserId': 0,
      });
    } else {
      await FirebaseFirestore.instance.collection('chats').doc(chatId).update({
        'unreadCount.$currentUserId': 1, // Artificial unread
      });
    }
  }

  Future<void> _lockChat(String chatId) async {
    final chatDoc = await FirebaseFirestore.instance
        .collection('chats')
        .doc(chatId)
        .get();
    final lockedMap = Map<String, dynamic>.from(
      chatDoc.data()?['locked'] ?? {},
    );

    final isLocked = lockedMap[currentUserId] == true;
    lockedMap[currentUserId] = !isLocked;

    await FirebaseFirestore.instance.collection('chats').doc(chatId).update({
      'locked': lockedMap,
    });
  }

  // --- Bulk Actions ---
  void _performBulkAction(String action) async {
    for (String chatId in _selectedChatIds) {
      switch (action) {
        case 'pin':
          await _togglePinChat(chatId, false);
          break;
        case 'archive':
          await _toggleArchiveChat(chatId, false); // Archive it
          break;
        case 'delete':
          await _deleteChat(chatId);
          break;
        case 'mute':
          await _muteChat(chatId);
          break;
        case 'read':
          await _markReadUnread(chatId, true);
          break;
        case 'unread':
          await _markReadUnread(chatId, false);
          break;
        case 'lock':
          await _lockChat(chatId);
          break;
      }
    }

    setState(() {
      _isSelectionMode = false;
      _selectedChatIds.clear();
    });
  }

  @override
  @override
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent, // Deep background
      appBar: _isSelectionMode ? _buildSelectionAppBar() : _buildNormalAppBar(),

      body: Column(
        children: [
          // Stories header row (Hide in selection mode? Optional. Let's keep it.)
           _buildStoriesHeader(),
           const SizedBox(height: 12),

          // Subtle divider
           Container(
              height: 1,
              color: AppColors.elevation, // Dark divider
              margin: const EdgeInsets.symmetric(horizontal: 16),
            ),

          // Messages list
          Expanded(child: _buildMessagesList()),
        ],
      ),
    );
  }

  PreferredSizeWidget _buildSelectionAppBar() {
    return AppBar(
      backgroundColor: AppColors.surface,
      leading: IconButton(
        icon: Icon(Icons.close, color: AppColors.textHigh),
        onPressed: () {
          setState(() {
            _isSelectionMode = false;
            _selectedChatIds.clear();
          });
        },
      ),
      title: Text(
        '${_selectedChatIds.length} Selected',
        style: TextStyle(color: AppColors.textHigh),
      ),
      actions: [
        IconButton(
          icon: Icon(Icons.push_pin_outlined, color: AppColors.textHigh),
          onPressed: () => _performBulkAction('pin'),
          tooltip: 'Pin',
        ),
        IconButton(
          icon: Icon(Feather.archive, color: AppColors.textHigh),
          onPressed: () => _performBulkAction('archive'),
        ),
        IconButton(
          icon: Icon(Feather.trash_2, color: AppColors.error),
          onPressed: () => _performBulkAction('delete'),
        ),
        PopupMenuButton<String>(
          icon: Icon(Icons.more_vert, color: AppColors.textHigh),
          onSelected: (value) => _performBulkAction(value),
          itemBuilder: (context) => [
            PopupMenuItem(value: 'lock', child: Text('Lock Chat')),
            PopupMenuItem(value: 'mute', child: Text('Mute/Unmute')),
            PopupMenuItem(value: 'read', child: Text('Mark as Read')),
            PopupMenuItem(value: 'unread', child: Text('Mark as Unread')),
          ],
        ),
      ],
    );
  }

  PreferredSizeWidget _buildNormalAppBar() {
      return AppBar(
        // ... (existing params)
      backgroundColor: Colors.transparent,
      elevation: 0,
      shadowColor: Colors.transparent,
      automaticallyImplyLeading: false,
      title: Row(
        children: [
          // FEMN Logo
          Container(
            width: 42,
            height: 42,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              color: AppColors.elevation, // Dark container
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.2),
                  blurRadius: 6,
                  offset: const Offset(0, 2),
                ),
              ],
            ),
            child: ClipOval(
              child: Image.asset(
                'assets/default_avatar.png',
                fit: BoxFit.cover,
              ),
            ),
          ),
          const SizedBox(width: 8),
          // Screen Title
          Text(
            'Inbox',
            style: TextStyle(
              fontWeight: FontWeight.bold,
              color: AppColors.textHigh,
            ),
          ),
        ],
      ),
      // AppBar actions
      actions: [
        // Camera Button
        Container(
          width: 42,
          height: 42,
          margin: const EdgeInsets.symmetric(horizontal: 4),
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            color: AppColors.elevation,
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.2),
                blurRadius: 6,
                offset: const Offset(0, 2),
              ),
            ],
          ),
          child: IconButton(
            icon: const Icon(
              Feather.camera,
              color: AppColors.primaryLavender,
              size: 22,
            ),
            onPressed: () => _showStoryCreationModal(context),
          ),
        ),
        const SizedBox(width: 8),

        // New Chat Button
        Container(
          width: 42,
          height: 42,
          margin: const EdgeInsets.symmetric(horizontal: 4),
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            color: AppColors.elevation,
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.2),
                blurRadius: 6,
                offset: const Offset(0, 2),
              ),
            ],
          ),
          child: IconButton(
            icon: const Icon(
              Feather.message_circle,
              color: AppColors.primaryLavender,
              size: 22,
            ),
            onPressed: () {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (context) => NewChatScreen()),
              );
            },
          ),
        ),
        const SizedBox(width: 8),

        // User Profile
        FutureBuilder<DocumentSnapshot>(
          future: FirebaseFirestore.instance
              .collection('users')
              .doc(currentUserId)
              .get(),
          builder: (context, snapshot) {
            Widget avatar;
            if (snapshot.connectionState == ConnectionState.waiting ||
                !snapshot.hasData ||
                !snapshot.data!.exists) {
              avatar = Image.asset(
                'assets/default_avatar.png',
                fit: BoxFit.cover,
              );
            } else {
              final user = snapshot.data!;
              final profileImage = user['profileImage'] ?? '';
              avatar = profileImage.isNotEmpty
                  ? Image(
                      image: CachedNetworkImageProvider(profileImage),
                      fit: BoxFit.cover,
                    )
                  : Image.asset('assets/default_avatar.png', fit: BoxFit.cover);
            }

            return GestureDetector(
              onTap: () => _showProfileMenu(context),
              child: Container(
                width: 42,
                height: 42,
                margin: const EdgeInsets.symmetric(horizontal: 4),
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  color: AppColors.elevation,
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.2),
                      blurRadius: 6,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: ClipOval(child: avatar),
              ),
            );
          },
        ),
        const SizedBox(width: 12),
      ],
    );
  }

  void _showProfileMenu(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) =>
            ProfileScreen(userId: FirebaseAuth.instance.currentUser!.uid),
      ),
    );
  }

  Widget _buildStoriesHeader() {
    return SizedBox(
      height: 100,
      child: FutureBuilder<List<String>>(
        future: _getFollowedUserIds(),
        builder: (context, followedUsersSnapshot) {
          if (!followedUsersSnapshot.hasData) {
            return Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryLavender,
              ),
            );
          }

          final followedUserIds = followedUsersSnapshot.data!;

          return StreamBuilder<QuerySnapshot>(
            stream: FirebaseFirestore.instance
                .collection('stories')
                .where('userId', whereIn: followedUserIds)
                .where('expiresAt', isGreaterThan: DateTime.now())
                .orderBy('timestamp', descending: true)
                .snapshots(),
            builder: (context, snapshot) {
              if (!snapshot.hasData) {
                return Center(
                  child: CircularProgressIndicator(
                    color: AppColors.primaryLavender,
                  ),
                );
              }

              // Group stories by user
              final Map<String, DocumentSnapshot> userStories = {};
              for (var doc in snapshot.data!.docs) {
                final userId = doc['userId'];
                if (!userStories.containsKey(userId)) {
                  userStories[userId] = doc;
                }
              }

              return ListView.builder(
                scrollDirection: Axis.horizontal,
                itemCount: userStories.length + 1, // +1 for "Add Story" button
                itemBuilder: (context, index) {
                  if (index == 0) {
                    return _buildAddStoryButton(context);
                  }

                  final userId = userStories.keys.elementAt(index - 1);
                  final story = userStories[userId]!;
                  final isSeen = List.from(
                    story['viewers'],
                  ).contains(currentUserId);

                  return FutureBuilder<DocumentSnapshot>(
                    future: FirebaseFirestore.instance
                        .collection('users')
                        .doc(userId)
                        .get(),
                    builder: (context, userSnapshot) {
                      if (!userSnapshot.hasData) {
                        return SizedBox.shrink();
                      }

                      final user = userSnapshot.data!;
                      return _buildStoryCircle(
                        user['username'],
                        user['profileImage'],
                        isSeen: isSeen,
                        onTap: () => _viewStory(
                          userId,
                          user['username'],
                          user['profileImage'],
                        ),
                      );
                    },
                  );
                },
              );
            },
          );
        },
      ),
    );
  }

  Widget _buildAddStoryButton(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.all(8),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          GestureDetector(
            onTap: () => _showStoryCreationModal(context),
            child: Container(
              width: 64,
              height: 64,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                color: AppColors.elevation, // Dark circle
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.2),
                    blurRadius: 15,
                    offset: const Offset(0, 2),
                  ),
                ],
              ),
              child: const Center(
                child: Icon(
                  Feather.plus,
                  size: 30,
                  color: AppColors.primaryLavender,
                ),
              ),
            ),
          ),
          const SizedBox(height: 4),
          const Text(
            'You',
            style: TextStyle(
              fontSize: 12,
              fontWeight: FontWeight.w500,
              color: AppColors.primaryLavender,
            ),
            overflow: TextOverflow.ellipsis,
          ),
        ],
      ),
    );
  }

  Widget _buildStoryCircle(
    String username,
    String profileImage, {
    bool isSeen = false,
    VoidCallback? onTap,
  }) {
    return Padding(
      padding: const EdgeInsets.all(8),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          GestureDetector(
            onTap: onTap,
            child: Container(
              width: 64,
              height: 64,
              padding: EdgeInsets.all(2), // Padding for the ring
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                border: Border.all(
                  // Teal for unseen, Disabled for seen
                  color: isSeen
                      ? AppColors.textDisabled
                      : AppColors.secondaryTeal,
                  width: 2,
                ),
              ),
              child: Container(
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  color: AppColors.elevation, // Background behind image
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.2),
                      blurRadius: 15,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: Padding(
                  padding: const EdgeInsets.all(2),
                  child: CircleAvatar(
                    radius: 30,
                    backgroundImage: profileImage.isNotEmpty
                        ? CachedNetworkImageProvider(profileImage)
                        : const AssetImage('assets/default_avatar.png')
                              as ImageProvider,
                  ),
                ),
              ),
            ),
          ),
          const SizedBox(height: 4),
          SizedBox(
            width: 64,
            child: Text(
              username,
              textAlign: TextAlign.center,
              style: const TextStyle(
                fontSize: 12,
                fontWeight: FontWeight.w500,
                color: AppColors.textMedium,
              ),
              maxLines: 1,
              overflow: TextOverflow.ellipsis,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildMessagesList() {
    return StreamBuilder<QuerySnapshot>(
      stream: FirebaseFirestore.instance
          .collection('chats')
          .where('participants', arrayContains: currentUserId)
          .snapshots(), // Client side sort/filter for complexity reasons
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return Center(
            child: CircularProgressIndicator(color: AppColors.primaryLavender),
          );
        }

        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return Center(
            child: Text(
              'No messages yet',
              style: TextStyle(color: AppColors.textMedium),
            ),
          );
        }

        final docs = snapshot.data!.docs;
        List<DocumentSnapshot> filteredDocs = [];
        List<DocumentSnapshot> pinnedDocs = [];

        bool hasArchivedChat = false;

        for (var doc in docs) {
          final data = doc.data() as Map<String, dynamic>;

          // Check Deleted
          final deletedMap = data['deletedAt'] as Map<String, dynamic>?;
          final deletedAtTimestamp = deletedMap?[currentUserId];
          // If deleted, filter out messages before that time??
          // Complex. For now, if 'deletedAt' exists and is AFTER lastMessageTime, don't show chat?
          // Simplification: "Delete" just hides the chat until a new message comes.
          // If deletedAt > lastMessageTime, hide.

          final lastMessageTime = (data['lastMessageTime'] as Timestamp?)
              ?.toDate();
          if (deletedAtTimestamp != null && lastMessageTime != null) {
            final delTime = (deletedAtTimestamp as Timestamp).toDate();
            if (delTime.isAfter(lastMessageTime)) {
              continue; // Skip this chat (it's deleted and no new activity)
            }
          }

          // Check Archived
          final archivedMap = data['archived'] as Map<String, dynamic>?;
          final isArchived = archivedMap?[currentUserId] == true;
          if (isArchived) {
            hasArchivedChat = true;
            continue; // Don't show in main list
          }

          // Check Locked
          final lockedMap = data['locked'] as Map<String, dynamic>?;
          final isLocked = lockedMap?[currentUserId] == true;
          if (isLocked) {
            // If locked, we still show it in list but maybe obfuscated or in "Locked" folder?
            // Requirement said "Locked Chats" folder.
            continue; // Skip for now, assume separate folder viewer not implemented yet or they are hidden.
          }

          // Check Pinned
          final pinnedMap = data['pinned'] as Map<String, dynamic>?;
          final isPinned = pinnedMap?[currentUserId] == true;

          if (isPinned) {
            pinnedDocs.add(doc);
          } else {
            filteredDocs.add(doc);
          }
        }

        // Sort: Recent first. Pinned already separated.
        filteredDocs.sort((a, b) {
          final tA =
              (a.data() as Map<String, dynamic>)['lastMessageTime']
                  as Timestamp?;
          final tB =
              (b.data() as Map<String, dynamic>)['lastMessageTime']
                  as Timestamp?;
          if (tA == null) return 1;
          if (tB == null) return -1;
          return tB.compareTo(tA);
        });

        pinnedDocs.sort((a, b) {
          // Pinned Date Sort? Or Last Message? Usually Last Message is fine for pinned too.
          final tA =
              (a.data() as Map<String, dynamic>)['lastMessageTime']
                  as Timestamp?;
          final tB =
              (b.data() as Map<String, dynamic>)['lastMessageTime']
                  as Timestamp?;
          if (tA == null) return 1;
          if (tB == null) return -1;
          return tB.compareTo(tA);
        });

        final displayList = [...pinnedDocs, ...filteredDocs];

        return ListView.builder(
          itemCount: displayList.length + 1 + (hasArchivedChat ? 1 : 0),
          itemBuilder: (context, index) {
            // 0 -> Notifications
            if (index == 0) {
              return _buildNotificationEntryTile();
            }

            int adjustedIndex = index - 1;

            // 1 -> Archived Folder (if exists)
            if (hasArchivedChat) {
              if (adjustedIndex == 0) {
                return ListTile(
                  leading: Container(
                    padding: EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: AppColors.elevation,
                      shape: BoxShape.circle,
                    ),
                    child: Icon(
                      Feather.archive,
                      color: AppColors.textMedium,
                      size: 18,
                    ),
                  ),
                  title: Text(
                    "Archived Chats",
                    style: TextStyle(
                      color: AppColors.textHigh,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  onTap: () {
                    // TODO: Navigate to Archive Screen
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text("Archive Screen functionality pending."),
                      ),
                    );
                  },
                );
              }
              adjustedIndex--;
            }

            final chat = displayList[adjustedIndex];
            final chatData = chat.data() as Map<String, dynamic>;
            final participants = List.from(chatData['participants']);
            final otherUserId = participants.firstWhere(
              (id) => id != currentUserId,
            );

            return FutureBuilder<DocumentSnapshot>(
              future: FirebaseFirestore.instance
                  .collection('users')
                  .doc(otherUserId)
                  .get(),
              builder: (context, userSnapshot) {
                if (!userSnapshot.hasData) {
                  return ListTile(
                    title: Text(
                      'Loading...',
                      style: TextStyle(color: AppColors.textDisabled),
                    ),
                  );
                }

                final user = userSnapshot.data!;
                final userData = user.data() as Map<String, dynamic>;

                final unreadCount =
                    chatData.containsKey('unreadCount') &&
                        chatData['unreadCount'] != null
                    ? chatData['unreadCount'][currentUserId] ?? 0
                    : 0;

                final pinnedMap = chatData['pinned'] as Map<String, dynamic>?;
                final isPinned = pinnedMap?[currentUserId] == true;

                final mutedMap =
                    chatData['mutedUntil'] as Map<String, dynamic>?;
                final muteTs = mutedMap?[currentUserId] as Timestamp?;
                final isMuted =
                    muteTs != null && muteTs.toDate().isAfter(DateTime.now());

                return _buildMessageTile(
                  chat.id,
                  userData['username'] ?? 'User',
                  userData['profileImage'] ?? '',
                  chatData['lastMessage'] ?? '',
                  (chatData['lastMessageTime'] as Timestamp?)?.toDate() ??
                      DateTime.now(),
                  unreadCount,
                  otherUserId,
                  chatType: chatData['type'],
                  otherUserAccountType: userData['accountType'],
                  isPinned: isPinned,
                  isMuted: isMuted,
                );
              },
            );
          },
        );
      },
    );
  }

  Widget _buildNotificationEntryTile() {
    return StreamBuilder<QuerySnapshot>(
      stream: FirebaseFirestore.instance
          .collection('users')
          .doc(currentUserId)
          .collection('notifications')
          .where('isRead', isEqualTo: false)
          .snapshots(),
      builder: (context, snapshot) {
        final unreadCount = snapshot.hasData ? snapshot.data!.docs.length : 0;

        return Padding(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
          child: GestureDetector(
            onTap: () {
              Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (context) => const NotificationsScreen(),
                ),
              );
            },
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
              decoration: BoxDecoration(
                color: AppColors.surface,
                borderRadius: BorderRadius.circular(16),
                border: unreadCount > 0
                    ? Border.all(
                        color: AppColors.primaryLavender.withOpacity(0.3),
                        width: 1,
                      )
                    : null,
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.04),
                    blurRadius: 6,
                    offset: const Offset(0, 2),
                  ),
                ],
              ),
              child: Row(
                children: [
                  // Notification Icon as Profile Pic
                  Container(
                    width: 48,
                    height: 48,
                    decoration: BoxDecoration(
                      color: AppColors.elevation,
                      shape: BoxShape.circle,
                    ),
                    child: const Icon(
                      Feather.bell,
                      color: AppColors.primaryLavender,
                      size: 24,
                    ),
                  ),
                  const SizedBox(width: 12),

                  // Notifications Text
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text(
                          'Notifications',
                          style: TextStyle(
                            fontSize: 15,
                            fontWeight: FontWeight.bold,
                            color: AppColors.textHigh,
                          ),
                        ),
                        if (unreadCount > 0) ...[
                          const SizedBox(height: 4),
                          Text(
                            'You have $unreadCount interactions',
                            style: const TextStyle(
                              fontSize: 13,
                              color: AppColors.primaryLavender,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ],
                      ],
                    ),
                  ),

                  // Indicator for unread
                  if (unreadCount > 0)
                    Container(
                      width: 10,
                      height: 10,
                      decoration: const BoxDecoration(
                        color: AppColors.accentMustard,
                        shape: BoxShape.circle,
                      ),
                    ),
                ],
              ),
            ),
          ),
        );
      },
    );
  }

  Widget _buildMessageTile(
    String chatId,
    String username,
    String profileImage,
    String lastMessage,
    DateTime timestamp,
    int unreadCount,
    String otherUserId, {
    String? chatType,
    String? otherUserAccountType,
    bool isPinned = false,
    bool isMuted = false,
  }) {
    final bool isTherapyChat = chatType == 'therapy';
    final bool isTherapist = otherUserAccountType == 'therapist';
    final bool isSelected = _selectedChatIds.contains(chatId);

    String displayName = username;
    if (isTherapyChat) {
      if (isTherapist) {
        displayName = "Therapist | $username";
      } else {
        displayName = "Client | $username";
      }
    }

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      child: GestureDetector(
        onLongPress: () {
          setState(() {
            _isSelectionMode = true;
            _selectedChatIds.add(chatId);
          });
        },
        onTap: () {
          if (_isSelectionMode) {
            setState(() {
              if (isSelected) {
                _selectedChatIds.remove(chatId);
                if (_selectedChatIds.isEmpty) _isSelectionMode = false;
              } else {
                _selectedChatIds.add(chatId);
              }
            });
            return;
          }

          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) => ChatScreen(
                chatId: chatId,
                otherUserId: otherUserId,
                otherUserName: displayName,
                otherUserProfileImage: profileImage,
              ),
            ),
          );
        },
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
          decoration: BoxDecoration(
            color: isSelected
                ? AppColors.primaryLavender.withOpacity(0.2)
                : AppColors.surface, // Surface color for message tile
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.04),
                blurRadius: 6,
                offset: const Offset(0, 2),
              ),
            ],
          ),
          child: Row(
            children: [
              // Selection Checkbox
              if (_isSelectionMode)
                Padding(
                  padding: const EdgeInsets.only(right: 12.0),
                  child: Icon(
                    isSelected
                        ? Icons.check_circle
                        : Icons.radio_button_unchecked,
                    color: isSelected
                        ? AppColors.primaryLavender
                        : AppColors.textDisabled,
                  ),
                ),

              // Profile image with optional Pulse Badge
              Stack(
                children: [
                  CircleAvatar(
                    radius: 24,
                    backgroundColor: AppColors.elevation,
                    backgroundImage: profileImage.isNotEmpty
                        ? CachedNetworkImageProvider(profileImage)
                        : const AssetImage('assets/default_avatar.png')
                              as ImageProvider,
                  ),
                  if (isTherapyChat)
                    Positioned(
                      bottom: 0,
                      right: 0,
                      child: Container(
                        width: 14,
                        height: 14,
                        decoration: BoxDecoration(
                          color: AppColors.primaryLavender, // Purple
                          shape: BoxShape.circle,
                          border: Border.all(
                            color: AppColors.surface,
                            width: 2,
                          ),
                          boxShadow: [
                            BoxShadow(
                              color: AppColors.primaryLavender.withOpacity(0.5),
                              blurRadius: 4,
                              spreadRadius: 1,
                            ),
                          ],
                        ),
                      ),
                    ),
                ],
              ),
              const SizedBox(width: 12),

              // Name and last message
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Expanded(
                          child: Text(
                            displayName,
                            style: const TextStyle(
                              fontSize: 15,
                              fontWeight: FontWeight.bold,
                              color: AppColors.textHigh, // White Name
                            ),
                            maxLines: 1,
                            overflow: TextOverflow.ellipsis,
                          ),
                        ),
                        if (isPinned)
                          Icon(
                            Icons.push_pin,
                            size: 14,
                            color: AppColors.textMedium,
                          ),
                        if (isMuted) SizedBox(width: 4),
                        if (isMuted)
                          Icon(
                            Feather.volume_x,
                            size: 14,
                            color: AppColors.textMedium,
                          ),
                      ],
                    ),
                    const SizedBox(height: 4),
                    Text(
                      lastMessage,
                      style: const TextStyle(
                        fontSize: 13,
                        color: AppColors.textMedium, // Gray message preview
                      ),
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ],
                ),
              ),

              // Timestamp and unread count
              Column(
                crossAxisAlignment: CrossAxisAlignment.end,
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Text(
                    timeago.format(timestamp),
                    style: TextStyle(
                      fontSize: 11,
                      color: AppColors.textDisabled,
                    ),
                  ),
                  if (unreadCount > 0) const SizedBox(height: 6),
                  if (unreadCount > 0)
                    Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 6,
                        vertical: 2,
                      ),
                      decoration: BoxDecoration(
                        color: AppColors
                            .accentMustard, // Mustard for notification badge
                        borderRadius: BorderRadius.circular(12),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withOpacity(0.08),
                            blurRadius: 4,
                            offset: const Offset(0, 2),
                          ),
                        ],
                      ),
                      child: Text(
                        unreadCount.toString(),
                        style: const TextStyle(
                          fontSize: 12,
                          color: AppColors
                              .backgroundDeep, // Dark text on light badge
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Future<List<String>> _getFollowedUserIds() async {
    try {
      final currentUserDoc = await FirebaseFirestore.instance
          .collection('users')
          .doc(currentUserId)
          .get();

      if (currentUserDoc.exists) {
        final followingList = List<String>.from(
          currentUserDoc['following'] ?? [],
        );
        followingList.add(currentUserId);
        return followingList;
      }
      return [currentUserId];
    } catch (e) {
      print('Error fetching followed users: $e');
      return [currentUserId];
    }
  }

  void _showStoryCreationModal(BuildContext context) {
    showModalBottomSheet(
      context: context,
      builder: (context) => StoryCreationModal(),
      isScrollControlled: true,
      backgroundColor: AppColors.surface, // Ensure modal matches theme
    );
  }

  void _viewStory(String userId, String username, String profileImage) async {
    try {
      final storiesSnapshot = await FirebaseFirestore.instance
          .collection('stories')
          .where('userId', isEqualTo: userId)
          .where('expiresAt', isGreaterThan: DateTime.now())
          .orderBy('timestamp', descending: false)
          .get();

      if (storiesSnapshot.docs.isEmpty) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('No stories available for this user.')),
        );
        return;
      }

      final List<DocumentSnapshot> userStoriesList = storiesSnapshot.docs;

      Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) => StoryViewerScreen(
            userId: userId,
            stories: userStoriesList,
            username: username,
            profileImage: profileImage,
          ),
        ),
      );
    } catch (e) {
      print('Error viewing story: $e');
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Error loading story.')));
    }
  }
}


--- C:\Code\femn\lib\hub_screens\notifications.dart ---

import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:timeago/timeago.dart' as timeago;
import 'package:cached_network_image/cached_network_image.dart';

// Internal App Imports
import 'package:femn/customization/colors.dart';
import 'package:femn/hub_screens/post.dart';
import 'package:femn/hub_screens/profile.dart';
import 'package:femn/hub_screens/messaging.dart';

class NotificationsScreen extends StatefulWidget {
  const NotificationsScreen({Key? key}) : super(key: key);

  @override
  _NotificationsScreenState createState() => _NotificationsScreenState();
}

class _NotificationsScreenState extends State<NotificationsScreen> {
  final String _currentUserId = FirebaseAuth.instance.currentUser!.uid;

  @override
  void initState() {
    super.initState();
    // Mark all as read when opening the screen
    _markAllAsRead(silent: true);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: Row(
          children: [
            const SizedBox(width: 12),
            GestureDetector(
              onTap: () => Navigator.pop(context),
              child: Container(
                width: 42,
                height: 42,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  color: AppColors.elevation,
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.2),
                      blurRadius: 6,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: const Icon(
                  Feather.arrow_left,
                  color: AppColors.primaryLavender,
                  size: 22,
                ),
              ),
            ),
          ],
        ),
        leadingWidth: 60,
        title: Text(
          'Notifications',
          style: TextStyle(
            fontWeight: FontWeight.bold,
            color: AppColors.textHigh,
          ),
        ),
      ),
      body: StreamBuilder<QuerySnapshot>(
        stream: FirebaseFirestore.instance
            .collection('users')
            .doc(_currentUserId)
            .collection('notifications')
            .orderBy('timestamp', descending: true)
            .snapshots(),
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting) {
            return const Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryLavender,
              ),
            );
          }

          if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
            return Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(
                    Feather.bell_off,
                    size: 64,
                    color: AppColors.textDisabled,
                  ),
                  const SizedBox(height: 16),
                  Text(
                    'No notifications yet',
                    style: TextStyle(color: AppColors.textMedium, fontSize: 16),
                  ),
                ],
              ),
            );
          }

          return ListView.builder(
            itemCount: snapshot.data!.docs.length,
            padding: const EdgeInsets.symmetric(vertical: 12),
            itemBuilder: (context, index) {
              final doc = snapshot.data!.docs[index];
              final data = doc.data() as Map<String, dynamic>;
              return _NotificationTile(
                docId: doc.id,
                data: data,
                currentUserId: _currentUserId,
              );
            },
          );
        },
      ),
    );
  }

  Future<void> _markAllAsRead({bool silent = false}) async {
    try {
      final snapshots = await FirebaseFirestore.instance
          .collection('users')
          .doc(_currentUserId)
          .collection('notifications')
          .where('isRead', isEqualTo: false)
          .get();

      if (snapshots.docs.isEmpty) return;

      final batch = FirebaseFirestore.instance.batch();
      for (var doc in snapshots.docs) {
        batch.update(doc.reference, {'isRead': true});
      }

      await batch.commit();
    } catch (e) {
      print("Error marking notifications as read: $e");
    }
  }
}

class _NotificationTile extends StatelessWidget {
  final String docId;
  final Map<String, dynamic> data;
  final String currentUserId;

  const _NotificationTile({
    Key? key,
    required this.docId,
    required this.data,
    required this.currentUserId,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final bool isRead = data['isRead'] ?? false;
    final String fromUserId = data['fromUserId'] ?? '';
    final Timestamp? timestamp = data['timestamp'] as Timestamp?;

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      child: GestureDetector(
        onTap: () => _handleTap(context),
        child: AnimatedContainer(
          duration: const Duration(milliseconds: 300),
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
          decoration: BoxDecoration(
            color: isRead
                ? AppColors.surface.withOpacity(0.7)
                : AppColors.surface,
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.04),
                blurRadius: 6,
                offset: const Offset(0, 2),
              ),
            ],
            border: isRead
                ? null
                : Border.all(
                    color: AppColors.primaryLavender.withOpacity(0.3),
                    width: 1,
                  ),
          ),
          child: Row(
            children: [
              // Avatar with Icon overlay
              _buildLeading(fromUserId),
              const SizedBox(width: 12),

              // Content
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      data['title'] ?? 'Notification',
                      style: TextStyle(
                        fontSize: 15,
                        fontWeight: isRead ? FontWeight.bold : FontWeight.w900,
                        color: AppColors.textHigh,
                      ),
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                    ),
                    const SizedBox(height: 4),
                    Text(
                      data['body'] ?? '',
                      style: TextStyle(
                        fontSize: 13,
                        color: isRead
                            ? AppColors.textMedium
                            : AppColors.textHigh,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ],
                ),
              ),

              // Timestamp & unread dot
              Column(
                crossAxisAlignment: CrossAxisAlignment.end,
                children: [
                  Text(
                    timestamp != null
                        ? timeago.format(timestamp.toDate(), locale: 'en_short')
                        : 'now',
                    style: TextStyle(
                      fontSize: 11,
                      color: AppColors.textDisabled,
                    ),
                  ),
                  if (!isRead) ...[
                    const SizedBox(height: 8),
                    Container(
                      width: 10,
                      height: 10,
                      decoration: const BoxDecoration(
                        color: AppColors.accentMustard,
                        shape: BoxShape.circle,
                      ),
                    ),
                  ],
                ],
              ),

              // Post Thumbnail (if exists)
              if (data['postMediaUrl'] != null &&
                  data['postMediaUrl'].isNotEmpty) ...[
                const SizedBox(width: 12),
                ClipRRect(
                  borderRadius: BorderRadius.circular(8),
                  child: CachedNetworkImage(
                    imageUrl: data['postMediaUrl'],
                    width: 44,
                    height: 44,
                    fit: BoxFit.cover,
                    placeholder: (context, url) => Container(
                      width: 44,
                      height: 44,
                      color: AppColors.elevation,
                    ),
                    errorWidget: (context, url, error) =>
                        const SizedBox.shrink(),
                  ),
                ),
              ],
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildLeading(String fromUserId) {
    return FutureBuilder<DocumentSnapshot>(
      future: FirebaseFirestore.instance
          .collection('users')
          .doc(fromUserId)
          .get(),
      builder: (context, snapshot) {
        String profileImage = '';
        if (snapshot.hasData && snapshot.data!.exists) {
          profileImage = snapshot.data!['profileImage'] ?? '';
        }

        return Stack(
          children: [
            CircleAvatar(
              radius: 24,
              backgroundColor: AppColors.elevation,
              backgroundImage: profileImage.isNotEmpty
                  ? CachedNetworkImageProvider(profileImage)
                  : const AssetImage('assets/default_avatar.png')
                        as ImageProvider,
            ),
            Positioned(
              bottom: -2,
              right: -2,
              child: Container(
                padding: const EdgeInsets.all(3),
                decoration: BoxDecoration(
                  color: AppColors.surface,
                  shape: BoxShape.circle,
                  border: Border.all(
                    color: AppColors.backgroundDeep,
                    width: 1.5,
                  ),
                ),
                child: Icon(
                  _getIconForType(),
                  size: 10,
                  color: AppColors.primaryLavender,
                ),
              ),
            ),
          ],
        );
      },
    );
  }

  IconData _getIconForType() {
    switch (data['type']) {
      case 'like':
        return Ionicons.heart;
      case 'comment':
        return Ionicons.chatbubble;
      case 'follow':
        return Ionicons.person_add;
      default:
        return Ionicons.notifications;
    }
  }

  void _handleTap(BuildContext context) async {
    // Navigate based on type
    final String type = data['type'] ?? '';
    final String postId = data['postId'] ?? '';
    final String fromUserId = data['fromUserId'] ?? '';

    if (type == 'like' || type == 'comment') {
      if (postId.isNotEmpty) {
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => PostDetailScreen(
              postId: postId,
              userId: currentUserId,
              source: 'notification',
            ),
          ),
        );
      }
    } else if (type == 'follow') {
      if (fromUserId.isNotEmpty) {
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => ProfileScreen(userId: fromUserId),
          ),
        );
      }
    } else if (type == 'therapy_accepted') {
      // Navigate to Chat
      // Pass necessary params if we have them, or just go to MessagingScreen/ChatScreen if feasible.
      // Since we have fromUserId (therapist), we can try to open the chat directly if we fetch user details,
      // or just go to the MessagingScreen main list for simplicity.
      // Although MessagingScreen is where chats are listed. To open specific chat we need Chat ID or User.
      // Let's go to MessagingScreen for now as it's safer.
      Navigator.push(
        context,
        MaterialPageRoute(builder: (context) => MessagingScreen()),
      );
    }
  }
}


--- C:\Code\femn\lib\hub_screens\post.dart ---

import 'package:cached_network_image/cached_network_image.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:femn/hub_screens/profile.dart';
import 'package:femn/hub_screens/search.dart';
import 'package:femn/customization/colors.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:flutter/material.dart';
import 'package:flutter_staggered_grid_view/flutter_staggered_grid_view.dart';
import 'package:femn/customization/layout.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:flutter_animate/flutter_animate.dart';

import 'package:share_plus/share_plus.dart';
import 'package:timeago/timeago.dart' as timeago;

import 'package:shared_preferences/shared_preferences.dart';
import 'package:video_player/video_player.dart';
import 'dart:async';
import 'package:flutter/foundation.dart';
import 'package:femn/feed/feed_service.dart';
import 'package:femn/feed/personalized_feed_service.dart';
import 'package:femn/circle/petitions.dart';
import 'package:femn/circle/polls.dart';
import 'package:shimmer/shimmer.dart';
import 'package:url_launcher/url_launcher.dart';
import 'dart:io';
import 'dart:typed_data';
import 'dart:ui' as ui;
import 'package:flutter/services.dart';

import 'package:path_provider/path_provider.dart';
import 'package:image/image.dart' as img;
import 'package:femn/services/notification_service.dart';

// Feed Screen with pull-to-refresh and infinite scroll

class FeedScreen extends StatefulWidget {
  @override
  _FeedScreenState createState() => _FeedScreenState();
}

class _FeedScreenState extends State<FeedScreen> {
  // --- INFINITE SCROLL VARIABLES ---

  final ScrollController _scrollController = ScrollController();

  bool _isScrolled = false; // Added for dynamic top bar styling

  final FeedService _feedService = FeedService();

  final PersonalizedFeedService _personalizedFeed = PersonalizedFeedService();

  List<DocumentSnapshot> _posts = [];

  bool _isLoadingInitial = true;

  bool _isLoadingMore = false;

  bool _hasMore = true;

  String _selectedFilter = 'For You';

  // --- USER CACHE FOR PERFORMANCE ---

  Map<String, Map<String, dynamic>> _userCache = {};

  // --- QUOTE VARIABLES ---

  bool _showQuote = false;

  Map<String, String> _todaysQuoteContent = {};

  final List<Map<String, String>> _dailyQuotes = [
    {"quote": "Deeds, not words.", "author": "Emmeline Pankhurst"},

    {
      "quote": "Feminism is the radical notion that women are people.",
      "author": "Marie Shear",
    },

    {
      "quote": "Well-behaved women seldom make history.",
      "author": "Laurel Thatcher Ulrich",
    },

    {
      "quote":
          "If they don't give you a seat at the table, bring a folding chair.",
      "author": "Shirley Chisholm",
    },

    {
      "quote":
          "My silences had not protected me. Your silence will not protect you.",
      "author": "Audre Lorde",
    },

    {
      "quote": "Women belong in all places where decisions are being made.",
      "author": "Ruth Bader Ginsburg",
    },

    {
      "quote": "We cannot all succeed when half of us are held back.",
      "author": "Malala Yousafzai",
    },

    {
      "quote":
          "The most common way people give up their power is by thinking they don't have any.",
      "author": "Alice Walker",
    },

    {
      "quote":
          "I am not free while any woman is unfree, even when her shackles are very different from my own.",
      "author": "Audre Lorde",
    },

    {
      "quote": "No pride for some of us without liberation for all of us.",
      "author": "Marsha P. Johnson",
    },
  ];

  // --- VIDEO SEQUENCE LOGIC ---

  final ValueNotifier<String?> _activeVideoIdNotifier = ValueNotifier(null);

  List<String> _videoIds = [];

  int _currentSequenceIndex = 0;

  // --- FOLLOWING LIST ---

  List<String> _followingIds = [];
  List<DocumentSnapshot> _trendingPetitions = [];
  bool _isLoadingTrending = false;
  Future<DocumentSnapshot>? _currentUserFuture;

  @override
  void initState() {
    super.initState();

    _currentUserFuture = FirebaseFirestore.instance
        .collection('users')
        .doc(FirebaseAuth.instance.currentUser!.uid)
        .get();

    _fetchFollowingList();
    _checkDailyQuote();
    _loadTrendingPetitions();

    // 1. Initial Load

    _loadInitialPosts();

    // 2. Setup Scroll Listener for Infinite Scroll & UI Styling
    _scrollController.addListener(() {
      // Toggle top bar styling based on scroll position
      if (_scrollController.hasClients) {
        final bool isScrolled = _scrollController.position.pixels > 10;
        if (isScrolled != _isScrolled) {
          setState(() => _isScrolled = isScrolled);
        }

        if (_scrollController.position.pixels >=
            _scrollController.position.maxScrollExtent - 200) {
          _loadMorePosts();
        }
      }
    });
  }

  @override
  void dispose() {
    _scrollController.dispose();

    _activeVideoIdNotifier.dispose();

    super.dispose();
  }

  // OPTIMIZED VERSION WITH BATCH USER FETCHING
  Future<void> _loadInitialPosts() async {
    if (!mounted) return;
    setState(() => _isLoadingInitial = true);

    final currentUserId = FirebaseAuth.instance.currentUser?.uid;

    try {
      List<DocumentSnapshot> newPosts;

      // 1. Fetch Posts (Your existing logic)
      if (_selectedFilter == 'For You') {
        final rawPosts = await _personalizedFeed.getPersonalizedFeed(limit: 20);
        newPosts = rawPosts;
      } else if (_selectedFilter == 'Following') {
        newPosts =
            (await FirebaseFirestore.instance
                    .collection('posts')
                    .where(
                      'userId',
                      whereIn: _followingIds.isEmpty
                          ? ['empty']
                          : _followingIds,
                    )
                    .orderBy('timestamp', descending: true)
                    .limit(20)
                    .get())
                .docs;
      } else {
        newPosts =
            (await FirebaseFirestore.instance
                    .collection('posts')
                    .orderBy('timestamp', descending: true)
                    .limit(20)
                    .get())
                .docs;
      }

      // Fetch Petitions and Polls to mix in (Fetch more to filter)
      final petitionsSnap = await FirebaseFirestore.instance
          .collection('petitions')
          .limit(20)
          .get();
      final pollsSnap = await FirebaseFirestore.instance
          .collection('polls')
          .limit(20)
          .get();

      List<DocumentSnapshot> filteredPetitions = [];
      if (currentUserId != null) {
        filteredPetitions = petitionsSnap.docs.where((doc) {
          final data = doc.data() as Map<String, dynamic>;
          final signers = List<String>.from(data['signers'] ?? []);
          return !signers.contains(currentUserId);
        }).toList();
      } else {
        filteredPetitions = petitionsSnap.docs;
      }

      List<DocumentSnapshot> filteredPolls = [];
      if (currentUserId != null) {
        filteredPolls = pollsSnap.docs.where((doc) {
          final data = doc.data() as Map<String, dynamic>;
          final voters = List<dynamic>.from(data['voters'] ?? []);
          return !voters.any((v) => v is Map && v['userId'] == currentUserId);
        }).toList();
      } else {
        filteredPolls = pollsSnap.docs;
      }

      // Final mix and filter for ALL posts (just in case pet/pol were in main feed too)
      List<DocumentSnapshot> allCandidates = [
        ...newPosts,
        ...filteredPetitions,
        ...filteredPolls,
      ];

      // Deduplicate and filter one last time (if user already participated in something that got in via main feed)
      List<DocumentSnapshot> finalItems = [];
      Set<String> seenIds = {};

      for (var doc in allCandidates) {
        if (seenIds.contains(doc.id)) continue;

        final data = doc.data() as Map<String, dynamic>;
        final collection = doc.reference.parent.id;
        bool keep = true;

        if (currentUserId != null) {
          if (collection == 'petitions') {
            final signers = List<String>.from(data['signers'] ?? []);
            if (signers.contains(currentUserId)) keep = false;
          } else if (collection == 'polls') {
            final voters = List<dynamic>.from(data['voters'] ?? []);
            if (voters.any((v) => v is Map && v['userId'] == currentUserId))
              keep = false;
          }
        }

        if (keep) {
          finalItems.add(doc);
          seenIds.add(doc.id);
        }
      }

      finalItems.shuffle();
      newPosts = finalItems.take(30).toList();

      // 2. BATCH FETCH USERS (The Performance Fix)
      Set<String> userIdsToFetch = {};
      for (var doc in newPosts) {
        final data = doc.data() as Map<String, dynamic>;
        // Handle different ID fields for different content types
        String? userId;
        if (data.containsKey('userId'))
          userId = data['userId'];
        else if (data.containsKey('createdBy'))
          userId = data['createdBy']; // For Petitions/Polls

        if (userId != null && !_userCache.containsKey(userId)) {
          userIdsToFetch.add(userId);
        }
      }

      if (userIdsToFetch.isNotEmpty) {
        final userDocs = await Future.wait(
          userIdsToFetch.map(
            (id) =>
                FirebaseFirestore.instance.collection('users').doc(id).get(),
          ),
        );

        for (var userDoc in userDocs) {
          if (userDoc.exists) {
            _userCache[userDoc.id] = userDoc.data() as Map<String, dynamic>;
          }
        }
      }

      if (mounted) {
        setState(() {
          _posts = newPosts;
          _isLoadingInitial = false;
          _hasMore = newPosts.isNotEmpty;
        });
        _triggerVideoLogic(newPosts);
      }
    } catch (e) {
      print("Error loading feed: $e");
      if (mounted) setState(() => _isLoadingInitial = false);
    }
  }

  // OPTIMIZED LOAD MORE WITH BATCH FETCHING
  Future<void> _loadMorePosts() async {
    if (_isLoadingMore || !_hasMore || _posts.isEmpty) return;
    setState(() => _isLoadingMore = true);

    final currentUserId = FirebaseAuth.instance.currentUser?.uid;

    List<DocumentSnapshot> newPosts;

    // Find the last actual POST document to use as cursor (skipping polls/petitions if they are last)
    DocumentSnapshot? lastDoc;
    for (int i = _posts.length - 1; i >= 0; i--) {
      final data = _posts[i].data() as Map<String, dynamic>;
      // Identify posts by fields unique to them or collection check if possible,
      // but simpler is checking known post fields like 'mediaUrl' or missing 'question'/'goal'
      if (data.containsKey('mediaUrl') || data.containsKey('caption')) {
        lastDoc = _posts[i];
        break;
      }
    }

    if (lastDoc == null) lastDoc = _posts.last; // Fallback

    if (_selectedFilter == 'For You') {
      newPosts = await _personalizedFeed.getPersonalizedFeed(
        limit: 10,
        lastDocument: lastDoc,
      );
    } else {
      final snap = await FirebaseFirestore.instance
          .collection('posts')
          .orderBy('timestamp', descending: true)
          .startAfterDocument(lastDoc)
          .limit(12)
          .get();
      newPosts = snap.docs;
    }

    // Fetch some petitions and polls to mix in
    final petitionsSnap = await FirebaseFirestore.instance
        .collection('petitions')
        .limit(10)
        .get();
    final pollsSnap = await FirebaseFirestore.instance
        .collection('polls')
        .limit(10)
        .get();

    List<DocumentSnapshot> filteredPetitions = [];
    if (currentUserId != null) {
      filteredPetitions = petitionsSnap.docs.where((doc) {
        final data = doc.data() as Map<String, dynamic>;
        final signers = List<String>.from(data['signers'] ?? []);
        return !signers.contains(currentUserId) &&
            !_posts.any((p) => p.id == doc.id);
      }).toList();
    }

    List<DocumentSnapshot> filteredPolls = [];
    if (currentUserId != null) {
      filteredPolls = pollsSnap.docs.where((doc) {
        final data = doc.data() as Map<String, dynamic>;
        final voters = List<dynamic>.from(data['voters'] ?? []);
        bool hasVoted = voters.any(
          (v) => v is Map && v['userId'] == currentUserId,
        );
        return !hasVoted && !_posts.any((p) => p.id == doc.id);
      }).toList();
    }

    List<DocumentSnapshot> mixedNewItems = [
      ...newPosts,
      ...filteredPetitions,
      ...filteredPolls,
    ];

    // Final dedupe and filtering
    List<DocumentSnapshot> uniqueNewItems = [];
    Set<String> existingIds = _posts.map((e) => e.id).toSet();

    for (var doc in mixedNewItems) {
      if (existingIds.contains(doc.id)) continue;

      final data = doc.data() as Map<String, dynamic>;
      final collection = doc.reference.parent.id;
      bool keep = true;

      if (currentUserId != null) {
        if (collection == 'petitions') {
          final signers = List<String>.from(data['signers'] ?? []);
          if (signers.contains(currentUserId)) keep = false;
        } else if (collection == 'polls') {
          final voters = List<dynamic>.from(data['voters'] ?? []);
          if (voters.any((v) => v is Map && v['userId'] == currentUserId))
            keep = false;
        }
      }

      if (keep) {
        uniqueNewItems.add(doc);
        existingIds.add(doc.id);
      }
    }

    uniqueNewItems.shuffle();
    newPosts = uniqueNewItems;

    // --- BATCH FETCH USERS FOR NEW POSTS ---
    Set<String> userIdsToFetch = {};
    for (var doc in newPosts) {
      final data = doc.data() as Map<String, dynamic>;
      String? userId;
      if (data.containsKey('userId'))
        userId = data['userId'];
      else if (data.containsKey('createdBy'))
        userId = data['createdBy'];

      if (userId != null && !_userCache.containsKey(userId)) {
        userIdsToFetch.add(userId);
      }
    }

    if (userIdsToFetch.isNotEmpty) {
      final userDocs = await Future.wait(
        userIdsToFetch.map(
          (id) => FirebaseFirestore.instance.collection('users').doc(id).get(),
        ),
      );
      for (var userDoc in userDocs) {
        if (userDoc.exists) {
          _userCache[userDoc.id] = userDoc.data() as Map<String, dynamic>;
        }
      }
    }
    // ------------------------------------------------

    if (mounted) {
      setState(() {
        _posts.addAll(newPosts);
        _isLoadingMore = false;
        if (newPosts.length < 5) _hasMore = false;
      });
      _triggerVideoLogic(_posts);
    }
  }

  Future<void> _onRefresh() async {
    setState(() {
      _posts.clear();
      _hasMore = true;
    });
    _loadTrendingPetitions();
    await _loadInitialPosts();
  }

  void _triggerVideoLogic(List<DocumentSnapshot> posts) {
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _startVideoSequence(posts);
    });
  }

  void _startVideoSequence(List<DocumentSnapshot> posts) {
    _videoIds = posts
        .where((doc) {
          final data = doc.data() as Map<String, dynamic>;
          return data['mediaType'] == 'video';
        })
        .map((doc) => doc.id)
        .toList();

    if (_videoIds.isEmpty) {
      _activeVideoIdNotifier.value = null;
      return;
    }
    if (_currentSequenceIndex == 0) _playNextInSequence();
  }

  void _playNextInSequence() {
    if (!mounted || _videoIds.isEmpty) return;
    if (_currentSequenceIndex >= _videoIds.length) _currentSequenceIndex = 0;
    _activeVideoIdNotifier.value = _videoIds[_currentSequenceIndex];
  }

  void _handleVideoFinished(String postId) {
    if (_videoIds.contains(postId) && _activeVideoIdNotifier.value == postId) {
      _currentSequenceIndex++;
      _playNextInSequence();
    }
  }

  Future<void> _checkDailyQuote() async {
    final prefs = await SharedPreferences.getInstance();
    final String? lastDismissedDate = prefs.getString(
      'last_dismissed_quote_date',
    );
    final DateTime now = DateTime.now();
    final String todayDate =
        "${now.year}-${now.month.toString().padLeft(2, '0')}-${now.day.toString().padLeft(2, '0')}";

    if (lastDismissedDate != todayDate) {
      final int quoteIndex = now.day % _dailyQuotes.length;
      setState(() {
        _todaysQuoteContent = _dailyQuotes[quoteIndex];
        _showQuote = true;
      });
    } else {
      setState(() => _showQuote = false);
    }
  }

  Future<void> _dismissQuote() async {
    final prefs = await SharedPreferences.getInstance();
    final DateTime now = DateTime.now();
    final String todayDate =
        "${now.year}-${now.month.toString().padLeft(2, '0')}-${now.day.toString().padLeft(2, '0')}";
    await prefs.setString('last_dismissed_quote_date', todayDate);
    setState(() => _showQuote = false);
  }

  Future<void> _fetchFollowingList() async {
    final currentUserId = FirebaseAuth.instance.currentUser!.uid;
    try {
      final userDoc = await FirebaseFirestore.instance
          .collection('users')
          .doc(currentUserId)
          .get();
      if (userDoc.exists) {
        final following = List<String>.from(userDoc['following'] ?? []);
        setState(() => _followingIds = following);
      }
    } catch (e) {
      print('Error fetching following list: $e');
    }
  }

  void _showComingSoonPopup() {
    showDialog(
      context: context,
      builder: (context) => Dialog(
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16.0),
        ),
        elevation: 6,
        backgroundColor: AppColors.surface,
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 24.0, vertical: 20.0),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(
                'Coming Soon',
                style: TextStyle(
                  color: AppColors.accentMustard,
                  fontWeight: FontWeight.bold,
                  fontSize: 18,
                ),
              ),
              const SizedBox(height: 12),
              Text(
                'The News section is currently under development.',
                style: TextStyle(color: AppColors.textMedium, fontSize: 15),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 20),
              GestureDetector(
                onTap: () => Navigator.pop(context),
                child: Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 28,
                    vertical: 10,
                  ),
                  decoration: BoxDecoration(
                    color: AppColors.elevation,
                    borderRadius: BorderRadius.circular(12),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.2),
                        blurRadius: 6,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),
                  child: Text(
                    'OK',
                    style: TextStyle(
                      color: AppColors.primaryLavender,
                      fontWeight: FontWeight.bold,
                      fontSize: 14,
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildTrendingPetitionsSection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: const EdgeInsets.fromLTRB(20, 4, 20, 12),
          child: Row(
            children: [
              Icon(
                Feather.trending_up,
                color: AppColors.accentMustard,
                size: 18,
              ),
              SizedBox(width: 8),
              Text(
                'TRENDING NOW',
                style: TextStyle(
                  color: AppColors.textHigh,
                  fontWeight: FontWeight.bold,
                  fontSize: 14,
                  letterSpacing: 1.0,
                ),
              ),
            ],
          ),
        ),
        SizedBox(
          height: 200,
          child: ListView.builder(
            padding: EdgeInsets.symmetric(horizontal: 20),
            scrollDirection: Axis.horizontal,
            itemCount: _trendingPetitions.length,
            itemBuilder: (context, index) {
              return TrendingPetitionCard(petition: _trendingPetitions[index]);
            },
          ),
        ),
        SizedBox(height: 10),
      ],
    );
  }

  Future<void> _loadTrendingPetitions() async {
    if (mounted) setState(() => _isLoadingTrending = true);
    try {
      final snapshot = await FirebaseFirestore.instance
          .collection('petitions')
          .orderBy('currentSignatures', descending: true)
          .limit(10)
          .get();

      if (mounted) {
        setState(() {
          _trendingPetitions = snapshot.docs;
          _isLoadingTrending = false;
        });
      }
    } catch (e) {
      print("Error loading trending petitions: $e");
      if (mounted) setState(() => _isLoadingTrending = false);
    }
  }

  void _loadMixedFeed() async {
    // This will be called inside _loadInitialPosts
  }

  @override
  Widget build(BuildContext context) {
    final currentUserId = FirebaseAuth.instance.currentUser!.uid;
    final topPadding = MediaQuery.of(context).padding.top;

    List<DocumentSnapshot> displayPosts = _posts;

    if (_selectedFilter == 'Following') {
      displayPosts = _posts.where((post) {
        final data = post.data() as Map<String, dynamic>;

        // Be careful with mixed types (polls/petitions might not have userId same way)
        if (data.containsKey('userId')) {
          return _followingIds.contains(data['userId']);
        }
        return true; // Keep others for now or filter them out too? Assuming following feed should include following's polls?
      }).toList();
    }

    return Scaffold(
      backgroundColor: Colors.transparent,
      body: RefreshIndicator(
        color: AppColors.primaryLavender,
        backgroundColor: Colors.transparent,
        onRefresh: _onRefresh,
        child: CustomScrollView(
          controller: _scrollController,
          slivers: [
            // 1. TOP BAR (Logo, Search, Profile)
            // 1. TOP BAR (Logo, Search, Profile)
            SliverAppBar(
              backgroundColor: Colors
                  .transparent, // Always transparent, we manage color in flexibleSpace
              surfaceTintColor: Colors.transparent, // Avoid M3 tint mismatch
              elevation: 0,
              floating: true,
              snap: true,
              pinned: false,
              automaticallyImplyLeading: false,
              toolbarHeight:
                  56, // Matches standard AppBar height in Circle screen
              flexibleSpace: _isScrolled
                  ? ClipRect(
                      child: BackdropFilter(
                        filter: ui.ImageFilter.blur(sigmaX: 10, sigmaY: 10),
                        child: Container(
                          color: AppColors.backgroundDeep.withOpacity(
                            0.8,
                          ), // Color ON TOP of blur
                        ),
                      ),
                    )
                  : null,
              title: Row(
                children: [
                  Container(
                    width: 42,
                    height: 42,
                    decoration: BoxDecoration(
                      shape: BoxShape.circle,
                      color: AppColors.elevation,
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black.withOpacity(0.2),
                          blurRadius: 15,
                          offset: const Offset(0, 2),
                        ),
                      ],
                    ),
                    child: ClipOval(
                      child: Image.asset(
                        'assets/default_avatar.png',
                        fit: BoxFit.cover,
                      ),
                    ),
                  ),
                  const SizedBox(width: 8),
                  Text(
                    'Femn',
                    style: TextStyle(
                      fontWeight: FontWeight.bold,
                      color: AppColors.textHigh,
                    ),
                  ),
                ],
              ),

              actions: [
                Container(
                  width: 42,

                  height: 42,

                  decoration: BoxDecoration(
                    shape: BoxShape.circle,

                    color: AppColors.elevation,

                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.2),
                        blurRadius: 15,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),

                  child: IconButton(
                    icon: const Icon(
                      Feather.search,
                      color: AppColors.primaryLavender,
                      size: 22,
                    ),

                    onPressed: () => Navigator.push(
                      context,
                      MaterialPageRoute(builder: (context) => SearchScreen()),
                    ),
                  ),
                ),

                SizedBox(width: 8),

                FutureBuilder<DocumentSnapshot>(
                  future: _currentUserFuture,

                  builder: (context, snapshot) {
                    Widget avatar;

                    if (!snapshot.hasData || !snapshot.data!.exists) {
                      avatar = Image.asset(
                        'assets/default_avatar.png',
                        fit: BoxFit.cover,
                      );
                    } else {
                      final userData =
                          snapshot.data!.data() as Map<String, dynamic>;

                      final profileImage = userData['profileImage'] ?? '';

                      avatar = profileImage.isNotEmpty
                          ? Image(
                              image: CachedNetworkImageProvider(profileImage),
                              fit: BoxFit.cover,
                            )
                          : Image.asset(
                              'assets/default_avatar.png',
                              fit: BoxFit.cover,
                            );
                    }

                    return GestureDetector(
                      onTap: () => _showProfileMenu(context),

                      child: Container(
                        width: 42,

                        height: 42,

                        decoration: BoxDecoration(
                          shape: BoxShape.circle,

                          color: AppColors.elevation,

                          boxShadow: [
                            BoxShadow(
                              color: Colors.black.withOpacity(0.2),
                              blurRadius: 15,
                              offset: const Offset(0, 2),
                            ),
                          ],
                        ),

                        child: ClipOval(child: avatar),
                      ),
                    );
                  },
                ),

                SizedBox(width: 12),
              ],
            ),

            // 2. PILL BUTTONS (Sticky Header)

            // 2. PILL BUTTONS (Sticky Header)
            SliverPersistentHeader(
              pinned: true,
              delegate: _StickyTabBarDelegate(
                isScrolled: _isScrolled,
                topPadding: topPadding, // Pass safe area
                minHeight: 45.0,
                maxHeight: 45.0,
                child: Container(
                  // We handle styling inside the delegate
                  padding: const EdgeInsets.symmetric(horizontal: 8.0),
                  alignment: Alignment.center,
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                    children: [
                      _buildFilterButton('News', onTap: _showComingSoonPopup),
                      _buildFilterButton(
                        'For You',
                        onTap: () {
                          setState(() => _selectedFilter = 'For You');
                          _onRefresh();
                        },
                      ),
                      _buildFilterButton(
                        'Following',
                        onTap: () {
                          setState(() => _selectedFilter = 'Following');
                          _onRefresh();
                        },
                      ),
                    ],
                  ),
                ),
              ),
            ),

            // 3. DAILY QUOTE - Gap Removed
            SliverToBoxAdapter(
              child: (_showQuote && _todaysQuoteContent.isNotEmpty)
                  ? Padding(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 20.0,
                        vertical: 8.0,
                      ),

                      child: Dismissible(
                        key: const Key('daily_quote_card'),

                        direction: DismissDirection.horizontal,

                        onDismissed: (direction) => _dismissQuote(),

                        child: Container(
                          width: double.infinity,

                          padding: const EdgeInsets.all(16.0),

                          decoration: BoxDecoration(
                            color: AppColors.surface,

                            borderRadius: BorderRadius.circular(16),

                            border: Border.all(
                              color: AppColors.primaryLavender.withOpacity(0.3),
                              width: 1,
                            ),

                            boxShadow: [
                              BoxShadow(
                                color: Colors.black.withOpacity(0.2),
                                blurRadius: 6,
                                offset: const Offset(0, 3),
                              ),
                            ],
                          ),

                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,

                            children: [
                              Text(
                                "TODAY'S INSPIRATION",

                                style: TextStyle(
                                  color: AppColors.secondaryTeal,
                                  fontSize: 10,
                                  fontWeight: FontWeight.bold,
                                  letterSpacing: 1.0,
                                ),
                              ),

                              const SizedBox(height: 8),

                              Text(
                                "\"${_todaysQuoteContent['quote']}\"",

                                style: TextStyle(
                                  fontSize: 14.0,
                                  color: AppColors.textHigh,
                                  fontWeight: FontWeight.w500,
                                  fontStyle: FontStyle.italic,
                                ),
                              ),

                              const SizedBox(height: 8),

                              Align(
                                alignment: Alignment.bottomRight,

                                child: Text(
                                  "~ ${_todaysQuoteContent['author']}",

                                  style: TextStyle(
                                    fontSize: 12.0,
                                    color: AppColors.primaryLavender,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    )
                  : SizedBox.shrink(),
            ),

            // 4. TRENDING PETITIONS
            if (_trendingPetitions.isNotEmpty)
              SliverToBoxAdapter(child: _buildTrendingPetitionsSection()),

            if (_isLoadingInitial)
              const FeedShimmerSkeleton()
            else if (displayPosts.isEmpty)
              SliverFillRemaining(
                child: Center(
                  child: Text(
                    "No posts found",

                    style: TextStyle(color: AppColors.textMedium),
                  ),
                ),
              )
            else
              SliverPadding(
                padding: const EdgeInsets.symmetric(
                  horizontal: 20.0,
                  vertical: 10.0,
                ),

                sliver: SliverMasonryGrid.count(
                  crossAxisCount: ResponsiveLayout.getColumnCount(context),

                  mainAxisSpacing: 8,

                  crossAxisSpacing: 8,

                  childCount: displayPosts.length + (_isLoadingMore ? 1 : 0),

                  itemBuilder: (context, index) {
                    if (index == displayPosts.length) {
                      return Padding(
                        padding: const EdgeInsets.all(16.0),

                        child: Center(
                          child: CircularProgressIndicator(
                            color: AppColors.primaryLavender,
                            strokeWidth: 2,
                          ),
                        ),
                      );
                    }

                    var post = displayPosts[index];

                    var postData = post.data() as Map<String, dynamic>;

                    var userId = postData['userId'];

                    return FeedPostWrapper(
                      key: ValueKey(post.id),

                      postDoc: post,

                      activeNotifier: _activeVideoIdNotifier,

                      onVideoFinished: () => _handleVideoFinished(post.id),

                      // Pass the cached user data directly
                      cachedUserData: _userCache[userId],
                    );
                  },
                ),
              ),
          ],
        ),
      ),
    );
  }

  Widget _buildFilterButton(String title, {required VoidCallback onTap}) {
    final bool isSelected = _selectedFilter == title;

    return GestureDetector(
      onTap: onTap,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        curve: Curves.easeInOut,
        padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 6.0),
        margin: const EdgeInsets.symmetric(horizontal: 4.0, vertical: 2.0),
        decoration: BoxDecoration(
          color: isSelected ? AppColors.secondaryTeal : AppColors.elevation,
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(isSelected ? 0.15 : 0.03),
              blurRadius: isSelected ? 6 : 4,
              offset: const Offset(0, 2),
            ),
          ],
        ),
        child: Text(
          title,
          textAlign: TextAlign.center,
          style: TextStyle(
            fontWeight: isSelected ? FontWeight.bold : FontWeight.w500,
            fontSize: 14.0,
            color: isSelected ? AppColors.textOnSecondary : AppColors.textHigh,
          ),
        ),
      ),
    );
  }

  void _showProfileMenu(BuildContext context) {
    Navigator.push(
      context,

      MaterialPageRoute(
        builder: (context) =>
            ProfileScreen(userId: FirebaseAuth.instance.currentUser!.uid),
      ),
    );
  }
}

// PostCardWithStream

class PostCardWithStream extends StatelessWidget {
  final String postId;

  final ValueNotifier<String?>? activeNotifier;

  final VoidCallback? onVideoFinished;

  const PostCardWithStream({
    Key? key,

    required this.postId,

    this.activeNotifier,

    this.onVideoFinished,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return StreamBuilder<DocumentSnapshot>(
      stream: FirebaseFirestore.instance
          .collection('posts')
          .doc(postId)
          .snapshots(),

      builder: (context, postSnapshot) {
        if (!postSnapshot.hasData || !postSnapshot.data!.exists)
          return SizedBox();

        final postData = postSnapshot.data!.data() as Map<String, dynamic>;

        if (!postData.containsKey('userId') || postData['userId'] == null)
          return SizedBox();

        return FutureBuilder<DocumentSnapshot>(
          future: FirebaseFirestore.instance
              .collection('users')
              .doc(postData['userId'])
              .get(),

          builder: (context, userSnapshot) {
            if (!userSnapshot.hasData || !userSnapshot.data!.exists)
              return SizedBox();

            final userData = userSnapshot.data!.data() as Map<String, dynamic>;

            return PostCard(
              postId: postId,

              userId: postData['userId'],

              username: userData['username'] ?? 'Unknown',

              profileImage: userData['profileImage'] ?? '',

              mediaUrl: postData['mediaUrl'] ?? '',

              caption: postData['caption'] ?? '',

              likes: List<String>.from(postData['likes'] ?? []),

              timestamp: postData['timestamp']?.toDate() ?? DateTime.now(),

              mediaType: postData['mediaType'] ?? 'image',

              activeNotifier: activeNotifier,

              onVideoFinished: onVideoFinished,

              thumbnailUrl: postData['thumbnailUrl'],

              linkUrl: postData['linkUrl'], // Extract Link
            );
          },
        );
      },
    );
  }
}

// PostCard - Updated with Link Display

class PostCard extends StatefulWidget {
  final String postId;

  final String userId;

  final String username;

  final String profileImage;

  final String mediaUrl;

  final String caption;

  final List<String> likes;

  final DateTime timestamp;

  final String mediaType;

  final String? thumbnailUrl;
  final String? linkUrl;
  final ValueNotifier<String?>? activeNotifier;
  final VoidCallback? onVideoFinished;
  final double? metaWidth;
  final double? metaHeight;
  final String source;
  final String? title; // NEW

  const PostCard({
    required this.postId,
    required this.userId,
    required this.username,
    required this.profileImage,
    required this.mediaUrl,
    required this.caption,
    required this.likes,
    required this.timestamp,
    required this.mediaType,
    this.thumbnailUrl,
    this.linkUrl,
    this.activeNotifier,
    this.onVideoFinished,
    this.metaWidth,
    this.metaHeight,
    this.source = 'feed',
    this.title, // NEW
  });

  @override
  _PostCardState createState() => _PostCardState();
}

class _PostCardState extends State<PostCard>
    with SingleTickerProviderStateMixin {
  final currentUserId = FirebaseAuth.instance.currentUser!.uid;

  final GlobalKey<PopupMenuButtonState<String>> _menuKey = GlobalKey();

  bool isLiked = false;

  bool isSaved = false;

  late AnimationController _heartController;

  late Animation<double> _heartScaleAnimation;

  late Animation<double> _heartOpacityAnimation;

  bool _isHeartVisible = false;

  Timer? _watchTimer;

  int _watchSeconds = 0;

  @override
  void initState() {
    super.initState();

    isLiked = widget.likes.contains(currentUserId);

    // Log View (Impression)
    if (currentUserId.isNotEmpty) {
      _sendAlgorithmSignal('view', weight: 0.1);
    }

    _checkIfSaved();

    _heartController = AnimationController(
      vsync: this,

      duration: const Duration(milliseconds: 400),
    );

    _heartScaleAnimation = Tween<double>(begin: 0.5, end: 1.2).animate(
      CurvedAnimation(parent: _heartController, curve: Curves.elasticOut),
    );

    _heartOpacityAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(
        parent: _heartController,
        curve: const Interval(0.0, 0.2),
      ),
    );

    _heartController.addStatusListener((status) {
      if (status == AnimationStatus.completed) {
        Future.delayed(const Duration(milliseconds: 200), () {
          if (mounted) _heartController.reverse();
        });
      }

      if (status == AnimationStatus.dismissed) {
        if (mounted) setState(() => _isHeartVisible = false);
      }
    });
  }

  @override
  void dispose() {
    _heartController.dispose();

    _watchTimer?.cancel();

    super.dispose();
  }

  void _checkIfSaved() async {
    final doc = await FirebaseFirestore.instance
        .collection('users')
        .doc(currentUserId)
        .get();

    if (doc.exists && mounted) {
      List saved = doc.data()?['savedPosts'] ?? [];

      setState(() => isSaved = saved.contains(widget.postId));
    }
  }

  @override
  void didUpdateWidget(covariant PostCard oldWidget) {
    super.didUpdateWidget(oldWidget);

    if (widget.likes.length != oldWidget.likes.length) {
      if (mounted)
        setState(() => isLiked = widget.likes.contains(currentUserId));
    }
  }

  void _viewPostDetail() {
    Navigator.push(
      context,

      MaterialPageRoute(
        builder: (context) => PostDetailScreen(
          postId: widget.postId,
          userId: widget.userId,
          title: widget.title, // NEW
        ),
      ),
    );
  }

  void _startWatchTimer() {
    if (widget.mediaType != 'video') return;

    _watchTimer?.cancel();

    _watchSeconds = 0;

    _watchTimer = Timer.periodic(Duration(seconds: 1), (timer) {
      if (mounted) {
        _watchSeconds++;

        if (_watchSeconds % 5 == 0 && _watchSeconds > 0) {
          _sendAlgorithmSignal('watch_time', weight: _watchSeconds.toDouble());
        }
      }
    });
  }

  void _stopWatchTimer() {
    _watchTimer?.cancel();

    if (_watchSeconds >= 3) {
      _sendAlgorithmSignal('watch_time', weight: _watchSeconds.toDouble());
    }

    _watchSeconds = 0;
  }

  Future<void> _sendAlgorithmSignal(String type, {double weight = 1.0}) async {
    try {
      await PersonalizedFeedService().recordInteraction(
        type: type,

        postId: widget.postId,

        authorId: widget.userId,

        value: weight,
        source: widget.source, // Pass source
      );
    } catch (e) {}
  }

  Future<void> _handleDoubleTapLike() async {
    HapticFeedback.lightImpact();
    setState(() => _isHeartVisible = true);
    _heartController.reset();
    _heartController.forward();

    if (!isLiked) {
      setState(() => isLiked = true);

      final ref = FirebaseFirestore.instance
          .collection('posts')
          .doc(widget.postId);

      await ref.update({
        'likes': FieldValue.arrayUnion([currentUserId]),
      });

      _sendAlgorithmSignal('like', weight: 1.0);

      // --- SEND NOTIFICATION ---
      print(
        "PostCard: Attempting to send notification to author ${widget.userId}",
      );
      try {
        final userDoc = await FirebaseFirestore.instance
            .collection('users')
            .doc(currentUserId)
            .get();
        final likedByUsername = userDoc.data()?['username'] ?? 'Someone';
        print(
          "PostCard: Liked by $likedByUsername. Triggering notification service.",
        );

        NotificationService().sendLikeNotification(
          authorId: widget.userId,
          postId: widget.postId,
          likedByUsername: likedByUsername,
          postTitle: widget.caption,
          postMediaUrl: widget.mediaUrl,
        );
      } catch (e) {
        print("PostCard: Error sending like notification: $e");
      }
    }
  }

  Future<void> _toggleLike() async {
    HapticFeedback.mediumImpact();

    setState(() => isLiked = !isLiked);
    final ref = FirebaseFirestore.instance
        .collection('posts')
        .doc(widget.postId);
    if (isLiked) {
      print(
        "PostCard: Attempting to send notification to author ${widget.userId}",
      );
      await ref.update({
        'likes': FieldValue.arrayUnion([currentUserId]),
      });
      _sendAlgorithmSignal('like', weight: 1.0);

      // --- SEND NOTIFICATION ---
      try {
        final userDoc = await FirebaseFirestore.instance
            .collection('users')
            .doc(currentUserId)
            .get();
        final likedByUsername = userDoc.data()?['username'] ?? 'Someone';
        print(
          "PostCard: Liked by $likedByUsername. Triggering notification service.",
        );

        NotificationService().sendLikeNotification(
          authorId: widget.userId,
          postId: widget.postId,
          likedByUsername: likedByUsername,
          postTitle: widget.caption,
          postMediaUrl: widget.mediaUrl,
        );
      } catch (e) {
        print("PostCard: Error sending like notification: $e");
      }
    } else {
      await ref.update({
        'likes': FieldValue.arrayRemove([currentUserId]),
      });
    }
  }

  Future<void> _toggleSave() async {
    HapticFeedback.lightImpact();
    setState(() => isSaved = !isSaved);

    final userRef = FirebaseFirestore.instance
        .collection('users')
        .doc(currentUserId);
    final postRef = FirebaseFirestore.instance
        .collection('posts')
        .doc(widget.postId);

    if (isSaved) {
      await userRef.update({
        'savedPosts': FieldValue.arrayUnion([widget.postId]),
      });
      postRef.update({'saves': FieldValue.increment(1)}); // Increment Saves
      _sendAlgorithmSignal('save', weight: 2.0);
      _showMinimalSnack("Saved", AppColors.accentMustard);
    } else {
      await userRef.update({
        'savedPosts': FieldValue.arrayRemove([widget.postId]),
      });
      postRef.update({'saves': FieldValue.increment(-1)}); // Decrement Saves
    }
  }

  Future<void> _sharePost() async {
    final String deepLink = "https://femn-9cabb.web.app/post/${widget.postId}";

    // Formatting Text
    String desc = widget.caption;
    String shortDesc = desc.length > 35 ? '${desc.substring(0, 35)}...' : desc;
    String shareText =
        "$shortDesc\nSee more posts by ${widget.username} on Femn: $deepLink";

    _showMinimalSnack("Preparing share...", AppColors.primaryLavender);

    try {
      if (widget.mediaType == 'image') {
        // Download and Watermark Image
        final response = await HttpClient()
            .getUrl(Uri.parse(widget.mediaUrl))
            .then((r) => r.close());
        final bytes = await response.fold<List<int>>(
          [],
          (p, e) => p..addAll(e),
        );

        img.Image? originalImage = img.decodeImage(Uint8List.fromList(bytes));
        if (originalImage != null) {
          // Load logo from assets
          final logoData = await rootBundle.load('assets/watermark.png');
          img.Image? logo = img.decodeImage(logoData.buffer.asUint8List());

          if (logo != null) {
            // Resize logo to be ~10% of image width (smaller as requested)
            int logoW = (originalImage.width * 0.10).toInt();
            logo = img.copyResize(logo, width: logoW);

            // Composite logo at bottom right
            img.compositeImage(
              originalImage,
              logo,
              dstX: originalImage.width - logo.width - 20,
              dstY: originalImage.height - logo.height - 20,
            );
          }

          final tempDir = await getTemporaryDirectory();
          final watermarkedFile = File(
            '${tempDir.path}/femn_share_${widget.postId}.jpg',
          );
          await watermarkedFile.writeAsBytes(
            img.encodeJpg(originalImage, quality: 90),
          );

          await Share.shareXFiles([
            XFile(watermarkedFile.path),
          ], text: shareText);
        } else {
          await Share.share(shareText);
        }
      } else {
        await Share.share(shareText);
      }

      FirebaseFirestore.instance.collection('posts').doc(widget.postId).update({
        'shares': FieldValue.increment(1),
      });
      _sendAlgorithmSignal('share', weight: 2.5);
    } catch (e) {
      print("Share error: $e");
      await Share.share(shareText);
    }
  }

  Future<void> _downloadMedia() async {
    _showMinimalSnack("Downloading...", AppColors.primaryLavender);

    await Future.delayed(Duration(seconds: 1));

    _sendAlgorithmSignal('download', weight: 3.0);

    _showMinimalSnack("Saved to Gallery", Colors.green);
  }

  Future<void> _reportPost() async {
    await FirebaseFirestore.instance.collection('reports').add({
      'postId': widget.postId,

      'reporterId': currentUserId,

      'reason': 'User reported via feed menu',

      'timestamp': FieldValue.serverTimestamp(),

      'status': 'pending',
    });

    _sendAlgorithmSignal('report', weight: -5.0);

    _showMinimalSnack("Report submitted.", AppColors.error);
  }

  void _showMinimalSnack(String msg, Color color) {
    if (!mounted) return;

    ScaffoldMessenger.of(context).hideCurrentSnackBar();

    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(
          msg,
          style: TextStyle(
            color: Colors.white,
            fontSize: 12,
            fontWeight: FontWeight.bold,
          ),
        ),

        backgroundColor: color,

        behavior: SnackBarBehavior.floating,

        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),

        margin: EdgeInsets.all(12),

        duration: Duration(seconds: 1),
      ),
    );
  }

  void _showMoreLikeThis() async {
    final similarPosts = await PersonalizedFeedService().getSimilarPosts(
      widget.postId,
    );

    if (similarPosts.isNotEmpty) {
      showDialog(
        context: context,

        builder: (context) =>
            _MoreLikeThisDialog(posts: similarPosts, position: Offset(0, 0)),
      );
    } else {
      _showMinimalSnack(
        "Showing more like this soon!",
        AppColors.secondaryTeal,
      );
    }
  }

  void _showLessLikeThis() {
    _sendAlgorithmSignal('see_less', weight: -2.0);

    _showMinimalSnack("Showing less like this.", AppColors.textDisabled);

    if (widget.activeNotifier != null && widget.mediaType == 'video') {
      widget.onVideoFinished?.call();
    }
  }

  void _handleMenuAction(String value) {
    switch (value) {
      case 'Download':
        _downloadMedia();
        break;

      case 'SeeMore':
        _sendAlgorithmSignal('see_more', weight: 1.5);
        _showMoreLikeThis();
        break;

      case 'SeeLess':
        _showLessLikeThis();
        break;

      case 'Report':
        _reportPost();
        break;
    }
  }

  // Helper for opening link

  Future<void> _launchURL() async {
    if (widget.linkUrl != null && widget.linkUrl!.isNotEmpty) {
      final Uri uri = Uri.parse(widget.linkUrl!);
      if (!await launchUrl(uri, mode: LaunchMode.externalApplication)) {
        _showMinimalSnack("Could not open link", AppColors.error);
      } else {
        FirebaseFirestore.instance
            .collection('posts')
            .doc(widget.postId)
            .update({'linkClicks': FieldValue.increment(1)});
        _sendAlgorithmSignal('click_link', weight: 2.0);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    double? aspectRatio;

    if (widget.metaWidth != null &&
        widget.metaHeight != null &&
        widget.metaHeight! > 0) {
      aspectRatio = widget.metaWidth! / widget.metaHeight!;
    }

    Widget mediaWidget;

    if (widget.mediaType == 'video') {
      double videoRatio = aspectRatio ?? (9 / 16);

      mediaWidget = AspectRatio(
        aspectRatio: videoRatio,

        child: FemnVideoPlayer(
          videoUrl: widget.mediaUrl,

          thumbnailUrl: widget.thumbnailUrl,

          isPreview: true,

          postId: widget.postId,

          activeNotifier: widget.activeNotifier,

          onVideoFinished: widget.onVideoFinished,
        ),
      );
    } else {
      Widget image = CachedNetworkImage(
        imageUrl: widget.mediaUrl,

        width: double.infinity,

        fit: BoxFit.cover,

        // OPTIMIZATION: Reduce memCacheWidth.

        // 600 is okay for full width, but if grid is 2-columns, 350-400 is plenty.
        memCacheWidth: 400,

        maxWidthDiskCache: 600, // Keep disk cache higher quality

        placeholder: (context, url) =>
            Container(height: 200, color: AppColors.elevation),

        errorWidget: (context, url, error) => Container(
          height: 200,

          color: AppColors.elevation,
          child: const Icon(Feather.alert_circle, color: AppColors.error),
        ),
      );

      mediaWidget = aspectRatio != null
          ? AspectRatio(aspectRatio: aspectRatio, child: image)
          : image;
    }

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,

      mainAxisSize: MainAxisSize.min,

      children: [
        // --- MEDIA (Gestures) ---
        GestureDetector(
          onDoubleTap: _handleDoubleTapLike,

          onTap: _viewPostDetail,

          onLongPress: () {
            _menuKey.currentState?.showButtonMenu();
          },

          onLongPressStart: (_) => _startWatchTimer(),

          onLongPressEnd: (_) => _stopWatchTimer(),

          onLongPressCancel: _stopWatchTimer,

          child: Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(20),

              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.05),
                  blurRadius: 10,
                  offset: const Offset(0, 4),
                ),
              ],
            ),

            child: ClipRRect(
              borderRadius: BorderRadius.circular(20),

              child: ConstrainedBox(
                constraints: BoxConstraints(
                  maxHeight: MediaQuery.of(context).size.height * 0.75,
                ),

                child: Stack(
                  alignment: Alignment.center,

                  children: [
                    mediaWidget,

                    if (_isHeartVisible)
                      Positioned.fill(
                        child: Center(
                          child: ScaleTransition(
                            scale: _heartScaleAnimation,

                            child: FadeTransition(
                              opacity: _heartOpacityAnimation,

                              child: const Icon(
                                Ionicons.heart,
                                size: 100,
                                color: Colors.red,
                                shadows: [
                                  Shadow(
                                    color: Colors.black45,
                                    blurRadius: 15,
                                    offset: Offset(0, 4),
                                  ),
                                ],
                              ),
                            ),
                          ),
                        ),
                      ),
                  ],
                ),
              ),
            ),
          ),
        ),

        // --- BOTTOM ROW ---
        Padding(
          padding: const EdgeInsets.fromLTRB(4.0, 10.0, 0.0, 16.0),

          child: Row(
            crossAxisAlignment: CrossAxisAlignment.start,

            children: [
              if (widget.profileImage.isNotEmpty)
                CircleAvatar(
                  radius: 12,

                  backgroundImage: CachedNetworkImageProvider(
                    widget.profileImage,
                  ),

                  backgroundColor: AppColors.elevation,
                ),

              const SizedBox(width: 8),

              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,

                  children: [
                    Text(
                      widget.username,

                      style: const TextStyle(
                        fontWeight: FontWeight.bold,
                        fontSize: 12,
                        color: AppColors.textHigh,
                      ),

                      maxLines: 1,

                      overflow: TextOverflow.ellipsis,
                    ),

                    // --- DISPLAY LINK IF PRESENT ---
                    if (widget.linkUrl != null && widget.linkUrl!.isNotEmpty)
                      GestureDetector(
                        onTap: _launchURL,

                        child: Container(
                          margin: EdgeInsets.only(top: 4, bottom: 2),

                          padding: EdgeInsets.symmetric(
                            horizontal: 10,
                            vertical: 4,
                          ),

                          decoration: BoxDecoration(
                            color: AppColors.secondaryTeal.withOpacity(0.2),

                            borderRadius: BorderRadius.circular(12),

                            border: Border.all(
                              color: AppColors.secondaryTeal.withOpacity(0.5),
                            ),
                          ),

                          child: Row(
                            mainAxisSize: MainAxisSize.min,

                            children: [
                              Icon(
                                Feather.link,
                                size: 12,
                                color: AppColors.secondaryTeal,
                              ),

                              SizedBox(width: 6),

                              Text(
                                "Visit Website",

                                style: TextStyle(
                                  color: AppColors.secondaryTeal,
                                  fontSize: 11,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),

                              Icon(
                                Feather.chevron_right,
                                size: 12,
                                color: AppColors.secondaryTeal,
                              ),
                            ],
                          ),
                        ),
                      ),

                    if (widget.caption.isNotEmpty)
                      Padding(
                        padding: const EdgeInsets.only(top: 2.0),

                        child: Text(
                          widget.caption,

                          maxLines: 2,

                          overflow: TextOverflow.ellipsis,

                          style: const TextStyle(
                            fontSize: 12,
                            color: AppColors.textMedium,
                            height: 1.3,
                          ),
                        ),
                      ),
                  ],
                ),
              ),

              // --- MINIMAL MENU ---
              SizedBox(
                width: 24,

                height: 24,

                child: Theme(
                  data: Theme.of(context).copyWith(
                    highlightColor: Colors.transparent,

                    splashColor: Colors.transparent,
                  ),

                  child: PopupMenuButton<String>(
                    key: _menuKey,

                    onSelected: _handleMenuAction,

                    padding: EdgeInsets.zero,

                    tooltip: '',

                    icon: Icon(
                      Feather.more_horizontal,
                      size: 18,
                      color: AppColors.textDisabled,
                    ),

                    color: AppColors.surface,

                    elevation: 4,

                    shadowColor: Colors.black.withOpacity(0.5),

                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),

                      side: BorderSide(
                        color: AppColors.textDisabled.withOpacity(0.1),
                        width: 1,
                      ),
                    ),

                    offset: const Offset(0, 5),

                    itemBuilder: (BuildContext context) {
                      return [
                        // ICONS ROW (Like, Save, Share)
                        PopupMenuItem<String>(
                          enabled: false,

                          height: 40,

                          padding: EdgeInsets.zero,

                          child: Container(
                            padding: EdgeInsets.symmetric(vertical: 4),

                            child: Row(
                              mainAxisAlignment: MainAxisAlignment.spaceEvenly,

                              children: [
                                InkWell(
                                  onTap: () {
                                    _toggleLike();
                                    Navigator.pop(context);
                                  },
                                  child:
                                      Icon(
                                            isLiked
                                                ? Ionicons.heart
                                                : Ionicons.heart_outline,
                                            size: 26,
                                            color: isLiked
                                                ? AppColors.error
                                                : AppColors.textHigh,
                                          )
                                          .animate(target: isLiked ? 1 : 0)
                                          .scale(
                                            duration: 200.ms,
                                            curve: Curves.easeOutBack,
                                          )
                                          .shimmer(
                                            delay: 200.ms,
                                            duration: 800.ms,
                                            color: Colors.white24,
                                          ),
                                ),
                                InkWell(
                                  onTap: () {
                                    _toggleSave();
                                    Navigator.pop(context);
                                  },
                                  child:
                                      Icon(
                                            isSaved
                                                ? Ionicons.bookmark
                                                : Ionicons.bookmark_outline,
                                            size: 26,
                                            color: isSaved
                                                ? AppColors.accentMustard
                                                : AppColors.textHigh,
                                          )
                                          .animate(target: isSaved ? 1 : 0)
                                          .scale(
                                            duration: 200.ms,
                                            curve: Curves.easeOutBack,
                                          )
                                          .shimmer(
                                            delay: 200.ms,
                                            duration: 800.ms,
                                            color: Colors.white24,
                                          ),
                                ),
                                InkWell(
                                  onTap: () {
                                    _sharePost();
                                    Navigator.pop(context);
                                  },
                                  child: Icon(
                                    Feather.share_2,
                                    size: 26,
                                    color: AppColors.textHigh,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ),

                        PopupMenuItem(
                          height: 1,
                          enabled: false,
                          child: Divider(
                            height: 1,
                            color: AppColors.textDisabled.withOpacity(0.1),
                          ),
                        ),

                        _buildMinimalItem(
                          'Download',
                          Feather.download,
                          'Download',
                        ),

                        _buildMinimalItem('SeeMore', Feather.eye, 'See more'),

                        _buildMinimalItem(
                          'SeeLess',
                          Feather.eye_off,
                          'See less',
                        ),

                        PopupMenuItem(
                          height: 1,
                          enabled: false,
                          child: Divider(
                            height: 1,
                            color: AppColors.textDisabled.withOpacity(0.1),
                          ),
                        ),

                        _buildMinimalItem(
                          'Report',
                          Feather.alert_circle,
                          'Report',
                          activeColor: AppColors.error,
                        ),
                      ];
                    },
                  ),
                ),
              ),
            ],
          ),
        ),
      ],
    );
  }

  PopupMenuItem<String> _buildMinimalItem(
    String value,
    IconData icon,
    String text, {
    Color? activeColor,
  }) {
    final color = (activeColor != null && value == 'Report')
        ? activeColor
        : AppColors.textHigh;

    return PopupMenuItem<String>(
      value: value,

      height: 36,

      padding: EdgeInsets.symmetric(horizontal: 16),

      child: Row(
        children: [
          Icon(icon, size: 16, color: color),

          SizedBox(width: 12),

          Text(
            text,
            style: TextStyle(
              fontSize: 12,
              color: color,
              fontWeight: FontWeight.w500,
            ),
          ),
        ],
      ),
    );
  }
}

// More Like This Dialog

class _MoreLikeThisDialog extends StatelessWidget {
  final List<DocumentSnapshot> posts;

  final Offset position;

  const _MoreLikeThisDialog({required this.posts, required this.position});

  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        // Semi-transparent background
        Positioned.fill(
          child: GestureDetector(
            onTap: () => Navigator.pop(context),

            child: Container(color: Colors.black54),
          ),
        ),

        // Content near the tapped position
        Positioned(
          top: position.dy,

          left: position.dx,

          child: Container(
            width: 300,

            height: 400,

            decoration: BoxDecoration(
              color: AppColors.surface,

              borderRadius: BorderRadius.circular(16),

              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.3),

                  blurRadius: 20,

                  spreadRadius: 2,
                ),
              ],
            ),

            child: Column(
              children: [
                Padding(
                  padding: const EdgeInsets.all(12.0),

                  child: Text(
                    'More Like This',

                    style: TextStyle(
                      color: AppColors.textHigh,

                      fontWeight: FontWeight.bold,

                      fontSize: 16,
                    ),
                  ),
                ),

                Expanded(
                  child: ListView.builder(
                    itemCount: posts.length < 5 ? posts.length : 5,

                    itemBuilder: (context, index) {
                      final post = posts[index];

                      final data = post.data() as Map<String, dynamic>;

                      return ListTile(
                        leading: data['mediaType'] == 'image'
                            ? Image.network(
                                data['mediaUrl'],
                                width: 40,
                                height: 40,
                                fit: BoxFit.cover,
                              )
                            : data['thumbnailUrl'] != null
                            ? Image.network(
                                data['thumbnailUrl'],
                                width: 40,
                                height: 40,
                                fit: BoxFit.cover,
                              )
                            : Container(
                                width: 40,
                                height: 40,
                                color: AppColors.elevation,
                              ),

                        title: Text(
                          data['caption']?.toString().split('\n').first ??
                              'Post',

                          style: TextStyle(
                            color: AppColors.textHigh,
                            fontSize: 12,
                          ),

                          maxLines: 2,

                          overflow: TextOverflow.ellipsis,
                        ),

                        subtitle: Text(
                          '${(data['likes'] as List).length} likes',

                          style: TextStyle(
                            color: AppColors.textMedium,
                            fontSize: 10,
                          ),
                        ),

                        onTap: () {
                          Navigator.pop(context);

                          Navigator.push(
                            context,

                            MaterialPageRoute(
                              builder: (context) => PostDetailScreen(
                                postId: post.id,

                                userId: data['userId'],
                              ),
                            ),
                          );
                        },
                      );
                    },
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }
}

// Post Detail Screen - Updated Styling with Universal Colors

class PostDetailScreen extends StatefulWidget {
  final String postId;
  final String? userId;
  final String source; // NEW
  final String? title; // NEW

  const PostDetailScreen({
    required this.postId,
    this.userId,
    this.source = 'feed',
    this.title,
  });

  @override
  _PostDetailScreenState createState() => _PostDetailScreenState();
}

class _PostDetailScreenState extends State<PostDetailScreen> {
  final TextEditingController _commentController = TextEditingController();

  final FocusNode _commentFocusNode = FocusNode();

  final currentUserId = FirebaseAuth.instance.currentUser!.uid;

  bool _isSaved = false;

  bool _showCommentInput = false;
  String? _activeReplyToCommentId;
  String? _activeReplyToUserId;
  String? _activeReplyToUsername;

  Future<DocumentSnapshot>? _userDataFuture;

  @override
  void initState() {
    super.initState();

    _userDataFuture = FirebaseFirestore.instance
        .collection('users')
        .doc(widget.userId)
        .get();

    // Record view signal
    PersonalizedFeedService().recordInteraction(
      type: 'view',
      postId: widget.postId,
      authorId: widget.userId,
      source: widget.source,
      collection: 'posts',
    );

    _checkIfSaved();
  }

  @override
  void dispose() {
    _commentController.dispose();

    _commentFocusNode.dispose();

    super.dispose();
  }

  Future<void> _onRefresh() async {
    await Future.delayed(Duration(milliseconds: 500));
  }

  void _checkIfSaved() async {
    final userDoc = await FirebaseFirestore.instance
        .collection('users')
        .doc(currentUserId)
        .get();

    if (userDoc.exists) {
      final data = userDoc.data();
      final savedPosts = List<String>.from(data?['savedPosts'] ?? []);

      setState(() => _isSaved = savedPosts.contains(widget.postId));
    }
  }

  // Send algorithm signal for detail screen actions

  Future<void> _sendAlgorithmSignal(String type, {double weight = 1.0}) async {
    try {
      await PersonalizedFeedService().recordInteraction(
        type: type,

        postId: widget.postId,

        authorId: widget.userId,

        value: weight,
      );
    } catch (e) {
      // silent fail
    }
  }

  // Share post from detail screen
  Future<void> _sharePost(
    Map<String, dynamic> postData,
    Map<String, dynamic> userData,
  ) async {
    final String deepLink = "https://femn-9cabb.web.app/post/${widget.postId}";

    // Formatting Text
    String desc =
        postData['caption'] ??
        postData['description'] ??
        postData['question'] ??
        '';
    String shortDesc = desc.length > 35 ? '${desc.substring(0, 35)}...' : desc;
    String username = userData['username'] ?? 'Unknown';
    String shareText =
        "$shortDesc\nSee more posts by $username on Femn: $deepLink";

    _showMinimalSnack("Preparing share...", AppColors.primaryLavender);

    try {
      String mediaUrl =
          postData['mediaUrl'] ?? postData['bannerImageUrl'] ?? '';
      String mediaType = postData['mediaType'] ?? 'image';

      if (mediaType == 'image' && mediaUrl.isNotEmpty) {
        final response = await HttpClient()
            .getUrl(Uri.parse(mediaUrl))
            .then((r) => r.close());
        final bytes = await response.fold<List<int>>(
          [],
          (p, e) => p..addAll(e),
        );

        img.Image? originalImage = img.decodeImage(Uint8List.fromList(bytes));
        if (originalImage != null) {
          final logoData = await rootBundle.load('assets/watermark.png');
          img.Image? logo = img.decodeImage(logoData.buffer.asUint8List());

          if (logo != null) {
            int logoW = (originalImage.width * 0.10).toInt();
            logo = img.copyResize(logo, width: logoW);
            img.compositeImage(
              originalImage,
              logo,
              dstX: originalImage.width - logo.width - 20,
              dstY: originalImage.height - logo.height - 20,
            );
          }

          final tempDir = await getTemporaryDirectory();
          final watermarkedFile = File(
            '${tempDir.path}/femn_share_detail_${widget.postId}.jpg',
          );
          await watermarkedFile.writeAsBytes(
            img.encodeJpg(originalImage, quality: 90),
          );

          await Share.shareXFiles([
            XFile(watermarkedFile.path),
          ], text: shareText);
        } else {
          await Share.share(shareText);
        }
      } else {
        await Share.share(shareText);
      }

      _sendAlgorithmSignal('share', weight: 2.5);
    } catch (e) {
      print("Share error: $e");
      await Share.share(shareText);
    }
  }

  void _showMinimalSnack(String msg, Color color) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(
          msg,
          style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
        ),
        backgroundColor: color,
        behavior: SnackBarBehavior.floating,
        duration: const Duration(seconds: 2),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
        margin: const EdgeInsets.all(12),
      ),
    );
  }

  void _toggleSave() async {
    try {
      final userRef = FirebaseFirestore.instance
          .collection('users')
          .doc(currentUserId);

      if (_isSaved) {
        await userRef.update({
          'savedPosts': FieldValue.arrayRemove([widget.postId]),
        });
      } else {
        await userRef.update({
          'savedPosts': FieldValue.arrayUnion([widget.postId]),
        });
      }

      setState(() => _isSaved = !_isSaved);

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(
            _isSaved ? 'Post saved!' : 'Post removed from saved',
            style: TextStyle(color: AppColors.backgroundDeep),
          ),

          backgroundColor: AppColors.primaryLavender,
        ),
      );

      HapticFeedback.lightImpact();
      _sendAlgorithmSignal('save', weight: _isSaved ? 2.0 : 0);
    } catch (e) {
      print(e);
    }
  }

  void _addComment() async {
    if (_commentController.text.isEmpty) return;

    final String? replyToCommentId = _activeReplyToCommentId;
    final String? replyToUserId = _activeReplyToUserId;
    final String? replyToUsername = _activeReplyToUsername;

    try {
      final userDoc = await FirebaseFirestore.instance
          .collection('users')
          .doc(currentUserId)
          .get();

      final postDoc = await FirebaseFirestore.instance
          .collection('posts')
          .doc(widget.postId)
          .get();

      final postOwnerId = postDoc['userId'];
      final String? postMediaUrl = postDoc.data()!.containsKey('mediaUrl')
          ? postDoc['mediaUrl']
          : null;

      final commentsRef = FirebaseFirestore.instance
          .collection('posts')
          .doc(widget.postId)
          .collection('comments');

      await commentsRef.add({
        'userId': currentUserId,

        'username': userDoc['username'],

        'profileImage': userDoc['profileImage'],

        'text': _commentController.text,

        'timestamp': DateTime.now(),

        'replyToCommentId': replyToCommentId,

        'replyToUserId': replyToUserId,

        'replyToUsername': replyToUsername,

        'likes': [],
      });

      await FirebaseFirestore.instance
          .collection('posts')
          .doc(widget.postId)
          .update({'comments': FieldValue.increment(1)});

      // Send signal for comment

      _sendAlgorithmSignal('comment', weight: 2.5);

      // Notification logic (Unified with NotificationService)
      final String currentUsername = userDoc['username'] ?? 'Someone';
      final String commentText = _commentController.text;

      if (postOwnerId != currentUserId &&
          (replyToCommentId == null || replyToUserId != postOwnerId)) {
        await NotificationService().sendCommentNotification(
          authorId: postOwnerId,
          postId: widget.postId,
          commentedByUsername: currentUsername,
          commentText: commentText,
          postMediaUrl: postMediaUrl,
        );
      }

      if (replyToUserId != null && replyToUserId != currentUserId) {
        await NotificationService().sendReplyNotification(
          targetUserId: replyToUserId,
          postId: widget.postId,
          repliedByUsername: currentUsername,
          replyText: commentText,
          postMediaUrl: postMediaUrl,
        );
      }

      _commentController.clear();
      _activeReplyToCommentId = null;
      _activeReplyToUserId = null;
      _activeReplyToUsername = null;

      if (replyToCommentId == null) {
        _hideAndUnfocusCommentInput();
      }
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Error adding comment')));
    }
  }

  void _likeComment(
    String commentId,
    List<String> currentLikes,
    String commentOwnerId,
  ) async {
    try {
      final commentRef = FirebaseFirestore.instance
          .collection('posts')
          .doc(widget.postId)
          .collection('comments')
          .doc(commentId);

      if (currentLikes.contains(currentUserId)) {
        await commentRef.update({
          'likes': FieldValue.arrayRemove([currentUserId]),
        });
      } else {
        await commentRef.update({
          'likes': FieldValue.arrayUnion([currentUserId]),
        });

        // Send Notification
        if (commentOwnerId != currentUserId) {
          final userDoc = await FirebaseFirestore.instance
              .collection('users')
              .doc(currentUserId)
              .get();

          final postDoc = await FirebaseFirestore.instance
              .collection('posts')
              .doc(widget.postId)
              .get();

          await NotificationService().sendCommentLikeNotification(
            commentOwnerId: commentOwnerId,
            postId: widget.postId,
            likedByUsername: userDoc.data()?['username'] ?? 'Someone',
            postMediaUrl: postDoc.data()!.containsKey('mediaUrl')
                ? postDoc['mediaUrl']
                : null,
          );
        }
      }
    } catch (e) {
      print("Error liking comment: $e");
    }
  }

  void _showAndFocusCommentInput({
    String? replyToCommentId,
    String? replyToUserId,
    String? replyToUsername,
  }) {
    setState(() {
      _showCommentInput = true;
      _activeReplyToCommentId = replyToCommentId;
      _activeReplyToUserId = replyToUserId;
      _activeReplyToUsername = replyToUsername;
    });

    if (replyToUsername != null) {
      _commentController.text = '@$replyToUsername ';

      _commentController.selection = TextSelection.fromPosition(
        TextPosition(offset: _commentController.text.length),
      );
    }

    WidgetsBinding.instance.addPostFrameCallback(
      (_) => FocusScope.of(context).requestFocus(_commentFocusNode),
    );
  }

  void _hideAndUnfocusCommentInput() {
    setState(() => _showCommentInput = false);

    _commentController.clear();

    FocusScope.of(context).unfocus();
  }

  @override
  Widget build(BuildContext context) {
    return RefreshIndicator(
      color: AppColors.primaryLavender,

      backgroundColor: AppColors.surface,

      onRefresh: _onRefresh,

      child: StreamBuilder<DocumentSnapshot>(
        stream: FirebaseFirestore.instance
            .collection('posts')
            .doc(widget.postId)
            .snapshots(),

        builder: (context, postSnapshot) {
          if (postSnapshot.connectionState == ConnectionState.waiting &&
              !postSnapshot.hasData)
            return Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryLavender,
              ),
            );

          if (!postSnapshot.hasData || !postSnapshot.data!.exists) {
            // Only show 'not found' if we definitely have no data
            return Center(
              child: Text(
                'Post not found',
                style: TextStyle(color: AppColors.textHigh),
              ),
            );
          }

          final post = postSnapshot.data!;

          final postData = post.data() as Map<String, dynamic>;

          final likes = List<String>.from(postData['likes'] ?? []);

          final isLiked = likes.contains(currentUserId);

          final likeCount = likes.length;

          final commentCount = postData['comments'] ?? 0;

          return FutureBuilder<DocumentSnapshot>(
            future: _userDataFuture,

            builder: (context, userSnapshot) {
              if (!userSnapshot.hasData || !userSnapshot.data!.exists)
                return SizedBox();

              final userData =
                  userSnapshot.data!.data() as Map<String, dynamic>;

              return Scaffold(
                backgroundColor:
                    Colors.transparent, // Universal Deep background

                appBar: PreferredSize(
                  preferredSize: const Size.fromHeight(55),

                  child: AppBar(
                    backgroundColor: Colors.transparent,

                    elevation: 0,

                    shadowColor: Colors.transparent,

                    automaticallyImplyLeading: false,

                    leading: IconButton(
                      icon: const Icon(
                        Feather.chevron_left,
                        color: AppColors.primaryLavender,
                      ),

                      onPressed: () => Navigator.pop(context),
                    ),

                    title: Row(
                      children: [
                        // Avatar
                        GestureDetector(
                          onTap: () {
                            if (widget.userId == currentUserId) {
                              Navigator.push(
                                context,
                                MaterialPageRoute(
                                  builder: (_) =>
                                      ProfileScreen(userId: widget.userId!),
                                ),
                              );
                            } else {
                              Navigator.push(
                                context,
                                MaterialPageRoute(
                                  builder: (_) =>
                                      ProfileScreen(userId: widget.userId!),
                                ),
                              );
                            }
                          },

                          child: Container(
                            width: 42,

                            height: 42,

                            decoration: BoxDecoration(
                              shape: BoxShape.circle,

                              color: AppColors.elevation,

                              boxShadow: [
                                BoxShadow(
                                  color: Colors.black.withOpacity(0.2),

                                  blurRadius: 6,

                                  offset: const Offset(0, 2),
                                ),
                              ],
                            ),

                            child: ClipOval(
                              child:
                                  userData['profileImage'] != null &&
                                      userData['profileImage'].isNotEmpty
                                  ? Image(
                                      image: CachedNetworkImageProvider(
                                        userData['profileImage'],
                                      ),
                                      fit: BoxFit.cover,
                                    )
                                  : Image.asset(
                                      'assets/default_avatar.png',
                                      fit: BoxFit.cover,
                                    ),
                            ),
                          ),
                        ),

                        const SizedBox(width: 12),

                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,

                          mainAxisSize: MainAxisSize.min,

                          children: [
                            Text(
                              userData['username'] ?? 'Unknown',

                              style: const TextStyle(
                                fontWeight: FontWeight.bold,

                                fontSize: 14,

                                color:
                                    AppColors.textHigh, // Universal Off-white
                              ),
                            ),

                            Text(
                              timeago.format(
                                postData['timestamp']?.toDate() ??
                                    DateTime.now(),
                              ),

                              style: const TextStyle(
                                fontSize: 12,

                                color: AppColors
                                    .primaryLavender, // Universal Lavender timestamp

                                fontWeight: FontWeight.normal,
                              ),
                            ),
                          ],
                        ),

                        const Spacer(),

                        Container(
                          width: 42,

                          height: 42,

                          decoration: BoxDecoration(
                            shape: BoxShape.circle,

                            color: AppColors.elevation,

                            boxShadow: [
                              BoxShadow(
                                color: Colors.black.withOpacity(0.2),
                                blurRadius: 6,
                                offset: const Offset(0, 2),
                              ),
                            ],
                          ),

                          child: IconButton(
                            icon: const Icon(
                              Feather.more_vertical,
                              color: AppColors.primaryLavender,
                              size: 22,
                            ),

                            onPressed: () => _showPostOptions(
                              context,
                              post,
                              userSnapshot.data!,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),

                body: Column(
                  children: [
                    Expanded(
                      child: SingleChildScrollView(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,

                          children: [
                            // Post Media
                            Padding(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 16.0,
                                vertical: 8.0,
                              ),

                              child: ClipRRect(
                                borderRadius: BorderRadius.circular(16),

                                child: postData['mediaType'] == 'image'
                                    ? CachedNetworkImage(
                                        imageUrl: postData['mediaUrl'],

                                        width: double.infinity,

                                        fit: BoxFit.cover,

                                        placeholder: (context, url) =>
                                            Container(
                                              height: 300,

                                              color: AppColors.elevation,

                                              child: const Center(
                                                child:
                                                    CircularProgressIndicator(
                                                      color: AppColors
                                                          .primaryLavender,
                                                    ),
                                              ),
                                            ),

                                        errorWidget: (context, url, error) =>
                                            Container(
                                              height: 300,

                                              color: AppColors.elevation,

                                              child: const Icon(
                                                Feather.alert_circle,
                                                color: AppColors.error,
                                              ),
                                            ),
                                      )
                                    : FemnVideoPlayer(
                                        videoUrl: postData['mediaUrl'],

                                        thumbnailUrl:
                                            postData['thumbnailUrl'], // Uses thumbnail from Firestore if available
                                      ),
                              ),
                            ),

                            // Action Buttons
                            Padding(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 16.0,
                                vertical: 12.0,
                              ),

                              child: Row(
                                children: [
                                  IconButton(
                                    icon:
                                        Icon(
                                              isLiked
                                                  ? Ionicons.heart
                                                  : Ionicons.heart_outline,
                                              color: isLiked
                                                  ? AppColors.error
                                                  : AppColors.primaryLavender,
                                              size: 28,
                                            )
                                            .animate(target: isLiked ? 1 : 0)
                                            .scale(
                                              begin: const Offset(1, 1),
                                              end: const Offset(1.3, 1.3),
                                              duration: 200.ms,
                                              curve: Curves.easeOutBack,
                                            )
                                            .then()
                                            .scale(
                                              begin: const Offset(1.3, 1.3),
                                              end: const Offset(1.0, 1.0),
                                              duration: 100.ms,
                                            )
                                            .shimmer(
                                              delay: 200.ms,
                                              duration: 800.ms,
                                              color: Colors.white24,
                                            ),

                                    onPressed: () async {
                                      HapticFeedback.mediumImpact();

                                      final postRef = FirebaseFirestore.instance
                                          .collection('posts')
                                          .doc(widget.postId);

                                      if (!isLiked) {
                                        print(
                                          "PostDetailScreen: Attempting to send notification to author ${widget.userId}",
                                        );
                                        await postRef.update({
                                          'likes': FieldValue.arrayUnion([
                                            currentUserId,
                                          ]),
                                        });

                                        _sendAlgorithmSignal(
                                          'like',
                                          weight: 1.0,
                                        );

                                        // --- SEND NOTIFICATION ---
                                        try {
                                          final userDoc =
                                              await FirebaseFirestore.instance
                                                  .collection('users')
                                                  .doc(currentUserId)
                                                  .get();
                                          final likedByUsername =
                                              userDoc.data()?['username'] ??
                                              'Someone';
                                          print(
                                            "PostDetailScreen: Liked by $likedByUsername. Triggering notification service.",
                                          );

                                          NotificationService()
                                              .sendLikeNotification(
                                                authorId: widget.userId!,
                                                postId: widget.postId,
                                                likedByUsername:
                                                    likedByUsername,
                                                postTitle:
                                                    postData['caption'] ?? '',
                                                postMediaUrl:
                                                    postData['mediaUrl'], // Pass mediaUrl for thumb
                                              );
                                        } catch (e) {
                                          print(
                                            "PostDetailScreen: Error sending like notification: $e",
                                          );
                                        }
                                      } else {
                                        await postRef.update({
                                          'likes': FieldValue.arrayRemove([
                                            currentUserId,
                                          ]),
                                        });
                                      }
                                    },
                                  ),

                                  Text(
                                    '$likeCount',
                                    style: TextStyle(
                                      fontWeight: FontWeight.w500,
                                      color: AppColors.textHigh,
                                    ),
                                  ),

                                  const SizedBox(width: 16),

                                  IconButton(
                                    icon: Icon(
                                      Feather.message_circle,
                                      color: AppColors.primaryLavender,
                                      size: 28,
                                    ),

                                    onPressed: _showAndFocusCommentInput,
                                  ),

                                  Text(
                                    '$commentCount',
                                    style: TextStyle(
                                      fontWeight: FontWeight.w500,
                                      color: AppColors.textHigh,
                                    ),
                                  ),

                                  const SizedBox(width: 16),

                                  IconButton(
                                    icon: Icon(
                                      Feather.share_2,
                                      color: AppColors.primaryLavender,
                                      size: 28,
                                    ),

                                    onPressed: () =>
                                        _sharePost(postData, userData),
                                  ),

                                  const Spacer(),

                                  IconButton(
                                    icon:
                                        Icon(
                                              _isSaved
                                                  ? Ionicons.bookmark
                                                  : Ionicons.bookmark_outline,
                                              color: _isSaved
                                                  ? AppColors.accentMustard
                                                  : AppColors.primaryLavender,
                                              size: 28,
                                            )
                                            .animate(target: _isSaved ? 1 : 0)
                                            .scale(
                                              begin: const Offset(1, 1),
                                              end: const Offset(1.3, 1.3),
                                              duration: 200.ms,
                                              curve: Curves.easeOutBack,
                                            )
                                            .then()
                                            .scale(
                                              begin: const Offset(1.3, 1.3),
                                              end: const Offset(1.0, 1.0),
                                              duration: 100.ms,
                                            )
                                            .shimmer(
                                              delay: 200.ms,
                                              duration: 800.ms,
                                              color: Colors.white24,
                                            ),

                                    onPressed: _toggleSave,
                                  ),
                                ],
                              ),
                            ),

                            // Caption
                            if (postData['caption'] != null &&
                                postData['caption'].isNotEmpty)
                              Padding(
                                padding: const EdgeInsets.symmetric(
                                  horizontal: 16.0,
                                  vertical: 8.0,
                                ),

                                child: Text.rich(
                                  TextSpan(
                                    children: [
                                      TextSpan(
                                        text: '${userData['username']} ',

                                        style: const TextStyle(
                                          fontWeight: FontWeight.bold,
                                          color: AppColors.textHigh,
                                        ),
                                      ),

                                      TextSpan(
                                        text: postData['caption'],

                                        style: TextStyle(
                                          color: AppColors.textMedium,
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ),

                            // Comments Header
                            Padding(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 16.0,
                                vertical: 8.0,
                              ),

                              child: Text(
                                'Comments',

                                style: TextStyle(
                                  fontSize: 16,

                                  fontWeight: FontWeight.bold,

                                  color: AppColors.primaryLavender,
                                ),
                              ),
                            ),

                            // Comment Stream
                            StreamBuilder<QuerySnapshot>(
                              stream: FirebaseFirestore.instance
                                  .collection('posts')
                                  .doc(widget.postId)
                                  .collection('comments')
                                  .where('replyToCommentId', isNull: true)
                                  .orderBy('timestamp', descending: false)
                                  .snapshots(),

                              builder: (context, commentsSnapshot) {
                                if (!commentsSnapshot.hasData ||
                                    commentsSnapshot.data!.docs.isEmpty) {
                                  return Padding(
                                    padding: const EdgeInsets.symmetric(
                                      horizontal: 16.0,
                                      vertical: 12.0,
                                    ),

                                    child: Text(
                                      'No comments yet.',
                                      style: TextStyle(
                                        color: AppColors.textDisabled,
                                      ),
                                    ),
                                  );
                                }

                                return ListView.builder(
                                  shrinkWrap: true,

                                  physics: const NeverScrollableScrollPhysics(),

                                  itemCount: commentsSnapshot.data!.docs.length,

                                  itemBuilder: (context, index) {
                                    final comment =
                                        commentsSnapshot.data!.docs[index];

                                    final commentLikes = List<String>.from(
                                      comment['likes'] ?? [],
                                    );

                                    return _buildCommentItem(
                                      comment,

                                      commentLikes.length,

                                      commentLikes.contains(currentUserId),

                                      context,
                                    );
                                  },
                                );
                              },
                            ),
                          ],
                        ),
                      ),
                    ),

                    // Input Field
                    if (_showCommentInput)
                      Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 16,
                          vertical: 8,
                        ),

                        color: AppColors
                            .surface, // Universal Dark surface for input area

                        child: Row(
                          children: [
                            Expanded(
                              child: TextField(
                                controller: _commentController,

                                focusNode: _commentFocusNode,

                                style: TextStyle(color: AppColors.textHigh),

                                decoration: InputDecoration(
                                  hintText: 'Add a comment...',

                                  hintStyle: TextStyle(
                                    color: AppColors.textDisabled,
                                  ),

                                  filled: true,

                                  fillColor: AppColors.elevation,

                                  border: OutlineInputBorder(
                                    borderRadius: BorderRadius.circular(24),

                                    borderSide: BorderSide.none,
                                  ),

                                  contentPadding: const EdgeInsets.symmetric(
                                    horizontal: 16,
                                    vertical: 8,
                                  ),
                                ),

                                textInputAction: TextInputAction.send,

                                onSubmitted: (_) => _addComment(),
                              ),
                            ),

                            IconButton(
                              icon: const Icon(
                                Feather.send,
                                color: AppColors.primaryLavender,
                              ),

                              onPressed: () => _addComment(),
                            ),
                          ],
                        ),
                      ),
                  ],
                ),
              );
            },
          );
        },
      ),
    );
  }

  Widget _buildCommentItem(
    DocumentSnapshot comment,

    int likeCount,

    bool isLiked,

    BuildContext context, {

    int depth = 0,
  }) {
    final indent = depth > 0 ? 16.0 * depth : 0.0;

    final commentData = comment.data() as Map<String, dynamic>;

    final String commentUsername = commentData['username'] ?? 'Unknown';

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,

      children: [
        if (depth > 0)
          Padding(
            padding: EdgeInsets.only(left: indent - 16.0),

            child: Container(
              width: 2,
              height: 24,
              color: AppColors.textDisabled,
            ),
          ),

        Padding(
          padding: EdgeInsets.only(
            left: indent,
            right: 12.0,
            top: 6.0,
            bottom: 6.0,
          ),

          child: Container(
            decoration: BoxDecoration(
              color: AppColors
                  .surface, // Universal Surface color for comment cards

              borderRadius: BorderRadius.circular(16),
            ),

            padding: const EdgeInsets.all(12.0),

            child: Row(
              crossAxisAlignment: CrossAxisAlignment.start,

              children: [
                CircleAvatar(
                  radius: 28,

                  backgroundImage:
                      commentData['profileImage']?.isNotEmpty == true
                      ? CachedNetworkImageProvider(commentData['profileImage'])
                      : AssetImage('assets/default_avatar.png')
                            as ImageProvider,

                  backgroundColor: AppColors.elevation,
                ),

                SizedBox(width: 12),

                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,

                    children: [
                      Row(
                        children: [
                          Text(
                            commentUsername,

                            style: TextStyle(
                              fontWeight: FontWeight.bold,

                              fontSize: 14,

                              color: AppColors
                                  .primaryLavender, // Name in Universal Lavender
                            ),
                          ),

                          if (commentData['isVerified'] == true) ...[
                            SizedBox(width: 4),

                            Icon(
                              Feather.check_circle,
                              color: Colors.blue,
                              size: 16,
                            ),
                          ],
                        ],
                      ),

                      if (commentData['replyToUsername'] != null)
                        Text.rich(
                          TextSpan(
                            children: [
                              TextSpan(
                                text: 'Replying to ',
                                style: TextStyle(
                                  color: AppColors.textDisabled,
                                  fontSize: 12,
                                ),
                              ),

                              TextSpan(
                                text: '@${commentData['replyToUsername']}',

                                style: TextStyle(
                                  color: AppColors.secondaryTeal,
                                  fontSize: 12,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ],
                          ),
                        ),

                      SizedBox(height: 4),

                      Text(
                        commentData['text'],

                        style: TextStyle(
                          fontSize: 14,
                          color: AppColors.textMedium,
                        ),
                      ),

                      SizedBox(height: 6),

                      Row(
                        children: [
                          Text(
                            timeago.format(commentData['timestamp'].toDate()),

                            style: TextStyle(
                              color: AppColors.textDisabled,
                              fontSize: 12,
                              fontStyle: FontStyle.italic,
                            ),
                          ),

                          SizedBox(width: 16),

                          GestureDetector(
                            onTap: () => _likeComment(
                              comment.id,
                              List<String>.from(commentData['likes'] ?? []),
                              commentData['userId'],
                            ),

                            child: Text(
                              '$likeCount ${likeCount == 1 ? 'like' : 'likes'}',

                              style: TextStyle(
                                color: AppColors.primaryLavender,
                                fontSize: 12,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),

                Column(
                  mainAxisSize: MainAxisSize.min,

                  children: [
                    GestureDetector(
                      onTap: () => _likeComment(
                        comment.id,
                        List<String>.from(commentData['likes'] ?? []),
                        commentData['userId'],
                      ),

                      child: Icon(
                        isLiked ? Feather.heart : Feather.heart,

                        size: 24,

                        color: isLiked
                            ? AppColors.error
                            : AppColors.textDisabled,
                      ),
                    ),

                    SizedBox(height: 15),

                    GestureDetector(
                      onTap: () => _showAndFocusCommentInput(
                        replyToCommentId: comment.id,
                        replyToUserId: commentData['userId'],
                        replyToUsername: commentUsername,
                      ),

                      child: Icon(
                        Feather.corner_up_left,
                        size: 20,
                        color: AppColors.primaryLavender,
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ),

        // Nested Replies
        StreamBuilder<QuerySnapshot>(
          stream: FirebaseFirestore.instance
              .collection('posts')
              .doc(widget.postId)
              .collection('comments')
              .where('replyToCommentId', isEqualTo: comment.id)
              .orderBy('timestamp', descending: false)
              .snapshots(),

          builder: (context, repliesSnapshot) {
            if (!repliesSnapshot.hasData || repliesSnapshot.data!.docs.isEmpty)
              return SizedBox.shrink();

            return Padding(
              padding: EdgeInsets.only(left: 16.0 * (depth + 1)),

              child: Column(
                children: repliesSnapshot.data!.docs.map((reply) {
                  final replyLikes = List<String>.from(reply['likes'] ?? []);

                  return _buildCommentItem(
                    reply,
                    replyLikes.length,
                    replyLikes.contains(currentUserId),
                    context,

                    depth: depth + 1,
                  );
                }).toList(),
              ),
            );
          },
        ),
      ],
    );
  }

  Future<void> _deletePost(DocumentSnapshot post) async {
    // 1. Show Confirmation Dialog

    final bool? confirm = await showDialog<bool>(
      context: context,

      builder: (context) => AlertDialog(
        backgroundColor: AppColors.surface,

        title: const Text(
          'Delete Post',
          style: TextStyle(color: AppColors.textHigh),
        ),

        content: const Text(
          'Are you sure you want to delete this post? This action cannot be undone.',

          style: TextStyle(color: AppColors.textMedium),
        ),

        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false), // Cancel

            child: const Text(
              'Cancel',
              style: TextStyle(color: AppColors.textMedium),
            ),
          ),

          TextButton(
            onPressed: () => Navigator.pop(context, true), // Confirm

            child: const Text(
              'Delete',
              style: TextStyle(
                color: AppColors.error,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
        ],
      ),
    );

    if (confirm != true) return;

    // --- CRITICAL FIX START ---

    // Capture the Navigator and Messenger BEFORE the async gap.

    // If the widget disposes during the delete, 'context' becomes dead,

    // but these variables will remain valid.

    final navigator = Navigator.of(context);

    final scaffoldMessenger = ScaffoldMessenger.of(context);

    // --- CRITICAL FIX END ---

    try {
      // Show loading indicator

      showDialog(
        context: context,

        barrierDismissible: false,

        builder: (context) => const Center(
          child: CircularProgressIndicator(color: AppColors.primaryLavender),
        ),
      );

      final postData = post.data() as Map<String, dynamic>;

      final String mediaUrl = postData['mediaUrl'] ?? '';

      // 2. Delete the Image/Video from Storage (Cleanup)

      if (mediaUrl.isNotEmpty) {
        try {
          await FirebaseStorage.instance.refFromURL(mediaUrl).delete();
        } catch (e) {
          debugPrint("Error deleting storage file: $e");

          // Continue deleting the document even if storage fails
        }
      }

      // 3. Delete the Post Document from Firestore

      await FirebaseFirestore.instance
          .collection('posts')
          .doc(post.id)
          .delete();

      // 4. Close Loading Dialog (Use captured navigator)

      navigator.pop();

      // 5. Go back to Feed (Use captured navigator)

      navigator.pop();

      // 6. Show Success (Use captured messenger)

      scaffoldMessenger.showSnackBar(
        const SnackBar(
          content: Text('Post deleted successfully'),

          backgroundColor: AppColors.primaryLavender,
        ),
      );
    } catch (e) {
      // Close Loading Dialog if open

      navigator.pop();

      scaffoldMessenger.showSnackBar(
        SnackBar(
          content: Text('Error deleting post: $e'),

          backgroundColor: AppColors.error,
        ),
      );
    }
  }

  void _showPostOptions(
    BuildContext context,
    DocumentSnapshot post,
    DocumentSnapshot user,
  ) {
    showModalBottomSheet(
      context: context,

      backgroundColor: Colors.transparent,

      builder: (context) {
        return Container(
          margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),

          padding: const EdgeInsets.all(16),

          decoration: BoxDecoration(
            color: AppColors.surface, // Universal Surface

            borderRadius: BorderRadius.circular(16),

            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.3),
                blurRadius: 8,
                offset: const Offset(0, 2),
              ),
            ],
          ),

          child: Column(
            mainAxisSize: MainAxisSize.min,

            children: [
              if (post['userId'] == currentUserId)
                _buildOptionItem(
                  icon: Feather.trash,

                  iconColor: AppColors.error,

                  label: 'Delete Post',

                  labelColor: AppColors.error,

                  onTap: () {
                    Navigator.pop(context); // Close the bottom sheet

                    _deletePost(post); // <--- Call the new function here
                  },
                ),

              _buildOptionItem(
                icon: Feather.alert_circle,

                iconColor: AppColors.accentMustard,

                label: 'Report Post',

                labelColor: AppColors.accentMustard,

                onTap: () {
                  Navigator.pop(context);

                  // _reportPost(context, post, user);
                },
              ),

              _buildOptionItem(
                icon: Feather.share_2,

                iconColor: AppColors.primaryLavender,

                label: 'Share Post',

                onTap: () {
                  Navigator.pop(context); // Close the menu first

                  _sharePost(
                    post.data() as Map<String, dynamic>,
                    user.data() as Map<String, dynamic>,
                  );
                },
              ),

              const Divider(height: 24, color: AppColors.textDisabled),

              _buildOptionItem(
                icon: Feather.x,

                iconColor: AppColors.textDisabled,

                label: 'Cancel',

                labelColor: AppColors.textMedium,

                onTap: () => Navigator.pop(context),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildOptionItem({
    required IconData icon,

    Color iconColor = AppColors.textMedium,

    required String label,

    Color? labelColor,

    required VoidCallback onTap,
  }) {
    return InkWell(
      onTap: onTap,

      borderRadius: BorderRadius.circular(12),

      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 8),

        child: Row(
          children: [
            Container(
              width: 36,

              height: 36,

              decoration: BoxDecoration(
                color: AppColors.elevation,

                shape: BoxShape.circle,
              ),

              child: Icon(icon, color: iconColor, size: 20),
            ),

            SizedBox(width: 16),

            Text(
              label,

              style: TextStyle(
                fontSize: 14,

                fontWeight: FontWeight.w500,

                color: labelColor ?? AppColors.textHigh,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// ======== UNIFIED VIDEO PLAYER COMPONENT ========

// ======== UNIFIED VIDEO PLAYER COMPONENT ========
class FemnVideoPlayer extends StatefulWidget {
  final String videoUrl;
  final String? thumbnailUrl;
  final bool isFullScreen;
  // --- Preview Props ---
  final bool isPreview; // true for Feed, false for Detail
  final String? postId;
  final ValueNotifier<String?>? activeNotifier;
  final VoidCallback? onVideoFinished;

  const FemnVideoPlayer({
    Key? key, // Good practice to add Key
    required this.videoUrl,
    // Removed duplicate line here
    this.thumbnailUrl,
    this.isFullScreen = false,
    this.isPreview = false,
    this.postId,
    this.activeNotifier,
    this.onVideoFinished,
  }) : super(key: key);

  @override
  _FemnVideoPlayerState createState() => _FemnVideoPlayerState();
}

class _FemnVideoPlayerState extends State<FemnVideoPlayer> {
  late VideoPlayerController _controller;
  bool _isInitialized = false;
  bool _showControls = true;
  Timer? _hideTimer;
  Timer? _previewTimer;
  bool _isFastForwarding = false;

  @override
  void initState() {
    super.initState();
    if (widget.isPreview) {
      widget.activeNotifier?.addListener(_checkPreviewStatus);
    } else {
      _initializeFullVideo();
    }
  }

  // --- PREVIEW LOGIC (Feed) ---
  void _checkPreviewStatus() {
    final isActive = widget.activeNotifier?.value == widget.postId;
    if (isActive) {
      _initializePreviewVideo();
    } else {
      _disposeController();
    }
  }

  Future<void> _initializePreviewVideo() async {
    if (_controller.value.isInitialized) return;
    _controller = VideoPlayerController.networkUrl(Uri.parse(widget.videoUrl));
    try {
      await _controller.initialize();
      _controller.setVolume(0.0); // Muted for feed
      if (widget.activeNotifier?.value == widget.postId) {
        if (mounted) setState(() => _isInitialized = true);
        await _controller.play();
        // Start 5s Timer
        _previewTimer?.cancel();
        _previewTimer = Timer(const Duration(seconds: 5), () {
          if (mounted) {
            _disposeController();
            widget.onVideoFinished?.call();
          }
        });
      } else {
        _disposeController();
      }
    } catch (e) {
      _disposeController();
      widget.onVideoFinished?.call();
    }
  }

  // --- FULL PLAYER LOGIC (Detail) ---
  Future<void> _initializeFullVideo() async {
    _controller = VideoPlayerController.networkUrl(Uri.parse(widget.videoUrl));
    try {
      await _controller.initialize();
      if (mounted) setState(() => _isInitialized = true);
      _controller.play();
      _controller.setLooping(true);
      _startHideTimer();
      _controller.addListener(() {
        if (mounted) setState(() {});
      });
    } catch (e) {
      debugPrint("Video Error: $e");
    }
  }

  @override
  void dispose() {
    widget.activeNotifier?.removeListener(_checkPreviewStatus);
    _hideTimer?.cancel();
    _previewTimer?.cancel();
    _controller.dispose();
    super.dispose();
  }

  void _disposeController() {
    _previewTimer?.cancel();
    if (_isInitialized) {
      _controller.dispose();
      _controller = VideoPlayerController.networkUrl(
        Uri.parse(widget.videoUrl),
      ); // Reset
      if (mounted) setState(() => _isInitialized = false);
    }
  }

  void _startHideTimer() {
    _hideTimer?.cancel();
    _hideTimer = Timer(const Duration(seconds: 3), () {
      if (mounted && _controller.value.isPlaying)
        setState(() => _showControls = false);
    });
  }

  void _toggleControls() {
    setState(() {
      _showControls = !_showControls;
      if (_showControls) _startHideTimer();
    });
  }

  void _togglePlay() {
    setState(() {
      _controller.value.isPlaying ? _controller.pause() : _controller.play();
      _showControls = true;
      _startHideTimer();
    });
  }

  String _formatDuration(Duration duration) {
    String twoDigits(int n) => n.toString().padLeft(2, "0");
    return "${twoDigits(duration.inMinutes.remainder(60))}:${twoDigits(duration.inSeconds.remainder(60))}";
  }

  void _enterFullScreen(BuildContext context) {
    _controller.pause();
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => Scaffold(
          backgroundColor: Colors.black,
          body: Center(
            child: FemnVideoPlayer(
              videoUrl: widget.videoUrl,
              thumbnailUrl: widget.thumbnailUrl,
              isFullScreen: true,
            ),
          ),
        ),
      ),
    ).then((_) => _controller.play());
  }

  @override
  Widget build(BuildContext context) {
    // 1. FEED PREVIEW MODE
    if (widget.isPreview) {
      return Stack(
        fit: StackFit.expand,
        alignment: Alignment.center,
        children: [
          // Thumbnail (Always visible until video covers it)
          if (widget.thumbnailUrl != null)
            Image(
              image: CachedNetworkImageProvider(widget.thumbnailUrl!),
              fit: BoxFit.cover,
            )
          else
            Container(color: Colors.black),
          // Video
          if (_isInitialized)
            SizedBox.expand(
              child: FittedBox(
                fit: BoxFit.cover,
                child: SizedBox(
                  width: _controller.value.size.width,
                  height: _controller.value.size.height,
                  child: VideoPlayer(_controller),
                ),
              ),
            ),
          // Tiny Play Icon (Bottom Left Indicator)
          const Positioned(
            bottom: 10,
            left: 10,
            child: Icon(
              Feather.play, // Simple play icon
              color: Colors.white,
              size: 24,
              shadows: [
                Shadow(
                  blurRadius: 4,
                  color: Colors.black54,
                  offset: Offset(0, 1),
                ),
              ],
            ),
          ),
        ],
      );
    }
    // 2. FULL PLAYER (Detail Mode)
    return LayoutBuilder(
      builder: (context, constraints) {
        Widget playerStack = Stack(
          fit: StackFit.expand,
          children: [
            if (widget.thumbnailUrl != null)
              Image(
                image: CachedNetworkImageProvider(widget.thumbnailUrl!),
                fit: BoxFit.cover,
              )
            else
              Container(color: Colors.black),
            if (_isInitialized)
              SizedBox.expand(
                child: FittedBox(
                  fit: BoxFit.cover,
                  child: SizedBox(
                    width: _controller.value.size.width,
                    height: _controller.value.size.height,
                    child: VideoPlayer(_controller),
                  ),
                ),
              ),
            if (_isInitialized)
              AnimatedOpacity(
                opacity: _showControls ? 1.0 : 0.0,
                duration: const Duration(milliseconds: 300),
                child: IgnorePointer(
                  ignoring: !_showControls,
                  child: Container(
                    color: Colors.black26,
                    child: Column(
                      children: [
                        const Spacer(),
                        IconButton(
                          iconSize: 60,
                          icon: Icon(
                            _controller.value.isPlaying
                                ? Feather.pause_circle
                                : Feather.play_circle,
                            color: Colors.white,
                          ),
                          onPressed: _togglePlay,
                        ),
                        const Spacer(),
                        _buildBottomBar(context),
                      ],
                    ),
                  ),
                ),
              ),
            if (!_isInitialized)
              const Center(
                child: CircularProgressIndicator(
                  color: AppColors.primaryLavender,
                ),
              ),
          ],
        );
        Widget gestureWrapper = GestureDetector(
          onDoubleTap: _togglePlay,
          onTap: _toggleControls,
          onLongPress: () {
            setState(() => _isFastForwarding = true);
            _controller.setPlaybackSpeed(2.0);
          },
          onLongPressUp: () {
            setState(() => _isFastForwarding = false);
            _controller.setPlaybackSpeed(1.0);
          },
          child: playerStack,
        );
        if (constraints.maxHeight == double.infinity) {
          return AspectRatio(aspectRatio: 9 / 16, child: gestureWrapper);
        }
        return gestureWrapper;
      },
    );
  }

  Widget _buildBottomBar(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
      decoration: const BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.bottomCenter,
          end: Alignment.topCenter,
          colors: [Colors.black87, Colors.transparent],
        ),
      ),
      child: Row(
        children: [
          Text(
            _formatDuration(_controller.value.position),
            style: const TextStyle(color: Colors.white, fontSize: 12),
          ),
          Expanded(
            child: Slider(
              value: _controller.value.position.inSeconds.toDouble(),
              max: _controller.value.duration.inSeconds.toDouble(),
              onChanged: (val) {
                _controller.seekTo(Duration(seconds: val.toInt()));
                _startHideTimer();
              },
            ),
          ),
          Text(
            _formatDuration(_controller.value.duration),
            style: const TextStyle(color: Colors.white, fontSize: 12),
          ),
          if (!widget.isFullScreen)
            IconButton(
              icon: const Icon(Feather.maximize, color: Colors.white, size: 20),
              onPressed: () => _enterFullScreen(context),
            ),
        ],
      ),
    );
  }
}

class FeedPostWrapper extends StatefulWidget {
  final DocumentSnapshot postDoc;
  final ValueNotifier<String?>? activeNotifier;
  final VoidCallback? onVideoFinished;
  final Map<String, dynamic>? cachedUserData; // Added this parameter

  const FeedPostWrapper({
    Key? key,
    required this.postDoc,
    this.activeNotifier,
    this.onVideoFinished,
    this.cachedUserData, // Added this to constructor
  }) : super(key: key);

  @override
  _FeedPostWrapperState createState() => _FeedPostWrapperState();
}

class _FeedPostWrapperState extends State<FeedPostWrapper>
    with AutomaticKeepAliveClientMixin {
  Map<String, dynamic>? _userData;

  @override
  bool get wantKeepAlive => true;

  @override
  void initState() {
    super.initState();
    _userData = widget.cachedUserData;
    if (_userData == null) {
      _fetchUser();
    }
  }

  void _fetchUser() async {
    try {
      final postData = widget.postDoc.data() as Map<String, dynamic>;
      final userId = postData['userId'] ?? postData['createdBy'];
      if (userId == null) return;
      final userSnap = await FirebaseFirestore.instance
          .collection('users')
          .doc(userId)
          .get();
      if (userSnap.exists && mounted) {
        setState(() {
          _userData = userSnap.data() as Map<String, dynamic>;
        });
      }
    } catch (e) {}
  }

  @override
  Widget build(BuildContext context) {
    super.build(context);

    if (_userData == null) {
      return Shimmer.fromColors(
        baseColor: AppColors.elevation,
        highlightColor: AppColors.surface,
        child: Container(
          height: 200,
          margin: const EdgeInsets.only(bottom: 12),
          decoration: BoxDecoration(
            color: AppColors.elevation,
            borderRadius: BorderRadius.circular(20),
          ),
        ),
      );
    }

    final postData = widget.postDoc.data() as Map<String, dynamic>;
    final collection = widget.postDoc.reference.parent.id;

    if (collection == 'petitions') {
      return PetitionFeedCard(petition: widget.postDoc, userData: _userData!);
    }

    if (collection == 'polls') {
      return PollCard(
        pollSnapshot: widget.postDoc,
        cardMarginVertical: 0,
        cardMarginHorizontal: 0,
        cardInternalPadding: 16,
        borderRadiusValue: 20,
      );
    }

    double? metaW;
    double? metaH;
    if (postData['width'] != null)
      metaW = (postData['width'] as num).toDouble();
    if (postData['height'] != null)
      metaH = (postData['height'] as num).toDouble();

    return PostCard(
      postId: widget.postDoc.id,
      userId: postData['userId'] ?? postData['createdBy'],
      username: _userData!['username'] ?? 'Unknown',
      profileImage: _userData!['profileImage'] ?? '',
      mediaUrl: postData['mediaUrl'] ?? postData['bannerImageUrl'] ?? '',
      caption:
          postData['caption'] ??
          postData['description'] ??
          postData['question'] ??
          '',
      likes: List<String>.from(postData['likes'] ?? []),
      timestamp:
          postData['timestamp']?.toDate() ??
          postData['createdAt']?.toDate() ??
          DateTime.now(),
      mediaType: postData['mediaType'] ?? 'image',
      thumbnailUrl: postData['thumbnailUrl'],
      linkUrl: postData['linkUrl'],
      activeNotifier: widget.activeNotifier,
      onVideoFinished: widget.onVideoFinished,
      metaWidth: metaW,
      metaHeight: metaH,
      title: postData['title'],
    );
  }
}

// --- Modern Card Widgets for Feed ---

class TrendingPetitionCard extends StatelessWidget {
  final DocumentSnapshot petition;
  const TrendingPetitionCard({Key? key, required this.petition})
    : super(key: key);

  @override
  Widget build(BuildContext context) {
    final data = petition.data() as Map<String, dynamic>;
    final imageUrl = data['bannerImageUrl'] ?? '';
    final title = data['title'] ?? 'Untitled';
    final signatures = data['currentSignatures'] ?? 0;
    final goal = data['goal'] ?? 1000;
    final progress = (signatures / (goal > 0 ? goal : 1000)).clamp(0.0, 1.0);

    return GestureDetector(
      onTap: () => Navigator.push(
        context,
        MaterialPageRoute(
          builder: (c) => EnhancedPetitionDetailScreen(petitionId: petition.id),
        ),
      ),
      child: Container(
        width: 180,
        margin: const EdgeInsets.only(right: 12),
        decoration: BoxDecoration(
          color: AppColors.surface,
          borderRadius: BorderRadius.circular(20),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.1),
              blurRadius: 10,
              offset: Offset(0, 4),
            ),
          ],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Expanded(
              flex: 3,
              child: ClipRRect(
                borderRadius: const BorderRadius.vertical(
                  top: Radius.circular(20),
                ),
                child: imageUrl.isNotEmpty
                    ? CachedNetworkImage(
                        imageUrl: imageUrl,
                        fit: BoxFit.cover,
                        width: double.infinity,
                      )
                    : Container(
                        color: AppColors.elevation,
                        child: const Icon(
                          Feather.flag,
                          color: AppColors.primaryLavender,
                        ),
                      ),
              ),
            ),
            // Live Progress Bar (The divider)
            LinearProgressIndicator(
              value: progress.toDouble(),
              backgroundColor: AppColors.elevation,
              valueColor: const AlwaysStoppedAnimation<Color>(
                AppColors.secondaryTeal,
              ),
              minHeight: 3,
            ),
            Expanded(
              flex: 1,
              child: Padding(
                padding: const EdgeInsets.fromLTRB(10, 8, 10, 8),
                child: Text(
                  title,
                  style: const TextStyle(
                    color: AppColors.textHigh,
                    fontWeight: FontWeight.bold,
                    fontSize: 12,
                    height: 1.2,
                  ),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class PetitionFeedCard extends StatelessWidget {
  final DocumentSnapshot petition;
  final Map<String, dynamic> userData;

  const PetitionFeedCard({
    Key? key,
    required this.petition,
    required this.userData,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final data = petition.data() as Map<String, dynamic>;
    final imageUrl = data['bannerImageUrl'] ?? '';
    final signatures = data['currentSignatures'] ?? 0;
    final goal = data['goal'] ?? 1000;
    final progress = (signatures / (goal > 0 ? goal : 1000)).clamp(0.0, 1.0);

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      mainAxisSize: MainAxisSize.min,
      children: [
        GestureDetector(
          onTap: () => Navigator.push(
            context,
            MaterialPageRoute(
              builder: (c) =>
                  EnhancedPetitionDetailScreen(petitionId: petition.id),
            ),
          ),
          child: Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(20),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.05),
                  blurRadius: 10,
                  offset: const Offset(0, 4),
                ),
              ],
            ),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(20),
              child: Column(
                children: [
                  if (imageUrl.isNotEmpty)
                    CachedNetworkImage(
                      imageUrl: imageUrl,
                      fit: BoxFit.cover,
                      width: double.infinity,
                      height: 180, // Slightly taller to match post feel
                      memCacheWidth: 400,
                    )
                  else
                    Container(
                      height: 150,
                      color: AppColors.elevation,
                      child: const Center(
                        child: Icon(
                          Feather.flag,
                          color: AppColors.primaryLavender,
                          size: 30,
                        ),
                      ),
                    ),
                  // Progress Bar - The distinguishing factor
                  LinearProgressIndicator(
                    value: progress.toDouble(),
                    backgroundColor: AppColors.elevation,
                    valueColor: const AlwaysStoppedAnimation<Color>(
                      AppColors.secondaryTeal,
                    ),
                    minHeight: 6,
                  ),
                ],
              ),
            ),
          ),
        ),
        // Bottom Row matching PostCard
        Padding(
          padding: const EdgeInsets.fromLTRB(4.0, 10.0, 0.0, 16.0),
          child: Row(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              if (userData['profileImage'] != null &&
                  userData['profileImage'].toString().isNotEmpty)
                CircleAvatar(
                  radius: 12,
                  backgroundImage: CachedNetworkImageProvider(
                    userData['profileImage'],
                  ),
                  backgroundColor: AppColors.elevation,
                )
              else
                CircleAvatar(
                  radius: 12,
                  backgroundColor: AppColors.elevation,
                  child: const Icon(
                    Feather.user,
                    size: 14,
                    color: AppColors.textDisabled,
                  ),
                ),
              const SizedBox(width: 8),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      userData['username'] ?? 'Anonymous',
                      style: const TextStyle(
                        fontWeight: FontWeight.bold,
                        fontSize: 12,
                        color: AppColors.textHigh,
                      ),
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                    ),
                    const SizedBox(height: 2),
                    Text(
                      data['title'] ?? 'Petition',
                      style: const TextStyle(
                        fontWeight: FontWeight.bold,
                        fontSize: 11,
                        color: AppColors.primaryLavender,
                      ),
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                    ),
                    const SizedBox(height: 2),
                    Text(
                      data['description'] ?? '',
                      style: const TextStyle(
                        fontSize: 11,
                        color: AppColors.textMedium,
                        height: 1.3,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ],
    );
  }
}

// PollFeedCard removed and replaced with direct usage of PollCard from circle/polls.dart

// Place this outside any class, or in a utils file
double snapToAllowedRatio(double rawRatio) {
  // The allowed ratios you specified
  const List<double> allowedRatios = [
    1.0, // 1:1
    2.0, // 2:1
    0.5, // 1:2
    3.0, // 3:1
    4.0 / 3.0, // 4:3
    3.0 / 2.0, // 3:2
    2.0 / 3.0, // 2:3
    16.0 / 9.0, // 16:9
    9.0 / 16.0, // 9:16
  ];

  // Find the closest allowed ratio to the input
  return allowedRatios.reduce((a, b) {
    return (rawRatio - a).abs() < (rawRatio - b).abs() ? a : b;
  });
}

class _StickyTabBarDelegate extends SliverPersistentHeaderDelegate {
  final Widget child;
  final double minHeight;
  final double maxHeight;
  final double topPadding;
  final bool isScrolled;

  _StickyTabBarDelegate({
    required this.child,
    required this.minHeight,
    required this.maxHeight,
    required this.topPadding,
    required this.isScrolled,
  });

  @override
  double get minExtent => minHeight + topPadding;

  @override
  double get maxExtent => maxHeight + topPadding;

  @override
  Widget build(
    BuildContext context,
    double shrinkOffset,
    bool overlapsContent,
  ) {
    // To match Circle screen spacing:
    // When the top bar is visible (floating), this header should sit directly below it with NO extra padding.
    // When pinned, it must shift down to clear the status bar.

    // overlapsContent is true when we are pinned and content is scrollable behind us.
    final bool isPinned =
        overlapsContent || shrinkOffset > (topPadding > 0 ? topPadding : 1);

    // Background visibility: match the SliverAppBar (isScrolled)
    final double backgroundOpacity = (isScrolled || isPinned) ? 0.95 : 0.0;

    return Container(
      // We keep the container height at maxExtent (45 + topPadding)
      // but we align the content so the gap matches.
      height: maxExtent,
      child: Stack(
        fit: StackFit.expand,
        children: [
          // Background Backdrop (Glassmorphism)
          if (backgroundOpacity > 0)
            Positioned.fill(
              child: ClipRect(
                child: BackdropFilter(
                  filter: ui.ImageFilter.blur(sigmaX: 10, sigmaY: 10),
                  child: Container(
                    color: AppColors.backgroundDeep.withOpacity(0.8),
                  ),
                ),
              ),
            ),

          // Content alignment
          // When not pinned (floating bar visible), align to TOP to be flush with SliverAppBar bottom.
          // When pinned, align to BOTTOM of the (45 + topPadding) box to clear the notch.
          Align(
            alignment: isPinned ? Alignment.bottomCenter : Alignment.topCenter,
            child: SizedBox(height: minHeight, child: child),
          ),
        ],
      ),
    );
  }

  @override
  bool shouldRebuild(_StickyTabBarDelegate oldDelegate) {
    return maxHeight != oldDelegate.maxHeight ||
        minHeight != oldDelegate.minHeight ||
        child != oldDelegate.child ||
        topPadding != oldDelegate.topPadding ||
        isScrolled != oldDelegate.isScrolled;
  }
}

class FeedShimmerSkeleton extends StatelessWidget {
  const FeedShimmerSkeleton({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return const SliverGridShimmerSkeleton();
  }
}


--- C:\Code\femn\lib\hub_screens\profile.dart ---

import 'dart:async';
import 'dart:io';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:femn/auth/auth.dart';
import 'package:femn/hub_screens/post.dart';
import 'package:femn/customization/colors.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:flutter_staggered_grid_view/flutter_staggered_grid_view.dart';
import 'package:femn/customization/layout.dart';
import 'package:image_picker/image_picker.dart';
import '../feed/addpost.dart';
import 'settings.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:video_player/video_player.dart';

import '../../feed/upload_service.dart';
import 'package:femn/circle/petitions.dart';
import 'package:femn/circle/polls.dart';
import 'package:femn/circle/groups.dart';
import 'package:femn/circle/discussions.dart';
import 'package:femn/analytics/screens/analytics_dashboard.dart'; // <--- Analytics Import
import 'package:rxdart/rxdart.dart';
import 'package:shimmer/shimmer.dart';
import 'package:femn/services/notification_service.dart';

// ======== AccountBadge Widget ========
class AccountBadge extends StatelessWidget {
  final String accountType;
  final bool isVerified;
  const AccountBadge({required this.accountType, required this.isVerified});

  @override
  Widget build(BuildContext context) {
    IconData icon;
    Color color;
    String label;
    switch (accountType) {
      case 'organization':
        icon = isVerified ? Feather.check_circle : Feather.briefcase;
        color = isVerified ? Colors.blueAccent : Colors.greenAccent;
        label = isVerified ? 'Verified Organization' : 'Organization';
        break;
      case 'therapist':
        icon = isVerified ? Feather.check_circle : Feather.activity;
        color = isVerified ? Colors.blueAccent : Colors.purpleAccent;
        label = isVerified ? 'Verified Therapist' : 'Therapist';
        break;
      default:
        icon = Feather.user;
        color = AppColors.textMedium;
        label = 'Personal';
    }
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: color.withOpacity(0.1),
        borderRadius: BorderRadius.circular(20),
        border: Border.all(color: color.withOpacity(0.3)),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, size: 16, color: color),
          const SizedBox(width: 4),
          Text(
            label,
            style: TextStyle(
              fontSize: 12,
              fontWeight: FontWeight.w600,
              color: color,
            ),
          ),
        ],
      ),
    );
  }
}

// ======== Post Grid With Preview Logic (Orchestrator) ========
enum ProfileTabType { activity, saved, liked, polls, petitions }

class PostGridWithPreview extends StatefulWidget {
  final String userId;
  final bool isOwnProfile;
  final Widget? createPostButton;
  final ProfileTabType tabType;

  const PostGridWithPreview({
    required this.userId,
    required this.isOwnProfile,
    this.createPostButton,
    this.tabType = ProfileTabType.activity,
  });

  @override
  _PostGridWithPreviewState createState() => _PostGridWithPreviewState();
}

class _PostGridWithPreviewState extends State<PostGridWithPreview> {
  final ValueNotifier<String?> _activeVideoIdNotifier = ValueNotifier(null);
  List<Map<String, dynamic>> _combinedItems = [];
  int _currentSequenceIndex = 0;
  List<String> _videoIds = [];

  // ADDED: Listener for Upload Service
  @override
  void initState() {
    super.initState();
    PostUploadService.instance.addListener(_onUploadStateChanged);
  }

  @override
  void dispose() {
    PostUploadService.instance.removeListener(_onUploadStateChanged);
    _activeVideoIdNotifier.dispose();
    super.dispose();
  }

  // Handle Error Popups here
  void _onUploadStateChanged() {
    final service = PostUploadService.instance;
    if (service.status == UploadStatus.error && service.errorMessage != null) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(service.errorMessage!),
            backgroundColor: AppColors.error,
            duration: Duration(seconds: 4),
          ),
        );
        service.consumeError(); // Reset service state
      }
    }
    // Rebuild to show/hide ghost post
    if (mounted) setState(() {});
  }

  void _startVideoSequence(List<Map<String, dynamic>> items) {
    _videoIds = items
        .where((item) => item['type'] == 'post')
        .map((item) => item['data'] as DocumentSnapshot)
        .where((doc) {
          final data = doc.data() as Map<String, dynamic>;
          return data['mediaType'] == 'video';
        })
        .map((doc) => doc.id)
        .toList();

    if (_videoIds.isEmpty) {
      _activeVideoIdNotifier.value = null;
      return;
    }
    _currentSequenceIndex = 0;
    _playNextInSequence();
  }

  void _playNextInSequence() {
    if (!mounted) return;

    if (_currentSequenceIndex >= _videoIds.length) {
      _currentSequenceIndex = 0; // Loop
    }

    if (_videoIds.isEmpty) return;
    String postIdToPlay = _videoIds[_currentSequenceIndex];
    _activeVideoIdNotifier.value = postIdToPlay;
  }

  void _handleVideoFinished(String postId) {
    if (_videoIds.contains(postId) && _activeVideoIdNotifier.value == postId) {
      _currentSequenceIndex++;
      _playNextInSequence();
    }
  }

  // Helpers from GroupsScreen for UI state
  bool _isDiscussionArchived(Map<String, dynamic> discussionData) {
    final Timestamp? expiresAt = discussionData['expiresAt'];
    if (expiresAt == null) return false;
    final DateTime expirationDate = expiresAt.toDate();
    return DateTime.now().isAfter(expirationDate);
  }

  int? _getDaysLeft(Map<String, dynamic> discussionData) {
    final Timestamp? expiresAt = discussionData['expiresAt'];
    if (expiresAt == null) return null;
    final DateTime expirationDate = expiresAt.toDate();
    final DateTime now = DateTime.now();
    if (now.isAfter(expirationDate)) return null;
    return expirationDate.difference(now).inDays;
  }

  Stream<List<Map<String, dynamic>>> _getCombinedStream() {
    final firestore = FirebaseFirestore.instance;

    if (widget.tabType == ProfileTabType.activity) {
      final postsStream = firestore
          .collection('posts')
          .where('userId', isEqualTo: widget.userId)
          .snapshots()
          .map(
            (s) => s.docs
                .map(
                  (d) => {
                    'type': 'post',
                    'data': d,
                    'time': d.data()['timestamp'],
                  },
                )
                .toList(),
          );

      final pollsStream = firestore
          .collection('polls')
          .where('createdBy', isEqualTo: widget.userId)
          .snapshots()
          .map(
            (s) => s.docs
                .map(
                  (d) => {
                    'type': 'poll',
                    'data': d,
                    'time': d.data()['createdAt'],
                  },
                )
                .toList(),
          );

      final groupsStream = firestore
          .collection('groups')
          .where('createdBy', isEqualTo: widget.userId)
          .snapshots()
          .map(
            (s) => s.docs.map((d) {
              final data = d.data() as Map<String, dynamic>;
              final isDiscussion = data['category'] == 'Discussions';
              return {
                'type': isDiscussion ? 'discussion' : 'group',
                'data': d,
                'time': data['createdAt'],
              };
            }).toList(),
          );

      final petitionsStream = firestore
          .collection('petitions')
          .where('createdBy', isEqualTo: widget.userId)
          .snapshots()
          .map(
            (s) => s.docs
                .map(
                  (d) => {
                    'type': 'petition',
                    'data': d,
                    'time': d.data()['createdAt'],
                  },
                )
                .toList(),
          );

      return CombineLatestStream.list([
        postsStream,
        pollsStream,
        groupsStream,
        petitionsStream,
      ]).map((lists) {
        final combined = lists.expand((x) => x).toList();
        combined.sort((a, b) {
          final timeA = (a['time'] as Timestamp?)?.toDate() ?? DateTime(0);
          final timeB = (b['time'] as Timestamp?)?.toDate() ?? DateTime(0);
          return timeB.compareTo(timeA);
        });
        return combined;
      });
    } else if (widget.tabType == ProfileTabType.saved) {
      // Saved posts in User doc
      return firestore.collection('users').doc(widget.userId).snapshots().asyncMap((
        userDoc,
      ) async {
        final savedIds = List<String>.from(userDoc.data()?['savedPosts'] ?? []);
        if (savedIds.isEmpty) return [];

        // Fetch posts in chunks of 10 (Firestore limit is 10 for whereIn, but actually 30 now, let's play safe)
        List<Map<String, dynamic>> results = [];
        for (var i = 0; i < savedIds.length; i += 10) {
          final chunk = savedIds.sublist(
            i,
            i + 10 > savedIds.length ? savedIds.length : i + 10,
          );
          final snap = await firestore
              .collection('posts')
              .where(FieldPath.documentId, whereIn: chunk)
              .get();
          results.addAll(
            snap.docs.map(
              (d) => {'type': 'post', 'data': d, 'time': d.data()['timestamp']},
            ),
          );
        }
        results.sort(
          (a, b) => ((b['time'] as Timestamp?)?.toDate() ?? DateTime(0))
              .compareTo((a['time'] as Timestamp?)?.toDate() ?? DateTime(0)),
        );
        return results;
      });
    } else if (widget.tabType == ProfileTabType.liked) {
      return firestore
          .collection('posts')
          .where('likes', arrayContains: widget.userId)
          .snapshots()
          .map(
            (s) => s.docs
                .map(
                  (d) => {
                    'type': 'post',
                    'data': d,
                    'time': d.data()['timestamp'],
                  },
                )
                .toList(),
          );
    } else if (widget.tabType == ProfileTabType.polls) {
      return firestore
          .collection('polls')
          .snapshots()
          .map(
            (s) => s.docs
                .where((d) {
                  final voters = List.from(
                    (d.data() as Map<String, dynamic>)['voters'] ?? [],
                  );
                  return voters.any(
                    (v) => v is Map && v['userId'] == widget.userId,
                  );
                })
                .map(
                  (d) => {
                    'type': 'poll',
                    'data': d,
                    'time': d.data()['createdAt'],
                  },
                )
                .toList(),
          );
    } else if (widget.tabType == ProfileTabType.petitions) {
      return firestore
          .collection('petitions')
          .where('signers', arrayContains: widget.userId)
          .snapshots()
          .map(
            (s) => s.docs
                .map(
                  (d) => {
                    'type': 'petition',
                    'data': d,
                    'time': d.data()['createdAt'],
                  },
                )
                .toList(),
          );
    }

    return Stream.value([]);
  }

  @override
  Widget build(BuildContext context) {
    // Check if we are uploading
    final uploadService = PostUploadService.instance;
    final bool isUploading =
        widget.isOwnProfile && uploadService.status == UploadStatus.uploading;

    return StreamBuilder<List<Map<String, dynamic>>>(
      stream: _getCombinedStream(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return Center(
            child: CircularProgressIndicator(color: AppColors.primaryLavender),
          );
        }

        final newItems = snapshot.hasData
            ? snapshot.data!
            : <Map<String, dynamic>>[];
        if (newItems.length != _combinedItems.length) {
          _combinedItems = newItems;
          WidgetsBinding.instance.addPostFrameCallback((_) {
            _startVideoSequence(_combinedItems);
          });
        }

        bool showCreateButton =
            widget.isOwnProfile &&
            widget.tabType == ProfileTabType.activity &&
            widget.createPostButton != null;
        bool showGhostPost =
            widget.isOwnProfile &&
            widget.tabType == ProfileTabType.activity &&
            isUploading;

        int itemCount = _combinedItems.length;
        if (showCreateButton) itemCount++;
        if (showGhostPost) itemCount++;

        if (itemCount == 0) {
          String msg = 'No activity yet';
          if (widget.tabType == ProfileTabType.saved)
            msg = 'No saved posts';
          else if (widget.tabType == ProfileTabType.liked)
            msg = 'No liked posts';
          else if (widget.tabType == ProfileTabType.polls)
            msg = 'No polls participated in';
          else if (widget.tabType == ProfileTabType.petitions)
            msg = 'No petitions signed';
          return Center(
            child: Text(msg, style: TextStyle(color: AppColors.textMedium)),
          );
        }

        return Padding(
          padding: const EdgeInsets.all(8.0),
          child: MasonryGridView.count(
            crossAxisCount: ResponsiveLayout.getColumnCount(context),
            mainAxisSpacing: 4,
            crossAxisSpacing: 4,
            itemCount: itemCount,
            itemBuilder: (context, index) {
              int offset = 0;
              if (showCreateButton) {
                if (index == 0) return widget.createPostButton!;
                offset++;
              }
              if (showGhostPost) {
                if (index == offset)
                  return _buildGhostUploadItem(uploadService);
                offset++;
              }
              final itemIndex = index - offset;
              if (itemIndex < 0 || itemIndex >= _combinedItems.length)
                return Container();

              final item = _combinedItems[itemIndex];
              Widget child;

              if (item['type'] == 'post') {
                child = _buildPostGridItem(item['data'] as DocumentSnapshot);
              } else {
                child = _buildCircleGridItem(item);
              }

              // Apply Staggered Start for Polls and Petitions
              if (widget.tabType == ProfileTabType.polls ||
                  widget.tabType == ProfileTabType.petitions) {
                int columns = ResponsiveLayout.getColumnCount(context);
                int column = index % columns;
                if ((column == 0 || column == columns - 1) && index < columns) {
                  // Pseudo-random offset based on user ID and column
                  final int seed = widget.userId.hashCode + column;
                  final double staggerOffset =
                      (seed % 35) + 15.0; // 15px to 50px range
                  return Padding(
                    padding: EdgeInsets.only(top: staggerOffset),
                    child: child,
                  );
                }
              }

              return child;
            },
          ),
        );
      },
    );
  }

  Widget _buildPostGridItem(DocumentSnapshot post) {
    var postData = post.data() as Map<String, dynamic>;
    return GestureDetector(
      onTap: () {
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => PostDetailScreen(
              postId: post.id,
              userId: widget.userId,
              source: 'profile',
            ),
          ),
        );
      },
      child: ClipRRect(
        borderRadius: BorderRadius.circular(12.0),
        child: Container(
          child: postData['mediaType'] == 'image'
              ? CachedNetworkImage(
                  imageUrl: postData['mediaUrl'],
                  fit: BoxFit.cover,
                  placeholder: (context, url) =>
                      Container(color: AppColors.elevation),
                  errorWidget: (context, url, error) =>
                      const Icon(Feather.alert_circle, color: AppColors.error),
                )
              : VideoGridItem(
                  url: postData['mediaUrl'],
                  thumbnailUrl: postData['thumbnailUrl'],
                  postId: post.id,
                  activePostIdNotifier: _activeVideoIdNotifier,
                  onVideoFinished: () => _handleVideoFinished(post.id),
                ),
        ),
      ),
    );
  }

  Widget _buildCircleGridItem(Map<String, dynamic> item) {
    final type = item['type'];
    final doc = item['data'] as DocumentSnapshot;
    final data = doc.data() as Map<String, dynamic>;

    IconData icon;
    String title;
    String description = '';
    Color color;
    String? imageUrl;
    Widget? badge;
    Widget? progressPill;

    switch (type) {
      case 'poll':
        icon = Feather.bar_chart_2;
        title = data['question'] ?? 'Poll';
        color = AppColors.primaryLavender;
        final int? days = _getDaysLeft(data);
        if (days != null) {
          badge = _buildSmallBadge('$days d', AppColors.accentMustard);
        }
        break;
      case 'discussion':
        icon = Feather.message_square;
        title = data['name'] ?? 'Discussion';
        description = data['description'] ?? '';
        color = AppColors.secondaryTeal;
        imageUrl = data['imageUrl'];
        final bool isArchived = _isDiscussionArchived(data);
        final int? days = _getDaysLeft(data);
        if (isArchived) {
          badge = _buildSmallBadge('ARCHIVED', AppColors.textDisabled);
        } else if (days != null) {
          badge = _buildSmallBadge('$days left', AppColors.accentMustard);
        }
        break;
      case 'group':
        icon = Feather.users;
        title = data['name'] ?? 'Group';
        description = data['description'] ?? '';
        color = AppColors.accentMustard;
        imageUrl = data['imageUrl'];
        break;
      case 'petition':
        icon = Feather.check_square;
        final petition = Petition.fromDocument(doc);
        title = petition.title;
        description = petition.description;
        color = AppColors.error;
        imageUrl = petition.bannerImageUrl;
        progressPill = _buildPetitionProgressPill(petition);
        break;
      default:
        icon = Feather.help_circle;
        title = 'Item';
        color = AppColors.textMedium;
    }

    if (type == 'poll') {
      return PollCard(
        pollSnapshot: doc,
        cardMarginVertical: 2,
        cardMarginHorizontal: 2,
        cardInternalPadding: 10,
        borderRadiusValue: 18,
        isCompact: true,
      );
    }

    return Card(
      margin: EdgeInsets.all(2),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(18)),
      color: AppColors.surface,
      elevation: 4,
      shadowColor: Colors.black.withOpacity(0.08),
      child: InkWell(
        borderRadius: BorderRadius.circular(18),
        onTap: () {
          if (type == 'discussion') {
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) =>
                    DiscussionViewScreen(discussionId: doc.id),
              ),
            );
          } else if (type == 'group') {
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) => GroupViewScreen(groupId: doc.id),
              ),
            );
          } else if (type == 'petition') {
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) =>
                    EnhancedPetitionDetailScreen(petitionId: doc.id),
              ),
            );
          }
        },
        child: Padding(
          padding: const EdgeInsets.all(8.0),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Image / AspectRatio
              AspectRatio(
                aspectRatio: 1,
                child: ClipRRect(
                  borderRadius: BorderRadius.circular(14),
                  child: Stack(
                    fit: StackFit.expand,
                    children: [
                      imageUrl != null && imageUrl.isNotEmpty
                          ? CachedNetworkImage(
                              imageUrl: imageUrl,
                              fit: BoxFit.cover,
                              placeholder: (context, url) => Shimmer.fromColors(
                                baseColor: AppColors.elevation,
                                highlightColor: AppColors.surface.withOpacity(
                                  0.5,
                                ),
                                child: Container(color: Colors.white),
                              ),
                              errorWidget: (context, url, error) => Container(
                                color: color.withOpacity(0.1),
                                child: Icon(icon, color: color, size: 24),
                              ),
                            )
                          : Container(
                              color: color.withOpacity(0.1),
                              child: Icon(icon, color: color, size: 24),
                            ),
                      if (badge != null)
                        Positioned(top: 4, left: 4, child: badge),
                    ],
                  ),
                ),
              ),
              const SizedBox(height: 8),
              // Content - Only show description
              if (description.isNotEmpty) ...[
                Text(
                  description,
                  textAlign: TextAlign.center,
                  maxLines: 3,
                  overflow: TextOverflow.ellipsis,
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    fontSize: 11,
                    color: AppColors.textHigh,
                  ),
                ),
                const SizedBox(height: 8),
              ],
              // Progress or Stats Pill
              if (progressPill != null)
                progressPill
              else
                _buildStatsPill(type, data, color, icon),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildSmallBadge(String text, Color color) {
    return Container(
      padding: EdgeInsets.symmetric(horizontal: 4, vertical: 2),
      decoration: BoxDecoration(
        color: color.withOpacity(0.9),
        borderRadius: BorderRadius.circular(6),
      ),
      child: Text(
        text,
        style: TextStyle(
          color: AppColors.backgroundDeep,
          fontSize: 8,
          fontWeight: FontWeight.bold,
        ),
      ),
    );
  }

  Widget _buildPetitionProgressPill(Petition petition) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 3),
      decoration: BoxDecoration(
        color: AppColors.secondaryTeal,
        borderRadius: BorderRadius.circular(50),
        border: Border.all(
          color: AppColors.primaryLavender,
          width: 3 * petition.progress,
        ),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(Feather.user_check, size: 10, color: AppColors.textOnSecondary),
          const SizedBox(width: 4),
          FittedBox(
            child: Text(
              '${petition.currentSignatures}/${petition.goal}',
              style: const TextStyle(
                color: AppColors.textOnSecondary,
                fontSize: 9,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStatsPill(
    String type,
    Map<String, dynamic> data,
    Color color,
    IconData icon,
  ) {
    String text = '';
    if (type == 'poll') {
      text = '${data['totalVotes'] ?? 0} votes';
    } else {
      text = '${data['memberCount'] ?? 0} members';
    }

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 3),
      decoration: BoxDecoration(
        color: (type == 'discussion' && _isDiscussionArchived(data))
            ? AppColors.textDisabled
            : AppColors.secondaryTeal,
        borderRadius: BorderRadius.circular(50),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(
            icon == Feather.bar_chart_2 ? icon : Feather.users,
            size: 10,
            color: AppColors.textOnSecondary,
          ),
          const SizedBox(width: 4),
          Text(
            text,
            style: const TextStyle(
              color: AppColors.textOnSecondary,
              fontSize: 9,
              fontWeight: FontWeight.bold,
            ),
          ),
        ],
      ),
    );
  }

  // --- NEW WIDGET: The Ghost Upload Item ---
  Widget _buildGhostUploadItem(PostUploadService service) {
    // Determine what to show as the background
    Widget backgroundWidget;

    if (service.currentMediaType == 'video') {
      if (service.currentThumbnail != null) {
        // Show generated thumbnail
        backgroundWidget = Image.file(
          service.currentThumbnail!,
          fit: BoxFit.cover,
          opacity: const AlwaysStoppedAnimation(0.5),
        );
      } else {
        // Show placeholder while thumbnail generates
        backgroundWidget = Container(
          color: Colors.black,
          child: Center(child: Icon(Feather.video, color: Colors.white24)),
        );
      }
    } else {
      // It's an image
      backgroundWidget = Image.file(
        service.currentFile!,
        fit: BoxFit.cover,
        opacity: const AlwaysStoppedAnimation(0.5),
      );
    }

    return AspectRatio(
      aspectRatio: 9 / 16,
      child: ClipRRect(
        borderRadius: BorderRadius.circular(12.0),
        child: Stack(
          fit: StackFit.expand,
          children: [
            // 1. Background (Image or Video Thumbnail)
            backgroundWidget,

            // 2. Dark Overlay
            Container(color: Colors.black45),

            // 3. Circular Progress & Icon
            Center(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Stack(
                    alignment: Alignment.center,
                    children: [
                      SizedBox(
                        width: 40,
                        height: 40,
                        child: CircularProgressIndicator(
                          value: service.progress,
                          color: AppColors.primaryLavender,
                          backgroundColor: Colors.white24,
                          strokeWidth: 4,
                        ),
                      ),
                      Icon(
                        service.progress >= 0.9
                            ? Feather.check
                            : Feather.upload,
                        color: Colors.white,
                        size: 18,
                      ),
                    ],
                  ),
                  SizedBox(height: 8),
                  Text(
                    service.progress >= 0.9 ? "Finalizing..." : "Posting...",
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 10,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// ======== Video Grid Item ========
class VideoGridItem extends StatefulWidget {
  final String url;
  final String? thumbnailUrl;
  final String postId;
  final ValueNotifier<String?>? activePostIdNotifier;
  final VoidCallback? onVideoFinished;

  const VideoGridItem({
    required this.url,
    this.thumbnailUrl,
    required this.postId,
    this.activePostIdNotifier,
    this.onVideoFinished,
  });

  @override
  _VideoGridItemState createState() => _VideoGridItemState();
}

class _VideoGridItemState extends State<VideoGridItem> {
  VideoPlayerController? _controller;
  bool _shouldPlay = false;
  Timer? _playDurationTimer;

  @override
  void initState() {
    super.initState();
    widget.activePostIdNotifier?.addListener(_checkPlaybackStatus);
  }

  @override
  void dispose() {
    widget.activePostIdNotifier?.removeListener(_checkPlaybackStatus);
    _playDurationTimer?.cancel();
    _controller?.dispose();
    super.dispose();
  }

  void _checkPlaybackStatus() {
    final isActive = widget.activePostIdNotifier?.value == widget.postId;
    if (isActive) {
      _initializeAndPlay();
    } else {
      _disposeController();
    }
  }

  Future<void> _initializeAndPlay() async {
    if (_controller != null) return;
    if (mounted) setState(() => _shouldPlay = true);

    _controller = VideoPlayerController.networkUrl(Uri.parse(widget.url));
    try {
      await _controller!.initialize();
      _controller!.setVolume(0.0);

      if (widget.activePostIdNotifier?.value == widget.postId) {
        await _controller!.play();
        if (mounted) setState(() {});

        _playDurationTimer?.cancel();
        _playDurationTimer = Timer(const Duration(seconds: 5), () {
          if (mounted) {
            _disposeController();
            widget.onVideoFinished?.call();
          }
        });
      } else {
        _disposeController();
      }
    } catch (e) {
      print("Error playing video preview: $e");
      _disposeController();
      widget.onVideoFinished?.call();
    }
  }

  void _disposeController() {
    _playDurationTimer?.cancel();
    if (_controller != null) {
      _controller!.dispose();
      _controller = null;
    }
    if (mounted && _shouldPlay) {
      setState(() => _shouldPlay = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    Widget thumbnailWidget;
    if (widget.thumbnailUrl != null && widget.thumbnailUrl!.isNotEmpty) {
      thumbnailWidget = CachedNetworkImage(
        imageUrl: widget.thumbnailUrl!,
        fit: BoxFit.cover,
        placeholder: (context, url) => Container(color: AppColors.elevation),
        errorWidget: (context, url, error) => Container(
          color: Colors.red.withOpacity(0.2),
          child: const Icon(Feather.image, color: Colors.red),
        ),
      );
    } else {
      thumbnailWidget = Container(
        color: AppColors.elevation,
        child: Center(
          child: Icon(Feather.video, color: AppColors.textDisabled, size: 30),
        ),
      );
    }

    double aspectRatio = 9 / 16;
    if (_controller != null && _controller!.value.isInitialized) {
      aspectRatio = _controller!.value.aspectRatio;
    }

    return AspectRatio(
      aspectRatio: aspectRatio,
      child: Stack(
        alignment: Alignment.center,
        children: [
          Positioned.fill(child: thumbnailWidget),
          if (_controller != null && _controller!.value.isInitialized)
            Positioned.fill(child: VideoPlayer(_controller!)),
          if (_shouldPlay &&
              (_controller == null || !_controller!.value.isInitialized))
            const Center(
              child: SizedBox(
                width: 20,
                height: 20,
                child: CircularProgressIndicator(
                  color: Colors.white,
                  strokeWidth: 2,
                ),
              ),
            ),
        ],
      ),
    );
  }
}

// ======== ProfileScreen ========
class ProfileScreen extends StatefulWidget {
  final String userId;
  const ProfileScreen({required this.userId});

  @override
  _ProfileScreenState createState() => _ProfileScreenState();
}

class _ProfileScreenState extends State<ProfileScreen> {
  final TextEditingController _fullNameController = TextEditingController();
  final TextEditingController _bioController = TextEditingController();
  final TextEditingController _missionStatementController =
      TextEditingController();
  final TextEditingController _websiteController = TextEditingController();
  final TextEditingController _phoneController = TextEditingController();
  final TextEditingController _addressController = TextEditingController();
  bool _isEditing = false;
  File? _profileImageFile;
  bool _isOwnProfile = false;

  // New State for Personality Visibility
  bool _showPersonality = true;
  List<AvailabilitySlot> _availabilitySlots = [];

  @override
  void initState() {
    super.initState();
    _isOwnProfile = widget.userId == FirebaseAuth.instance.currentUser!.uid;
    WidgetsBinding.instance.addPostFrameCallback((_) {
      fixMissingBioFields();
    });

    if (!_isOwnProfile) {
      _incrementProfileVisits();
    }
  }

  void _incrementProfileVisits() async {
    try {
      await FirebaseFirestore.instance
          .collection('users')
          .doc(widget.userId)
          .update({'profileVisits': FieldValue.increment(1)});
    } catch (e) {
      print("Error incrementing visits: $e");
    }
  }

  Widget _buildProfileHeader(DocumentSnapshot user) {
    final userData = user.data() as Map<String, dynamic>? ?? {};
    bool canChangeName = true;
    int daysRemaining = 0;

    // Initialize Toggle State from DB when not editing
    if (!_isEditing) {
      _showPersonality = userData['showPersonality'] ?? true;
    }

    if (userData['lastNameChangeDate'] != null) {
      final Timestamp lastChange = userData['lastNameChangeDate'];
      final date = lastChange.toDate();
      final daysSince = DateTime.now().difference(date).inDays;
      if (daysSince < 30) {
        canChangeName = false;
        daysRemaining = 30 - daysSince;
      }
    }

    // Personality Data
    String? personalityType = userData['personalityType'];
    String? personalityTitle = userData['personalityTitle'];

    return Column(
      children: [
        Stack(
          children: [
            GestureDetector(
              onTap: () {
                if (_isEditing) _pickProfileImage();
              },
              child: Stack(
                alignment: Alignment.center,
                children: [
                  CircleAvatar(
                    radius: 50,
                    backgroundColor: AppColors.elevation,
                    backgroundImage:
                        (userData['profileImage'] ?? userData['logo'] ?? '')
                            .isNotEmpty
                        ? CachedNetworkImageProvider(
                            userData['profileImage'] ?? userData['logo'] ?? '',
                          )
                        : const AssetImage('assets/default_avatar.png')
                              as ImageProvider,
                  ),
                  if (_isEditing)
                    Container(
                      width: 100,
                      height: 100,
                      decoration: BoxDecoration(
                        color: Colors.black.withOpacity(0.3),
                        shape: BoxShape.circle,
                      ),
                      child: const Icon(Feather.camera, color: Colors.white),
                    ),
                ],
              ),
            ),
            if (_isOwnProfile)
              Positioned(
                bottom: 0,
                right: 0,
                child: CircleAvatar(
                  radius: 12,
                  backgroundColor: AppColors.primaryLavender,
                  child: IconButton(
                    padding: EdgeInsets.zero,
                    constraints: const BoxConstraints(),
                    icon: Icon(
                      _isEditing ? Feather.save : Feather.edit,
                      color: AppColors.backgroundDeep,
                      size: 14,
                    ),
                    onPressed: () {
                      if (_isEditing)
                        _saveProfileChanges();
                      else
                        setState(() => _isEditing = true);
                    },
                  ),
                ),
              ),
          ],
        ),
        const SizedBox(height: 8),
        AccountBadge(
          accountType: userData['accountType'] ?? 'personal',
          isVerified: userData['isVerified'] ?? false,
        ),
        const SizedBox(height: 8),

        // --- PERSONALITY TYPE DISPLAY ---
        if (!_isEditing && _showPersonality && personalityType != null)
          Container(
            margin: EdgeInsets.only(bottom: 8),
            padding: EdgeInsets.symmetric(horizontal: 12, vertical: 4),
            decoration: BoxDecoration(
              color: AppColors.elevation,
              borderRadius: BorderRadius.circular(15),
              border: Border.all(
                color: AppColors.secondaryTeal.withOpacity(0.5),
              ),
            ),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(Feather.zap, size: 12, color: AppColors.secondaryTeal),
                SizedBox(width: 6),
                Text(
                  "$personalityType - $personalityTitle",
                  style: TextStyle(
                    color: AppColors.textHigh,
                    fontSize: 12,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
          ),

        _isEditing
            ? Column(
                children: [
                  TextFormField(
                    controller: _fullNameController,
                    enabled: canChangeName,
                    style: TextStyle(
                      color: canChangeName
                          ? AppColors.textHigh
                          : AppColors.textDisabled,
                    ),
                    decoration: InputDecoration(
                      labelText: 'Full Name',
                      filled: true,
                      fillColor: AppColors.elevation,
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                        borderSide: BorderSide.none,
                      ),
                    ),
                  ),

                  // --- VISIBILITY TOGGLE IN EDIT MODE ---
                  if (personalityType != null)
                    SwitchListTile(
                      activeColor: AppColors.primaryLavender,
                      contentPadding: EdgeInsets.zero,
                      title: Text(
                        "Show Twin Finder Personality",
                        style: TextStyle(
                          color: AppColors.textMedium,
                          fontSize: 14,
                        ),
                      ),
                      value: _showPersonality,
                      onChanged: (val) {
                        setState(() => _showPersonality = val);
                      },
                    ),

                  Padding(
                    padding: const EdgeInsets.only(top: 8.0),
                    child: Container(
                      padding: const EdgeInsets.all(10),
                      decoration: BoxDecoration(
                        color: canChangeName
                            ? Colors.orange.withOpacity(0.15)
                            : AppColors.error.withOpacity(0.15),
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(
                          color: canChangeName
                              ? Colors.orange
                              : AppColors.error,
                          width: 1,
                        ),
                      ),
                      child: Row(
                        children: [
                          Icon(
                            canChangeName
                                ? Feather.alert_triangle
                                : Feather.lock,
                            color: canChangeName
                                ? Colors.orange
                                : AppColors.error,
                            size: 20,
                          ),
                          const SizedBox(width: 10),
                          Expanded(
                            child: Text(
                              canChangeName
                                  ? "Note: You can only change your name once every 30 days."
                                  : "Name change locked. You can change it again in $daysRemaining days.",
                              style: TextStyle(
                                fontSize: 12,
                                color: canChangeName
                                    ? Colors.orange
                                    : AppColors.error,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              )
            : Text(
                userData['fullName'] ??
                    userData['organizationName'] ??
                    'No Name',
                style: const TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: AppColors.textHigh,
                ),
              ),
        const SizedBox(height: 2),
        Text(
          '@${userData['username'] ?? ''}',
          style: const TextStyle(color: AppColors.textMedium),
        ),
        ProfileStatsWidget(userId: user.id, isOwnProfile: _isOwnProfile),
        const SizedBox(height: 8),

        if (userData['accountType'] == 'organization')
          ..._buildOrganizationProfile(user),
        if (userData['accountType'] == 'therapist')
          ..._buildTherapistProfile(user),
        if ((userData['accountType'] ?? 'personal') == 'personal')
          _isEditing
              ? Padding(
                  padding: const EdgeInsets.only(top: 8.0),
                  child: TextFormField(
                    controller: _bioController,
                    style: const TextStyle(color: AppColors.textHigh),
                    decoration: InputDecoration(
                      labelText: 'Bio',
                      filled: true,
                      fillColor: AppColors.elevation,
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                        borderSide: BorderSide.none,
                      ),
                    ),
                    maxLines: 2,
                  ),
                )
              : Text(
                  userData['bio'] ?? 'No bio yet',
                  textAlign: TextAlign.center,
                  style: const TextStyle(color: AppColors.textMedium),
                ),
      ],
    );
  }

  List<Widget> _buildOrganizationProfile(DocumentSnapshot user) {
    final userData = user.data() as Map<String, dynamic>? ?? {};
    if (!_isEditing) {
      _missionStatementController.text = userData['missionStatement'] ?? '';
      _websiteController.text = userData['website'] ?? '';
      _phoneController.text = userData['phone'] ?? '';
      _addressController.text = userData['address'] ?? '';
    }

    return [
      _buildAutoBio(userData),
      if (userData['missionStatement'] != null)
        Padding(
          padding: const EdgeInsets.symmetric(vertical: 8.0, horizontal: 20),
          child: Text(
            userData['missionStatement'],
            textAlign: TextAlign.center,
            style: const TextStyle(
              fontStyle: FontStyle.italic,
              color: AppColors.textMedium,
              fontSize: 13,
            ),
          ),
        ),
      if (userData['website'] != null &&
          (userData['website'] as String).isNotEmpty)
        Padding(
          padding: const EdgeInsets.only(top: 4.0),
          child: Text(
            userData['website'],
            style: const TextStyle(
              color: AppColors.secondaryTeal,
              decoration: TextDecoration.underline,
            ),
          ),
        ),
      _isEditing
          ? Column(
              children: [
                _buildTextField(
                  controller: _missionStatementController,
                  label: 'Mission Statement',
                  maxLines: 2,
                ),
                const SizedBox(height: 8),
                _buildTextField(
                  controller: _websiteController,
                  label: 'Website (optional)',
                ),
                const SizedBox(height: 8),
                _buildTextField(controller: _phoneController, label: 'Phone'),
                const SizedBox(height: 8),
                _buildTextField(
                  controller: _addressController,
                  label: 'Address',
                ),
                const SizedBox(height: 8),
                _buildTextField(
                  controller: _bioController,
                  label: 'About Us',
                  maxLines: 3,
                ),
              ],
            )
          : const SizedBox.shrink(),
    ];
  }

  String _generateAutoBio(Map<String, dynamic> userData) {
    List<String> parts = [];
    final type = userData['accountType'];

    if (type == 'therapist') {
      if (userData['specialization'] is List) {
        final specs = (userData['specialization'] as List).join(', ');
        if (specs.isNotEmpty) parts.add(specs);
      }
      if (userData['experienceLevel'] != null &&
          userData['experienceLevel'].toString().isNotEmpty) {
        parts.add(userData['experienceLevel']);
      }
      if (userData['region'] != null &&
          userData['region'].toString().isNotEmpty) {
        parts.add(userData['region']);
      }
      if (userData['languages'] is List) {
        final langs = (userData['languages'] as List).join(', ');
        if (langs.isNotEmpty) parts.add(langs);
      }
      if (userData['genderPreference'] != null &&
          userData['genderPreference'].toString().isNotEmpty) {
        parts.add(userData['genderPreference']);
      }
    } else if (type == 'organization') {
      if (userData['category'] != null &&
          userData['category'].toString().isNotEmpty) {
        parts.add(userData['category']);
      }
      if (userData['areasOfFocus'] is List) {
        final focus = (userData['areasOfFocus'] as List).join(', ');
        if (focus.isNotEmpty) parts.add(focus);
      }
      if (userData['country'] != null &&
          userData['country'].toString().isNotEmpty) {
        parts.add(userData['country']);
      }
    }
    return parts.join(' || ');
  }

  Widget _buildAutoBio(Map<String, dynamic> userData) {
    final bio = _generateAutoBio(userData);
    if (bio.isEmpty) return const SizedBox.shrink();

    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8.0, horizontal: 24.0),
      child: Text(
        bio,
        textAlign: TextAlign.center,
        style: GoogleFonts.poppins(
          color: AppColors.textMedium,
          fontSize: 13,
          fontWeight: FontWeight.w500,
          height: 1.5,
        ),
      ),
    );
  }

  List<Widget> _buildTherapistProfile(DocumentSnapshot user) {
    final userData = user.data() as Map<String, dynamic>? ?? {};

    return [
      _buildAutoBio(userData),
      // Rating Display
      if (userData['accountType'] == 'therapist')
        Padding(
          padding: const EdgeInsets.symmetric(vertical: 4),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              const Icon(
                Feather.star,
                size: 16,
                color: AppColors.accentMustard,
              ),
              const SizedBox(width: 4),
              Text(
                '${(userData['averageRating'] ?? 0.0).toStringAsFixed(1)} (${userData['totalRatings'] ?? 0})',
                style: const TextStyle(
                  color: AppColors.textMedium,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
        ),
      if (_isEditing && userData['accountType'] == 'therapist')
        _buildAvailabilityField(),
      if (!_isEditing &&
          userData['availability'] != null &&
          (userData['availability'] as List).isNotEmpty)
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Row(
                children: [
                  Icon(Feather.clock, size: 16, color: AppColors.secondaryTeal),
                  SizedBox(width: 8),
                  Text(
                    'Availability',
                    style: TextStyle(
                      fontWeight: FontWeight.bold,
                      color: AppColors.textHigh,
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 8),
              ...(userData['availability'] as List).map<Widget>((slot) {
                final day = slot['day'];
                final start = TimeOfDay(
                  hour: slot['startHour'] ?? 0,
                  minute: slot['startMinute'] ?? 0,
                );
                final end = TimeOfDay(
                  hour: slot['endHour'] ?? 0,
                  minute: slot['endMinute'] ?? 0,
                );
                return Padding(
                  padding: const EdgeInsets.only(left: 24, bottom: 4),
                  child: Text(
                    '$day: ${start.format(context)} - ${end.format(context)}',
                    style: const TextStyle(
                      color: AppColors.success,
                      fontWeight: FontWeight.w500,
                      fontSize: 13,
                    ),
                  ),
                );
              }).toList(),
            ],
          ),
        ),
      if (_isEditing)
        _buildTextField(
          controller: _bioController,
          label: 'Professional Bio',
          maxLines: 3,
        ),
    ];
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String label,
    int maxLines = 1,
  }) {
    return TextFormField(
      controller: controller,
      style: const TextStyle(color: AppColors.textHigh),
      decoration: InputDecoration(
        labelText: label,
        filled: true,
        fillColor: AppColors.elevation,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(12),
          borderSide: BorderSide.none,
        ),
      ),
      maxLines: maxLines,
    );
  }

  Future<void> _pickProfileImage() async {
    final picker = ImagePicker();
    final pickedFile = await picker.pickImage(source: ImageSource.gallery);
    if (pickedFile != null) {
      setState(() => _profileImageFile = File(pickedFile.path));
      await _uploadProfileImage();
    }
  }

  Future<void> _saveProfileChanges() async {
    try {
      final userDoc = await FirebaseFirestore.instance
          .collection('users')
          .doc(widget.userId)
          .get();
      final userData = userDoc.data() as Map<String, dynamic>? ?? {};

      Map<String, dynamic> updateData = {
        'bio': _bioController.text,
        'showPersonality': _showPersonality, //  SAVE TOGGLE STATE
      };

      if (_fullNameController.text.trim() != (userData['fullName'] ?? '')) {
        if (userData['lastNameChangeDate'] != null &&
            DateTime.now()
                    .difference(
                      (userData['lastNameChangeDate'] as Timestamp).toDate(),
                    )
                    .inDays <
                30) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Name change locked for 30 days.'),
              backgroundColor: AppColors.error,
            ),
          );
          return;
        }
        updateData['fullName'] = _fullNameController.text.trim();
        updateData['lastNameChangeDate'] = FieldValue.serverTimestamp();
      }

      if (userData['accountType'] == 'organization') {
        updateData['missionStatement'] = _missionStatementController.text;
        updateData['website'] = _websiteController.text;
        updateData['phone'] = _phoneController.text;
        updateData['address'] = _addressController.text;
      }

      if (userData['accountType'] == 'therapist') {
        updateData['availability'] = _availabilitySlots
            .map((s) => s.toMap())
            .toList();
      }

      await FirebaseFirestore.instance
          .collection('users')
          .doc(widget.userId)
          .update(updateData);
      setState(() => _isEditing = false);

      ScaffoldMessenger.of(
        context,
      ).showSnackBar(const SnackBar(content: Text('Profile updated!')));
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Error: $e')));
    }
  }

  Future<void> _uploadProfileImage() async {
    if (_profileImageFile == null) return;
    try {
      final ref = FirebaseStorage.instance.ref().child(
        'profile_images/${widget.userId}.jpg',
      );
      await ref.putFile(_profileImageFile!);
      final url = await ref.getDownloadURL();
      await FirebaseFirestore.instance
          .collection('users')
          .doc(widget.userId)
          .set({'profileImage': url}, SetOptions(merge: true));
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(const SnackBar(content: Text('Profile picture updated!')));
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Upload failed: $e')));
    }
  }

  Future<void> fixMissingBioFields() async {
    try {
      await FirebaseFirestore.instance
          .collection('users')
          .doc(widget.userId)
          .set({'bio': ''}, SetOptions(merge: true));
    } catch (_) {}
  }

  Widget _buildAvailabilityField() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Padding(
          padding: EdgeInsets.symmetric(vertical: 8.0, horizontal: 16.0),
          child: Text(
            'Edit Availability',
            style: TextStyle(
              color: AppColors.primaryLavender,
              fontWeight: FontWeight.bold,
            ),
          ),
        ),
        ..._availabilitySlots.asMap().entries.map((entry) {
          int index = entry.key;
          AvailabilitySlot slot = entry.value;
          return Padding(
            padding: const EdgeInsets.symmetric(
              horizontal: 16.0,
              vertical: 4.0,
            ),
            child: Row(
              children: [
                Expanded(
                  child: DropdownButton<String>(
                    value: slot.day,
                    dropdownColor: AppColors.surface,
                    style: const TextStyle(
                      color: AppColors.textHigh,
                      fontSize: 13,
                    ),
                    onChanged: (val) {
                      if (val != null) {
                        setState(() {
                          _availabilitySlots[index] = slot.copyWith(day: val);
                        });
                      }
                    },
                    items:
                        [
                              'Monday',
                              'Tuesday',
                              'Wednesday',
                              'Thursday',
                              'Friday',
                              'Saturday',
                              'Sunday',
                            ]
                            .map(
                              (d) => DropdownMenuItem(value: d, child: Text(d)),
                            )
                            .toList(),
                  ),
                ),
                TextButton(
                  onPressed: () => _selectTime(index, true),
                  child: Text(
                    slot.startTime.format(context),
                    style: const TextStyle(
                      color: AppColors.secondaryTeal,
                      fontSize: 13,
                    ),
                  ),
                ),
                const Text('-', style: TextStyle(color: AppColors.textMedium)),
                TextButton(
                  onPressed: () => _selectTime(index, false),
                  child: Text(
                    slot.endTime.format(context),
                    style: const TextStyle(
                      color: AppColors.secondaryTeal,
                      fontSize: 13,
                    ),
                  ),
                ),
                IconButton(
                  icon: const Icon(
                    Feather.minus_circle,
                    color: AppColors.error,
                    size: 20,
                  ),
                  onPressed: () => _removeAvailabilitySlot(index),
                ),
              ],
            ),
          );
        }).toList(),
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16.0),
          child: TextButton.icon(
            onPressed: _addAvailabilitySlot,
            icon: const Icon(Feather.plus, color: AppColors.success, size: 18),
            label: const Text(
              'Add Slot',
              style: TextStyle(color: AppColors.success, fontSize: 13),
            ),
          ),
        ),
      ],
    );
  }

  void _addAvailabilitySlot() {
    setState(() {
      _availabilitySlots.add(
        AvailabilitySlot(
          day: 'Monday',
          startTime: const TimeOfDay(hour: 9, minute: 0),
          endTime: const TimeOfDay(hour: 17, minute: 0),
        ),
      );
    });
  }

  void _removeAvailabilitySlot(int index) {
    setState(() {
      _availabilitySlots.removeAt(index);
    });
  }

  Future<void> _selectTime(int index, bool isStart) async {
    final TimeOfDay? picked = await showTimePicker(
      context: context,
      initialTime: isStart
          ? _availabilitySlots[index].startTime
          : _availabilitySlots[index].endTime,
    );
    if (picked != null) {
      setState(() {
        if (isStart) {
          _availabilitySlots[index] = _availabilitySlots[index].copyWith(
            startTime: picked,
          );
        } else {
          _availabilitySlots[index] = _availabilitySlots[index].copyWith(
            endTime: picked,
          );
        }
      });
    }
  }

  Widget _buildPostsGrid(String userId, bool isOwnProfile) {
    return PostGridWithPreview(
      userId: userId,
      isOwnProfile: isOwnProfile,
      createPostButton: isOwnProfile ? _buildCreatePostButton() : null,
    );
  }

  Widget _buildCreatePostButton() {
    return GestureDetector(
      onTap: () => Navigator.push(
        context,
        MaterialPageRoute(builder: (context) => AddPostScreen()),
      ),
      child: AspectRatio(
        aspectRatio: 9 / 16,
        child: Container(
          decoration: BoxDecoration(
            color: AppColors.elevation,
            borderRadius: BorderRadius.circular(12.0),
            border: Border.all(color: AppColors.primaryLavender, width: 1.5),
          ),
          child: const Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(
                Feather.plus_circle,
                size: 40,
                color: AppColors.primaryLavender,
              ),
              SizedBox(height: 8),
              Text(
                'Create Post',
                style: TextStyle(
                  color: AppColors.primaryLavender,
                  fontSize: 14,
                  fontWeight: FontWeight.bold,
                ),
                textAlign: TextAlign.center,
              ),
            ],
          ),
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: const Text(
          'Profile',
          style: TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: Colors.transparent,
        elevation: 0,
        actions: _isOwnProfile
            ? [
                // Analytics Button
                Container(
                  width: 40,
                  height: 40,
                  margin: const EdgeInsets.only(top: 8, bottom: 8),
                  decoration: BoxDecoration(
                    shape: BoxShape.circle,
                    color: AppColors.elevation,
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.08),
                        blurRadius: 6,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),
                  child: IconButton(
                    icon: const Icon(
                      Feather.bar_chart_2,
                      color: AppColors.primaryLavender,
                      size: 20,
                    ),
                    onPressed: () => Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (context) => AnalyticsDashboardScreen(),
                      ),
                    ),
                  ),
                ),
                const SizedBox(width: 8),
                // Settings Button
                Container(
                  width: 40,
                  height: 40,
                  margin: const EdgeInsets.only(top: 8, bottom: 8),
                  decoration: BoxDecoration(
                    shape: BoxShape.circle,
                    color: AppColors.elevation,
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.08),
                        blurRadius: 6,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),
                  child: IconButton(
                    icon: const Icon(
                      Feather.settings,
                      color: AppColors.primaryLavender,
                      size: 20,
                    ),
                    onPressed: () => Navigator.push(
                      context,
                      MaterialPageRoute(builder: (context) => SettingsScreen()),
                    ),
                  ),
                ),
                const SizedBox(width: 12),
              ]
            : null,
      ),
      body: FutureBuilder<DocumentSnapshot>(
        future: FirebaseFirestore.instance
            .collection('users')
            .doc(widget.userId)
            .get(),
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting)
            return const Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryLavender,
              ),
            );
          if (!snapshot.hasData)
            return const Center(child: Text('User not found'));

          var user = snapshot.data!;
          var userData = user.data() as Map<String, dynamic>? ?? {};

          if (!_isEditing) {
            _fullNameController.text = userData['fullName'] ?? '';
            _bioController.text = userData['bio'] ?? '';
            if (userData['availability'] != null) {
              _availabilitySlots = (userData['availability'] as List)
                  .map(
                    (slot) => AvailabilitySlot.fromMap(
                      Map<String, dynamic>.from(slot),
                    ),
                  )
                  .toList();
            }
          }

          return DefaultTabController(
            length: 5,
            child: NestedScrollView(
              headerSliverBuilder: (context, innerBoxIsScrolled) {
                return [
                  SliverToBoxAdapter(
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Column(
                        children: [
                          _buildProfileHeader(user),
                          const SizedBox(height: 4),

                          // Removed ProfileStatsWidget from here to move it between @ and bio
                          if (!_isOwnProfile) const SizedBox(height: 16),
                          if (!_isOwnProfile)
                            ElevatedButton(
                              onPressed: () async {
                                List f = List.from(userData['followers'] ?? []);
                                if (f.contains(
                                  FirebaseAuth.instance.currentUser!.uid,
                                )) {
                                  await FirebaseFirestore.instance
                                      .collection('users')
                                      .doc(widget.userId)
                                      .update({
                                        'followers': FieldValue.arrayRemove([
                                          FirebaseAuth
                                              .instance
                                              .currentUser!
                                              .uid,
                                        ]),
                                      });
                                  await FirebaseFirestore.instance
                                      .collection('users')
                                      .doc(
                                        FirebaseAuth.instance.currentUser!.uid,
                                      )
                                      .update({
                                        'following': FieldValue.arrayRemove([
                                          widget.userId,
                                        ]),
                                      });
                                } else {
                                  await FirebaseFirestore.instance
                                      .collection('users')
                                      .doc(widget.userId)
                                      .update({
                                        'followers': FieldValue.arrayUnion([
                                          FirebaseAuth
                                              .instance
                                              .currentUser!
                                              .uid,
                                        ]),
                                      });
                                  await FirebaseFirestore.instance
                                      .collection('users')
                                      .doc(
                                        FirebaseAuth.instance.currentUser!.uid,
                                      )
                                      .update({
                                        'following': FieldValue.arrayUnion([
                                          widget.userId,
                                        ]),
                                      });
                                  // Send notification using service
                                  final currentUser =
                                      FirebaseAuth.instance.currentUser;
                                  if (currentUser != null) {
                                    final currentUserDoc =
                                        await FirebaseFirestore.instance
                                            .collection('users')
                                            .doc(currentUser.uid)
                                            .get();
                                    final followerUsername =
                                        currentUserDoc.data()?['username'] ??
                                        'Someone';
                                    await NotificationService()
                                        .sendFollowNotification(
                                          followedUserId: widget.userId,
                                          followerUsername: followerUsername,
                                        );
                                  }
                                }
                              },
                              style: ElevatedButton.styleFrom(
                                backgroundColor: AppColors.primaryLavender,
                              ),
                              child: Text(
                                List.from(userData['followers'] ?? []).contains(
                                      FirebaseAuth.instance.currentUser!.uid,
                                    )
                                    ? 'Unfollow'
                                    : 'Follow',
                                style: const TextStyle(
                                  color: AppColors.backgroundDeep,
                                ),
                              ),
                            ),
                        ],
                      ),
                    ),
                  ),
                  SliverPersistentHeader(
                    pinned: true,
                    delegate: _SliverAppBarDelegate(
                      TabBar(
                        labelColor: AppColors.primaryLavender,
                        unselectedLabelColor: AppColors.textDisabled,
                        indicatorColor: AppColors.primaryLavender,
                        tabs: [
                          Tab(icon: Icon(Feather.grid, size: 18)),
                          Tab(icon: Icon(Feather.bookmark, size: 18)),
                          Tab(icon: Icon(Feather.heart, size: 18)),
                          Tab(icon: Icon(Feather.bar_chart_2, size: 18)),
                          Tab(icon: Icon(Feather.check_square, size: 18)),
                        ],
                      ),
                    ),
                  ),
                ];
              },
              body: TabBarView(
                children: [
                  PostGridWithPreview(
                    userId: widget.userId,
                    isOwnProfile: _isOwnProfile,
                    tabType: ProfileTabType.activity,
                    createPostButton: _isOwnProfile
                        ? _buildCreatePostButton()
                        : null,
                  ),
                  PostGridWithPreview(
                    userId: widget.userId,
                    isOwnProfile: _isOwnProfile,
                    tabType: ProfileTabType.saved,
                  ),
                  PostGridWithPreview(
                    userId: widget.userId,
                    isOwnProfile: _isOwnProfile,
                    tabType: ProfileTabType.liked,
                  ),
                  PostGridWithPreview(
                    userId: widget.userId,
                    isOwnProfile: _isOwnProfile,
                    tabType: ProfileTabType.polls,
                  ),
                  PostGridWithPreview(
                    userId: widget.userId,
                    isOwnProfile: _isOwnProfile,
                    tabType: ProfileTabType.petitions,
                  ),
                ],
              ),
            ),
          );
        },
      ),
    );
  }
}

// ======== Other User Profile Screen ========
class OtherUserProfileScreen extends StatefulWidget {
  final String userId;
  const OtherUserProfileScreen({required this.userId});

  @override
  _OtherUserProfileScreenState createState() => _OtherUserProfileScreenState();
}

class _OtherUserProfileScreenState extends State<OtherUserProfileScreen> {
  bool _isFollowing = false;

  @override
  void initState() {
    super.initState();
    _checkIfFollowing();
  }

  void _checkIfFollowing() async {
    final doc = await FirebaseFirestore.instance
        .collection('users')
        .doc(widget.userId)
        .get();
    if (doc.exists) {
      setState(
        () => _isFollowing = List<String>.from(
          doc.data()?['followers'] ?? [],
        ).contains(FirebaseAuth.instance.currentUser!.uid),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: const Text(
          'Profile',
          style: TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: Colors.transparent,
        elevation: 0,
      ),
      body: FutureBuilder<DocumentSnapshot>(
        future: FirebaseFirestore.instance
            .collection('users')
            .doc(widget.userId)
            .get(),
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting)
            return const Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryLavender,
              ),
            );

          final user = snapshot.data?.data() as Map<String, dynamic>? ?? {};

          //  CHECK PERSONALITY VISIBILITY FROM DB
          bool showPersonality = user['showPersonality'] ?? true;
          String? personalityType = user['personalityType'];
          String? personalityTitle = user['personalityTitle'];

          return DefaultTabController(
            length: 5,
            child: NestedScrollView(
              headerSliverBuilder: (context, innerBoxIsScrolled) {
                return [
                  SliverToBoxAdapter(
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Column(
                        children: [
                          CircleAvatar(
                            radius: 50,
                            backgroundColor: AppColors.elevation,
                            backgroundImage:
                                (user['profileImage'] ?? '').isNotEmpty
                                ? CachedNetworkImageProvider(
                                    user['profileImage'],
                                  )
                                : const AssetImage('assets/default_avatar.png')
                                      as ImageProvider,
                          ),
                          const SizedBox(height: 8),
                          Text(
                            user['fullName'] ?? 'No Name',
                            style: const TextStyle(
                              fontSize: 24,
                              fontWeight: FontWeight.bold,
                              color: AppColors.textHigh,
                            ),
                          ),
                          const SizedBox(height: 2),
                          Text(
                            '@${user['username'] ?? ''}',
                            style: const TextStyle(color: AppColors.textMedium),
                          ),
                          if (showPersonality && personalityType != null)
                            Container(
                              margin: const EdgeInsets.symmetric(vertical: 6),
                              padding: const EdgeInsets.symmetric(
                                horizontal: 12,
                                vertical: 4,
                              ),
                              decoration: BoxDecoration(
                                color: AppColors.elevation,
                                borderRadius: BorderRadius.circular(15),
                                border: Border.all(
                                  color: AppColors.secondaryTeal.withOpacity(
                                    0.5,
                                  ),
                                ),
                              ),
                              child: Row(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Icon(
                                    Feather.zap,
                                    size: 12,
                                    color: AppColors.secondaryTeal,
                                  ),
                                  const SizedBox(width: 6),
                                  Text(
                                    "$personalityType - $personalityTitle",
                                    style: const TextStyle(
                                      color: AppColors.textHigh,
                                      fontSize: 12,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ProfileStatsWidget(
                            userId: widget.userId,
                            isOwnProfile: false,
                          ),
                          Text(
                            user['bio'] ?? 'No bio yet',
                            textAlign: TextAlign.center,
                            style: const TextStyle(color: AppColors.textMedium),
                          ),
                          // ProfileStatsWidget moved up
                          const SizedBox(height: 16),
                          ElevatedButton(
                            onPressed: () async {
                              if (_isFollowing) {
                                await FirebaseFirestore.instance
                                    .collection('users')
                                    .doc(widget.userId)
                                    .update({
                                      'followers': FieldValue.arrayRemove([
                                        FirebaseAuth.instance.currentUser!.uid,
                                      ]),
                                    });
                                await FirebaseFirestore.instance
                                    .collection('users')
                                    .doc(FirebaseAuth.instance.currentUser!.uid)
                                    .update({
                                      'following': FieldValue.arrayRemove([
                                        widget.userId,
                                      ]),
                                    });
                              } else {
                                await FirebaseFirestore.instance
                                    .collection('users')
                                    .doc(widget.userId)
                                    .update({
                                      'followers': FieldValue.arrayUnion([
                                        FirebaseAuth.instance.currentUser!.uid,
                                      ]),
                                    });
                                await FirebaseFirestore.instance
                                    .collection('users')
                                    .doc(FirebaseAuth.instance.currentUser!.uid)
                                    .update({
                                      'following': FieldValue.arrayUnion([
                                        widget.userId,
                                      ]),
                                    });

                                // Send notification using service
                                final currentUser =
                                    FirebaseAuth.instance.currentUser;
                                if (currentUser != null) {
                                  final currentUserDoc = await FirebaseFirestore
                                      .instance
                                      .collection('users')
                                      .doc(currentUser.uid)
                                      .get();
                                  final followerUsername =
                                      currentUserDoc.data()?['username'] ??
                                      'Someone';
                                  await NotificationService()
                                      .sendFollowNotification(
                                        followedUserId: widget.userId,
                                        followerUsername: followerUsername,
                                      );
                                }
                              }
                              setState(() => _isFollowing = !_isFollowing);
                            },
                            style: ElevatedButton.styleFrom(
                              backgroundColor: _isFollowing
                                  ? AppColors.elevation
                                  : AppColors.secondaryTeal,
                            ),
                            child: Text(
                              _isFollowing ? 'Unfollow' : 'Follow',
                              style: TextStyle(
                                color: _isFollowing
                                    ? AppColors.textHigh
                                    : AppColors.backgroundDeep,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                  SliverPersistentHeader(
                    pinned: true,
                    delegate: _SliverAppBarDelegate(
                      const TabBar(
                        labelColor: AppColors.primaryLavender,
                        unselectedLabelColor: AppColors.textDisabled,
                        indicatorColor: AppColors.primaryLavender,
                        tabs: [
                          Tab(icon: Icon(Feather.grid, size: 18)),
                          Tab(icon: Icon(Feather.bookmark, size: 18)),
                          Tab(icon: Icon(Feather.heart, size: 18)),
                          Tab(icon: Icon(Feather.bar_chart_2, size: 18)),
                          Tab(icon: Icon(Feather.check_square, size: 18)),
                        ],
                      ),
                    ),
                  ),
                ];
              },
              body: TabBarView(
                children: [
                  PostGridWithPreview(
                    userId: widget.userId,
                    isOwnProfile: false,
                    tabType: ProfileTabType.activity,
                  ),
                  PostGridWithPreview(
                    userId: widget.userId,
                    isOwnProfile: false,
                    tabType: ProfileTabType.saved,
                  ),
                  PostGridWithPreview(
                    userId: widget.userId,
                    isOwnProfile: false,
                    tabType: ProfileTabType.liked,
                  ),
                  PostGridWithPreview(
                    userId: widget.userId,
                    isOwnProfile: false,
                    tabType: ProfileTabType.polls,
                  ),
                  PostGridWithPreview(
                    userId: widget.userId,
                    isOwnProfile: false,
                    tabType: ProfileTabType.petitions,
                  ),
                ],
              ),
            ),
          );
        },
      ),
    );
  }
}

// ======== Follow List Screen ========
class FollowListScreen extends StatefulWidget {
  final String userId;
  final bool showFollowers;
  const FollowListScreen({required this.userId, required this.showFollowers});

  @override
  _FollowListScreenState createState() => _FollowListScreenState();
}

class _FollowListScreenState extends State<FollowListScreen> {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        title: Text(
          widget.showFollowers ? 'Followers' : 'Following',
          style: const TextStyle(color: AppColors.textHigh),
        ),
        backgroundColor: Colors.transparent,
        elevation: 0,
      ),
      body: StreamBuilder<DocumentSnapshot>(
        stream: FirebaseFirestore.instance
            .collection('users')
            .doc(widget.userId)
            .snapshots(),
        builder: (context, userSnapshot) {
          if (userSnapshot.connectionState == ConnectionState.waiting)
            return const Center(
              child: CircularProgressIndicator(
                color: AppColors.primaryLavender,
              ),
            );

          final u = userSnapshot.data?.data() as Map<String, dynamic>? ?? {};
          final ids = List<String>.from(
            widget.showFollowers
                ? (u['followers'] ?? [])
                : (u['following'] ?? []),
          );

          if (ids.isEmpty)
            return Center(
              child: Text(
                widget.showFollowers
                    ? 'No followers yet'
                    : 'Not following anyone',
                style: const TextStyle(color: AppColors.textMedium),
              ),
            );

          return ListView.builder(
            itemCount: ids.length,
            itemBuilder: (context, index) => FutureBuilder<DocumentSnapshot>(
              future: FirebaseFirestore.instance
                  .collection('users')
                  .doc(ids[index])
                  .get(),
              builder: (context, snap) {
                final user = snap.data?.data() as Map<String, dynamic>? ?? {};
                return ListTile(
                  leading: CircleAvatar(
                    backgroundColor: AppColors.elevation,
                    backgroundImage: (user['profileImage'] ?? '').isNotEmpty
                        ? CachedNetworkImageProvider(user['profileImage'])
                        : const AssetImage('assets/default_avatar.png')
                              as ImageProvider,
                  ),
                  title: Text(
                    user['username'] ?? 'Loading...',
                    style: const TextStyle(color: AppColors.textHigh),
                  ),
                  subtitle: Text(
                    user['fullName'] ?? '',
                    style: const TextStyle(color: AppColors.textMedium),
                  ),
                  onTap: () => Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (context) =>
                          ids[index] == FirebaseAuth.instance.currentUser!.uid
                          ? ProfileScreen(userId: ids[index])
                          : OtherUserProfileScreen(userId: ids[index]),
                    ),
                  ),
                );
              },
            ),
          );
        },
      ),
    );
  }
}

// ======== Profile Stats Widget ========
class ProfileStatsWidget extends StatelessWidget {
  final String userId;
  final bool isOwnProfile;
  const ProfileStatsWidget({required this.userId, required this.isOwnProfile});

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          _buildStat(
            "posts",
            FirebaseFirestore.instance
                .collection('posts')
                .where('userId', isEqualTo: userId)
                .snapshots()
                .map((s) => s.docs.length),
          ),
          const SizedBox(width: 16),
          GestureDetector(
            onTap: () => Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) =>
                    FollowListScreen(userId: userId, showFollowers: true),
              ),
            ),
            child: _buildStatFuture("followers", userId, true),
          ),
          const SizedBox(width: 16),
          GestureDetector(
            onTap: () => Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) =>
                    FollowListScreen(userId: userId, showFollowers: false),
              ),
            ),
            child: _buildStatFuture("following", userId, false),
          ),
          const SizedBox(width: 16),
          _buildEmbersStat(userId),
        ],
      ),
    );
  }

  Widget _buildStat(String label, Stream<int> stream) => StreamBuilder<int>(
    stream: stream,
    builder: (context, snapshot) => Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Text(
          (snapshot.data ?? 0).toString(),
          style: const TextStyle(
            fontWeight: FontWeight.bold,
            fontSize: 14,
            color: AppColors.textHigh,
          ),
        ),
        const SizedBox(width: 4),
        Text(
          label,
          style: const TextStyle(
            fontSize: 13,
            fontWeight: FontWeight.normal,
            color: AppColors.textMedium,
          ),
        ),
      ],
    ),
  );

  Widget _buildStatFuture(
    String label,
    String userId,
    bool f,
  ) => FutureBuilder<DocumentSnapshot>(
    future: FirebaseFirestore.instance.collection('users').doc(userId).get(),
    builder: (context, snapshot) => Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Text(
          (List.from(
            (snapshot.data?.data() as Map?)?[f ? 'followers' : 'following'] ??
                [],
          )).length.toString(),
          style: const TextStyle(
            fontWeight: FontWeight.bold,
            fontSize: 14,
            color: AppColors.textHigh,
          ),
        ),
        const SizedBox(width: 4),
        Text(
          label,
          style: const TextStyle(
            fontSize: 13,
            fontWeight: FontWeight.normal,
            color: AppColors.textMedium,
          ),
        ),
      ],
    ),
  );

  Widget _buildEmbersStat(String userId) => StreamBuilder<DocumentSnapshot>(
    stream: FirebaseFirestore.instance
        .collection('users')
        .doc(userId)
        .snapshots(),
    builder: (context, snapshot) => Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Text(
          ((snapshot.data?.data() as Map?)?['embers'] ?? 0).toString(),
          style: const TextStyle(
            fontWeight: FontWeight.bold,
            fontSize: 14,
            color: AppColors.textHigh,
          ),
        ),
        const SizedBox(width: 4),
        Text(
          "embers",
          style: const TextStyle(
            fontSize: 13,
            fontWeight: FontWeight.normal,
            color: AppColors.textMedium,
          ),
        ),
      ],
    ),
  );
}

class _SliverAppBarDelegate extends SliverPersistentHeaderDelegate {
  _SliverAppBarDelegate(this._tabBar);

  final TabBar _tabBar;

  @override
  double get minExtent => _tabBar.preferredSize.height;
  @override
  double get maxExtent => _tabBar.preferredSize.height;

  @override
  Widget build(
    BuildContext context,
    double shrinkOffset,
    bool overlapsContent,
  ) {
    return Container(color: AppColors.surface.withOpacity(0.8), child: _tabBar);
  }

  @override
  bool shouldRebuild(_SliverAppBarDelegate oldDelegate) {
    return false;
  }
}


--- C:\Code\femn\lib\hub_screens\search.dart ---

import 'package:femn/circle/petitions.dart';
import 'dart:async';
import 'post.dart';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:femn/hub_screens/profile.dart';
import 'package:femn/customization/colors.dart'; // <--- IMPORT COLORS
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_staggered_grid_view/flutter_staggered_grid_view.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:femn/customization/layout.dart';

// Enhanced Search Screen with multiple search types and smart features
class SearchScreen extends StatefulWidget {
  @override
  _SearchScreenState createState() => _SearchScreenState();
}

class _SearchScreenState extends State<SearchScreen> {
  final TextEditingController _searchController = TextEditingController();
  final FocusNode _searchFocusNode = FocusNode();
  
  List<dynamic> _searchResults = [];
  List<String> _searchSuggestions = [];
  List<Map<String, dynamic>> _recentSearches = [];
  List<String> _trendingHashtags = [];
  List<Map<String, dynamic>> _suggestedUsers = [];
  
  bool _isSearching = false;
  bool _showSuggestions = false;
  SearchCategory _selectedCategory = SearchCategory.all;
  
  // Personalization data
  Set<String> _userInterests = {};
  Set<String> _followingIds = {};
  
  // Debouncing for search
  Timer? _debounceTimer;

  @override
  void initState() {
    super.initState();
    _loadPersonalizationData();
    _loadTrendingData();
    _loadRecentSearches();
    _loadSuggestedUsers();
  }

  @override
  void dispose() {
    _debounceTimer?.cancel();
    _searchController.dispose();
    _searchFocusNode.dispose();
    super.dispose();
  }

  // Load user preferences and network
  Future<void> _loadPersonalizationData() async {
    final currentUserId = FirebaseAuth.instance.currentUser!.uid;
    try {
      final userDoc = await FirebaseFirestore.instance
          .collection('users')
          .doc(currentUserId)
          .get();
          
      if (userDoc.exists) {
        setState(() {
          _userInterests = Set<String>.from(userDoc['interests'] ?? []);
          _followingIds = Set<String>.from(userDoc['following'] ?? []);
        });
      }
    } catch (e) {
      print('Error loading personalization data: $e');
    }
  }

  // Load trending hashtags and content
  Future<void> _loadTrendingData() async {
    try {
      final hashtagsSnapshot = await FirebaseFirestore.instance
          .collection('trending')
          .doc('hashtags')
          .get();
          
      if (hashtagsSnapshot.exists) {
        setState(() {
          _trendingHashtags = List<String>.from(hashtagsSnapshot['trending'] ?? []);
        });
      }
    } catch (e) {
      print('Error loading trending data: $e');
    }
  }

  // Load suggested users based on network and interests
  Future<void> _loadSuggestedUsers() async {
    try {
      final currentUserId = FirebaseAuth.instance.currentUser!.uid;
      final usersSnapshot = await FirebaseFirestore.instance
          .collection('users')
          .where('uid', isNotEqualTo: currentUserId)
          .limit(10)
          .get();
          
      // Simple suggestion algorithm
      final suggested = usersSnapshot.docs
          .map((doc) => doc.data())
          .where((user) => _userInterests.any((interest) => 
              user['bio']?.toLowerCase().contains(interest.toLowerCase()) == true ||
              user['username'].toLowerCase().contains(interest.toLowerCase())))
          .toList();
          
      setState(() {
        _suggestedUsers = suggested;
      });
    } catch (e) {
      print('Error loading suggested users: $e');
    }
  }

  // Load recent searches from local storage or Firestore
  Future<void> _loadRecentSearches() async {
    // Simplified version
    setState(() {
      _recentSearches = []; 
    });
  }

  // Save search to recent searches
  void _saveToRecentSearches(String query, String type) {
    final searchItem = {
      'query': query,
      'type': type,
      'timestamp': DateTime.now().millisecondsSinceEpoch,
    };
    
    setState(() {
      _recentSearches.removeWhere((item) => item['query'] == query);
      _recentSearches.insert(0, searchItem);
      if (_recentSearches.length > 10) {
        _recentSearches.removeLast();
      }
    });
    
    // Save to Firestore for cross-device sync
    _saveRecentSearchToFirestore(searchItem);
  }

  Future<void> _saveRecentSearchToFirestore(Map<String, dynamic> searchItem) async {
    final currentUserId = FirebaseAuth.instance.currentUser!.uid;
    try {
      await FirebaseFirestore.instance
          .collection('users')
          .doc(currentUserId)
          .collection('recentSearches')
          .add(searchItem);
    } catch (e) {
      print('Error saving recent search: $e');
    }
  }

  // Smart search with debouncing and multiple data sources
  void _performSearch(String query) async {
    if (query.isEmpty) {
      setState(() {
        _searchResults = [];
        _isSearching = false;
        _showSuggestions = true;
      });
      return;
    }

    // Cancel previous debounce timer
    _debounceTimer?.cancel();
    
    // Show suggestions while typing
    if (query.length > 1) {
      _generateSearchSuggestions(query);
    }

    // Set up new debounce timer
    _debounceTimer = Timer(const Duration(milliseconds: 300), () async {
      if (query.isEmpty) return;

      setState(() {
        _isSearching = true;
        _showSuggestions = false;
      });

      try {
        final results = await _searchAcrossAllCategories(query);
        setState(() {
          _searchResults = results;
          _isSearching = false;
        });

        // Save to recent searches
        _saveToRecentSearches(query, 'search');
      } catch (e) {
        print('Search error: $e');
        setState(() {
          _isSearching = false;
        });
      }
    });
  }

  // Generate smart search suggestions
  void _generateSearchSuggestions(String query) async {
    try {
      // Get all users and posts for suggestions
      final usersSnapshot = await FirebaseFirestore.instance
          .collection('users')
          .limit(20)
          .get();

      final postsSnapshot = await FirebaseFirestore.instance
          .collection('posts')
          .limit(20)
          .get();

      final suggestions = <String>[];
      final queryLower = query.toLowerCase();
      
      // Add user suggestions
      suggestions.addAll(usersSnapshot.docs
          .where((doc) {
            final user = doc.data();
            final username = user['username']?.toString().toLowerCase() ?? '';
            return username.contains(queryLower);
          })
          .map((doc) => '@${doc['username']}')
          .toList());

      // Extract hashtags and keywords from posts
      for (final doc in postsSnapshot.docs) {
        final post = doc.data();
        final caption = post['caption']?.toString() ?? '';
        
        // Extract hashtags
        final hashtags = _extractHashtags(caption);
        suggestions.addAll(hashtags.where((tag) => 
            tag.toLowerCase().contains(queryLower)));
        
        // Add caption keywords
        final keywords = _extractKeywords(caption);
        suggestions.addAll(keywords.where((keyword) =>
            keyword.toLowerCase().contains(queryLower)));
      }

      // Remove duplicates and limit
      final uniqueSuggestions = suggestions.toSet().toList();
      setState(() {
        _searchSuggestions = uniqueSuggestions.take(8).toList();
        _showSuggestions = true;
      });
    } catch (e) {
      print('Error generating suggestions: $e');
    }
  }

  List<String> _extractHashtags(String text) {
    final regex = RegExp(r'#(\w+)');
    return regex.allMatches(text).map((match) => match.group(0)!).toList();
  }

  List<String> _extractKeywords(String text) {
    return text.split(' ')
        .where((word) => word.length > 2)
        .map((word) => word.trim())
        .where((word) => !word.startsWith('#'))
        .toList();
  }

  // Search across all categories with relevance scoring
  Future<List<dynamic>> _searchAcrossAllCategories(String query) async {
    try {
      final results = <Map<String, dynamic>>[];
      
      // Search users
      final users = await _searchUsers(query);
      results.addAll(users);

      // Search posts by caption and hashtags
      final posts = await _searchPosts(query);
      results.addAll(posts);

      // Search hashtags
      final hashtags = await _searchHashtags(query);
      results.addAll(hashtags);
      
      // Search petitions
      final petitions = await _searchPetitions(query);
      results.addAll(petitions);

      // Sort by relevance score
      results.sort((a, b) => (b['relevanceScore'] ?? 0).compareTo(a['relevanceScore'] ?? 0));
      
      return results;
      
    } catch (e) {
      print('Search error: $e');
      return [];
    }
  }

  // Enhanced user search with local filtering
  Future<List<Map<String, dynamic>>> _searchUsers(String query) async {
    try {
      final usersSnapshot = await FirebaseFirestore.instance
          .collection('users')
          .get();

      return usersSnapshot.docs
          .where((doc) {
            final user = doc.data();
            final username = user['username']?.toString().toLowerCase() ?? '';
            final fullName = user['fullName']?.toString().toLowerCase() ?? '';
            final queryLower = query.toLowerCase().replaceFirst('@', '');
            
            return username.contains(queryLower) || 
                   fullName.contains(queryLower);
          })
          .map((doc) {
            final user = doc.data();
            double relevanceScore = _calculateUserRelevanceScore(user, query);
            
            return {
              'type': 'user',
              'data': user,
              'relevanceScore': relevanceScore,
              'id': doc.id,
            };
          })
          .toList();
    } catch (e) {
      print('Error searching users: $e');
      return [];
    }
  }

  // Enhanced post search with local filtering
  Future<List<Map<String, dynamic>>> _searchPosts(String query) async {
    try {
      final postsSnapshot = await FirebaseFirestore.instance
          .collection('posts')
          .get();

      return postsSnapshot.docs
          .where((doc) {
            final post = doc.data();
            final caption = post['caption']?.toString().toLowerCase() ?? '';
            final hashtags = List<String>.from(post['hashtags'] ?? []);
            final queryLower = query.toLowerCase();
            
            // Search in caption
            if (caption.contains(queryLower)) return true;
            
            // Search in hashtags
            if (hashtags.any((tag) => tag.toLowerCase().contains(queryLower.replaceFirst('#', '')))) {
              return true;
            }
            
            return false;
          })
          .map((doc) {
            final post = doc.data();
            double relevanceScore = _calculatePostRelevanceScore(post, query);
            
            return {
              'type': 'post',
              'data': post,
              'relevanceScore': relevanceScore,
              'id': doc.id,
            };
          })
          .toList();
    } catch (e) {
      print('Error searching posts: $e');
      return [];
    }
  }

  // Enhanced hashtag search
  Future<List<Map<String, dynamic>>> _searchHashtags(String query) async {
    try {
      final cleanQuery = query.replaceFirst('#', '').toLowerCase();
      
      final postsSnapshot = await FirebaseFirestore.instance
          .collection('posts')
          .get();

      // Find all unique hashtags across posts
      final allHashtags = <String, int>{};
      
      for (final doc in postsSnapshot.docs) {
        final post = doc.data();
        final hashtags = List<String>.from(post['hashtags'] ?? []);
        
        for (final tag in hashtags) {
          final cleanTag = tag.toLowerCase();
          if (cleanTag.contains(cleanQuery)) {
            allHashtags[tag] = (allHashtags[tag] ?? 0) + 1;
          }
        }
      }

      return allHashtags.entries.map((entry) {
        return {
          'type': 'hashtag',
          'data': {
            'tag': '#${entry.key}',
            'popularity': entry.value,
          },
          'relevanceScore': entry.value.toDouble(),
          'id': entry.key,
        };
      }).toList();
    } catch (e) {
      print('Error searching hashtags: $e');
      return [];
    }
  }

  Future<List<Map<String, dynamic>>> _searchPetitions(String query) async {
    try {
      final petitionsSnapshot = await FirebaseFirestore.instance
          .collection('petitions')
          .get();

      return petitionsSnapshot.docs
          .where((doc) {
            final petition = doc.data();
            final title = petition['title']?.toString().toLowerCase() ?? '';
            final description = petition['description']?.toString().toLowerCase() ?? '';
            final queryLower = query.toLowerCase();
            
            return title.contains(queryLower) || description.contains(queryLower);
          })
          .map((doc) {
            final petition = doc.data();
            petition['id'] = doc.id; // Ensure ID is in the data map
            double relevanceScore = _calculatePetitionRelevanceScore(petition, query);
            
            return {
              'type': 'petition',
              'data': petition,
              'relevanceScore': relevanceScore,
              'id': doc.id,
            };
          })
          .toList();
    } catch (e) {
      print('Error searching petitions: $e');
      return [];
    }
  }

  // Relevance scoring algorithms
  double _calculatePetitionRelevanceScore(Map<String, dynamic> petition, String query) {
    double score = 0.0;
    final title = petition['title']?.toString().toLowerCase() ?? '';
    final queryLower = query.toLowerCase();

    if (title == queryLower) score += 100;
    else if (title.startsWith(queryLower)) score += 60;
    else if (title.contains(queryLower)) score += 30;

    final goal = petition['goal'] ?? 0;
    final signatures = petition['currentSignatures'] ?? 0;
    if (goal > 0) {
      score += (signatures / goal) * 50;
    }
    
    return score;
  }

  double _calculateUserRelevanceScore(Map<String, dynamic> user, String query) {
    double score = 0.0;
    final username = user['username']?.toString().toLowerCase() ?? '';
    final fullName = user['fullName']?.toString().toLowerCase() ?? '';
    final queryLower = query.toLowerCase();

    if (username == queryLower) score += 100;
    else if (username.startsWith(queryLower)) score += 50;
    else if (username.contains(queryLower)) score += 25;

    if (fullName.contains(queryLower)) score += 20;
    if (user['isVerified'] == true) score += 30;
    if (_followingIds.contains(user['uid'])) score += 40;

    final mutualCount = _calculateMutualConnections(user);
    score += mutualCount * 5;

    return score;
  }

  double _calculatePostRelevanceScore(Map<String, dynamic> post, String query) {
    double score = 0.0;
    final caption = post['caption']?.toString().toLowerCase() ?? '';
    final queryLower = query.toLowerCase();

    if (caption == queryLower) score += 60;
    else if (caption.startsWith(queryLower)) score += 40;
    else if (caption.contains(queryLower)) score += 20;

    final hashtags = List<String>.from(post['hashtags'] ?? []);
    if (hashtags.any((tag) => tag.toLowerCase().contains(queryLower.replaceFirst('#', '')))) {
      score += 30;
    }

    final likes = List<String>.from(post['likes'] ?? []).length;
    final comments = post['comments'] ?? 0;
    score += (likes * 0.1) + (comments * 0.2);

    final timestamp = post['timestamp']?.toDate() ?? DateTime.now();
    final ageInHours = DateTime.now().difference(timestamp).inHours;
    if (ageInHours < 24) score += 20;
    if (ageInHours < 1) score += 30;

    return score;
  }

  int _calculateMutualConnections(Map<String, dynamic> user) {
    final userFollowing = Set<String>.from(user['following'] ?? []);
    return userFollowing.intersection(_followingIds).length;
  }

  // Filter results by category
  List<dynamic> _getFilteredResults() {
    if (_selectedCategory == SearchCategory.all) {
      return _searchResults;
    }
    
    return _searchResults.where((item) {
      switch (_selectedCategory) {
        case SearchCategory.users:
          return item['type'] == 'user';
        case SearchCategory.posts:
          return item['type'] == 'post';
        case SearchCategory.hashtags:
          return item['type'] == 'hashtag';
        case SearchCategory.petitions:
          return item['type'] == 'petition';
        default:
          return true;
      }
    }).toList();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent, // Deep background
      body: SafeArea(
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Enhanced Search Bar
            _buildSearchBar(),
            
            // Search Categories
            _buildCategoryFilter(),
            
            // Search Results or Default State
            Expanded(
              child: _buildSearchContent(),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildSearchBar() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12),
        decoration: BoxDecoration(
          color: AppColors.elevation, // Dark container
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.2),
              blurRadius: 6,
              offset: const Offset(0, 2),
            ),
          ],
        ),
        child: Row(
          children: [
            const Icon(Feather.search, color: AppColors.primaryLavender),
            const SizedBox(width: 8),
            Expanded(
              child: TextField(
                controller: _searchController,
                focusNode: _searchFocusNode,
                decoration: InputDecoration(
                  hintText: 'Search users, posts, hashtags...',
                  hintStyle: TextStyle(color: AppColors.textDisabled),
                  border: InputBorder.none,
                  suffixIcon: _searchController.text.isNotEmpty
                      ? IconButton(
                          icon: const Icon(Feather.x, color: AppColors.primaryLavender),
                          onPressed: () {
                            _searchController.clear();
                            _performSearch('');
                            _searchFocusNode.unfocus();
                          },
                        )
                      : null,
                ),
                onChanged: _performSearch,
                onTap: () {
                  setState(() {
                    _showSuggestions = _searchController.text.isNotEmpty;
                  });
                },
                style: const TextStyle(color: AppColors.textHigh), // Off-white text
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildCategoryFilter() {
    return Container(
      height: 45,
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 12),
        child: ListView.builder(
          scrollDirection: Axis.horizontal,
          itemCount: SearchCategory.values.length,
          itemBuilder: (context, index) {
            final category = SearchCategory.values[index];
            final isSelected = _selectedCategory == category;

            return GestureDetector(
              onTap: () {
                setState(() {
                  _selectedCategory = category;
                });
              },
              child: AnimatedContainer(
                duration: const Duration(milliseconds: 200),
                curve: Curves.easeInOut,
                padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                margin: const EdgeInsets.symmetric(horizontal: 6, vertical: 6),
                decoration: BoxDecoration(
                  // Teal for active, Elevation for inactive
                  color: isSelected ? AppColors.secondaryTeal : AppColors.elevation,
                  borderRadius: BorderRadius.circular(16),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(isSelected ? 0.3 : 0.1),
                      blurRadius: isSelected ? 6 : 4,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: Center(
                  child: Text(
                    category.name.toUpperCase(),
                    style: TextStyle(
                      color: isSelected ? Colors.white : AppColors.textMedium,
                      fontWeight: isSelected ? FontWeight.bold : FontWeight.w500,
                      fontSize: 14,
                    ),
                  ),
                ),
              ),
            );
          },
        ),
      ),
    );
  }

  Widget _buildSearchContent() {
    if (_isSearching) {
      return const GridShimmerSkeleton();
    }

    if (_searchController.text.isNotEmpty) {
      if (_showSuggestions && _searchSuggestions.isNotEmpty) {
        return _buildSuggestionsList();
      }
      
      final filteredResults = _getFilteredResults();
      if (filteredResults.isEmpty) {
        return _buildNoResults();
      }
      
      return _buildSearchResults(filteredResults);
    }

    // Default state - show trending and suggestions
    return _buildDefaultContent();
  }

  Widget _buildSuggestionsList() {
    if (_searchSuggestions.isEmpty) {
      return const SizedBox.shrink();
    }

    return ListView.builder(
      padding: const EdgeInsets.all(8),
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      itemCount: _searchSuggestions.length,
      itemBuilder: (context, index) {
        final suggestion = _searchSuggestions[index];
        return ListTile(
          leading: Icon(
            suggestion.startsWith('@') ? Feather.user : Feather.hash,
            color: AppColors.textMedium,
          ),
          title: Text(suggestion, style: TextStyle(color: AppColors.textHigh)),
          onTap: () {
            _searchController.text = suggestion;
            _performSearch(suggestion);
            FocusScope.of(context).unfocus();
          },
        );
      },
    );
  }

  Widget _buildSearchResults(List<dynamic> results) {
    // Separate posts from other types
    final posts = results.where((item) => item['type'] == 'post').toList();
    final nonPosts = results.where((item) => item['type'] != 'post').toList();

    return ListView(
      padding: EdgeInsets.all(8),
      children: [
        // Show non-post items first (users, hashtags)
        ...nonPosts.map((item) {
          switch (item['type']) {
            case 'user':
              return _buildUserResult(item['data']);
            case 'hashtag':
              return _buildHashtagResult(item['data']);
            case 'petition':
              return _buildPetitionResult(item['data']);
            default:
              return SizedBox();
          }
        }),
        
        // Show posts in staggered grid if there are any
        if (posts.isNotEmpty) ...[
          if (nonPosts.isNotEmpty) SizedBox(height: 16),
          _buildPostGrid(posts),
        ],
      ],
    );
  }

  Widget _buildPostGrid(List<dynamic> posts) {
    return MasonryGridView.count(
      crossAxisCount: ResponsiveLayout.getColumnCount(context), 
      mainAxisSpacing: 10,
      crossAxisSpacing: 10,
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      itemCount: posts.length,
      itemBuilder: (context, index) {
        final post = posts[index]['data'];
        final postId = posts[index]['id'];
        final mediaUrl = post['mediaUrl'] ?? '';
        final mediaType = post['mediaType'] ?? 'image';
        final caption = post['caption'] ?? '';
        final userId = post['userId'] ?? '';
        // final likes = List<String>.from(post['likes'] ?? []);

        final randomHeightFactor = ((postId.hashCode % 2) + 1.4);
        final double imageHeight = 120.0 * randomHeightFactor;
        final double borderRadiusValue = 20.0;

        return GestureDetector(
          onTap: () {
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) => PostDetailScreen(
                  postId: postId,
                  userId: userId,
                ),
              ),
            );
          },
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            mainAxisSize: MainAxisSize.min,
            children: [
              // --- Media container ---
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(borderRadiusValue),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.3),
                      blurRadius: 8,
                      spreadRadius: 0.5,
                      offset: const Offset(0, 3),
                    ),
                  ],
                ),
                child: ClipRRect(
                  borderRadius: BorderRadius.circular(borderRadiusValue),
                  child: mediaType == 'image'
                      ? CachedNetworkImage(
                          imageUrl: mediaUrl,
                          width: double.infinity,
                          height: imageHeight,
                          fit: BoxFit.cover,
                          placeholder: (context, url) => Container(
                            height: imageHeight,
                            color: AppColors.elevation,
                            child: Center(child: CircularProgressIndicator(strokeWidth: 2, color: AppColors.primaryLavender)),
                          ),
                          errorWidget: (context, url, error) => Container(
                            height: imageHeight,
                            color: AppColors.elevation,
                            child: const Center(
                              child: Icon(Feather.alert_circle, color: AppColors.error),
                            ),
                          ),
                        )
                      : Container(
                          height: imageHeight,
                          color: Colors.black,
                          child: const Center(
                            child: Icon(Feather.play, color: Colors.white, size: 36),
                          ),
                        ),
                ),
              ),
              if (caption.isNotEmpty)
                Padding(
                  padding: const EdgeInsets.only(top: 6.0, left: 4.0, right: 4.0),
                  child: Text(
                    caption,
                    style: const TextStyle(
                      fontSize: 12,
                      fontWeight: FontWeight.w400,
                      color: AppColors.textMedium, // Light gray for caption
                    ),
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildUserResult(Map<String, dynamic> user) {
    return GestureDetector(
      onTap: () {
        if (user['uid'] == FirebaseAuth.instance.currentUser!.uid) {
          Navigator.push(context, MaterialPageRoute(builder: (context) => ProfileScreen(userId: user['uid'])));
        } else {
          // Navigator.push(context, MaterialPageRoute(builder: (context) => OtherUserProfileScreen(userId: user['uid'])));
        }
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        margin: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),
        decoration: BoxDecoration(
          color: AppColors.surface, // Surface card
          borderRadius: BorderRadius.circular(12),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.2),
              blurRadius: 4,
              offset: const Offset(0, 2),
            ),
          ],
        ),
        child: Row(
          children: [
            Container(
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                boxShadow: [
                  BoxShadow(color: Colors.black.withOpacity(0.2), blurRadius: 6, offset: const Offset(0, 2)),
                ],
              ),
              child: CircleAvatar(
                radius: 24,
                backgroundColor: AppColors.elevation,
                backgroundImage: (user['profileImage']?.isNotEmpty == true)
                    ? CachedNetworkImageProvider(user['profileImage'])
                    : const AssetImage('assets/default_avatar.png') as ImageProvider,
              ),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Flexible(
                        child: Text(
                          user['username']?.toString() ?? 'Unknown',
                          style: const TextStyle(
                            fontWeight: FontWeight.bold,
                            fontSize: 14,
                            color: AppColors.primaryLavender, // Lavender username
                          ),
                          overflow: TextOverflow.ellipsis,
                        ),
                      ),
                      if (user['isVerified'] == true) const SizedBox(width: 4),
                      if (user['isVerified'] == true)
                        const Icon(Feather.check_circle, color: Colors.blue, size: 16),
                    ],
                  ),
                  const SizedBox(height: 2),
                  Text(
                    user['fullName']?.toString() ?? '',
                    style: const TextStyle(
                      fontSize: 12,
                      color: AppColors.textMedium,
                    ),
                    overflow: TextOverflow.ellipsis,
                  ),
                ],
              ),
            ),
            const SizedBox(width: 8),
            GestureDetector(
              onTap: () => _followUser(user['uid']),
              child: Container(
                height: 32,
                padding: const EdgeInsets.symmetric(horizontal: 16),
                decoration: BoxDecoration(
                  color: _followingIds.contains(user['uid'])
                      ? AppColors.elevation // Following = Dark Gray
                      : AppColors.primaryLavender, // Follow = Lavender
                  borderRadius: BorderRadius.circular(16),
                ),
                alignment: Alignment.center,
                child: Text(
                  _followingIds.contains(user['uid']) ? 'Following' : 'Follow',
                  style: TextStyle(
                    color: _followingIds.contains(user['uid']) ? AppColors.textMedium : AppColors.backgroundDeep,
                    fontSize: 12,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildHashtagResult(Map<String, dynamic> hashtag) {
    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: AppColors.surface,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.2),
            blurRadius: 4,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: ListTile(
        contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),
        leading: Container(
          width: 48,
          height: 48,
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            color: AppColors.elevation,
          ),
          child: const Center(
            child: Icon(Feather.hash, color: AppColors.primaryLavender, size: 22),
          ),
        ),
        title: Text(
          hashtag['tag']?.toString() ?? '',
          style: const TextStyle(
            fontWeight: FontWeight.bold,
            fontSize: 14,
            color: AppColors.primaryLavender,
          ),
        ),
        subtitle: Text(
          '${hashtag['popularity']} posts',
          style: TextStyle(fontSize: 12, color: AppColors.textMedium),
        ),
        trailing: const Icon(Feather.chevron_right, size: 16, color: AppColors.textDisabled),
        onTap: () {
          _searchController.text = hashtag['tag'].toString();
          _performSearch(hashtag['tag'].toString());
        },
      ),
    );
  }

  Widget _buildPetitionResult(Map<String, dynamic> petition) {
    final title = petition['title'] ?? 'Untitled Petition';
    final progress = (petition['goal'] ?? 0) > 0 
        ? (petition['currentSignatures'] ?? 0) / petition['goal'] 
        : 0.0;

    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: AppColors.surface,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.2),
            blurRadius: 4,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: ListTile(
        contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),
        leading: Container(
          width: 48,
          height: 48,
          decoration: BoxDecoration(
            color: AppColors.elevation,
            borderRadius: BorderRadius.circular(8),
          ),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(8),
            child: (petition['bannerImageUrl'] != null && petition['bannerImageUrl'].toString().isNotEmpty)
                ? CachedNetworkImage(
                    imageUrl: petition['bannerImageUrl'],
                    fit: BoxFit.cover,
                  )
                : const Icon(Feather.flag, color: AppColors.primaryLavender),
          ),
        ),
        title: Text(title, style: const TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold, fontSize: 14)),
        subtitle: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text('${petition['currentSignatures'] ?? 0} signed', style: const TextStyle(color: AppColors.textMedium, fontSize: 12)),
            const SizedBox(height: 4),
            ClipRRect(
              borderRadius: BorderRadius.circular(2),
              child: LinearProgressIndicator(
                value: progress,
                backgroundColor: AppColors.elevation,
                color: AppColors.secondaryTeal,
                minHeight: 4,
              ),
            ),
          ],
        ),
        onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) => EnhancedPetitionDetailScreen(petitionId: petition['id']),
            ),
          );
        },
      ),
    );
  }

  Widget _buildNoResults() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Feather.search, size: 64, color: AppColors.textDisabled),
          SizedBox(height: 16),
          Text(
            'No results found',
            style: TextStyle(fontSize: 18, color: AppColors.textMedium),
          ),
        ],
      ),
    );
  }

  Widget _buildDefaultContent() {
    return ListView(
      padding: EdgeInsets.all(12),
      children: [
        // Recent Searches
        if (_recentSearches.isNotEmpty) ...[
          _buildSectionHeader('Recent Searches'),
          ..._recentSearches.map((search) => _buildRecentSearchItem(search)),
          SizedBox(height: 16),
        ],
        
        // Trending Hashtags
        if (_trendingHashtags.isNotEmpty) ...[
          _buildSectionHeader('Trending Now'),
          Wrap(
            spacing: 8,
            runSpacing: 8,
            children: _trendingHashtags
                .take(10)
                .map((tag) => _buildTrendingTag(tag))
                .toList(),
          ),
          SizedBox(height: 16),
        ],
        
        // Suggested Users
        if (_suggestedUsers.isNotEmpty) ...[
          _buildSectionHeader('Suggested for You'),
          ..._suggestedUsers
              .take(5)
              .map((user) => _buildUserResult(user)),
        ],
      ],
    );
  }

  Widget _buildSectionHeader(String title) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Text(
        title,
        style: TextStyle(
          fontWeight: FontWeight.bold,
          fontSize: 16,
          color: AppColors.primaryLavender,
        ),
      ),
    );
  }

  Widget _buildRecentSearchItem(Map<String, dynamic> search) {
    return ListTile(
      leading: Icon(Feather.clock, color: AppColors.textMedium),
      title: Text(search['query']?.toString() ?? '', style: TextStyle(color: AppColors.textHigh)),
      trailing: IconButton(
        icon: Icon(Feather.x, size: 16, color: AppColors.textDisabled),
        onPressed: () => _removeRecentSearch(search['query']?.toString() ?? ''),
      ),
      onTap: () {
        _searchController.text = search['query']?.toString() ?? '';
        _performSearch(search['query']?.toString() ?? '');
      },
    );
  }

  Widget _buildTrendingTag(String tag) {
    return ActionChip(
      label: Text(tag),
      onPressed: () {
        _searchController.text = tag;
        _performSearch(tag);
      },
      backgroundColor: AppColors.elevation,
      labelStyle: TextStyle(color: AppColors.primaryLavender),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20), side: BorderSide.none),
    );
  }

  void _removeRecentSearch(String query) {
    setState(() {
      _recentSearches.removeWhere((item) => item['query'] == query);
    });
  }

  void _followUser(String userId) async {
    final currentUserId = FirebaseAuth.instance.currentUser!.uid;
    try {
      await FirebaseFirestore.instance
          .collection('users')
          .doc(currentUserId)
          .update({
        'following': FieldValue.arrayUnion([userId])
      });
      
      setState(() {
        _followingIds.add(userId);
      });
    } catch (e) {
      print('Error following user: $e');
    }
  }
}

// Search categories enum
enum SearchCategory {
  all,
  users,
  posts,
  hashtags,
  petitions,
}

// Extension to get display names
extension SearchCategoryExtension on SearchCategory {
  String get name {
    switch (this) {
      case SearchCategory.all:
        return 'All';
      case SearchCategory.users:
        return 'People';
      case SearchCategory.posts:
        return 'Posts';
      case SearchCategory.hashtags:
        return 'Hashtags';
      case SearchCategory.petitions:
        return 'Petitions';
    }
  }
}


--- C:\Code\femn\lib\hub_screens\settings.dart ---

// settings.dart
import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:femn/auth/auth.dart';
import 'package:femn/customization/colors.dart';
import 'package:femn/widgets/femn_background.dart';
import 'package:femn/hub_screens/settings_subpages.dart';

class SettingsScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      extendBodyBehindAppBar: true,
      appBar: AppBar(
        title: Text(
          "Settings",
          style: TextStyle(
            color: AppColors.textHigh,
            fontWeight: FontWeight.bold,
            fontSize: 18,
          ),
        ),
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(
          icon: Icon(Feather.arrow_left, color: AppColors.primaryLavender),
          onPressed: () => Navigator.pop(context),
        ),
      ),
      body: FemnBackground(
        child: ListView(
          padding: const EdgeInsets.only(
            top: kToolbarHeight + 20,
            left: 16,
            right: 16,
            bottom: 40,
          ),
          children: [
            _buildSectionHeader("Account Management"),
            _buildMenuTile(
              context,
              Feather.user,
              "Account",
              "Profile, Personal Info, Deletion",
              AccountManagementScreen(),
            ),

            _buildSectionHeader("Privacy & Security"),
            _buildMenuTile(
              context,
              Feather.eye,
              "Privacy",
              "Visibility, Status, Blocking",
              PrivacySettingsScreen(),
            ),
            _buildMenuTile(
              context,
              Feather.shield,
              "Security",
              "Password, 2FA, Activity",
              SecuritySettingsScreen(),
            ),

            _buildSectionHeader("Preferences"),
            _buildMenuTile(
              context,
              Feather.bell,
              "Notifications",
              "Push, Email, and SMS",
              NotificationSettingsScreen(),
            ),
            _buildMenuTile(
              context,
              Feather.sliders,
              "Content & Feed",
              "Quality, Autoplay, Language",
              ContentPreferencesScreen(),
            ),
            _buildMenuTile(
              context,
              Feather.monitor,
              "Accessibility & Display",
              "Themes, Text Size, Alt Text",
              AccessibilitySettingsScreen(),
            ),

            _buildSectionHeader("Information"),
            _buildMenuTile(
              context,
              Feather.help_circle,
              "Support & About",
              "FAQ, Legal, App Version",
              SupportAboutScreen(),
            ),

            SizedBox(height: 30),

            _buildActionTile(
              context,
              Feather.plus_circle,
              "Add Account",
              () => {},
              color: AppColors.primaryLavender,
            ),
            _buildActionTile(
              context,
              Feather.log_out,
              "Logout",
              () async {
                await FirebaseAuth.instance.signOut();
                Navigator.pushAndRemoveUntil(
                  context,
                  MaterialPageRoute(builder: (context) => LoginScreen()),
                  (route) => false,
                );
              },
              color: AppColors.error,
              isBold: true,
            ),

            Center(
              child: Padding(
                padding: const EdgeInsets.symmetric(vertical: 20.0),
                child: Text(
                  "Femn v1.0.4",
                  style: TextStyle(color: AppColors.textDisabled, fontSize: 12),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildSectionHeader(String title) {
    return Padding(
      padding: const EdgeInsets.only(left: 8, bottom: 8, top: 16),
      child: Text(
        title.toUpperCase(),
        style: TextStyle(
          color: AppColors.primaryLavender.withOpacity(0.8),
          fontWeight: FontWeight.bold,
          fontSize: 11,
          letterSpacing: 1.2,
        ),
      ),
    );
  }

  Widget _buildMenuTile(
    BuildContext context,
    IconData icon,
    String title,
    String subtitle,
    Widget screen,
  ) {
    return Container(
      margin: EdgeInsets.only(bottom: 8),
      decoration: BoxDecoration(
        color: AppColors.surface.withOpacity(0.7),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.elevation.withOpacity(0.5)),
      ),
      child: ListTile(
        contentPadding: EdgeInsets.symmetric(horizontal: 16, vertical: 4),
        leading: Container(
          padding: EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: AppColors.primaryLavender.withOpacity(0.1),
            borderRadius: BorderRadius.circular(12),
          ),
          child: Icon(icon, color: AppColors.primaryLavender, size: 20),
        ),
        title: Text(
          title,
          style: TextStyle(
            color: AppColors.textHigh,
            fontWeight: FontWeight.w600,
            fontSize: 15,
          ),
        ),
        subtitle: Text(
          subtitle,
          style: TextStyle(color: AppColors.textDisabled, fontSize: 12),
        ),
        trailing: Icon(
          Feather.chevron_right,
          color: AppColors.textDisabled,
          size: 16,
        ),
        onTap: () => Navigator.push(
          context,
          MaterialPageRoute(builder: (context) => screen),
        ),
      ),
    );
  }

  Widget _buildActionTile(
    BuildContext context,
    IconData icon,
    String title,
    VoidCallback onTap, {
    Color? color,
    bool isBold = false,
  }) {
    return Container(
      margin: EdgeInsets.only(bottom: 8),
      decoration: BoxDecoration(
        color: AppColors.surface.withOpacity(0.7),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.elevation.withOpacity(0.5)),
      ),
      child: ListTile(
        contentPadding: EdgeInsets.symmetric(horizontal: 16, vertical: 4),
        leading: Container(
          padding: EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: (color ?? AppColors.primaryLavender).withOpacity(0.1),
            borderRadius: BorderRadius.circular(12),
          ),
          child: Icon(
            icon,
            color: color ?? AppColors.primaryLavender,
            size: 20,
          ),
        ),
        title: Text(
          title,
          style: TextStyle(
            color: color ?? AppColors.textHigh,
            fontWeight: isBold ? FontWeight.bold : FontWeight.w600,
            fontSize: 15,
          ),
        ),
        trailing: Icon(
          Feather.chevron_right,
          color: AppColors.textDisabled,
          size: 16,
        ),
        onTap: onTap,
      ),
    );
  }
}

// --- CATEGORY SCREENS ---

class PrivacySettingsScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) => SettingsPageBase(
    title: "Privacy",
    children: [
      SettingsSwitchTile(
        icon: Feather.eye,
        title: "Account Visibility",
        subtitle: "Toggle between Public and Private status",
        value: false,
      ),
      SettingsSwitchTile(
        icon: Feather.activity,
        title: "Active Status",
        subtitle: "Show when you're online",
        value: true,
      ),
      SettingsActionTile(
        icon: Feather.slash,
        title: "Blocked Accounts",
        subtitle: "Manage users you've blocked",
      ),
      SettingsActionTile(
        icon: Feather.volume_x,
        title: "Muted Accounts",
        subtitle: "Content hidden without blocking",
      ),
      SettingsActionTile(
        icon: Feather.mail,
        title: "Messaging Privacy",
        subtitle: "Control who can send you direct messages",
        onTap: () => Navigator.push(
          context,
          MaterialPageRoute(builder: (context) => MessagingPrivacyScreen()),
        ),
      ),
      SettingsActionTile(
        icon: Feather.at_sign,
        title: "Tagging & Mentions",
        subtitle: "Control who can tag or mention you",
      ),
    ],
  );
}

class SecuritySettingsScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) => SettingsPageBase(
    title: "Security",
    children: [
      SettingsActionTile(
        icon: Feather.lock,
        title: "Change Password",
        subtitle: "Standard form to update your password",
      ),
      SettingsActionTile(
        icon: Feather.shield,
        title: "Two-Factor Authentication (2FA)",
        subtitle: "SMS or Authenticator app verification",
      ),
      SettingsActionTile(
        icon: Feather.monitor,
        title: "Login Activity",
        subtitle: "Manage active sessions and locations",
        onTap: () => Navigator.push(
          context,
          MaterialPageRoute(builder: (context) => LoginActivityScreen()),
        ),
      ),
      SettingsSwitchTile(
        icon: Feather.save,
        title: "Saved Login Info",
        subtitle: "Save credentials on this device",
        value: true,
      ),
    ],
  );
}

class NotificationSettingsScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) => SettingsPageBase(
    title: "Notifications",
    children: [
      SettingsHeader("Push Notifications"),
      SettingsSwitchTile(
        icon: Feather.heart,
        title: "Likes, Comments, & Mentions",
        subtitle: "Activity on your posts",
        value: true,
      ),
      SettingsSwitchTile(
        icon: Feather.user_plus,
        title: "New Followers",
        subtitle: "When someone follows you",
        value: true,
      ),
      SettingsSwitchTile(
        icon: Feather.message_square,
        title: "Direct Messages",
        subtitle: "New message alerts",
        value: true,
      ),
      SettingsSwitchTile(
        icon: Feather.info,
        title: "App updates/news",
        subtitle: "Stay informed about Femn",
        value: false,
      ),
      SettingsHeader("Email Notifications"),
      SettingsSwitchTile(
        icon: Feather.mail,
        title: "Marketing emails",
        subtitle: "Special offers and news",
        value: false,
      ),
      SettingsSwitchTile(
        icon: Feather.trending_up,
        title: "Product updates",
        subtitle: "New features and releases",
        value: true,
      ),
      SettingsSwitchTile(
        icon: Feather.list,
        title: "Activity digests",
        subtitle: "Summary of your network's activity",
        value: false,
      ),
      SettingsHeader("SMS Notifications"),
      SettingsSwitchTile(
        icon: Feather.shield,
        title: "Security alerts",
        subtitle: "Login attempts and account changes",
        value: true,
      ),
      SettingsSwitchTile(
        icon: Feather.key,
        title: "OTPs",
        subtitle: "One-time passwords for authentication",
        value: true,
      ),
    ],
  );
}

class ContentPreferencesScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) => SettingsPageBase(
    title: "Content & Feed",
    children: [
      SettingsActionTile(
        icon: Feather.image,
        title: "Media Quality",
        subtitle: "Data saver mode for cellular data",
        onTap: () => Navigator.push(
          context,
          MaterialPageRoute(builder: (context) => MediaQualityScreen()),
        ),
      ),
      SettingsSwitchTile(
        icon: Feather.play_circle,
        title: "Autoplay",
        subtitle: "Toggle video autoplay on/off (or Wi-Fi only)",
        value: false,
      ),
      SettingsActionTile(
        icon: Feather.alert_triangle,
        title: "Sensitive Content Control",
        subtitle: "Filter or blur sensitive content",
      ),
      SettingsActionTile(
        icon: Feather.globe,
        title: "Language",
        subtitle: "Set your app language preference",
        onTap: () => Navigator.push(
          context,
          MaterialPageRoute(builder: (context) => LanguageScreen()),
        ),
      ),
    ],
  );
}

class AccessibilitySettingsScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) => SettingsPageBase(
    title: "Accessibility & Display",
    children: [
      SettingsHeader("Appearance"),
      _buildAppearanceTile(context, "Light mode", false),
      _buildAppearanceTile(context, "Dark mode", true),
      _buildAppearanceTile(context, "System Default", false),
      SettingsHeader("Readability"),
      SettingsActionTile(
        icon: Feather.type,
        title: "Text Size",
        subtitle: "Adjustable font scaling",
      ),
      SettingsSwitchTile(
        icon: Feather.eye,
        title: "Alt Text",
        subtitle: "Manage automatic alt-text generation",
        value: true,
      ),
    ],
  );

  Widget _buildAppearanceTile(
    BuildContext context,
    String title,
    bool selected,
  ) {
    return Container(
      margin: EdgeInsets.only(bottom: 8),
      decoration: BoxDecoration(
        color: AppColors.surface.withOpacity(0.7),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.elevation.withOpacity(0.5)),
      ),
      child: ListTile(
        title: Text(
          title,
          style: TextStyle(
            color: AppColors.textHigh,
            fontWeight: FontWeight.w600,
            fontSize: 15,
          ),
        ),
        trailing: Container(
          padding: EdgeInsets.all(4),
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            border: Border.all(
              color: selected
                  ? AppColors.primaryLavender
                  : AppColors.textDisabled,
              width: 2,
            ),
          ),
          child: CircleAvatar(
            radius: 6,
            backgroundColor: selected
                ? AppColors.primaryLavender
                : Colors.transparent,
          ),
        ),
        onTap: () {},
      ),
    );
  }
}

class SupportAboutScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) => SettingsPageBase(
    title: "Support & About",
    children: [
      SettingsActionTile(
        icon: Feather.help_circle,
        title: "Help Center / FAQ",
        subtitle: "External support pages",
      ),
      SettingsActionTile(
        icon: Feather.flag,
        title: "Report a Problem",
        subtitle: "Bug reports and feedback",
      ),
      SettingsActionTile(
        icon: Feather.file_text,
        title: "Terms of Service",
        subtitle: "Legal agreement",
      ),
      SettingsActionTile(
        icon: Feather.shield,
        title: "Privacy Policy",
        subtitle: "Data handling policy",
      ),
      SettingsActionTile(
        icon: Feather.code,
        title: "Open Source Libraries",
        subtitle: "Attribution for code libraries used",
      ),
      Padding(
        padding: const EdgeInsets.symmetric(vertical: 24.0),
        child: Center(
          child: Column(
            children: [
              Text(
                "App Version",
                style: TextStyle(color: AppColors.textDisabled, fontSize: 12),
              ),
              Text(
                "1.0.4",
                style: TextStyle(
                  color: AppColors.textMedium,
                  fontWeight: FontWeight.bold,
                  fontSize: 16,
                ),
              ),
            ],
          ),
        ),
      ),
    ],
  );
}


--- C:\Code\femn\lib\hub_screens\settings_subpages.dart ---

import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:femn/customization/colors.dart';
import 'package:femn/widgets/femn_background.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:intl/intl.dart';
import 'package:image_picker/image_picker.dart';
import 'package:femn/auth/auth.dart'; // To access AuthScreen
import 'dart:io';
import 'dart:convert';
import 'package:share_plus/share_plus.dart';

// --- SHARED UI COMPONENTS ---

class SettingsPageBase extends StatelessWidget {
  final String title;
  final List<Widget> children;

  const SettingsPageBase({required this.title, required this.children});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      extendBodyBehindAppBar: true,
      appBar: AppBar(
        title: Text(title, style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold, fontSize: 18)),
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(
          icon: Icon(Feather.arrow_left, color: AppColors.primaryLavender),
          onPressed: () => Navigator.pop(context),
        ),
      ),
      body: FemnBackground(
        child: ListView(
          padding: const EdgeInsets.only(top: kToolbarHeight + 20, left: 16, right: 16, bottom: 40),
          children: children,
        ),
      ),
    );
  }
}

class SettingsActionTile extends StatelessWidget {
  final IconData icon;
  final String title;
  final String subtitle;
  final VoidCallback? onTap;

  const SettingsActionTile({required this.icon, required this.title, required this.subtitle, this.onTap});

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: EdgeInsets.only(bottom: 8),
      decoration: BoxDecoration(
        color: AppColors.surface.withOpacity(0.7),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.elevation.withOpacity(0.5)),
      ),
      child: ListTile(
        leading: Container(
          padding: EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: AppColors.primaryLavender.withOpacity(0.1),
            borderRadius: BorderRadius.circular(10),
          ),
          child: Icon(icon, color: AppColors.primaryLavender, size: 20),
        ),
        title: Text(title, style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.w600, fontSize: 15)),
        subtitle: Text(subtitle, style: TextStyle(color: AppColors.textDisabled, fontSize: 12)),
        trailing: Icon(Feather.chevron_right, color: AppColors.textDisabled, size: 16),
        onTap: onTap ?? () {},
      ),
    );
  }
}

class SettingsSwitchTile extends StatefulWidget {
  final IconData icon;
  final String title;
  final String subtitle;
  final bool value;

  const SettingsSwitchTile({required this.icon, required this.title, required this.subtitle, required this.value});

  @override
  _SettingsSwitchTileState createState() => _SettingsSwitchTileState();
}

class _SettingsSwitchTileState extends State<SettingsSwitchTile> {
  late bool _currentValue;

  @override
  void initState() {
    super.initState();
    _currentValue = widget.value;
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: EdgeInsets.only(bottom: 8),
      decoration: BoxDecoration(
        color: AppColors.surface.withOpacity(0.7),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.elevation.withOpacity(0.5)),
      ),
      child: SwitchListTile(
        secondary: Container(
          padding: EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: AppColors.primaryLavender.withOpacity(0.1),
            borderRadius: BorderRadius.circular(10),
          ),
          child: Icon(widget.icon, color: AppColors.primaryLavender, size: 20),
        ),
        title: Text(widget.title, style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.w600, fontSize: 15)),
        subtitle: Text(widget.subtitle, style: TextStyle(color: AppColors.textDisabled, fontSize: 12)),
        value: _currentValue,
        activeColor: AppColors.primaryLavender,
        onChanged: (val) => setState(() => _currentValue = val),
      ),
    );
  }
}

class SettingsInfoTile extends StatelessWidget {
  final IconData icon;
  final String title;
  final String subtitle;

  const SettingsInfoTile({required this.icon, required this.title, required this.subtitle});

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: EdgeInsets.only(bottom: 8),
      decoration: BoxDecoration(
        color: AppColors.surface.withOpacity(0.7),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.elevation.withOpacity(0.5)),
      ),
      child: ListTile(
        leading: Container(
          padding: EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: AppColors.primaryLavender.withOpacity(0.1),
            borderRadius: BorderRadius.circular(10),
          ),
          child: Icon(icon, color: AppColors.primaryLavender, size: 20),
        ),
        title: Text(
          title, 
          style: TextStyle(color: AppColors.textMedium, fontWeight: FontWeight.w500, fontSize: 12)
        ),
        subtitle: Text(
          subtitle, 
          style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.w600, fontSize: 15)
        ),
      ),
    );
  }
}

class SettingsHeader extends StatelessWidget {
  final String title;
  const SettingsHeader(this.title);

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      child: Text(
        title.toUpperCase(),
        style: TextStyle(
          color: AppColors.primaryLavender,
          fontWeight: FontWeight.bold,
          fontSize: 11,
          letterSpacing: 1.2,
        ),
      ),
    );
  }
}

// --- SPECIFIC SCREENS ---

class EditProfileScreen extends StatefulWidget {
  @override
  _EditProfileScreenState createState() => _EditProfileScreenState();
}

class _EditProfileScreenState extends State<EditProfileScreen> {
  final _auth = FirebaseAuth.instance;
  final _firestore = FirebaseFirestore.instance;
  final _storage = FirebaseStorage.instance;
  
  late TextEditingController _usernameController;
  late TextEditingController _fullNameController;
  late TextEditingController _bioController;
  bool _isLoading = true;
  String? _profileImageUrl;
  String? _accountType;
  File? _imageFile;

  @override
  void initState() {
    super.initState();
    _loadUserData();
  }

  Future<void> _loadUserData() async {
    final user = _auth.currentUser;
    if (user != null) {
      final doc = await _firestore.collection('users').doc(user.uid).get();
      if (doc.exists) {
        final data = doc.data()!;
        setState(() {
          _usernameController = TextEditingController(text: data['username'] ?? '');
          _fullNameController = TextEditingController(text: data['fullName'] ?? '');
          _bioController = TextEditingController(text: data['bio'] ?? '');
          _profileImageUrl = data['profileImage'];
          _accountType = data['accountType'];
          _isLoading = false;
        });
      }
    }
  }

  Future<void> _pickImage() async {
    final picker = ImagePicker();
    final pickedFile = await picker.pickImage(source: ImageSource.gallery, imageQuality: 70);
    if (pickedFile != null) {
      setState(() {
        _imageFile = File(pickedFile.path);
      });
    }
  }

  Future<String?> _uploadImage(String uid) async {
    if (_imageFile == null) return _profileImageUrl;
    try {
      final ref = _storage.ref().child('profile_images').child('$uid.jpg');
      await ref.putFile(_imageFile!);
      return await ref.getDownloadURL();
    } catch (e) {
      print("Error uploading image: $e");
      return _profileImageUrl;
    }
  }

  Future<void> _saveChanges() async {
    setState(() => _isLoading = true);
    try {
      final uid = _auth.currentUser!.uid;
      final newImageUrl = await _uploadImage(uid);
      
      Map<String, dynamic> updateData = {
        'username': _usernameController.text.trim().toLowerCase(),
        'fullName': _fullNameController.text.trim(),
        'profileImage': newImageUrl,
      };

      // Only sync bio if the account type typically has one
      if (_accountType == 'personal' || _accountType == 'organization') {
        updateData['bio'] = _bioController.text.trim();
      }

      await _firestore.collection('users').doc(uid).update(updateData);
      Navigator.pop(context);
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error saving changes: $e")));
      setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    if (_isLoading) return SettingsPageBase(title: "Edit Profile", children: [Center(child: CircularProgressIndicator(color: AppColors.primaryLavender))]);

    return SettingsPageBase(
      title: "Edit Profile",
      children: [
        Center(
          child: GestureDetector(
            onTap: _pickImage,
            child: Stack(
              children: [
                CircleAvatar(
                  radius: 55,
                  backgroundColor: AppColors.primaryLavender.withOpacity(0.2),
                  child: CircleAvatar(
                    radius: 50,
                    backgroundColor: AppColors.surface,
                    backgroundImage: _imageFile != null 
                        ? FileImage(_imageFile!) as ImageProvider
                        : (_profileImageUrl != null && _profileImageUrl!.isNotEmpty) 
                            ? NetworkImage(_profileImageUrl!) 
                            : null,
                    child: (_imageFile == null && (_profileImageUrl == null || _profileImageUrl!.isEmpty)) 
                        ? Icon(Feather.user, size: 40, color: AppColors.textDisabled) 
                        : null,
                  ),
                ),
                Positioned(
                  bottom: 0,
                  right: 0,
                  child: Container(
                    padding: EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: AppColors.primaryLavender, 
                      shape: BoxShape.circle,
                      border: Border.all(color: AppColors.backgroundDeep, width: 2),
                    ),
                    child: Icon(Feather.camera, color: Colors.white, size: 16),
                  ),
                ),
              ],
            ),
          ),
        ),
        SizedBox(height: 30),
        _buildTextField("Username", _usernameController, prefix: "@"),
        _buildTextField(_accountType == 'organization' ? "Organization Name" : "Full Name", _fullNameController),
        
        if (_accountType == 'personal' || _accountType == 'organization')
          _buildTextField("Bio", _bioController, maxLines: 3),
          
        SizedBox(height: 20),
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: ElevatedButton(
            onPressed: _saveChanges,
            style: ElevatedButton.styleFrom(
              backgroundColor: AppColors.primaryLavender,
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
              padding: EdgeInsets.symmetric(vertical: 16),
              elevation: 4,
            ),
            child: Text("Save Changes", style: TextStyle(color: AppColors.backgroundDeep, fontWeight: FontWeight.bold, fontSize: 16)),
          ),
        ),
      ],
    );
  }

  Widget _buildTextField(String label, TextEditingController controller, {int maxLines = 1, String? prefix}) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Padding(
            padding: const EdgeInsets.only(left: 4, bottom: 8),
            child: Text(label, style: TextStyle(color: AppColors.textMedium, fontSize: 13, fontWeight: FontWeight.w500)),
          ),
          TextFormField(
            controller: controller,
            maxLines: maxLines,
            style: TextStyle(color: AppColors.textHigh, fontSize: 15),
            decoration: InputDecoration(
              prefixText: prefix,
              prefixStyle: TextStyle(color: AppColors.primaryLavender, fontWeight: FontWeight.bold),
              filled: true,
              fillColor: AppColors.surface.withOpacity(0.5),
              border: OutlineInputBorder(borderRadius: BorderRadius.circular(16), borderSide: BorderSide.none),
              enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(16), borderSide: BorderSide(color: AppColors.elevation.withOpacity(0.5))),
              focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(16), borderSide: BorderSide(color: AppColors.primaryLavender)),
              contentPadding: EdgeInsets.all(18),
            ),
          ),
        ],
      ),
    );
  }
}

class PersonalInfoScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return FutureBuilder<DocumentSnapshot>(
      future: FirebaseFirestore.instance.collection('users').doc(FirebaseAuth.instance.currentUser!.uid).get(),
      builder: (context, snapshot) {
        if (!snapshot.hasData) {
          return SettingsPageBase(title: "Personal Information", children: [Center(child: CircularProgressIndicator(color: AppColors.primaryLavender))]);
        }

        final data = snapshot.data!.data() as Map<String, dynamic>;
        final accountType = data['accountType'] ?? 'personal';

        // Prepare info tiles based on account type
        List<Widget> infoTiles = [
          SettingsInfoTile(icon: Feather.user, title: "Full Name", subtitle: data['fullName'] ?? 'N/A'),
          SettingsInfoTile(icon: Feather.at_sign, title: "Username", subtitle: data['username'] ?? 'N/A'),
          SettingsInfoTile(icon: Feather.mail, title: "Email Address", subtitle: data['email'] ?? 'N/A'),
        ];

        if (accountType == 'personal' || accountType == 'therapist') {
          if (data['dateOfBirth'] != null) {
            final dob = (data['dateOfBirth'] as Timestamp).toDate();
            infoTiles.add(SettingsInfoTile(icon: Feather.calendar, title: "Birthday", subtitle: DateFormat('MMMM d, yyyy').format(dob)));
          }
        }

        if (accountType == 'organization') {
          infoTiles.addAll([
            SettingsInfoTile(icon: Feather.briefcase, title: "Category", subtitle: data['category'] ?? 'N/A'),
            SettingsInfoTile(icon: Feather.globe, title: "Country", subtitle: data['country'] ?? 'N/A'),
            SettingsInfoTile(icon: Feather.phone, title: "Phone", subtitle: data['phone'] ?? 'N/A'),
            SettingsInfoTile(icon: Feather.map_pin, title: "Address", subtitle: data['address'] ?? 'N/A'),
            SettingsInfoTile(icon: Feather.link, title: "Website", subtitle: data['website'] ?? 'N/A'),
            SettingsInfoTile(icon: Feather.file_text, title: "Mission Statement", subtitle: data['missionStatement'] ?? 'N/A'),
          ]);
        }

        if (accountType == 'therapist') {
          infoTiles.addAll([
            SettingsInfoTile(icon: Feather.activity, title: "Experience Level", subtitle: data['experienceLevel'] ?? 'N/A'),
            SettingsInfoTile(icon: Feather.map, title: "Region", subtitle: data['region'] ?? 'N/A'),
            SettingsInfoTile(icon: Feather.users, title: "Ethnicity", subtitle: data['ethnicity'] ?? 'N/A'),
            SettingsInfoTile(icon: Feather.user, title: "Gender", subtitle: data['gender'] ?? 'N/A'),
            SettingsInfoTile(icon: Feather.shield, title: "Religion", subtitle: data['religion'] ?? 'N/A'),
            SettingsInfoTile(icon: Feather.globe, title: "Languages", subtitle: (data['languages'] as List?)?.join(', ') ?? 'N/A'),
            SettingsInfoTile(icon: Feather.award, title: "Specialization", subtitle: (data['specialization'] as List?)?.join(', ') ?? 'N/A'),
          ]);
        }

        // Common metadata
        infoTiles.add(SettingsHeader("Account Metadata"));
        infoTiles.add(SettingsInfoTile(icon: Feather.info, title: "Account Type", subtitle: accountType.toString().toUpperCase()));
        if (data['createdAt'] != null) {
          final created = (data['createdAt'] as Timestamp).toDate();
          infoTiles.add(SettingsInfoTile(icon: Feather.clock, title: "Joined Femn", subtitle: DateFormat('MMMM d, yyyy').format(created)));
        }

        return SettingsPageBase(
          title: "Personal Information",
          children: [
            ...infoTiles,
            Padding(
              padding: const EdgeInsets.all(16.0),
              child: Text(
                "This private data is only visible to you. Femn uses it to customize your experience and ensure safety.",
                style: TextStyle(color: AppColors.textDisabled, fontSize: 11),
                textAlign: TextAlign.center,
              ),
            ),
          ],
        );
      },
    );
  }
}

class DeletionScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return SettingsPageBase(
      title: "Account Deletion",
      children: [
        _buildAlertCard(
          context,
          "Deactivate Account",
          "Temporarily hide your profile and content. You can reactivate anytime by logging back in. Your account will be invisible to others.",
          AppColors.primaryLavender,
          isDeactivate: true,
        ),
        SizedBox(height: 20),
        _buildAlertCard(
          context,
          "Delete Account",
          "Permanently delete your data. This action is irreversible. All your posts, messages, and profile information will be erased.",
          AppColors.error,
          isDeactivate: false,
        ),
      ],
    );
  }

  Widget _buildAlertCard(BuildContext context, String title, String description, Color color, {required bool isDeactivate}) {
    return Container(
      margin: EdgeInsets.all(16),
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: color.withOpacity(0.3)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: [
          Text(title, style: TextStyle(color: color, fontWeight: FontWeight.bold, fontSize: 18)),
          SizedBox(height: 8),
          Text(description, style: TextStyle(color: AppColors.textMedium, fontSize: 14)),
          SizedBox(height: 16),
          ElevatedButton(
            onPressed: () => _showConfirmationDialog(context, isDeactivate),
            style: ElevatedButton.styleFrom(
              backgroundColor: color,
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
            ),
            child: Text(title, style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
          ),
        ],
      ),
    );
  }

  void _showConfirmationDialog(BuildContext context, bool isDeactivate) {
    if (isDeactivate) {
      showDialog(
        context: context,
        builder: (context) => AlertDialog(
          backgroundColor: AppColors.surface,
          title: Text("Deactivate Account?", style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)),
          content: Text(
            "You are about to deactivate your account. It will be hidden from everyone. You can reactivate it by simply logging in again.",
            style: TextStyle(color: AppColors.textMedium),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: Text("Cancel", style: TextStyle(color: AppColors.textDisabled)),
            ),
            TextButton(
              onPressed: () {
                Navigator.pop(context);
                _performAction(context, true);
              },
              child: Text("Deactivate", style: TextStyle(color: AppColors.primaryLavender, fontWeight: FontWeight.bold)),
            ),
          ],
        ),
      );
    } else {
      // STRICT DELETE DIALOG
      showDialog(
        context: context,
        builder: (context) => _StrictDeleteDialog(onConfirm: () => _performAction(context, false)),
      );
    }
  }

  Future<void> _performAction(BuildContext context, bool isDeactivate) async {
    final auth = FirebaseAuth.instance;
    final firestore = FirebaseFirestore.instance;
    final user = auth.currentUser;
    if (user == null) return;

    try {
      if (isDeactivate) {
        await firestore.collection('users').doc(user.uid).update({'isActive': false});
        await auth.signOut();
        Navigator.pushAndRemoveUntil(
          context,
          MaterialPageRoute(builder: (context) => AuthScreen()),
          (route) => false,
        );
      } else {
        await firestore.collection('users').doc(user.uid).delete();
        await user.delete(); 
        Navigator.pushAndRemoveUntil(
          context,
          MaterialPageRoute(builder: (context) => AuthScreen()),
          (route) => false,
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e"), backgroundColor: AppColors.error));
    }
  }
}

class _StrictDeleteDialog extends StatefulWidget {
  final VoidCallback onConfirm;
  const _StrictDeleteDialog({required this.onConfirm});

  @override
  __StrictDeleteDialogState createState() => __StrictDeleteDialogState();
}

class __StrictDeleteDialogState extends State<_StrictDeleteDialog> {
  final _usernameController = TextEditingController();
  final _passwordController = TextEditingController();
  bool _isVerified = false;
  bool _isLoading = false;
  String? _error;

  Future<void> _verifyAndConfirm() async {
    setState(() { _isLoading = true; _error = null; });

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) throw Exception("User not signed in");

      // 1. Verify Username matches Firestore
      final doc = await FirebaseFirestore.instance.collection('users').doc(user.uid).get();
      if (!doc.exists) throw Exception("User record not found");
      
      final realUsername = doc.data()?['username'] as String?;
      if (realUsername != _usernameController.text.trim().toLowerCase()) {
         throw Exception("Username does not match.");
      }

      // 2. Verify Password (Re-authenticate)
      // Note: This requires EmailAuthProvider. Only works for Email/Password accounts.
      // If using Google/Apple sign in, you'd need reauthenticateWithProvider.
      // Assuming Email/Password for now based on 'password' requirement.
      if (user.email == null) throw Exception("Email not found");
      
      AuthCredential credential = EmailAuthProvider.credential(
        email: user.email!, 
        password: _passwordController.text.trim()
      );
      
      await user.reauthenticateWithCredential(credential);

      // If we reach here, verification succeeded
      Navigator.pop(context); // Close dialog
      widget.onConfirm(); // Perform delete

    } catch (e) {
      setState(() {
        if (e is FirebaseAuthException) {
           _error = "Incorrect password.";
        } else {
           _error = e.toString().replaceAll("Exception: ", "");
        }
        _isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      backgroundColor: AppColors.surface,
      title: Text("Delete Account?", style: TextStyle(color: AppColors.error, fontWeight: FontWeight.bold)),
      content: SingleChildScrollView(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              "This action is PERMANENT. All your data will be erased immediately. To confirm, please verify your identity.",
              style: TextStyle(color: AppColors.textMedium, fontSize: 13),
            ),
            SizedBox(height: 20),
            
            // Username Field
            Text("Enter your username:", style: TextStyle(color: AppColors.textHigh, fontSize: 12, fontWeight: FontWeight.bold)),
            SizedBox(height: 5),
            TextField(
              controller: _usernameController,
              decoration: InputDecoration(
                filled: true,
                fillColor: AppColors.elevation,
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
                contentPadding: EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              ),
              style: TextStyle(color: AppColors.textHigh),
            ),
            
            SizedBox(height: 15),
            
            // Password Field
            Text("Enter your password:", style: TextStyle(color: AppColors.textHigh, fontSize: 12, fontWeight: FontWeight.bold)),
            SizedBox(height: 5),
            TextField(
              controller: _passwordController,
              obscureText: true,
              decoration: InputDecoration(
                filled: true,
                fillColor: AppColors.elevation,
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
                contentPadding: EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              ),
              style: TextStyle(color: AppColors.textHigh),
            ),

            if (_error != null) ...[
              SizedBox(height: 10),
              Text(_error!, style: TextStyle(color: AppColors.error, fontSize: 12, fontWeight: FontWeight.bold)),
            ],
          ],
        ),
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: Text("Cancel", style: TextStyle(color: AppColors.textDisabled)),
        ),
        ElevatedButton(
          onPressed: _isLoading ? null : _verifyAndConfirm,
          style: ElevatedButton.styleFrom(
            backgroundColor: AppColors.error,
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
          ),
          child: _isLoading 
            ? SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white))
            : Text("DELETE ACCOUNT", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
        ),
      ],
    );
  }
}

class MessagingPrivacyScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return SettingsPageBase(
      title: "Messaging Privacy",
      children: [
        _RadioTile("Everyone", true),
        _RadioTile("Followers only", false),
        _RadioTile("No one", false),
      ],
    );
  }

  Widget _RadioTile(String title, bool selected) {
    return Container(
      margin: EdgeInsets.only(bottom: 8),
      decoration: BoxDecoration(
        color: AppColors.surface.withOpacity(0.7),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.elevation.withOpacity(0.5)),
      ),
      child: ListTile(
        title: Text(title, style: TextStyle(color: AppColors.textHigh)),
        trailing: Container(
          padding: EdgeInsets.all(4),
          decoration: BoxDecoration(shape: BoxShape.circle, border: Border.all(color: selected ? AppColors.primaryLavender : AppColors.textDisabled, width: 2)),
          child: CircleAvatar(radius: 6, backgroundColor: selected ? AppColors.primaryLavender : Colors.transparent),
        ),
        onTap: () {},
      ),
    );
  }
}

class LoginActivityScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return SettingsPageBase(
      title: "Login Activity",
      children: [
        _SessionTile("iPhone 14 Pro", "New York, USA", "Active Now", true),
        _SessionTile("Chrome on Windows", "London, UK", "2 hours ago", false),
        _SessionTile("iPad Air", "Paris, France", "Yesterday", false),
        SizedBox(height: 20),
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: TextButton(
            onPressed: () {},
            child: Text("Log out of all other sessions", style: TextStyle(color: AppColors.error, fontWeight: FontWeight.bold)),
          ),
        ),
      ],
    );
  }

  Widget _SessionTile(String device, String location, String time, bool current) {
    return Container(
      margin: EdgeInsets.only(bottom: 8),
      decoration: BoxDecoration(
        color: AppColors.surface.withOpacity(0.7),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.elevation.withOpacity(0.5)),
      ),
      child: ListTile(
        leading: Icon(current ? Feather.monitor : Feather.smartphone, color: current ? AppColors.success : AppColors.textDisabled),
        title: Text(device, style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)),
        subtitle: Text("$location  $time", style: TextStyle(color: AppColors.textDisabled, fontSize: 12)),
        trailing: current ? null : Text("Logout", style: TextStyle(color: AppColors.error, fontSize: 12)),
      ),
    );
  }
}

class MediaQualityScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return SettingsPageBase(
      title: "Media Quality",
      children: [
        SettingsHeader("Cellular Data"),
        SettingsSwitchTile(icon: Feather.zap, title: "Data Saver", subtitle: "Lower quality images and videos", value: false),
        SettingsHeader("Wi-Fi"),
        SettingsSwitchTile(icon: Feather.upload, title: "Upload in HD", subtitle: "Always upload high-res media", value: true),
      ],
    );
  }
}

class LanguageScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return SettingsPageBase(
      title: "Language",
      children: [
        _LanguageTile("English (System Default)", true),
        _LanguageTile("French", false),
        _LanguageTile("Spanish", false),
        _LanguageTile("German", false),
        _LanguageTile("Arabic", false),
      ],
    );
  }

  Widget _LanguageTile(String title, bool selected) {
    return Container(
      margin: EdgeInsets.only(bottom: 8),
      decoration: BoxDecoration(
        color: AppColors.surface.withOpacity(0.7),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.elevation.withOpacity(0.5)),
      ),
      child: ListTile(
        title: Text(title, style: TextStyle(color: AppColors.textHigh)),
        trailing: selected ? Icon(Feather.check, color: AppColors.primaryLavender) : null,
        onTap: () {},
      ),
    );
  }
}

class AccountManagementScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) => SettingsPageBase(
    title: "Account Management",
    children: [
      SettingsActionTile(icon: Feather.user, title: "Edit Profile", subtitle: "Username, bio, profile picture", onTap: () => Navigator.push(context, MaterialPageRoute(builder: (context) => EditProfileScreen()))),
      SettingsActionTile(icon: Feather.info, title: "Personal Information", subtitle: "Email, phone, birthday", onTap: () => Navigator.push(context, MaterialPageRoute(builder: (context) => PersonalInfoScreen()))),
      SettingsActionTile(icon: Feather.user_x, title: "Account Deletion & Deactivation", subtitle: "Temporarily hide or permanently delete", onTap: () => Navigator.push(context, MaterialPageRoute(builder: (context) => DeletionScreen()))),
      SettingsActionTile(
        icon: Feather.download, 
        title: "Request Account Data", 
        subtitle: "Download a copy of your information",
        onTap: () => _requestAccountData(context),
      ),
    ],
  );

  Future<void> _requestAccountData(BuildContext context) async {
    // 1. First, require Password Re-authentication
    final passwordController = TextEditingController();
    bool? authorized = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: AppColors.surface,
        title: Text("Verify Identity", style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text("Please enter your password to request your data dump.", style: TextStyle(color: AppColors.textMedium)),
            SizedBox(height: 10),
            TextField(
              controller: passwordController,
              obscureText: true,
              decoration: InputDecoration(
                hintText: "Password",
                filled: true,
                fillColor: AppColors.elevation,
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
              ),
              style: TextStyle(color: AppColors.textHigh),
            ),
          ],
        ),
        actions: [
          TextButton(onPressed: () => Navigator.pop(context, false), child: Text("Cancel", style: TextStyle(color: AppColors.textDisabled))),
          TextButton(
            onPressed: () async {
              try {
                final user = FirebaseAuth.instance.currentUser;
                if (user != null && user.email != null) {
                  AuthCredential credential = EmailAuthProvider.credential(email: user.email!, password: passwordController.text.trim());
                  await user.reauthenticateWithCredential(credential);
                  Navigator.pop(context, true);
                }
              } catch (e) {
                ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Incorrect password"), backgroundColor: AppColors.error));
              }
            },
            child: Text("Verify", style: TextStyle(color: AppColors.primaryLavender, fontWeight: FontWeight.bold)),
          ),
        ],
      ),
    );

    if (authorized == true) {
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (BuildContext context) {
          return _DataRequestProgressDialog();
        },
      );
    }
  }
}

class _DataRequestProgressDialog extends StatefulWidget {
  @override
  __DataRequestProgressDialogState createState() => __DataRequestProgressDialogState();
}

class __DataRequestProgressDialogState extends State<_DataRequestProgressDialog> {
  String _status = "Initializing...";
  double _progress = 0.1;

  @override
  void initState() {
    super.initState();
    _startProcess();
  }

  Future<void> _startProcess() async {
    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) throw Exception("User not logged in");
      final uid = user.uid;

      // Helper to process data for JSON (handle Timestamps)
      dynamic _processData(dynamic data) {
        if (data is Timestamp) return data.toDate().toIso8601String();
        if (data is List) return data.map(_processData).toList();
        if (data is Map) {
          return data.map((key, value) => MapEntry(key, _processData(value)));
        }
        return data;
      }

      // Step 1: Connecting
      await Future.delayed(Duration(milliseconds: 500));
      if (!mounted) return;
      setState(() { _status = "Fetching Profile..."; _progress = 0.1; });

      final Map<String, dynamic> fullExport = {};

      // 1. Profile
      final userDoc = await FirebaseFirestore.instance.collection('users').doc(uid).get();
      Map<String, dynamic> userData = {};
      
      if (userDoc.exists) {
        userData = _processData(userDoc.data()) as Map<String, dynamic>;
        
        // Remove embeddings if present
        if (userData.containsKey('embedding')) userData.remove('embedding');
        if (userData.containsKey('embeddings')) userData.remove('embeddings');
        
        fullExport['profile'] = userData;

        // ACCOUNT TYPE SPECIFIC DATA
        String accountType = userData['accountType'] ?? 'personal';
        if (accountType == 'therapist') {
           if (!mounted) return;
           setState(() { _status = "Fetching Therapist Data..."; _progress = 0.15; });
           
           // Fetch Certifications (URLs already in profile usually, but fetch separate collection if any)
           // Fetch Availability slots if stored separately? (Usually in profile)
           // Fetch Reviews/Ratings if stored in subcollections
           final reviewsSnap = await FirebaseFirestore.instance.collection('users').doc(uid).collection('reviews').get();
           if (reviewsSnap.docs.isNotEmpty) {
             fullExport['therapist_reviews'] = reviewsSnap.docs.map((d) => _processData(d.data())).toList();
           }
        }
      } else {
         fullExport['profile'] = {"error": "User document not found"};
      }

      // 2. Posts
      if (!mounted) return;
      setState(() { _status = "Fetching Posts..."; _progress = 0.3; });
      final postsSnap = await FirebaseFirestore.instance.collection('posts').where('userId', isEqualTo: uid).get();
      var processedPosts = postsSnap.docs.map((d) {
         var pData = _processData(d.data()) as Map<String, dynamic>;
         // Remove any embeddings in posts
         pData.remove('embedding');
         pData.remove('vector');
         return pData;
      }).toList();
      fullExport['posts'] = processedPosts;

      // 3. Journal
      if (!mounted) return;
      setState(() { _status = "Fetching Journal..."; _progress = 0.5; });
      final journalSnap = await FirebaseFirestore.instance.collection('users').doc(uid).collection('journal').get();
      fullExport['journal'] = journalSnap.docs.map((d) => _processData(d.data())).toList();

      // 4. Stories
      if (!mounted) return;
      setState(() { _status = "Fetching Stories..."; _progress = 0.7; });
      final storiesSnap = await FirebaseFirestore.instance.collection('stories').where('userId', isEqualTo: uid).get();
      fullExport['stories'] = storiesSnap.docs.map((d) => _processData(d.data())).toList();

      // 5. Chats
      if (!mounted) return;
      setState(() { _status = "Fetching Chats..."; _progress = 0.9; });
      final chatsSnap = await FirebaseFirestore.instance.collection('chats').where('participants', arrayContains: uid).get();
      fullExport['chats'] = chatsSnap.docs.map((d) => _processData(d.data())).toList();

      // 6. Notifications - EXCLUDED per user request
      
      // Finalizing
      if (!mounted) return;
      setState(() { _status = "Encrypting export file..."; _progress = 0.98; });
      
      final jsonString = JsonEncoder.withIndent('  ').convert(fullExport);

      await Future.delayed(Duration(milliseconds: 500));
      setState(() { _status = "Ready to share!"; _progress = 1.0; });
      await Future.delayed(Duration(milliseconds: 500));

      Navigator.pop(context); // Close dialog
      await Share.share(jsonString, subject: 'My Femn Account Data');

    } catch (e) {
      Navigator.pop(context);
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(
        content: Text("Error: $e"),
        backgroundColor: AppColors.error,
      ));
    }
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      backgroundColor: AppColors.surface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          SizedBox(height: 10),
          CircularProgressIndicator(
            value: _progress,
            color: AppColors.primaryLavender,
            backgroundColor: AppColors.elevation,
          ),
          SizedBox(height: 20),
          Text(
            "Account Data Request",
            style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold, fontSize: 16),
          ),
          SizedBox(height: 10),
          Text(
            _status,
            style: TextStyle(color: AppColors.textMedium, fontSize: 13),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }
}


--- C:\Code\femn\lib\hub_screens\story.dart ---

import 'dart:async';
import 'dart:io';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:flutter/material.dart';
import 'package:image_picker/image_picker.dart';
import 'package:timeago/timeago.dart' as timeago;
import 'package:uuid/uuid.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:femn/services/embers_service.dart';
import 'package:femn/customization/colors.dart'; // <--- IMPORT COLORS

// --- STORY CREATION MODAL ---
class StoryCreationModal extends StatefulWidget {
  @override
  _StoryCreationModalState createState() => _StoryCreationModalState();
}

class _StoryCreationModalState extends State<StoryCreationModal> {
  File? _mediaFile;
  String? _mediaType;
  final TextEditingController _captionController = TextEditingController();
  bool _isUploading = false;

  Future<void> _pickMedia(ImageSource source) async {
    final picker = ImagePicker();
    final pickedFile = await picker.pickImage(source: source);
    
    if (pickedFile != null) {
      setState(() {
        _mediaFile = File(pickedFile.path);
        _mediaType = 'image';
      });
    }
  }

  Future<void> _uploadStory() async {
    if (_mediaFile == null) return;
    
    setState(() { _isUploading = true; });
    
    try {
      final currentUserId = FirebaseAuth.instance.currentUser!.uid;
      final userDoc = await FirebaseFirestore.instance.collection('users').doc(currentUserId).get();
      
      // Check if user has enough embers first
      final hasEnoughEmbers = await EmbersService.hasSufficientEmbers(1);
      if (!hasEnoughEmbers) {
        // The EmbersService will automatically show a snackbar via the button check
        setState(() { _isUploading = false; });
        return;
      }
      
      // Upload media
      String storyId = Uuid().v4();
      Reference storageRef = FirebaseStorage.instance
          .ref()
          .child('stories')
          .child(currentUserId)
          .child('$storyId.jpg');
      
      await storageRef.putFile(_mediaFile!);
      String mediaUrl = await storageRef.getDownloadURL();

      // Create story document and get reference
      DocumentReference storyDocRef = await FirebaseFirestore.instance.collection('stories').add({
        'userId': currentUserId,
        'username': userDoc['username'],
        'profileImage': userDoc['profileImage'],
        'mediaUrl': mediaUrl,
        'caption': _captionController.text,
        'mediaType': _mediaType,
        'timestamp': DateTime.now(),
        'expiresAt': DateTime.now().add(Duration(hours: 24)),
        'viewers': [],
      });

      //  DEDUCT 1 EMBER FOR STORY CREATION
      final result = await EmbersService.processEmbersTransaction(
        context: context,
        amount: -1,
        actionType: 'story_creation',
        referenceId: storyDocRef.id,
        insufficientFundsMessage: 'Need 1 Ember to create a story',
      );

      if (!result.success) {
        // If embers deduction failed, delete the story and show error
        await storyDocRef.delete();
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Failed to create story: ${result.message}')),
        );
        return;
      }

      await Future.delayed(Duration(milliseconds: 500));
      Navigator.pop(context);
      
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Error uploading story: $e')),
      );
    } finally {
      setState(() { _isUploading = false; });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surface, // Dark surface
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text('Create Story', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
          SizedBox(height: 16),
          
          if (_mediaFile != null) _buildMediaPreview(),
          if (_mediaFile != null) SizedBox(height: 16),
          
          if (_mediaFile != null)
            TextField(
              controller: _captionController,
              style: TextStyle(color: AppColors.textHigh),
              decoration: InputDecoration(
                hintText: 'Add a caption...',
                hintStyle: TextStyle(color: AppColors.textDisabled),
                filled: true,
                fillColor: AppColors.elevation,
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide.none,
                ),
              ),
              maxLines: 2,
            ),
          
          if (_mediaFile != null) SizedBox(height: 16),
          
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceEvenly,
            children: [
              ElevatedButton.icon(
                onPressed: () => _pickMedia(ImageSource.camera),
                icon: Icon(Feather.camera),
                label: Text('Camera'),
                style: ElevatedButton.styleFrom(
                  backgroundColor: AppColors.elevation,
                  foregroundColor: AppColors.primaryLavender,
                ),
              ),
              ElevatedButton.icon(
                onPressed: () => _pickMedia(ImageSource.gallery),
                icon: Icon(Feather.image),
                label: Text('Gallery'),
                 style: ElevatedButton.styleFrom(
                  backgroundColor: AppColors.elevation,
                  foregroundColor: AppColors.primaryLavender,
                ),
              ),
            ],
          ),
          
          if (_mediaFile != null) SizedBox(height: 16),
          
          if (_mediaFile != null)
            _isUploading
                ? CircularProgressIndicator(color: AppColors.primaryLavender)
                : ElevatedButton(
                    onPressed: () async {
                      // Check embers balance before uploading
                      final hasEnoughEmbers = await EmbersService.hasSufficientEmbers(1);
                      if (!hasEnoughEmbers) {
                        // This will trigger the EmbersService to show the snackbar
                        await EmbersService.processEmbersTransaction(
                          context: context,
                          amount: -1,
                          actionType: 'story_creation_check',
                          showSnackBar: true,
                        );
                        return;
                      }
                      
                      // If they have enough embers, proceed with upload
                      await _uploadStory();
                    },
                    child: Text('Share Story'),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryLavender,
                      foregroundColor: AppColors.backgroundDeep,
                      minimumSize: Size(double.infinity, 50),
                    ),
                  ),
        ],
      ),
    );
  }

  Widget _buildMediaPreview() {
    return Container(
      height: 200,
      width: double.infinity,
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(12),
        color: Colors.black,
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(12),
        child: _mediaType == 'image'
            ? Image.file(_mediaFile!, fit: BoxFit.cover)
            : Center(child: Icon(Feather.play, size: 50, color: Colors.white)),
      ),
    );
  }
}


// --- STORIES TAB ---
class StoriesTab extends StatefulWidget {
  @override
  _StoriesTabState createState() => _StoriesTabState();
}

class _StoriesTabState extends State<StoriesTab> {
  File? _pickedStory;
  bool _isUploading = false;
  String? _mediaType; // 'image' or 'video'

  Future<void> _pickStory() async {
    final picker = ImagePicker();
    final pickedFile = await picker.pickImage(source: ImageSource.gallery);
    if (pickedFile != null) {
      setState(() {
        _pickedStory = File(pickedFile.path);
        _mediaType = 'image'; 
      });
    }
  }

  Future<void> _takeStory() async {
    final picker = ImagePicker();
    final pickedFile = await picker.pickImage(source: ImageSource.camera);
    if (pickedFile != null) {
      setState(() {
        _pickedStory = File(pickedFile.path);
        _mediaType = 'image'; 
      });
    }
  }

  Future<void> _uploadStory() async {
    if (_pickedStory == null || _mediaType == null) return;

    setState(() {
      _isUploading = true;
    });

    try {
      final currentUserId = FirebaseAuth.instance.currentUser!.uid;
      final userDoc = await FirebaseFirestore.instance.collection('users').doc(currentUserId).get();
      final username = userDoc['username'];
      final profileImage = userDoc['profileImage'];

      // Upload media to Firebase Storage
      String storyId = Uuid().v4();
      Reference storageRef = FirebaseStorage.instance
          .ref()
          .child('stories')
          .child(currentUserId)
          .child('$storyId.${_mediaType == 'image' ? 'jpg' : 'mp4'}');
      await storageRef.putFile(_pickedStory!);
      String mediaUrl = await storageRef.getDownloadURL();

      // Add story to Firestore with expiration (e.g., 24 hours)
      await FirebaseFirestore.instance.collection('stories').add({
        'userId': currentUserId,
        'username': username,
        'profileImage': profileImage,
        'mediaUrl': mediaUrl,
        'mediaType': _mediaType,
        'timestamp': DateTime.now(),
        'expiresAt': DateTime.now().add(Duration(hours: 24)), 
        'viewers': [], 
      });

      setState(() {
        _pickedStory = null;
        _isUploading = false;
      });

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Story uploaded!')),
      );
    } catch (e) {
      setState(() {
        _isUploading = false;
      });
      print('Error uploading story: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Error uploading story: $e')),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    final currentUserId = FirebaseAuth.instance.currentUser!.uid;
    return Column(
      children: [
        // Upload Story Section
        Padding(
          padding: const EdgeInsets.all(8.0),
          child: Card(
            elevation: 2,
            color: AppColors.surface, // Dark card
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Column(
                children: [
                  Text('Upload a Story', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
                  SizedBox(height: 10),
                  _isUploading
                      ? CircularProgressIndicator(color: AppColors.primaryLavender)
                      : _pickedStory != null
                          ? Column(
                              children: [
                                ClipRRect(
                                  borderRadius: BorderRadius.circular(8),
                                  child: _mediaType == 'image'
                                      ? Image.file(_pickedStory!, height: 200, fit: BoxFit.cover)
                                      : Container(
                                          height: 200,
                                          color: Colors.black,
                                          child: Center(
                                            child: Icon(Feather.play, color: Colors.white, size: 50),
                                          ),
                                        ),
                                ),
                                SizedBox(height: 10),
                                Row(
                                  mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                                  children: [
                                    ElevatedButton(
                                      onPressed: _uploadStory,
                                      child: Text('Upload'),
                                      style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryLavender, foregroundColor: AppColors.backgroundDeep),
                                    ),
                                    ElevatedButton(
                                      onPressed: () {
                                        setState(() {
                                          _pickedStory = null;
                                          _mediaType = null;
                                        });
                                      },
                                      child: Text('Cancel'),
                                      style: ElevatedButton.styleFrom(backgroundColor: AppColors.error, foregroundColor: AppColors.backgroundDeep),
                                    ),
                                  ],
                                ),
                              ],
                            )
                          : Row(
                              mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                              children: [
                                ElevatedButton.icon(
                                  onPressed: _pickStory,
                                  icon: Icon(Feather.image),
                                  label: Text('Gallery'),
                                  style: ElevatedButton.styleFrom(backgroundColor: AppColors.elevation, foregroundColor: AppColors.primaryLavender),
                                ),
                                ElevatedButton.icon(
                                  onPressed: _takeStory,
                                  icon: Icon(Feather.camera),
                                  label: Text('Camera'),
                                  style: ElevatedButton.styleFrom(backgroundColor: AppColors.elevation, foregroundColor: AppColors.primaryLavender),
                                ),
                              ],
                            ),
                ],
              ),
            ),
          ),
        ),
        // View Stories Section
        Expanded(
          child: StreamBuilder<QuerySnapshot>(
            stream: FirebaseFirestore.instance
                .collection('stories')
                .where('expiresAt', isGreaterThan: DateTime.now())
                .orderBy('timestamp', descending: true)
                .snapshots(),
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.waiting) {
                return Center(child: CircularProgressIndicator(color: AppColors.primaryLavender));
              }
              if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
                return Center(child: Text('No stories available', style: TextStyle(color: AppColors.textMedium)));
              }

              // Group stories by user
              Map<String, List<DocumentSnapshot>> groupedStories = {};
              for (var doc in snapshot.data!.docs) {
                final userId = doc['userId'];
                if (!groupedStories.containsKey(userId)) {
                  groupedStories[userId] = [];
                }
                groupedStories[userId]!.add(doc);
              }

              return GridView.builder(
                padding: EdgeInsets.all(8),
                gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                  crossAxisCount: 3,
                  crossAxisSpacing: 8,
                  mainAxisSpacing: 8,
                ),
                itemCount: groupedStories.length,
                itemBuilder: (context, index) {
                  final userId = groupedStories.keys.elementAt(index);
                  final userStories = groupedStories[userId]!;
                  final latestStory = userStories.first; 

                  bool isOwnStory = userId == currentUserId;
                  bool isSeen = userStories.every((story) => List.from(story['viewers']).contains(currentUserId));

                  return GestureDetector(
                    onTap: () {
                      Navigator.push(
                        context,
                        MaterialPageRoute(
                          builder: (context) => StoryViewerScreen(
                            userId: userId,
                            stories: userStories, 
                            username: latestStory['username'] ?? '', 
                            profileImage: latestStory['profileImage'] ?? '',
                          ),
                        ),
                      );
                    },
                    child: Stack(
                      children: [
                        // Story Thumbnail
                        Container(
                          decoration: BoxDecoration(
                            borderRadius: BorderRadius.circular(12),
                            border: Border.all(
                              // Lavender for Own, Teal for Unseen, Grey for Seen
                              color: isOwnStory
                                  ? AppColors.primaryLavender
                                  : (isSeen ? AppColors.textDisabled : AppColors.secondaryTeal),
                              width: 2.5,
                            ),
                          ),
                          child: ClipRRect(
                            borderRadius: BorderRadius.circular(10),
                            child: latestStory['mediaType'] == 'image'
                                ? CachedNetworkImage(
                                    imageUrl: latestStory['mediaUrl'],
                                    fit: BoxFit.cover,
                                    width: double.infinity,
                                    height: double.infinity,
                                    placeholder: (context, url) => Container(color: AppColors.elevation),
                                    errorWidget: (context, url, error) => Icon(Feather.alert_circle, color: AppColors.error),
                                  )
                                : Container(
                                    color: Colors.black,
                                    child: Center(
                                      child: Icon(Feather.play, color: Colors.white, size: 30),
                                    ),
                                  ),
                          ),
                        ),
                        // User Info Overlay
                        Positioned(
                          bottom: 0,
                          left: 0,
                          right: 0,
                          child: Container(
                            padding: EdgeInsets.symmetric(horizontal: 4, vertical: 4),
                            decoration: BoxDecoration(
                              color: Colors.black54,
                              borderRadius: BorderRadius.only(
                                bottomLeft: Radius.circular(10),
                                bottomRight: Radius.circular(10),
                              ),
                            ),
                            child: Text(
                              isOwnStory ? 'Your Story' : (latestStory['username'] ?? 'User'),
                              style: TextStyle(color: Colors.white, fontSize: 10),
                              overflow: TextOverflow.ellipsis,
                              textAlign: TextAlign.center,
                            ),
                          ),
                        ),
                      ],
                    ),
                  );
                },
              );
            },
          ),
        ),
      ],
    );
  }
}

// --- STORY VIEWER SCREEN ---
class StoryViewerScreen extends StatefulWidget {
  final String userId;
  final List<DocumentSnapshot> stories;
  final String username;
  final String profileImage;

  const StoryViewerScreen({
    Key? key,
    required this.userId,
    required this.stories,
    required this.username,
    required this.profileImage,
  }) : super(key: key);

  @override
  _StoryViewerScreenState createState() => _StoryViewerScreenState();
}

class _StoryViewerScreenState extends State<StoryViewerScreen> {
  late PageController _pageController;
  int _currentIndex = 0;
  late Timer _timer;
  final Duration _storyDuration = Duration(seconds: 5);
  late bool _isOwnStory; 

  @override
  void initState() {
    super.initState();
    _pageController = PageController();
    _isOwnStory = widget.userId == FirebaseAuth.instance.currentUser!.uid;
    _startTimer();
    if (!_isOwnStory) { 
      _markAsSeen();
    }
  }

  void _startTimer() {
    _timer = Timer.periodic(_storyDuration, (timer) {
      if (_currentIndex < widget.stories.length - 1) {
        _nextStory();
      } else {
        Navigator.pop(context); 
      }
    });
  }

  void _markAsSeen() async {
    final currentUserId = FirebaseAuth.instance.currentUser!.uid;
    for (var story in widget.stories) {
      final viewers = List.from(story['viewers'] ?? []); 
      if (!viewers.contains(currentUserId)) {
        try {
          await FirebaseFirestore.instance.collection('stories').doc(story.id).update({
            'viewers': FieldValue.arrayUnion([currentUserId])
          });
        } catch (e) {
          print("Error marking story as seen: $e");
        }
      }
    }
  }

  void _nextStory() {
    if (_currentIndex < widget.stories.length - 1) {
      setState(() {
        _currentIndex++;
        _pageController.nextPage(
          duration: Duration(milliseconds: 300),
          curve: Curves.easeInOut,
        );
      });
    }
  }

  void _previousStory() {
    if (_currentIndex > 0) {
      setState(() {
        _currentIndex--;
        _pageController.previousPage(
          duration: Duration(milliseconds: 300),
          curve: Curves.easeInOut,
        );
      });
    }
  }

   @override
  void dispose() {
    _timer.cancel();
    _pageController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    if (widget.stories.isEmpty || _currentIndex >= widget.stories.length) {
      return Scaffold(
        backgroundColor: Colors.black,
        body: Center(child: Text("No stories to display", style: TextStyle(color: Colors.white))),
      );
    }

    final currentStory = widget.stories[_currentIndex];
    return GestureDetector(
      onTapDown: (details) {
        final screenWidth = MediaQuery.of(context).size.width;
        if (details.globalPosition.dx < screenWidth / 2) {
          _previousStory();
        } else {
          _nextStory();
        }
      },
      child: Scaffold(
        backgroundColor: Colors.black, // Full screen media is usually black bg
        body: Stack(
          children: [
            // Story content
            PageView.builder(
              controller: _pageController,
              itemCount: widget.stories.length,
              physics: NeverScrollableScrollPhysics(), // Disable swipe to not interfere with tap logic
              onPageChanged: (index) {
                setState(() => _currentIndex = index);
              },
              itemBuilder: (context, index) {
                 if (index >= widget.stories.length) return Container();
                final story = widget.stories[index];
                return Stack(
                  children: [
                    // Media
                    Center(
                      child: story['mediaType'] == 'image'
                          ? CachedNetworkImage(
                              imageUrl: story['mediaUrl'],
                              fit: BoxFit.contain,
                              width: double.infinity,
                              placeholder: (context, url) => Center(child: CircularProgressIndicator(color: Colors.white)),
                              errorWidget: (context, url, error) => Center(
                                child: Icon(Feather.alert_circle, color: Colors.white),
                              ),
                            )
                          : Container(
                              color: Colors.black,
                              child: Center(
                                child: Icon(Feather.play, color: Colors.white, size: 50),
                              ),
                            ),
                    ),
                    // Caption overlay
                    if ((story['caption'] as String?)?.isNotEmpty == true)
                      Positioned(
                        bottom: 40,
                        left: 0,
                        right: 0,
                        child: Container(
                          padding: EdgeInsets.all(16),
                          color: Colors.black54,
                          child: Text(
                            story['caption'],
                            textAlign: TextAlign.center,
                            style: TextStyle(color: Colors.white, fontSize: 16),
                          ),
                        ),
                      ),
                  ],
                );
              },
            ),
            // Progress bars
            Positioned(
              top: 50,
              left: 10,
              right: 10,
              child: Row(
                children: widget.stories.asMap().entries.map((entry) {
                  int index = entry.key;
                  return Expanded(
                    child: Container(
                      height: 3,
                      margin: EdgeInsets.symmetric(horizontal: 2),
                      decoration: BoxDecoration(
                        color: Colors.white30,
                        borderRadius: BorderRadius.circular(2),
                      ),
                      child: Stack(
                        children: [
                          if (index == _currentIndex)
                            // Animated progress
                            TweenAnimationBuilder<double>(
                              tween: Tween(begin: 0.0, end: 1.0),
                              duration: _storyDuration,
                              builder: (context, value, child) {
                                return FractionallySizedBox(
                                  alignment: Alignment.centerLeft,
                                  widthFactor: value,
                                  child: Container(
                                    decoration: BoxDecoration(
                                      color: Colors.white,
                                      borderRadius: BorderRadius.circular(2),
                                    ),
                                  ),
                                );
                              },
                            )
                          else if (index < _currentIndex)
                            // Completed
                            Container(
                              decoration: BoxDecoration(
                                color: Colors.white,
                                borderRadius: BorderRadius.circular(2),
                              ),
                            ),
                        ],
                      ),
                    ),
                  );
                }).toList(),
              ),
            ),
             // User info and close button
            Positioned(
              top: 65,
              left: 16,
              right: 16, 
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween, 
                children: [
                  Row(
                    children: [
                      CircleAvatar(
                        radius: 20,
                        backgroundImage: widget.profileImage.isNotEmpty
                            ? CachedNetworkImageProvider(widget.profileImage)
                            : AssetImage('assets/default_avatar.png') as ImageProvider,
                      ),
                      SizedBox(width: 12),
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            widget.username,
                            style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                          ),
                          Text(
                            timeago.format(currentStory['timestamp'].toDate()),
                            style: TextStyle(color: Colors.white70, fontSize: 12),
                          ),
                        ],
                      ),
                    ],
                  ),
                  IconButton(
                    icon: Icon(Feather.x, color: Colors.white),
                    onPressed: () => Navigator.pop(context),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}


--- C:\Code\femn\lib\hub_screens\wellness.dart ---

import 'dart:math';
import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:femn/customization/colors.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/material.dart';
import 'package:flutter_staggered_grid_view/flutter_staggered_grid_view.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';

// --- Custom Imports ---
import 'package:femn/hub_screens/profile.dart';
import 'package:femn/hub_screens/search.dart';
import '../wellness_widgets/journal.dart';
import 'package:femn/wellness_widgets/period_tracker.dart';
import '../wellness_widgets/tracker.dart';
import '../services/streak_service.dart';
import '../wellness_widgets/twin_finder.dart';
import '../wellness_widgets/leakguard/leakguard.dart';
import '../therapy/screens/therapy_discovery_screen.dart';
import '../therapy/screens/therapist_dashboard.dart';
import '../circle/petitions.dart';

// --- Enums & Models ---
enum WidgetType {
  journal,
  cycle,
  activity,
  twinFinder,
  safetyHeatmaps,
  pinksLevel,
  selfDefense,
  literature,
  leakGuard,
  checkInTimer,
  therapy,
  clientDashboard,
  petitionsDashboard,
}

class GridItem {
  final String id;
  final WidgetType type;
  int crossAxisCount;
  int mainAxisCount;

  GridItem({
    required this.id,
    required this.type,
    this.crossAxisCount = 2,
    this.mainAxisCount = 2,
  });

  // Convert object to Map for Firestore
  Map<String, dynamic> toJson() => {
    'id': id,
    'type': type.name, // Saves as "journal", "cycle", etc.
    'cross': crossAxisCount,
    'main': mainAxisCount,
  };

  // Create object from Map from Firestore
  factory GridItem.fromJson(Map<String, dynamic> json) {
    return GridItem(
      id: json['id'],
      // Find the enum value that matches the string name
      type: WidgetType.values.firstWhere(
        (e) => e.name == json['type'],
        orElse: () => WidgetType.journal, // Fallback if error
      ),
      crossAxisCount: json['cross'] ?? 2,
      mainAxisCount: json['main'] ?? 2,
    );
  }
}

class WellnessScreen extends StatefulWidget {
  @override
  _WellnessScreenState createState() => _WellnessScreenState();
}

class _WellnessScreenState extends State<WellnessScreen> {
  List<GridItem> _activeWidgets = [];
  bool _isEditMode = false;
  bool _isLoading = true; // Add loading state
  final String _uid =
      FirebaseAuth.instance.currentUser!.uid; // Store UID for easy access

  // Define available widgets content
  final Map<WidgetType, Map<String, dynamic>> _widgetDefinitions = {
    WidgetType.journal: {
      'name': 'Wellness Journal',
      'icon': Feather.book,
      'desc': 'Track mental health',
      'hasStreak': true,
      'onTap': (context) => Navigator.push(
        context,
        MaterialPageRoute(builder: (c) => JournalScreen()),
      ),
    },
    WidgetType.cycle: {
      'name': 'Cycle',
      'icon': Feather.calendar,
      'desc': 'Track your flow',
      'isCycle': true,
      'onTap': (context) => Navigator.push(
        context,
        MaterialPageRoute(builder: (c) => PeriodTrackerScreen()),
      ),
    },
    WidgetType.activity: {
      'name': 'Activity',
      'icon': Feather.trending_up,
      'desc': 'Petitions & polls',
      'onTap': (context) => Navigator.push(
        context,
        MaterialPageRoute(builder: (c) => TrackerScreen()),
      ),
    },
    WidgetType.twinFinder: {
      'name': 'Twin Finder',
      'icon': Feather.users,
      'desc': 'Find personality twin',
      'onTap': (context) => Navigator.push(
        context,
        MaterialPageRoute(builder: (c) => TwinFinderScreen()),
      ),
    },
    WidgetType.safetyHeatmaps: {
      'name': 'Safety Heatmaps',
      'icon': Feather.map_pin,
      'desc': 'View safety info',
    },
    WidgetType.pinksLevel: {
      'name': 'Pinks & Level',
      'icon': Feather.bar_chart,
      'desc': 'Track pink levels',
    },
    WidgetType.selfDefense: {
      'name': 'Self-defense',
      'icon': Feather.shield,
      'desc': 'Learn techniques',
    },
    WidgetType.literature: {
      'name': 'Literature',
      'icon': Feather.book_open,
      'desc': 'Educational content',
    },
    WidgetType.leakGuard: {
      'name': 'Leak Guard',
      'icon': Feather.lock,
      'desc': 'Anti-sextortion tool',
      'onTap': (context) => Navigator.push(
        context,
        MaterialPageRoute(builder: (c) => LeakGuardScreen()),
      ),
    },
    WidgetType.checkInTimer: {
      'name': 'Check-in Timer',
      'icon': Feather.clock,
      'desc': 'Set reminders',
    },
    WidgetType.therapy: {
      'name': 'Therapy',
      'icon': Feather.heart,
      'desc': 'Professional support',
      'onTap': (context) => Navigator.push(
        context,
        MaterialPageRoute(builder: (c) => TherapyDiscoveryScreen()),
      ),
    },
    WidgetType.clientDashboard: {
      'name': 'Client Dashboard',
      'icon': Feather.grid,
      'desc': 'Manage your clients',
      'onTap': (context) => Navigator.push(
        context,
        MaterialPageRoute(builder: (c) => TherapistDashboard()),
      ),
    },
    WidgetType.petitionsDashboard: {
      'name': 'Petitions Dashboard',
      'icon': Feather.flag,
      'desc': 'Manage your causes',
      'onTap': (context) => Navigator.push(
        context,
        MaterialPageRoute(builder: (c) => UserPetitionsDashboard()),
      ),
    },
  };

  @override
  void initState() {
    super.initState();
    _loadLayout(); // Load data when screen starts
  }

  // --- FIRESTORE PERSISTENCE LOGIC ---

  // 1. Save current list to Firestore & Local Cache
  Future<void> _saveLayout() async {
    try {
      // Convert list of objects to list of Maps
      final data = _activeWidgets.map((e) => e.toJson()).toList();

      // 1. Save Local
      final prefs = await SharedPreferences.getInstance();
      await prefs.setString('wellness_layout_cache', jsonEncode(data));

      // 2. Save Remote
      await FirebaseFirestore.instance.collection('users').doc(_uid).update({
        'wellnessLayout': data,
      });
    } catch (e) {
      print("Error saving layout: $e");
    }
  }

  // 2. Load list (Cache First, Then Network)
  Future<void> _loadLayout() async {
    // A. Try Local Cache FIRST (Instant)
    try {
      final prefs = await SharedPreferences.getInstance();
      final String? cached = prefs.getString('wellness_layout_cache');
      if (cached != null) {
        final List<dynamic> decoded = jsonDecode(cached);
        if (mounted) {
          setState(() {
            _activeWidgets = decoded
                .map((item) => GridItem.fromJson(item))
                .toList();
            _isLoading = false; // Show UI immediately
          });
        }
      }
    } catch (e) {
      print("Cache error: $e");
    }

    // B. Fetch from Network (Background Sync)
    try {
      DocumentSnapshot doc = await FirebaseFirestore.instance
          .collection('users')
          .doc(_uid)
          .get();

      if (doc.exists && doc.data() != null) {
        final data = doc.data() as Map<String, dynamic>;

        if (data.containsKey('wellnessLayout')) {
          List<dynamic> savedList = data['wellnessLayout'];

          // Update Cache
          final prefs = await SharedPreferences.getInstance();
          await prefs.setString('wellness_layout_cache', jsonEncode(savedList));

          if (mounted) {
            setState(() {
              _activeWidgets = savedList
                  .map((item) => GridItem.fromJson(item))
                  .toList();
              _isLoading = false;
            });
          }
        } else {
          if (mounted && _activeWidgets.isEmpty)
            setState(() => _isLoading = false);
        }
      } else {
        if (mounted && _activeWidgets.isEmpty)
          setState(() => _isLoading = false);
      }
    } catch (e) {
      print("Error loading layout: $e");
      if (mounted && _activeWidgets.isEmpty) setState(() => _isLoading = false);
    }
  }

  Future<void> _onRefresh() async {
    await _loadLayout(); // Refresh now re-fetches from DB
  }

  // --- Logic: Add Widget (Updated) ---
  void _addWidget(WidgetType type) {
    setState(() {
      int cross = 2;
      int main = 2;
      if (type == WidgetType.journal ||
          type == WidgetType.activity ||
          type == WidgetType.literature ||
          type == WidgetType.pinksLevel) {
        cross = 3;
      }
      if (type == WidgetType.checkInTimer) {
        cross = 5;
        main = 2;
      }
      if (type == WidgetType.cycle) {
        cross = 2;
        main = 3;
      }

      _activeWidgets.add(
        GridItem(
          id: DateTime.now().millisecondsSinceEpoch.toString(),
          type: type,
          crossAxisCount: cross,
          mainAxisCount: main,
        ),
      );
    });
    _saveLayout(); // <--- SAVE
    Navigator.pop(context);
  }

  // --- Logic: Remove Widget (Updated) ---
  void _removeWidget(int index) {
    setState(() {
      _activeWidgets.removeAt(index);
      if (_activeWidgets.isEmpty) _isEditMode = false;
    });
    _saveLayout(); // <--- SAVE
  }

  // --- Logic: Resize Widget (Updated) ---
  void _resizeWidget(int index) {
    setState(() {
      var item = _activeWidgets[index];
      if (item.crossAxisCount == 2 && item.mainAxisCount == 2) {
        item.crossAxisCount = 3;
        item.mainAxisCount = 2;
      } else if (item.crossAxisCount == 3 && item.mainAxisCount == 2) {
        item.crossAxisCount = 2;
        item.mainAxisCount = 3;
      } else if (item.crossAxisCount == 2 && item.mainAxisCount == 3) {
        item.crossAxisCount = 4;
        item.mainAxisCount = 3;
      } else if (item.crossAxisCount == 4 && item.mainAxisCount == 3) {
        item.crossAxisCount = 5;
        item.mainAxisCount = 2;
      } else {
        item.crossAxisCount = 2;
        item.mainAxisCount = 2;
      }
    });
    _saveLayout(); // <--- SAVE
  }

  // --- Logic: Reorder (Updated) ---
  void _moveWidget(int index, int direction) {
    setState(() {
      if (direction == -1 && index > 0) {
        final item = _activeWidgets.removeAt(index);
        _activeWidgets.insert(index - 1, item);
      } else if (direction == 1 && index < _activeWidgets.length - 1) {
        final item = _activeWidgets.removeAt(index);
        _activeWidgets.insert(index + 1, item);
      }
    });
    _saveLayout(); // <--- SAVE
  }

  // --- UI: Add Menu ---
  void _showAddWidgetMenu() {
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (context) {
        final usedTypes = _activeWidgets.map((e) => e.type).toSet();
        final available = WidgetType.values
            .where((t) => !usedTypes.contains(t))
            .toList();

        return Container(
          decoration: BoxDecoration(
            color: AppColors.backgroundDeep,
            borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
          ),
          padding: EdgeInsets.all(20),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                "Add Widget to Mesh",
                style: TextStyle(
                  color: AppColors.textHigh,
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                ),
              ),
              SizedBox(height: 16),
              available.isEmpty
                  ? Padding(
                      padding: const EdgeInsets.all(20.0),
                      child: Center(
                        child: Text(
                          "All widgets added!",
                          style: TextStyle(color: AppColors.textDisabled),
                        ),
                      ),
                    )
                  : Expanded(
                      child: GridView.builder(
                        gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                          crossAxisCount: 3,
                          crossAxisSpacing: 10,
                          mainAxisSpacing: 10,
                        ),
                        itemCount: available.length,
                        itemBuilder: (context, index) {
                          final type = available[index];
                          final def = _widgetDefinitions[type]!;
                          return GestureDetector(
                            onTap: () => _addWidget(type),
                            child: Container(
                              decoration: BoxDecoration(
                                color: AppColors.surface,
                                borderRadius: BorderRadius.circular(16),
                                border: Border.all(color: AppColors.elevation),
                              ),
                              child: Column(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  Icon(
                                    def['icon'],
                                    color: AppColors.primaryLavender,
                                  ),
                                  SizedBox(height: 8),
                                  Text(
                                    def['name'],
                                    style: TextStyle(
                                      color: AppColors.textMedium,
                                      fontSize: 12,
                                    ),
                                    textAlign: TextAlign.center,
                                  ),
                                ],
                              ),
                            ),
                          );
                        },
                      ),
                    ),
            ],
          ),
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    final currentUserId = FirebaseAuth.instance.currentUser!.uid;

    return Scaffold(
      backgroundColor: Colors.transparent,
      body: GestureDetector(
        onTap: () {
          if (_isEditMode) setState(() => _isEditMode = false);
        },
        onLongPress: () {
          if (!_isEditMode) _showAddWidgetMenu();
        },
        child: RefreshIndicator(
          onRefresh: _onRefresh,
          color: AppColors.primaryLavender,
          backgroundColor: Colors.transparent,
          child: CustomScrollView(
            physics: AlwaysScrollableScrollPhysics(),
            slivers: [
              SliverAppBar(
                backgroundColor: Colors.transparent,
                elevation: 0,
                pinned: true,
                automaticallyImplyLeading: false,
                title: Row(
                  children: [
                    _buildLogo(),
                    SizedBox(width: 8),
                    Text(
                      'You',
                      style: TextStyle(
                        fontWeight: FontWeight.bold,
                        color: AppColors.textHigh,
                      ),
                    ),
                  ],
                ),
                actions: [
                  _buildCircleButton(
                    Feather.search,
                    () => Navigator.push(
                      context,
                      MaterialPageRoute(builder: (c) => SearchScreen()),
                    ),
                  ),
                  SizedBox(width: 8),
                  _buildUserAvatar(currentUserId),
                  SizedBox(width: 12),
                ],
              ),

              SliverPadding(
                padding: EdgeInsets.all(12),
                sliver: _isLoading
                    ? SliverFillRemaining(
                        child: Center(
                          child: CircularProgressIndicator(
                            color: AppColors.primaryLavender,
                          ),
                        ),
                      )
                    : _activeWidgets.isEmpty
                    ? SliverFillRemaining(
                        child: Center(
                          child: Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Icon(
                                Feather.plus_square,
                                size: 40,
                                color: AppColors.textDisabled,
                              ),
                              SizedBox(height: 12),
                              Text(
                                "Long press here to add widgets",
                                style: TextStyle(color: AppColors.textMedium),
                              ),
                            ],
                          ),
                        ),
                      )
                    : SliverToBoxAdapter(
                        child: StaggeredGrid.count(
                          crossAxisCount: 5,
                          mainAxisSpacing: 10,
                          crossAxisSpacing: 10,
                          children: List.generate(_activeWidgets.length, (
                            index,
                          ) {
                            final item = _activeWidgets[index];
                            return StaggeredGridTile.count(
                              key: ValueKey(item.id),
                              crossAxisCellCount: item.crossAxisCount,
                              mainAxisCellCount: item.mainAxisCount,
                              child: _buildEditableWrapper(index, item),
                            );
                          }),
                        ),
                      ),
              ),
              SliverToBoxAdapter(child: SizedBox(height: 80)),
            ],
          ),
        ),
      ),
    );
  }

  // --- Item Wrapper (Handles Edit Mode) ---
  Widget _buildEditableWrapper(int index, GridItem item) {
    Widget content = _buildCardContent(item);

    return GestureDetector(
      onLongPress: () {
        setState(() => _isEditMode = true);
      },
      child: Stack(
        children: [
          Positioned.fill(child: content),

          if (_isEditMode)
            Positioned.fill(
              child: Container(
                decoration: BoxDecoration(
                  color: Colors.black.withOpacity(0.5),
                  borderRadius: BorderRadius.circular(24),
                  border: Border.all(color: Colors.white, width: 2),
                ),
              ),
            ),

          if (_isEditMode)
            Positioned(
              bottom: 8,
              right: 8,
              child: GestureDetector(
                onTap: () => _resizeWidget(index),
                child: CircleAvatar(
                  radius: 16,
                  backgroundColor: AppColors.primaryLavender,
                  child: Icon(
                    Feather.maximize_2,
                    size: 16,
                    color: Colors.white,
                  ),
                ),
              ),
            ),

          if (_isEditMode)
            Positioned(
              top: 8,
              left: 8,
              child: GestureDetector(
                onTap: () => _removeWidget(index),
                child: CircleAvatar(
                  radius: 16,
                  backgroundColor: AppColors.error,
                  child: Icon(Feather.x, size: 16, color: Colors.white),
                ),
              ),
            ),

          if (_isEditMode)
            Positioned(
              top: 8,
              right: 8,
              child: Row(
                children: [
                  if (index > 0)
                    GestureDetector(
                      onTap: () => _moveWidget(index, -1),
                      child: CircleAvatar(
                        radius: 14,
                        backgroundColor: Colors.white24,
                        child: Icon(
                          Feather.chevron_left,
                          size: 16,
                          color: Colors.white,
                        ),
                      ),
                    ),
                  SizedBox(width: 4),
                  if (index < _activeWidgets.length - 1)
                    GestureDetector(
                      onTap: () => _moveWidget(index, 1),
                      child: CircleAvatar(
                        radius: 14,
                        backgroundColor: Colors.white24,
                        child: Icon(
                          Feather.chevron_right,
                          size: 16,
                          color: Colors.white,
                        ),
                      ),
                    ),
                ],
              ),
            ),
        ],
      ),
    );
  }

  // --- Content Builder ---
  Widget _buildCardContent(GridItem item) {
    final def = _widgetDefinitions[item.type]!;

    VoidCallback? onTap;
    if (!_isEditMode && def['onTap'] != null) {
      onTap = () => def['onTap'](context);
    }

    Widget baseContent = Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        Icon(
          def['icon'],
          size: item.mainAxisCount >= 3 ? 55 : 40,
          color: AppColors.primaryLavender,
        ),
        SizedBox(height: 12),
        Text(
          def['name'],
          style: TextStyle(
            fontWeight: FontWeight.bold,
            fontSize: item.mainAxisCount >= 3 ? 18 : 15,
            color: AppColors.textHigh,
          ),
          textAlign: TextAlign.center,
          maxLines: 1,
          overflow: TextOverflow.ellipsis,
        ),
        if (item.mainAxisCount >= 2) ...[
          SizedBox(height: 4),
          Text(
            def['desc'],
            style: TextStyle(
              fontSize: 11,
              fontStyle: FontStyle.italic,
              color: AppColors.textMedium,
            ),
            textAlign: TextAlign.center,
            maxLines: 2,
          ),
        ],
      ],
    );

    final uid = FirebaseAuth.instance.currentUser!.uid;

    if (def['hasStreak'] == true) {
      return StreamBuilder<DocumentSnapshot>(
        stream: FirebaseFirestore.instance
            .collection('users')
            .doc(uid)
            .snapshots(),
        builder: (context, snapshot) {
          int count = 0;
          bool isActive = false;
          if (snapshot.hasData && snapshot.data!.exists) {
            final data = snapshot.data!.data() as Map<String, dynamic>;
            count = data['streakCount'] ?? 0;
            final Timestamp? lastLogTs = data['lastStreakDate'];
            if (lastLogTs != null) {
              final diff = DateTime.now().difference(lastLogTs.toDate()).inDays;
              isActive = diff <= 1;
              if (diff > 1 && count > 0) isActive = false;
            }
          }
          return _buildBaseContainer(
            baseContent,
            onTap,
            streakCount: count,
            streakActive: isActive,
          );
        },
      );
    }

    if (def['isCycle'] == true) {
      return StreamBuilder<DocumentSnapshot>(
        stream: FirebaseFirestore.instance
            .collection('users')
            .doc(uid)
            .collection('cycle_settings')
            .doc('settings')
            .snapshots(),
        builder: (context, snapshot) {
          CyclePhaseData? currentPhase;
          if (snapshot.hasData && snapshot.data!.exists) {
            final data = snapshot.data!.data() as Map<String, dynamic>;
            final Timestamp? lastPeriod = data['lastPeriodStart'];
            final int avgCycle = data['avgCycleLength'] ?? 28;
            final bool isPregnancy = data['isPregnancyMode'] ?? false;
            if (lastPeriod != null && !isPregnancy) {
              currentPhase = CycleService.getCurrentPhase(
                lastPeriod.toDate(),
                avgCycle,
              );
            }
          }
          return _buildBaseContainer(
            baseContent,
            onTap,
            cyclePhase: currentPhase,
          );
        },
      );
    }

    return _buildBaseContainer(baseContent, onTap);
  }

  Widget _buildBaseContainer(
    Widget content,
    VoidCallback? onTap, {
    int? streakCount,
    bool? streakActive,
    CyclePhaseData? cyclePhase,
  }) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        decoration: BoxDecoration(
          color: AppColors.surface,
          borderRadius: BorderRadius.circular(24.0),
          border: Border.all(color: AppColors.elevation, width: 1),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.15),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: Stack(
          children: [
            Center(
              child: Padding(
                padding: const EdgeInsets.all(12.0),
                child: content,
              ),
            ),

            if (streakCount != null)
              Positioned(
                top: 12,
                right: 12,
                child: GestureDetector(
                  onTap: (streakActive == false)
                      ? () => _showRestorationModal(context, streakCount)
                      : null,
                  child: Container(
                    padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(
                      color: AppColors.elevation,
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: streakActive!
                            ? Colors.orange.withOpacity(0.5)
                            : AppColors.textDisabled.withOpacity(0.3),
                      ),
                    ),
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Icon(
                          streakActive ? Feather.zap : Feather.zap,
                          size: 16,
                          color: streakActive
                              ? Colors.orange
                              : AppColors.textDisabled,
                        ),
                        SizedBox(width: 4),
                        Text(
                          "$streakCount",
                          style: TextStyle(
                            color: streakActive
                                ? AppColors.textHigh
                                : AppColors.textDisabled,
                            fontWeight: FontWeight.bold,
                            fontSize: 12,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ),

            if (cyclePhase != null)
              Positioned(
                top: 12,
                right: 12,
                child: Container(
                  padding: EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                  decoration: BoxDecoration(
                    color: cyclePhase.bgColor,
                    borderRadius: BorderRadius.circular(20),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.2),
                        blurRadius: 4,
                        offset: Offset(0, 2),
                      ),
                    ],
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(
                        cyclePhase.icon,
                        size: 12,
                        color: cyclePhase.textColor,
                      ),
                      SizedBox(width: 6),
                      Text(
                        cyclePhase.seasonName,
                        style: TextStyle(
                          color: cyclePhase.textColor,
                          fontWeight: FontWeight.bold,
                          fontSize: 11,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
          ],
        ),
      ),
    );
  }

  // --- Helpers (Logo, Avatar, etc) ---
  Widget _buildLogo() {
    return Container(
      width: 42,
      height: 42,
      decoration: BoxDecoration(
        shape: BoxShape.circle,
        color: AppColors.elevation,
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.2),
            blurRadius: 6,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: ClipOval(
        child: Image.asset('assets/default_avatar.png', fit: BoxFit.cover),
      ),
    );
  }

  Widget _buildCircleButton(IconData icon, VoidCallback onTap) {
    return Container(
      width: 42,
      height: 42,
      decoration: BoxDecoration(
        shape: BoxShape.circle,
        color: AppColors.elevation,
      ),
      child: IconButton(
        icon: Icon(icon, color: AppColors.primaryLavender, size: 22),
        onPressed: onTap,
      ),
    );
  }

  Widget _buildUserAvatar(String uid) {
    return FutureBuilder<DocumentSnapshot>(
      future: FirebaseFirestore.instance.collection('users').doc(uid).get(),
      builder: (context, snapshot) {
        String url = '';
        if (snapshot.hasData && snapshot.data!.exists) {
          url = snapshot.data!.get('profileImage') ?? '';
        }
        return GestureDetector(
          onTap: () => Navigator.push(
            context,
            MaterialPageRoute(builder: (c) => ProfileScreen(userId: uid)),
          ),
          child: Container(
            width: 42,
            height: 42,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              color: AppColors.elevation,
            ),
            child: ClipOval(
              child: url.isNotEmpty
                  ? Image(
                      image: CachedNetworkImageProvider(url),
                      fit: BoxFit.cover,
                    )
                  : Image.asset('assets/default_avatar.png', fit: BoxFit.cover),
            ),
          ),
        );
      },
    );
  }

  void _showRestorationModal(BuildContext context, int lostStreak) {
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (context) => Container(
        padding: EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: AppColors.surface,
          borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(Feather.zap, size: 48, color: AppColors.textDisabled),
            SizedBox(height: 16),
            Text(
              "Streak Extinguished!",
              style: TextStyle(
                color: AppColors.textHigh,
                fontSize: 20,
                fontWeight: FontWeight.bold,
              ),
            ),
            SizedBox(height: 8),
            Text(
              "You missed a day. You can restore your $lostStreak day streak if it was lost within the last 48 hours.",
              textAlign: TextAlign.center,
              style: TextStyle(color: AppColors.textMedium),
            ),
            SizedBox(height: 24),
            Row(
              children: [
                Expanded(
                  child: OutlinedButton(
                    onPressed: () => Navigator.pop(context),
                    child: Text("Let it go"),
                    style: OutlinedButton.styleFrom(
                      foregroundColor: AppColors.textMedium,
                      side: BorderSide(color: AppColors.textDisabled),
                    ),
                  ),
                ),
                SizedBox(width: 12),
                Expanded(
                  child: ElevatedButton(
                    onPressed: () async {
                      Navigator.pop(context);
                      final result = await StreakService.tryRestoreStreak();
                      ScaffoldMessenger.of(context).showSnackBar(
                        SnackBar(
                          content: Text(
                            result == "Success"
                                ? "Streak Restored! "
                                : result,
                          ),
                          backgroundColor: result == "Success"
                              ? Colors.orange
                              : AppColors.error,
                        ),
                      );
                    },
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.orange,
                    ),
                    child: Text("Restore "),
                  ),
                ),
              ],
            ),
            SizedBox(height: 12),
            FutureBuilder<DocumentSnapshot>(
              future: FirebaseFirestore.instance
                  .collection('users')
                  .doc(FirebaseAuth.instance.currentUser!.uid)
                  .get(),
              builder: (context, snapshot) {
                if (!snapshot.hasData) return SizedBox();
                int used = snapshot.data!.get('restorationsUsed') ?? 0;
                return Text(
                  "Restorations used this month: $used/3",
                  style: TextStyle(color: AppColors.textDisabled, fontSize: 12),
                );
              },
            ),
          ],
        ),
      ),
    );
  }
}


--- C:\Code\femn\lib\services\custom_camera_screen.dart ---

import 'dart:io';
import 'package:camera/camera.dart';
import 'package:femn/customization/colors.dart';
import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';

class CustomCameraScreen extends StatefulWidget {
  @override
  _CustomCameraScreenState createState() => _CustomCameraScreenState();
}

class _CustomCameraScreenState extends State<CustomCameraScreen> {
  CameraController? _controller;
  List<CameraDescription>? _cameras;
  int _selectedCameraIndex = 0;
  bool _isRecording = false;
  bool _isPhotoMode = true; // Toggle between Photo and Video
  bool _isInitializing = true;

  @override
  void initState() {
    super.initState();
    _initializeCamera();
  }

  Future<void> _initializeCamera() async {
    _cameras = await availableCameras();
    if (_cameras != null && _cameras!.isNotEmpty) {
      _controller = CameraController(
        _cameras![_selectedCameraIndex],
        ResolutionPreset.high,
        enableAudio: true,
      );
      await _controller!.initialize();
      if (mounted) setState(() => _isInitializing = false);
    }
  }

  Future<void> _takePhoto() async {
    if (_controller == null || !_controller!.value.isInitialized) return;
    try {
      final XFile image = await _controller!.takePicture();
      Navigator.pop(context, File(image.path));
    } catch (e) {
      print("Error capturing photo: $e");
    }
  }

  Future<void> _toggleRecording() async {
    if (_controller == null || !_controller!.value.isInitialized) return;

    if (_isRecording) {
      final XFile video = await _controller!.stopVideoRecording();
      setState(() => _isRecording = false);
      Navigator.pop(context, File(video.path));
    } else {
      await _controller!.startVideoRecording();
      setState(() => _isRecording = true);
    }
  }

  void _switchCamera() {
    setState(() {
      _isInitializing = true;
      _selectedCameraIndex = (_selectedCameraIndex + 1) % _cameras!.length;
    });
    _initializeCamera();
  }

  @override
  void dispose() {
    _controller?.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    if (_isInitializing || _controller == null) {
      return Scaffold(
        backgroundColor: Colors.black,
        body: Center(child: CircularProgressIndicator(color: AppColors.primaryLavender)),
      );
    }

    return Scaffold(
      backgroundColor: Colors.black,
      body: Stack(
        children: [
          // 1. Camera Preview
          Center(child: CameraPreview(_controller!)),

          // 2. Top Controls (Close & Flash could go here)
          Positioned(
            top: 50,
            left: 20,
            child: IconButton(
              icon: Icon(Feather.x, color: Colors.white, size: 30),
              onPressed: () => Navigator.pop(context),
            ),
          ),

          // 3. Side Controls (Flip Camera)
          Positioned(
            top: 60,
            right: 20,
            child: Column(
              children: [
                IconButton(
                  icon: Icon(Feather.refresh_cw, color: Colors.white),
                  onPressed: _switchCamera,
                ),
                Text("Flip", style: TextStyle(color: Colors.white, fontSize: 12)),
              ],
            ),
          ),

          // 4. Bottom Controls (Capture & Mode Switcher)
          Positioned(
            bottom: 40,
            left: 0,
            right: 0,
            child: Column(
              children: [
                // Shutter Button
                GestureDetector(
                  onTap: _isPhotoMode ? _takePhoto : _toggleRecording,
                  child: Container(
                    height: 80,
                    width: 80,
                    decoration: BoxDecoration(
                      shape: BoxShape.circle,
                      border: Border.all(color: Colors.white, width: 4),
                    ),
                    child: Center(
                      child: Container(
                        height: _isRecording ? 30 : 60,
                        width: _isRecording ? 30 : 60,
                        decoration: BoxDecoration(
                          color: _isPhotoMode ? Colors.white : Colors.red,
                          borderRadius: _isRecording 
                              ? BorderRadius.circular(4) 
                              : BorderRadius.circular(50),
                        ),
                      ),
                    ),
                  ),
                ),
                SizedBox(height: 20),
                
                // Mode Selector (Photo / Video Text)
                Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    GestureDetector(
                      onTap: () => setState(() => _isPhotoMode = true),
                      child: Text(
                        "Photo",
                        style: TextStyle(
                          color: _isPhotoMode ? Colors.white : Colors.grey,
                          fontWeight: FontWeight.bold,
                          fontSize: 16,
                          shadows: [Shadow(blurRadius: 5, color: Colors.black)],
                        ),
                      ),
                    ),
                    SizedBox(width: 20),
                    GestureDetector(
                      onTap: () => setState(() => _isPhotoMode = false),
                      child: Text(
                        "Video",
                        style: TextStyle(
                          color: !_isPhotoMode ? Colors.white : Colors.grey,
                          fontWeight: FontWeight.bold,
                          fontSize: 16,
                          shadows: [Shadow(blurRadius: 5, color: Colors.black)],
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}


--- C:\Code\femn\lib\services\custom_gallery_screen.dart ---

import 'dart:io';
import 'dart:typed_data';
import 'package:femn/customization/colors.dart'; 
import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:photo_manager/photo_manager.dart';
import 'package:flutter_staggered_grid_view/flutter_staggered_grid_view.dart';
import 'package:femn/customization/layout.dart';

class CustomGalleryScreen extends StatefulWidget {
  @override
  _CustomGalleryScreenState createState() => _CustomGalleryScreenState();
}

class _CustomGalleryScreenState extends State<CustomGalleryScreen> {
  List<AssetEntity> _assets = [];
  bool _isLoading = true;
  int _selectedFilterIndex = 0; // 0: All, 1: Photos, 2: Videos

  @override
  void initState() {
    super.initState();
    _fetchAssets();
  }

  // Map index to RequestType
  RequestType _getMediaTypeForIndex(int index) {
    switch (index) {
      case 0: return RequestType.common; // All
      case 1: return RequestType.image;  // Photos
      case 2: return RequestType.video;  // Videos
      default: return RequestType.common;
    }
  }

Future<void> _fetchAssets({RequestType type = RequestType.common}) async {
    setState(() => _isLoading = true);

    // Request permission
    final PermissionState ps = await PhotoManager.requestPermissionExtend();
    if (ps.isAuth) {
      
      // 1. Define the sort order: Creation Date, Descending (Newest first)
      final FilterOptionGroup filterOption = FilterOptionGroup(
        orders: [
          OrderOption(type: OrderOptionType.createDate, asc: false),
        ],
      );

      // 2. Pass 'filterOption' to getAssetPathList
      List<AssetPathEntity> albums = await PhotoManager.getAssetPathList(
        type: type,
        filterOption: filterOption, 
      );

      if (albums.isNotEmpty) {
        // Since we sorted the query, the range 0-100 will now be the 100 MOST RECENT items.
        // You can increase 'end' to load more, or implement pagination.
        List<AssetEntity> media = await albums[0].getAssetListRange(start: 0, end: 100);
        
        setState(() {
          _assets = media;
          _isLoading = false;
        });
      } else {
        setState(() {
          _assets = [];
          _isLoading = false;
        });
      }
    } else {
      setState(() => _isLoading = false);
      PhotoManager.openSetting();
    }
  }

  void _onFilterChanged(int index) {
    if (_selectedFilterIndex != index) {
      setState(() {
        _selectedFilterIndex = index;
      });
      _fetchAssets(type: _getMediaTypeForIndex(index));
    }
  }

  Future<void> _selectAsset(AssetEntity asset) async {
    File? file = await asset.file;
    if (file != null) {
      Navigator.pop(context, file);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      body: SafeArea(
        child: Column(
          children: [
            _buildCustomHeader(),
            _buildFilterPills(),
            Expanded(
              child: _isLoading
                  ? Center(child: CircularProgressIndicator(color: AppColors.primaryLavender))
                  : _assets.isEmpty
                      ? Center(child: Text("No media found", style: TextStyle(color: AppColors.textMedium)))
                      : Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 16.0),
                          child: MasonryGridView.count(
                            crossAxisCount: ResponsiveLayout.getColumnCount(context), // Responsive columns
                            mainAxisSpacing: 8,
                            crossAxisSpacing: 8,
                            itemCount: _assets.length,
                            itemBuilder: (context, index) {
                              final asset = _assets[index];
                              return _buildMediaItem(asset);
                            },
                          ),
                        ),
            ),
          ],
        ),
      ),
    );
  }

  // 1. Custom Header (Matches your PostDetailScreen style)
  Widget _buildCustomHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 12.0),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          // Close Button
          Container(
            width: 42,
            height: 42,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              color: AppColors.elevation,
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.2),
                  blurRadius: 6,
                  offset: const Offset(0, 2),
                ),
              ],
            ),
            child: IconButton(
              // Standardized to Feather.x
              icon: Icon(Feather.x, color: Colors.white, size: 22),
              onPressed: () => Navigator.pop(context),
            ),
          ),
          
          // Title
          Text(
            "Gallery",
            style: TextStyle(
              color: AppColors.textHigh,
              fontWeight: FontWeight.bold,
              fontSize: 18,
            ),
          ),

          // Invisible spacer to balance the row
          SizedBox(width: 42),
        ],
      ),
    );
  }

  // 2. Filter Pills (Matches your FeedScreen style)
  Widget _buildFilterPills() {
    return Padding(
      padding: const EdgeInsets.only(bottom: 16.0, left: 16.0, right: 16.0),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceEvenly,
        children: [
          _buildPill('All', 0),
          _buildPill('Photos', 1),
          _buildPill('Videos', 2),
        ],
      ),
    );
  }

  Widget _buildPill(String title, int index) {
    final bool isSelected = _selectedFilterIndex == index;
    return GestureDetector(
      onTap: () => _onFilterChanged(index),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        curve: Curves.easeInOut,
        padding: const EdgeInsets.symmetric(horizontal: 24.0, vertical: 10.0),
        decoration: BoxDecoration(
          color: isSelected ? AppColors.secondaryTeal : AppColors.elevation,
          borderRadius: BorderRadius.circular(20),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(isSelected ? 0.3 : 0.1),
              blurRadius: isSelected ? 8 : 4,
              offset: const Offset(0, 3),
            ),
          ],
          border: isSelected 
            ? Border.all(color: AppColors.secondaryTeal, width: 1)
            : Border.all(color: Colors.transparent),
        ),
        child: Text(
          title,
          style: TextStyle(
            fontWeight: isSelected ? FontWeight.bold : FontWeight.w500,
            fontSize: 14.0,
            color: isSelected ? AppColors.textOnSecondary : AppColors.textMedium,
          ),
        ),
      ),
    );
  }

  // 3. Staggered Grid Item
  Widget _buildMediaItem(AssetEntity asset) {
    // Calculate aspect ratio so the grid staggers correctly
    // Default to square 1.0 if dimensions are 0 for some reason
    double aspectRatio = (asset.width > 0 && asset.height > 0) 
        ? asset.width / asset.height 
        : 1.0;

    return GestureDetector(
      onTap: () => _selectAsset(asset),
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.3),
              blurRadius: 4,
              offset: Offset(0, 2),
            )
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(16),
          child: Stack(
            fit: StackFit.passthrough,
            children: [
              // Use AspectRatio to enforce the stagger height
              AspectRatio(
                aspectRatio: aspectRatio,
                child: FutureBuilder<Uint8List?>(
                  future: asset.thumbnailDataWithSize(ThumbnailSize(400, 400)), // Request decent quality thumbnail
                  builder: (context, snapshot) {
                    if (snapshot.connectionState == ConnectionState.done && snapshot.data != null) {
                      return Image.memory(
                        snapshot.data!,
                        fit: BoxFit.cover,
                      );
                    }
                    return Container(
                      color: AppColors.elevation,
                      child: Center(
                        child: CircularProgressIndicator(
                          strokeWidth: 2, 
                          color: AppColors.primaryLavender
                        )
                      ),
                    );
                  },
                ),
              ),
              
              // Video Indicator / Duration
              if (asset.type == AssetType.video)
                Positioned(
                  bottom: 8,
                  right: 8,
                  child: Container(
                    padding: EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.7),
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        // Standardized to Feather.play
                        Icon(Feather.play, color: Colors.white, size: 10),
                        SizedBox(width: 4),
                        Text(
                          _formatDuration(asset.duration),
                          style: TextStyle(
                            color: Colors.white, 
                            fontSize: 10, 
                            fontWeight: FontWeight.bold
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
            ],
          ),
        ),
      ),
    );
  }

  String _formatDuration(int seconds) {
    final duration = Duration(seconds: seconds);
    String twoDigits(int n) => n.toString().padLeft(2, "0");
    String twoDigitSeconds = twoDigits(duration.inSeconds.remainder(60));
    return "${duration.inMinutes}:$twoDigitSeconds";
  }
}


--- C:\Code\femn\lib\services\deep_link_service.dart ---

import 'dart:async';
import 'package:app_links/app_links.dart';
import 'package:flutter/material.dart';
import 'package:femn/hub_screens/post.dart'; // <--- IMPORT THIS

class DeepLinkService {
  static final DeepLinkService _instance = DeepLinkService._internal();
  factory DeepLinkService() => _instance;
  DeepLinkService._internal();

  final AppLinks _appLinks = AppLinks();
  StreamSubscription? _linkSubscription;

  void initDeepLinks(BuildContext context) {
    _appLinks.getInitialLink().then((uri) {
      if (uri != null) _handleLink(uri, context);
    });

    _linkSubscription = _appLinks.uriLinkStream.listen((uri) {
      _handleLink(uri, context);
    });
  }

  void _handleLink(Uri uri, BuildContext context) {
    print("Deep Link Received: $uri");
    
    if (uri.pathSegments.contains('post')) {
      String postId = uri.pathSegments.last;

      // FIX: Use MaterialPageRoute directly
      Navigator.of(context).push(
        MaterialPageRoute(
          builder: (context) => PostDetailScreen(
            postId: postId,
            userId: null, // This is now allowed because of Step 1!
          ),
        ),
      );
    }
  }

  void dispose() {
    _linkSubscription?.cancel();
  }
}


--- C:\Code\femn\lib\services\embers_service.dart ---

// embers_service.dart
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/material.dart';

class EmbersService {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;

  // MAIN REUSABLE FUNCTION - Handles everything in one call
  static Future<EmbersResult> processEmbersTransaction({
    required BuildContext context,
    required int amount,
    required String actionType,
    String? referenceId,
    String? successMessage,
    String? insufficientFundsMessage,
    bool showSnackBar = true,
  }) async {
    try {
      final currentUserId = FirebaseAuth.instance.currentUser!.uid;
      final userRef = FirebaseFirestore.instance.collection('users').doc(currentUserId);
      
      // Check if spending and has sufficient funds
      if (amount < 0) {
        final userDoc = await userRef.get();
        // --- SAFE READ FIX START ---
        final userData = userDoc.data();
        final int currentEmbers = (userData != null && userData.containsKey('embers')) 
            ? userData['embers'] 
            : 0; // Default to 0 if missing
        // --- SAFE READ FIX END ---

        if (currentEmbers < amount.abs()) {
          final message = insufficientFundsMessage ?? 'Insufficient Embers. Need ${amount.abs()} but only have $currentEmbers.';
          if (showSnackBar) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(content: Text(message), backgroundColor: Colors.orange),
            );
          }
          return EmbersResult(success: false, message: message, newBalance: currentEmbers);
        }
      }
      
      // Process the transaction
      await FirebaseFirestore.instance.runTransaction((transaction) async {
        final userDoc = await transaction.get(userRef);
        
        // --- SAFE READ FIX START ---
        final userData = userDoc.data();
        final int currentEmbers = (userData != null && userData.containsKey('embers')) 
            ? userData['embers'] 
            : 0;
        // --- SAFE READ FIX END ---

        final newEmbers = currentEmbers + amount;
        
        transaction.update(userRef, {'embers': newEmbers});
        
        // Record transaction
        await _recordTransaction(
          userId: currentUserId,
          amount: amount,
          actionType: actionType,
          referenceId: referenceId,
          balanceAfter: newEmbers,
        );
      });
      
      // Success message
      final message = successMessage ?? 
        (amount > 0 ? '+$amount Embers!' : '$amount Embers');
      
      if (showSnackBar) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(message),
            backgroundColor: amount > 0 ? Colors.green : Colors.blue,
          ),
        );
      }
      
      return EmbersResult(success: true, message: message, newBalance: await _getCurrentEmbers());
      
    } catch (e) {
      final errorMessage = 'Error processing Embers: $e';
      print(errorMessage); // Log to console
      if (showSnackBar) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("Transaction failed. Please try again."), backgroundColor: Colors.red),
        );
      }
      return EmbersResult(success: false, message: errorMessage, newBalance: 0);
    }
  }

  // SPECIFIC ACTION WRAPPERS
  static Future<EmbersResult> earnForPost(BuildContext context, String postId) {
    return processEmbersTransaction(
      context: context,
      amount: 5,
      actionType: 'post_creation',
      referenceId: postId,
      successMessage: 'Post created! +5 Embers!',
    );
  }

  static Future<EmbersResult> spendForStory(BuildContext context, String storyId) {
    return processEmbersTransaction(
      context: context,
      amount: -2,
      actionType: 'story_creation', 
      referenceId: storyId,
      insufficientFundsMessage: 'Need 2 Embers to create a story',
    );
  }

  // QUICK CHECK FUNCTION
  static Future<bool> hasSufficientEmbers(int requiredAmount) async {
    final currentEmbers = await _getCurrentEmbers();
    return currentEmbers >= requiredAmount;
  }

  // PRIVATE HELPERS
  static Future<int> _getCurrentEmbers() async {
    final currentUserId = FirebaseAuth.instance.currentUser!.uid;
    final userDoc = await FirebaseFirestore.instance.collection('users').doc(currentUserId).get();
    
    // --- SAFE READ FIX ---
    final userData = userDoc.data();
    if (userData != null && userData.containsKey('embers')) {
      return userData['embers'];
    }
    return 0; // Return 0 if field doesn't exist
  }

  static Future<void> _recordTransaction({
    required String userId,
    required int amount,
    required String actionType,
    String? referenceId,
    required int balanceAfter,
  }) async {
    await FirebaseFirestore.instance.collection('embers_transactions').add({
      'userId': userId,
      'amount': amount,
      'actionType': actionType,
      'referenceId': referenceId,
      'balanceAfter': balanceAfter,
      'timestamp': DateTime.now(),
    });
  }
}

// Simple result class
class EmbersResult {
  final bool success;
  final String message;
  final int newBalance;

  EmbersResult({
    required this.success,
    required this.message,
    required this.newBalance,
  });
}


--- C:\Code\femn\lib\services\navigation_service.dart ---

import 'package:flutter/material.dart';

class NavigationService {
  static final GlobalKey<NavigatorState> navigatorKey =
      GlobalKey<NavigatorState>();

  static Future<dynamic> navigateTo(Widget page) {
    return navigatorKey.currentState!.push(
      MaterialPageRoute(builder: (context) => page),
    );
  }

  static void goBack() {
    return navigatorKey.currentState!.pop();
  }
}


--- C:\Code\femn\lib\services\notification_service.dart ---

import 'dart:async';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_messaging/firebase_messaging.dart';

import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'navigation_service.dart';
import '../hub_screens/post.dart';
import '../hub_screens/profile.dart';
import '../circle/petitions.dart';
import '../circle/poll_detail_screen.dart';
import '../hub_screens/messaging.dart';
import '../therapy/screens/therapist_dashboard.dart';

class NotificationService {
  static final NotificationService _instance = NotificationService._internal();

  factory NotificationService() {
    return _instance;
  }

  NotificationService._internal();

  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseMessaging _messaging = FirebaseMessaging.instance;
  final FlutterLocalNotificationsPlugin _localNotifications =
      FlutterLocalNotificationsPlugin();

  bool _isInitialized = false;

  Future<void> initialize() async {
    if (_isInitialized) return;

    // 1. Request Permissions
    await _requestPermissions();

    // 2. Setup Local Notifications
    const AndroidInitializationSettings initializationSettingsAndroid =
        AndroidInitializationSettings('@mipmap/ic_launcher');

    final DarwinInitializationSettings initializationSettingsIOS =
        DarwinInitializationSettings(
          requestSoundPermission: true,
          requestBadgePermission: true,
          requestAlertPermission: true,
        );

    final InitializationSettings initializationSettings =
        InitializationSettings(
          android: initializationSettingsAndroid,
          iOS: initializationSettingsIOS,
        );

    await _localNotifications.initialize(
      initializationSettings,
      onDidReceiveNotificationResponse: (NotificationResponse response) async {
        _handleNotificationPayload(response.payload);
      },
    );

    // 2.1 Handle Cold Start (Notification that launched the app)
    final notificationAppLaunchDetails = await _localNotifications
        .getNotificationAppLaunchDetails();
    if (notificationAppLaunchDetails?.didNotificationLaunchApp ?? false) {
      final payload =
          notificationAppLaunchDetails?.notificationResponse?.payload;
      _handleNotificationPayload(payload);
    }

    // 3. Listen for Auth Changes to start/stop Firestore listener
    _auth.authStateChanges().listen((user) {
      if (user != null) {
        _listenToNotifications(user.uid);
      } else {
        _stopListeningToNotifications();
      }
    });

    _isInitialized = true;
  }

  Future<void> _requestPermissions() async {
    NotificationSettings settings = await _messaging.requestPermission(
      alert: true,
      badge: true,
      sound: true,
    );
    print('User granted permission: ${settings.authorizationStatus}');
  }

  StreamSubscription? _notificationSubscription;
  DateTime _listenerStartTime = DateTime.now();

  void _listenToNotifications(String uid) {
    print("NotificationService: Starting listener for user $uid");
    _stopListeningToNotifications();
    _listenerStartTime = DateTime.now();

    _notificationSubscription = _firestore
        .collection('users')
        .doc(uid)
        .collection('notifications')
        .orderBy('timestamp', descending: true)
        .limit(5) // Look at top few in case they arrive fast
        .snapshots()
        .listen((snapshot) {
          print(
            "NotificationService: Received snapshot with ${snapshot.docs.length} docs and ${snapshot.docChanges.length} changes",
          );
          for (var change in snapshot.docChanges) {
            if (change.type == DocumentChangeType.added) {
              final data = change.doc.data();
              if (data != null) {
                // Ensure it's a new notification and not part of initial fetch
                final timestamp = data['timestamp'];
                print(
                  "NotificationService: New doc added. Timestamp: $timestamp",
                );
                if (timestamp is Timestamp) {
                  // Only show if it happened AFTER the listener started (or very recently)
                  // We add a small buffer for clock drift
                  final tsDate = timestamp.toDate();
                  final isRecent = tsDate.isAfter(
                    _listenerStartTime.subtract(Duration(seconds: 10)),
                  );
                  print(
                    "NotificationService: Is recent? $isRecent (TS: $tsDate, Start: $_listenerStartTime)",
                  );
                  if (isRecent) {
                    print(
                      "NotificationService: Showing local notification: ${data['title']}",
                    );
                    _showLocalNotification(
                      title: data['title'] ?? 'New Notification',
                      body: data['body'] ?? 'You have a new interaction.',
                      payload:
                          "${data['type']}:${data['postId'] ?? data['fromUserId'] ?? data['sessionId'] ?? ''}",
                    );
                  }
                }
              }
            }
          }
        });
  }

  void _stopListeningToNotifications() {
    print("NotificationService: Stopping listener");
    _notificationSubscription?.cancel();
    _notificationSubscription = null;
  }

  Future<void> _showLocalNotification({
    required String title,
    required String body,
    String? payload,
  }) async {
    print("NotificationService: Calling _showLocalNotification");
    const AndroidNotificationDetails androidPlatformChannelSpecifics =
        AndroidNotificationDetails(
          'high_importance_channel', // id
          'High Importance Notifications', // title
          importance: Importance.max,
          priority: Priority.high,
          showWhen: true,
        );
    const NotificationDetails platformChannelSpecifics = NotificationDetails(
      android: androidPlatformChannelSpecifics,
    );

    await _localNotifications.show(
      0,
      title,
      body,
      platformChannelSpecifics,
      payload: payload,
    );
  }

  void _handleNotificationPayload(String? payload) {
    if (payload == null || !payload.contains(':')) return;

    // Small delay to ensure navigator is ready if called early in app lifecycle
    Future.delayed(const Duration(milliseconds: 500), () {
      if (NavigationService.navigatorKey.currentState == null) return;

      final parts = payload.split(':');
      final type = parts[0];
      final id = parts[1];

      if (id.isEmpty) return;

      switch (type) {
        case 'like':
        case 'comment':
          NavigationService.navigateTo(PostDetailScreen(postId: id));
          break;
        case 'follow':
          NavigationService.navigateTo(ProfileScreen(userId: id));
          break;
        case 'poll':
          NavigationService.navigateTo(PollDetailScreen(pollId: id));
          break;
        case 'petition':
        case 'petition_goal':
        case 'petition_update':
          NavigationService.navigateTo(
            EnhancedPetitionDetailScreen(petitionId: id),
          );
          break;
        case 'therapy_booking':
          NavigationService.navigateTo(TherapistDashboard());
          break;
        case 'therapy_accepted':
          // For therapy sessions, navigate to the Messaging screen (HomeScreen index 4 equivalent)
          NavigationService.navigateTo(MessagingScreen());
          break;
      }
    });
  }

  /// Sends a "like" notification to the author of the post.
  /// This writes a document to the author's notifications subcollection.
  Future<void> sendLikeNotification({
    required String authorId,
    required String postId,
    required String likedByUsername,
    required String postTitle,
    String? postMediaUrl, // Added for thumb
  }) async {
    final currentUser = _auth.currentUser;
    if (currentUser == null || currentUser.uid == authorId)
      return; // Don't notify self

    try {
      await _firestore
          .collection('users')
          .doc(authorId)
          .collection('notifications')
          .add({
            'type': 'like',
            'title': likedByUsername,
            'body': 'Liked your post.',
            'postId': postId,
            'fromUserId': currentUser.uid,
            'postMediaUrl': postMediaUrl, // Storing thumb
            'isRead': false,
            'timestamp': FieldValue.serverTimestamp(),
          });
    } catch (e) {
      print("Error sending notification: $e");
    }
  }

  /// Sends a "comment" notification to the author of the post.
  Future<void> sendCommentNotification({
    required String authorId,
    required String postId,
    required String commentedByUsername,
    required String commentText,
    String? postMediaUrl,
  }) async {
    final currentUser = _auth.currentUser;
    if (currentUser == null || currentUser.uid == authorId) return;

    try {
      await _firestore
          .collection('users')
          .doc(authorId)
          .collection('notifications')
          .add({
            'type': 'comment',
            'title': commentedByUsername,
            'body': 'Commented: $commentText',
            'postId': postId,
            'fromUserId': currentUser.uid,
            'postMediaUrl': postMediaUrl,
            'isRead': false,
            'timestamp': FieldValue.serverTimestamp(),
          });
    } catch (e) {
      print("Error sending comment notification: $e");
    }
  }

  /// Sends a "follow" notification to the followed user.
  Future<void> sendFollowNotification({
    required String followedUserId,
    required String followerUsername,
  }) async {
    final currentUser = _auth.currentUser;
    if (currentUser == null || currentUser.uid == followedUserId) return;

    try {
      await _firestore
          .collection('users')
          .doc(followedUserId)
          .collection('notifications')
          .add({
            'type': 'follow',
            'title': followerUsername,
            'body': 'Started following you.',
            'fromUserId': currentUser.uid,
            'isRead': false,
            'timestamp': FieldValue.serverTimestamp(),
          });
    } catch (e) {
      print("Error sending follow notification: $e");
    }
  }

  /// Sends a "comment like" notification to the comment owner.
  Future<void> sendCommentLikeNotification({
    required String commentOwnerId,
    required String postId,
    required String likedByUsername,
    String? postMediaUrl,
  }) async {
    final currentUser = _auth.currentUser;
    if (currentUser == null || currentUser.uid == commentOwnerId) return;

    try {
      await _firestore
          .collection('users')
          .doc(commentOwnerId)
          .collection('notifications')
          .add({
            'type': 'like',
            'title': likedByUsername,
            'body': 'Liked your comment',
            'postId': postId,
            'fromUserId': currentUser.uid,
            'postMediaUrl': postMediaUrl,
            'isRead': false,
            'timestamp': FieldValue.serverTimestamp(),
          });
    } catch (e) {
      print("Error sending comment like notification: $e");
    }
  }

  /// Sends a "reply" notification to the person being replied to.
  Future<void> sendReplyNotification({
    required String targetUserId,
    required String postId,
    required String repliedByUsername,
    required String replyText,
    String? postMediaUrl,
  }) async {
    final currentUser = _auth.currentUser;
    if (currentUser == null || currentUser.uid == targetUserId) return;

    try {
      await _firestore
          .collection('users')
          .doc(targetUserId)
          .collection('notifications')
          .add({
            'type': 'comment',
            'title': repliedByUsername,
            'body': 'Replied: $replyText',
            'postId': postId,
            'fromUserId': currentUser.uid,
            'postMediaUrl': postMediaUrl,
            'isRead': false,
            'timestamp': FieldValue.serverTimestamp(),
          });
    } catch (e) {
      print("Error sending reply notification: $e");
    }
  }

  /// Helper to send notifications to a list of users in parallel
  Future<void> _sendBatchNotifications({
    required List<String> userIds,
    required Map<String, dynamic> notificationData,
  }) async {
    final futures = userIds.map((uid) {
      return _firestore
          .collection('users')
          .doc(uid)
          .collection('notifications')
          .add(notificationData);
    });
    await Future.wait(futures);
  }

  /// Sends a notification to all followers when a user creates a poll.
  Future<void> sendPollCreatedNotification({
    required String creatorId,
    required String creatorUsername,
    required String pollId,
    required String pollQuestion,
    String? imageUrl,
  }) async {
    try {
      final userDoc = await _firestore.collection('users').doc(creatorId).get();
      final followers = List<String>.from(userDoc.data()?['followers'] ?? []);

      if (followers.isEmpty) return;

      final notificationData = {
        'type': 'poll',
        'title': creatorUsername,
        'body': 'Created a new poll: $pollQuestion',
        'postId': pollId,
        'fromUserId': creatorId,
        'postMediaUrl': imageUrl,
        'isRead': false,
        'timestamp': FieldValue.serverTimestamp(),
      };

      await _sendBatchNotifications(
        userIds: followers,
        notificationData: notificationData,
      );
    } catch (e) {
      print("Error sending poll creation notifications: $e");
    }
  }

  /// Sends a notification to all followers when a user creates a petition.
  Future<void> sendPetitionCreatedNotification({
    required String creatorId,
    required String creatorUsername,
    required String petitionId,
    required String petitionTitle,
    String? bannerImageUrl,
  }) async {
    try {
      final userDoc = await _firestore.collection('users').doc(creatorId).get();
      final followers = List<String>.from(userDoc.data()?['followers'] ?? []);

      if (followers.isEmpty) return;

      final notificationData = {
        'type': 'petition',
        'title': creatorUsername,
        'body': 'Started a new petition: $petitionTitle',
        'postId': petitionId,
        'fromUserId': creatorId,
        'postMediaUrl': bannerImageUrl,
        'isRead': false,
        'timestamp': FieldValue.serverTimestamp(),
      };

      await _sendBatchNotifications(
        userIds: followers,
        notificationData: notificationData,
      );
    } catch (e) {
      print("Error sending petition creation notifications: $e");
    }
  }

  /// Sends a notification to all signers when a petition reaches its goal.
  Future<void> sendPetitionGoalReachedNotification({
    required String petitionId,
    required String petitionTitle,
    required List<String> signerIds,
    String? bannerImageUrl,
  }) async {
    if (signerIds.isEmpty) return;

    try {
      final notificationData = {
        'type': 'petition_goal',
        'title': 'Victory!',
        'body': 'The petition "$petitionTitle" has reached its goal!',
        'postId': petitionId,
        'postMediaUrl': bannerImageUrl,
        'isRead': false,
        'timestamp': FieldValue.serverTimestamp(),
      };

      await _sendBatchNotifications(
        userIds: signerIds,
        notificationData: notificationData,
      );
    } catch (e) {
      print("Error sending petition goal reached notifications: $e");
    }
  }

  /// Sends a notification to all signers when a petition gets an update.
  Future<void> sendPetitionUpdateNotification({
    required String petitionId,
    required String petitionTitle,
    required String updateTitle,
    required List<String> signerIds,
    String? bannerImageUrl,
  }) async {
    if (signerIds.isEmpty) return;

    try {
      final notificationData = {
        'type': 'petition_update',
        'title': 'Petition Update',
        'body': 'New update for "$petitionTitle": $updateTitle',
        'postId': petitionId,
        'postMediaUrl': bannerImageUrl,
        'isRead': false,
        'timestamp': FieldValue.serverTimestamp(),
      };

      await _sendBatchNotifications(
        userIds: signerIds,
        notificationData: notificationData,
      );
    } catch (e) {
      print("Error sending petition update notifications: $e");
    }
  }
}


--- C:\Code\femn\lib\services\streak_service.dart ---

import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';

class StreakService {
  static final FirebaseFirestore _db = FirebaseFirestore.instance;
  static final FirebaseAuth _auth = FirebaseAuth.instance;

  static DocumentReference get _userRef => 
      _db.collection('users').doc(_auth.currentUser!.uid);

  // --- 1. Update Streak (Called when saving a Journal Entry) ---
  static Future<void> updateStreakOnEntry() async {
    final uid = _auth.currentUser?.uid;
    if (uid == null) return;

    final doc = await _userRef.get();
    final data = doc.data() as Map<String, dynamic>? ?? {};

    final int currentStreak = data['streakCount'] ?? 0;
    final Timestamp? lastLogTs = data['lastStreakDate'];
    
    final DateTime now = DateTime.now();
    final DateTime today = DateTime(now.year, now.month, now.day);

    if (lastLogTs == null) {
      // First ever entry
      await _userRef.update({
        'streakCount': 1,
        'lastStreakDate': Timestamp.fromDate(now),
        'streakActive': true,
      });
      return;
    }

    final DateTime lastLogDate = lastLogTs.toDate();
    final DateTime lastLogDay = DateTime(lastLogDate.year, lastLogDate.month, lastLogDate.day);

    if (today.difference(lastLogDay).inDays == 0) {
      // Already logged today, do nothing
      return;
    } else if (today.difference(lastLogDay).inDays == 1) {
      // Consecutive day
      await _userRef.update({
        'streakCount': currentStreak + 1,
        'lastStreakDate': Timestamp.fromDate(now),
        'streakActive': true,
      });
    } else {
      // Streak broken (missed more than 1 day)
      // We don't reset to 1 immediately here logic-wise if we want to allow restoration,
      // but usually, if they log today after missing yesterday, the previous streak is considered "lost".
      // However, for the visual "Flame Out", we handle that in the UI fetch.
      // If they are logging now, they are starting a NEW streak of 1.
      
      // Save the old streak info in case they want to restore later (if logic permits),
      // but generally, logging a new entry confirms the new streak.
      await _userRef.update({
        'streakCount': 1, // Reset to 1 because they logged today
        'lastStreakDate': Timestamp.fromDate(now),
        'streakLostDate': lastLogTs, // Save when they lost it
        'streakActive': true,
      });
    }
  }

  // --- 2. Check Streak Status (For UI Display) ---
  // Returns a Map with status for the UI
  static Future<Map<String, dynamic>> getStreakStatus() async {
    final uid = _auth.currentUser?.uid;
    if (uid == null) return {};

    final doc = await _userRef.get();
    if (!doc.exists) return {'count': 0, 'active': false};

    final data = doc.data() as Map<String, dynamic>;
    final int count = data['streakCount'] ?? 0;
    final Timestamp? lastLogTs = data['lastStreakDate'];
    
    if (lastLogTs == null) return {'count': 0, 'active': false};

    final DateTime now = DateTime.now();
    final DateTime today = DateTime(now.year, now.month, now.day);
    final DateTime lastLog = lastLogTs.toDate();
    final DateTime lastLogDay = DateTime(lastLog.year, lastLog.month, lastLog.day);

    final int diff = today.difference(lastLogDay).inDays;

    if (diff <= 1) {
      // Logged today or yesterday (streak is safe)
      return {'count': count, 'active': true};
    } else {
      // Missed a day
      return {'count': count, 'active': false, 'lostDate': lastLogTs};
    }
  }

  // --- 3. Restore Streak Logic ---
  static Future<String> tryRestoreStreak() async {
    final uid = _auth.currentUser?.uid;
    if (uid == null) return "User not found";

    final doc = await _userRef.get();
    final data = doc.data() as Map<String, dynamic>;

    final Timestamp? lastLogTs = data['lastStreakDate'];
    if (lastLogTs == null) return "No streak to restore";

    final DateTime now = DateTime.now();
    final DateTime lastLog = lastLogTs.toDate();
    
    // Check 1: Is it within 2 days?
    // If last log was Jan 1, and today is Jan 4 (diff is 3), it's too late. 
    // Allowed: Jan 3 (diff 2).
    final int daysMissed = now.difference(lastLog).inDays;
    
    if (daysMissed > 2) {
      // Too late, reset permanently
      await _userRef.update({'streakCount': 0});
      return "Too late to restore (limit 48hrs)";
    }

    // Check 2: Restoration Counts
    final int restorationsUsed = data['restorationsUsed'] ?? 0;
    final Timestamp? lastRestorationTs = data['lastRestorationDate'];
    
    // Check if month changed since last restoration
    int currentRestorations = restorationsUsed;
    if (lastRestorationTs != null) {
      final lastResDate = lastRestorationTs.toDate();
      if (lastResDate.month != now.month || lastResDate.year != now.year) {
        currentRestorations = 0; // New month, reset count
      }
    }

    if (currentRestorations >= 3) {
      return "Monthly restoration limit reached (3/3)";
    }

    // Perform Restoration
    // We update the lastStreakDate to "Yesterday" so the streak continues seamlessly
    final DateTime yesterday = now.subtract(Duration(days: 1));
    
    await _userRef.update({
      'lastStreakDate': Timestamp.fromDate(yesterday), // Pretend they logged yesterday
      'streakActive': true,
      'restorationsUsed': currentRestorations + 1,
      'lastRestorationDate': Timestamp.fromDate(now),
    });

    return "Success";
  }
}


--- C:\Code\femn\lib\therapy\models\therapy_models.dart ---

import 'package:cloud_firestore/cloud_firestore.dart';

enum SessionType { oneDay, multiDay }
enum SessionStatus { pending, active, completed, cancelled }

class TherapySession {
  final String id;
  final String therapistId;
  final String clientId;
  final SessionType type;
  final SessionStatus status;
  final DateTime startTime;
  final DateTime? endTime;
  final List<TimelineItem> timeline;
  final String problemDescription;

  TherapySession({
    required this.id,
    required this.therapistId,
    required this.clientId,
    required this.type,
    required this.status,
    required this.startTime,
    this.endTime,
    this.timeline = const [],
    this.problemDescription = '',
  });

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'therapistId': therapistId,
      'clientId': clientId,
      'type': type.index,
      'status': status.index,
      'startTime': startTime,
      'endTime': endTime,
      'timeline': timeline.map((x) => x.toMap()).toList(),
      'problemDescription': problemDescription,
    };
  }

  factory TherapySession.fromMap(Map<String, dynamic> map, String id) {
    return TherapySession(
      id: id,
      therapistId: map['therapistId'] ?? '',
      clientId: map['clientId'] ?? '',
      type: SessionType.values[map['type'] ?? 0],
      status: SessionStatus.values[map['status'] ?? 0],
      startTime: (map['startTime'] as Timestamp).toDate(),
      endTime: (map['endTime'] as Timestamp?)?.toDate(),
      timeline: List<TimelineItem>.from(
        (map['timeline'] as List? ?? []).map((x) => TimelineItem.fromMap(x)),
      ),
      problemDescription: map['problemDescription'] ?? '',
    );
  }
}

class TimelineItem {
  final String title;
  final String description;
  final DateTime timestamp;
  final bool isCompleted;

  TimelineItem({
    required this.title,
    required this.description,
    required this.timestamp,
    this.isCompleted = false,
  });

  Map<String, dynamic> toMap() {
    return {
      'title': title,
      'description': description,
      'timestamp': timestamp,
      'isCompleted': isCompleted,
    };
  }

  factory TimelineItem.fromMap(Map<String, dynamic> map) {
    return TimelineItem(
      title: map['title'] ?? '',
      description: map['description'] ?? '',
      timestamp: (map['timestamp'] as Timestamp).toDate(),
      isCompleted: map['isCompleted'] ?? false,
    );
  }
}

class TherapistReview {
  final String id;
  final String therapistId;
  final String reviewerId;
  final double rating;
  final String comment;
  final DateTime timestamp;

  TherapistReview({
    required this.id,
    required this.therapistId,
    required this.reviewerId,
    required this.rating,
    required this.comment,
    required this.timestamp,
  });

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'therapistId': therapistId,
      'reviewerId': reviewerId,
      'rating': rating,
      'comment': comment,
      'timestamp': timestamp,
    };
  }
}

class TherapistReport {
  final String id;
  final String therapistId;
  final String reporterId;
  final String reason;
  final DateTime timestamp;

  TherapistReport({
    required this.id,
    required this.therapistId,
    required this.reporterId,
    required this.reason,
    required this.timestamp,
  });

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'therapistId': therapistId,
      'reporterId': reporterId,
      'reason': reason,
      'timestamp': timestamp,
    };
  }
}


--- C:\Code\femn\lib\therapy\screens\therapist_dashboard.dart ---

import 'package:flutter/material.dart';
import 'package:femn/customization/colors.dart';
import 'package:femn/widgets/femn_background.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cached_network_image/cached_network_image.dart';
import '../services/therapy_service.dart';
import '../models/therapy_models.dart';

class TherapistDashboard extends StatefulWidget {
  @override
  _TherapistDashboardState createState() => _TherapistDashboardState();
}

class _TherapistDashboardState extends State<TherapistDashboard> {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final TherapyService _therapyService = TherapyService();

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      body: FemnBackground(
        child: Column(
          children: [
            // Header
            Padding(
              padding: const EdgeInsets.only(
                top: 60.0,
                left: 24,
                right: 24,
                bottom: 20,
              ),
              child: Row(
                children: [
                  GestureDetector(
                    onTap: () => Navigator.pop(context),
                    child: Container(
                      width: 42,
                      height: 42,
                      decoration: BoxDecoration(
                        color: AppColors.elevation,
                        shape: BoxShape.circle,
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withOpacity(0.1),
                            blurRadius: 8,
                            offset: Offset(0, 2),
                          ),
                        ],
                      ),
                      child: Icon(
                        Feather.arrow_left,
                        color: AppColors.textHigh,
                        size: 20,
                      ),
                    ),
                  ),
                  SizedBox(width: 16),
                  Text(
                    'Client Dashboard',
                    style: TextStyle(
                      color: AppColors.textHigh,
                      fontSize: 22,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ],
              ),
            ),

            Expanded(
              child: StreamBuilder<QuerySnapshot>(
                stream: FirebaseFirestore.instance
                    .collection('therapy_sessions')
                    .where('therapistId', isEqualTo: _auth.currentUser!.uid)
                    .where('status', isEqualTo: SessionStatus.pending.index)
                    .orderBy('startTime', descending: true)
                    .snapshots(),
                builder: (context, snapshot) {
                  if (snapshot.connectionState == ConnectionState.waiting) {
                    return Center(
                      child: CircularProgressIndicator(
                        color: AppColors.primaryLavender,
                      ),
                    );
                  }

                  if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
                    return _buildEmptyState();
                  }

                  return ListView.builder(
                    padding: EdgeInsets.symmetric(horizontal: 24),
                    itemCount: snapshot.data!.docs.length,
                    itemBuilder: (context, index) {
                      final doc = snapshot.data!.docs[index];
                      final data = doc.data() as Map<String, dynamic>;
                      final session = TherapySession.fromMap(data, doc.id);

                      return _buildRequestCard(session);
                    },
                  );
                },
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Feather.users, size: 64, color: AppColors.textDisabled),
          SizedBox(height: 16),
          Text(
            "No pending requests",
            style: TextStyle(
              color: AppColors.textMedium,
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          SizedBox(height: 8),
          Text(
            "New client requests will appear here.",
            style: TextStyle(color: AppColors.textDisabled),
          ),
        ],
      ),
    );
  }

  Widget _buildRequestCard(TherapySession session) {
    return FutureBuilder<DocumentSnapshot>(
      future: FirebaseFirestore.instance
          .collection('users')
          .doc(session.clientId)
          .get(),
      builder: (context, snapshot) {
        if (!snapshot.hasData) return SizedBox.shrink();

        final userData = snapshot.data!.data() as Map<String, dynamic>;

        return Container(
          margin: EdgeInsets.only(bottom: 16),
          padding: EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: AppColors.surface,
            borderRadius: BorderRadius.circular(20),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.1),
                blurRadius: 8,
                offset: Offset(0, 4),
              ),
            ],
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  CircleAvatar(
                    radius: 24,
                    backgroundImage:
                        (userData['profileImage'] != null &&
                            userData['profileImage'].isNotEmpty)
                        ? CachedNetworkImageProvider(userData['profileImage'])
                        : AssetImage('assets/default_avatar.png')
                              as ImageProvider,
                  ),
                  SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          userData['fullName'] ??
                              userData['username'] ??
                              'Client',
                          style: TextStyle(
                            color: AppColors.textHigh,
                            fontWeight: FontWeight.bold,
                            fontSize: 16,
                          ),
                        ),
                        Text(
                          "Requested just now", // Ideally use timeago
                          style: TextStyle(
                            color: AppColors.textMedium,
                            fontSize: 12,
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
              SizedBox(height: 12),
              if (session.problemDescription.isNotEmpty) ...[
                Text(
                  "Note:",
                  style: TextStyle(
                    color: AppColors.primaryLavender,
                    fontSize: 12,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                SizedBox(height: 4),
                Text(
                  session.problemDescription,
                  style: TextStyle(
                    color: AppColors.textHigh,
                    fontSize: 14,
                    fontStyle: FontStyle.italic,
                  ),
                ),
                SizedBox(height: 16),
              ],
              Row(
                children: [
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () {
                        // Reject logic could go here
                      },
                      style: OutlinedButton.styleFrom(
                        side: BorderSide(color: AppColors.error),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      child: Text(
                        "Decline",
                        style: TextStyle(color: AppColors.error),
                      ),
                    ),
                  ),
                  SizedBox(width: 12),
                  Expanded(
                    child: ElevatedButton(
                      onPressed: () async {
                        await _therapyService.acceptSession(session.id);
                        ScaffoldMessenger.of(context).showSnackBar(
                          SnackBar(
                            content: Text("Client accepted! Chat created."),
                            backgroundColor: AppColors.secondaryTeal,
                          ),
                        );
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.secondaryTeal,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      child: Text(
                        "Accept",
                        style: TextStyle(color: Colors.white),
                      ),
                    ),
                  ),
                ],
              ),
            ],
          ),
        );
      },
    );
  }
}


--- C:\Code\femn\lib\therapy\screens\therapy_discovery_screen.dart ---

import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:femn/customization/colors.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:femn/widgets/femn_background.dart';
import '../services/therapy_service.dart';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../models/therapy_models.dart';

class TherapyDiscoveryScreen extends StatefulWidget {
  @override
  _TherapyDiscoveryScreenState createState() => _TherapyDiscoveryScreenState();
}

class _TherapyDiscoveryScreenState extends State<TherapyDiscoveryScreen> {
  final TextEditingController _searchController = TextEditingController();
  final TherapyService _therapyService = TherapyService();

  String _selectedCategory = 'All';
  List<String> _selectedSpecializations = [];
  bool _showAdvancedFilters = false;

  final List<String> _categories = [
    'All',
    'Anxiety',
    'Depression',
    'Trauma',
    'Relationships',
    'Stress',
    'Grief',
    'Addiction',
    'Self-esteem',
  ];

  final List<String> _specializationOptions = [
    'CBT',
    'EMDR',
    'Family Therapy',
    'Couples Counseling',
    'Art Therapy',
    'Trauma-Informed',
    'LGBTQ+ Affirming',
    'Mindfulness',
  ];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      body: FemnBackground(
        child: Column(
          children: [
            // Custom Header
            Padding(
              padding: const EdgeInsets.only(
                top: 60.0,
                left: 24,
                right: 24,
                bottom: 20,
              ),
              child: Row(
                children: [
                  GestureDetector(
                    onTap: () => Navigator.pop(context),
                    child: Container(
                      width: 42,
                      height: 42,
                      decoration: BoxDecoration(
                        color: AppColors.elevation,
                        shape: BoxShape.circle,
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withOpacity(0.1),
                            blurRadius: 8,
                            offset: Offset(0, 2),
                          ),
                        ],
                      ),
                      child: Icon(
                        Feather.arrow_left,
                        color: AppColors.textHigh,
                        size: 20,
                      ),
                    ),
                  ),
                  SizedBox(width: 16),
                  Text(
                    'Therapy',
                    style: TextStyle(
                      color: AppColors.textHigh,
                      fontSize: 22,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  Spacer(),
                  GestureDetector(
                    onTap: () => _showPendingRequests(context),
                    child: Container(
                      width: 42,
                      height: 42,
                      decoration: BoxDecoration(
                        color: AppColors.elevation,
                        shape: BoxShape.circle,
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withOpacity(0.1),
                            blurRadius: 8,
                            offset: Offset(0, 2),
                          ),
                        ],
                      ),
                      child: Icon(
                        Feather.clock,
                        color: AppColors.primaryLavender,
                        size: 20,
                      ),
                    ),
                  ),
                ],
              ),
            ),

            // Search Bar
            Padding(
              padding: const EdgeInsets.symmetric(
                horizontal: 24.0,
                vertical: 8,
              ),
              child: Container(
                padding: const EdgeInsets.symmetric(horizontal: 16),
                decoration: BoxDecoration(
                  color: AppColors.elevation,
                  borderRadius: BorderRadius.circular(16),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.2),
                      blurRadius: 6,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: TextField(
                  controller: _searchController,
                  style: TextStyle(color: AppColors.textHigh),
                  decoration: InputDecoration(
                    hintText: 'Search therapists...',
                    hintStyle: TextStyle(color: AppColors.textDisabled),
                    border: InputBorder.none,
                    icon: Icon(
                      Feather.search,
                      color: AppColors.primaryLavender,
                    ),
                  ),
                  onChanged: (val) => setState(() {}),
                ),
              ),
            ),

            // Horizontal Category Filter (Circles Style)
            Container(
              height: 60,
              padding: EdgeInsets.symmetric(vertical: 8),
              child: ListView.builder(
                scrollDirection: Axis.horizontal,
                padding: EdgeInsets.symmetric(horizontal: 20),
                itemCount: _categories.length,
                itemBuilder: (context, index) {
                  final category = _categories[index];
                  final isSelected = _selectedCategory == category;
                  return GestureDetector(
                    onTap: () => setState(() {
                      _selectedCategory = category;
                      // When clicking a main category, we might want to clear specific specializations or keep them?
                      // Keeping them allows for "Anxiety" + "CBT".
                    }),
                    child: AnimatedContainer(
                      duration: Duration(milliseconds: 200),
                      margin: EdgeInsets.only(right: 12),
                      padding: EdgeInsets.symmetric(
                        horizontal: 20,
                        vertical: 8,
                      ),
                      decoration: BoxDecoration(
                        color: isSelected
                            ? AppColors.secondaryTeal
                            : AppColors.elevation,
                        borderRadius: BorderRadius.circular(24),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withOpacity(
                              isSelected ? 0.3 : 0.1,
                            ),
                            blurRadius: isSelected ? 6 : 4,
                            offset: Offset(0, 2),
                          ),
                        ],
                      ),
                      child: Center(
                        child: Text(
                          category,
                          style: TextStyle(
                            color: isSelected
                                ? Colors.white
                                : AppColors.textMedium,
                            fontWeight: isSelected
                                ? FontWeight.bold
                                : FontWeight.w500,
                            fontSize: 14,
                          ),
                        ),
                      ),
                    ),
                  );
                },
              ),
            ),

            // "I specialise in" Filter (Multi-select)
            Padding(
              padding: const EdgeInsets.symmetric(
                horizontal: 24.0,
                vertical: 8,
              ),
              child: GestureDetector(
                onTap: () => setState(
                  () => _showAdvancedFilters = !_showAdvancedFilters,
                ),
                child: Row(
                  children: [
                    Text(
                      "Filter by Specialization",
                      style: TextStyle(
                        color: AppColors.primaryLavender,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    Icon(
                      _showAdvancedFilters
                          ? Feather.chevron_up
                          : Feather.chevron_down,
                      color: AppColors.primaryLavender,
                    ),
                  ],
                ),
              ),
            ),

            if (_showAdvancedFilters)
              Padding(
                padding: const EdgeInsets.symmetric(
                  horizontal: 24.0,
                  vertical: 8,
                ),
                child: Container(
                  width: double.infinity,
                  decoration: BoxDecoration(
                    color: AppColors.elevation,
                    borderRadius: BorderRadius.circular(24),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.1),
                        blurRadius: 6,
                        offset: Offset(0, 2),
                      ),
                    ],
                  ),
                  padding: EdgeInsets.all(20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        "I specialise in",
                        style: TextStyle(
                          color: AppColors.primaryLavender,
                          fontWeight: FontWeight.w600,
                          fontSize: 16,
                        ),
                      ),
                      SizedBox(height: 10),
                      Wrap(
                        spacing: 10,
                        runSpacing: 10,
                        children: _specializationOptions.map((option) {
                          final isSelected = _selectedSpecializations.contains(
                            option,
                          );
                          return FilterChip(
                            label: Text(
                              option,
                              style: TextStyle(
                                color: isSelected
                                    ? Colors.white
                                    : AppColors.textMedium,
                              ),
                            ),
                            selected: isSelected,
                            onSelected: (v) {
                              setState(() {
                                if (v)
                                  _selectedSpecializations.add(option);
                                else
                                  _selectedSpecializations.remove(option);
                              });
                            },
                            selectedColor: AppColors.secondaryTeal,
                            backgroundColor: AppColors.backgroundDeep,
                            checkmarkColor: Colors.white,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(20),
                              side: BorderSide(
                                color: isSelected
                                    ? AppColors.secondaryTeal
                                    : AppColors.textDisabled,
                              ),
                            ),
                          );
                        }).toList(),
                      ),
                    ],
                  ),
                ),
              ),

            // Therapists List
            Expanded(
              child: StreamBuilder<QuerySnapshot>(
                stream: _therapyService.getTherapists(
                  situation: _selectedCategory == 'All'
                      ? null
                      : _selectedCategory,
                  // We can't easily filter strictly by multiple specializations in Firestore query without composite indexes or client side filtering.
                  // For now, we will filter client-side for the multi-select.
                ),
                builder: (context, snapshot) {
                  if (snapshot.connectionState == ConnectionState.waiting) {
                    return Center(
                      child: CircularProgressIndicator(
                        color: AppColors.primaryLavender,
                      ),
                    );
                  }
                  if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
                    return Center(
                      child: Text(
                        "No therapists found.",
                        style: TextStyle(color: AppColors.textMedium),
                      ),
                    );
                  }

                  // Client-side filtering for search text and multi-select specializations
                  var therapists = snapshot.data!.docs.where((doc) {
                    final data = doc.data() as Map<String, dynamic>;
                    final name = (data['fullName'] ?? '')
                        .toString()
                        .toLowerCase();
                    final search = _searchController.text.toLowerCase();

                    // Search Filter
                    if (search.isNotEmpty && !name.contains(search))
                      return false;

                    // Specialization Filter (Match ANY or ALL? Usually ANY for filters, or ALL for strict. Let's do partial match overlap)
                    if (_selectedSpecializations.isNotEmpty) {
                      final specs = List<String>.from(
                        data['specialization'] ?? [],
                      );
                      // Check if therapist has any of the selected specializations? Or all?
                      // "I specialise in" X, Y usually means I want someone who knows X OR Y.
                      // But maybe user wants someone who knows X AND Y.
                      // Let's go with ANY for now as it's more permissive.
                      if (!specs.any(
                        (s) => _selectedSpecializations.contains(s),
                      ))
                        return false;
                    }

                    return true;
                  }).toList();

                  if (therapists.isEmpty) {
                    return Center(
                      child: Text(
                        "No matching therapists.",
                        style: TextStyle(color: AppColors.textMedium),
                      ),
                    );
                  }

                  return ListView.builder(
                    padding: EdgeInsets.all(16),
                    itemCount: therapists.length,
                    itemBuilder: (context, index) {
                      final therapistData =
                          therapists[index].data() as Map<String, dynamic>;
                      return _buildTherapistCard(
                        therapistData,
                        therapists[index].id,
                      );
                    },
                  );
                },
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildTherapistCard(Map<String, dynamic> data, String id) {
    return Container(
      margin: EdgeInsets.only(bottom: 16),
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surface,
        borderRadius: BorderRadius.circular(20),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 8,
            offset: Offset(0, 4),
          ),
        ],
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Avatar
          Container(
            width: 70,
            height: 70,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              image: DecorationImage(
                image:
                    (data['profileImage'] != null &&
                        data['profileImage'].isNotEmpty)
                    ? CachedNetworkImageProvider(data['profileImage'])
                    : AssetImage('assets/default_avatar.png') as ImageProvider,
                fit: BoxFit.cover,
              ),
            ),
          ),
          SizedBox(width: 16),
          // Info
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  data['fullName'] ?? 'Therapist',
                  style: TextStyle(
                    color: AppColors.textHigh,
                    fontWeight: FontWeight.bold,
                    fontSize: 18,
                  ),
                ),
                SizedBox(height: 4),
                Text(
                  (data['specialization'] as List<dynamic>? ?? []).join(', '),
                  style: TextStyle(
                    color: AppColors.primaryLavender,
                    fontSize: 12,
                    fontWeight: FontWeight.w500,
                  ),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),
                SizedBox(height: 8),
                Row(
                  children: [
                    Icon(
                      Feather.star,
                      color: AppColors.accentMustard,
                      size: 14,
                    ),
                    SizedBox(width: 4),
                    Text(
                      (data['averageRating'] ?? 0.0).toStringAsFixed(1),
                      style: TextStyle(
                        color: AppColors.textHigh,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    SizedBox(width: 4),
                    Text(
                      '(${data['totalRatings'] ?? 0})',
                      style: TextStyle(
                        color: AppColors.textMedium,
                        fontSize: 12,
                      ),
                    ),
                    Spacer(),
                    GestureDetector(
                      onTap: () => _showTherapistDetails(context, data, id),
                      child: Container(
                        padding: EdgeInsets.symmetric(
                          horizontal: 12,
                          vertical: 6,
                        ),
                        decoration: BoxDecoration(
                          color: AppColors.secondaryTeal.withOpacity(0.2),
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: Text(
                          "Book",
                          style: TextStyle(
                            color: AppColors.secondaryTeal,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  void _showTherapistDetails(
    BuildContext context,
    Map<String, dynamic> data,
    String therapistId,
  ) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) {
        return DraggableScrollableSheet(
          initialChildSize: 0.7,
          minChildSize: 0.5,
          maxChildSize: 0.9,
          builder: (context, scrollController) {
            return Container(
              decoration: BoxDecoration(
                color: AppColors.backgroundDeep,
                borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
              ),
              padding: EdgeInsets.all(24),
              child: SingleChildScrollView(
                controller: scrollController,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Center(
                      child: Container(
                        width: 40,
                        height: 4,
                        decoration: BoxDecoration(
                          color: AppColors.textDisabled,
                          borderRadius: BorderRadius.circular(2),
                        ),
                      ),
                    ),
                    SizedBox(height: 24),
                    Center(
                      child: Container(
                        width: 100,
                        height: 100,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          image: DecorationImage(
                            image:
                                (data['profileImage'] != null &&
                                    data['profileImage'].isNotEmpty)
                                ? CachedNetworkImageProvider(
                                    data['profileImage'],
                                  )
                                : AssetImage('assets/default_avatar.png')
                                      as ImageProvider,
                            fit: BoxFit.cover,
                          ),
                        ),
                      ),
                    ),
                    SizedBox(height: 16),
                    Center(
                      child: Text(
                        data['fullName'] ?? 'Therapist',
                        style: TextStyle(
                          color: AppColors.textHigh,
                          fontSize: 24,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                    SizedBox(height: 8),
                    Center(
                      child: Text(
                        (data['specialization'] as List<dynamic>? ?? []).join(
                          ', ',
                        ),
                        style: TextStyle(
                          color: AppColors.primaryLavender,
                          fontSize: 14,
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ),
                    SizedBox(height: 24),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceAround,
                      children: [
                        _buildStatItem(
                          Feather.star,
                          (data['averageRating'] ?? 0.0).toStringAsFixed(1),
                          "Rating",
                        ),
                        _buildStatItem(
                          Feather.users,
                          '${data['totalClients'] ?? 0}',
                          "Clients",
                        ),
                        _buildStatItem(
                          Feather.file_text,
                          '${data['reportCount'] ?? 0}', // Maybe reports isn't something to brag about?
                          // The prompt said "report number" - assuming this means something positive or just transparency?
                          // Could also mean session reports? Let's stick to what's in data.
                          "Reports",
                        ),
                      ],
                    ),
                    SizedBox(height: 24),
                    Text(
                      "About",
                      style: TextStyle(
                        color: AppColors.textHigh,
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    SizedBox(height: 8),
                    Text(
                      (data['bio'] is List)
                          ? (data['bio'] as List).join('\n')
                          : (data['bio']?.toString() ??
                                "No bio available. This therapist helps with various mental health challenges."),
                      style: TextStyle(
                        color: AppColors.textMedium,
                        fontSize: 14,
                        height: 1.5,
                      ),
                    ),
                    SizedBox(height: 24),
                    Text(
                      "Availability",
                      style: TextStyle(
                        color: AppColors.textHigh,
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    SizedBox(height: 8),
                    // Just a placeholder or data['availability'] if exists
                    Text(
                      (data['availability'] is List)
                          ? (data['availability'] as List).join(', ')
                          : (data['availability']?.toString() ??
                                "Mon - Fri, 9:00 AM - 5:00 PM"),
                      style: TextStyle(
                        color: AppColors.textMedium,
                        fontSize: 14,
                      ),
                    ),
                    SizedBox(height: 40),
                    SizedBox(
                      width: double.infinity,
                      height: 56,
                      child: ElevatedButton(
                        onPressed: () {
                          Navigator.pop(context);
                          _showBookingDialog(context, therapistId);
                        },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: AppColors.primaryLavender,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(16),
                          ),
                        ),
                        child: Text(
                          "Book Journey",
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    ),
                    SizedBox(height: 20),
                  ],
                ),
              ),
            );
          },
        );
      },
    );
  }

  Widget _buildStatItem(IconData icon, String value, String label) {
    return Column(
      children: [
        Icon(icon, color: AppColors.primaryLavender, size: 24),
        SizedBox(height: 8),
        Text(
          value,
          style: TextStyle(
            color: AppColors.textHigh,
            fontWeight: FontWeight.bold,
            fontSize: 16,
          ),
        ),
        SizedBox(height: 4),
        Text(
          label,
          style: TextStyle(color: AppColors.textMedium, fontSize: 12),
        ),
      ],
    );
  }

  void _showBookingDialog(BuildContext context, String therapistId) {
    final TextEditingController _problemController = TextEditingController();
    bool _isLoading = false;

    showDialog(
      context: context,
      builder: (context) {
        return StatefulBuilder(
          builder: (context, setState) {
            return AlertDialog(
              backgroundColor: AppColors.surface,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(24),
              ),
              title: Text(
                "Describe your situation",
                style: TextStyle(color: AppColors.textHigh),
              ),
              content: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Text(
                    "This helps the therapist understand your needs before accepting the request.",
                    style: TextStyle(color: AppColors.textMedium, fontSize: 12),
                  ),
                  SizedBox(height: 16),
                  TextField(
                    controller: _problemController,
                    maxLines: 4,
                    style: TextStyle(color: AppColors.textHigh),
                    decoration: InputDecoration(
                      hintText: "I'm feeling...",
                      hintStyle: TextStyle(color: AppColors.textDisabled),
                      filled: true,
                      fillColor: AppColors.backgroundDeep,
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                        borderSide: BorderSide.none,
                      ),
                    ),
                  ),
                ],
              ),
              actions: [
                TextButton(
                  onPressed: () => Navigator.pop(context),
                  child: Text(
                    "Cancel",
                    style: TextStyle(color: AppColors.textMedium),
                  ),
                ),
                ElevatedButton(
                  onPressed: _isLoading
                      ? null
                      : () async {
                          if (_problemController.text.isEmpty) return;

                          setState(() => _isLoading = true);
                          final error = await _therapyService.bookTherapist(
                            therapistId,
                            SessionType.oneDay, // Defaulting for now
                            _problemController.text,
                          );

                          setState(() => _isLoading = false);
                          Navigator.pop(context); // Close dialog

                          if (error == null) {
                            ScaffoldMessenger.of(context).showSnackBar(
                              SnackBar(
                                content: Text("Request sent successfully!"),
                                backgroundColor: AppColors.secondaryTeal,
                              ),
                            );
                          } else {
                            ScaffoldMessenger.of(context).showSnackBar(
                              SnackBar(
                                content: Text(error),
                                backgroundColor: AppColors.error,
                              ),
                            );
                          }
                        },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.primaryLavender,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                  ),
                  child: _isLoading
                      ? SizedBox(
                          width: 20,
                          height: 20,
                          child: CircularProgressIndicator(
                            color: Colors.white,
                            strokeWidth: 2,
                          ),
                        )
                      : Text(
                          "Send Request",
                          style: TextStyle(color: Colors.white),
                        ),
                ),
              ],
            );
          },
        );
      },
    );
  }

  void _showPendingRequests(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) {
        return DraggableScrollableSheet(
          initialChildSize: 0.5,
          minChildSize: 0.3,
          maxChildSize: 0.8,
          builder: (context, scrollController) {
            return Container(
              decoration: BoxDecoration(
                color: AppColors.backgroundDeep,
                borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
              ),
              padding: EdgeInsets.all(24),
              child: Column(
                children: [
                  Container(
                    width: 40,
                    height: 4,
                    decoration: BoxDecoration(
                      color: AppColors.textDisabled,
                      borderRadius: BorderRadius.circular(2),
                    ),
                  ),
                  SizedBox(height: 16),
                  Text(
                    "Pending Requests",
                    style: TextStyle(
                      color: AppColors.textHigh,
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  SizedBox(height: 16),
                  Expanded(
                    child: StreamBuilder<QuerySnapshot>(
                      stream: FirebaseFirestore.instance
                          .collection('therapy_sessions')
                          .where(
                            'clientId',
                            isEqualTo: FirebaseAuth.instance.currentUser!.uid,
                          )
                          .where(
                            'status',
                            isEqualTo: SessionStatus.pending.index,
                          )
                          .snapshots(),
                      builder: (context, snapshot) {
                        if (snapshot.connectionState ==
                            ConnectionState.waiting) {
                          return Center(
                            child: CircularProgressIndicator(
                              color: AppColors.primaryLavender,
                            ),
                          );
                        }
                        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
                          return Center(
                            child: Text(
                              "No pending requests.",
                              style: TextStyle(color: AppColors.textMedium),
                            ),
                          );
                        }

                        return ListView.builder(
                          controller: scrollController,
                          itemCount: snapshot.data!.docs.length,
                          itemBuilder: (context, index) {
                            final doc = snapshot.data!.docs[index];
                            final data = doc.data() as Map<String, dynamic>;
                            final therapistId = data['therapistId'];

                            return FutureBuilder<DocumentSnapshot>(
                              future: FirebaseFirestore.instance
                                  .collection('users')
                                  .doc(therapistId)
                                  .get(),
                              builder: (context, therapistSnapshot) {
                                if (!therapistSnapshot.hasData)
                                  return SizedBox.shrink();
                                final therapist =
                                    therapistSnapshot.data!.data()
                                        as Map<String, dynamic>;

                                return Container(
                                  margin: EdgeInsets.only(bottom: 12),
                                  padding: EdgeInsets.all(12),
                                  decoration: BoxDecoration(
                                    color: AppColors.surface,
                                    borderRadius: BorderRadius.circular(16),
                                  ),
                                  child: Row(
                                    children: [
                                      CircleAvatar(
                                        backgroundImage:
                                            (therapist['profileImage'] !=
                                                    null &&
                                                therapist['profileImage']
                                                    .isNotEmpty)
                                            ? CachedNetworkImageProvider(
                                                therapist['profileImage'],
                                              )
                                            : AssetImage(
                                                    'assets/default_avatar.png',
                                                  )
                                                  as ImageProvider,
                                      ),
                                      SizedBox(width: 12),
                                      Expanded(
                                        child: Column(
                                          crossAxisAlignment:
                                              CrossAxisAlignment.start,
                                          children: [
                                            Text(
                                              therapist['fullName'] ??
                                                  'Therapist',
                                              style: TextStyle(
                                                color: AppColors.textHigh,
                                                fontWeight: FontWeight.bold,
                                              ),
                                            ),
                                            Text(
                                              "Pending Approval",
                                              style: TextStyle(
                                                color: AppColors.accentMustard,
                                                fontSize: 12,
                                              ),
                                            ),
                                          ],
                                        ),
                                      ),
                                      IconButton(
                                        icon: Icon(
                                          Feather.trash_2,
                                          color: AppColors.textDisabled,
                                          size: 18,
                                        ),
                                        onPressed: () async {
                                          await FirebaseFirestore.instance
                                              .collection('therapy_sessions')
                                              .doc(doc.id)
                                              .delete();
                                        },
                                      ),
                                    ],
                                  ),
                                );
                              },
                            );
                          },
                        );
                      },
                    ),
                  ),
                ],
              ),
            );
          },
        );
      },
    );
  }
}


--- C:\Code\femn\lib\therapy\services\therapy_service.dart ---

import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../models/therapy_models.dart';

class TherapyService {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;

  // --- Session Management ---

  Future<String?> bookTherapist(
    String therapistId,
    SessionType type,
    String problemDescription,
  ) async {
    try {
      final String clientId = _auth.currentUser!.uid;

      // Check User's Pending Requests (Max 3 active pending)
      final userPendingSessions = await _firestore
          .collection('therapy_sessions')
          .where('clientId', isEqualTo: clientId)
          .where('status', isEqualTo: SessionStatus.pending.index)
          .get();

      if (userPendingSessions.docs.length >= 3) {
        return "You can only have 3 pending therapy requests at a time.";
      }

      // Check therapist capacity (Max 3 active clients)
      final therapistDoc = await _firestore
          .collection('users')
          .doc(therapistId)
          .get();
      final activeClients = therapistDoc.data()?['activeClients'] ?? 0;

      if (activeClients >= 3) {
        return "Therapist is currently at maximum capacity (3/3 clients).";
      }

      // Create Session
      final sessionRef = _firestore.collection('therapy_sessions').doc();
      final session = TherapySession(
        id: sessionRef.id,
        therapistId: therapistId,
        clientId: clientId,
        type: type,
        status: SessionStatus.pending,
        startTime: DateTime.now(),
        problemDescription: problemDescription,
      );

      await sessionRef.set(session.toMap());

      // Create Notification for Therapist
      await _firestore.collection('notifications').add({
        'toUserId': therapistId,
        'fromUserId': clientId,
        'type': 'therapy_booking',
        'title': 'New Therapy Request',
        'body': 'A new client has requested a therapy session.',
        'timestamp': FieldValue.serverTimestamp(),
        'read': false,
        'sessionId': sessionRef.id,
      });

      await _firestore
          .collection('users')
          .doc(therapistId)
          .collection('notifications')
          .add({
            'type': 'therapy_booking',
            'title': 'New Therapy Request',
            'body': 'A new client has requested a therapy session.',
            'sessionId': sessionRef.id,
            'fromUserId': clientId,
            'isRead': false,
            'timestamp': FieldValue.serverTimestamp(),
          });

      return null; // Success
    } catch (e) {
      return e.toString();
    }
  }

  Future<void> acceptSession(String sessionId) async {
    final sessionDoc = await _firestore
        .collection('therapy_sessions')
        .doc(sessionId)
        .get();
    if (!sessionDoc.exists) return;

    final data = sessionDoc.data()!;
    final therapistId = data['therapistId'];
    final clientId = data['clientId'];

    // Update session status
    await _firestore.collection('therapy_sessions').doc(sessionId).update({
      'status': SessionStatus.active.index,
    });

    // Update therapist active clients
    await _firestore.collection('users').doc(therapistId).update({
      'activeClients': FieldValue.increment(1),
      'totalClients': FieldValue.increment(1),
    });

    // Create a chat if it doesn't exist
    // Create a chat if it doesn't exist
    final chatsQuery = await _firestore
        .collection('chats')
        .where('participants', arrayContains: therapistId)
        .where('type', isEqualTo: 'therapy')
        .get();

    bool chatExists = false;
    for (var doc in chatsQuery.docs) {
      if (List.from(doc['participants']).contains(clientId)) {
        chatExists = true;
        break;
      }
    }

    if (!chatExists) {
      await _firestore.collection('chats').add({
        'participants': [therapistId, clientId],
        'type': 'therapy',
        'lastMessage': 'Therapy session accepted. You can now chat.',
        'lastMessageTime': FieldValue.serverTimestamp(),
        'unreadCount': {therapistId: 0, clientId: 1},
        'createdAt': FieldValue.serverTimestamp(),
      });
    }

    // Notify Client
    await _firestore.collection('notifications').add({
      'toUserId': clientId,
      'fromUserId': therapistId,
      'type': 'therapy_accepted',
      'title': 'Request Accepted',
      'body': 'Your therapy request has been accepted.',
      'timestamp': FieldValue.serverTimestamp(),
      'read': false,
      'sessionId': sessionId,
    });

    await _firestore
        .collection('users')
        .doc(clientId)
        .collection('notifications')
        .add({
          'type': 'therapy_accepted',
          'title': 'Request Accepted',
          'body': 'Your therapy request has been accepted.',
          'fromUserId': therapistId,
          'isRead': false,
          'timestamp': FieldValue.serverTimestamp(),
          'sessionId': sessionId,
        });
  }

  Future<void> completeSession(String sessionId, String therapistId) async {
    await _firestore.collection('therapy_sessions').doc(sessionId).update({
      'status': SessionStatus.completed.index,
      'endTime': FieldValue.serverTimestamp(),
    });

    await _firestore.collection('users').doc(therapistId).update({
      'activeClients': FieldValue.increment(-1),
    });
  }

  // --- Ratings & Reviews ---

  Future<void> rateTherapist(
    String therapistId,
    double rating,
    String comment,
  ) async {
    final String reviewerId = _auth.currentUser!.uid;
    final reviewRef = _firestore.collection('therapist_reviews').doc();

    await reviewRef.set({
      'id': reviewRef.id,
      'therapistId': therapistId,
      'reviewerId': reviewerId,
      'rating': rating,
      'comment': comment,
      'timestamp': FieldValue.serverTimestamp(),
    });

    // Update Average Rating
    final therapistDoc = await _firestore
        .collection('users')
        .doc(therapistId)
        .get();
    final data = therapistDoc.data()!;
    final currentAvg = (data['averageRating'] ?? 0.0).toDouble();
    final totalRatings = data['totalRatings'] ?? 0;

    final newTotal = totalRatings + 1;
    final newAvg = ((currentAvg * totalRatings) + rating) / newTotal;

    await _firestore.collection('users').doc(therapistId).update({
      'averageRating': newAvg,
      'totalRatings': newTotal,
    });

    // Check for Verification (500 clients + mostly 5 stars?)
    // Simplified: Check if totalClients >= 500 and averageRating >= 4.5
    if (newTotal >= 500 && newAvg >= 4.5) {
      await _firestore.collection('users').doc(therapistId).update({
        'isVerified': true,
      });
    }
  }

  // --- Reporting ---

  Future<void> reportTherapist(String therapistId, String reason) async {
    final reportRef = _firestore.collection('therapist_reports').doc();
    await reportRef.set({
      'id': reportRef.id,
      'therapistId': therapistId,
      'reporterId': _auth.currentUser!.uid,
      'reason': reason,
      'timestamp': FieldValue.serverTimestamp(),
    });

    await _firestore.collection('users').doc(therapistId).update({
      'reportCount': FieldValue.increment(1),
    });
  }

  // --- Search & Filtering ---

  Stream<QuerySnapshot> getTherapists({
    String? region,
    String? situation,
    int? age,
    String? ethnicity,
    String? gender,
    bool? isLgbtqPlus,
    String? religion,
    String? ageRange,
    String? language,
    String? livedExperience,
  }) {
    Query query = _firestore
        .collection('users')
        .where('accountType', isEqualTo: 'therapist');

    if (region != null && region.isNotEmpty && region != 'All') {
      query = query.where('region', isEqualTo: region);
    }

    if (situation != null && situation.isNotEmpty) {
      // Specialty matching
      query = query.where('specialization', arrayContains: situation);
    }

    if (livedExperience != null && livedExperience.isNotEmpty) {
      query = query.where('livedExperiences', arrayContains: livedExperience);
    }

    if (language != null && language.isNotEmpty && language != 'All') {
      query = query.where('languages', arrayContains: language);
    }

    if (ethnicity != null && ethnicity.isNotEmpty && ethnicity != 'All') {
      query = query.where('ethnicity', isEqualTo: ethnicity);
    }

    if (gender != null && gender.isNotEmpty && gender != 'All') {
      query = query.where('gender', isEqualTo: gender);
    }

    if (isLgbtqPlus != null && isLgbtqPlus == true) {
      query = query.where('isLgbtqPlus', isEqualTo: true);
    }

    if (religion != null && religion.isNotEmpty && religion != 'All') {
      query = query.where('religion', isEqualTo: religion);
    }

    if (ageRange != null && ageRange.isNotEmpty && ageRange != 'All') {
      query = query.where('ageRange', isEqualTo: ageRange);
    }

    return query.snapshots();
  }
}


--- C:\Code\femn\lib\wellness_widgets\journal.dart ---

import 'dart:async';
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter_staggered_grid_view/flutter_staggered_grid_view.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:intl/intl.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:table_calendar/table_calendar.dart';
import 'package:geolocator/geolocator.dart';
import 'package:image_picker/image_picker.dart';
import 'package:file_picker/file_picker.dart';
import 'package:record/record.dart';
import 'package:audioplayers/audioplayers.dart';
import 'package:path_provider/path_provider.dart';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:femn/hub_screens/profile.dart'; 
import 'package:femn/auth/auth.dart'; 
import 'package:femn/customization/colors.dart'; 
import '../services/streak_service.dart';
import 'package:femn/customization/layout.dart';

// --- 1. Security Service (Updated for UID) ---
class SecurityService {
  // Keys are now dynamic based on UID to prevent multi-user conflict
  static String _pinKey(String uid) => 'user_journal_pin_$uid';
  static String _lockEnabledKey(String uid) => 'journal_lock_enabled_$uid';

  static Future<bool> isLockEnabled(String uid) async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool(_lockEnabledKey(uid)) ?? false;
  }

  static Future<void> setLockEnabled(String uid, bool enabled) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_lockEnabledKey(uid), enabled);
  }

  static Future<bool> checkPin(String uid, String pin) async {
    final prefs = await SharedPreferences.getInstance();
    final storedPin = prefs.getString(_pinKey(uid));
    return storedPin == pin;
  }

  static Future<void> setPin(String uid, String pin) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_pinKey(uid), pin);
  }
}

// --- 2. Main Journal Screen ---

class JournalScreen extends StatefulWidget {
  @override
  _JournalScreenState createState() => _JournalScreenState();
}

class _JournalScreenState extends State<JournalScreen> {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  
  bool _isLocked = true;
  bool _isLoading = true;
  
  DateTime _focusedDay = DateTime.now();
  DateTime? _selectedDay;
  String? _filterMood; 

  @override
  void initState() {
    super.initState();
    _checkLockStatus();
  }

  Future<void> _checkLockStatus() async {
    final user = _auth.currentUser;
    if (user != null) {
      bool enabled = await SecurityService.isLockEnabled(user.uid);
      if (!enabled) {
        setState(() {
          _isLocked = false;
          _isLoading = false;
        });
      } else {
        setState(() => _isLoading = false);
      }
    } else {
       setState(() => _isLoading = false);
    }
  }

  // --- Helper for Circular Buttons ---
  Widget _buildFemnActionButton({required IconData icon, required VoidCallback onTap}) {
    return Container(
      width: 42,
      height: 42,
      margin: const EdgeInsets.symmetric(horizontal: 4),
      decoration: BoxDecoration(
        shape: BoxShape.circle,
        color: AppColors.elevation, // Dark container
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.08),
            blurRadius: 6,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: IconButton(
        icon: Icon(icon, color: AppColors.primaryLavender, size: 20),
        onPressed: onTap,
        padding: EdgeInsets.zero,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    if (_isLoading) return Scaffold(backgroundColor: Colors.transparent, body: Center(child: CircularProgressIndicator(color: AppColors.primaryLavender)));

    if (_isLocked) {
      return PinScreen(
        mode: PinMode.unlock,
        onSuccess: () => setState(() => _isLocked = false),
      );
    }

    final currentUserId = _auth.currentUser!.uid;

    return Scaffold(
      backgroundColor: Colors.transparent,
      
      // --- App Bar ---
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        foregroundColor: AppColors.textHigh,
        elevation: 0,
        automaticallyImplyLeading: false, 
        title: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              width: 42, height: 42,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                color: AppColors.elevation,
                boxShadow: [
                  BoxShadow(color: Colors.black.withOpacity(0.08), blurRadius: 15, offset: const Offset(0, 2)),
                ],
              ),
              child: ClipOval(
                child: Image.asset('assets/default_avatar.png', fit: BoxFit.cover,
                  errorBuilder: (context, error, stackTrace) => Icon(Feather.circle, color: AppColors.primaryLavender),
                ),
              ),
            ),
            const SizedBox(width: 8),
            const Text(
              'Journal',
              style: TextStyle(fontWeight: FontWeight.bold, fontSize: 18, color: AppColors.textHigh),
            ),
          ],
        ),
        actions: [
          // 1. Calendar Button
          _buildFemnActionButton(
            icon: Feather.calendar, 
            onTap: _showCalendarModal
          ),

          // 2. Settings Button (Moved to middle)
          _buildFemnActionButton(
            icon: Feather.settings, 
            onTap: () {
              Navigator.push(
                context, 
                MaterialPageRoute(builder: (context) => JournalSettingsScreen())
              );
            }
          ),
          
          // 3. User Profile Button
          FutureBuilder<DocumentSnapshot>(
            future: FirebaseFirestore.instance.collection('users').doc(currentUserId).get(),
            builder: (context, snapshot) {
              Widget avatar;
              if (snapshot.connectionState == ConnectionState.waiting || !snapshot.hasData || !snapshot.data!.exists) {
                avatar = Image.asset('assets/default_avatar.png', fit: BoxFit.cover, errorBuilder: (_,__,___) => Icon(Feather.user, color: AppColors.textMedium));
              } else {
                final user = snapshot.data!.data() as Map<String, dynamic>;
                final profileImage = user['profileImage'] ?? '';
                avatar = profileImage.isNotEmpty
                    ? CachedNetworkImage(imageUrl: profileImage, fit: BoxFit.cover)
                    : Image.asset('assets/default_avatar.png', fit: BoxFit.cover);
              }

              return GestureDetector(
                onTap: () {
                    Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (context) => ProfileScreen(userId: currentUserId),
                    ),
                  );
                },
                child: Container(
                  width: 42,
                  height: 42,
                  margin: const EdgeInsets.symmetric(horizontal: 4),
                  decoration: BoxDecoration(
                    shape: BoxShape.circle,
                    color: AppColors.elevation,
                    boxShadow: [
                      BoxShadow(color: Colors.black.withOpacity(0.08), blurRadius: 6, offset: const Offset(0, 2)),
                    ],
                  ),
                  child: ClipOval(child: avatar),
                ),
              );
            },
          ),
          const SizedBox(width: 12),
        ],
      ),

      floatingActionButton: FloatingActionButton.extended(
        onPressed: () => Navigator.push(context, MaterialPageRoute(builder: (_) => ComposeEntryScreen())),
        backgroundColor: AppColors.accentMustard, // Mustard for FAB
        elevation: 4,
        icon: Icon(Feather.edit_2, color: AppColors.backgroundDeep),
        label: Text("Write", style: TextStyle(color: AppColors.backgroundDeep, fontWeight: FontWeight.bold)),
      ),

      body: Column(
        children: [
          SizedBox(height: 10),
          _buildMoodFilterBar(),
          Expanded(child: _buildJournalList()),
        ],
      ),
    );
  }

  // --- Mood Filter ---
  Widget _buildMoodFilterBar() {
    final moods = ["All", "", "", "", "", ""];
    return Container(
      height: 45,
      margin: EdgeInsets.only(bottom: 8),
      child: ListView.builder(
        scrollDirection: Axis.horizontal,
        padding: EdgeInsets.symmetric(horizontal: 16),
        itemCount: moods.length,
        itemBuilder: (context, index) {
          final mood = moods[index];
          final isSelected = (mood == "All" && _filterMood == null) || mood == _filterMood;
          return GestureDetector(
            onTap: () => setState(() => _filterMood = mood == "All" ? null : mood),
            child: AnimatedContainer(
              duration: Duration(milliseconds: 200),
              margin: EdgeInsets.only(right: 12),
              padding: EdgeInsets.symmetric(horizontal: 20, vertical: 8),
              decoration: BoxDecoration(
                // Teal for selected, Elevation (dark gray) for unselected
                color: isSelected ? AppColors.secondaryTeal : AppColors.elevation,
                borderRadius: BorderRadius.circular(50),
              ),
              child: Center(
                child: Text(
                  mood,
                  style: TextStyle(
                    fontSize: 16,
                    color: isSelected ? Colors.white : AppColors.textMedium,
                    fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                  ),
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  // --- Calendar Modal ---
  void _showCalendarModal() {
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      isScrollControlled: true,
      builder: (context) => Container(
        height: 550,
        decoration: BoxDecoration(
          color: AppColors.surface, // Dark Surface
          borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
        ),
        padding: EdgeInsets.all(16),
        child: Column(
          children: [
            Container(width: 40, height: 4, decoration: BoxDecoration(color: AppColors.textDisabled, borderRadius: BorderRadius.circular(2))),
            SizedBox(height: 20),
            TableCalendar(
              firstDay: DateTime.utc(2020, 1, 1),
              lastDay: DateTime.utc(2030, 12, 31),
              focusedDay: _focusedDay,
              selectedDayPredicate: (day) => isSameDay(_selectedDay, day),
              calendarFormat: CalendarFormat.month,
              onDaySelected: (selectedDay, focusedDay) {
                setState(() {
                  _selectedDay = selectedDay;
                  _focusedDay = focusedDay;
                });
                Navigator.pop(context);
              },
              calendarStyle: CalendarStyle(
                defaultTextStyle: TextStyle(color: AppColors.textHigh),
                weekendTextStyle: TextStyle(color: AppColors.textMedium),
                selectedDecoration: BoxDecoration(color: AppColors.primaryLavender, shape: BoxShape.circle),
                todayDecoration: BoxDecoration(color: AppColors.secondaryTeal.withOpacity(0.5), shape: BoxShape.circle),
                todayTextStyle: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold),
              ),
              headerStyle: HeaderStyle(
                formatButtonVisible: false, 
                titleCentered: true,
                titleTextStyle: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold, fontSize: 18),
                leftChevronIcon: Icon(Feather.chevron_left, color: AppColors.primaryLavender),
                rightChevronIcon: Icon(Feather.chevron_right, color: AppColors.primaryLavender),
              ),
            ),
            if (_selectedDay != null)
              TextButton(
                onPressed: () {
                  setState(() => _selectedDay = null);
                  Navigator.pop(context);
                },
                child: Text("Clear Date Filter", style: TextStyle(color: AppColors.error)),
              )
          ],
        ),
      ),
    );
  }

  // --- Journal List ---
  Widget _buildJournalList() {
    Query query = FirebaseFirestore.instance
        .collection('users')
        .doc(_auth.currentUser!.uid)
        .collection('journal')
        .orderBy('timestamp', descending: true);

    return StreamBuilder<QuerySnapshot>(
      stream: query.snapshots(),
      builder: (context, snapshot) {
        if (!snapshot.hasData) return Center(child: CircularProgressIndicator(color: AppColors.primaryLavender));

        var docs = snapshot.data!.docs;

        if (_selectedDay != null) {
          docs = docs.where((doc) {
            final ts = (doc['timestamp'] as Timestamp).toDate();
            return isSameDay(ts, _selectedDay);
          }).toList();
        }

        if (_filterMood != null) {
          docs = docs.where((doc) => doc['mood'] == _filterMood).toList();
        }

        if (docs.isEmpty) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Feather.file_text, size: 48, color: AppColors.textDisabled),
                SizedBox(height: 10),
                Text("No entries found", style: TextStyle(color: AppColors.textMedium)),
              ],
            ),
          );
        }

        return MasonryGridView.count(
          padding: EdgeInsets.all(16),
          crossAxisCount: ResponsiveLayout.getColumnCount(context),
          mainAxisSpacing: 12,
          crossAxisSpacing: 12,
          itemCount: docs.length,
          itemBuilder: (context, index) {
            final data = docs[index].data() as Map<String, dynamic>;
            data['id'] = docs[index].id; 
            return _buildJournalCard(data);
          },
        );
      },
    );
  }

  Widget _buildJournalCard(Map<String, dynamic> data) {
    final date = (data['timestamp'] as Timestamp).toDate();
    final mood = data['mood'] ?? '';
    final content = data['content'] ?? '';
    final hasAudio = data['voiceNotePath'] != null;
    final hasImage = data['imagePath'] != null;

    return GestureDetector(
      onTap: () {
        Navigator.push(
          context,
          MaterialPageRoute(builder: (context) => JournalDetailScreen(data: data)),
        );
      },
      child: Container(
        padding: EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: AppColors.surface, // Dark Card
          borderRadius: BorderRadius.circular(20.0),
          boxShadow: [
            BoxShadow(color: Colors.black.withOpacity(0.3), blurRadius: 10, offset: Offset(0, 4))
          ],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(DateFormat('MMM d').format(date), style: TextStyle(color: AppColors.primaryLavender, fontWeight: FontWeight.bold, fontSize: 12)),
                Text(mood, style: TextStyle(fontSize: 18)),
              ],
            ),
            SizedBox(height: 8),
            if (hasImage) 
               Padding(
                 padding: const EdgeInsets.only(bottom: 8.0),
                 child: ClipRRect(
                   borderRadius: BorderRadius.circular(12),
                   child: Image.file(File(data['imagePath']), height: 80, width: double.infinity, fit: BoxFit.cover),
                 ),
               ),
            Text(content, maxLines: 5, overflow: TextOverflow.ellipsis, style: TextStyle(fontSize: 13, height: 1.4, color: AppColors.textMedium)),
            if (hasAudio) ...[
              SizedBox(height: 8),
              Row(
                children: [
                  Icon(Feather.mic, size: 14, color: AppColors.secondaryTeal),
                  SizedBox(width: 4),
                  Text("Audio Note", style: TextStyle(fontSize: 10, color: AppColors.secondaryTeal))
                ],
              ),
            ]
          ],
        ),
      ),
    );
  }
}

// --- 3. Journal Settings Screen ---

class JournalSettingsScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Journal Settings", style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)),
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(
          icon: Icon(Feather.arrow_left, color: AppColors.textHigh),
          onPressed: () => Navigator.pop(context),
        ),
      ),
      backgroundColor: Colors.transparent,
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            ListTile(
              leading: Container(
                padding: EdgeInsets.all(8),
                decoration: BoxDecoration(color: AppColors.elevation, shape: BoxShape.circle),
                child: Icon(Feather.lock, color: AppColors.primaryLavender),
              ),
              title: Text("Security & PIN", style: TextStyle(color: AppColors.textHigh)),
               trailing: Icon(Feather.chevron_right, size: 16, color: AppColors.textDisabled),
              onTap: () {
                 Navigator.push(context, MaterialPageRoute(builder: (_) => SecuritySettingsScreen()));
              },
            ),
            Divider(color: AppColors.textDisabled),
            Spacer(),
          ],
        ),
      ),
    );
  }
}


// --- 4. Journal Detail Screen (View Full Entry) ---

class JournalDetailScreen extends StatelessWidget {
  final Map<String, dynamic> data;
  const JournalDetailScreen({required this.data});

  @override
  Widget build(BuildContext context) {
    final date = (data['timestamp'] as Timestamp).toDate();
    final mood = data['mood'] ?? '';
    final content = data['content'] ?? '';
    final String? imagePath = data['imagePath'];
    final String? voiceNotePath = data['voiceNotePath'];
    final String? docPath = data['docPath'];
    final List<dynamic> tags = data['tags'] ?? [];
    final String weather = data['locationWeather'] ?? '';

    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(icon: Icon(Feather.arrow_left, color: AppColors.textHigh), onPressed: () => Navigator.pop(context)),
        title: Text(DateFormat('MMMM d, yyyy').format(date), style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)),
        actions: [
           Center(child: Padding(
             padding: const EdgeInsets.only(right: 16.0),
             child: Text(mood, style: TextStyle(fontSize: 24)),
           ))
        ],
      ),
      body: SingleChildScrollView(
        padding: EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            if (weather.isNotEmpty)
              Padding(
                padding: const EdgeInsets.only(bottom: 16.0),
                child: Row(children: [Icon(Feather.map_pin, size: 14, color: AppColors.textMedium), SizedBox(width: 4), Text(weather, style: TextStyle(color: AppColors.textMedium))]),
              ),

            if (imagePath != null)
              ClipRRect(
                borderRadius: BorderRadius.circular(20),
                child: Image.file(File(imagePath), width: double.infinity, fit: BoxFit.cover),
              ),
            SizedBox(height: 20),
            
            // Audio Player Logic for Detail View
            if (voiceNotePath != null)
              VoiceMessagePlayer(path: voiceNotePath),

            SizedBox(height: 20),
            Text(content, style: TextStyle(fontSize: 16, height: 1.6, color: AppColors.textHigh)),
            
            if (docPath != null)
              Container(
                margin: EdgeInsets.only(top: 20),
                padding: EdgeInsets.all(12),
                decoration: BoxDecoration(color: AppColors.elevation, borderRadius: BorderRadius.circular(12)),
                child: Row(children: [Icon(Feather.file_text, color: AppColors.secondaryTeal), SizedBox(width: 8), Text("Document Attached", style: TextStyle(color: AppColors.textHigh))]),
              ),

            if (tags.isNotEmpty)
              Padding(
                padding: const EdgeInsets.only(top: 20.0),
                child: Wrap(
                  spacing: 8,
                  children: tags.map((t) => Chip(
                    label: Text("#$t", style: TextStyle(color: AppColors.primaryLavender)), 
                    backgroundColor: AppColors.elevation
                  )).toList(),
                ),
              )
          ],
        ),
      ),
    );
  }
}

// --- 5. Voice Player Widget ---

class VoiceMessagePlayer extends StatefulWidget {
  final String path;
  const VoiceMessagePlayer({required this.path});

  @override
  _VoiceMessagePlayerState createState() => _VoiceMessagePlayerState();
}

class _VoiceMessagePlayerState extends State<VoiceMessagePlayer> {
  final AudioPlayer _audioPlayer = AudioPlayer();
  bool _isPlaying = false;
  Duration _duration = Duration.zero;
  Duration _position = Duration.zero;

  @override
  void initState() {
    super.initState();
    _audioPlayer.onPlayerStateChanged.listen((state) {
      if(mounted) setState(() => _isPlaying = state == PlayerState.playing);
    });
    _audioPlayer.onDurationChanged.listen((d) {
      if(mounted) setState(() => _duration = d);
    });
    _audioPlayer.onPositionChanged.listen((p) {
      if(mounted) setState(() => _position = p);
    });
  }

  @override
  void dispose() {
    _audioPlayer.dispose();
    super.dispose();
  }

  Future<void> _togglePlay() async {
    try {
      if (_isPlaying) {
        await _audioPlayer.pause();
      } else {
        // 
        await _audioPlayer.play(DeviceFileSource(widget.path));
      }
    } catch (e) {
      print("Error playing audio: $e");
    }
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      decoration: BoxDecoration(
        color: AppColors.surface,
        borderRadius: BorderRadius.circular(20),
      ),
      child: Row(
        children: [
          IconButton(
            icon: Icon(_isPlaying ? Feather.pause_circle : Feather.play_circle, color: AppColors.primaryLavender, size: 32),
            onPressed: _togglePlay,
          ),
          SizedBox(width: 8),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text("Voice Note", style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.textHigh)),
                LinearProgressIndicator(
                  value: _duration.inMilliseconds > 0 ? _position.inMilliseconds / _duration.inMilliseconds : 0,
                  color: AppColors.primaryLavender,
                  backgroundColor: AppColors.elevation,
                ),
              ],
            ),
          ),
          SizedBox(width: 8),
          Text(_formatDuration(_duration), style: TextStyle(fontSize: 12, color: AppColors.textMedium)),
        ],
      ),
    );
  }

  String _formatDuration(Duration d) {
    String twoDigits(int n) => n.toString().padLeft(2, "0");
    return "${twoDigits(d.inMinutes.remainder(60))}:${twoDigits(d.inSeconds.remainder(60))}";
  }
}

// --- 6. PIN Screen (Updated for UID) ---

enum PinMode { setup, verify, unlock }

class PinScreen extends StatefulWidget {
  final PinMode mode;
  final VoidCallback onSuccess;

  PinScreen({required this.mode, required this.onSuccess});

  @override
  _PinScreenState createState() => _PinScreenState();
}

class _PinScreenState extends State<PinScreen> {
  String _input = "";
  String _tempPin = "";
  String _message = "Enter PIN";

  @override
  void initState() {
    super.initState();
    _updateMessage();
  }

  void _updateMessage() {
    setState(() {
      if (widget.mode == PinMode.setup) {
        _message = _tempPin.isEmpty ? "Create a 4-digit PIN" : "Confirm your PIN";
      } else if (widget.mode == PinMode.unlock) {
        _message = "Welcome Back";
      } else {
        _message = "Enter current PIN";
      }
    });
  }

  void _onKeyPress(String val) async {
    if (_input.length < 4) {
      setState(() => _input += val);
    }
    if (_input.length == 4) {
      _handleSubmit();
    }
  }

  void _handleSubmit() async {
    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid == null) return; // Handle gracefully if no user

    if (widget.mode == PinMode.unlock || widget.mode == PinMode.verify) {
      bool isValid = await SecurityService.checkPin(uid, _input);
      if (isValid) {
        widget.onSuccess();
      } else {
        setState(() {
          _input = "";
          _message = "Incorrect PIN";
        });
      }
    } else if (widget.mode == PinMode.setup) {
      if (_tempPin.isEmpty) {
        setState(() {
          _tempPin = _input;
          _input = "";
          _updateMessage();
        });
      } else {
        if (_input == _tempPin) {
          await SecurityService.setPin(uid, _input);
          widget.onSuccess();
        } else {
          setState(() {
            _input = "";
            _tempPin = "";
            _message = "Mismatch. Start over.";
          });
        }
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      body: SafeArea(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Container(
              padding: EdgeInsets.all(20),
              decoration: BoxDecoration(color: AppColors.surface, shape: BoxShape.circle, boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.3), blurRadius: 20)]),
              child: Icon(Feather.lock, size: 40, color: AppColors.primaryLavender),
            ),
            SizedBox(height: 30),
            Text(_message, style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
            SizedBox(height: 30),
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: List.generate(4, (index) {
                return AnimatedContainer(
                  duration: Duration(milliseconds: 200),
                  margin: EdgeInsets.symmetric(horizontal: 12),
                  width: 16,
                  height: 16,
                  decoration: BoxDecoration(
                    shape: BoxShape.circle,
                    color: index < _input.length ? AppColors.primaryLavender : AppColors.elevation,
                  ),
                );
              }),
            ),
            SizedBox(height: 50),
            _buildNumPad(),
          ],
        ),
      ),
    );
  }

  Widget _buildNumPad() {
    return Container(
      width: 280,
      child: GridView.count(
        crossAxisCount: 3,
        shrinkWrap: true,
        mainAxisSpacing: 20,
        crossAxisSpacing: 20,
        childAspectRatio: 1.5,
        physics: NeverScrollableScrollPhysics(),
        children: [
          ...List.generate(9, (i) => _buildNumBtn("${i + 1}")),
          SizedBox(), 
          _buildNumBtn("0"),
          IconButton(
            icon: Icon(Feather.delete, color: AppColors.primaryLavender),
            onPressed: () {
              if (_input.isNotEmpty) setState(() => _input = _input.substring(0, _input.length - 1));
            },
          ),
        ],
      ),
    );
  }

  Widget _buildNumBtn(String val) {
    return GestureDetector(
      onTap: () => _onKeyPress(val),
      child: Container(
        decoration: BoxDecoration(shape: BoxShape.circle, color: AppColors.surface),
        child: Center(
          child: Text(val, style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
        ),
      ),
    );
  }
}

// --- 7. Security Settings Screen ---

class SecuritySettingsScreen extends StatefulWidget {
  @override
  _SecuritySettingsScreenState createState() => _SecuritySettingsScreenState();
}

class _SecuritySettingsScreenState extends State<SecuritySettingsScreen> {
  bool _isLockEnabled = false;

  @override
  void initState() {
    super.initState();
    _loadState();
  }

  void _loadState() async {
    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid != null) {
      bool enabled = await SecurityService.isLockEnabled(uid);
      setState(() => _isLockEnabled = enabled);
    }
  }

  void _toggleLock(bool val) async {
    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid == null) return;

    if (val) {
      Navigator.push(context, MaterialPageRoute(builder: (_) => PinScreen(
        mode: PinMode.setup,
        onSuccess: () async {
          await SecurityService.setLockEnabled(uid, true);
          setState(() => _isLockEnabled = true);
          Navigator.pop(context);
        },
      )));
    } else {
      Navigator.push(context, MaterialPageRoute(builder: (_) => PinScreen(
        mode: PinMode.verify,
        onSuccess: () async {
          await SecurityService.setLockEnabled(uid, false);
          setState(() => _isLockEnabled = false);
          Navigator.pop(context);
        },
      )));
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        title: Text("Security", style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)), 
        backgroundColor: AppColors.backgroundDeep, 
        iconTheme: IconThemeData(color: AppColors.textHigh), 
        elevation: 0,
        leading: IconButton(icon: Icon(Feather.arrow_left), onPressed: () => Navigator.pop(context)),
      ),
      body: ListView(
        padding: EdgeInsets.all(16),
        children: [
          SwitchListTile(
            activeColor: AppColors.primaryLavender,
            title: Text("App Lock", style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.textHigh)),
            subtitle: Text("Require PIN to open journal", style: TextStyle(fontSize: 12, color: AppColors.textMedium)),
            value: _isLockEnabled,
            onChanged: _toggleLock,
          ),
          if (_isLockEnabled)
            ListTile(
              title: Text("Change PIN", style: TextStyle(color: AppColors.textHigh)),
              trailing: Icon(Feather.chevron_right, size: 14, color: AppColors.textDisabled),
              onTap: () {
                Navigator.push(context, MaterialPageRoute(builder: (_) => PinScreen(
                  mode: PinMode.verify,
                  onSuccess: () {
                    Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => PinScreen(
                      mode: PinMode.setup,
                      onSuccess: () {
                        Navigator.pop(context);
                        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("PIN Updated")));
                      },
                    )));
                  },
                )));
              },
            ),
        ],
      ),
    );
  }
}

// --- 8. Compose Screen ---

class ComposeEntryScreen extends StatefulWidget {
  @override
  _ComposeEntryScreenState createState() => _ComposeEntryScreenState();
}

class _ComposeEntryScreenState extends State<ComposeEntryScreen> {
  final TextEditingController _contentController = TextEditingController();
  final TextEditingController _tagController = TextEditingController();
  
  String _mood = "";
  double _intensity = 5.0;
  bool _isMoodExpanded = false;
  List<String> _tags = [];
  
  String _weatherInfo = "Detecting location...";

  String? _imagePath;
  String? _docPath;
  
  final AudioRecorder _audioRecorder = AudioRecorder();
  final AudioPlayer _audioPlayer = AudioPlayer();
  bool _isRecording = false;
  String? _recordingPath;
  bool _isPlaying = false;

  @override
  void initState() {
    super.initState();
    _fetchWeather();
  }

  @override
  void dispose() {
    _audioRecorder.dispose();
    _audioPlayer.dispose();
    super.dispose();
  }

  Future<void> _fetchWeather() async {
    try {
      LocationPermission permission = await Geolocator.checkPermission();
      if (permission == LocationPermission.denied) {
        permission = await Geolocator.requestPermission();
      }
      
      if (permission == LocationPermission.whileInUse || permission == LocationPermission.always) {
        setState(() {
          _weatherInfo = "24C  Sunny  Abuja"; // Simulated based on context
        });
      } else {
        setState(() => _weatherInfo = "Location denied");
      }
    } catch (e) {
      setState(() => _weatherInfo = "Weather unavailable");
    }
  }

  Future<void> _takePhoto() async {
    final ImagePicker picker = ImagePicker();
    final XFile? photo = await picker.pickImage(source: ImageSource.camera);
    if (photo != null) setState(() => _imagePath = photo.path);
  }

  Future<void> _pickDocument() async {
    FilePickerResult? result = await FilePicker.platform.pickFiles();
    if (result != null) setState(() => _docPath = result.files.single.path);
  }

  Future<void> _toggleRecording() async {
    if (_isRecording) {
      final path = await _audioRecorder.stop();
      setState(() {
        _isRecording = false;
        _recordingPath = path;
      });
    } else {
      if (await _audioRecorder.hasPermission()) {
        final directory = await getApplicationDocumentsDirectory();
        final path = '${directory.path}/voice_${DateTime.now().millisecondsSinceEpoch}.m4a';
        await _audioRecorder.start(const RecordConfig(), path: path);
        setState(() => _isRecording = true);
      }
    }
  }

  Future<void> _playVoiceNote() async {
    if (_recordingPath != null) {
      if (_isPlaying) {
        await _audioPlayer.pause();
        setState(() => _isPlaying = false);
      } else {
        await _audioPlayer.play(DeviceFileSource(_recordingPath!));
        setState(() => _isPlaying = true);
        _audioPlayer.onPlayerComplete.listen((event) => setState(() => _isPlaying = false));
      }
    }
  }

  Future<void> _saveEntry() async {
    if (_contentController.text.isEmpty && _imagePath == null && _recordingPath == null) return;
    
    final uid = FirebaseAuth.instance.currentUser!.uid;
    await FirebaseFirestore.instance.collection('users').doc(uid).collection('journal').add({
      'content': _contentController.text,
      'mood': _mood,
      'intensity': _intensity,
      'tags': _tags,
      'locationWeather': _weatherInfo,
      'imagePath': _imagePath,
      'docPath': _docPath,
      'voiceNotePath': _recordingPath,
      'timestamp': FieldValue.serverTimestamp(),
    });

    await StreakService.updateStreakOnEntry();
    Navigator.pop(context);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundDeep,
        elevation: 0,
        leading: IconButton(icon: Icon(Feather.x, color: AppColors.textHigh), onPressed: () => Navigator.pop(context)),
        title: Text("New Entry", style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)),
        actions: [
          Padding(
            padding: const EdgeInsets.only(right: 16.0),
            child: Center(
              child: ElevatedButton(
                onPressed: _saveEntry,
                style: ElevatedButton.styleFrom(
                  backgroundColor: AppColors.primaryLavender,
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
                  elevation: 0,
                ),
                child: Text("Save", style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.backgroundDeep)),
              ),
            ),
          )
        ],
      ),
      body: SingleChildScrollView(
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Weather
            Container(
              width: double.infinity,
              padding: EdgeInsets.symmetric(horizontal: 20, vertical: 8),
              color: AppColors.surface,
              child: Row(
                children: [
                  Icon(Feather.map_pin, size: 14, color: AppColors.secondaryTeal),
                  SizedBox(width: 6),
                  Text(_weatherInfo, style: TextStyle(fontSize: 12, color: AppColors.textMedium)),
                ],
              ),
            ),

            // Expandable Mood
            AnimatedContainer(
              duration: Duration(milliseconds: 300),
              padding: EdgeInsets.symmetric(horizontal: 20, vertical: 15),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  GestureDetector(
                    onTap: () => setState(() => _isMoodExpanded = !_isMoodExpanded),
                    child: Row(
                      children: [
                        Text("Mood: $_mood", style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
                        Spacer(),
                        Icon(_isMoodExpanded ? Feather.chevron_up : Feather.chevron_down, color: AppColors.textDisabled),
                      ],
                    ),
                  ),
                  if (_isMoodExpanded) ...[
                    SizedBox(height: 15),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: ["", "", "", "", ""].map((m) => GestureDetector(
                        onTap: () => setState(() => _mood = m),
                        child: Text(m, style: TextStyle(fontSize: 32)),
                      )).toList(),
                    ),
                    Slider(
                      value: _intensity,
                      min: 1, max: 10,
                      activeColor: AppColors.primaryLavender,
                      inactiveColor: AppColors.elevation,
                      onChanged: (v) => setState(() => _intensity = v),
                    ),
                  ]
                ],
              ),
            ),
            
            // Editor
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 20.0),
              child: TextField(
                controller: _contentController,
                maxLines: null,
                minLines: 8,
                style: TextStyle(fontSize: 15, height: 1.5, color: AppColors.textHigh),
                decoration: InputDecoration(
                  hintText: "What's on your mind today?",
                  filled: true,
                  fillColor: AppColors.elevation,
                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
                  hintStyle: TextStyle(color: AppColors.textDisabled),
                  contentPadding: EdgeInsets.all(20),
                ),
              ),
            ),

            // Attachments Display
            if (_imagePath != null)
              Padding(
                padding: const EdgeInsets.all(20),
                child: ClipRRect(
                  borderRadius: BorderRadius.circular(18),
                  child: Image.file(File(_imagePath!), height: 180, width: double.infinity, fit: BoxFit.cover),
                ),
              ),
              
            if (_recordingPath != null)
              Container(
                margin: EdgeInsets.symmetric(horizontal: 20, vertical: 10),
                padding: EdgeInsets.all(12),
                decoration: BoxDecoration(color: AppColors.surface, borderRadius: BorderRadius.circular(16)),
                child: Row(
                  children: [
                    IconButton(
                      icon: Icon(_isPlaying ? Feather.pause : Feather.play, color: AppColors.primaryLavender),
                      onPressed: _playVoiceNote,
                    ),
                    Text("Voice Note Recorded", style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)),
                    Spacer(),
                    IconButton(icon: Icon(Feather.trash_2, color: AppColors.error, size: 20), onPressed: () => setState(() => _recordingPath = null)),
                  ],
                ),
              ),

             if (_docPath != null)
              Container(
                margin: EdgeInsets.symmetric(horizontal: 20, vertical: 10),
                padding: EdgeInsets.all(12),
                decoration: BoxDecoration(color: AppColors.elevation, borderRadius: BorderRadius.circular(16)),
                child: Row(
                  children: [
                    Icon(Feather.file_text, color: AppColors.secondaryTeal),
                    SizedBox(width: 8),
                    Expanded(child: Text("Document Attached", style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold))),
                    IconButton(icon: Icon(Feather.x, color: AppColors.textDisabled, size: 20), onPressed: () => setState(() => _docPath = null)),
                  ],
                ),
              ),

            // Tags
            SizedBox(height: 10),
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 20),
              child: Wrap(
                spacing: 8,
                runSpacing: 8,
                children: [
                  ..._tags.map((t) => Chip(
                    label: Text("#$t", style: TextStyle(fontSize: 12, color: AppColors.primaryLavender)),
                    backgroundColor: AppColors.elevation,
                    deleteIcon: Icon(Feather.x, size: 14, color: AppColors.primaryLavender),
                    onDeleted: () => setState(() => _tags.remove(t)),
                  )),
                  Container(
                    width: 100,
                    child: TextField(
                      controller: _tagController,
                      style: TextStyle(fontSize: 12, color: AppColors.textHigh),
                      decoration: InputDecoration(
                        hintText: "+ Tag",
                        isDense: true,
                        filled: true,
                        fillColor: AppColors.elevation,
                        border: OutlineInputBorder(borderRadius: BorderRadius.circular(20), borderSide: BorderSide.none),
                        contentPadding: EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                        hintStyle: TextStyle(color: AppColors.textDisabled),
                      ),
                      onSubmitted: (val) {
                        if (val.isNotEmpty) {
                          setState(() {
                            _tags.add(val);
                            _tagController.clear();
                          });
                        }
                      },
                    ),
                  )
                ],
              ),
            ),

            SizedBox(height: 20),
            Divider(height: 1, color: AppColors.textDisabled),
            
            // Bottom Action Bar
            Container(
              padding: EdgeInsets.symmetric(horizontal: 20, vertical: 20),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceAround,
                children: [
                  _buildActionButton(Feather.mic, _isRecording ? "Stop" : "Voice", _isRecording ? AppColors.error : AppColors.primaryLavender, _toggleRecording),
                  _buildActionButton(Feather.camera, "Photo", AppColors.primaryLavender, _takePhoto),
                  _buildActionButton(Feather.file_text, "Doc", AppColors.primaryLavender, _pickDocument),
                ],
              ),
            ),
            SizedBox(height: 20),
          ],
        ),
      ),
    );
  }

  Widget _buildActionButton(IconData icon, String label, Color color, VoidCallback onTap) {
    return InkWell(
      onTap: onTap,
      child: Column(
        children: [
          Container(
            padding: EdgeInsets.all(12),
            decoration: BoxDecoration(color: AppColors.elevation, shape: BoxShape.circle),
            child: Icon(icon, color: color, size: 24),
          ),
          SizedBox(height: 8),
          Text(label, style: TextStyle(fontSize: 12, color: AppColors.textMedium, fontWeight: FontWeight.bold)),
        ],
      ),
    );
  }
}


--- C:\Code\femn\lib\wellness_widgets\period_tracker.dart ---

import 'dart:async';
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart'; // Using Feather Icons
import 'package:intl/intl.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:table_calendar/table_calendar.dart';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:femn/customization/colors.dart'; 
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;
import 'package:percent_indicator/percent_indicator.dart';
import 'package:fl_chart/fl_chart.dart'; 
import 'package:femn/hub_screens/profile.dart';

// --- 1. Data Models ---

class DailyLog {
  final DateTime date;
  final String? flowIntensity;
  final List<String> symptoms;
  final List<String> moods;
  final bool sexualActivity;
  final bool protectedSex;
  final String? notes;

  DailyLog({
    required this.date,
    this.flowIntensity,
    this.symptoms = const [],
    this.moods = const [],
    this.sexualActivity = false,
    this.protectedSex = false,
    this.notes,
  });

  Map<String, dynamic> toMap() {
    return {
      'date': Timestamp.fromDate(date),
      'flowIntensity': flowIntensity,
      'symptoms': symptoms,
      'moods': moods,
      'sexualActivity': sexualActivity,
      'protectedSex': protectedSex,
      'notes': notes,
    };
  }

  factory DailyLog.fromDoc(Map<String, dynamic> data) {
    return DailyLog(
      date: (data['date'] as Timestamp).toDate(),
      flowIntensity: data['flowIntensity'],
      symptoms: List<String>.from(data['symptoms'] ?? []),
      moods: List<String>.from(data['moods'] ?? []),
      sexualActivity: data['sexualActivity'] ?? false,
      protectedSex: data['protectedSex'] ?? false,
      notes: data['notes'],
    );
  }
}

class HistoricalCycle {
  final DateTime startDate;
  final DateTime endDate;
  final List<DailyLog> logs;
  final int periodLength;

  HistoricalCycle({
    required this.startDate,
    required this.endDate,
    required this.logs,
    required this.periodLength,
  });

  int get length => endDate.difference(startDate).inDays + 1;
}

// --- 2. Cycle Logic Service ---

class CycleService {
  static const int kDefaultCycleLength = 28;

  static DateTime predictNextPeriod(DateTime lastPeriodStart, {int avgCycle = kDefaultCycleLength}) {
    return lastPeriodStart.add(Duration(days: avgCycle));
  }

  // --- NEW: Calculate Phase/Season ---
  static CyclePhaseData? getCurrentPhase(DateTime? lastPeriodStart, int cycleLength) {
    if (lastPeriodStart == null) return null;

    final now = DateTime.now();
    final diff = now.difference(lastPeriodStart).inDays;
    
    // Normalize day to current cycle (1-based index)
    // If diff is 30 and cycle is 28, day is 2.
    int currentDay = (diff % cycleLength) + 1; 

    // Logic for Seasons
    // Winter (Menstruation): Days 1-5
    if (currentDay <= 5) {
      return CyclePhaseData(
        seasonName: "Winter",
        phaseName: "Menstruation",
        bgColor: Color(0xFF102A43), // Midnight Navy
        textColor: Color(0xFFD9E2EC), // Frosty Ice Blue
        icon: Feather.cloud_snow,
      );
    }
    // Summer (Ovulation): Approx 14 days before end of cycle (+/- 1 day)
    // For 28 days, Ovulation is ~14. Range 13-15.
    int ovulationDay = cycleLength - 14; 
    if (currentDay >= ovulationDay - 1 && currentDay <= ovulationDay + 1) {
      return CyclePhaseData(
        seasonName: "Summer",
        phaseName: "Ovulation",
        bgColor: Color(0xFFFFD700), // Solar Gold
        textColor: Color(0xFF4E342E), // Dark Earth Brown
        icon: Feather.sun,
      );
    }
    // Spring (Follicular): After Winter, Before Summer
    if (currentDay > 5 && currentDay < ovulationDay - 1) {
      return CyclePhaseData(
        seasonName: "Spring",
        phaseName: "Follicular",
        bgColor: Color(0xFF98FB98), // Pale Mint Green
        textColor: Color(0xFF1B5E20), // Deep Fern Green
        icon: Feather.cloud_drizzle, // or a flower/sprout icon if available
      );
    }
    // Autumn (Luteal): After Summer, until end
    return CyclePhaseData(
      seasonName: "Autumn",
      phaseName: "Luteal",
      bgColor: Color(0xFFC0392B), // Deep Rust
      textColor: Color(0xFFFDF2E9), // Warm Vanilla
      icon: Feather.wind,
    );
  }
}

// --- 3. Security Service (User Specific) ---
class SecurityService {
  // Keys are now dynamic based on UID to prevent multi-user conflict
  static String _pinKey(String uid) => 'user_journal_pin_$uid';
  static String _lockEnabledKey(String uid) => 'journal_lock_enabled_$uid';

  static Future<bool> isLockEnabled(String uid) async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool(_lockEnabledKey(uid)) ?? false;
  }

  static Future<void> setLockEnabled(String uid, bool enabled) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_lockEnabledKey(uid), enabled);
  }

  static Future<bool> checkPin(String uid, String pin) async {
    final prefs = await SharedPreferences.getInstance();
    final storedPin = prefs.getString(_pinKey(uid));
    return storedPin == pin;
  }

  static Future<void> setPin(String uid, String pin) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_pinKey(uid), pin);
  }
}

// --- 4. Main Screen ---

class PeriodTrackerScreen extends StatefulWidget {
  @override
  _PeriodTrackerScreenState createState() => _PeriodTrackerScreenState();
}

class _PeriodTrackerScreenState extends State<PeriodTrackerScreen> with SingleTickerProviderStateMixin {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  late TabController _tabController;
  
  // State
  DateTime _focusedDay = DateTime.now();
  DateTime? _selectedDay;
  Map<DateTime, List<String>> _calendarEvents = {}; 
  Map<DateTime, DailyLog> _logsMap = {}; 
  List<HistoricalCycle> _historyCycles = [];
  
  // Settings & Flags
  bool _isPregnancyMode = false;
  int _avgCycleLength = 28;
  DateTime? _lastPeriodStart;
  
  bool _isLoading = true;
  bool _isLocked = false; 
  bool _isFirstTimeSetup = false;
  
  // Chart State
  int _touchedIndex = -1;

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 3, vsync: this);
    _selectedDay = _focusedDay;
    _initialCheck();
  }

  Future<void> _initialCheck() async {
    final user = _auth.currentUser;
    if (user == null) return;

    // Check lock specifically for this user
    bool enabled = await SecurityService.isLockEnabled(user.uid);
    if (enabled) {
      setState(() {
        _isLocked = true;
        _isLoading = false;
      });
    } else {
      _loadData();
    }
  }

  Future<void> _loadData() async {
    setState(() => _isLoading = true);
    try {
      final user = _auth.currentUser;
      if (user == null) {
        setState(() => _isLoading = false);
        return; 
      }
      final uid = user.uid;

      // 1. Check if settings exist (Determines Onboarding)
      DocumentSnapshot<Map<String, dynamic>> settingsDoc;
      try {
        settingsDoc = await _firestore
            .collection('users')
            .doc(uid)
            .collection('cycle_settings')
            .doc('settings')
            .get();
      } catch (e) {
        rethrow; 
      }

      if (!settingsDoc.exists) {
        setState(() {
          _isFirstTimeSetup = true;
          _isLoading = false;
        });
        return;
      }

      final data = settingsDoc.data()!;
      _isPregnancyMode = data['isPregnancyMode'] ?? false;
      _avgCycleLength = data['avgCycleLength'] ?? 28;
      
      // If manual start date was saved in settings (from onboarding), use it as fallback
      if (data['lastPeriodStart'] != null) {
        _lastPeriodStart = (data['lastPeriodStart'] as Timestamp).toDate();
      }

      // 2. Load Logs
      final snap = await _firestore
          .collection('users')
          .doc(uid)
          .collection('cycle_logs')
          .orderBy('date')
          .get();

      final Map<DateTime, DailyLog> logsMap = {};
      final Map<DateTime, List<String>> events = {};
      final List<DailyLog> allLogsList = [];

      for (var doc in snap.docs) {
        final log = DailyLog.fromDoc(doc.data());
        final dateKey = DateTime(log.date.year, log.date.month, log.date.day);

        logsMap[dateKey] = log;
        allLogsList.add(log);

        List<String> markers = [];
        if (log.flowIntensity != null) markers.add('period');
        if (log.sexualActivity) markers.add('intimacy');
        if (log.symptoms.isNotEmpty) markers.add('symptom');
        events[dateKey] = markers;
      }

      _historyCycles = _calculateCycles(allLogsList);

      // If we have history, the latest cycle start is the authority. 
      // If no logs yet, we rely on the onboarding 'lastPeriodStart'.
      if (_historyCycles.isNotEmpty) {
        _lastPeriodStart = _historyCycles.last.startDate;
      }

      if (mounted) {
        setState(() {
          _logsMap = logsMap;
          _calendarEvents = events;
          _isLoading = false;
          _isFirstTimeSetup = false;
        });
      }
    } catch (e) {
      debugPrint("Error loading data: $e");
      if (mounted) {
        setState(() => _isLoading = false);
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text("Network unavailable. Please checks your internet."),
            backgroundColor: AppColors.error,
          ),
        );
      }
    }
  }

  List<HistoricalCycle> _calculateCycles(List<DailyLog> logs) {
    if (logs.isEmpty) return [];
    
    List<HistoricalCycle> cycles = [];
    logs.sort((a, b) => a.date.compareTo(b.date));

    List<DailyLog> currentCycleLogs = [];
    DateTime? cycleStart;
    DateTime? lastFlowDate;
    int currentPeriodDays = 0;

    for (var log in logs) {
      bool isFlow = log.flowIntensity != null;

      if (isFlow) {
        // If gap is large, it's a new cycle
        if (lastFlowDate != null && log.date.difference(lastFlowDate!).inDays > 10) {
          if (cycleStart != null) {
            cycles.add(HistoricalCycle(
              startDate: cycleStart,
              endDate: log.date.subtract(Duration(days: 1)),
              logs: List.from(currentCycleLogs),
              periodLength: currentPeriodDays,
            ));
          }
          cycleStart = log.date;
          currentCycleLogs = [];
          currentPeriodDays = 0;
        }
        
        if (cycleStart == null) cycleStart = log.date;
        lastFlowDate = log.date;
        currentPeriodDays++;
      }
      
      if (cycleStart != null) {
        currentCycleLogs.add(log);
      }
    }

    if (cycleStart != null) {
      cycles.add(HistoricalCycle(
        startDate: cycleStart,
        endDate: DateTime.now(),
        logs: currentCycleLogs,
        periodLength: currentPeriodDays,
      ));
    }

    return cycles.reversed.toList();
  }

  // ---  UI Helper for Circular Buttons ---
  Widget _buildCircleAction({required Widget child, required VoidCallback onTap}) {
    return Container(
      width: 42, height: 42,
      decoration: BoxDecoration(
        shape: BoxShape.circle,
        color: AppColors.elevation,
        boxShadow: [
          BoxShadow(color: Colors.black.withOpacity(0.08), blurRadius: 6, offset: const Offset(0, 2)),
        ],
      ),
      child: IconButton(
        icon: child,
        onPressed: onTap,
        padding: EdgeInsets.zero,
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    // 1. Lock Screen Check
    if (_isLocked) {
      return PinScreen(
        mode: PinMode.unlock,
        onSuccess: () {
          setState(() => _isLocked = false);
          _loadData();
        },
      );
    }

    // 2. Loading State
    if (_isLoading) {
      return Scaffold(
        backgroundColor: Colors.transparent, 
        body: Center(child: CircularProgressIndicator(color: AppColors.primaryLavender))
      );
    }

    // 3. Onboarding Check
    if (_isFirstTimeSetup) {
      return OnboardingWizard(
        onCompleted: () async {
          // Refresh data to load the newly saved settings
          await _loadData();
        },
      );
    }

    // 4. Main App Content
    return Scaffold(
      backgroundColor: Colors.transparent,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        foregroundColor: AppColors.textHigh,
        elevation: 0,
        automaticallyImplyLeading: false,
        title: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              width: 42, height: 42,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                color: AppColors.elevation,
                boxShadow: [
                  BoxShadow(color: Colors.black.withOpacity(0.08), blurRadius: 15, offset: const Offset(0, 2)),
                ],
              ),
              child: ClipOval(
                child: Image.asset('assets/default_avatar.png', fit: BoxFit.cover,
                  errorBuilder: (context, error, stackTrace) => Icon(Feather.circle, color: AppColors.primaryLavender),
                ),
              ),
            ),
            SizedBox(width: 8),
            Text('Flow', style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.textHigh)),
          ],
        ),
        actions: [
          // 1. PDF Button (Left)
          _buildCircleAction(
            child: Icon(Feather.file_text, color: AppColors.primaryLavender, size: 22),
            onTap: _generatePDFReport,
          ),
          const SizedBox(width: 8),

          // 2. Settings Button (Middle)
          _buildCircleAction(
            child: Icon(Feather.settings, color: AppColors.primaryLavender, size: 22),
            onTap: _showSettingsModal,
          ),
          const SizedBox(width: 8),
          
          // 3. Profile Picture (Far Right)
          FutureBuilder<DocumentSnapshot>(
            future: _firestore.collection('users').doc(_auth.currentUser?.uid).get(),
            builder: (context, snapshot) {
              Widget avatar;
              if (snapshot.connectionState == ConnectionState.waiting || !snapshot.hasData || !snapshot.data!.exists) {
                avatar = Image.asset('assets/default_avatar.png', fit: BoxFit.cover, errorBuilder: (_,__,___) => Icon(Feather.user, color: AppColors.textMedium));
              } else {
                final userData = snapshot.data!.data() as Map<String, dynamic>;
                final String profileImage = userData['profileImage'] ?? '';
                avatar = profileImage.isNotEmpty
                  ? CachedNetworkImage(imageUrl: profileImage, fit: BoxFit.cover)
                  : Image.asset('assets/default_avatar.png', fit: BoxFit.cover);
              }

              return GestureDetector(
                onTap: () {
                  final uid = _auth.currentUser!.uid; 
                  Navigator.push(
                    context, 
                    MaterialPageRoute(builder: (context) => ProfileScreen(userId: uid))
                  );
                },
                child: Container(
                  width: 42, height: 42,
                  decoration: BoxDecoration(
                    shape: BoxShape.circle,
                    color: AppColors.elevation,
                    boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.08), blurRadius: 15, offset: const Offset(0, 2))],
                  ),
                  child: ClipOval(child: avatar),
                ),
              );
            },
          ),
          const SizedBox(width: 16), // Extra padding on right
        ],
      ),

      body: Column(
        children: [
          Container(
            color: Colors.transparent,
            child: TabBar(
              controller: _tabController,
              labelColor: AppColors.primaryLavender,
              unselectedLabelColor: AppColors.textMedium,
              indicatorColor: AppColors.primaryLavender,
              tabs: [
                Tab(text: "Calendar"),
                Tab(text: "Insights"),
                Tab(text: "History"),
              ],
            ),
          ),
          Expanded(
            child: TabBarView(
              controller: _tabController,
              children: [
                _buildCalendarTab(),
                _buildInsightsTab(),
                _buildHistoryTab(),
              ],
            ),
          ),
        ],
      ),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: () => _showLogSheet(_selectedDay ?? DateTime.now()),
        backgroundColor: AppColors.accentMustard,
        icon: Icon(Feather.plus, color: AppColors.backgroundDeep), // Feather Icon
        label: Text("Log", style: TextStyle(color: AppColors.backgroundDeep, fontWeight: FontWeight.bold)),
      ),
    );
  }

  // ---  Tab 1: Calendar ---
  Widget _buildCalendarTab() {
    return SingleChildScrollView(
      child: Column(
        children: [
          if (_lastPeriodStart != null && !_isPregnancyMode) ...[
            SizedBox(height: 16),
            _buildCycleDashboard(),
          ],
          if (_isPregnancyMode) ...[
             SizedBox(height: 16),
             _buildPregnancyDashboard(),
          ],
          
          TableCalendar(
            firstDay: DateTime.utc(2020, 1, 1),
            lastDay: DateTime.utc(2030, 12, 31),
            focusedDay: _focusedDay,
            selectedDayPredicate: (day) => isSameDay(_selectedDay, day),
            calendarFormat: CalendarFormat.month,
            onDaySelected: (selectedDay, focusedDay) {
              setState(() {
                _selectedDay = selectedDay;
                _focusedDay = focusedDay;
              });
            },
            eventLoader: (day) {
              final dateKey = DateTime(day.year, day.month, day.day);
              return _calendarEvents[dateKey] ?? [];
            },
            calendarStyle: CalendarStyle(
              defaultTextStyle: TextStyle(color: AppColors.textHigh),
              weekendTextStyle: TextStyle(color: AppColors.textMedium),
              todayDecoration: BoxDecoration(color: AppColors.secondaryTeal.withOpacity(0.5), shape: BoxShape.circle),
              selectedDecoration: BoxDecoration(color: AppColors.primaryLavender, shape: BoxShape.circle),
              markerDecoration: BoxDecoration(color: AppColors.accentMustard, shape: BoxShape.circle),
            ),
            headerStyle: HeaderStyle(
              formatButtonVisible: false,
              titleCentered: true,
              titleTextStyle: TextStyle(color: AppColors.textHigh, fontSize: 18, fontWeight: FontWeight.bold),
              leftChevronIcon: Icon(Feather.chevron_left, color: AppColors.primaryLavender), // Feather
              rightChevronIcon: Icon(Feather.chevron_right, color: AppColors.primaryLavender), // Feather
            ),
          ),
          Divider(color: AppColors.textDisabled),
          if (_selectedDay != null) _buildDayDetail(_selectedDay!),
        ],
      ),
    );
  }

  Widget _buildCycleDashboard() {
    // Safety check in case _lastPeriodStart is null (shouldn't be here if logic is correct)
    if (_lastPeriodStart == null) return SizedBox();

    final nextPeriod = CycleService.predictNextPeriod(_lastPeriodStart!, avgCycle: _avgCycleLength);
    final daysUntil = nextPeriod.difference(DateTime.now()).inDays;
    
    return Container(
      margin: EdgeInsets.symmetric(horizontal: 16),
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(color: AppColors.surface, borderRadius: BorderRadius.circular(20)),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceAround,
        children: [
          _buildInfoPill("Next Period", "$daysUntil Days", Feather.droplet, AppColors.primaryLavender), // Feather
          _buildInfoPill("Phase", "Luteal", Feather.clock, AppColors.secondaryTeal), // Feather
        ],
      ),
    );
  }

  Widget _buildPregnancyDashboard() {
    return Container(
      margin: EdgeInsets.symmetric(horizontal: 16),
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.surface, borderRadius: BorderRadius.circular(20), border: Border.all(color: AppColors.primaryLavender)
      ),
      child: Row(
        children: [
           CircularPercentIndicator(
             radius: 35.0, lineWidth: 8.0, percent: 0.3,
             center: Text("12\nWeeks", textAlign: TextAlign.center, style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12, color: AppColors.textHigh)),
             progressColor: AppColors.primaryLavender, backgroundColor: AppColors.elevation,
           ),
           SizedBox(width: 20),
           Expanded(
             child: Column(
               crossAxisAlignment: CrossAxisAlignment.start,
               children: [
                 Text("Baby is the size of a Plum!", style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16, color: AppColors.textHigh)),
                 Text("Keep tracking your vitamins.", style: TextStyle(color: AppColors.textMedium)),
               ],
             ),
           )
        ],
      ),
    );
  }

  Widget _buildInfoPill(String label, String value, IconData icon, Color color) {
    return Column(
      children: [
        CircleAvatar(backgroundColor: AppColors.elevation, radius: 20, child: Icon(icon, color: color, size: 20)),
        SizedBox(height: 8),
        Text(value, style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14, color: AppColors.textHigh)),
        Text(label, style: TextStyle(fontSize: 10, color: AppColors.textMedium)),
      ],
    );
  }

  Widget _buildDayDetail(DateTime date) {
    final dateKey = DateTime(date.year, date.month, date.day);
    final log = _logsMap[dateKey];

    return Padding(
      padding: const EdgeInsets.all(16.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(DateFormat('EEEE, MMM d').format(date), style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
          SizedBox(height: 10),
          if (log == null) Text("No data logged.", style: TextStyle(color: AppColors.textDisabled)),
          if (log != null) ...[
            if (log.flowIntensity != null) _buildDetailRow("Flow", log.flowIntensity!, Feather.droplet, AppColors.error), // Feather
            if (log.moods.isNotEmpty) _buildDetailRow("Mood", log.moods.join(", "), Feather.smile, AppColors.accentMustard), // Feather
            if (log.symptoms.isNotEmpty) _buildDetailRow("Symptoms", log.symptoms.join(", "), Feather.activity, AppColors.primaryLavender), // Feather
          ]
        ],
      ),
    );
  }

  Widget _buildDetailRow(String title, String value, IconData icon, Color color) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 6.0),
      child: Row(
        children: [
          Icon(icon, size: 16, color: color),
          SizedBox(width: 8),
          Text("$title: ", style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.textHigh)),
          Expanded(child: Text(value, overflow: TextOverflow.ellipsis, style: TextStyle(color: AppColors.textMedium))),
        ],
      ),
    );
  }

  // ---  Tab 2: Insights (Animated Pie Chart) ---
  Widget _buildInsightsTab() {
    Map<String, int> stats = {'Cramps': 0, 'Headache': 0, 'Bloating': 0, 'Acne': 0};
    _logsMap.values.forEach((log) {
      for (var s in log.symptoms) {
        if (stats.containsKey(s)) stats[s] = (stats[s] ?? 0) + 1;
      }
    });

    int total = 0;
    stats.forEach((_, v) => total += v);
    
    // Prepare Data for Pie Chart
    List<PieChartSectionData> showingSections() {
      return List.generate(stats.length, (i) {
        final isTouched = i == _touchedIndex;
        final fontSize = isTouched ? 20.0 : 14.0;
        final radius = isTouched ? 110.0 : 100.0;
        
        final key = stats.keys.elementAt(i);
        final value = stats[key] ?? 0;
        final percent = total > 0 ? (value / total) * 100 : 0;

        Color color;
        switch (i) {
          case 0: color = AppColors.primaryLavender; break;
          case 1: color = AppColors.secondaryTeal; break;
          case 2: color = AppColors.accentMustard; break;
          default: color = AppColors.error;
        }

        return PieChartSectionData(
          color: color,
          value: value.toDouble(),
          title: '${percent.toStringAsFixed(0)}%',
          radius: radius,
          titleStyle: TextStyle(
            fontSize: fontSize,
            fontWeight: FontWeight.bold,
            color: const Color(0xffffffff),
          ),
          badgeWidget: isTouched ? Container(
             padding: EdgeInsets.all(4),
             color: Colors.white,
             child: Text(key, style: TextStyle(fontSize: 10, color: Colors.black)),
          ) : null,
          badgePositionPercentageOffset: .98,
        );
      });
    }

    return SingleChildScrollView(
      padding: EdgeInsets.all(16),
      child: Column(
        children: [
          Text("Symptom Patterns", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
          SizedBox(height: 20),
          
          // Large Pie Chart Container
          SizedBox(
            height: 350, // Make it large so screen doesn't feel empty
            child: total == 0 
            ? Center(child: Text("Not enough data yet", style: TextStyle(color: AppColors.textDisabled)))
            : PieChart(
                PieChartData(
                  pieTouchData: PieTouchData(
                    touchCallback: (FlTouchEvent event, pieTouchResponse) {
                      setState(() {
                        if (!event.isInterestedForInteractions ||
                            pieTouchResponse == null ||
                            pieTouchResponse.touchedSection == null) {
                          _touchedIndex = -1;
                          return;
                        }
                        _touchedIndex = pieTouchResponse.touchedSection!.touchedSectionIndex;
                      });
                    },
                  ),
                  borderData: FlBorderData(show: false),
                  sectionsSpace: 2, // Space between slices
                  centerSpaceRadius: 40, // Donut style
                  sections: showingSections(),
                ),
                swapAnimationDuration: Duration(milliseconds: 800), // Smooth Animation
                swapAnimationCurve: Curves.easeInOutQuint,
              ),
          ),
          
          SizedBox(height: 30),
          // Legend
          Wrap(
            spacing: 16, runSpacing: 10,
            alignment: WrapAlignment.center,
            children: List.generate(stats.length, (i) {
               final key = stats.keys.elementAt(i);
               Color color;
                switch (i) {
                  case 0: color = AppColors.primaryLavender; break;
                  case 1: color = AppColors.secondaryTeal; break;
                  case 2: color = AppColors.accentMustard; break;
                  default: color = AppColors.error;
                }
               return Row(
                 mainAxisSize: MainAxisSize.min,
                 children: [
                   Container(width: 12, height: 12, color: color),
                   SizedBox(width: 4),
                   Text(key, style: TextStyle(color: AppColors.textMedium))
                 ],
               );
            }),
          )
        ],
      ),
    );
  }

  // ---  Tab 3: History (The "Cycle Stream") ---

  Widget _buildHistoryTab() {
    if (_historyCycles.isEmpty) {
      return Center(
        child: Text("Log your periods to see history.", style: TextStyle(color: AppColors.textMedium)),
      );
    }

    return ListView.builder(
      padding: EdgeInsets.all(16),
      itemCount: _historyCycles.length,
      itemBuilder: (context, index) {
        final cycle = _historyCycles[index];
        return _buildCycleCard(cycle);
      },
    );
  }

  Widget _buildCycleCard(HistoricalCycle cycle) {
    final isRegular = (cycle.length - _avgCycleLength).abs() <= 3;
    final regularityLabel = isRegular ? "Regular" : (cycle.length > _avgCycleLength ? "Late" : "Early");
    final regularityColor = isRegular ? AppColors.success : AppColors.accentMustard;
    
    List<Widget> miniMapSegments = [];
    for (int i = 0; i < cycle.length && i < 30; i++) {
      final date = cycle.startDate.add(Duration(days: i));
      final dateKey = DateTime(date.year, date.month, date.day);
      final log = _logsMap[dateKey];
      final isFlow = log?.flowIntensity != null;
      
      miniMapSegments.add(
        Expanded(
          child: Container(
            height: 6,
            margin: EdgeInsets.symmetric(horizontal: 0.5),
            decoration: BoxDecoration(
              color: isFlow ? AppColors.primaryLavender : AppColors.elevation,
              borderRadius: BorderRadius.circular(2),
            ),
          ),
        )
      );
    }

    return Card(
      elevation: 0,
      margin: EdgeInsets.only(bottom: 16),
      color: AppColors.surface,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(20),
        side: BorderSide(color: AppColors.elevation),
      ),
      child: Theme(
        data: Theme.of(context).copyWith(dividerColor: Colors.transparent),
        child: ExpansionTile(
          tilePadding: EdgeInsets.all(16),
          title: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    DateFormat('MMMM yyyy').format(cycle.startDate),
                    style: TextStyle(fontWeight: FontWeight.bold, fontSize: 18, color: AppColors.textHigh),
                  ),
                  Container(
                    padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(
                      color: regularityColor.withOpacity(0.2),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Text(regularityLabel, style: TextStyle(color: regularityColor, fontSize: 10, fontWeight: FontWeight.bold)),
                  )
                ],
              ),
              SizedBox(height: 12),
              Row(
                children: [
                  _buildCycleStat("Cycle Length", "${cycle.length} Days", cycle.length != _avgCycleLength),
                  SizedBox(width: 20),
                  _buildCycleStat("Period", "${cycle.periodLength} Days", false),
                  Spacer(),
                  Text(
                    "${DateFormat('MMM d').format(cycle.startDate)} - ${DateFormat('MMM d').format(cycle.endDate)}",
                    style: TextStyle(fontSize: 12, color: AppColors.textMedium),
                  )
                ],
              ),
              SizedBox(height: 12),
              Row(children: miniMapSegments),
            ],
          ),
          
          children: [
            Container(
              padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
              decoration: BoxDecoration(color: AppColors.elevation.withOpacity(0.5)),
              child: Column(
                children: cycle.logs.map((log) {
                  final cycleDay = log.date.difference(cycle.startDate).inDays + 1;
                  
                  return Padding(
                    padding: const EdgeInsets.only(bottom: 12.0),
                    child: Row(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Container(
                          width: 60,
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text("Day $cycleDay", style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.primaryLavender)),
                              Text(DateFormat('MMM d').format(log.date), style: TextStyle(fontSize: 10, color: AppColors.textMedium)),
                            ],
                          ),
                        ),
                        
                        Expanded(
                          child: Wrap(
                            spacing: 8,
                            runSpacing: 4,
                            children: [
                              if (log.flowIntensity != null)
                                _buildMicroTag(Feather.droplet, log.flowIntensity!, AppColors.error), // Feather
                              if (log.symptoms.isNotEmpty)
                                ...log.symptoms.map((s) => _buildMicroTag(Feather.activity, s, AppColors.primaryLavender)), // Feather
                              if (log.moods.isNotEmpty)
                                ...log.moods.map((m) => _buildMicroTag(Feather.smile, m, AppColors.accentMustard)), // Feather
                              if (log.sexualActivity)
                                _buildMicroTag(Feather.heart, "Intimacy", Colors.pink), // Feather
                              if (log.notes != null && log.notes!.isNotEmpty)
                                Padding(
                                  padding: const EdgeInsets.only(top: 4.0),
                                  child: Text(
                                    "\"${log.notes}\"",
                                    style: TextStyle(fontStyle: FontStyle.italic, fontSize: 12, color: AppColors.textMedium),
                                    maxLines: 2,
                                    overflow: TextOverflow.ellipsis,
                                  ),
                                ),
                            ],
                          ),
                        ),
                      ],
                    ),
                  );
                }).toList(),
              ),
            )
          ],
        ),
      ),
    );
  }

  Widget _buildCycleStat(String label, String value, bool isDeviation) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(value, style: TextStyle(
          fontWeight: FontWeight.bold, 
          fontSize: 14, 
          color: isDeviation ? AppColors.accentMustard : AppColors.textHigh
        )),
        Text(label, style: TextStyle(fontSize: 10, color: AppColors.textMedium)),
      ],
    );
  }

  Widget _buildMicroTag(IconData icon, String text, Color color) {
    return Container(
      padding: EdgeInsets.symmetric(horizontal: 6, vertical: 2),
      decoration: BoxDecoration(
        color: AppColors.surface,
        borderRadius: BorderRadius.circular(4),
        border: Border.all(color: AppColors.elevation)
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, size: 10, color: color),
          SizedBox(width: 4),
          Text(text, style: TextStyle(fontSize: 10, color: AppColors.textMedium)),
        ],
      ),
    );
  }

  // ---  Daily Log Sheet Widget ---

  void _showLogSheet(DateTime date) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => DraggableScrollableSheet(
        initialChildSize: 0.9,
        minChildSize: 0.5,
        maxChildSize: 0.95,
        builder: (_, controller) => Container(
          decoration: BoxDecoration(
            color: AppColors.backgroundDeep,
            borderRadius: BorderRadius.vertical(top: Radius.circular(25)),
          ),
          child: DailyLogSheet(
            date: date,
            onSave: (log) async {
              final uid = _auth.currentUser!.uid;
              final dateKey = DateTime(log.date.year, log.date.month, log.date.day);
              await _firestore
                  .collection('users')
                  .doc(uid)
                  .collection('cycle_logs')
                  .doc(dateKey.toIso8601String())
                  .set(log.toMap());
              
              await _loadData(); 
              Navigator.pop(context);
            },
          ),
        ),
      ),
    );
  }

  // ---  Settings Modal ---
  void _showSettingsModal() {
    showModalBottomSheet(
      context: context,
      backgroundColor: AppColors.surface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.vertical(top: Radius.circular(20))),
      builder: (context) {
        return StatefulBuilder(
          builder: (context, setModalState) {
            return Container(
              padding: EdgeInsets.all(20),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text("Cycle Settings", style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
                  SizedBox(height: 20),
                  
                  // Pregnancy Toggle
                  SwitchListTile(
                    title: Text("Pregnancy Mode", style: TextStyle(color: AppColors.textHigh)),
                    subtitle: Text("Pause period predictions", style: TextStyle(color: AppColors.textMedium)),
                    value: _isPregnancyMode,
                    activeColor: AppColors.primaryLavender,
                    onChanged: (val) {
                      setModalState(() => _isPregnancyMode = val);
                      setState(() => _isPregnancyMode = val);
                      final uid = _auth.currentUser!.uid;
                      _firestore.collection('users').doc(uid).collection('cycle_settings').doc('settings').set({
                        'isPregnancyMode': val,
                      }, SetOptions(merge: true));
                    },
                  ),
                  Divider(color: AppColors.elevation),
                  
                  // Custom Input for Cycle Length
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8.0),
                    child: Text("Average Cycle Length (Days)", style: TextStyle(color: AppColors.textMedium, fontSize: 12)),
                  ),
                  Container(
                    margin: EdgeInsets.symmetric(horizontal: 16),
                    padding: EdgeInsets.symmetric(horizontal: 12),
                    decoration: BoxDecoration(
                      color: AppColors.elevation,
                      borderRadius: BorderRadius.circular(12)
                    ),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        IconButton(
                          icon: Icon(Feather.minus, color: AppColors.primaryLavender),
                          onPressed: () {
                             if (_avgCycleLength > 20) {
                               setModalState(() => _avgCycleLength--);
                               setState(() => _avgCycleLength = _avgCycleLength);
                               _saveCycleLength(_avgCycleLength);
                             }
                          },
                        ),
                        Text("$_avgCycleLength", style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
                        IconButton(
                          icon: Icon(Feather.plus, color: AppColors.primaryLavender),
                          onPressed: () {
                             if (_avgCycleLength < 60) {
                               setModalState(() => _avgCycleLength++);
                               setState(() => _avgCycleLength = _avgCycleLength);
                               _saveCycleLength(_avgCycleLength);
                             }
                          },
                        ),
                      ],
                    ),
                  ),
                  SizedBox(height: 10),
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 16),
                    child: Text("Typical cycles range from 21 to 35 days.", style: TextStyle(color: AppColors.textDisabled, fontSize: 12, fontStyle: FontStyle.italic)),
                  ),
                  SizedBox(height: 20),
                  
                  // Toggle Lock
                  ListTile(
                    title: Text("App Lock", style: TextStyle(color: AppColors.textHigh)),
                    subtitle: Text("Enable PIN protection", style: TextStyle(color: AppColors.textMedium)),
                    trailing: Icon(Feather.lock, color: AppColors.primaryLavender),
                    onTap: () {
                       Navigator.pop(context);
                       _setupPin();
                    },
                  ),
                ],
              ),
            );
          }
        );
      }
    );
  }
  
  void _setupPin() {
    Navigator.push(
      context, 
      MaterialPageRoute(builder: (context) => PinScreen(
        mode: PinMode.setup, 
        onSuccess: () async {
          final uid = _auth.currentUser!.uid;
          await SecurityService.setLockEnabled(uid, true);
          Navigator.pop(context);
          ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Lock enabled")));
        }
      ))
    );
  }

  void _saveCycleLength(int length) {
    final uid = _auth.currentUser!.uid;
    _firestore.collection('users').doc(uid).collection('cycle_settings').doc('settings').set({
      'avgCycleLength': length,
    }, SetOptions(merge: true));
  }

  // ---  PDF Report ---
  Future<void> _generatePDFReport() async {
    final pdf = pw.Document();
    pdf.addPage(
      pw.Page(
        build: (pw.Context context) {
          return pw.Center(
            child: pw.Column(
              children: [
                pw.Text("Femn Cycle Report", style: pw.TextStyle(fontSize: 24, fontWeight: pw.FontWeight.bold)),
                pw.SizedBox(height: 20),
                pw.Table.fromTextArray(context: context, data: <List<String>>[
                  <String>['Date', 'Flow', 'Symptoms'],
                  ..._logsMap.values.map((l) => [
                    DateFormat('yyyy-MM-dd').format(l.date),
                    l.flowIntensity ?? '-',
                    l.symptoms.join(', ')
                  ]).toList()
                ]),
              ],
            )
          );
        },
      ),
    );
  }
}

// --- 5. Onboarding Wizard ---

class OnboardingWizard extends StatefulWidget {
  final VoidCallback onCompleted;
  OnboardingWizard({required this.onCompleted});

  @override
  _OnboardingWizardState createState() => _OnboardingWizardState();
}

class _OnboardingWizardState extends State<OnboardingWizard> {
  final PageController _controller = PageController();
  int _currentPage = 0;
  
  // Data to Collect
  DateTime _lastPeriod = DateTime.now();
  int _cycleLength = 28;
  int _periodLength = 5;
  bool _isRegular = true;
  bool _hormonalBirthControl = false;
  String _goal = "Track my cycle";
  bool _enablePin = false;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      body: SafeArea(
        child: Column(
          children: [
            // Progress Bar
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 24.0, vertical: 16),
              child: LinearProgressIndicator(
                value: (_currentPage + 1) / 4,
                backgroundColor: AppColors.elevation,
                color: AppColors.primaryLavender,
                minHeight: 6,
                borderRadius: BorderRadius.circular(3),
              ),
            ),
            
            Expanded(
              child: PageView(
                controller: _controller,
                physics: NeverScrollableScrollPhysics(), // Prevent swiping, force button use
                onPageChanged: (p) => setState(() => _currentPage = p),
                children: [
                  _buildStepBasics(),
                  _buildStepHistory(),
                  _buildStepGoals(),
                  _buildStepSecurity(),
                ],
              ),
            ),
            
            // Bottom Nav
            Padding(
              padding: const EdgeInsets.all(24.0),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  if (_currentPage > 0)
                    TextButton(
                      onPressed: () => _controller.previousPage(duration: Duration(milliseconds: 300), curve: Curves.ease),
                      child: Text("Back", style: TextStyle(color: AppColors.textMedium)),
                    )
                  else
                    SizedBox(),
                    
                  ElevatedButton(
                    onPressed: _handleNext,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryLavender,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(25)),
                      padding: EdgeInsets.symmetric(horizontal: 30, vertical: 12)
                    ),
                    child: Text(
                      _currentPage == 3 ? "Finish" : "Next", 
                      style: TextStyle(color: AppColors.backgroundDeep, fontWeight: FontWeight.bold)
                    ),
                  )
                ],
              ),
            )
          ],
        ),
      ),
    );
  }
  
  void _handleNext() async {
    if (_currentPage < 3) {
      _controller.nextPage(duration: Duration(milliseconds: 300), curve: Curves.ease);
    } else {
      // Save all data
      await _saveAndFinish();
    }
  }

  Future<void> _saveAndFinish() async {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return;
    
    // Save to Firestore
    await FirebaseFirestore.instance
        .collection('users')
        .doc(user.uid)
        .collection('cycle_settings')
        .doc('settings')
        .set({
          'lastPeriodStart': Timestamp.fromDate(_lastPeriod),
          'avgCycleLength': _cycleLength,
          'avgPeriodLength': _periodLength,
          'isRegular': _isRegular,
          'hormonalBirthControl': _hormonalBirthControl,
          'goal': _goal,
          'isPregnancyMode': false,
        });

    if (_enablePin) {
       // Navigate to PIN setup, then finish
       await Navigator.push(
         context, 
         MaterialPageRoute(builder: (context) => PinScreen(
           mode: PinMode.setup, 
           onSuccess: () async {
             await SecurityService.setLockEnabled(user.uid, true);
             Navigator.pop(context); // Close pin screen
           }
         ))
       );
    }
    
    widget.onCompleted();
  }

  // --- Step 1: Basics ---
  Widget _buildStepBasics() {
    return SingleChildScrollView(
      padding: EdgeInsets.symmetric(horizontal: 24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text("The Basics", style: TextStyle(fontSize: 28, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
          SizedBox(height: 10),
          Text("These are mandatory for accurate predictions.", style: TextStyle(color: AppColors.textMedium)),
          SizedBox(height: 30),
          
          Text("When did your last period start?", style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.textHigh)),
          SizedBox(height: 10),
          InkWell(
            onTap: () async {
              final d = await showDatePicker(
                context: context, 
                initialDate: _lastPeriod, 
                firstDate: DateTime(2020), 
                lastDate: DateTime.now(),
                builder: (context, child) {
                  return Theme(
                    data: Theme.of(context).copyWith(
                      colorScheme: ColorScheme.light(primary: AppColors.primaryLavender),
                    ),
                    child: child!,
                  );
                }
              );
              if (d != null) setState(() => _lastPeriod = d);
            },
            child: Container(
              padding: EdgeInsets.all(16),
              decoration: BoxDecoration(color: AppColors.elevation, borderRadius: BorderRadius.circular(12)),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(DateFormat.yMMMMd().format(_lastPeriod), style: TextStyle(color: AppColors.textHigh)),
                  Icon(Feather.calendar, color: AppColors.primaryLavender)
                ],
              ),
            ),
          ),
          
          SizedBox(height: 30),
          Text("Typical Cycle Length: $_cycleLength days", style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.textHigh)),
          Slider(
            value: _cycleLength.toDouble(),
            min: 21, max: 45, divisions: 24,
            activeColor: AppColors.primaryLavender,
            inactiveColor: AppColors.elevation,
            onChanged: (v) => setState(() => _cycleLength = v.toInt()),
          ),
          
          SizedBox(height: 10),
          Text("Typical Period Duration: $_periodLength days", style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.textHigh)),
          Slider(
            value: _periodLength.toDouble(),
            min: 1, max: 10, divisions: 9,
            activeColor: AppColors.secondaryTeal,
            inactiveColor: AppColors.elevation,
            onChanged: (v) => setState(() => _periodLength = v.toInt()),
          ),
        ],
      ),
    );
  }

  // --- Step 2: History ---
  Widget _buildStepHistory() {
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: 24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text("Context", style: TextStyle(fontSize: 28, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
          SizedBox(height: 10),
          Text("Help us filter outliers.", style: TextStyle(color: AppColors.textMedium)),
          SizedBox(height: 30),
          
          SwitchListTile(
            title: Text("Is your cycle regular?", style: TextStyle(color: AppColors.textHigh)),
            subtitle: Text("Doesn't vary by more than a few days", style: TextStyle(color: AppColors.textMedium, fontSize: 12)),
            value: _isRegular,
            activeColor: AppColors.primaryLavender,
            contentPadding: EdgeInsets.zero,
            onChanged: (v) => setState(() => _isRegular = v),
          ),
          Divider(color: AppColors.elevation),
          SwitchListTile(
            title: Text("Hormonal Birth Control?", style: TextStyle(color: AppColors.textHigh)),
            subtitle: Text("Pill, IUD, etc. (May affect predictions)", style: TextStyle(color: AppColors.textMedium, fontSize: 12)),
            value: _hormonalBirthControl,
            activeColor: AppColors.accentMustard,
            contentPadding: EdgeInsets.zero,
            onChanged: (v) => setState(() => _hormonalBirthControl = v),
          ),
        ],
      ),
    );
  }

  // --- Step 3: Goals ---
  Widget _buildStepGoals() {
    final goals = ["Track my cycle", "Track symptoms", "Get pregnant", "Avoid pregnancy"];
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: 24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text("Your Goal", style: TextStyle(fontSize: 28, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
          SizedBox(height: 30),
          ...goals.map((g) => RadioListTile(
            title: Text(g, style: TextStyle(color: AppColors.textHigh)),
            value: g,
            groupValue: _goal,
            activeColor: AppColors.primaryLavender,
            onChanged: (v) => setState(() => _goal = v.toString()),
          )).toList()
        ],
      ),
    );
  }
  
  // --- Step 4: Security ---
  Widget _buildStepSecurity() {
    return Padding(
      padding: EdgeInsets.symmetric(horizontal: 24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text("Privacy", style: TextStyle(fontSize: 28, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
          SizedBox(height: 10),
          Text("Keep your health data private.", style: TextStyle(color: AppColors.textMedium)),
          SizedBox(height: 30),
          
          Container(
            padding: EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: AppColors.surface,
              borderRadius: BorderRadius.circular(20),
              border: Border.all(color: _enablePin ? AppColors.primaryLavender : AppColors.elevation, width: 2)
            ),
            child: Column(
              children: [
                Icon(Feather.lock, size: 40, color: _enablePin ? AppColors.primaryLavender : AppColors.textDisabled),
                SizedBox(height: 20),
                SwitchListTile(
                  title: Text("Enable PIN Lock", style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.textHigh)),
                  subtitle: Text("Secure app entry", style: TextStyle(color: AppColors.textMedium)),
                  value: _enablePin,
                  activeColor: AppColors.primaryLavender,
                  onChanged: (v) => setState(() => _enablePin = v),
                )
              ],
            ),
          )
        ],
      ),
    );
  }
}

// ---  Daily Log Sheet Widget ---
class DailyLogSheet extends StatefulWidget {
  final DateTime date;
  final Function(DailyLog) onSave;

  DailyLogSheet({required this.date, required this.onSave});

  @override
  _DailyLogSheetState createState() => _DailyLogSheetState();
}

class _DailyLogSheetState extends State<DailyLogSheet> {
  String? _flow;
  List<String> _symptoms = [];
  List<String> _moods = [];
  bool _sexualActivity = false;
  bool _protected = false;
  TextEditingController _notesController = TextEditingController();

  final List<String> _flowOptions = ['Spotting', 'Light', 'Medium', 'Heavy', 'Clotting'];
  final List<String> _symptomOptions = ['Cramps', 'Headache', 'Bloating', 'Acne', 'Nausea'];
  final List<String> _moodOptions = ['Happy', 'Sad', 'Anxious', 'Irritable', 'Energetic'];

  @override
  Widget build(BuildContext context) {
    return ListView(
      padding: EdgeInsets.all(20),
      children: [
        Center(child: Container(width: 40, height: 4, decoration: BoxDecoration(color: AppColors.textDisabled, borderRadius: BorderRadius.circular(2)))),
        SizedBox(height: 20),
        Text("Log for ${DateFormat('MMM d').format(widget.date)}", style: TextStyle(fontSize: 22, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
        SizedBox(height: 20),
        
        _buildSectionHeader("Flow Intensity"),
        Wrap(
          spacing: 8,
          children: _flowOptions.map((f) => ChoiceChip(
            label: Text(f),
            selected: _flow == f,
            onSelected: (val) => setState(() => _flow = val ? f : null),
            selectedColor: AppColors.primaryLavender,
            backgroundColor: AppColors.elevation,
            labelStyle: TextStyle(color: _flow == f ? AppColors.backgroundDeep : AppColors.textHigh),
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20), side: BorderSide(color: AppColors.elevation)),
          )).toList(),
        ),

        SizedBox(height: 20),
        _buildSectionHeader("Symptoms"),
        Wrap(
          spacing: 8,
          children: _symptomOptions.map((s) => FilterChip(
            label: Text(s),
            selected: _symptoms.contains(s),
            onSelected: (val) => setState(() => val ? _symptoms.add(s) : _symptoms.remove(s)),
            selectedColor: AppColors.secondaryTeal,
            backgroundColor: AppColors.elevation,
            labelStyle: TextStyle(color: _symptoms.contains(s) ? Colors.white : AppColors.textHigh),
            checkmarkColor: Colors.white,
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20), side: BorderSide(color: AppColors.elevation)),
          )).toList(),
        ),

        SizedBox(height: 20),
        _buildSectionHeader("Mood"),
        Wrap(
          spacing: 8,
          children: _moodOptions.map((m) => FilterChip(
            label: Text(m),
            selected: _moods.contains(m),
            onSelected: (val) => setState(() => val ? _moods.add(m) : _moods.remove(m)),
            selectedColor: AppColors.accentMustard,
            backgroundColor: AppColors.elevation,
            labelStyle: TextStyle(color: _moods.contains(m) ? AppColors.backgroundDeep : AppColors.textHigh),
             shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20), side: BorderSide(color: AppColors.elevation)),
          )).toList(),
        ),

        SizedBox(height: 20),
        _buildSectionHeader("Intimacy"),
        SwitchListTile(
          title: Text("Sexual Activity", style: TextStyle(color: AppColors.textHigh)), 
          value: _sexualActivity, 
          activeColor: AppColors.primaryLavender, 
          onChanged: (val) => setState(() => _sexualActivity = val)
        ),
        if (_sexualActivity) CheckboxListTile(
          title: Text("Protected?", style: TextStyle(color: AppColors.textHigh)), 
          value: _protected, 
          activeColor: AppColors.primaryLavender, 
          onChanged: (val) => setState(() => _protected = val ?? false)
        ),

        SizedBox(height: 20),
        _buildSectionHeader("Notes"),
        TextField(
          controller: _notesController, 
          style: TextStyle(color: AppColors.textHigh),
          decoration: InputDecoration(
            hintText: "Add notes...", 
            hintStyle: TextStyle(color: AppColors.textDisabled),
            filled: true,
            fillColor: AppColors.elevation,
            border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none)
          ), 
          maxLines: 3
        ),

        SizedBox(height: 30),
        ElevatedButton(
          onPressed: () {
            final log = DailyLog(
              date: widget.date,
              flowIntensity: _flow,
              symptoms: _symptoms,
              moods: _moods,
              sexualActivity: _sexualActivity,
              protectedSex: _protected,
              notes: _notesController.text,
            );
            widget.onSave(log);
          },
          style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryLavender, shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)), padding: EdgeInsets.symmetric(vertical: 16)),
          child: Text("Save Log", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: AppColors.backgroundDeep)),
        ),
      ],
    );
  }

  Widget _buildSectionHeader(String title) {
    return Padding(padding: const EdgeInsets.only(bottom: 8.0), child: Text(title, style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: AppColors.textHigh)));
  }
}

// --- 6. PIN Screen ---

enum PinMode { setup, verify, unlock }

class PinScreen extends StatefulWidget {
  final PinMode mode;
  final VoidCallback onSuccess;

  PinScreen({required this.mode, required this.onSuccess});

  @override
  _PinScreenState createState() => _PinScreenState();
}

class _PinScreenState extends State<PinScreen> {
  String _input = "";
  String _tempPin = "";
  String _message = "Enter PIN";

  @override
  void initState() {
    super.initState();
    _updateMessage();
  }

  void _updateMessage() {
    setState(() {
      if (widget.mode == PinMode.setup) {
        _message = _tempPin.isEmpty ? "Create a 4-digit PIN" : "Confirm your PIN";
      } else if (widget.mode == PinMode.unlock) {
        _message = "Welcome Back";
      } else {
        _message = "Enter current PIN";
      }
    });
  }

  void _onKeyPress(String val) async {
    if (_input.length < 4) {
      setState(() => _input += val);
    }
    if (_input.length == 4) {
      _handleSubmit();
    }
  }

  void _handleSubmit() async {
    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid == null) return; // Should not happen in this flow

    if (widget.mode == PinMode.unlock || widget.mode == PinMode.verify) {
      bool isValid = await SecurityService.checkPin(uid, _input);
      if (isValid) {
        widget.onSuccess();
      } else {
        setState(() {
          _input = "";
          _message = "Incorrect PIN";
        });
      }
    } else if (widget.mode == PinMode.setup) {
      if (_tempPin.isEmpty) {
        setState(() {
          _tempPin = _input;
          _input = "";
          _updateMessage();
        });
      } else {
        if (_input == _tempPin) {
          await SecurityService.setPin(uid, _input);
          widget.onSuccess();
        } else {
          setState(() {
            _input = "";
            _tempPin = "";
            _message = "Mismatch. Start over.";
          });
        }
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      body: SafeArea(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Container(
              padding: EdgeInsets.all(20),
              decoration: BoxDecoration(color: AppColors.surface, shape: BoxShape.circle, boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.3), blurRadius: 20)]),
              child: Icon(Feather.lock, size: 40, color: AppColors.primaryLavender), // Feather
            ),
            SizedBox(height: 30),
            Text(_message, style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
            SizedBox(height: 30),
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: List.generate(4, (index) {
                return AnimatedContainer(
                  duration: Duration(milliseconds: 200),
                  margin: EdgeInsets.symmetric(horizontal: 12),
                  width: 16,
                  height: 16,
                  decoration: BoxDecoration(
                    shape: BoxShape.circle,
                    color: index < _input.length ? AppColors.primaryLavender : AppColors.elevation,
                  ),
                );
              }),
            ),
            SizedBox(height: 50),
            _buildNumPad(),
          ],
        ),
      ),
    );
  }

  Widget _buildNumPad() {
    return Container(
      width: 280,
      child: GridView.count(
        crossAxisCount: 3,
        shrinkWrap: true,
        mainAxisSpacing: 20,
        crossAxisSpacing: 20,
        childAspectRatio: 1.5,
        physics: NeverScrollableScrollPhysics(),
        children: [
          ...List.generate(9, (i) => _buildNumBtn("${i + 1}")),
          SizedBox(), 
          _buildNumBtn("0"),
          IconButton(
            icon: Icon(Feather.delete, color: AppColors.primaryLavender), // Feather delete
            onPressed: () {
              if (_input.isNotEmpty) setState(() => _input = _input.substring(0, _input.length - 1));
            },
          ),
        ],
      ),
    );
  }

  Widget _buildNumBtn(String val) {
    return GestureDetector(
      onTap: () => _onKeyPress(val),
      child: Container(
        decoration: BoxDecoration(shape: BoxShape.circle, color: AppColors.surface),
        child: Center(
          child: Text(val, style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: AppColors.textHigh)),
        ),
      ),
    );
  }
}

class CyclePhaseData {
  final String seasonName; // Winter, Spring, Summer, Autumn
  final String phaseName;  // Menstruation, Follicular, etc.
  final Color bgColor;
  final Color textColor;
  final IconData icon;

  CyclePhaseData({
    required this.seasonName,
    required this.phaseName,
    required this.bgColor,
    required this.textColor,
    required this.icon,
  });
}


--- C:\Code\femn\lib\wellness_widgets\tracker.dart ---

import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:flutter_staggered_grid_view/flutter_staggered_grid_view.dart';
import 'package:rxdart/rxdart.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:femn/customization/colors.dart'; // <--- IMPORT COLORS
import 'package:femn/widgets/femn_background.dart';

import '../circle/petitions.dart';
import '../circle/polls.dart';
import 'package:femn/customization/layout.dart';

class TrackerScreen extends StatefulWidget {
  @override
  _TrackerScreenState createState() => _TrackerScreenState();
}

class _TrackerScreenState extends State<TrackerScreen> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  late String _currentUserId;

  @override
  void initState() {
    super.initState();
    _currentUserId = _auth.currentUser!.uid;
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      body: FemnBackground(
        child: Column(
          children: [
            Padding(
              padding: const EdgeInsets.only(
                top: 60.0,
                left: 24,
                right: 24,
                bottom: 20,
              ),
              child: Row(
                children: [
                  GestureDetector(
                    onTap: () => Navigator.pop(context),
                    child: Container(
                      width: 42,
                      height: 42,
                      decoration: BoxDecoration(
                        color: AppColors.elevation,
                        shape: BoxShape.circle,
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withOpacity(0.1),
                            blurRadius: 8,
                            offset: Offset(0, 2),
                          ),
                        ],
                      ),
                      child: Icon(
                        Feather.arrow_left,
                        color: AppColors.textHigh,
                        size: 20,
                      ),
                    ),
                  ),
                  SizedBox(width: 16),
                  Text(
                    'Journey History',
                    style: TextStyle(
                      color: AppColors.textHigh,
                      fontSize: 22,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ],
              ),
            ),
            Expanded(
              child: Padding(
                padding: const EdgeInsets.symmetric(horizontal: 16.0),
                child: _buildAllTrackedItems(),
              ),
            ),
          ],
        ),
      ),
    );
  }

  // Add this method to your _TrackerScreenState class
  void showPetitionDetails(
    BuildContext context,
    Petition petition,
    bool isSigned,
  ) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) =>
            EnhancedPetitionDetailScreen(petitionId: petition.id),
      ),
    );
  }

  Widget _buildAllTrackedItems() {
    return StreamBuilder<List<DocumentSnapshot>>(
      stream: _getCombinedTrackedItemsStream(),
      builder: (context, snapshot) {
        // Handle loading state
        if (snapshot.connectionState == ConnectionState.waiting) {
          return Center(
            child: CircularProgressIndicator(color: AppColors.primaryLavender),
          );
        }

        // Handle errors
        if (snapshot.hasError) {
          print('Error loading tracked items: ${snapshot.error}');
          return _buildErrorState('Error loading tracked items');
        }

        final allTrackedItems = snapshot.data ?? [];

        print('Found ${allTrackedItems.length} total tracked items');

        if (allTrackedItems.isEmpty) {
          return _buildEmptyState(
            icon: Feather.target,
            title: 'No Tracked Items',
            subtitle:
                'Your created and interacted petitions and polls will appear here',
          );
        }

        return MasonryGridView.count(
          crossAxisCount: ResponsiveLayout.getColumnCount(context),
          mainAxisSpacing: 12,
          crossAxisSpacing: 12,
          itemCount: allTrackedItems.length,
          itemBuilder: (context, index) {
            final item = allTrackedItems[index];
            final itemType = item.reference.parent.id; // 'petitions' or 'polls'

            if (itemType == 'petitions') {
              final petition = Petition.fromDocument(item);
              final isCreated = petition.createdBy == _currentUserId;
              return _buildPetitionTrackerCard(petition, isCreated);
            } else if (itemType == 'polls') {
              final pollData = item.data() as Map<String, dynamic>;
              final isCreated = pollData['createdBy'] == _currentUserId;
              return _buildPollTrackerCard(item, isCreated);
            } else {
              return Container(); // Fallback
            }
          },
        );
      },
    );
  }

  Stream<List<DocumentSnapshot>> _getCombinedTrackedItemsStream() {
    // Define Firestore queries
    final createdPetitionsStream = _firestore
        .collection('petitions')
        .where('createdBy', isEqualTo: _currentUserId)
        .snapshots();

    final signedPetitionsStream = _firestore
        .collection('petitions')
        .where('signers', arrayContains: _currentUserId)
        .snapshots();

    final createdPollsStream = _firestore
        .collection('polls')
        .where('createdBy', isEqualTo: _currentUserId)
        .snapshots();

    final votedPollsStream = _firestore
        .collection('polls')
        .where('voters', arrayContains: _currentUserId)
        .snapshots();

    // Combine all four streams manually
    return Rx.combineLatest4<
      QuerySnapshot,
      QuerySnapshot,
      QuerySnapshot,
      QuerySnapshot,
      List<DocumentSnapshot>
    >(
      createdPetitionsStream,
      signedPetitionsStream,
      createdPollsStream,
      votedPollsStream,
      (createdPetitions, signedPetitions, createdPolls, votedPolls) {
        final allItems = <DocumentSnapshot>[];
        final seenIds = <String>{};

        void addDocs(List<DocumentSnapshot> docs, String prefix) {
          for (final doc in docs) {
            final id = '${prefix}_${doc.id}';
            if (!seenIds.contains(id)) {
              seenIds.add(id);
              allItems.add(doc);
            }
          }
        }

        addDocs(createdPetitions.docs, 'petition');
        addDocs(signedPetitions.docs, 'petition');
        addDocs(createdPolls.docs, 'poll');
        addDocs(votedPolls.docs, 'poll');

        // Sort newest first
        allItems.sort((a, b) {
          final aData = a.data() as Map<String, dynamic>;
          final bData = b.data() as Map<String, dynamic>;
          final aTime = aData['createdAt'] as Timestamp;
          final bTime = bData['createdAt'] as Timestamp;
          return bTime.compareTo(aTime);
        });

        return allItems;
      },
    );
  }

  Widget _buildPetitionTrackerCard(Petition petition, bool isCreated) {
    final progress = petition.goal > 0
        ? petition.currentSignatures / petition.goal
        : 0.0;
    final progressPercent = (progress * 100).toInt();

    return Card(
      margin: EdgeInsets.zero,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      color: AppColors.surface, // Surface Color
      elevation: 2,
      child: InkWell(
        onTap: () {
          showPetitionDetails(
            context,
            petition,
            petition.signers.contains(_currentUserId),
          );
        },
        borderRadius: BorderRadius.circular(16),
        child: Padding(
          padding: const EdgeInsets.all(12.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Badge for created/signed
              Container(
                padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  // Lavender for Created, Teal for Signed
                  color: isCreated
                      ? AppColors.primaryLavender
                      : AppColors.secondaryTeal,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(
                  isCreated ? 'CREATED' : 'SIGNED',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 10,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
              SizedBox(height: 8),

              // Banner image
              if (petition.bannerImageUrl != null &&
                  petition.bannerImageUrl!.isNotEmpty)
                ClipRRect(
                  borderRadius: BorderRadius.circular(8),
                  child: CachedNetworkImage(
                    imageUrl: petition.bannerImageUrl!,
                    height: 80,
                    width: double.infinity,
                    fit: BoxFit.cover,
                    placeholder: (context, url) =>
                        Container(color: AppColors.elevation, height: 80),
                    errorWidget: (context, url, error) => Container(
                      color: AppColors.elevation,
                      height: 80,
                      child: Icon(Feather.alert_circle, color: AppColors.error),
                    ),
                  ),
                ),

              SizedBox(height: 8),

              // Title
              Text(
                petition.title.length > 30
                    ? '${petition.title.substring(0, 30)}...'
                    : petition.title,
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  fontSize: 14,
                  color: AppColors.textHigh, // Off-white
                ),
                maxLines: 2,
                overflow: TextOverflow.ellipsis,
              ),

              SizedBox(height: 6),

              // Progress bar
              LinearProgressIndicator(
                value: progress,
                backgroundColor: AppColors.elevation,
                color: AppColors.secondaryTeal,
                minHeight: 6,
                borderRadius: BorderRadius.circular(3),
              ),

              SizedBox(height: 6),

              // Progress text
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    '$progressPercent%',
                    style: TextStyle(
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                      color: AppColors.secondaryTeal,
                    ),
                  ),
                  Text(
                    '${petition.currentSignatures}/${petition.goal}',
                    style: TextStyle(fontSize: 12, color: AppColors.textMedium),
                  ),
                ],
              ),

              SizedBox(height: 6),

              // Days ago
              Text(
                _getDaysAgo(petition.createdAt),
                style: TextStyle(fontSize: 10, color: AppColors.textDisabled),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildPollTrackerCard(DocumentSnapshot pollSnapshot, bool isCreated) {
    final pollData = pollSnapshot.data() as Map<String, dynamic>;
    final String question = pollData['question'] ?? '';
    final List<dynamic> options = pollData['options'] ?? [];
    final int totalVotes = pollData['totalVotes'] ?? 0;
    final List<dynamic> voters = pollData['voters'] ?? [];
    final Timestamp createdAt = pollData['createdAt'] ?? Timestamp.now();
    final Timestamp? expiresAt = pollData['expiresAt'];

    // Check if user has voted
    bool hasVoted = false;
    for (var voter in voters) {
      if (voter is Map<String, dynamic> && voter['userId'] == _currentUserId) {
        hasVoted = true;
        break;
      }
    }

    // Calculate days left
    int? daysLeft;
    if (expiresAt != null) {
      final now = DateTime.now();
      final expiration = expiresAt.toDate();
      daysLeft = expiration.difference(now).inDays;
      if (daysLeft < 0) daysLeft = 0;
    }

    return Card(
      margin: EdgeInsets.zero,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      color: AppColors.surface, // Surface Color
      elevation: 2,
      child: InkWell(
        onTap: () {
          // _showPollDetails(context, pollSnapshot);
        },
        borderRadius: BorderRadius.circular(16),
        child: Padding(
          padding: const EdgeInsets.all(12.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Badge for created/voted
              Container(
                padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  // Lavender (Created), Teal (Voted), Mustard (Tracking)
                  color: isCreated
                      ? AppColors.primaryLavender
                      : (hasVoted
                            ? AppColors.secondaryTeal
                            : AppColors.accentMustard),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(
                  isCreated ? 'CREATED' : (hasVoted ? 'VOTED' : 'TRACKING'),
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 10,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
              SizedBox(height: 8),

              // Poll icon or first option image
              Container(
                height: 80,
                width: double.infinity,
                decoration: BoxDecoration(
                  color: AppColors.elevation,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: _buildPollImage(options),
              ),

              SizedBox(height: 8),

              // Question
              Text(
                question.length > 30
                    ? '${question.substring(0, 30)}...'
                    : question,
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  fontSize: 14,
                  color: AppColors.textHigh,
                ),
                maxLines: 2,
                overflow: TextOverflow.ellipsis,
              ),

              SizedBox(height: 6),

              // Votes info
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Icon(
                    Feather.bar_chart_2,
                    size: 16,
                    color: AppColors.primaryLavender,
                  ),
                  Text(
                    '$totalVotes votes',
                    style: TextStyle(
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                      color: AppColors.primaryLavender,
                    ),
                  ),
                ],
              ),

              SizedBox(height: 6),

              // Options count
              Text(
                '${options.length} options',
                style: TextStyle(fontSize: 12, color: AppColors.textMedium),
              ),

              SizedBox(height: 6),

              // Days info
              if (daysLeft != null && daysLeft > 0)
                Text(
                  '$daysLeft days left',
                  style: TextStyle(fontSize: 10, color: AppColors.textDisabled),
                )
              else if (daysLeft == 0)
                Text(
                  'Ended today',
                  style: TextStyle(fontSize: 10, color: AppColors.error),
                )
              else
                Text(
                  _getDaysAgo(createdAt),
                  style: TextStyle(fontSize: 10, color: AppColors.textDisabled),
                ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildPollImage(List<dynamic> options) {
    // Try to find the first option with an image
    for (var option in options) {
      if (option is Map<String, dynamic> &&
          option['imageUrl'] != null &&
          option['imageUrl'].isNotEmpty) {
        return ClipRRect(
          borderRadius: BorderRadius.circular(8),
          child: CachedNetworkImage(
            imageUrl: option['imageUrl'],
            height: 80,
            width: double.infinity,
            fit: BoxFit.cover,
            placeholder: (context, url) =>
                Container(color: AppColors.elevation),
            errorWidget: (context, url, error) => Container(
              color: AppColors.elevation,
              child: Icon(
                Feather.bar_chart_2,
                color: AppColors.primaryLavender,
              ),
            ),
          ),
        );
      }
    }

    // Fallback to poll icon
    return Center(
      child: Icon(
        Feather.bar_chart_2,
        size: 40,
        color: AppColors.primaryLavender,
      ),
    );
  }

  String _getDaysAgo(Timestamp createdAt) {
    final now = DateTime.now();
    final created = createdAt.toDate();
    final difference = now.difference(created);

    if (difference.inDays == 0) {
      return 'today';
    } else if (difference.inDays == 1) {
      return '1 day ago';
    } else {
      return '${difference.inDays} days ago';
    }
  }

  Widget _buildEmptyState({
    required IconData icon,
    required String title,
    required String subtitle,
  }) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(icon, size: 64, color: AppColors.textDisabled),
          SizedBox(height: 16),
          Text(
            title,
            style: TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.bold,
              color: AppColors.primaryLavender,
            ),
          ),
          SizedBox(height: 8),
          Text(
            subtitle,
            textAlign: TextAlign.center,
            style: TextStyle(color: AppColors.textMedium),
          ),
        ],
      ),
    );
  }

  Widget _buildErrorState(String message) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Feather.alert_circle,
            size: 64,
            color: AppColors.error.withOpacity(0.5),
          ),
          SizedBox(height: 16),
          Text(
            'Oops!',
            style: TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.bold,
              color: AppColors.error,
            ),
          ),
          SizedBox(height: 8),
          Text(
            message,
            textAlign: TextAlign.center,
            style: TextStyle(color: AppColors.textMedium),
          ),
          SizedBox(height: 16),
          ElevatedButton(
            onPressed: () {
              setState(() {});
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: AppColors.primaryLavender,
              foregroundColor: AppColors.backgroundDeep,
            ),
            child: Text('Retry'),
          ),
        ],
      ),
    );
  }
}


--- C:\Code\femn\lib\wellness_widgets\twin_finder.dart ---

import 'dart:async';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:femn/customization/colors.dart'; 
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/material.dart';
import 'package:flutter_animate/flutter_animate.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:percent_indicator/linear_percent_indicator.dart';
import 'twin_finder_engine.dart';

class TwinFinderScreen extends StatefulWidget {
  @override
  _TwinFinderScreenState createState() => _TwinFinderScreenState();
}

class _TwinFinderScreenState extends State<TwinFinderScreen> {
  // Logic Engine
  final TwinFinderEngine _engine = TwinFinderEngine();
  
  // State
  bool _isLoading = true;
  bool _isFinished = false;
  bool _isCalculating = false; // "Fake" loading phase
  bool _checkingExisting = true; 

  // Result Data
  String? _resultArchetype;
  String? _resultTitle;
  String? _resultDescription;
  int? _resultColor; // Stored as int from hex string

  // Progress for "Calculating" screen
  double _calcProgress = 0.0;
  String _calcStatus = "Analyzing Cognitive Stack...";

  @override
  void initState() {
    super.initState();
    _checkExistingResult();
  }

  Future<void> _checkExistingResult() async {
    final uid = FirebaseAuth.instance.currentUser!.uid;
    try {
      final doc = await FirebaseFirestore.instance.collection('users').doc(uid).get();
      if (doc.exists && doc.data()!.containsKey('personalityType')) {
        final data = doc.data()!;
        _loadResult(data);
      } else {
        await _startSession();
      }
    } catch (e) {
      await _startSession();
    }
  }

  void _loadResult(Map<String, dynamic> data) {
      setState(() {
          _resultArchetype = data['personalityType'];
          _resultTitle = data['personalityTitle'];
          _resultDescription = data['personalityDesc'];
          // Fallback legacy calculation for color if missing
          if (data['personalityColor'] != null) {
              _resultColor = data['personalityColor'];
          } else {
             _resultColor = int.parse("0xFF805da1"); // Default Purple
          }

          _isFinished = true;
          _checkingExisting = false;
          _isLoading = false;
        });
  }

  Future<void> _startSession() async {
    setState(() => _checkingExisting = false);
    await _engine.loadQuestions();
    _engine.startSession();
    setState(() => _isLoading = false);
  }

  void _handleAnswer(int value) async {
    _engine.setAnswer(value);
    
    // Auto-advance logic
    Future.delayed(Duration(milliseconds: 250), () {
        _goNext();
    });
    setState(() {});
  }

  void _goNext() {
      // If we are at the end...
      if (_engine.currentIndex >= _engine.totalQuestions - 1) {
          // Check if answered?
          if (_engine.currentAnswer != null) {
              _startCalculationSequence();
          }
      } else {
          _engine.nextQuestion();
          setState(() {});
      }
  }

  void _goBack() {
      _engine.previousQuestion();
      setState(() {});
  }

  // --- CALCULATING SEQUENCE ---
  void _startCalculationSequence() async {
      setState(() {
          _isCalculating = true;
      });

      // Simulate steps
      final steps = [
          "Analyzing Cognitive Functions...",
          "Mapping Dominant Traits...",
          "Resolving Paradoxes...",
          "Finalizing Archetype..."
      ];

      for (int i = 0; i < steps.length; i++) {
          await Future.delayed(Duration(milliseconds: 800));
          if (!mounted) return;
          setState(() {
              _calcStatus = steps[i];
              _calcProgress = (i + 1) / steps.length;
          });
      }

       await Future.delayed(Duration(milliseconds: 500));
       if (!mounted) return;

       final result = _engine.calculateResult();
       _finishTest(result);
  }

  Future<void> _finishTest(Map<String, dynamic> resultData) async {
    final uid = FirebaseAuth.instance.currentUser!.uid;
    
    // Parse Color
    int colorInt = int.parse(resultData['color']);

    // Save to Firestore
    await FirebaseFirestore.instance.collection('users').doc(uid).update({
      'personalityType': resultData['archetype'],
      'personalityTitle': resultData['title'],
      'personalityDesc': resultData['description'],
      'personalityColor': colorInt,
      'personalityTestDate': DateTime.now(),
      'showPersonality': true, 
    });

    setState(() {
      _isCalculating = false;
      _isFinished = true;
      _resultArchetype = resultData['archetype'];
      _resultTitle = resultData['title'];
      _resultDescription = resultData['description'];
      _resultColor = colorInt;
    });
  }

  Future<void> _retakeTest() async {
    setState(() {
      _isLoading = true;
      _isFinished = false;
    });
    final uid = FirebaseAuth.instance.currentUser!.uid;
    await FirebaseFirestore.instance.collection('users').doc(uid).update({
      'personalityType': FieldValue.delete(),
    });
    _engine.startSession();
    setState(() => _isLoading = false);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent, // Assumes background from parent or stack
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(
          icon: Icon(Feather.x, color: AppColors.textMedium),
          onPressed: () => Navigator.pop(context),
        ),
        title: Text(
          "Twin Finder",
          style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold),
        ),
        centerTitle: true,
      ),
      body: SafeArea(
        child: _buildBody(),
      ),
    );
  }

  Widget _buildBody() {
      if (_checkingExisting) {
          return Center(child: CircularProgressIndicator(color: AppColors.primaryLavender));
      }
      if (_isCalculating) {
          return _buildCalculatingView();
      }
      if (_isFinished) {
          return _buildResultView();
      }
      return _buildQuizView();
  }

  // --- LOADING VIEW ---
  Widget _buildCalculatingView() {
      return Center(
          child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                  Stack(
                      alignment: Alignment.center,
                      children: [
                          SizedBox(
                              width: 100,
                              height: 100,
                              child: CircularProgressIndicator(
                                  value: _calcProgress,
                                  color: AppColors.secondaryTeal,
                                  backgroundColor: AppColors.elevation,
                                  strokeWidth: 8,
                              ),
                          ),
                          Icon(Feather.cpu, color: AppColors.textHigh, size: 32)
                              .animate(onPlay: (c) => c.repeat())
                              .fadeIn(duration: 600.ms)
                              .then().fadeOut(duration: 600.ms),
                      ],
                  ),
                  SizedBox(height: 32),
                  Text(
                      _calcStatus,
                      style: TextStyle(color: AppColors.textHigh, fontSize: 16, fontWeight: FontWeight.bold),
                  ).animate().slideY(begin: 0.1, end: 0),
                  SizedBox(height: 8),
                  Text(
                      "${(_calcProgress * 100).toInt()}% Complete",
                      style: TextStyle(color: AppColors.textMedium, fontSize: 12),
                  ),
              ],
          ),
      );
  }

  // --- QUIZ VIEW ---
  Widget _buildQuizView() {
    if (_isLoading) return Center(child: CircularProgressIndicator(color: AppColors.primaryLavender));

    final question = _engine.currentQuestion;
    if (question == null) return SizedBox();

    return Column(
      children: [
        Expanded(
          child: Padding(
            key: ValueKey(question['id']), // Animate on change
            padding: const EdgeInsets.symmetric(horizontal: 24.0),
            child: Column(
              children: [
                SizedBox(height: 10),
                LinearPercentIndicator(
                  lineHeight: 8.0,
                  percent: _engine.progress.clamp(0.0, 1.0),
                  backgroundColor: AppColors.elevation,
                  progressColor: AppColors.secondaryTeal,
                  barRadius: Radius.circular(10),
                  animation: true,
                  animateFromLastPercent: true,
                ),
                SizedBox(height: 10),
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 8.0),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Text(
                        "Question ${_engine.currentIndex + 1}/${_engine.totalQuestions}",
                        style: TextStyle(color: AppColors.textDisabled, fontSize: 12),
                      ),
                      Text(
                        question['category'] ?? "General",
                        style: TextStyle(color: AppColors.primaryLavender, fontSize: 12, fontWeight: FontWeight.bold),
                      ),
                    ],
                  ),
                ),
                Spacer(),
                // Question Card
                Container(
                  padding: EdgeInsets.all(24),
                  decoration: BoxDecoration(
                    color: AppColors.surface,
                    borderRadius: BorderRadius.circular(24),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.2),
                        blurRadius: 15,
                        offset: Offset(0, 5),
                      )
                    ],
                    border: Border.all(color: AppColors.elevation),
                  ),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Text(
                        question['text'],
                        textAlign: TextAlign.center,
                        style: TextStyle(
                          color: AppColors.textHigh,
                          fontSize: 20,
                          fontWeight: FontWeight.bold,
                          height: 1.3,
                        ),
                      ),
                    ],
                  ),
                ).animate().fadeIn(duration: 400.ms).slideY(begin: 0.1, end: 0),
                Spacer(),
                _buildSpectrumOptions(question),
                Spacer(),
              ],
            ),
          ),
        ),
        
        // --- BOTTOM NAVIGATION BAR ---
        Container(
            padding: EdgeInsets.symmetric(horizontal: 24, vertical: 16),
            decoration: BoxDecoration(
                color: AppColors.surface,
                border: Border(top: BorderSide(color: AppColors.elevation)),
            ),
            child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                    // Previous Button
                     Opacity(
                        opacity: _engine.canGoBack ? 1.0 : 0.3,
                        child: TextButton.icon(
                            icon: Icon(Feather.chevron_left, color: AppColors.textMedium),
                            label: Text("Previous", style: TextStyle(color: AppColors.textMedium)),
                            onPressed: _engine.canGoBack ? _goBack : null,
                        ),
                     ),

                     // Indicator dots or simple spacer
                     Row(
                         children: [
                             Container(width: 6, height: 6, decoration: BoxDecoration(shape: BoxShape.circle, color: _engine.currentAnswer != null ? AppColors.secondaryTeal : AppColors.elevation)),
                             SizedBox(width: 4),
                             Container(width: 6, height: 6, decoration: BoxDecoration(shape: BoxShape.circle, color: AppColors.elevation)),
                         ],
                     ),

                    // Next Button
                    Opacity(
                        opacity: (_engine.currentAnswer != null) ? 1.0 : 0.3, 
                        child: Directionality(
                            textDirection: TextDirection.rtl,
                            child: TextButton.icon(
                                icon: Icon(Feather.chevron_right, color: AppColors.primaryLavender),
                                label: Text("Next", style: TextStyle(color: AppColors.primaryLavender, fontWeight: FontWeight.bold)),
                                onPressed: (_engine.currentAnswer != null) ? _goNext : null,
                            ),
                        ),
                    ),
                ],
            ),
        ),
      ],
    );
  }

  Widget _buildSpectrumOptions(Map<String, dynamic> question) {
      int? selected = _engine.currentAnswer;

    return Column(
      children: [
        Text(
          question['optionA']['text'].toUpperCase(),
          textAlign: TextAlign.center,
          style: TextStyle(color: AppColors.secondaryTeal, fontWeight: FontWeight.bold, letterSpacing: 0.5, fontSize: 11),
        ),
        SizedBox(height: 20),
        Container(
          height: 80,
          child: Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              _buildSpectrumButton(0, Colors.teal, 60, selected == 0), 
              _buildSpectrumButton(1, Colors.teal.withOpacity(0.6), 45, selected == 1),
              _buildSpectrumButton(2, AppColors.primaryLavender.withOpacity(0.6), 45, selected == 2), 
              _buildSpectrumButton(3, AppColors.primaryLavender, 60, selected == 3),
            ],
          ),
        ),
        SizedBox(height: 20),
        Text(
          question['optionB']['text'].toUpperCase(),
          textAlign: TextAlign.center,
          style: TextStyle(color: AppColors.primaryLavender, fontWeight: FontWeight.bold, letterSpacing: 0.5, fontSize: 11),
        ),
      ],
    );
  }

  Widget _buildSpectrumButton(int value, Color color, double size, bool isSelected) {
    return GestureDetector(
      onTap: () => _handleAnswer(value),
      child: AnimatedContainer(
        duration: Duration(milliseconds: 200),
        width: isSelected ? size * 1.2 : size,
        height: isSelected ? size * 1.2 : size,
        decoration: BoxDecoration(
          shape: BoxShape.circle,
          color: AppColors.elevation,
          border: Border.all(color: isSelected ? Colors.white : color, width: isSelected ? 3 : 2),
          boxShadow: [
            BoxShadow(color: color.withOpacity(0.2), blurRadius: 10, spreadRadius: 1)
          ]
        ),
        child: Center(
          child: AnimatedContainer(
            duration: Duration(milliseconds: 200),
            width: isSelected ? size * 0.6 : size * 0.4,
            height: isSelected ? size * 0.6 : size * 0.4,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              color: color,
            ),
            child: isSelected ? Icon(Feather.check, color: Colors.white, size: 16) : null,
          ),
        ),
      ),
    );
  }

  // --- RESULT VIEW ---
  Widget _buildResultView() {
    Color coreColor = Color(_resultColor ?? 0xFF805da1);

    return SingleChildScrollView(
        child: Padding(
            padding: const EdgeInsets.all(24.0),
            child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                    SizedBox(height: 40),
                    Icon(Feather.check_circle, size: 80, color: coreColor)
                        .animate().scale(duration: 500.ms, curve: Curves.elasticOut),
                    SizedBox(height: 24),
                    Text(
                        "Personality Analysis Complete",
                        style: TextStyle(color: AppColors.textMedium, fontSize: 14, letterSpacing: 1.5),
                    ),
                    SizedBox(height: 12),
                    Text(
                        "You are The ${_resultTitle ?? '...'}",
                        style: TextStyle(color: AppColors.textHigh, fontSize: 26, fontWeight: FontWeight.bold),
                        textAlign: TextAlign.center,
                    ),
                    SizedBox(height: 12),
                    Container(
                        padding: EdgeInsets.symmetric(horizontal: 20, vertical: 10),
                        decoration: BoxDecoration(
                            color: coreColor.withOpacity(0.2),
                            borderRadius: BorderRadius.circular(20),
                            border: Border.all(color: coreColor.withOpacity(0.5))
                        ),
                        child: Text(
                            _resultArchetype ?? "",
                            style: TextStyle(color: coreColor, fontWeight: FontWeight.bold, letterSpacing: 2.0, fontSize: 22),
                        ),
                    ),
                    SizedBox(height: 32),
                    
                    // Main Description Card
                    Container(
                        padding: EdgeInsets.all(24),
                        decoration: BoxDecoration(
                            color: AppColors.surface,
                            borderRadius: BorderRadius.circular(16),
                            border: Border.all(color: AppColors.elevation),
                        ),
                        child: Column(
                            children: [
                                Icon(Feather.align_left, color: coreColor, size: 24),
                                SizedBox(height: 16),
                                Text(
                                    _resultDescription ?? "",
                                    textAlign: TextAlign.justify,
                                    style: TextStyle(
                                        color: AppColors.textHigh, 
                                        fontSize: 15,
                                        height: 1.6,
                                        fontFamily: 'Roboto'
                                    ),
                                ),
                            ],
                        ),
                    ),
                    
                    SizedBox(height: 40),
                    
                    // DONE BUTTON
                    SizedBox(
                        width: double.infinity,
                        child: ElevatedButton(
                            onPressed: () => Navigator.pop(context),
                            style: ElevatedButton.styleFrom(
                                backgroundColor: coreColor,
                                padding: EdgeInsets.symmetric(vertical: 20),
                                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                            ),
                            child: Text(
                                "Close Analysis", 
                                style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)
                            ),
                        ),
                    ),

                    SizedBox(height: 16),
                    
                    TextButton(
                        onPressed: _retakeTest,
                        child: Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                                Icon(Feather.refresh_ccw, size: 14, color: AppColors.textMedium),
                                SizedBox(width: 8),
                                Text("Retake Test", style: TextStyle(color: AppColors.textMedium)),
                            ],
                        ),
                    ),
                    SizedBox(height: 20),
                ],
            ),
        ),
    );
  }
}


--- C:\Code\femn\lib\wellness_widgets\twin_finder_engine.dart ---

import 'dart:convert';
import 'package:flutter/services.dart';
import 'package:flutter/material.dart';

class TwinFinderEngine {
  List<Map<String, dynamic>> _allQuestions = [];
  
  // Session State
  List<Map<String, dynamic>> _sessionQuestions = [];
  List<int?> _userAnswers = []; 
  
  int _currentIndex = 0;
  int get currentIndex => _currentIndex;
  int get totalQuestions => _sessionQuestions.length;

  Future<void> loadQuestions() async {
    try {
      final String response = await rootBundle.loadString('assets/data/twin_finder_questions.json');
      final List<dynamic> data = jsonDecode(response);
      _allQuestions = data.cast<Map<String, dynamic>>();
      _allQuestions.shuffle(); // Randomize order
    } catch (e) {
      print("Error loading Twin Finder questions: $e");
    }
  }

  void startSession({int limit = 25}) {
    _currentIndex = 0;
    if (limit > _allQuestions.length) limit = _allQuestions.length;
    _sessionQuestions = _allQuestions.take(limit).toList();
    _userAnswers = List.filled(limit, null);
  }

  Map<String, dynamic>? get currentQuestion {
    if (_currentIndex < _sessionQuestions.length) {
      return _sessionQuestions[_currentIndex];
    }
    return null;
  }

  bool get isFinished => _currentIndex >= _sessionQuestions.length;
  double get progress => _currentIndex / _sessionQuestions.length;
  bool get canGoBack => _currentIndex > 0;
  bool get canGoForward => _currentIndex < _sessionQuestions.length - 1;

  // returns true if test is finished
  bool nextQuestion() {
    if (_currentIndex < _sessionQuestions.length - 1) {
      _currentIndex++;
      return false;
    }
    return true; // We are at the end
  }

  void previousQuestion() {
    if (_currentIndex > 0) {
      _currentIndex--;
    }
  }

  void setAnswer(int value) {
    if (_currentIndex < _userAnswers.length) {
      _userAnswers[_currentIndex] = value;
    }
  }

  int? get currentAnswer {
      if (_currentIndex < _userAnswers.length) {
      return _userAnswers[_currentIndex];
    }
    return null;
  }

  Map<String, dynamic> calculateResult() {
    // 1. Tally Scores based on _userAnswers
    Map<String, int> scores = {
      "Ni": 0, "Ne": 0, "Si": 0, "Se": 0,
      "Ti": 0, "Te": 0, "Fi": 0, "Fe": 0
    };

    for (int i = 0; i < _sessionQuestions.length; i++) {
        final ans = _userAnswers[i];
        if (ans == null) continue; // Should not happen in completed test
        
        final q = _sessionQuestions[i];
        final optionA = q['optionA'];
        final optionB = q['optionB'];
        
        // value 0: Strong A, 1: Slight A, 2: Slight B, 3: Strong B
        if (ans == 0 || ans == 1) {
             _addScores(scores, optionA['functions'], ans == 0 ? 2 : 1);
        } else {
             _addScores(scores, optionB['functions'], ans == 3 ? 2 : 1);
        }
    }

    // 2. Identify Dominant Function
    var sortedFunctions = scores.entries.toList()
      ..sort((a, b) => b.value.compareTo(a.value));
    
    final dom = sortedFunctions[0].key;
    final aux = _findAuxiliary(dom, sortedFunctions);
    
    final archetype = _deriveArchetype(dom, aux);
    
    return {
      "archetype": archetype,
      "title": _getArchetypeTitle(archetype),
      "description": _getArchetypeDescription(archetype),
      "color": _getArchetypeColor(archetype),
      "scores": scores.toString() 
    };
  }

  void _addScores(Map<String, int> scores, Map<String, dynamic>? impact, int weight) {
    if (impact == null) return;
    impact.forEach((func, points) {
      if (scores.containsKey(func)) {
        scores[func] = scores[func]! + (points as int) * weight;
      }
    });
  }

  String _findAuxiliary(String dom, List<MapEntry<String, int>> sorted) {
    bool isDomIntroverted = dom.endsWith('i');
    bool isDomJudging = dom.startsWith('T') || dom.startsWith('F');

    for (var entry in sorted) {
      if (entry.key == dom) continue;
      
      bool isAuxIntroverted = entry.key.endsWith('i');
      bool isAuxJudging = entry.key.startsWith('T') || entry.key.startsWith('F');

      if (isDomIntroverted == isAuxIntroverted) continue;
      if (isDomJudging == isAuxJudging) continue;

      return entry.key;
    }
    
    return sorted[1].key; 
  }

  String _deriveArchetype(String dom, String aux) {
    if (dom == "Ni" && (aux == "Te" || aux == "Ti")) return "INTJ"; 
    if (dom == "Ni" && (aux == "Fe" || aux == "Fi")) return "INFJ";
    if (dom == "Ne" && (aux == "Ti" || aux == "Te")) return "ENTP";
    if (dom == "Ne" && (aux == "Fi" || aux == "Fe")) return "ENFP";
    
    if (dom == "Si" && (aux == "Te" || aux == "Ti")) return "ISTJ";
    if (dom == "Si" && (aux == "Fe" || aux == "Fi")) return "ISFJ";
    if (dom == "Se" && (aux == "Ti" || aux == "Te")) return "ESTP";
    if (dom == "Se" && (aux == "Fi" || aux == "Fe")) return "ESFP";

    if (dom == "Ti" && (aux == "Ne" || aux == "Ni")) return "INTP";
    if (dom == "Ti" && (aux == "Se" || aux == "Si")) return "ISTP";
    if (dom == "Fi" && (aux == "Ne" || aux == "Ni")) return "INFP";
    if (dom == "Fi" && (aux == "Se" || aux == "Si")) return "ISFP";

    if (dom == "Te" && (aux == "Ni" || aux == "Ne")) return "ENTJ";
    if (dom == "Te" && (aux == "Si" || aux == "Se")) return "ESTJ";
    if (dom == "Fe" && (aux == "Ni" || aux == "Ne")) return "ENFJ";
    if (dom == "Fe" && (aux == "Si" || aux == "Se")) return "ESFJ";

    return "INTP"; // Default Fallback
  }

  String _getArchetypeTitle(String code) {
    const titles = {
      "INTJ": "The Architect", "INTP": "The Logician",
      "ENTJ": "The Commander", "ENTP": "The Debater",
      "INFJ": "The Advocate", "INFP": "The Mediator",
      "ENFJ": "The Protagonist", "ENFP": "The Campaigner",
      "ISTJ": "The Logistician", "ISFJ": "The Defender",
      "ESTJ": "The Executive", "ESFJ": "The Consul",
      "ISTP": "The Virtuoso", "ISFP": "The Adventurer",
      "ESTP": "The Entrepreneur", "ESFP": "The Entertainer",
    };
    return titles[code] ?? "The Enigma";
  }

  String _getArchetypeColor(String code) {
    // NT Types (Purple) #805da1
    if (['INTJ', 'INTP', 'ENTJ', 'ENTP'].contains(code)) return "0xFF805da1";
    // NF Types (Green) #429a6d
    if (['INFJ', 'INFP', 'ENFJ', 'ENFP'].contains(code)) return "0xFF429a6d";
    // SJ Types (Teal/Blue) #3ba3b5
    if (['ISTJ', 'ISFJ', 'ESTJ', 'ESFJ'].contains(code)) return "0xFF3ba3b5";
    // SP Types (Yellow) #e1ad3d
    if (['ISTP', 'ISFP', 'ESTP', 'ESFP'].contains(code)) return "0xFFe1ad3d";
    
    return "0xFF805da1"; // Default purple
  }

  String _getArchetypeDescription(String code) {
    const descs = {
      "INTJ": "You possess a mind that is constantly simulating the future, treating reality like a chessboard where every move must be calculated ten steps in advance. You dont just want to understand systems; you want to dismantle them and rebuild them better, ruthless in your pursuit of efficiency and logic. Small talk feels like a painful waste of bandwidth because youd rather be discussing the heat death of the universe or a strategy to optimize global supply chains. You often feel like the only adult in a room full of people acting on impulse, and while you aren't devoid of emotion, you view it as a variable that needs to be managed rather than a guide to follow.\n\nPeople often mistake your quiet observation for arrogance, but really, youre just vetting your ideas to ensure they are bulletproof before you speak. You value competence above all else, and your love language is essentially someone listening to your plan without interrupting.",
      "INTP": "You live inside a complex web of theories and \"what ifs,\" where the actual answer is often less interesting than the process of finding it. Your brain is a browser with 300 tabs open, and you are constantly cross-referencing ideas to see if they hold up to logical scrutiny. You have a habit of debating not to be difficult, but to test the structural integrity of an argument; if a fact doesn't click into your internal framework of truth, you simply cannot accept it. Routine is your kryptonite, and youve likely started a dozen brilliant projects this year that you abandoned the moment you figured out how they would work.\n\nYou are often detached, viewing social interactions as anthropological experiments rather than emotional exchanges. You crave precise language, and nothing frustrates you more than someone who says \"you know what I mean\" when you definitely do not.",
      "ENTJ": "You walk into a room and immediately spot the inefficiencies, feeling a physical itch to take charge and correct them. For you, relaxation is just another form of goal-setting, and you struggle to respect anyone who lacks a five-year plan or the drive to execute it. You arent necessarily trying to be bossy; you just genuinely believe that if everyone did what you said, the world would run perfectly. You process emotions through the lens of productivitysadness or stress are problems to be solved with an action plan rather than feelings to be wallowed in.\n\nYour intensity can be intimidating, but it comes from a place of wanting everyone to reach their potential. You are the person who pushes the \"impossible\" button just to see if it breaks, because you know that with enough willpower and strategy, nothing actually is.",
      "ENTP": "You are a mental gymnast who delights in taking the opposing view just to see if the other person can defend their stance. You don't argue to be mean; you argue because friction creates sparks, and sparks light up the truth (or at least, a more interesting conversation). You are allergic to tradition and \"because I said so\" reasoning, preferring to dismantle rules to see why they were put there in the first place. Your mind moves faster than your mouth, often leading you to jump between three different topics in a single sentence, leaving others dizzy while youre just getting warmed up.\n\nYou thrive in chaos and get bored the second a problem is solved. You are the person who invents a new way to do the dishes not because it's necessary, but because the old way was boring, and \"good enough\" is a phrase that isn't in your vocabulary.",
      "INFJ": "You feel like you are walking around with an X-ray vision that sees right into peoples souls, picking up on their hidden motives and unhealed traumas often before they do. You are a walking paradox: an extroverted introvert who loves humanity but finds humans exhausting. You have a rich, vivid inner world that feels more real than the physical one, and you are constantly searching for the deeper meaning behind every interaction. You are often the \"therapist\" friend, capable of absorbing everyones emotions, which leaves you needing to disappear for three days just to remember which feelings are actually yours.\n\nYou are driven by a quiet, intense conviction to change the world, not through force, but through shifting perspectives. You don't just want to be understood; you want to be known, but you rarely let anyone see the full depth of the galaxy inside your head.",
      "INFP": "You navigate the world through a lens of deep, unshakeable personal values, constantly checking if your actions align with your authentic self. You are a dreamer who often feels like you were born in the wrong century, longing for a reality that is kinder, more magical, and more poetic than the one you live in. You tend to romanticize everythingfrom your morning coffee to a strangers glanceand while you seem gentle and adaptable, you become immovable rock when a core value is threatened. You are prone to carrying the weight of the worlds sadness, taking things personally because you care so intensely.\n\nYou have a secret inner world of stories and scenarios that you rarely share because youre afraid they wont translate. You don't want a normal life; you want a life that feels like a novel, full of meaning, beauty, and emotional resonance.",
      "ENFJ": "You are the person who instinctively knows the emotional temperature of a room the second you walk in and immediately adjusts your behavior to bring harmony. You have a compulsion to help others realize their potential, often seeing a version of them that they can't even see themselves yet. You are a natural leader, not because you demand power, but because people naturally gravitate toward your warmth and charisma. However, you often neglect your own needs, feeling guilty if you aren't being useful or if someone around you is unhappy, taking it as a personal failure.\n\nYou are intense in your connections and crave deep, authentic communication, often feeling drained by surface-level interactions. You are the cheerleader who will drive three hours to support a friend, secretly hoping someone would do the same for you without you having to ask.",
      "ENFP": "You are a human firework, bursting with enthusiasm and the belief that everything is connected to everything else. You vacillate between being the life of the party and falling into a deep, existential introspection about the meaning of life. You collect people like souvenirs, fascinated by their stories and potential, and you possess a superpower for making anyone feel like the most interesting person in the world. Routine feels like a slow death to you; you need novelty, passion, and the freedom to chase your latest obsession, even if you drop it next week.\n\nDespite your bubbly exterior, you have a surprisingly dark and complex inner core that craves emotional intensity. You are constantly looking for the \"magic\" in everyday life, terrified of settling for a career or relationship that doesn't set your soul on fire.",
      "ISTJ": "You are the backbone of civilization, the person who actually reads the terms and conditions and keeps the receipt \"just in case.\" You find comfort in facts, traditions, and clear hierarchies because they provide a stable framework in a chaotic world. You don't need praise; you just need people to do their jobs correctly and show up on time, because reliability is your love language. You often feel like the only person who understands that rules exist to prevent disaster, and you get deeply frustrated by people who wing it or let their emotions dictate their decisions.\n\nYou show you care by fixing the leaky faucet or handling the taxes, not by writing poetry. You are steady, grounded, and fiercely loyal, and while you may not be the loudest in the room, you are usually the one keeping the roof from collapsing.",
      "ISFJ": "You are the quiet observer who remembers that your coworker is allergic to peanuts and that your friends mother has surgery next Tuesday. You navigate the world with a deep sense of duty and a desire to protect the peace, often working tirelessly behind the scenes without asking for credit. You have a filing cabinet in your brain storing every detail of your past interactions, which makes you incredibly sentimental but also prone to holding onto grudges or embarrassments from years ago. You struggle to say \"no\" because you terrified of letting people down or causing conflict.\n\nYou crave stability and struggle when plans change last minute, preferring a life that is predictable and harmonious. You are the one who makes a house a home, creating a safe, warm space for everyone else while secretly hoping someone will notice how hard you work.",
      "ESTJ": "You believe that if there isn't a procedure for it, you should write one, because chaos is just a failure of management. You value hard work, honesty, and competence, and you have zero patience for excuses or laziness. You are often the person organizing the group trip or taking charge of the project because you know that if you don't, it won't get done right. You are direct and objective, which can sometimes hurt people's feelings, but you genuinely believe that telling the truth is the most respectful thing you can do.\n\nYou respect tradition and authority, provided that authority is competent, and you act as a pillar of your community. You don't guessyou know, and you move through life with a decisiveness that makes others feel safer just by being around you.",
      "ESFJ": "You are the social glue of any group, the person who ensures everyone has a drink and feels included in the conversation. You define yourself by your relationships and your ability to provide for others, taking your responsibilities to your family and friends very seriously. You are highly sensitive to criticism and discord; if someone is mad at you, it feels like the end of the world, and you will work overtime to restore harmony. You love gossip, not out of malice, but because you are genuinely fascinated by the details of people's lives and social dynamics.\n\nYou thrive on clear expectations and social validation, loving nothing more than being appreciated for your efforts. You are the first to send a thank-you card and the last to leave the party, ensuring that every social obligation is met with grace and warmth.",
      "ISTP": "You are the quiet problem-solver who observes the world with a cool, detached curiosity, waiting for the moment things break so you can fix them. You learn by doing, preferring to get your hands dirty with the mechanics of reality rather than reading the manual. You have a limited social battery and a low tolerance for drama; you prefer relationships where you can sit in comfortable silence or do an activity together rather than talk about feelings. You are unpredictable, prone to sudden bursts of energy or impulsive adventures, and you hate feeling controlled or tied down.\n\nYou have a \"live and let live\" attitude, rarely judging others but expecting the same freedom in return. You are a master of crisis management, staying completely calm when everyone else is panicking, simply because you are too busy analyzing the variables to be afraid.",
      "ISFP": "You live your life as a canvas, constantly expressing your unique perspective through your style, your art, or your choices. You are deeply in touch with your senses, savoring the texture, sound, and color of the present moment more than any other type. You are gentle and unassuming, often underestimated by others, but you possess a core of steel when it comes to your personal freedom and values. You don't want to lead or control others; you just want the space to be yourself without interference.\n\nYou are prone to taking things at your own pace, which can look like laziness to others, but is actually you waiting for the \"vibe\" to be right. You are a free spirit who finds beauty in the tragic and the mundane, always prioritizing how a decision feels over what makes logical sense.",
      "ESTP": "You are a creature of the immediate moment, moving faster than everyone else and scanning the room for the next opportunity or thrill. You don't worry about the future because you know that you can talk your way out of whatever trouble you land in. You are brutally pragmatic and observant, noticing the small physical cues others miss, which makes you excellent at reading people and navigating social hierarchies. You hate abstract theory; if you can't touch it, eat it, or spend it, you aren't interested.\n\nYou are the person who jumps off the cliff first and builds the parachute on the way down. You have a magnetic charm and a boldness that draws people in, largely because you make life feel like an action movie where you are the invincible star.",
      "ESFP": "You are a burst of solar energy, terrified of missing out on anything and determined to make every moment fun. You treat the world like a stage, and you are happiest when you are the center of attention, making people laugh or bringing the energy up. You are incredibly observant of how people are feeling and will drop everything to comfort a friend, often offering a distraction or an adventure rather than advice. You struggle with long-term planning and \"boring\" responsibilities, preferring to deal with consequences only when they are staring you in the face.\n\nYou are generous to a fault, often giving your time and money freely because you believe life is meant to be shared. You don't just want to exist; you want to sparkle, and you want everyone around you to feel the glow.",
    };
    return descs[code] ?? "A unique personality that defies categorization.";
  }
}


--- C:\Code\femn\lib\wellness_widgets\widget_customization_service.dart ---

import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:shared_preferences/shared_preferences.dart';

// --- The Data Model ---
class WidgetLayout {
  final String id;
  final String name;
  final IconData icon;
  final String description;
  final int crossAxisCellCount;
  final int mainAxisCellCount;
  final int position;
  final bool isVisible;
  final Map<String, dynamic>? metadata;

  WidgetLayout({
    required this.id,
    required this.name,
    required this.icon,
    required this.description,
    this.crossAxisCellCount = 2,
    this.mainAxisCellCount = 2,
    this.position = 0,
    this.isVisible = true,
    this.metadata,
  });

  // Create a copy of the object with updated values
  WidgetLayout copyWith({
    String? id,
    String? name,
    IconData? icon,
    String? description,
    int? crossAxisCellCount,
    int? mainAxisCellCount,
    int? position,
    bool? isVisible,
    Map<String, dynamic>? metadata,
  }) {
    return WidgetLayout(
      id: id ?? this.id,
      name: name ?? this.name,
      icon: icon ?? this.icon,
      description: description ?? this.description,
      crossAxisCellCount: crossAxisCellCount ?? this.crossAxisCellCount,
      mainAxisCellCount: mainAxisCellCount ?? this.mainAxisCellCount,
      position: position ?? this.position,
      isVisible: isVisible ?? this.isVisible,
      metadata: metadata ?? this.metadata,
    );
  }

  // Convert to Map for JSON saving
  // Note: We don't save the IconData directly to JSON, we rely on the ID to restore it
  // or we save the layout properties and merge with default definitions.
  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'crossAxisCellCount': crossAxisCellCount,
      'mainAxisCellCount': mainAxisCellCount,
      'position': position,
      'isVisible': isVisible,
    };
  }

  // Helper to reconstruct from JSON, merging with a default "Definition" to get back the Icon
  factory WidgetLayout.fromJson(Map<String, dynamic> json, WidgetLayout defaultDef) {
    return defaultDef.copyWith(
      crossAxisCellCount: json['crossAxisCellCount'],
      mainAxisCellCount: json['mainAxisCellCount'],
      position: json['position'],
      isVisible: json['isVisible'],
    );
  }
}

// --- The Service ---
class WidgetCustomizationService {
  static const String _storageKey = 'wellness_dashboard_layout';

  // 1. Define the Master List of all available widgets
  final List<WidgetLayout> _allWidgetsDefaults = [
    WidgetLayout(
      id: 'wellness_journal',
      name: 'Journal',
      icon: Feather.book,
      description: 'Track your thoughts & mood',
      crossAxisCellCount: 2,
      mainAxisCellCount: 2,
      metadata: {'hasStreak': true},
    ),
    WidgetLayout(
      id: 'cycle',
      name: 'Cycle',
      icon: Feather.droplet,
      description: 'Period & ovulation tracker',
      crossAxisCellCount: 3,
      mainAxisCellCount: 2,
      metadata: {'isCycle': true},
    ),
    WidgetLayout(
      id: 'activity',
      name: 'Activity',
      icon: Feather.activity,
      description: 'Physical movement log',
      crossAxisCellCount: 2,
      mainAxisCellCount: 2,
    ),
    WidgetLayout(
      id: 'twin_finder',
      name: 'Twin Finder',
      icon: Feather.users,
      description: 'Find your personality twin',
      crossAxisCellCount: 2,
      mainAxisCellCount: 2,
    ),
    WidgetLayout(
      id: 'leak_guard',
      name: 'LeakGuard',
      icon: Feather.shield,
      description: 'Protection reminders',
      crossAxisCellCount: 3,
      mainAxisCellCount: 2,
    ),
  ];

  // Get all widgets that exist in the app
  List<WidgetLayout> getAvailableWidgets() {
    return _allWidgetsDefaults;
  }

  // Get the default starting layout
  List<WidgetLayout> getDefaultLayout() {
    // Return copies so we don't mutate the master list
    return _allWidgetsDefaults.map((w) => w.copyWith()).toList();
  }

  // Save the current list to SharedPreferences
  Future<void> saveLayout(List<WidgetLayout> widgets) async {
    final prefs = await SharedPreferences.getInstance();
    
    // Sort by position before saving to ensure consistency
    widgets.sort((a, b) => a.position.compareTo(b.position));

    final String encoded = jsonEncode(widgets.map((w) => w.toJson()).toList());
    await prefs.setString(_storageKey, encoded);
  }

  // Load from SharedPreferences
  Future<List<WidgetLayout>> getSavedLayout() async {
    final prefs = await SharedPreferences.getInstance();
    final String? jsonString = prefs.getString(_storageKey);

    if (jsonString == null) {
      return getDefaultLayout();
    }

    try {
      final List<dynamic> decoded = jsonDecode(jsonString);
      final List<WidgetLayout> loadedWidgets = [];

      // We define a map of the default definitions for easy lookup
      final Map<String, WidgetLayout> definitionsMap = {
        for (var w in _allWidgetsDefaults) w.id: w
      };

      for (var item in decoded) {
        final String id = item['id'];
        final WidgetLayout? definition = definitionsMap[id];

        // Only add if the widget ID still exists in our app definitions
        if (definition != null) {
          loadedWidgets.add(WidgetLayout.fromJson(item, definition));
        }
      }

      // Handle New Widgets:
      // If we added a new widget to the app update since the user last saved,
      // it won't be in the saved JSON. We should add it to the end or keep it available.
      // For now, we only return what was saved. The "Add Widget" screen handles the rest.
      
      return loadedWidgets..sort((a, b) => a.position.compareTo(b.position));

    } catch (e) {
      // If data is corrupt, return default
      debugPrint("Error loading layout: $e");
      return getDefaultLayout();
    }
  }
}


--- C:\Code\femn\lib\wellness_widgets\leakguard\cease_desist_generator.dart ---

import 'dart:math';
import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;
import 'package:printing/printing.dart';
import 'package:intl/intl.dart';
import 'package:femn/customization/colors.dart'; 

class CeaseDesistScreen extends StatefulWidget {
  @override
  _CeaseDesistScreenState createState() => _CeaseDesistScreenState();
}

class _CeaseDesistScreenState extends State<CeaseDesistScreen> {
  // Form Controllers
  final _perpNameController = TextEditingController();
  final _perpDetailsController = TextEditingController(); // Email/Phone/Handle
  final _perpAddressController = TextEditingController(); // Optional
  final _userNameController = TextEditingController();
  final _userLocationController = TextEditingController(); // City, Country
  final _userEmailController = TextEditingController();
  
  String _sendMethod = "Email"; // Default
  final List<String> _sendMethods = ["Email", "WhatsApp", "DM (Direct Message)", "Certified Mail"];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundDeep,
        elevation: 0,
        leading: IconButton(
          icon: Icon(Feather.arrow_left, color: AppColors.textHigh),
          onPressed: () => Navigator.pop(context),
        ),
        title: Text("Legal Notice Generator", style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)),
      ),
      body: SingleChildScrollView(
        padding: EdgeInsets.all(24),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildHeader(),
            SizedBox(height: 30),

            // SECTION 1: THE PERPETRATOR
            Text("THE PERPETRATOR (TARGET)", style: TextStyle(color: AppColors.textMedium, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
            SizedBox(height: 15),
            
            _buildTextField(_perpNameController, "Their Name", Feather.user_x, "e.g. John Doe (or 'Unknown')"),
            SizedBox(height: 15),
            _buildTextField(_perpDetailsController, "Their Contact (Phone/Email/Handle)", Feather.at_sign, "e.g. +234... or @username"),
            SizedBox(height: 15),
            _buildTextField(_perpAddressController, "Their Address (Optional)", Feather.map_pin, "Leave blank if unknown"),

            SizedBox(height: 30),

            // SECTION 2: YOUR DETAILS
            Text("YOUR DETAILS (THE SENDER)", style: TextStyle(color: AppColors.textMedium, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
            SizedBox(height: 15),
            
            _buildTextField(_userNameController, "Your Full Name", Feather.user, "Required for legal validity"),
            SizedBox(height: 15),
            _buildTextField(_userLocationController, "Your City, Country", Feather.map, "e.g. Lagos, Nigeria"),
            SizedBox(height: 15),
            _buildTextField(_userEmailController, "Secure Email Address", Feather.mail, "Use a secondary email for safety"),

            SizedBox(height: 30),

            // SECTION 3: DELIVERY METHOD
            Text("METHOD OF DELIVERY", style: TextStyle(color: AppColors.textMedium, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
            SizedBox(height: 15),
            Container(
              padding: EdgeInsets.symmetric(horizontal: 16),
              decoration: BoxDecoration(
                color: AppColors.surface,
                borderRadius: BorderRadius.circular(12),
                border: Border.all(color: AppColors.elevation),
              ),
              child: DropdownButtonHideUnderline(
                child: DropdownButton<String>(
                  value: _sendMethod,
                  dropdownColor: AppColors.surface,
                  isExpanded: true,
                  icon: Icon(Feather.chevron_down, color: AppColors.textHigh),
                  items: _sendMethods.map((m) {
                    return DropdownMenuItem(value: m, child: Text(m, style: TextStyle(color: AppColors.textHigh)));
                  }).toList(),
                  onChanged: (val) => setState(() => _sendMethod = val!),
                ),
              ),
            ),

            SizedBox(height: 40),

            // ACTION BUTTON
            SizedBox(
              width: double.infinity,
              child: ElevatedButton.icon(
                icon: Icon(Feather.printer, color: Colors.white),
                label: Text("Generate Formal PDF"),
                style: ElevatedButton.styleFrom(
                  backgroundColor: AppColors.primaryLavender,
                  padding: EdgeInsets.symmetric(vertical: 20),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                ),
                onPressed: () => _generatePDF(context),
              ),
            ),
            SizedBox(height: 50),
          ],
        ),
      ),
    );
  }

  Widget _buildHeader() {
    return Container(
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.elevation),
      ),
      child: Row(
        children: [
          Icon(Feather.briefcase, color: AppColors.primaryLavender, size: 30),
          SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  "Formal Legal Notice",
                  style: TextStyle(color: AppColors.textHigh, fontSize: 18, fontWeight: FontWeight.bold),
                ),
                SizedBox(height: 5),
                Text(
                  "Generates a 'Cease & Desist' document using standard court typography (Serif fonts, Justified text) to maximize intimidation.",
                  style: TextStyle(color: AppColors.textMedium, fontSize: 12),
                ),
              ],
            ),
          )
        ],
      ),
    );
  }

  Widget _buildTextField(TextEditingController controller, String label, IconData icon, String hint) {
    return TextField(
      controller: controller,
      style: TextStyle(color: AppColors.textHigh),
      decoration: InputDecoration(
        labelText: label,
        labelStyle: TextStyle(color: AppColors.textMedium),
        prefixIcon: Icon(icon, color: AppColors.textDisabled, size: 18),
        hintText: hint,
        hintStyle: TextStyle(color: AppColors.textDisabled),
        filled: true,
        fillColor: AppColors.surface,
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
      ),
    );
  }

  // ==========================================
  // PDF GENERATION LOGIC
  // ==========================================
  Future<void> _generatePDF(BuildContext context) async {
    final pdf = pw.Document();
    
    // 1. Load Professional Serif Fonts (Tinos is a free Google Font alternative to Times New Roman)
    final fontRegular = await PdfGoogleFonts.tinosRegular();
    final fontBold = await PdfGoogleFonts.tinosBold();
    final fontItalic = await PdfGoogleFonts.tinosItalic();

    // 2. Prepare Data
    final today = DateFormat('MMMM dd, yyyy').format(DateTime.now());
    final caseRef = "CASE-${DateTime.now().year}-${Random().nextInt(99999)}"; // Random Case ID
    
    final perpName = _perpNameController.text.isEmpty ? "John/Jane Doe" : _perpNameController.text;
    final perpContact = _perpDetailsController.text;
    final perpAddress = _perpAddressController.text;
    
    final userName = _userNameController.text.isEmpty ? "[Your Legal Name]" : _userNameController.text;
    final userLoc = _userLocationController.text.isEmpty ? "[Your City, Country]" : _userLocationController.text;
    final userEmail = _userEmailController.text.isEmpty ? "[Your Email]" : _userEmailController.text;

    // 3. Build Page
    pdf.addPage(
      pw.MultiPage(
        pageTheme: pw.PageTheme(
          theme: pw.ThemeData.withFont(base: fontRegular, bold: fontBold, italic: fontItalic),
          margin: const pw.EdgeInsets.all(72), // 1 inch margins
        ),
        build: (pw.Context context) {
          return [
            // --- HEADER ---
            pw.Row(
              mainAxisAlignment: pw.MainAxisAlignment.spaceBetween,
              children: [
                pw.Text("URGENT LEGAL NOTICE", style: pw.TextStyle(color: PdfColors.red, fontWeight: pw.FontWeight.bold, fontSize: 14)),
                pw.Text("VIA: ${_sendMethod.toUpperCase()}", style: pw.TextStyle(fontSize: 10, fontWeight: pw.FontWeight.bold)),
              ]
            ),
            pw.SizedBox(height: 20),

            // --- PARTIES BLOCK ---
            pw.Container(
              decoration: pw.BoxDecoration(border: pw.Border(left: pw.BorderSide(width: 2))),
              padding: pw.EdgeInsets.only(left: 10),
              child: pw.Column(
                crossAxisAlignment: pw.CrossAxisAlignment.start,
                children: [
                  pw.Text("FROM:", style: pw.TextStyle(fontWeight: pw.FontWeight.bold)),
                  pw.Text(userName),
                  pw.Text(userLoc),
                  pw.Text(userEmail),
                  pw.SizedBox(height: 10),
                  pw.Text("TO:", style: pw.TextStyle(fontWeight: pw.FontWeight.bold)),
                  pw.Text(perpName),
                  if (perpContact.isNotEmpty) pw.Text(perpContact),
                  if (perpAddress.isNotEmpty) pw.Text(perpAddress),
                  pw.SizedBox(height: 10),
                  pw.Text("DATE: $today"),
                  pw.Text("FILE REF: $caseRef", style: pw.TextStyle(fontWeight: pw.FontWeight.bold)),
                ]
              )
            ),
            pw.SizedBox(height: 25),

            // --- SUBJECT LINE ---
            pw.Center(
              child: pw.Text(
                "RE: FORMAL DEMAND TO CEASE AND DESIST: EXTORTION, HARASSMENT, AND THREAT OF NON-CONSENSUAL IMAGE ABUSE",
                textAlign: pw.TextAlign.center,
                style: pw.TextStyle(fontWeight: pw.FontWeight.bold, fontSize: 12),
              )
            ),
            pw.SizedBox(height: 20),

            // --- INTRODUCTION ---
            pw.Text("To $perpName:", style: pw.TextStyle(fontWeight: pw.FontWeight.bold)),
            pw.SizedBox(height: 10),
            pw.Text(
              "This letter constitutes formal legal notice demanding that you immediately CEASE AND DESIST all unlawful actions against me, specifically the possession, threat of distribution, and actual distribution of private, sexually explicit, or intimate images/videos (\"Private Media\") depicting me.",
              textAlign: pw.TextAlign.justify,
            ),
            pw.SizedBox(height: 10),
            pw.Text(
              "Your threats to release this Private Media unless specific demands are met constitute Criminal Extortion and Blackmail.",
              textAlign: pw.TextAlign.justify,
              style: pw.TextStyle(fontWeight: pw.FontWeight.bold)
            ),
            pw.SizedBox(height: 20),

            // --- SECTION 1: LEGAL VIOLATIONS ---
            pw.Text("LEGAL VIOLATIONS", style: pw.TextStyle(fontWeight: pw.FontWeight.bold, fontSize: 12, decoration: pw.TextDecoration.underline)),
            pw.SizedBox(height: 10),
            pw.Text(
              "Be advised that your conduct violates criminal and civil laws recognized in international jurisdictions, including but not limited to:",
              textAlign: pw.TextAlign.justify
            ),
            pw.SizedBox(height: 10),
            _buildNumberedItem("1", "Criminal Extortion & Blackmail", "The act of demanding money, goods, or acts in exchange for withholding the release of private information is a felony in the United States, United Kingdom, European Union, Nigeria, and most sovereign nations."),
            _buildNumberedItem("2", "Non-Consensual Pornography (Revenge Porn)", "The distribution of private sexual images without consent is a specific criminal offense in many jurisdictions punishable by imprisonment and registration as a sex offender."),
            _buildNumberedItem("3", "Invasion of Privacy", "Your actions give rise to civil liability, for which I reserve the right to sue for significant monetary damages."),
            _buildNumberedItem("4", "Copyright Infringement", "As the creator/subject of these images, I own the copyright. Unauthorized reproduction is a violation of international copyright treaties and the DMCA."),
            
            pw.SizedBox(height: 20),

            // --- SECTION 2: DEMANDS ---
            pw.Text("DEMANDS", style: pw.TextStyle(fontWeight: pw.FontWeight.bold, fontSize: 12, decoration: pw.TextDecoration.underline)),
            pw.SizedBox(height: 10),
            pw.Text("I hereby demand that you immediately:", textAlign: pw.TextAlign.justify),
            pw.SizedBox(height: 10),
            _buildNumberedItem("1", null, "PERMANENTLY DELETE all copies of the Private Media from all devices, cloud storage, hard drives, and communication platforms in your control."),
            _buildNumberedItem("2", null, "CEASE all communication with me, my family, my employer, and my acquaintances."),
            _buildNumberedItem("3", null, "ABSTAIN from sharing, uploading, or showing the Private Media to any third party or online platform."),
            
            pw.SizedBox(height: 20),

            // --- SECTION 3: SPOLIATION WARNING (BOXED) ---
            pw.Container(
              decoration: pw.BoxDecoration(border: pw.Border.all()),
              padding: pw.EdgeInsets.all(10),
              child: pw.Column(
                crossAxisAlignment: pw.CrossAxisAlignment.start,
                children: [
                  pw.Text("NOTICE TO PRESERVE EVIDENCE (SPOLIATION WARNING)", style: pw.TextStyle(fontWeight: pw.FontWeight.bold)),
                  pw.SizedBox(height: 5),
                  pw.Text(
                    "This is a formal notice to preserve all evidence related to this matter. You are legally required to retain all text messages, call logs, emails, metadata, and files related to your communications with me. Deleting or altering this evidence acts as an admission of guilt and may lead to additional criminal charges for Spoliation of Evidence or Obstruction of Justice.",
                    textAlign: pw.TextAlign.justify,
                    style: pw.TextStyle(fontSize: 10)
                  ),
                ]
              )
            ),

            pw.SizedBox(height: 20),

            // --- SECTION 4: NEXT STEPS ---
            pw.Text("NEXT STEPS", style: pw.TextStyle(fontWeight: pw.FontWeight.bold, fontSize: 12, decoration: pw.TextDecoration.underline)),
            pw.SizedBox(height: 10),
            pw.Text("If you fail to comply with these demands immediately, I will:", textAlign: pw.TextAlign.justify),
            pw.SizedBox(height: 10),
            _buildNumberedItem("1", null, "File formal criminal complaints with local law enforcement and the Interpol Cybercrime Directorate."),
            _buildNumberedItem("2", null, "File \"Takedown Notices\" with all relevant Internet Service Providers (ISPs) and social media platforms, alerting them to your illegal use of their services, which will result in the termination of your accounts."),
            _buildNumberedItem("3", null, "Retain legal counsel to pursue maximum civil damages and criminal prosecution to the fullest extent of the law in your governing jurisdiction."),

            pw.SizedBox(height: 30),
            pw.Center(child: pw.Text("GOVERN YOURSELF ACCORDINGLY.", style: pw.TextStyle(fontWeight: pw.FontWeight.bold))),
            pw.SizedBox(height: 50),

            // --- SIGNATURE ---
            pw.Divider(),
            pw.Text(userName),
            pw.Text("Victim / Claimant"),
          ];
        }
      )
    );

    await Printing.layoutPdf(
      onLayout: (PdfPageFormat format) async => pdf.save(),
    );
  }

  // Helper for Numbered Lists in PDF
  pw.Widget _buildNumberedItem(String number, String? title, String text) {
    return pw.Padding(
      padding: pw.EdgeInsets.only(bottom: 8),
      child: pw.Row(
        crossAxisAlignment: pw.CrossAxisAlignment.start,
        children: [
          pw.SizedBox(width: 20, child: pw.Text("$number.", style: pw.TextStyle(fontWeight: pw.FontWeight.bold))),
          pw.Expanded(
            child: pw.RichText(
              textAlign: pw.TextAlign.justify,
              text: pw.TextSpan(
                children: [
                  if (title != null) 
                    pw.TextSpan(text: "$title: ", style: pw.TextStyle(fontWeight: pw.FontWeight.bold)),
                  pw.TextSpan(text: text),
                ]
              )
            )
          )
        ]
      )
    );
  }
}


--- C:\Code\femn\lib\wellness_widgets\leakguard\deepfake_defense.dart ---

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:femn/customization/colors.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:share_plus/share_plus.dart';

class DeepfakeDefenseScreen extends StatefulWidget {
  @override
  _DeepfakeDefenseScreenState createState() => _DeepfakeDefenseScreenState();
}

class _DeepfakeDefenseScreenState extends State<DeepfakeDefenseScreen> with SingleTickerProviderStateMixin {
  late TabController _tabController;

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 2, vsync: this);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundDeep,
        elevation: 0,
        leading: IconButton(
          icon: Icon(Feather.arrow_left, color: AppColors.textHigh),
          onPressed: () => Navigator.pop(context),
        ),
        title: Text("Deepfake Defense", style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)),
        bottom: TabBar(
          controller: _tabController,
          indicatorColor: AppColors.primaryLavender,
          labelColor: AppColors.primaryLavender,
          unselectedLabelColor: AppColors.textDisabled,
          tabs: [
            Tab(text: "STATEMENT GENERATOR"),
            Tab(text: "STRATEGY GUIDE"),
          ],
        ),
      ),
      body: TabBarView(
        controller: _tabController,
        children: [
          _buildGeneratorTab(),
          _buildStrategyTab(),
        ],
      ),
    );
  }

  // ==========================================
  // TAB 1: THE DENIAL GENERATOR
  // ==========================================
  Widget _buildGeneratorTab() {
    return ListView(
      padding: EdgeInsets.all(20),
      children: [
        _buildInfoCard(
          "Plausible Deniability",
          "In the age of AI, 'Truth' is debatable. You do not have to admit anything. Use these scripts to cast doubt immediately.",
          Feather.shield,
          Colors.blueAccent,
        ),
        SizedBox(height: 24),
        Text("SELECT AUDIENCE", style: TextStyle(color: AppColors.textMedium, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
        SizedBox(height: 12),
        
        _buildScriptCard(
          title: "Public Social Media (The 'Outraged' Post)",
          usageContext: "Use this on Instagram Stories, Twitter, or WhatsApp Status immediately after a leak threat.",
          script: "I have been made aware of AI-generated deepfake images circulating with my likeness. This is a targeted harassment campaign using illegal technology. \n\nI am working with the authorities to trace the source. If you receive these fake images, do not engage. Blocking and reporting is the only help I need. #Deepfake #CyberSafety",
          tags: ["Public", "Formal", "Instagram"],
        ),

        _buildScriptCard(
          title: "Family & Parents (The 'Simple' Explanation)",
          usageContext: "Use this for older relatives who don't understand tech.",
          script: "Mum/Dad, someone hacked my account and is using AI (Artificial Intelligence) to edit my face onto naked bodies. Its a common scam happening to thousands of people right now. It is not real, but it is scary. I am handling it with the police.",
          tags: ["Family", "Simple", "WhatsApp"],
        ),

        _buildScriptCard(
          title: "Work / Employer (The 'HR' Defense)",
          usageContext: "Use this if the extortionist threatens to email your boss.",
          script: "I am writing to formally notify you that I am currently the victim of a cyber-harassment attack involving 'Deepfake' technology. Criminals are generating synthetic explicit imagery to extort me.\n\nThis is a police matter (Case Ref: PENDING). I wanted to alert you in case they attempt to contact the company. These images are fabricated and malicious.",
          tags: ["Professional", "HR", "Email"],
        ),

        _buildScriptCard(
          title: "The 'Gaslight' Response (To Friends)",
          usageContext: "Use this in group chats if someone asks.",
          script: "Lol have you seen the AI edits? They didn't even get my tattoo right. It's crazy what apps can do these days. Ignore that trash.",
          tags: ["Casual", "Dismissive"],
        ),
      ],
    );
  }

  // ==========================================
  // TAB 2: STRATEGY & EDUCATION
  // ==========================================
  Widget _buildStrategyTab() {
    return ListView(
      padding: EdgeInsets.all(20),
      children: [
        Text("HOW TO SOW DOUBT", style: TextStyle(color: AppColors.textMedium, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
        SizedBox(height: 12),
        _buildStrategyItem(
          "1. Point out 'Glitchy' Details",
          "Even if the photo is real, AI often struggles with hands, teeth, and background text. Tell people: 'Look at the fingers, look at the shadow. It's clearly AI.' Most people won't look close enough to verify, but they will believe the doubt.",
        ),
        _buildStrategyItem(
          "2. The 'Hacked' Narrative",
          "It is easier for people to believe you were hacked than to believe you are a victim of revenge porn. Stick to the story: 'My iCloud/Snapchat was breached and they are using AI tools.'",
        ),
        _buildStrategyItem(
          "3. Anger, Not Shame",
          "If you act ashamed, people assume it's real. If you act angry and violated by 'technology,' people see you as a victim of a crime. Shift the narrative from 'I took a nude' to 'Criminals are stealing my face.'",
        ),
        
        SizedBox(height: 30),
        Text("EXPLAINING AI TO BOOMERS", style: TextStyle(color: AppColors.textMedium, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
        SizedBox(height: 12),
        Container(
          padding: EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: AppColors.surface,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.elevation),
          ),
          child: Column(
            children: [
              Text(
                "\"It's like Photoshop, but automatic.\"",
                style: TextStyle(color: AppColors.textHigh, fontSize: 18, fontWeight: FontWeight.bold, fontStyle: FontStyle.italic),
                textAlign: TextAlign.center,
              ),
              SizedBox(height: 10),
              Text(
                "Older generations trust photos. You must explain that apps now exist where you upload one selfie, and it generates a nude body that matches your skin tone perfectly. Show them a news article about 'Deepfake Scams' if necessary.",
                style: TextStyle(color: AppColors.textMedium),
              ),
            ],
          ),
        ),
      ],
    );
  }

  // --- WIDGETS ---

  Widget _buildInfoCard(String title, String desc, IconData icon, Color color) {
    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: color.withOpacity(0.1),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: color.withOpacity(0.3)),
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Icon(icon, color: color, size: 24),
          SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title, style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold, fontSize: 16)),
                SizedBox(height: 4),
                Text(desc, style: TextStyle(color: AppColors.textMedium, fontSize: 13, height: 1.4)),
              ],
            ),
          )
        ],
      ),
    );
  }

  // FIX: Renamed 'context' to 'usageContext' to avoid conflict
  Widget _buildScriptCard({required String title, required String usageContext, required String script, required List<String> tags}) {
    return Container(
      margin: EdgeInsets.only(bottom: 20),
      decoration: BoxDecoration(
        color: AppColors.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.elevation),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title, style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold, fontSize: 16)),
                SizedBox(height: 4),
                Text(usageContext, style: TextStyle(color: AppColors.textDisabled, fontSize: 12)),
                SizedBox(height: 12),
                Wrap(
                  spacing: 8,
                  children: tags.map((tag) => Container(
                    padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(
                      color: AppColors.primaryLavender.withOpacity(0.2),
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Text(tag, style: TextStyle(color: AppColors.primaryLavender, fontSize: 10, fontWeight: FontWeight.bold)),
                  )).toList(),
                )
              ],
            ),
          ),
          Divider(height: 1, color: AppColors.elevation),
          
          // Script Body
          Container(
            width: double.infinity,
            padding: EdgeInsets.all(20),
            color: Colors.black12,
            child: Text(
              script,
              style: GoogleFonts.robotoMono(
                color: AppColors.textHigh,
                fontSize: 14,
                height: 1.5,
              ),
            ),
          ),

          // Action Buttons
          Row(
            children: [
              Expanded(
                child: TextButton.icon(
                  icon: Icon(Feather.copy, size: 16, color: AppColors.textMedium),
                  label: Text("Copy Text", style: TextStyle(color: AppColors.textMedium)),
                  style: TextButton.styleFrom(padding: EdgeInsets.symmetric(vertical: 16)),
                  onPressed: () {
                    Clipboard.setData(ClipboardData(text: script));
                    // 'context' now refers to the State's BuildContext, which works
                    ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Statement copied!")));
                  },
                ),
              ),
              Container(width: 1, height: 48, color: AppColors.elevation),
              Expanded(
                child: TextButton.icon(
                  icon: Icon(Feather.share, size: 16, color: AppColors.primaryLavender),
                  label: Text("Share", style: TextStyle(color: AppColors.primaryLavender)),
                  style: TextButton.styleFrom(padding: EdgeInsets.symmetric(vertical: 16)),
                  onPressed: () {
                    Share.share(script);
                  },
                ),
              ),
            ],
          )
        ],
      ),
    );
  }

  Widget _buildStrategyItem(String title, String desc) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 20.0),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Icon(Feather.check_circle, color: Colors.greenAccent, size: 20),
          SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title, style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold, fontSize: 15)),
                SizedBox(height: 6),
                Text(desc, style: TextStyle(color: AppColors.textMedium, fontSize: 13, height: 1.4)),
              ],
            ),
          )
        ],
      ),
    );
  }
}


--- C:\Code\femn\lib\wellness_widgets\leakguard\evidence_locker.dart ---

import 'dart:io';
import 'dart:async';
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:file_picker/file_picker.dart';
import 'package:path_provider/path_provider.dart';
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;
import 'package:printing/printing.dart';
import 'package:intl/intl.dart';
import 'package:local_auth/local_auth.dart';
import 'package:femn/customization/colors.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:record/record.dart'; // NEW
import 'package:audioplayers/audioplayers.dart'; // NEW
import 'package:archive/archive_io.dart'; // NEW
import 'package:share_plus/share_plus.dart'; // NEW

// ==========================================
// DATA MODEL
// ==========================================
enum EvidenceType { image, audio, document, video }

class EvidenceItem {
  final String id;
  final String filePath;
  final String originalName;
  final String contextNote;
  final String category;
  final DateTime timestamp;
  final EvidenceType type;

  EvidenceItem({
    required this.id,
    required this.filePath,
    required this.originalName,
    required this.contextNote,
    required this.category,
    required this.timestamp,
    required this.type,
  });

  Map<String, dynamic> toJson() => {
        'id': id,
        'filePath': filePath,
        'originalName': originalName,
        'contextNote': contextNote,
        'category': category,
        'timestamp': timestamp.toIso8601String(),
        'type': type.toString(),
      };

  factory EvidenceItem.fromJson(Map<String, dynamic> json) {
    return EvidenceItem(
      id: json['id'],
      filePath: json['filePath'],
      originalName: json['originalName'],
      contextNote: json['contextNote'],
      category: json['category'],
      timestamp: DateTime.parse(json['timestamp']),
      type: EvidenceType.values.firstWhere(
        (e) => e.toString() == json['type'],
        orElse: () => EvidenceType.image,
      ),
    );
  }
}

// ==========================================
// MAIN SCREEN
// ==========================================
class EvidenceLockerScreen extends StatefulWidget {
  @override
  _EvidenceLockerScreenState createState() => _EvidenceLockerScreenState();
}

class _EvidenceLockerScreenState extends State<EvidenceLockerScreen> {
  final LocalAuthentication auth = LocalAuthentication();
  bool _isAuthenticated = false;
  List<EvidenceItem> _evidenceList = [];
  bool _isLoading = true;
  String _sortBy = 'Date (Newest)';

  // Audio Recorder State
  final AudioRecorder _audioRecorder = AudioRecorder();
  bool _isRecording = false;
  
  final Map<String, Color> _categoryColors = {
    "Threat": Colors.redAccent,
    "Nude Leaked": Colors.purpleAccent,
    "Financial": Colors.greenAccent,
    "Stalking": Colors.orangeAccent,
    "Other": Colors.grey,
  };
  
  final String _currentUserId = "user_001";

  @override
  void initState() {
    super.initState();
    _checkBiometrics();
    _loadEvidenceManifest();
  }

  @override
  void dispose() {
    _audioRecorder.dispose();
    super.dispose();
  }

  // --- [PERSISTENCE & AUTH METHODS SAME AS BEFORE] ---
  Future<void> _loadEvidenceManifest() async {
    try {
      final directory = await getApplicationDocumentsDirectory();
      final file = File('${directory.path}/evidence_manifest_$_currentUserId.json');
      if (await file.exists()) {
        final jsonString = await file.readAsString();
        final List<dynamic> jsonList = jsonDecode(jsonString);
        setState(() {
          _evidenceList = jsonList.map((e) => EvidenceItem.fromJson(e)).toList();
          _sortEvidence();
          _isLoading = false;
        });
      } else {
        setState(() => _isLoading = false);
      }
    } catch (e) {
      setState(() => _isLoading = false);
    }
  }

  Future<void> _saveEvidenceManifest() async {
    final directory = await getApplicationDocumentsDirectory();
    final file = File('${directory.path}/evidence_manifest_$_currentUserId.json');
    final jsonList = _evidenceList.map((e) => e.toJson()).toList();
    await file.writeAsString(jsonEncode(jsonList));
  }

  Future<void> _checkBiometrics() async {
    try {
      bool canCheck = await auth.canCheckBiometrics;
      if (canCheck) {
        bool didAuth = await auth.authenticate(
          localizedReason: 'Unlock Evidence Vault',
          options: const AuthenticationOptions(stickyAuth: true),
        );
        setState(() => _isAuthenticated = didAuth);
      } else {
        setState(() => _isAuthenticated = true);
      }
    } catch (e) {
      setState(() => _isAuthenticated = true);
    }
  }

  // --- [IMPORT LOGIC] ---
  Future<void> _importEvidence() async {
    FilePickerResult? result = await FilePicker.platform.pickFiles(
      type: FileType.any,
      allowMultiple: true, 
    );
    if (result != null) {
      _showContextDialog(files: result.files); // Pass files
    }
  }

  // NEW: Voice Recording Logic
  Future<void> _startRecording() async {
    try {
      if (await _audioRecorder.hasPermission()) {
        final directory = await getApplicationDocumentsDirectory();
        String path = '${directory.path}/VN_${DateTime.now().millisecondsSinceEpoch}.m4a';
        
        await _audioRecorder.start(const RecordConfig(), path: path);
        setState(() => _isRecording = true);
      }
    } catch (e) {
      print(e);
    }
  }

  Future<String?> _stopRecording() async {
    try {
      final path = await _audioRecorder.stop();
      setState(() => _isRecording = false);
      return path;
    } catch (e) {
      return null;
    }
  }

  // --- [CONTEXT DIALOG WITH MIC] ---
  void _showContextDialog({List<PlatformFile>? files, String? recordedPath}) {
    TextEditingController _noteController = TextEditingController();
    String _selectedCategory = "Threat";
    
    // If we have a recording, wrap it in a pseudo-file for display
    List<dynamic> displayItems = [];
    if (files != null) displayItems.addAll(files);
    if (recordedPath != null) displayItems.add("VOICE_NOTE");

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) {
        return StatefulBuilder(builder: (context, setModalState) {
          return Container(
            height: MediaQuery.of(context).size.height * 0.9,
            decoration: BoxDecoration(
              color: AppColors.surface,
              borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
            ),
            padding: EdgeInsets.fromLTRB(24, 24, 24, MediaQuery.of(context).viewInsets.bottom + 24),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Center(child: Container(width: 40, height: 4, color: AppColors.textDisabled)),
                SizedBox(height: 20),
                Text("Secure Evidence", style: TextStyle(color: AppColors.textHigh, fontSize: 20, fontWeight: FontWeight.bold)),
                
                SizedBox(height: 20),
                
                // PREVIEWS
                Container(
                  height: 80,
                  child: ListView.separated(
                    scrollDirection: Axis.horizontal,
                    itemCount: displayItems.length,
                    separatorBuilder: (_, __) => SizedBox(width: 10),
                    itemBuilder: (context, index) {
                      final item = displayItems[index];
                      if (item == "VOICE_NOTE") {
                        return Container(
                          width: 80,
                          decoration: BoxDecoration(color: Colors.redAccent.withOpacity(0.2), borderRadius: BorderRadius.circular(12)),
                          child: Icon(Feather.mic, color: Colors.redAccent),
                        );
                      }
                      final PlatformFile file = item as PlatformFile;
                      bool isImage = ['jpg', 'jpeg', 'png'].contains(file.extension?.toLowerCase());
                      return Container(
                        width: 80,
                        decoration: BoxDecoration(
                          color: AppColors.backgroundDeep,
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: AppColors.elevation),
                          image: isImage && file.path != null
                              ? DecorationImage(image: FileImage(File(file.path!)), fit: BoxFit.cover)
                              : null,
                        ),
                        child: !isImage 
                           ? Center(child: Icon(_getFileIcon(file.extension), color: AppColors.textMedium))
                           : null,
                      );
                    },
                  ),
                ),

                SizedBox(height: 20),
                
                // CATEGORY
                Text("TYPE", style: TextStyle(color: AppColors.textMedium, fontSize: 11, fontWeight: FontWeight.bold)),
                SizedBox(height: 10),
                Wrap(
                  spacing: 8,
                  children: _categoryColors.keys.map((cat) {
                    bool isSelected = _selectedCategory == cat;
                    return ChoiceChip(
                      label: Text(cat),
                      selected: isSelected,
                      selectedColor: _categoryColors[cat],
                      onSelected: (val) => setModalState(() => _selectedCategory = cat),
                    );
                  }).toList(),
                ),

                SizedBox(height: 20),
                
                // CONTEXT NOTE + RECORDER
                Text("CONTEXT (TEXT OR VOICE)", style: TextStyle(color: AppColors.textMedium, fontSize: 11, fontWeight: FontWeight.bold)),
                SizedBox(height: 10),
                Row(
                  children: [
                    Expanded(
                      child: TextField(
                        controller: _noteController,
                        maxLines: 3,
                        style: TextStyle(color: AppColors.textHigh),
                        decoration: InputDecoration(
                          hintText: "Add details...",
                          filled: true,
                          fillColor: AppColors.backgroundDeep,
                          border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
                        ),
                      ),
                    ),
                    SizedBox(width: 10),
                    // MICROPHONE BUTTON
                    GestureDetector(
                      onLongPress: () async {
                        await _startRecording();
                        setModalState(() {}); // Update UI to show red
                      },
                      onLongPressUp: () async {
                         String? path = await _stopRecording();
                         setModalState(() {});
                         if (path != null) {
                           // Close this modal and reopen it with the new audio file added
                           // In a real app, use a proper state manager. Here we simply create a PlatformFile from the recording.
                           Navigator.pop(context);
                           final audioFile = PlatformFile(name: "Voice_Note.m4a", size: 0, path: path);
                           List<PlatformFile> newFiles = files ?? [];
                           newFiles.add(audioFile);
                           _showContextDialog(files: newFiles);
                         }
                      },
                      child: Container(
                        width: 50, height: 50,
                        decoration: BoxDecoration(
                          color: _isRecording ? Colors.red : AppColors.primaryLavender,
                          shape: BoxShape.circle,
                          boxShadow: _isRecording ? [BoxShadow(color: Colors.redAccent, blurRadius: 10)] : []
                        ),
                        child: Icon(_isRecording ? Feather.mic : Feather.mic_off, color: Colors.white),
                      ),
                    ),
                  ],
                ),
                SizedBox(height: 5),
                if (_isRecording) Text("Recording... Release to save", style: TextStyle(color: Colors.redAccent, fontSize: 12)),
                if (!_isRecording) Text("Hold Mic to record voice note", style: TextStyle(color: AppColors.textDisabled, fontSize: 10)),

                Spacer(),
                
                // SAVE BUTTON
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton.icon(
                    icon: Icon(Feather.lock, color: Colors.white),
                    label: Text("Encrypt & Save"),
                    style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.primaryLavender,
                        padding: EdgeInsets.symmetric(vertical: 18),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12))),
                    onPressed: () async {
                      Navigator.pop(context);
                      await _processBatch(files ?? [], _noteController.text, _selectedCategory);
                    },
                  ),
                ),
              ],
            ),
          );
        });
      },
    );
  }

  // --- [HELPER METHODS] ---
  IconData _getFileIcon(String? ext) {
    if (ext == null) return Feather.file;
    if (['mp3', 'm4a', 'wav', 'aac'].contains(ext.toLowerCase())) return Feather.mic;
    if (['pdf', 'doc', 'docx'].contains(ext.toLowerCase())) return Feather.file_text;
    if (['mp4', 'mov', 'avi'].contains(ext.toLowerCase())) return Feather.video;
    return Feather.file;
  }

  EvidenceType _getEvidenceType(String? ext) {
    if (ext == null) return EvidenceType.document;
    String e = ext.toLowerCase();
    if (['jpg', 'jpeg', 'png', 'heic'].contains(e)) return EvidenceType.image;
    if (['mp3', 'm4a', 'wav', 'aac'].contains(e)) return EvidenceType.audio;
    if (['mp4', 'mov', 'avi'].contains(e)) return EvidenceType.video;
    return EvidenceType.document;
  }

  Future<void> _processBatch(List<PlatformFile> files, String note, String category) async {
    setState(() => _isLoading = true);
    final directory = await getApplicationDocumentsDirectory();

    for (var file in files) {
      if (file.path == null) continue;
      
      final String extension = file.extension ?? 'dat';
      // Save with safe unique name
      final String newPath = '${directory.path}/EV_${DateTime.now().millisecondsSinceEpoch}_${file.name.replaceAll(" ", "_")}';
      
      await File(file.path!).copy(newPath);

      _evidenceList.add(EvidenceItem(
        id: DateTime.now().toString() + "_" + file.name,
        filePath: newPath,
        originalName: file.name,
        contextNote: note,
        category: category,
        timestamp: DateTime.now(),
        type: _getEvidenceType(file.extension),
      ));
    }
    
    _sortEvidence();
    await _saveEvidenceManifest();
    
    setState(() => _isLoading = false);
    
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text("Items Secured. Please delete originals."), backgroundColor: Colors.orange),
    );
  }

  void _sortEvidence() {
    setState(() {
      if (_sortBy == 'Date (Newest)') {
        _evidenceList.sort((a, b) => b.timestamp.compareTo(a.timestamp));
      } else if (_sortBy == 'Date (Oldest)') {
        _evidenceList.sort((a, b) => a.timestamp.compareTo(b.timestamp));
      } else if (_sortBy == 'Category') {
        _evidenceList.sort((a, b) => a.category.compareTo(b.category));
      }
    });
  }

  // #8 NEW: ZIP EXPORT (Solves the "Video not opening" issue)
  Future<void> _generateAndShareZip() async {
    setState(() => _isLoading = true);

    try {
      final directory = await getApplicationDocumentsDirectory();
      final encoder = ZipFileEncoder();
      
      // 1. Create a Temp Directory for Staging
      final zipDir = Directory('${directory.path}/Case_Export_${DateTime.now().millisecondsSinceEpoch}');
      await zipDir.create();

      // 2. Generate the PDF Report (Text & Images only)
      final pdf = pw.Document();
      final font = await PdfGoogleFonts.robotoRegular();
      final boldFont = await PdfGoogleFonts.robotoBold();

      pdf.addPage(pw.MultiPage(
        theme: pw.ThemeData.withFont(base: font, bold: boldFont),
        build: (context) => [
          pw.Header(level: 0, child: pw.Text("CASE EVIDENCE REPORT", style: pw.TextStyle(fontSize: 24, fontWeight: pw.FontWeight.bold))),
          pw.Paragraph(text: "Refer to the 'Evidence_Files' folder in this ZIP archive for full resolution videos and audio files."),
          pw.Divider(),
          ..._evidenceList.map((item) => pw.Container(
            margin: pw.EdgeInsets.only(bottom: 20),
            child: pw.Row(
              crossAxisAlignment: pw.CrossAxisAlignment.start,
              children: [
                pw.Expanded(flex: 1, child: pw.Text(item.originalName, style: pw.TextStyle(fontSize: 10, color: PdfColors.grey700))),
                pw.SizedBox(width: 10),
                pw.Expanded(flex: 3, child: pw.Column(crossAxisAlignment: pw.CrossAxisAlignment.start, children: [
                  pw.Text(item.category.toUpperCase(), style: pw.TextStyle(color: PdfColors.red, fontWeight: pw.FontWeight.bold)),
                  pw.Text(item.contextNote, style: pw.TextStyle(fontStyle: pw.FontStyle.italic)),
                  if(item.type == EvidenceType.image) 
                    pw.Container(height: 150, child: pw.Image(pw.MemoryImage(File(item.filePath).readAsBytesSync()), fit: pw.BoxFit.contain))
                ]))
              ]
            )
          )).toList()
        ]
      ));

      // Save PDF to Staging
      final pdfFile = File('${zipDir.path}/Incident_Report.pdf');
      await pdfFile.writeAsBytes(await pdf.save());

      // 3. Create 'Evidence_Files' subfolder
      final evidenceDir = Directory('${zipDir.path}/Evidence_Files');
      await evidenceDir.create();

      // 4. Copy all Raw Files to Staging
      for (var item in _evidenceList) {
        final source = File(item.filePath);
        if (await source.exists()) {
          await source.copy('${evidenceDir.path}/${item.originalName}');
        }
      }

      // 5. Zip it all up
      final zipPath = '${directory.path}/Case_Export.zip';
      encoder.create(zipPath);
      encoder.addDirectory(zipDir);
      encoder.close();

      // 6. Share the ZIP
      await Share.shareXFiles([XFile(zipPath)], text: 'Secure Case Export');

      // Cleanup
      await zipDir.delete(recursive: true);

    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Export Failed: $e")));
    } finally {
      setState(() => _isLoading = false);
    }
  }

  // Deletion
  void _deleteItem(EvidenceItem item) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: AppColors.surface,
        title: Text("Delete Evidence?", style: TextStyle(color: AppColors.textHigh)),
        content: Text("Permanent deletion. Undo impossible.", style: TextStyle(color: AppColors.textMedium)),
        actions: [
          TextButton(onPressed: () => Navigator.pop(context), child: Text("Cancel")),
          TextButton(
            onPressed: () async {
              try {
                final file = File(item.filePath);
                if (await file.exists()) await file.delete();
              } catch (e) {}
              setState(() { _evidenceList.removeWhere((e) => e.id == item.id); });
              await _saveEvidenceManifest();
              Navigator.pop(context); // Close Confirm
              Navigator.pop(context); // Close Modal
            },
            child: Text("Delete", style: TextStyle(color: Colors.red)),
          ),
        ],
      ),
    );
  }

  void _showDetailModal(EvidenceItem item) {
    showDialog(
      context: context,
      builder: (context) => Dialog(
        backgroundColor: Colors.transparent,
        insetPadding: EdgeInsets.all(10),
        child: Container(
          decoration: BoxDecoration(color: AppColors.surface, borderRadius: BorderRadius.circular(20)),
          child: Column(
            children: [
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text("Detail View", style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold)),
                    Row(children: [
                      IconButton(icon: Icon(Feather.trash_2, color: Colors.red), onPressed: () => _deleteItem(item)),
                      IconButton(icon: Icon(Feather.x, color: AppColors.textHigh), onPressed: () => Navigator.pop(context)),
                    ])
                  ],
                ),
              ),
              Expanded(
                child: Container(
                  color: Colors.black,
                  width: double.infinity,
                  child: item.type == EvidenceType.image
                      ? InteractiveViewer(child: Image.file(File(item.filePath))) 
                      : Center(
                          child: Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Icon(_getFileIcon(item.filePath.split('.').last), size: 64, color: Colors.white),
                              SizedBox(height: 20),
                              Text("Multimedia Evidence", style: TextStyle(color: Colors.white)),
                              SizedBox(height: 20),
                              // PLAY BUTTON
                              ElevatedButton.icon(
                                icon: Icon(Feather.play),
                                label: Text("Play / Open"),
                                onPressed: () async {
                                  // Simple Audio Player implementation
                                  if (item.type == EvidenceType.audio) {
                                    final player = AudioPlayer();
                                    await player.play(DeviceFileSource(item.filePath));
                                    ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Playing audio...")));
                                  } else {
                                    ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Video playback requires 'video_player' package.")));
                                  }
                                },
                              )
                            ],
                          ),
                        ),
                ),
              ),
              Container(
                padding: EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(item.contextNote, style: TextStyle(color: AppColors.textHigh)),
                    SizedBox(height: 5),
                    Text(DateFormat('MMM dd, yyyy HH:mm').format(item.timestamp), style: TextStyle(color: AppColors.textDisabled, fontSize: 10)),
                  ],
                ),
              )
            ],
          ),
        ),
      ),
    );
  }

  // --- [BUILD METHOD] ---
  @override
  Widget build(BuildContext context) {
    if (!_isAuthenticated) {
      return Scaffold(
        backgroundColor: AppColors.backgroundDeep,
        body: Center(child: IconButton(icon: Icon(Feather.lock, size: 64, color: AppColors.textDisabled), onPressed: _checkBiometrics)),
      );
    }

    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundDeep,
        elevation: 0,
        title: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text("Evidence Locker", style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold, fontSize: 18)),
            Text("${_evidenceList.length} items secured", style: TextStyle(color: AppColors.textMedium, fontSize: 12)),
          ],
        ),
        actions: [
          PopupMenuButton<String>(
            icon: Icon(Feather.filter, color: AppColors.textHigh),
            onSelected: (val) { _sortBy = val; _sortEvidence(); },
            itemBuilder: (context) => ['Date (Newest)', 'Date (Oldest)', 'Category'].map((choice) => PopupMenuItem(value: choice, child: Text(choice))).toList(),
          ),
          IconButton(
            icon: Icon(Feather.package, color: Colors.redAccent), // Changed icon to package to represent ZIP
            tooltip: "Export Case File (ZIP)",
            onPressed: _evidenceList.isEmpty ? null : _generateAndShareZip,
          ),
        ],
      ),
      floatingActionButton: FloatingActionButton.extended(
        backgroundColor: AppColors.primaryLavender,
        onPressed: _importEvidence,
        icon: Icon(Feather.plus),
        label: Text("Add"),
      ),
      body: _isLoading 
          ? Center(child: CircularProgressIndicator()) 
          : _evidenceList.isEmpty ? _buildEmptyState() : _buildMasonryGrid(),
    );
  }

  Widget _buildEmptyState() {
    return Center(child: Column(mainAxisAlignment: MainAxisAlignment.center, children: [Icon(Feather.shield, size: 50, color: AppColors.textDisabled), SizedBox(height: 20), Text("Vault Empty", style: TextStyle(color: AppColors.textDisabled))]));
  }

  Widget _buildMasonryGrid() {
    return SingleChildScrollView(
      padding: EdgeInsets.all(16),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Expanded(child: _buildColumn(0)),
          SizedBox(width: 10),
          Expanded(child: _buildColumn(1)),
          SizedBox(width: 10),
          Expanded(child: _buildColumn(2)),
        ],
      ),
    );
  }

  Widget _buildColumn(int columnIndex) {
    List<EvidenceItem> items = [];
    for (int i = 0; i < _evidenceList.length; i++) {
      if (i % 3 == columnIndex) items.add(_evidenceList[i]);
    }

    return Column(
      children: items.map((item) {
        return GestureDetector(
          onTap: () => _showDetailModal(item),
          child: Container(
            margin: EdgeInsets.only(bottom: 10),
            decoration: BoxDecoration(
              color: AppColors.surface,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black12, blurRadius: 4)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                ClipRRect(
                  borderRadius: BorderRadius.vertical(top: Radius.circular(12)),
                  child: Container(
                    color: Colors.black12,
                    child: item.type == EvidenceType.image
                        ? Image.file(File(item.filePath), fit: BoxFit.cover)
                        : Container(
                            height: 80,
                            width: double.infinity,
                            color: AppColors.backgroundDeep,
                            child: Center(child: Icon(_getFileIcon(item.filePath.split('.').last), color: AppColors.textMedium)),
                          ),
                  ),
                ),
                Padding(
                  padding: const EdgeInsets.all(8.0),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Container(
                        padding: EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                        decoration: BoxDecoration(color: _categoryColors[item.category], borderRadius: BorderRadius.circular(4)),
                        child: Text(item.category, style: TextStyle(fontSize: 8, color: Colors.white, fontWeight: FontWeight.bold)),
                      ),
                      SizedBox(height: 4),
                      Text(item.contextNote.isNotEmpty ? item.contextNote : "No context", maxLines: 2, overflow: TextOverflow.ellipsis, style: TextStyle(color: AppColors.textHigh, fontSize: 10)),
                    ],
                  ),
                )
              ],
            ),
          ),
        );
      }).toList(),
    );
  }
}


--- C:\Code\femn\lib\wellness_widgets\leakguard\fake_payment_generator.dart ---

import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:intl/intl.dart';
import 'dart:math';
import 'package:femn/customization/colors.dart'; 
import 'package:google_fonts/google_fonts.dart';

// ==========================================
// SCREEN 1: THE INPUT FORM
// ==========================================
class FakePaymentForm extends StatefulWidget {
  @override
  _FakePaymentFormState createState() => _FakePaymentFormState();
}

class _FakePaymentFormState extends State<FakePaymentForm> {
  // Controllers
  final _amountController = TextEditingController();
  final _currencyController = TextEditingController(text: ""); // New Currency Input
  final _recipientNameController = TextEditingController();
  final _recipientAccountController = TextEditingController();
  final _senderNameController = TextEditingController(); 
  final _senderBankController = TextEditingController(text: "MONIE POINT"); // Default to match screenshot example
  
  // Defaults
  String _selectedRecipientBank = "OPay";
  String _status = "Successful"; // Changed default to "Successful" to match image
  DateTime _transactionDate = DateTime.now();

  // Bank Options
  final List<String> _banks = [
    "OPay", "PalmPay", "Access Bank", "GTBank", "Zenith Bank", "UBA", 
    "Kuda", "First Bank", "Fidelity Bank", "Monie Point"
  ];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundDeep,
        elevation: 0,
        leading: IconButton(
          icon: Icon(Feather.arrow_left, color: AppColors.textHigh),
          onPressed: () => Navigator.pop(context),
        ),
        title: Text("Decoy Generator", style: TextStyle(color: AppColors.textHigh)),
        centerTitle: true,
      ),
      body: SingleChildScrollView(
        padding: EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
             // Privacy Warning
             Container(
              padding: EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.orange.withOpacity(0.1),
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: Colors.orange.withOpacity(0.3)),
              ),
              child: Row(
                children: [
                  Icon(Feather.eye_off, color: Colors.orange, size: 16),
                  SizedBox(width: 10),
                  Expanded(
                    child: Text(
                      "Tip: Use 'Pending' status to stall. It implies network issues.",
                      style: TextStyle(color: Colors.orange, fontSize: 12),
                    ),
                  ),
                ],
              ),
            ),
            SizedBox(height: 20),

            Row(
              children: [
                Expanded(
                  flex: 1,
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      _buildLabel("Currency"),
                      _buildInput(_currencyController, ""),
                    ],
                  ),
                ),
                SizedBox(width: 10),
                Expanded(
                  flex: 3,
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                       _buildLabel("Decoy Amount"),
                       _buildInput(_amountController, "e.g. 7,000", isNumber: true),
                    ],
                  ),
                ),
              ],
            ),

            _buildLabel("Receiver Name (The Extortionist)"),
            _buildInput(_recipientNameController, "e.g. PRECIOUS EKE THANKGOD"),

            _buildLabel("Receiver Account Number"),
            _buildInput(_recipientAccountController, "e.g. 913 207 2555", isNumber: true),

            _buildLabel("Receiver Bank"),
            _buildDropdown(),

            Divider(color: AppColors.elevation, height: 40),

            _buildLabel("Your Name (Sender Name)"),
            _buildInput(_senderNameController, "e.g. OLUWAFERANMI FIYINFOLU"),

            _buildLabel("Sender Bank Name"),
            _buildInput(_senderBankController, "e.g. MONIE POINT"),

            SizedBox(height: 20),
            
            _buildLabel("Transaction Status"),
            Row(
              children: [
                _buildStatusChip("Successful", Colors.green),
                SizedBox(width: 10),
                _buildStatusChip("Pending", Colors.orange), 
              ],
            ),

            SizedBox(height: 40),

            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: Color(0xFF00C853), // OPay Green
                  padding: EdgeInsets.symmetric(vertical: 18),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                ),
                onPressed: () {
                  if (_amountController.text.isEmpty) return;

                  // Generate Random IDs (Longer to match screenshot)
                  String refId = "260108${Random().nextInt(999999)}${Random().nextInt(999999)}${Random().nextInt(999999)}";
                  String sessionId = "090405260108${Random().nextInt(99999999)}${Random().nextInt(99999999)}";
                  
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (context) => OPayReceiptScreen(
                        amount: _amountController.text,
                        currency: _currencyController.text,
                        recipientName: _recipientNameController.text,
                        recipientAccount: _recipientAccountController.text,
                        recipientBank: _selectedRecipientBank,
                        senderName: _senderNameController.text.isEmpty ? "User" : _senderNameController.text,
                        senderBank: _senderBankController.text,
                        status: _status,
                        date: _transactionDate,
                        refId: refId,
                        sessionId: sessionId,
                      ),
                    ),
                  );
                },
                child: Text(
                  "Generate Receipt", 
                  style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.white)
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildLabel(String text) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0, top: 12),
      child: Text(text, style: TextStyle(color: AppColors.textMedium, fontSize: 13)),
    );
  }

  Widget _buildInput(TextEditingController controller, String hint, {bool isNumber = false}) {
    return TextField(
      controller: controller,
      keyboardType: isNumber ? TextInputType.number : TextInputType.text,
      style: TextStyle(color: AppColors.textHigh),
      decoration: InputDecoration(
        hintText: hint,
        hintStyle: TextStyle(color: AppColors.textDisabled),
        filled: true,
        fillColor: AppColors.surface,
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: BorderSide.none),
        contentPadding: EdgeInsets.symmetric(horizontal: 16, vertical: 14),
      ),
    );
  }

  Widget _buildDropdown() {
    return Container(
      padding: EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.surface,
        borderRadius: BorderRadius.circular(8),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: _selectedRecipientBank,
          dropdownColor: AppColors.surface,
          isExpanded: true,
          items: _banks.map((bank) {
            return DropdownMenuItem(
              value: bank,
              child: Text(bank, style: TextStyle(color: AppColors.textHigh)),
            );
          }).toList(),
          onChanged: (val) => setState(() => _selectedRecipientBank = val!),
        ),
      ),
    );
  }

  Widget _buildStatusChip(String label, Color color) {
    bool isSelected = _status == label;
    return GestureDetector(
      onTap: () => setState(() => _status = label),
      child: Container(
        padding: EdgeInsets.symmetric(horizontal: 24, vertical: 10),
        decoration: BoxDecoration(
          color: isSelected ? color : Colors.transparent,
          borderRadius: BorderRadius.circular(4),
          border: Border.all(color: isSelected ? color : AppColors.textDisabled),
        ),
        child: Text(
          label,
          style: TextStyle(
            color: isSelected ? Colors.white : AppColors.textDisabled,
            fontWeight: FontWeight.bold,
            fontSize: 12,
          ),
        ),
      ),
    );
  }
}

// ==========================================
// SCREEN 2: THE OPAY REPLICA (Renderer)
// ==========================================
class OPayReceiptScreen extends StatefulWidget {
  final String amount;
  final String currency;
  final String recipientName;
  final String recipientAccount;
  final String recipientBank;
  final String senderName;
  final String senderBank;
  final String status;
  final DateTime date;
  final String refId;
  final String sessionId;

  const OPayReceiptScreen({
    Key? key,
    required this.amount,
    required this.currency,
    required this.recipientName,
    required this.recipientAccount,
    required this.recipientBank,
    required this.senderName,
    required this.senderBank,
    required this.status,
    required this.date,
    required this.refId,
    required this.sessionId,
  }) : super(key: key);

  @override
  State<OPayReceiptScreen> createState() => _OPayReceiptScreenState();
}

class _OPayReceiptScreenState extends State<OPayReceiptScreen> {
  
  @override
  void initState() {
    super.initState();
    // Trigger the SnackBar immediately
    WidgetsBinding.instance.addPostFrameCallback((_) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              Icon(Feather.camera, color: Colors.white, size: 20),
              SizedBox(width: 12),
              Expanded(child: Text("Screenshot this NOW!")),
            ],
          ),
          backgroundColor: Colors.redAccent,
          behavior: SnackBarBehavior.floating,
          duration: Duration(seconds: 10),
        ),
      );
    });
  }

  @override
  Widget build(BuildContext context) {
    // Exact Colors from Screenshot
    final opayGreen = Color(0xFF00BFA5); // Slightly tealish green
    final opayLogoGreen = Color(0xFF00C853);
    final opayLogoPurple = Color(0xFF1B0F6B); 
    final labelGrey = Color(0xFF9E9E9E);
    final textDark = Colors.black.withOpacity(0.85);

    // Format currency manually to insert the user's custom symbol
    String formattedAmount = "${widget.currency}${widget.amount}";

    return Scaffold(
      backgroundColor: Colors.white, // White background for the whole page
      appBar: AppBar(
        backgroundColor: Colors.white,
        elevation: 0,
        leading: IconButton(
          icon: Icon(Feather.chevron_left, color: Colors.grey, size: 28),
          onPressed: () => Navigator.pop(context),
        ),
        title: Text(
          "Share Receipt", 
          style: TextStyle(color: textDark, fontSize: 18, fontWeight: FontWeight.normal)
        ),
      ),
      body: SingleChildScrollView(
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 10),
          child: Container(
            // This container acts as the "paper"
            decoration: BoxDecoration(
              color: Colors.white,
              // Optional: Add shadow if you want it to look like a card, 
              // but the screenshot looks flat/clean.
            ),
            padding: EdgeInsets.all(20),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.center,
              children: [
                
                // 1. HEADER (Logo + Title)
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    // OPay Logo Construction
                    Row(
                      children: [
                        // The Logo Icon (Green broken circle)
                         Stack(
                           alignment: Alignment.center,
                           children: [
                             Container(
                               width: 28, height: 28,
                               decoration: BoxDecoration(
                                 shape: BoxShape.circle,
                                 border: Border.all(color: opayLogoGreen, width: 4),
                               ),
                             ),
                             // White cut to make it look like a 'C' or 'O'
                             Positioned(
                               right: -2,
                               child: Container(color: Colors.white, width: 8, height: 10)
                              )
                           ],
                         ),
                        SizedBox(width: 4),
                        // The 'Pay' Text
                        Text(
                          "Pay",
                          style: TextStyle(
                            color: opayLogoPurple,
                            fontSize: 24,
                            fontWeight: FontWeight.bold,
                            fontFamily: 'Roboto',
                          ),
                        ),
                      ],
                    ),
                    
                    Text(
                      "Transaction Receipt",
                      style: TextStyle(
                        color: Colors.black,
                        fontSize: 14,
                      ),
                    ),
                  ],
                ),

                SizedBox(height: 40),

                // 2. AMOUNT & STATUS
                Text(
                  formattedAmount,
                  style: TextStyle(
                    color: opayGreen,
                    fontSize: 30,
                    fontWeight: FontWeight.w900,
                  ),
                ),
                SizedBox(height: 8),
                Text(
                  widget.status, // "Successful"
                  style: TextStyle(
                    color: Color(0xFF424242), // Dark grey/black for status
                    fontSize: 16,
                    fontWeight: FontWeight.normal,
                  ),
                ),
                SizedBox(height: 6),
                Text(
                  DateFormat('MMM dd, yyyy HH:mm:ss').format(widget.date),
                  style: TextStyle(color: labelGrey, fontSize: 11),
                ),

                SizedBox(height: 20),
                Divider(thickness: 0.5, color: Colors.grey[300]),
                SizedBox(height: 20),

                // 3. DETAILS BLOCK
                // The screenshot uses a specific layout: Left Label, Right Value (Right aligned)
                
                _buildRecipientDetailRow(
                  "Recipient Details", 
                  widget.recipientName.toUpperCase(), 
                  "${widget.recipientBank} | ${widget.recipientAccount}",
                  textDark, labelGrey
                ),
                SizedBox(height: 20),
                
                _buildRecipientDetailRow(
                  "Sender Details", 
                  widget.senderName.toUpperCase(), 
                  "${widget.senderBank} | 553****951", // Masked sender number like screenshot
                  textDark, labelGrey
                ),
                SizedBox(height: 20),

                _buildSimpleRow("Transaction Type", "Bank Deposit", textDark, labelGrey),
                SizedBox(height: 20),

                _buildSimpleRow("Transaction No.", widget.refId, textDark, labelGrey),
                SizedBox(height: 20),
                
                _buildSimpleRow("Session ID", widget.sessionId, textDark, labelGrey),

                SizedBox(height: 50),

                // 4. FOOTER (Exact Text)
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 10.0),
                  child: Text(
                    "Enjoy a better life with OPay. Get free transfers, withdrawals, bill payments, instant loans, and good annual interest on your savings. OPay is licensed by the Central Bank of Nigeria and insured by the NDIC.",
                    textAlign: TextAlign.center,
                    style: GoogleFonts.caveat( // Handwriting style font
                      color: labelGrey,
                      fontSize: 13,
                      height: 1.2,
                    ),
                  ),
                ),
                SizedBox(height: 40),
                
                // Bottom Pattern (Optional representation of receipt tear)
                Row(
                  children: List.generate(30, (index) => Expanded(
                    child: Container(
                      height: 5,
                      decoration: BoxDecoration(
                        color: Colors.grey[100],
                        shape: BoxShape.circle,
                      ),
                    ),
                  )),
                )
              ],
            ),
          ),
        ),
      ),
    );
  }

  // Row for "Transaction Type", "Ref", "Session"
  Widget _buildSimpleRow(String label, String value, Color dark, Color grey) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Expanded(
          flex: 2,
          child: Text(label, style: TextStyle(color: grey, fontSize: 13))
        ),
        Expanded(
          flex: 3,
          child: Text(
            value, 
            textAlign: TextAlign.right,
            style: TextStyle(color: dark, fontSize: 13, fontWeight: FontWeight.normal),
          ),
        ),
      ],
    );
  }

  // Row for Recipient/Sender (Two lines for value)
  Widget _buildRecipientDetailRow(String label, String mainValue, String subValue, Color dark, Color grey) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Expanded(
          flex: 2,
          child: Text(label, style: TextStyle(color: grey, fontSize: 13))
        ),
        Expanded(
          flex: 4,
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Text(
                mainValue, 
                textAlign: TextAlign.right,
                style: TextStyle(color: dark, fontSize: 13, fontWeight: FontWeight.bold),
              ),
              SizedBox(height: 4),
              Text(
                subValue, 
                textAlign: TextAlign.right,
                style: TextStyle(color: Colors.black54, fontSize: 12),
              ),
            ],
          ),
        ),
      ],
    );
  }
}


--- C:\Code\femn\lib\wellness_widgets\leakguard\leakguard.dart ---

import 'package:flutter/material.dart';
import 'package:flutter/services.dart'; // Added for Clipboard
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:url_launcher/url_launcher.dart'; // Added for opening links/calls
import 'package:femn/customization/colors.dart'; 
import 'package:femn/wellness_widgets/leakguard/negotiation_playbook.dart';
import 'package:femn/wellness_widgets/leakguard/negotiation_data.dart';
import 'package:femn/wellness_widgets/leakguard/fake_payment_generator.dart';
import 'package:femn/wellness_widgets/leakguard/evidence_locker.dart';
import 'package:femn/wellness_widgets/leakguard/social_airlock.dart';
import 'cease_desist_generator.dart';
import 'deepfake_defense.dart';

class LeakGuardScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundDeep,
        elevation: 0,
        leading: IconButton(
          icon: Icon(Feather.arrow_left, color: AppColors.textHigh),
          onPressed: () => Navigator.pop(context),
        ),
        title: Text(
          "Leak Guard",
          style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold),
        ),
        centerTitle: true,
        actions: [
          IconButton(
            icon: Icon(Feather.info, color: AppColors.textMedium),
            onPressed: () {
              // Info Dialog Logic
              showDialog(
                context: context,
                builder: (context) => Dialog(
                  backgroundColor: AppColors.surface,
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
                  child: Container(
                    padding: EdgeInsets.all(24),
                    constraints: BoxConstraints(maxHeight: MediaQuery.of(context).size.height * 0.8),
                    child: Column(
                      children: [
                        Row(
                          children: [
                            Icon(Feather.shield, color: AppColors.primaryLavender),
                            SizedBox(width: 10),
                            Text("About LeakGuard", style: TextStyle(color: AppColors.textHigh, fontSize: 18, fontWeight: FontWeight.bold)),
                          ],
                        ),
                        SizedBox(height: 16),
                        Expanded(
                          child: SingleChildScrollView(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text("WHAT IS SEXTORTION?", style: TextStyle(color: Colors.redAccent, fontSize: 12, fontWeight: FontWeight.bold)),
                                SizedBox(height: 8),
                                Text("Sextortion is a crime where someone threatens to share your intimate images or videos unless you pay money or do what they say. It relies on fear and panic.", style: TextStyle(color: AppColors.textMedium, height: 1.5)),
                                SizedBox(height: 24),
                                Text("HOW WE PROTECT YOU", style: TextStyle(color: AppColors.primaryLavender, fontSize: 12, fontWeight: FontWeight.bold)),
                                SizedBox(height: 16),
                                _buildInfoItem("Panic Button", "Instantly lock down your social media accounts to hide your friends list from the attacker."),
                                _buildInfoItem("Negotiation Playbook", "Psychological scripts to stall the attacker and buy you time without paying."),
                                _buildInfoItem("Fake Payment", "Generate a realistic 'Pending' transaction receipt to fool them into waiting."),
                                _buildInfoItem("Evidence Locker", "Securely store proofs (screenshots/threats) in an encrypted vault hidden from your gallery."),
                                _buildInfoItem("Social Airlock", "Step-by-step guides to harden your privacy settings on Facebook, Instagram, and LinkedIn."),
                                _buildInfoItem("Cease & Desist", "Generate a formal legal document citing criminal codes to scare the attacker."),
                                _buildInfoItem("Deepfake Defense", "Statements to deny the authenticity of leaks by claiming they are AI-generated."),
                              ],
                            ),
                          ),
                        ),
                        SizedBox(height: 16),
                        SizedBox(
                          width: double.infinity,
                          child: ElevatedButton(
                            style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryLavender),
                            onPressed: () => Navigator.pop(context),
                            child: Text("Understood", style: TextStyle(color: Colors.white)),
                          ),
                        )
                      ],
                    ),
                  ),
                ),
              );
            },
          )
        ],
      ),
      body: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 20.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Header Card
            Container(
              padding: EdgeInsets.all(20),
              decoration: BoxDecoration(
                color: AppColors.surface,
                borderRadius: BorderRadius.circular(20),
                border: Border.all(color: AppColors.elevation),
              ),
              child: Row(
                children: [
                  Container(
                    padding: EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: AppColors.primaryLavender.withOpacity(0.1),
                      shape: BoxShape.circle,
                    ),
                    child: Icon(Feather.shield, color: AppColors.primaryLavender, size: 28),
                  ),
                  SizedBox(width: 16),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          "Anti-Sextortion Defense",
                          style: TextStyle(
                            color: AppColors.textHigh,
                            fontWeight: FontWeight.bold,
                            fontSize: 16,
                          ),
                        ),
                        SizedBox(height: 4),
                        Text(
                          "Secure your digital footprint and get help immediately.",
                          style: TextStyle(color: AppColors.textMedium, fontSize: 13),
                        ),
                      ],
                    ),
                  )
                ],
              ),
            ),
            
            SizedBox(height: 24),

            // Scrollable Features List
            Expanded(
              child: ListView(
                physics: BouncingScrollPhysics(),
                children: [
                  
                  // PHASE 2: EMERGENCY (Top Priority)
                  Text(
                    "CRITICAL RESPONSE",
                    style: TextStyle(
                      color: Colors.redAccent, 
                      fontWeight: FontWeight.bold, 
                      fontSize: 12,
                      letterSpacing: 1.2
                    ),
                  ),
                  SizedBox(height: 10),
                  _buildPanicButton(context),
                  SizedBox(height: 24),

                  // PHASE 2: TACTICAL TOOLS (During)
                  Text(
                    "TACTICAL TOOLS",
                    style: TextStyle(
                      color: AppColors.textMedium, 
                      fontWeight: FontWeight.bold, 
                      fontSize: 12,
                      letterSpacing: 1.2
                    ),
                  ),
                  SizedBox(height: 10),
                  _buildFeatureTile(
                    context,
                    title: "Negotiation Playbook",
                    subtitle: "Scripts to stall and de-escalate.",
                    icon: Feather.message_square,
                    color: Colors.orangeAccent,
                    onTap: () {
                      Navigator.push(
                        context,
                        MaterialPageRoute(builder: (context) => NegotiationPlaybookScreen()),
                      );
                    },
                  ),
                  _buildFeatureTile(
                    context,
                    title: "Fake Payment Generator",
                    subtitle: "Create a decoy receipt to buy time.",
                    icon: Feather.credit_card,
                    color: Colors.blueAccent,
                    onTap: () {
                      Navigator.push(
                        context,
                        MaterialPageRoute(builder: (context) => FakePaymentForm()),
                      );
                    },
                  ),
                  _buildFeatureTile(
                    context,
                    title: "Evidence Locker",
                    subtitle: "Securely store proofs before deleting.",
                    icon: Feather.hard_drive,
                    color: Colors.tealAccent,
                    onTap: () {
                      Navigator.push(
                        context,
                        MaterialPageRoute(builder: (context) => EvidenceLockerScreen()),
                      );
                    },
                  ),

                  SizedBox(height: 24),

                  // PHASE 1 & 3: PREVENTION & LEGAL (Before/After)
                  Text(
                    "PREVENTION & LEGAL",
                    style: TextStyle(
                      color: AppColors.textMedium, 
                      fontWeight: FontWeight.bold, 
                      fontSize: 12,
                      letterSpacing: 1.2
                    ),
                  ),
                  SizedBox(height: 10),
                  _buildFeatureTile(
                    context,
                    title: "Social Airlock",
                    subtitle: "Hide friend lists & lock profiles.",
                    icon: Feather.lock,
                    color: AppColors.primaryLavender,
                    onTap: () {
                      Navigator.push(
                        context,
                        MaterialPageRoute(builder: (context) => SocialAirlockScreen()),
                      );
                    },
                  ),
                  _buildFeatureTile(
                    context,
                    title: "Cease & Desist",
                    subtitle: "Generate formal legal warnings.",
                    icon: Feather.file_text,
                    color: AppColors.primaryLavender,
                    onTap: () {
                      Navigator.push(
                        context,
                        MaterialPageRoute(builder: (context) => CeaseDesistScreen()),
                      );
                    },
                  ),
                  _buildFeatureTile(
                    context,
                    title: "Deepfake Defense",
                    subtitle: "Plausible deniability strategy.",
                    icon: Feather.cpu,
                    color: AppColors.primaryLavender,
                    onTap: () {
                      Navigator.push(
                        context,
                        MaterialPageRoute(builder: (context) => DeepfakeDefenseScreen()),
                      );
                    },
                  ),
                  
                  SizedBox(height: 24),

                  // ---------------------------------------------
                  // NEW SECTION: WHO TO CONTACT
                  // ---------------------------------------------
                  Text(
                    "IMMEDIATE HELP & REPORTING",
                    style: TextStyle(
                      color: Colors.greenAccent, 
                      fontWeight: FontWeight.bold, 
                      fontSize: 12,
                      letterSpacing: 1.2
                    ),
                  ),
                  SizedBox(height: 10),

                  // --- NIGERIA SUPPORT ---
                  Text("Nigeria Support", style: TextStyle(color: AppColors.textMedium, fontSize: 11, fontWeight: FontWeight.bold)),
                  SizedBox(height: 8),
                  
                  _buildContactCard(
                    context,
                    title: "NAPTIP",
                    desc: "Agency for Prohibition of Trafficking in Persons. Handles blackmail & violence cases.",
                    actions: [
                      _ContactAction(icon: Feather.phone, label: "627 (Toll-Free)", value: "tel:627"),
                      _ContactAction(icon: Feather.mail, label: "info@naptip.gov.ng", value: "mailto:info@naptip.gov.ng"),
                      _ContactAction(icon: Feather.globe, label: "naptip.gov.ng", value: "https://naptip.gov.ng"),
                    ]
                  ),
                  _buildContactCard(
                    context,
                    title: "NPF-NCCC",
                    desc: "Nigeria Police Cybercrime Centre. Report cyberstalking & sextortion.",
                    actions: [
                      _ContactAction(icon: Feather.globe, label: "Report Portal (incb.police.gov.ng)", value: "https://incb.police.gov.ng"),
                      _ContactAction(icon: Feather.mail, label: "police@nccc.gov.ng", value: "mailto:police@nccc.gov.ng"),
                    ]
                  ),
                  _buildContactCard(
                    context,
                    title: "WARIF",
                    desc: "Women at Risk International Foundation. Confidential counseling & support.",
                    actions: [
                      _ContactAction(icon: Feather.phone, label: "0800 927 43472", value: "tel:080092743472"),
                      _ContactAction(icon: Feather.message_circle, label: "WhatsApp: 0907 819 0505", value: "https://wa.me/2349078190505"),
                    ]
                  ),

                  SizedBox(height: 16),

                  // --- GLOBAL DEFENSE ---
                  Text("Global & Technical Defense", style: TextStyle(color: AppColors.textMedium, fontSize: 11, fontWeight: FontWeight.bold)),
                  SizedBox(height: 8),

                  _buildContactCard(
                    context,
                    title: "StopNCII.org",
                    desc: "Create a digital hash of your images to block them from uploading to FB, Insta, TikTok & OnlyFans.",
                    actions: [
                      _ContactAction(icon: Feather.shield, label: "Open StopNCII.org", value: "https://stopncii.org"),
                    ]
                  ),
                  _buildContactCard(
                    context,
                    title: "Take It Down (For Minors)",
                    desc: "Operated by NCMEC. Removes images of anyone under 18 from the internet.",
                    actions: [
                      _ContactAction(icon: Feather.user_minus, label: "Open TakeItDown", value: "https://takeitdown.ncmec.org"),
                    ]
                  ),
                  _buildContactCard(
                    context,
                    title: "FBI / IC3",
                    desc: "Internet Crime Complaint Center. Use if perpetrator is international/US-based.",
                    actions: [
                      _ContactAction(icon: Feather.flag, label: "File Complaint (ic3.gov)", value: "https://ic3.gov"),
                    ]
                  ),

                  // Bottom Padding
                  SizedBox(height: 40),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildInfoItem(String title, String desc) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12.0),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Icon(Feather.check_circle, size: 16, color: AppColors.textDisabled),
          SizedBox(width: 10),
          Expanded(
            child: RichText(
              text: TextSpan(
                style: TextStyle(color: AppColors.textMedium, fontSize: 13, height: 1.4, fontFamily: 'Roboto'),
                children: [
                  TextSpan(text: "$title: ", style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.textHigh)),
                  TextSpan(text: desc),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  // WIDGET: Contact Card for Help Section
  Widget _buildContactCard(BuildContext context, {required String title, required String desc, required List<_ContactAction> actions}) {
    return Container(
      margin: EdgeInsets.only(bottom: 12),
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surface,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.elevation),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(title, style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold, fontSize: 14)),
          SizedBox(height: 4),
          Text(desc, style: TextStyle(color: AppColors.textMedium, fontSize: 12)),
          SizedBox(height: 12),
          Column(
            children: actions.map((action) {
              return InkWell(
                onTap: () async {
                  final Uri uri = Uri.parse(action.value);
                  if (await canLaunchUrl(uri)) {
                    await launchUrl(uri, mode: LaunchMode.externalApplication);
                  } else {
                    ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Could not launch ${action.label}")));
                  }
                },
                onLongPress: () {
                  Clipboard.setData(ClipboardData(text: action.value.replaceAll(RegExp(r'(tel:|mailto:|https:)'), '')));
                  ScaffoldMessenger.of(context).showSnackBar(SnackBar(
                    content: Text("Copied ${action.label} to clipboard"),
                    backgroundColor: AppColors.primaryLavender,
                    duration: Duration(seconds: 1),
                  ));
                },
                child: Padding(
                  padding: const EdgeInsets.symmetric(vertical: 6.0),
                  child: Row(
                    children: [
                      Icon(action.icon, size: 14, color: AppColors.primaryLavender),
                      SizedBox(width: 8),
                      Text(action.label, style: TextStyle(color: AppColors.primaryLavender, fontWeight: FontWeight.w600, fontSize: 12)),
                      Spacer(),
                      Icon(Feather.copy, size: 12, color: AppColors.textDisabled),
                    ],
                  ),
                ),
              );
            }).toList(),
          )
        ],
      ),
    );
  }

  // WIDGET: The Big Red Panic Button
  Widget _buildPanicButton(BuildContext context) {
    return SocialLockdownButton(
      onTap: () {
        // Trigger your actual logic here
        print("Panic Protocol Started");
      },
    );
  }

  // WIDGET: Standard Feature Tile
  Widget _buildFeatureTile(BuildContext context, {
    required String title, 
    required String subtitle, 
    required IconData icon, 
    required Color color,
    required VoidCallback onTap,
  }) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12.0),
      child: GestureDetector(
        onTap: onTap,
        child: Container(
          padding: EdgeInsets.symmetric(horizontal: 16, vertical: 16),
          decoration: BoxDecoration(
            color: AppColors.surface,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: AppColors.elevation),
          ),
          child: Row(
            children: [
              Icon(icon, color: color, size: 22),
              SizedBox(width: 16),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      title,
                      style: TextStyle(
                        color: AppColors.textHigh,
                        fontWeight: FontWeight.w600,
                        fontSize: 15,
                      ),
                    ),
                    SizedBox(height: 2),
                    Text(
                      subtitle,
                      style: TextStyle(color: AppColors.textMedium, fontSize: 12),
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ],
                ),
              ),
              Icon(Feather.chevron_right, color: AppColors.textDisabled, size: 18),
            ],
          ),
        ),
      ),
    );
  }
}

// Helper Class for Contact Actions
class _ContactAction {
  final IconData icon;
  final String label;
  final String value; // tel:..., mailto:..., or https:...

  _ContactAction({required this.icon, required this.label, required this.value});
}

class SocialLockdownButton extends StatefulWidget {
  final VoidCallback onTap;

  const SocialLockdownButton({Key? key, required this.onTap}) : super(key: key);

  @override
  _SocialLockdownButtonState createState() => _SocialLockdownButtonState();
}

class _SocialLockdownButtonState extends State<SocialLockdownButton> {
  bool _isCalmed = false;

  void _activateLockdown() {
    if (_isCalmed) return; // Prevent double taps

    // 1. Trigger the logic passed from parent
    widget.onTap();

    // 2. Start the visual calming transition
    setState(() => _isCalmed = true);
  }

  @override
  Widget build(BuildContext context) {
    // Define active colors based on state
    final Color primaryColor = _isCalmed ? AppColors.primaryLavender : Colors.redAccent;
    final Color glowColor = _isCalmed ? AppColors.primaryLavender.withOpacity(0.25) : Colors.redAccent.withOpacity(0.2);
    
    return GestureDetector(
      onTap: _activateLockdown,
      child: AnimatedContainer(
        // Slow, 1.5s duration for a deep breath effect
        duration: Duration(milliseconds: 1500),
        curve: Curves.easeInOutCubic, 
        padding: EdgeInsets.all(20),
        decoration: BoxDecoration(
          // Gradient animates from Red/Transparent to Lavender/Transparent
          gradient: LinearGradient(
            colors: [glowColor, Colors.transparent],
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
          ),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: _isCalmed ? AppColors.primaryLavender : Colors.redAccent.withOpacity(0.5),
            width: 1,
          ),
        ),
        child: Row(
          children: [
            // --- ANIMATED ICON CIRCLE ---
            AnimatedContainer(
              duration: Duration(milliseconds: 1500),
              curve: Curves.easeInOut,
              padding: EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: glowColor,
                shape: BoxShape.circle,
              ),
              child: AnimatedSwitcher(
                duration: Duration(milliseconds: 600),
                child: Icon(
                  _isCalmed ? Feather.shield : Feather.alert_triangle,
                  key: ValueKey(_isCalmed), // Key enforces the switch animation
                  color: primaryColor,
                  size: 24,
                ),
              ),
            ),
            
            SizedBox(width: 16),
            
            // --- ANIMATED TEXT ---
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  AnimatedDefaultTextStyle(
                    duration: Duration(milliseconds: 1500),
                    style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 16,
                      fontFamily: 'Roboto', // Ensure this matches your app font
                    ),
                    child: Text(_isCalmed ? "Social Airlock Active" : "Do Not Panic"),
                  ),
                  SizedBox(height: 4),
                  AnimatedDefaultTextStyle(
                    duration: Duration(milliseconds: 1500),
                    style: TextStyle(
                      color: _isCalmed ? AppColors.primaryLavender : AppColors.textMedium,
                      fontSize: 13,
                    ),
                    child: Text(_isCalmed 
                      ? "Protocol initiated. Stay safe." 
                      : "Let's fix this together, step by step."
                    ),
                  ),
                ],
              ),
            ),

            // --- LIKE BUTTON ANIMATION ---
            AnimatedSwitcher(
              duration: Duration(milliseconds: 800),
              transitionBuilder: (Widget child, Animation<double> animation) {
                // Creates a "Pop" effect (scales up then settles)
                return ScaleTransition(
                  scale: CurvedAnimation(parent: animation, curve: Curves.elasticOut),
                  child: child,
                );
              },
              child: _isCalmed
                  ? Icon(
                      Feather.heart, // Filled heart
                      key: ValueKey('filled'),
                      color: AppColors.primaryLavender,
                      size: 26,
                    )
                  : Icon(
                      Feather.heart, // Outline heart
                      key: ValueKey('outline'),
                      color: AppColors.textDisabled,
                      size: 24,
                    ),
            ),
          ],
        ),
      ),
    );
  }
}


--- C:\Code\femn\lib\wellness_widgets\leakguard\negotiation_data.dart ---

import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:femn/wellness_widgets/leakguard/negotiation_playbook.dart';
class PlaybookScenario {
  final String title;
  final String trigger; // "They said..."
  final String script;
  final String logic;
  final IconData icon;
  final Color color;
  final bool showFakePaymentOption;

  PlaybookScenario({
    required this.title,
    required this.trigger,
    required this.script,
    required this.logic,
    required this.icon,
    required this.color,
    this.showFakePaymentOption = false,
  });
}

class NegotiationData {
  // THE GOLDEN RULES (The "Never" List)
  static final List<String> goldenRules = [
    "NEVER Pay. It marks you as a target who will pay again.",
    "NEVER Apologize. It validates their power over you.",
    "NEVER Send 'One Last Photo'. It is a trap.",
  ];

  // THE SCRIPTS (The "Action" Options)
  static final List<PlaybookScenario> scenarios = [
    PlaybookScenario(
      title: " The Stall Tactic",
      trigger: "They demanded money immediately.",
      icon: Feather.clock,
      color: Colors.blueAccent,
      script: "I don't have that amount in my account. I need 24 hours to sell my phone/laptop to get the cash. Please wait.",
      logic: "Extortionists want speed. This script forces them to wait without saying 'No'. It buys you time to contact police or lock your accounts.",
      showFakePaymentOption: true,
    ),
    PlaybookScenario(
      title: "The Grey Rock",
      trigger: "They are insulting or threatening you.",
      icon: Feather.shield,
      color: Colors.grey,
      script: "I understand.",
      logic: "Boring responses kill their thrill. If you don't cry or beg, they lose the emotional 'high' of the attack.",
      showFakePaymentOption: false,
    ),
    PlaybookScenario(
      title: "The Broken Record",
      trigger: "They keep pressuring you to pay NOW.",
      icon: Feather.repeat,
      color: Colors.orangeAccent,
      script: "As I said, I am trying to get the money. Screaming at me won't make the bank open faster.",
      logic: "Repetition shows you are not panicked. You are sticking to the plan (The Stall).",
      showFakePaymentOption: true,
    ),
    PlaybookScenario(
      title: "The Bluff Call",
      trigger: "They threaten to send it to your family.",
      icon: Feather.users,
      color: Colors.redAccent,
      script: "(Do not reply. Go Silent.)",
      logic: "If they were going to do it, they would have done it. They want you to beg. Silence makes them wonder if you've already gone to the police.",
      showFakePaymentOption: false,
    ),
  ];
}


--- C:\Code\femn\lib\wellness_widgets\leakguard\negotiation_playbook.dart ---

import 'package:flutter/material.dart';
import 'package:flutter/services.dart'; // For Clipboard
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:femn/customization/colors.dart'; 
import 'package:femn/wellness_widgets/leakguard/negotiation_data.dart';
import 'package:femn/wellness_widgets/leakguard/fake_payment_generator.dart';

class NegotiationPlaybookScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundDeep,
        elevation: 0,
        leading: IconButton(
          icon: Icon(Feather.arrow_left, color: AppColors.textHigh),
          onPressed: () => Navigator.pop(context),
        ),
        title: Text("Negotiation Playbook", style: TextStyle(color: AppColors.textHigh)),
        centerTitle: true,
      ),
      body: Column(
        children: [
          // 1. THE GOLDEN RULES CARD
          _buildGoldenRulesCard(),

          SizedBox(height: 10),

          // Section Title
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
            child: Row(
              children: [
                Text(
                  "WHAT IS HAPPENING NOW?",
                  style: TextStyle(
                    color: AppColors.textMedium,
                    fontSize: 12,
                    fontWeight: FontWeight.bold,
                    letterSpacing: 1.2,
                  ),
                ),
              ],
            ),
          ),

          // 2. SCENARIO LIST
          Expanded(
            child: ListView.builder(
              padding: EdgeInsets.symmetric(horizontal: 20),
              itemCount: NegotiationData.scenarios.length,
              itemBuilder: (context, index) {
                return _buildScenarioTile(context, NegotiationData.scenarios[index]);
              },
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildGoldenRulesCard() {
    return Container(
      margin: EdgeInsets.all(20),
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Colors.redAccent.withOpacity(0.1),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Colors.redAccent.withOpacity(0.3)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(Feather.alert_octagon, color: Colors.redAccent, size: 20),
              SizedBox(width: 10),
              Text(
                "THE GOLDEN RULES",
                style: TextStyle(
                  color: Colors.redAccent,
                  fontWeight: FontWeight.bold,
                  letterSpacing: 1.0,
                ),
              ),
            ],
          ),
          SizedBox(height: 12),
          ...NegotiationData.goldenRules.map((rule) => Padding(
            padding: const EdgeInsets.only(bottom: 8.0),
            child: Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(" ", style: TextStyle(color: Colors.redAccent, fontWeight: FontWeight.bold)),
                Expanded(
                  child: Text(
                    rule,
                    style: TextStyle(color: AppColors.textHigh, fontSize: 14),
                  ),
                ),
              ],
            ),
          )).toList(),
        ],
      ),
    );
  }

  Widget _buildScenarioTile(BuildContext context, PlaybookScenario scenario) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12.0),
      child: GestureDetector(
        onTap: () => _showScenarioDetails(context, scenario),
        child: Container(
          padding: EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: AppColors.surface,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: AppColors.elevation),
          ),
          child: Row(
            children: [
              Container(
                padding: EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: scenario.color.withOpacity(0.1),
                  shape: BoxShape.circle,
                ),
                child: Icon(scenario.icon, color: scenario.color, size: 24),
              ),
              SizedBox(width: 16),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      scenario.trigger,
                      style: TextStyle(
                        color: AppColors.textHigh,
                        fontWeight: FontWeight.w600,
                        fontSize: 15,
                      ),
                    ),
                    SizedBox(height: 4),
                    Text(
                      "Use: ${scenario.title}",
                      style: TextStyle(color: scenario.color, fontSize: 13, fontWeight: FontWeight.bold),
                    ),
                  ],
                ),
              ),
              Icon(Feather.chevron_right, color: AppColors.textDisabled),
            ],
          ),
        ),
      ),
    );
  }

  // 3. BOTTOM SHEET DETAIL VIEW
  void _showScenarioDetails(BuildContext context, PlaybookScenario scenario) {
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      isScrollControlled: true,
      builder: (context) {
        return Container(
          height: MediaQuery.of(context).size.height * 0.7,
          decoration: BoxDecoration(
            color: AppColors.surface,
            borderRadius: BorderRadius.only(
              topLeft: Radius.circular(24),
              topRight: Radius.circular(24),
            ),
          ),
          padding: EdgeInsets.all(24),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Handle Bar
              Center(
                child: Container(
                  width: 40,
                  height: 4,
                  decoration: BoxDecoration(
                    color: AppColors.textDisabled,
                    borderRadius: BorderRadius.circular(2),
                  ),
                ),
              ),
              SizedBox(height: 24),
              
              // Title
              Row(
                children: [
                  Icon(scenario.icon, color: scenario.color),
                  SizedBox(width: 10),
                  Text(
                    scenario.title,
                    style: TextStyle(
                      color: AppColors.textHigh,
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ],
              ),
              SizedBox(height: 24),

              // THE SCRIPT (The Hero of the screen)
              Text("COPY & PASTE THIS:", style: TextStyle(color: AppColors.textMedium, fontSize: 12)),
              SizedBox(height: 8),
              Container(
                width: double.infinity,
                padding: EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: AppColors.backgroundDeep,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: scenario.color.withOpacity(0.5)),
                ),
                child: SelectableText(
                  scenario.script,
                  style: TextStyle(
                    color: AppColors.textHigh,
                    fontSize: 18,
                    fontFamily: 'Courier', // Monospace font looks more "script-like"
                  ),
                ),
              ),
              
              SizedBox(height: 16),
              
              // Action Buttons
              Row(
                children: [
                  Expanded(
                    child: ElevatedButton.icon(
                      style: ElevatedButton.styleFrom(
                        backgroundColor: scenario.color,
                        padding: EdgeInsets.symmetric(vertical: 16),
                      ),
                      icon: Icon(Feather.copy, color: Colors.white),
                      label: Text("Copy Text", style: TextStyle(color: Colors.white)),
                      onPressed: () {
                        Clipboard.setData(ClipboardData(text: scenario.script));
                        ScaffoldMessenger.of(context).showSnackBar(
                          SnackBar(content: Text("Script copied to clipboard")),
                        );
                        Navigator.pop(context);
                      },
                    ),
                  ),
                ],
              ),

              SizedBox(height: 24),
              
              // The Logic (Why this works)
              Text("WHY THIS WORKS:", style: TextStyle(color: AppColors.textMedium, fontSize: 12)),
              SizedBox(height: 8),
              Text(
                scenario.logic,
                style: TextStyle(color: AppColors.textHigh, height: 1.5),
              ),

              Spacer(),
              
              // Optional: Fake Payment Link
              if (scenario.showFakePaymentOption)
                SizedBox(
                  width: double.infinity,
                  child: OutlinedButton.icon(
                    style: OutlinedButton.styleFrom(
                      side: BorderSide(color: AppColors.primaryLavender),
                      padding: EdgeInsets.symmetric(vertical: 16),
                    ),
                    icon: Icon(Feather.credit_card, color: AppColors.primaryLavender),
                    label: Text("Generate Fake Receipt", style: TextStyle(color: AppColors.primaryLavender)),
                    onPressed: () {
  Navigator.push(
    context,
    MaterialPageRoute(builder: (context) => FakePaymentForm()),
  );
},
                  ),
                ),
            ],
          ),
        );
      },
    );
  }
}


--- C:\Code\femn\lib\wellness_widgets\leakguard\social_airlock.dart ---

import 'package:flutter/material.dart';
import 'package:flutter_vector_icons/flutter_vector_icons.dart';
import 'package:femn/customization/colors.dart'; // Ensure matches your project
import 'package:google_fonts/google_fonts.dart';
import 'package:url_launcher/url_launcher.dart'; // Add url_launcher: ^6.1.11 to pubspec.yaml

// ==========================================
// DATA MODEL
// ==========================================
enum RiskLevel { easy, medium, private }

class AirlockApp {
  final String name;
  final IconData icon;
  final Color brandColor;
  final RiskLevel riskLevel;
  final String description;
  final List<String> steps;
  final String? deepLink; // Optional: "fb://settings" etc.

  AirlockApp({
    required this.name,
    required this.icon,
    required this.brandColor,
    required this.riskLevel,
    required this.description,
    required this.steps,
    this.deepLink,
  });
}

// ==========================================
// MAIN SCREEN
// ==========================================
class SocialAirlockScreen extends StatelessWidget {
  
  //  GROUP 1: EASY FIX
  final List<AirlockApp> _easyFixApps = [
    AirlockApp(
      name: "Facebook",
      icon: FontAwesome.facebook,
      brandColor: Color(0xFF1877F2),
      riskLevel: RiskLevel.easy,
      description: "Facebook is the worst offender for public friend lists, but offers the best controls to fix it.",
      steps: [
        "Go to **Settings & Privacy > Settings**.",
        "Scroll to Audience and Visibility, tap **How people find and contact you**.",
        "Find **Who can see your friends list?**",
        "Change it to **Only Me**.",
        "Note: Mutual friends remain visible."
      ],
    ),
    AirlockApp(
      name: "TikTok",
      icon: FontAwesome.music, // Proxy for TikTok
      brandColor: Colors.black,
      riskLevel: RiskLevel.easy,
      description: "Hide your following list so people cant see which creators or friends you are watching.",
      steps: [
        "Go to Profile > **Menu ()**.",
        "Tap **Settings and privacy > Privacy**.",
        "Tap **Following list**.",
        "Change it to **Only me**."
      ],
    ),
    AirlockApp(
      name: "LinkedIn",
      icon: FontAwesome.linkedin,
      brandColor: Color(0xFF0077B5),
      riskLevel: RiskLevel.easy,
      description: "Competitors and nosey coworkers often look here to see who you know.",
      steps: [
        "Tap profile pic > **Settings & Privacy**.",
        "Tap **Visibility** on the left menu.",
        "Find **Connections**.",
        "Toggle **Connection visibility** to **Off**."
      ],
    ),
    AirlockApp(
      name: "YouTube",
      icon: FontAwesome.youtube,
      brandColor: Color(0xFFFF0000),
      riskLevel: RiskLevel.easy,
      description: "Hide your subscriptions so people can't profile you based on channels you watch.",
      steps: [
        "Go to **Settings > Privacy**.",
        "Toggle **On** for **'Keep all my subscriptions private'**."
      ],
    ),
  ];

  //  GROUP 2: ALL OR NOTHING
  final List<AirlockApp> _hardFixApps = [
    AirlockApp(
      name: "Instagram",
      icon: FontAwesome.instagram,
      brandColor: Color(0xFFE1306C),
      riskLevel: RiskLevel.medium,
      description: "Instagram does not let you hide 'Following' unless you go Private.",
      steps: [
        "**Option A (Recommended):** Go to Settings > Privacy > **Private Account**.",
        "**Option B (Public):** You must manually block specific people. They cannot see your list if blocked."
      ],
    ),
    AirlockApp(
      name: "Twitter (X)",
      icon: FontAwesome.twitter,
      brandColor: Color(0xFF1DA1F2),
      riskLevel: RiskLevel.medium,
      description: "Like Instagram, you cannot hide who you follow if your tweets are public.",
      steps: [
        "Go to Settings & Support > Settings and privacy.",
        "Tap **Privacy and safety > Audience and tagging**.",
        "Check **Protect your posts**."
      ],
    ),
    AirlockApp(
      name: "Threads",
      icon: FontAwesome.at,
      brandColor: Colors.black,
      riskLevel: RiskLevel.medium,
      description: "Since it is tied to Instagram, it follows the same logic.",
      steps: [
        "Go to Privacy settings.",
        "Switch to **Private Profile**."
      ],
    ),
  ];

  //  GROUP 3: INHERENTLY PRIVATE
  final List<AirlockApp> _privateApps = [
    AirlockApp(
      name: "Snapchat",
      icon: FontAwesome.snapchat_ghost,
      brandColor: Color(0xFFFFFC00),
      riskLevel: RiskLevel.private,
      description: "Ensure you aren't visible in 'Quick Add' recommendations.",
      steps: [
        "Go to **Settings > Privacy Controls**.",
        "Find **See Me in Quick Add**.",
        "**Uncheck** it."
      ],
    ),
    AirlockApp(
      name: "Reddit",
      icon: FontAwesome.reddit,
      brandColor: Color(0xFFFF4500),
      riskLevel: RiskLevel.private,
      description: "Prevent people from following your username and tracking your posts.",
      steps: [
        "Go to **User Settings > Profile**.",
        "Toggle Off **Show active communities**.",
        "Toggle Off **Allow people to follow you**."
      ],
    ),
    AirlockApp(
      name: "Discord",
      icon: MaterialCommunityIcons.discord,
      brandColor: Color(0xFF5865F2),
      riskLevel: RiskLevel.private,
      description: "Friend lists are private by default. Only 'Mutual Friends' are visible.",
      steps: [
        "Your list is already safe.",
        "Check **User Settings > Privacy & Safety** to restrict DMs from server members."
      ],
    ),
    AirlockApp(
      name: "Telegram",
      icon: FontAwesome.telegram,
      brandColor: Color(0xFF0088CC),
      riskLevel: RiskLevel.private,
      description: "Hide your phone number so strangers can't find your profile.",
      steps: [
        "Go to **Settings > Privacy and Security**.",
        "Tap **Phone Number**.",
        "Set 'Who can see my phone number?' to **Nobody**."
      ],
    ),
  ];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundDeep,
      appBar: AppBar(
        backgroundColor: AppColors.backgroundDeep,
        elevation: 0,
        leading: IconButton(
          icon: Icon(Feather.arrow_left, color: AppColors.textHigh),
          onPressed: () => Navigator.pop(context),
        ),
        title: Text(
          "Social Airlock",
          style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold),
        ),
      ),
      body: SingleChildScrollView(
        padding: EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildHeader(),
            SizedBox(height: 30),
            
            _buildSectionHeader("THE 'EASY FIX' GROUP", Colors.greenAccent, "Public profile, hidden friends."),
            _buildBentoGrid(context, _easyFixApps),
            SizedBox(height: 30),

            _buildSectionHeader("THE 'ALL OR NOTHING' GROUP", Colors.orangeAccent, "Must be Private to hide friends."),
            _buildBentoGrid(context, _hardFixApps),
            SizedBox(height: 30),

            _buildSectionHeader("INHERENTLY PRIVATE", Colors.blueAccent, "Check these just in case."),
            _buildBentoGrid(context, _privateApps),
            SizedBox(height: 40),
          ],
        ),
      ),
    );
  }

  Widget _buildHeader() {
    return Container(
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [AppColors.primaryLavender.withOpacity(0.2), Colors.transparent],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(20),
        border: Border.all(color: AppColors.primaryLavender.withOpacity(0.3)),
      ),
      child: Row(
        children: [
          Icon(Feather.lock, color: AppColors.primaryLavender, size: 32),
          SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  "Lock Your Doors",
                  style: TextStyle(color: AppColors.textHigh, fontSize: 18, fontWeight: FontWeight.bold),
                ),
                SizedBox(height: 5),
                Text(
                  "Extortionists use your friend lists to find leverage. Hide them now.",
                  style: TextStyle(color: AppColors.textMedium, fontSize: 13),
                ),
              ],
            ),
          )
        ],
      ),
    );
  }

  Widget _buildSectionHeader(String title, Color color, String subtitle) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          children: [
            Icon(Feather.circle, size: 10, color: color),
            SizedBox(width: 8),
            Text(
              title,
              style: TextStyle(color: color, fontWeight: FontWeight.bold, fontSize: 12, letterSpacing: 1.2),
            ),
          ],
        ),
        SizedBox(height: 4),
        Text(subtitle, style: TextStyle(color: AppColors.textMedium, fontSize: 12)),
        SizedBox(height: 12),
      ],
    );
  }

  Widget _buildBentoGrid(BuildContext context, List<AirlockApp> apps) {
    return GridView.builder(
      shrinkWrap: true,
      physics: NeverScrollableScrollPhysics(),
      gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: 2,
        crossAxisSpacing: 12,
        mainAxisSpacing: 12,
        childAspectRatio: 1.1, // Slightly wider than square
      ),
      itemCount: apps.length,
      itemBuilder: (context, index) {
        return _buildAppCard(context, apps[index]);
      },
    );
  }

  Widget _buildAppCard(BuildContext context, AirlockApp app) {
    return GestureDetector(
      onTap: () => _showAppGuide(context, app),
      child: Container(
        decoration: BoxDecoration(
          color: AppColors.surface,
          borderRadius: BorderRadius.circular(20),
          boxShadow: [BoxShadow(color: Colors.black12, blurRadius: 4, offset: Offset(0, 2))],
          border: Border.all(color: AppColors.elevation),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Container(
              padding: EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: app.brandColor.withOpacity(0.1),
                shape: BoxShape.circle,
              ),
              child: Icon(app.icon, color: app.brandColor, size: 30),
            ),
            SizedBox(height: 12),
            Text(
              app.name,
              style: TextStyle(color: AppColors.textHigh, fontWeight: FontWeight.bold, fontSize: 16),
            ),
            SizedBox(height: 4),
            Text(
              "Tap to secure",
              style: TextStyle(color: AppColors.textDisabled, fontSize: 10),
            ),
          ],
        ),
      ),
    );
  }

  void _showAppGuide(BuildContext context, AirlockApp app) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => Container(
        height: MediaQuery.of(context).size.height * 0.7,
        decoration: BoxDecoration(
          color: AppColors.surface,
          borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
        ),
        padding: EdgeInsets.all(24),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Center(child: Container(width: 40, height: 4, color: AppColors.textDisabled)),
            SizedBox(height: 24),
            
            // Header
            Row(
              children: [
                Icon(app.icon, color: app.brandColor, size: 32),
                SizedBox(width: 16),
                Text(app.name, style: TextStyle(color: AppColors.textHigh, fontSize: 24, fontWeight: FontWeight.bold)),
              ],
            ),
            SizedBox(height: 24),

            // Description
            Text("THE REALITY", style: TextStyle(color: AppColors.textDisabled, fontSize: 10, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
            SizedBox(height: 8),
            Text(
              app.description,
              style: TextStyle(color: AppColors.textHigh, fontSize: 14, height: 1.5),
            ),
            
            SizedBox(height: 24),

            // Steps
            Text("THE FIX", style: TextStyle(color: AppColors.textDisabled, fontSize: 10, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
            SizedBox(height: 12),
            Expanded(
              child: ListView.separated(
                itemCount: app.steps.length,
                separatorBuilder: (_,__) => SizedBox(height: 12),
                itemBuilder: (context, index) {
                  return Row(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Container(
                        width: 24, height: 24,
                        alignment: Alignment.center,
                        decoration: BoxDecoration(
                          color: AppColors.primaryLavender.withOpacity(0.1),
                          shape: BoxShape.circle,
                        ),
                        child: Text("${index + 1}", style: TextStyle(color: AppColors.primaryLavender, fontWeight: FontWeight.bold, fontSize: 12)),
                      ),
                      SizedBox(width: 12),
                      Expanded(
                        child: Text(
                          app.steps[index].replaceAll('**', ''), // Simple markdown strip
                          style: TextStyle(color: AppColors.textHigh, fontSize: 14),
                        ),
                      ),
                    ],
                  );
                },
              ),
            ),

            // Launch Button
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: app.brandColor,
                  padding: EdgeInsets.symmetric(vertical: 16),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                ),
                onPressed: () {
                   // In a real app, use url_launcher to open the specific app
                   Navigator.pop(context);
                },
                child: Text("Open ${app.name}", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
              ),
            )
          ],
        ),
      ),
    );
  }
}


--- C:\Code\femn\lib\widgets\femn_background.dart ---

import 'package:flutter/material.dart';
import 'package:femn/customization/colors.dart';

class FemnBackground extends StatelessWidget {
  final Widget child;
  final double opacity;
  final String imagePath;

  const FemnBackground({
    Key? key,
    required this.child,
    this.opacity = 0.9,
    this.imagePath = 'assets/femn_state.png',
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: AppColors.backgroundDeep,
        image: DecorationImage(
          image: AssetImage(imagePath),
          fit: BoxFit.cover,
          colorFilter: ColorFilter.mode(
            Colors.black.withOpacity(opacity),
            BlendMode.darken,
          ),
        ),
      ),
      child: child,
    );
  }
}
